<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>路口查核記錄</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: "Noto Sans TC", Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        color: #333;
      }

      .container {
        max-width: 500px;
         margin: 0 auto; /* 修改為0 auto使頂部無間距 */
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      h2 {
        margin-top: 10px; /* 減少上邊距 */
        color: #06c755;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
     border-bottom: none; /* 移除底部分隔線 */
        padding-bottom: 15px;
      }
/* 車輛距離漸層底色樣式 - 僅應用於車號而非整個項目 */
.bus-plate.distance-veryclose { background-color: rgba(255, 193, 7, 1); } /* 0-100m 滿色黃 */
.bus-plate.distance-close { background-color: rgba(255, 193, 7, 0.75); } /* 101-150m 3/4滿色黃 */
.bus-plate.distance-medium { background-color: rgba(255, 193, 7, 0.5); } /* 151-200m 2/4滿色黃 */
.bus-plate.distance-far { background-color: rgba(255, 193, 7, 0.25); } /* 201-250m 1/4滿色黃 */

/* 自動偵測按鈕啟動樣式 */
.utility-button.auto-detect-active {
  background-color: #e7f3fe; /* 使用與偵測車輛按鈕相同的顏色 */
  color: #004085;
  border-color: #b8daff;
}
      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }

      .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 4px;
      }

      /* 輸入框樣式 */
      .input-group {
        display: flex;
        align-items: center;
      }

      .input-group input {
        flex: 1;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
      }

      .input-group .icon-button {
        width: 46px;
        height: 46px;
        border: 1px solid #ddd;
        border-left: none;
        background-color: #f8f9fa;
        border-top-right-radius: 6px;
        border-bottom-right-radius: 6px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .input-group .icon-button:hover {
        background-color: #e9ecef;
      }

      .input-group .icon-button i {
        color: #06c755;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border 0.3s;
        box-sizing: border-box;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: #06c755;
        outline: none;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.1);
      }

      /* 新增：檢測車輛卡片樣式 */
      .bus-card {
        background-color: #fff;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 15px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .bus-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .bus-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
      }

      .bus-card-company {
        font-weight: bold;
        color: #06c755;
      }

      .bus-card-plate {
        font-weight: bold;
        background-color: #ffeb3b;
        padding: 3px 8px;
        border-radius: 4px;
      }

      .bus-card-body {
        padding: 15px;
      }

      .bus-card-route {
        margin-bottom: 10px;
        font-size: 15px;
      }

      .bus-card-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }

      button {
        width: 100%;
        padding: 14px;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 10px;
      }

      button:hover {
        background-color: #04a73e;
        box-shadow: 0 4px 8px rgba(6, 199, 85, 0.2);
      }

      .secondary-button {
        background-color: #f1f1f1;
        color: #333;
      }

      .secondary-button:hover {
        background-color: #e5e5e5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 簡化選項樣式 */
      .quick-items {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }

      .quick-item {
  background-color: #f1f1f1;
  border-radius: 20px;
  padding: 8px 14px; /* 放大按鈕尺寸 */
  font-size: 15px; /* 放大字體 */
  cursor: pointer;
  border: 1px solid #ddd;
  transition: all 0.2s ease;
  margin-bottom: 5px; /* 增加間距 */
      }

      .quick-item.selected {
        background-color: #06c755;
        color: white;
        border-color: #06c755;
      }
      
      /* 其他項目簡化樣式 */
      .quick-other-items {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }
      
      .quick-other-item {
  background-color: #f8f9fa;
  border-radius: 6px;
  padding: 6px 10px; /* 放大按鈕尺寸 */
  font-size: 14px; /* 放大字體 */
  cursor: pointer;
  border: 1px solid #eee;
  transition: all 0.2s ease;
  margin-bottom: 5px; /* 增加間距 */
      }
      
      .quick-other-item.selected {
        background-color: #e7f3fe;
        color: #004085;
        border-color: #b8daff;
      }

      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }

      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        display: block;
      }

      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        display: block;
      }

      .status-message.info {
        background-color: #e7f3fe;
        color: #004085;
        display: block;
      }

      /* 即時偵測結果小卡 */
      .real-time-detection {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #06c755;
        color: white;
        padding: 10px 15px;
        border-radius: 30px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 99;
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .real-time-detection.show {
        opacity: 1;
        transform: translateY(0);
      }

      .detection-count {
        background-color: white;
        color: #06c755;
        font-weight: bold;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* 動作按鈕樣式 */
      .action-button {
        padding: 10px;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .submit-button {
        background-color: #06c755;
        color: white;
      }
      
      .submit-button:hover {
        background-color: #04a73e;
      }
      
      .remove-button {
        background-color: #f8d7da;
        color: #721c24;
      }
      
      .remove-button:hover {
        background-color: #f5c6cb;
      }
      
      /* 輔助按鈕容器 */
      .utility-buttons {
        margin: 20px 0;
        display: flex;
        gap: 10px;
      }
      
      .utility-button {
  flex: 1;
  text-align: center;
  padding: 10px 8px; /* 調整內距 */
  border-radius: 6px;
  background-color: #f1f1f1;
  color: #333;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid #ddd;
  display: flex;          /* 使用彈性布局 */
  flex-direction: column; /* 垂直排列 */
  align-items: center;    /* 水平居中 */
  justify-content: center;/* 垂直居中 */
  gap: 5px;               /* 圖標和文字之間的間距 */
      }
      
      .utility-button:hover {
        background-color: #e5e5e5;
      }
      .utility-button i {
  font-size: 18px;
  margin-bottom: 4px;
}
      .utility-button.primary {
        background-color: #e7f3fe;
        color: #004085;
        border-color: #b8daff;
      }
      
      .utility-button.primary:hover {
        background-color: #d1e7ff;
      }
      
      /* 無檢測結果時的樣式 */
      .no-buses-message {
        text-align: center;
        padding: 30px 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        color: #6c757d;
        margin: 20px 0;
      }
      
      /* 已提交卡片樣式 */
      .bus-card.submitted {
        opacity: 0.7;
        pointer-events: none;
      }
      
      .submitted-label {
        background-color: #d4edda;
        color: #155724;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      
      /* 查詢歷史樣式 */
      .history-list {
        margin-top: 15px;
      }
      
      .history-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
      }
      
      .history-time {
        color: #6c757d;
        font-size: 12px;
      }
      
      /* 狀態標籤 */
      .status-tag {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 5px;
      }
      
      .status-processing {
        background-color: #fff3cd;
        color: #856404;
      }
      
      .status-submitted {
        background-color: #d4edda;
        color: #155724;
      }
      
      /* 位置項目樣式 */
      .location-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }
      
      .location-item:hover {
        background-color: #f9f9f9;
      }
      
      /* 檢測按鈕容器樣式 */
      .detect-button-container {
        margin-bottom: 15px;
        text-align: center;
      }
      
      .detect-button {
        width: auto !important;
        padding: 10px 15px !important;
        margin: 0 auto !important;
      }
      
      /* 無數據提示樣式 */
      .no-data-message {
        text-align: center;
        padding: 15px;
        color: #6c757d;
        font-style: italic;
      }
      
      /* 彈窗模態樣式補充 */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 500px;
        max-height: 70vh;
        overflow-y: auto;
        animation: slideDown 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      
      @keyframes slideDown {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      
      /* 載入中覆蓋層樣式補充 */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #06c755;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .hidden {
        display: none;
      }
      
      /* 公司信息與品牌 */
      .line-brand {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #999;
        padding-top: 15px;
        border-top: 1px solid #f0f0f0;
      }
      
      /* 檢測結果區域 */
      .detected-buses-container {
        margin-top: 20px;
        margin-bottom: 20px;
      }
      
      .detection-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
      }
      .detection-title-area {
  display: flex;
  align-items: center;
}
      
      .detection-header h3 {
        margin: 0;
        color: #06c755;
      }
      /* 簡易車輛列表樣式 */
.simple-bus-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 15px;
}
/* 路線容器固定寬度 */
.bus-route-container {
  width: 65%;            /* 使用百分比控制寬度 */
  max-width: 90px;       /* 最大寬度限制 */
  overflow: hidden;    
  white-space: nowrap;
  position: relative;
  text-overflow: ellipsis;
  flex-shrink: 1;        /* 允許適當壓縮 */
}
.simple-bus-item {
  background-color: #f8f9fa;
  border: 1px solid #eee;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: 8px;          /* 減小內邊距 */
  box-sizing: border-box;
  margin: 0;
  position: relative;
  overflow: visible;     /* 改為可見溢出 */
  min-height: 45px;      /* 使用最小高度而非固定高度 */
}
.simple-bus-item strong {
  font-size: 15px; /* 車牌號碼稍微大一點 */
}
.simple-bus-item:hover {
  background-color: #e7f3fe;
  border-color: #b8daff;
  transform: translateY(-2px);
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
}

.company-label {
 color: #06c755;
  font-weight: 500;
  font-size: 15px; /* 減小公司名稱字體 */
}

/* 固定輸入區域樣式 */
.bus-input-container {
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-top: 20px;
  margin-bottom: 20px;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  transition: all 0.3s ease;
}
.bus-route {
  color: #004085;
  font-weight: 500;
  font-size: 15px;
  max-width: 60%;
  overflow: hidden;
  white-space: nowrap;
  position: relative;
}
.bus-plate {
  flex-shrink: 0;        /* 防止車牌被壓縮 */
  width: 35%;            /* 分配更多空間給車牌 */
  max-width: 85px;       /* 最大寬度限制 */
  text-align: center;
  background-color: #ffeb3b;
  padding: 3px 5px;      /* 減小內邊距 */
  border-radius: 4px;
  font-weight: bold;
  font-size: 14px;
  margin-left: auto;     /* 靠右對齊 */
  overflow: visible;     /* 允許內容溢出 */
}
.bus-info-header {
  background-color: #f8f9fa;
  padding: 15px;
  border-bottom: 1px solid #eee;
}

.route-info {
  color: #004085; /* 加深顏色讓路線更明顯 */
  margin-top: 0;
  margin-bottom: 5px;
  font-size: 18px;
  font-weight: 500; /* 加粗 */
  text-align: left; /* 添加這行使文字靠左 */
}

.input-section {
  padding: 15px;
}

.input-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.cancel-button {
  background-color: #f1f1f1;
  color: #333;
}

.cancel-button:hover {
  background-color: #e5e5e5;
}

/* 倒數計時容器 */
.countdown-container {
  text-align: center;
  margin-top: 5px;
  color: #6c757d;
  font-size: 14px;
  height: 20px;
}
/* 開關按鈕樣式 */
.switch-container {
  display: flex;
  align-items: center;
  margin-left: 10px;
  font-size: 14px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 20px;
  margin-right: 6px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #06c755;
}

input:checked + .slider:before {
  transform: translateX(20px);
}
 /* 添加到現有樣式的最後 */
  /* 跑馬燈效果樣式 */
  .text-marquee {
  display: inline-block;
  white-space: nowrap;
  overflow: hidden;
  width: 100%;
  color: #004085;
  font-weight: 500;
  }
  
.text-marquee.scrolling {
  animation: marquee-scroll 8s linear infinite;
}
/* 列表項中的跑馬燈速度更快 */
.list-marquee.scrolling {
    animation: marquee-scroll-left 8s linear infinite; /* 增加時間確保完整滾動 */
  display: inline-block;
  white-space: nowrap;
}

  .text-marquee:hover {
    animation-play-state: paused;
  }
  
/* 修改跑馬燈效果為單向 */
@keyframes marquee-scroll-left {
  0%, 5% { transform: translateX(0); }
  95%, 100% { transform: translateX(-200%); } /* 移動更遠距離確保完全顯示 */
}
  
  /* 調整路線顯示容器 */
  .route-info {
  color: #004085;
  margin-top: 0;
  margin-bottom: 5px;
  font-size: 18px;
  font-weight: 500;
  text-align: left;
  width: 100%;
  overflow: hidden;
  }
  
  /* 確保跑馬燈容器寬度正確 */
  #inputBusRoute {
  width: 100%;
  overflow: hidden;
  position: relative;
  }
/* 響應式調整 */
@media (max-width: 480px) {
  .switch-container {
    font-size: 12px;
  }
  
  .switch {
    width: 36px;
    height: 18px;
  }
  
  .slider:before {
    height: 14px;
    width: 14px;
  }
  
  input:checked + .slider:before {
    transform: translateX(18px);
  }
}
    </style>
  </head>
  <body>
    <div id="loading-overlay" class="loading-overlay hidden">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h2>路口查核</h2>

      <div id="statusMessage" class="status-message"></div>

      <!-- 即時偵測懸浮顯示 -->
      <div
        id="realTimeDetection"
        class="real-time-detection"
        onclick="showDetectedBuses()"
      >
        <span id="detectionCount" class="detection-count">0</span>
        <span>個新偵測結果</span>
      </div>

      <!-- 位置選擇 -->
      <div class="form-group">
        <label for="location" class="required">我的位置</label>
        <div class="input-group">
          <input type="text" id="location" placeholder="選擇附近路口" />
          <div class="icon-button" onclick="openLocationModal()">
            <i class="fas fa-map-marker-alt"></i>
          </div>
        </div>
      </div>

<div class="utility-buttons">
  <div class="utility-button" onclick="detectBuses()">
    <i class="fas fa-search"></i>
    <span>偵測車輛</span>
  </div>
  <div id="autoDetectButton" class="utility-button" onclick="toggleAutoDetect()">
    <i class="fas fa-sync"></i>
    <span id="autoDetectStatus">自動偵測</span>
  </div>
  <div class="utility-button" onclick="openManualInputModal()">
    <i class="fas fa-plus"></i>
    <span>手動新增</span>
  </div>

</div>
<div class="countdown-container">
  <span id="countdown"></span>
</div>

      <!-- 隱藏欄位 -->
      <input type="hidden" id="positionLat" />
      <input type="hidden" id="userId" />

      <!-- 檢測到的車輛容器 -->
<div id="detectedBusesContainer" class="detected-buses-container">
  <div class="detection-header">
    <div class="detection-title-area">
      <h3>偵測車輛</h3>
      <div class="switch-container">
        <label class="switch">
          <input type="checkbox" id="includeRecordedToggle" onchange="toggleIncludeRecorded()">
          <span class="slider"></span>
        </label>
        <span>包含已記錄車輛</span>
      </div>
    </div>
    <span id="busCount" class="status-tag status-processing">0 輛</span>
  </div>
  <div id="detectedBusesList">
    <!-- 檢測到的車輛卡片將在這裡動態顯示 -->
    <div class="no-buses-message">
      <i
        class="fas fa-bus"
        style="font-size: 24px; color: #adb5bd; margin-bottom: 10px"
      ></i>
      <p>尚未檢測到車輛，請點擊「偵測車輛」按鈕</p>
    </div>
  </div>
</div>
 <!-- 修改固定的車輛輸入區域結構，調整路線顯示位置 -->
<div id="busInputContainer" class="bus-input-container hidden">
  <div class="bus-info-header">
    <!-- 將路線移到頂部 -->
    <div id="inputBusRoute" class="route-info"></div>
    <div><span id="inputBusCompany" class="company-label"></span> <strong id="inputBusNumber"></strong></div>
  </div>
  
  <div class="input-section">
    <label>查核結果:</label>
    <div id="mainItemsContainer" class="quick-items">
      <!-- 主要項目將在這裡生成 -->
    </div>
    
    <label>其它:</label>
    <div id="otherItemsContainer" class="quick-other-items">
      <!-- 其他項目將在這裡生成 -->
    </div>
    
    <div class="input-actions">
      <div class="action-button submit-button" onclick="submitSelectedBus()">
        <i class="fas fa-check"></i> 送出記錄
      </div>
      <div class="action-button cancel-button" onclick="cancelBusInput()">
        <i class="fas fa-times"></i> 取消
      </div>
    </div>
  </div>
</div>
<!-- 手動輸入車輛模態框 -->
<div id="manualInputModal" class="modal">
  <div class="modal-content">
    <h3>手動新增車輛</h3>
       <div id="manualInputError" class="status-message error" style="display: none; margin-bottom: 15px;"></div>
    <div class="form-group">
      <label for="manualPlateNumber" class="required">車號</label>
      <input type="text" id="manualPlateNumber" placeholder="輸入車號" oninput="convertToUpperCase(this)" onblur="formatPlateNumber(this)">
    </div>
    <div class="form-group">
      <label for="manualCompany">公司</label>
      <select id="manualCompany"  class="required">
        <option value="">請選擇公司</option>
        <option value="首都客運">首都</option>
        <option value="臺北客運">臺北</option>
        <option value="大都會客運">大都會</option>
        <option value="三重客運">三重</option>
        <option value="台中客運">台中</option>
      </select>
    </div>
    <div class="form-group">
      <label for="manualRoute">路線</label>
      <input type="text" id="manualRoute" placeholder="輸入路線">
    </div>
    <div class="button-group">
      <button type="button" onclick="addManualBus()">確認新增</button>
      <button type="button" class="secondary-button" onclick="closeManualInputModal()">取消</button>
    </div>
  </div>
</div>
      <div class="line-brand">首都集團路口查核平台-v03212111</div>
    </div>

    <!-- 位置選擇彈窗 -->
    <div id="locationModal" class="modal">
      <div class="modal-content">
        <h3>我的位置</h3>
        <!-- 添加重新偵測按鈕 -->
        <div id="detectLocationButtonContainer" class="detect-button-container">
          <button
            id="detectLocationButton"
            type="button"
            class="secondary-button detect-button"
            onclick="refreshLocationList()"
          >
            <i class="fas fa-sync-alt"></i> 偵測位置
          </button>
        </div>
        <div id="locationList"></div>
        <div class="button-group">
          <button type="button" onclick="closeLocationModal()">關閉</button>
        </div>
      </div>
    </div>

    <!-- 歷史紀錄彈窗 -->
    <div id="historyModal" class="modal">
      <div class="modal-content">
        <h3>今日紀錄</h3>
        <div id="historyList" class="history-list">
          <!-- 歷史紀錄將在這裡動態顯示 -->
        </div>
        <div class="button-group">
          <button type="button" onclick="closeHistoryModal()">關閉</button>
        </div>
      </div>
    </div>


  <script>
// 全局變數
let liffInitialized = false;
const base_url = "https://35.221.146.143.nip.io/linehook/";
const channelId = "2006992891";
const liffId = "2006993665-1Nvo0AvX".trim(); // LIFFID
let currentLatitude = 0;
let currentLongitude = 0;
let intersections = [];
let allDetectedBuses = []; // 所有偵測到的車輛
let displayedBuses = []; // 目前顯示的車輛
let submittedBuses = []; // 已提交的車輛
let otherItems = [];
let globalLoadingTimeout = null;
let watchId = null;
let selectedBusIndex = -1;
// 添加全局變數
let autoDetectInterval = null;
let countdownInterval = null;
let countdownSeconds = 20; // 預設20秒
// 全局變數 - 是否包含已記錄車輛
let includeRecordedVehicles = false;
// 公司列表數據
const companies = [
  { id: "1", name: "首都客運" },
  { id: "2", name: "臺北客運" },
  { id: "3", name: "大都會客運" },
  { id: "4", name: "三重客運" },
  { id: "5", name: "台中客運" },
];

// 主要項目預設值
const mainItems = ["左轉未停", "右轉未停", "未指差", "未停未指差", "無缺失"];

const safeStorage = {
  set: function(key, value) {
    try {
      if (typeof value === 'object') {
        value = JSON.stringify(value);
      }
      localStorage.setItem(key, value);
      return true;
    } catch (error) {
      console.error("保存到localStorage失敗:", error);
      return false;
    }
  },
  
  get: function(key, defaultValue = null) {
    try {
      const value = localStorage.getItem(key);
      if (value === null) return defaultValue;
      
      // 嘗試解析JSON
      try {
        return JSON.parse(value);
      } catch (e) {
        // 如果不是JSON，直接返回值
        return value;
      }
    } catch (error) {
      console.error("從localStorage讀取失敗:", error);
      return defaultValue;
    }
  },
  
  remove: function(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error("從localStorage刪除失敗:", error);
      return false;
    }
  },
  
  // 檢查存儲是否可用
  isAvailable: function() {
    try {
      const testKey = "__test__";
      localStorage.setItem(testKey, testKey);
      localStorage.removeItem(testKey);
      return true;
    } catch (e) {
      return false;
    }
  }
};

// 切換是否包含已記錄車輛的開關
function toggleIncludeRecorded() {
  includeRecordedVehicles = document.getElementById('includeRecordedToggle').checked;
  console.log("包含已記錄車輛設置更改為:", includeRecordedVehicles);
  
  // 立即重新篩選顯示的車輛
  refreshDisplayedBuses();
}
// 根據當前設置重新篩選要顯示的車輛
function refreshDisplayedBuses() {
  if (includeRecordedVehicles) {
    // 包含所有車輛 - 合併所有偵測到的車輛
    displayedBuses = [...allDetectedBuses];
  } else {
    // 只顯示未提交過的車輛
    const threeMinutes = 3 * 60 * 1000; // 3分鐘轉換為毫秒
    const currentTime = Date.now();
    
    displayedBuses = allDetectedBuses.filter(bus => {
      // 如果車牌在已提交列表中且提交時間小於3分鐘，則不顯示
      if (submittedBuses.includes(bus.plateNumber)) {
        const submissionTime = localStorage.getItem(`submitted_${bus.plateNumber}`);
        if (submissionTime && (currentTime - parseInt(submissionTime)) < threeMinutes) {
          return false; // 排除近期已提交的車輛
        }
      }
      return true; // 保留其他車輛
    });
  }
    // 更新UI
  updateDetectedBusesList();
}
// 在模態框內顯示錯誤訊息
function showManualInputError(message) {
  const errorElement = document.getElementById("manualInputError");
  errorElement.textContent = message;
  errorElement.style.display = "block";
  
  // 3秒後自動隱藏錯誤訊息
  setTimeout(() => {
    errorElement.style.display = "none";
  }, 3000);
}
// 轉換為大寫函數
function convertToUpperCase(input) {
  input.value = input.value.toUpperCase();
    // 添加車號格式化邏輯
  formatPlateNumber(input);
}

// 格式化車號，處理各種情況
function formatPlateNumber(input) {
  let value = input.value.replace(/-/g, ''); // 先移除所有 "-"
  
  // 如果車牌包含數字和英文，但格式複雜(如123U3)
  // 我們找到第一個字母和數字交界的地方
  let result = value;
  let hasFormatted = false;
  
  // 尋找從數字到字母的轉換
  for (let i = 0; i < value.length - 1; i++) {
    let current = value[i];
    let next = value[i + 1];
    
    // 如果當前字符是數字，下一個是字母
    if (!isNaN(parseInt(current)) && isNaN(parseInt(next)) && /[A-Z]/.test(next)) {
      result = value.substring(0, i + 1) + '-' + value.substring(i + 1);
      hasFormatted = true;
      break;
    }
    
    // 如果當前字符是字母，下一個是數字
    if (isNaN(parseInt(current)) && /[A-Z]/.test(current) && !isNaN(parseInt(next))) {
      result = value.substring(0, i + 1) + '-' + value.substring(i + 1);
      hasFormatted = true;
      break;
    }
  }
  
  input.value = result;
}


// 在頁面載入時初始化
window.onload = initializePage;
// 清空顯示車輛列表的函數
function clearDisplayedBuses() {
  // 如果列表已為空，顯示提示
  if (displayedBuses.length === 0) {
    showStatusMessage("當前列表已為空", "info");
    return;
  }
  
  // 直接清空列表
  displayedBuses = [];
  updateDetectedBusesList();
  showStatusMessage("已清空車輛列表", "info");
}
// 取消車輛輸入
function cancelBusInput() {
  document.getElementById("busInputContainer").classList.add("hidden");
  selectedBusIndex = -1;
}

// 切換自動偵測功能
function toggleAutoDetect() {
  const statusElem = document.getElementById("autoDetectStatus");
   const autoDetectButton = document.getElementById("autoDetectButton");
  if (autoDetectInterval) {
    stopAutoDetect();
    statusElem.textContent = "自動偵測";
    autoDetectButton.classList.remove("auto-detect-active");
  } else {
    startAutoDetect();
    statusElem.textContent = "停止自動";
    autoDetectButton.classList.add("auto-detect-active");
  }
}
// 打開手動輸入模態框時暫停自動偵測
function openManualInputModal() {
  // 記錄當前自動偵測狀態
   const wasAutoDetecting = !!autoDetectInterval;
  
//   // 如果正在自動偵測，暫時停止
   if (wasAutoDetecting) {
     stopAutoDetect();
//     // 在window上保存狀態，以便後續恢復
     window.tempAutoDetectState = true;
 }
  
  document.getElementById("manualInputModal").style.display = "block";
   // 重置表單欄位到預設值
  document.getElementById("manualPlateNumber").value = "";
  document.getElementById("manualCompany").value = ""; // 預設選擇首都
  document.getElementById("manualRoute").value = "";
    // 隱藏任何之前的錯誤訊息
  document.getElementById("manualInputError").style.display = "none";
}

// 關閉手動輸入模態框時恢復自動偵測
function closeManualInputModal() {
  document.getElementById("manualInputModal").style.display = "none";
  
//   // 如果之前是自動偵測狀態，恢復自動偵測
  if (window.tempAutoDetectState) {
    startAutoDetect();
    window.tempAutoDetectState = false;
  }
}

// 加強健康檢查函數，確保計時器正常運行
// 改進的自動偵測健康檢查函數，更清晰的命名和錯誤處理
function setupAutoDetectHealthCheck() {
  const HEALTH_CHECK_INTERVAL_MS = 10000; // 10秒
  
  // 設置健康檢查定時器
  const healthCheckInterval = setInterval(() => {
    try {
      const statusElem = document.getElementById("autoDetectStatus");
      
      // 檢查是否應該在自動偵測狀態但計時器已經停止
      if (statusElem && statusElem.textContent === "停止自動" && !autoDetectInterval) {
        console.log("檢測到自動偵測異常停止，正在重新啟動...");
        // 重新啟動自動偵測
        startAutoDetect();
      }
      
      // 檢查倒數計時是否正常運行
      if (statusElem && statusElem.textContent === "停止自動" && !countdownInterval) {
        console.log("檢測到倒數計時異常停止，正在重新啟動...");
        // 重新啟動倒數計時
        startCountdown();
      }
    } catch (error) {
      console.error("自動偵測健康檢查錯誤:", error);
      // 即使出錯也不中斷健康檢查
    }
  }, HEALTH_CHECK_INTERVAL_MS);
  
  // 頁面卸載時清理健康檢查
  window.addEventListener("beforeunload", function() {
    if (healthCheckInterval) {
      clearInterval(healthCheckInterval);
    }
  });
}
// 添加完整的頁面初始化函數，包含錯誤處理和回調
async function initializePage() {
  try {
    showLoading();
    console.log("初始化頁面...");
    
    // 檢查localStorage是否可用
    if (!safeStorage.isAvailable()) {
      showStatusMessage("本地存儲不可用，部分功能可能受限", "warning", true);
    }
    
    // 清理過期提交記錄
    cleanupExpiredSubmissions();
    
    // 檢查位置權限
    checkLocationPermission();
    
    // 初始化LIFF
    await initLIFF();
    
    // 確保includeRecordedVehicles開關預設為false
    includeRecordedVehicles = false;
    document.getElementById('includeRecordedToggle').checked = false;
    
    // 如果已登入，開始位置監視
    if (liffInitialized && liff.isLoggedIn()) {
      startLocationWatching(true);
    }
    
    // 設置自動偵測健康檢查
    setupAutoDetectHealthCheck();
    
    // 添加網絡狀態監聽器
    setupNetworkListeners();
    
    console.log("頁面初始化完成");
    hideLoading();
  } catch (error) {
    console.error("頁面載入時發生錯誤:", error);
    showStatusMessage("載入頁面時發生錯誤，請重新整理", "error");
    hideLoading();
  }
}
// 網絡監聽器設置
function setupNetworkListeners() {
  // 網絡恢復連接
  window.addEventListener('online', function() {
    console.log("網絡連接恢復");
    showStatusMessage("網絡連接已恢復", "info", true);
    
    // 如果頁面可見，更新位置
    if (document.visibilityState === 'visible') {
      getCurrentPosition(true);
    }
  });
  
  // 網絡斷開連接
  window.addEventListener('offline', function() {
    console.log("網絡連接已斷開");
    showStatusMessage("網絡連接已斷開，部分功能可能不可用", "warning");
  });
}
// 添加手動輸入的車輛
function addManualBus() {
  const plateNumber = document.getElementById("manualPlateNumber").value.trim();
  const company = document.getElementById("manualCompany").value;
  const route = document.getElementById("manualRoute").value.trim();
  
  // 車號驗證
  if (!plateNumber) {
    showManualInputError("請輸入車號");
    return;
  }
  
  // 公司驗證
  if (!company) {
    showManualInputError("請選擇公司");
    return;
  }
  
  // 檢查是否已提交過
  if (isRecentlySubmitted(plateNumber)) {
    showStatusMessage("此車輛近期已提交記錄，請稍後再試", "error");
    return;
  }
  
  // 創建新車輛對象
  const newBus = {
    plateNumber: plateNumber,
    operatorName: company,
    routeName: { chinese: route },
    position: {
      latitude: currentLatitude,
      longitude: currentLongitude
    },
    isManualInput: true // 標記為手動輸入
  };
  
  // 添加到顯示列表
  displayedBuses.push(newBus);
  allDetectedBuses.push(newBus);
  
  // 更新UI
  updateDetectedBusesList();
  
  // 關閉模態框
  closeManualInputModal();
  
  // 選擇新添加的車輛進行輸入
  selectBusForInput(newBus, displayedBuses.length - 1);
}

// 檢查是否近期提交過（3分鐘內）
function isRecentlySubmitted(plateNumber) {
  const submissionTime = localStorage.getItem(`submitted_${plateNumber}`);
  if (!submissionTime) return false;
  
  const threeMinutes = 3 * 60 * 1000;
  return (Date.now() - parseInt(submissionTime)) < threeMinutes;
}

// 修改selectBusForInput函數，將路線移到頂部
function selectBusForInput(bus, index) {
  selectedBusIndex = index;
  
  // 更新輸入區域顯示
  const inputContainer = document.getElementById("busInputContainer");
  if (inputContainer) {
    inputContainer.classList.remove("hidden");
    
    // 更新車輛信息，將路線移到最上方
    const routeInfo = bus.routeName?.chinese || "未知路線";
          // 創建路線元素，添加跑馬燈功能
      const routeElement = document.getElementById("inputBusRoute");
      routeElement.innerHTML = `<div class="text-marquee">路線: ${routeInfo}</div>`;
      
      // 檢查路線長度，如果過長則啟用跑馬燈效果
setTimeout(() => {
  const textElement = routeElement.querySelector('.text-marquee');
  if (textElement) {
    // 固定一個預設寬度
    const MAX_WIDTH_WITHOUT_MARQUEE = 800; // 這個值可以根據您的UI設計調整
    if (textElement.scrollWidth > MAX_WIDTH_WITHOUT_MARQUEE) {
      textElement.classList.add('scrolling');
    } else {
      textElement.classList.remove('scrolling');
    }
  }
}, 10); // 減少延遲時間，讓跑馬燈更快啟動

    document.getElementById("inputBusCompany").textContent = bus.operatorName || "未知公司";
    document.getElementById("inputBusNumber").textContent = bus.plateNumber || "無車號";
    
    // 清除之前的選擇
    const mainItemsContainer = document.getElementById("mainItemsContainer");
    mainItemsContainer.innerHTML = '';
    mainItems.forEach(item => {
      const itemButton = document.createElement("div");
      itemButton.className = "quick-item";
      itemButton.textContent = item;
      itemButton.dataset.value = item;
      itemButton.onclick = function() {
        mainItemsContainer.querySelectorAll(".quick-item").forEach(el => {
          el.classList.remove("selected");
        });
        this.classList.add("selected");
      };
      mainItemsContainer.appendChild(itemButton);
    });

    // 初始化其他項目選擇器
    const otherItemsContainer = document.getElementById("otherItemsContainer");
    otherItemsContainer.innerHTML = '';
    otherItems.forEach(item => {
      const itemButton = document.createElement("div");
      itemButton.className = "quick-other-item";
      itemButton.textContent = item.itemName;
      itemButton.dataset.value = item.itemName;
      itemButton.onclick = function() {
        this.classList.toggle("selected");
      };
      otherItemsContainer.appendChild(itemButton);
    });
    
    // 滾動到輸入區域
    inputContainer.scrollIntoView({ behavior: "smooth" });
  }
}

// 修改開始自動偵測函數，確保定時器正確設置
function startAutoDetect() {
  // 先清除任何現有的自動偵測計時器
  if (autoDetectInterval) {
    clearInterval(autoDetectInterval);
    autoDetectInterval = null;
  }
  
  // 立即執行一次偵測，標記為自動偵測
  detectBuses(true);
  
  // 重新設置自動偵測間隔，每20秒執行一次
  autoDetectInterval = setInterval(() => {
    console.log("自動偵測觸發");
    detectBuses(true); // 傳入true表示是自動偵測
  }, 20000); // 每20秒
  
  // 開始倒數計時
  startCountdown();
  
  // 顯示自動偵測已啟動的提示
  showStatusMessage("自動偵測已啟動", "info");
  setTimeout(() => {
    // 3秒後清除提示
    const statusElement = document.getElementById("statusMessage");
    if (statusElement && statusElement.textContent === "自動偵測已啟動") {
      statusElement.textContent = "";
      statusElement.className = "status-message";
    }
  }, 3000);
}

// 停止自動偵測
function stopAutoDetect() {
  if (autoDetectInterval) {
    clearInterval(autoDetectInterval);
    autoDetectInterval = null;
  }
  
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  
  // 重置倒數顯示
  const countdownElement = document.getElementById("countdown");
  if (countdownElement) {
    countdownElement.textContent = "";
  }
    const autoDetectButton = document.getElementById("autoDetectButton");
  autoDetectButton.classList.remove("auto-detect-active");
}

// 開始倒數
function startCountdown() {
  if (countdownInterval) {
    clearInterval(countdownInterval);
  }
  
  countdownSeconds = 20;
  updateCountdownDisplay();
  
  countdownInterval = setInterval(() => {
    countdownSeconds--;
    
    if (countdownSeconds <= 0) {
      // 不清除計時器，而是重置倒數
      // 注意：不要在這裡調用 clearInterval
      countdownSeconds = 20; // 直接重置為20秒
    }
    
    updateCountdownDisplay();
  }, 1000);
}
// 更新倒數顯示
function updateCountdownDisplay() {
  const countdownElement = document.getElementById("countdown");
  if (countdownElement) {
    countdownElement.textContent = `${countdownSeconds}秒後重新偵測`;
  }
}
// 獲取是否為集團公司
function isGroupCompany(operatorName) {
  if (!operatorName) return false;

  // 檢查是否為集團公司
  return companies.some(
    (company) =>
      operatorName.includes(company.name) ||
      company.name.includes(operatorName)
  );
}

// 檢查 startLocationWatching 函數（約在行 500 左右）：
function startLocationWatching(silent = false) {
  // 先停止現有的監視，避免重複監視
  stopLocationWatching();
  
  if (!navigator.geolocation) {
  console.log("瀏覽器不支持地理位置API");
  if (!silent) {
    showStatusMessage("您的設備不支持位置功能", "error");
  }
  return;
}
  if (navigator.geolocation) {
    window.watchId = navigator.geolocation.watchPosition(
      (position) => {
        console.log("位置已更新");
        currentLatitude = position.coords.latitude;
        currentLongitude = position.coords.longitude;
        savePosition(currentLatitude, currentLongitude);
      },
      (error) => {
        console.log("位置監聽錯誤:", error);
        if (!silent) {
          showStatusMessage("暫時無法獲取位置，請至室外", "info");
        }
      },
      {
        enableHighAccuracy: true,
        maximumAge: 10000, // 允许10秒内的位置缓存
      }
    );
    console.log("已啟動位置監視，watchId:", window.watchId);
  }
}

// 停止位置監視
function stopLocationWatching() {
  if (window.watchId) {
    navigator.geolocation.clearWatch(window.watchId);
    window.watchId = null;
    console.log("已停止位置監視");
  }
}

// 使用改進的存儲函數保存位置
function savePosition(latitude, longitude) {
  safeStorage.set("lastKnownLatitude", latitude);
  safeStorage.set("lastKnownLongitude", longitude);
  safeStorage.set("lastPositionTimestamp", Date.now());

  // 如果成功獲取位置，清除之前的"無法獲取位置"訊息
  const statusElement = document.getElementById("statusMessage");
  if (
    statusElement.textContent.includes("無法獲取位置") ||
    statusElement.textContent.includes("暫時無法獲取位置")
  ) {
    statusElement.textContent = "";
    statusElement.className = "status-message";
  }
}


// 確保有正確的 callAPI 函數實現（約在行 460 左右）：
async function callAPI(url, options = {}, errorMessage = "操作失敗，請稍後再試", showErrorToUser = true) {
  try {
    const response = await fetchWithRetry(url, options, 3);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText || `HTTP錯誤 ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error(`API調用失敗 (${url}):`, error);
    if (showErrorToUser) {
      showStatusMessage(errorMessage, "error");
    }
    throw error;
  }
}
// 初始化 LIFF
async function initLIFF() {
  try {
    console.log("初始化LIFF...");
    const isInClient = liff.isInClient();
    console.log("是否在LINE環境中:", isInClient);
    // 使用persistent-geo參數
    const liffInfo = {
      liffId: liffId,
      withLoginOnExternalBrowser: true, // 確保在外部瀏覽器中也能登入
      persistentGeo: true, // 強調需要持續位置權限
    };
    await liff.init(liffInfo);
    liffInitialized = true;
    console.log("LIFF 初始化成功");

    if (!liff.isLoggedIn()) {
      console.log("用戶未登入，引導登入...");
      liff.login();
      return;
    }

    try {
      // 檢查用戶是否已綁定
      const profile = await liff.getProfile();
      const userId = profile.userId;
      document.getElementById("userId").value = userId;
      await checkUserExists(userId, channelId);
      const lastLocation = await fetchLastLocation(userId);
      if (lastLocation) {
        // 填入最後記錄的位置
        document.getElementById("location").value = lastLocation;
        console.log("已填入今日最後記錄位置:", lastLocation);
      }
    } catch (profileError) {
      console.error("獲取用戶資料失敗:", profileError);
      showStatusMessage("無法獲取用戶資料，請確保已授權應用程式", "error");
    }

    // 獲取其他項目列表
    await fetchOtherItems();
  } catch (error) {
    console.error("LIFF 初始化失敗:", error);
    showStatusMessage(
      "LINE 應用程式初始化失敗，請確認網路連接並重新嘗試",
      "error"
    );
    liffInitialized = false;
  } finally {
    // 確保無論如何都隱藏loading
    hideLoading();
  }
}

// 檢查用戶是否已存在/註冊
async function checkUserExists(userId, channelId) {
  try {
    const response = await fetch(base_url + "User/checkUser", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: userId, channelId: channelId }),
    });

    if (response.status === 200) {
      // 用戶已存在，顯示表單
      // 不執行 getCurrentPosition() 避免畫面被阻擋
    } else if (response.status === 404) {
      // 用戶不存在，導向註冊頁面
      liff.openWindow({
        url: "https://liff.line.me/2006993665-PVAXZjA1",
        external: true,
      });
    } else {
      showStatusMessage("檢查用戶信息時發生錯誤，請重新嘗試", "error");
    }
  } catch (error) {
    console.error("檢查用戶存在性失敗:", error);
    showStatusMessage("檢查用戶信息時發生錯誤，請重新嘗試", "error");
  }
}

// 偵測車輛
// 修改偵測車輛函數，考慮是否顯示已記錄車輛
async function detectBuses(isAutoDetection = false) {
  showLoading();
  try {
    // 確保有位置
    if (!(await getCurrentPosition(false))) {
      hideLoading();
      return;
    }


      allDetectedBuses = []; // 清空全局列表
      displayedBuses = []; // 清空顯示列表

    
    // 獲取附近車輛
    const response = await fetchWithRetry(
      `${base_url}monitor/buses?latitude=${currentLatitude}&longitude=${currentLongitude}&distance=300`,
      {},
      3 // 增加重試次數
    );
    
    if (!response.ok) {
      throw new Error(`HTTP 錯誤 ${response.status}`);
    }
    
    const data = await response.json();
    
    // 只過濾集團公司車輛，但根據includeRecordedVehicles來決定是否過濾已提交車輛
    const newDetectedBuses = [];
    const threeMinutes = 3 * 60 * 1000; // 3分鐘轉換為毫秒
    const currentTime = Date.now();
    
    if (data && data.buses && data.buses.length > 0) {
      data.buses.forEach((bus) => {
        // 檢查是否是集團公司
        if (isGroupCompany(bus.operatorName)) {
          // 添加到全局列表
          allDetectedBuses.push(bus);
          newDetectedBuses.push(bus);
          
          // 檢查是否應該添加到顯示列表中（基於includeRecordedVehicles設置）
          if (includeRecordedVehicles || !submittedBuses.includes(bus.plateNumber)) {
            // 即使不包含已記錄車輛，也需要檢查提交時間是否超過3分鐘
            if (includeRecordedVehicles || !submittedBuses.includes(bus.plateNumber) || 
               (submittedBuses.includes(bus.plateNumber) && 
                ((currentTime - parseInt(localStorage.getItem(`submitted_${bus.plateNumber}`) || '0')) >= threeMinutes))) {
              displayedBuses.push(bus);
            }
          }
        }
      });
    }
    
    // 更新UI
    updateDetectedBusesList();
    
    // 如果有新偵測到的車輛，顯示通知
    if (newDetectedBuses.length > 0) {
      showNewDetectionNotification(newDetectedBuses.length);
    } else if (!isAutoDetection) {
      // 只在手動偵測時顯示無車輛訊息
      showStatusMessage("目前附近未偵測到車輛", "info",true);
    }
    
    hideLoading();
  } catch (error) {
    console.error("偵測車輛失敗:", error);
    hideLoading();
    
    // 只在手動偵測時顯示錯誤訊息
    if (!isAutoDetection) {
      showStatusMessage("偵測車輛失敗，請稍後再試", "error",true);
    }
    
    // 確保自動偵測繼續運行，即使出現錯誤
    if (isAutoDetection && autoDetectInterval) {
      console.log("自動偵測遇到錯誤，但將繼續運行");
    }
  }
}
// 獲取車輛距離的輔助函數
function getVehicleDistance(bus) {
  // 預設999米
  let distanceInMeters = 999;
  
  // 嘗試從Distance字段獲取距離（如果存在）
  if (bus.Distance !== undefined) {
    distanceInMeters = bus.Distance * 1000; // 公里轉公尺
  }
  // 如果沒有Distance字段，嘗試從位置計算距離
  else if (bus.position && bus.position.latitude && bus.position.longitude) {
    distanceInMeters = calculateDistance(
      currentLatitude, 
      currentLongitude, 
      bus.position.latitude, 
      bus.position.longitude
    );
  }
  
  return distanceInMeters;
}

// 根據距離為元素添加CSS類
function addDistanceClassToElement(element, distanceInMeters) {
  // 先清除所有距離相關的類
  element.classList.remove("distance-veryclose", "distance-close", "distance-medium", "distance-far");
  
  // 添加對應的距離類
  if (distanceInMeters <= 80) {
    element.classList.add("distance-veryclose"); // 0-80m 滿色
  } else if (distanceInMeters <= 150) {
    element.classList.add("distance-close"); // 81-150m 3/4滿色
  } else if (distanceInMeters <= 220) {
    element.classList.add("distance-medium"); // 151-220m 2/4滿色
  } else if (distanceInMeters <= 300) {
    element.classList.add("distance-far"); // 221-300m 1/4滿色
  }
}


// 使用DocumentFragment優化更新車輛列表
function updateDetectedBusesList() {
  const container = document.getElementById("detectedBusesList");
  
  // 更新計數
  document.getElementById("busCount").textContent = `${displayedBuses.length} 輛`;
  
  // 使用DocumentFragment來減少DOM操作
  const fragment = document.createDocumentFragment();
  
  if (displayedBuses.length === 0) {
    const noDataMessage = document.createElement("div");
    noDataMessage.className = "no-buses-message";
    noDataMessage.innerHTML = `
      <i class="fas fa-bus" style="font-size: 24px; color: #adb5bd; margin-bottom: 10px;"></i>
      <p>尚未檢測到車輛，請點擊「偵測車輛」按鈕</p>
    `;
    fragment.appendChild(noDataMessage);
  } else {
    // 創建簡易車輛列表
    const busListContainer = document.createElement("div");
    busListContainer.className = "simple-bus-list";
    
    displayedBuses.forEach((bus, index) => {
      const busItem = createBusListItem(bus, index);
      busListContainer.appendChild(busItem);
    });
    
    fragment.appendChild(busListContainer);
  }
  
  // 清空容器並一次性添加所有新元素
  container.innerHTML = "";
  container.appendChild(fragment);
}


function createBusListItem(bus, index) {
  // 路線信息
  const routeInfo = bus.routeName?.chinese || "未知路線";
  
  const busItem = document.createElement("div");
  busItem.className = "simple-bus-item";
  
  // 創建路線元素包裹容器
  const routeElement = document.createElement("div");
  routeElement.className = "bus-route-container";
  
  // 使用跑馬燈包裝路線文字
  const routeTextElement = document.createElement("div");
  routeTextElement.className = "text-marquee";
  
  // 路線太長時直接啟動跑馬燈，降低門檻
  if (routeInfo.length > 4) {  // 降低門檻至4個字符
    routeTextElement.classList.add("list-marquee", "scrolling");
    
    // 創建額外的內容以確保完全滾動
    routeTextElement.innerHTML = `${routeInfo} &nbsp;&nbsp;&nbsp;&nbsp; ${routeInfo}`;
  } else {
    routeTextElement.textContent = routeInfo;
  }
  
  // 添加title屬性，方便懸停查看完整路線
  routeElement.title = routeInfo;
  
  routeElement.appendChild(routeTextElement);
  
  // 創建車號元素
  const plateElement = document.createElement("div");
  plateElement.className = "bus-plate";
  
  // 獲取距離並設置對應的CSS類
  const distanceInMeters = getVehicleDistance(bus);
  addDistanceClassToElement(plateElement, distanceInMeters);
  
  plateElement.textContent = bus.plateNumber;
  
  // 將元素添加到車輛項目中
  busItem.appendChild(routeElement);
  busItem.appendChild(plateElement);
  
  busItem.onclick = function() {
    selectBusForInput(bus, index);
  };
  
  return busItem;
}

// 計算兩點間距離的函數
function calculateDistance(lat1, lon1, lat2, lon2) {
  // 如果缺少座標，返回最大距離
  if (!lat1 || !lon1 || !lat2 || !lon2) {
    return 999;
  }
  
  // 轉為數字類型
  lat1 = parseFloat(lat1);
  lon1 = parseFloat(lon1);
  lat2 = parseFloat(lat2);
  lon2 = parseFloat(lon2);
  
  // 使用Haversine公式計算地球表面兩點間的距離
  const R = 6371000; // 地球半徑，單位為米
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;
  
  return distance;
}
// 創建車輛卡片
function createBusCard(bus, index) {
  const busCard = document.createElement("div");
  busCard.className = "bus-card";
  busCard.id = `bus-card-${index}`;

  // 公司名稱顯示，移除"客運"
  let companyName = bus.operatorName || "未知公司";
  companyName = companyName.replace(/客運$/, "");

  // 頭部信息
  const header = document.createElement("div");
  header.className = "bus-card-header";
  header.innerHTML = `
    <span class="bus-card-company">${companyName}</span>
    <span class="bus-card-plate">${bus.plateNumber || "無車號"}</span>
    `;

  // 主體內容
  const body = document.createElement("div");
  body.className = "bus-card-body";

  // 路線信息
  const routeInfo = document.createElement("div");
  routeInfo.className = "bus-card-route";
  routeInfo.textContent = `路線: ${bus.routeName?.chinese || "未知路線"}`;

  // 主要項目選擇器
  const mainItemsLabel = document.createElement("label");
  mainItemsLabel.textContent = "查核結果:";
  
  const mainItemsContainer = document.createElement("div");
  mainItemsContainer.className = "quick-items";
  mainItems.forEach((item) => {
    const itemButton = document.createElement("div");
    itemButton.className = "quick-item";
    itemButton.textContent = item;
    itemButton.dataset.value = item;
    itemButton.onclick = function () {
      // 移除同組其他選中
      mainItemsContainer.querySelectorAll(".quick-item").forEach((el) => {
        el.classList.remove("selected");
      });
      // 選中當前
      this.classList.add("selected");
      // 儲存選擇到bus對象
      bus.selectedMainItem = this.dataset.value;
    };
    mainItemsContainer.appendChild(itemButton);
  });

  // 其他項目選擇器
  const otherItemsLabel = document.createElement("label");
  otherItemsLabel.textContent = "其它:";
  
  const otherItemsContainer = document.createElement("div");
  otherItemsContainer.className = "quick-other-items";
  otherItems.forEach((item) => {
    const itemButton = document.createElement("div");
    itemButton.className = "quick-other-item";
    itemButton.textContent = item.itemName;
    itemButton.dataset.value = item.itemName;
    itemButton.onclick = function () {
      // 切換選擇
      this.classList.toggle("selected");

      // 初始化選擇數組如果不存在
      if (!bus.selectedOtherItems) {
        bus.selectedOtherItems = [];
      }

      // 更新選擇
      if (this.classList.contains("selected")) {
        bus.selectedOtherItems.push(this.dataset.value);
      } else {
        bus.selectedOtherItems = bus.selectedOtherItems.filter(
          (i) => i !== this.dataset.value
        );
      }
    };
    otherItemsContainer.appendChild(itemButton);
  });

  // 操作按鈕
  const actionsContainer = document.createElement("div");
  actionsContainer.className = "bus-card-actions";

  // 提交按鈕
  const submitButton = document.createElement("div");
  submitButton.className = "action-button submit-button";
  submitButton.innerHTML = '<i class="fas fa-check"></i> 提交記錄';
  submitButton.onclick = function () {
    submitBusRecord(bus, index);
  };

  // 只添加提交按鈕
  actionsContainer.appendChild(submitButton);

  body.appendChild(routeInfo);
  body.appendChild(mainItemsLabel);
  body.appendChild(mainItemsContainer);
  body.appendChild(otherItemsLabel);
  body.appendChild(otherItemsContainer);
  body.appendChild(actionsContainer);

  busCard.appendChild(header);
  busCard.appendChild(body);

  return busCard;
}
// 顯示新偵測通知
function showNewDetectionNotification(count) {
  const notification = document.getElementById("realTimeDetection");
  const countDisplay = document.getElementById("detectionCount");

  countDisplay.textContent = count;
  notification.classList.add("show");

  // 5秒後自動隱藏
  setTimeout(() => {
    notification.classList.remove("show");
  }, 5000);
}

// 顯示已偵測的車輛
function showDetectedBuses() {
  document.getElementById("realTimeDetection").classList.remove("show");

  // 滾動到車輛列表
  document.getElementById("detectedBusesContainer").scrollIntoView({
    behavior: "smooth",
  });
}

// 提交選中的車輛
function submitSelectedBus() {
  if (selectedBusIndex === -1) {
    showStatusMessage("請先選擇車輛", "error");
    return;
  }
  
  const bus = displayedBuses[selectedBusIndex];
  
  // 獲取選中的主要項目
  const mainItemsContainer = document.getElementById("mainItemsContainer");
  const selectedMainItem = mainItemsContainer.querySelector(".quick-item.selected");
  if (!selectedMainItem) {
    showStatusMessage("請選擇查核結果", "error");
    return;
  }
  
  // 獲取選中的其他項目
  const otherItemsContainer = document.getElementById("otherItemsContainer");
  const selectedOtherItems = Array.from(otherItemsContainer.querySelectorAll(".quick-other-item.selected"))
    .map(item => item.dataset.value);
  
  // 檢查位置
  if (!document.getElementById("location").value) {
    showStatusMessage("請選擇查核路口", "error");
    return;
  }
  
  // 提交記錄
  submitBusRecord(bus, selectedBusIndex, selectedMainItem.dataset.value, selectedOtherItems);
}

// 提交車輛記錄
async function submitBusRecord(bus, index, mainItem, otherItems) {
  showLoading();
  
  try {
  const data = {
  userId: document.getElementById("userId").value,
  location: document.getElementById("location").value,
  plateNumbCompany: bus.operatorName || "不明",  // 如果為空，顯示"不明"
  routeName: bus.routeName?.chinese || "不明",   // 如果為空，顯示"不明"
  plateNumber: bus.plateNumber,
  positionLat: `(${bus.position?.latitude || currentLatitude},${
    bus.position?.longitude || currentLongitude
  })`,
  mainItem: mainItem,
  otherItem: otherItems.join(", "),
};
    
    const response = await fetch(base_url + "monitor/records", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    
    if (response.ok) {
      // 添加到已提交列表
      submittedBuses.push(bus.plateNumber);
      
      // 設置提交時間，3分鐘內不再顯示
      const submissionTime = Date.now();
      localStorage.setItem(`submitted_${bus.plateNumber}`, submissionTime);
      
      // 從顯示列表移除
      displayedBuses = displayedBuses.filter((_, idx) => idx !== index);
      
      // 更新UI
      updateDetectedBusesList();
      
      // 隱藏輸入區域
      document.getElementById("busInputContainer").classList.add("hidden");
      selectedBusIndex = -1;
      
      showStatusMessage("已新增一筆記錄！", "success",true);
    } else {
      const error = await response.text();
      throw new Error(error || "提交記錄失敗");
    }
  } catch (error) {
    console.error("提交記錄失敗:", error);
    showStatusMessage("提交記錄失敗: " + error.message, "error");
  } finally {
    hideLoading();
  }
}

// 獲取當前位置
async function getCurrentPosition(silent = false) {
  showLoading();
  console.log("開始獲取位置...");
  
  // 新增全局變數用於重試
  let retryCount = 0;
  const maxRetries = 3;

  try {
    // 1. 首先嘗試從本地存儲讀取最近位置
    if (loadLastPosition()) {
      console.log("使用本地緩存位置成功");
      hideLoading();
      return true;
    }

    // 2. 然後在LINE環境中使用LIFF API
    const isInLineApp = liff.isInClient();
    if (isInLineApp && liffInitialized) {
      console.log("嘗試使用LIFF位置API...");

      try {
        // 設置超時，增加到10秒
        const positionPromise = liff.getPosition();
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error("LIFF位置獲取超時")), 10000);
        });

        const position = await Promise.race([
          positionPromise,
          timeoutPromise,
        ]);

        // 成功獲取位置
        console.log("LIFF位置獲取成功", position);
        currentLatitude = position.latitude;
        currentLongitude = position.longitude;
        savePosition(currentLatitude, currentLongitude);
        hideLoading();
        return true;
      } catch (liffError) {
        console.error("LIFF位置API錯誤:", liffError);
        // 繼續嘗試下一個方法
      }
    }

    // 3. 嘗試使用瀏覽器定位API (增加重試機制)
    while (retryCount < maxRetries && navigator.geolocation) {
      try {
        // 清除之前的位置監視，避免衝突
        if (window.watchId) {
          navigator.geolocation.clearWatch(window.watchId);
          window.watchId = null;
        }
        
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 15000, // 增加到15秒增加成功率
            maximumAge: 0, // 不使用緩存
          });
        });

        console.log("瀏覽器位置API獲取成功");
        currentLatitude = position.coords.latitude;
        currentLongitude = position.coords.longitude;
        savePosition(currentLatitude, currentLongitude);
        
        // 重新啟動位置監視
        startLocationWatching(true);
        
        hideLoading();
        return true;
      } catch (geoError) {
        console.error("瀏覽器位置API錯誤:", geoError.code, geoError.message);
        retryCount++;
        
        if (retryCount < maxRetries) {
          console.log(`位置獲取失敗，進行第${retryCount}次重試`);
          // 延遲2秒後重試
          await new Promise(resolve => setTimeout(resolve, 2000));
          // 循環將繼續下一次重試
        } else {
          console.log("達到最大重試次數，使用預設位置");
          // 使用預設位置
          break;
        }
      }
    }

    // 4. 使用默認位置作為後備
    console.log("使用預設位置作為後備");
    currentLatitude = 25.033; // 假設的台北市中心位置
    currentLongitude = 121.565;
    savePosition(currentLatitude, currentLongitude);
    hideLoading();

    if (!silent) {
      showStatusMessage("無法準確獲取位置，使用預設位置", "info", true);
    }
    return true;
  } catch (error) {
    console.error("位置獲取完全失敗:", error);
    hideLoading();
    
    if (!silent) {
      showStatusMessage("暫時無法獲取位置，請至室外", "info", true);
    }
    return false;
  }
}
// 添加頁面可見性變化監聽器 - 放在全局初始化區域
document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'visible') {
    console.log('頁面重新變為可見，更新位置...');
    
    // 如果位置監視器不存在，重新啟動
    if (!window.watchId) {
      startLocationWatching(true);
    }
    
    // 獲取最新位置，但使用靜默模式避免彈出訊息
    getCurrentPosition(true).then(success => {
      if (success) {
        console.log('頁面重新可見時成功更新位置');
      }
    });
  }
});

// 網絡狀態變化監聽器 - 放在全局初始化區域
window.addEventListener('online', function() {
  console.log("網絡連接恢復，重新獲取位置");
  if (document.visibilityState === 'visible') {
    getCurrentPosition(true);
  }
});

// 嘗試從 localStorage 讀取位置，使用明確的超時時間常量
function loadLastPosition() {
  const POSITION_VALID_DURATION_MS = 60 * 1000; // 60秒，即1分鐘
  
  try {
    const lastLat = safeStorage.get("lastKnownLatitude");
    const lastLng = safeStorage.get("lastKnownLongitude");
    const timestamp = safeStorage.get("lastPositionTimestamp");

    if (lastLat && lastLng && timestamp) {
      if (Date.now() - timestamp < POSITION_VALID_DURATION_MS) {
        currentLatitude = parseFloat(lastLat);
        currentLongitude = parseFloat(lastLng);
        return true;
      }
    }
  } catch (e) {
    console.log("無法從本地儲存讀取位置:", e);
  }
  return false;
}

// 檢查位置權限
function checkLocationPermission() {
  if (!navigator.permissions) {
    console.log("瀏覽器不支持權限檢查API");
    return;
  }

  navigator.permissions.query({ name: "geolocation" }).then((result) => {
    if (result.state === "denied") {
      showStatusMessage(
        "位置權限已被拒絕，請在瀏覽器或LINE設置中允許位置訪問",
        "error"
      );
    } else if (result.state === "prompt") {
      console.log("位置權限將在需要時提示用戶");
    } else if (result.state === "granted") {
      console.log("位置權限已授予");
    }
  });
}
// 刷新位置列表
function refreshLocationList() {
  // 更新按鈕狀態，顯示正在加載
  const detectButton = document.getElementById("detectLocationButton");
  if (detectButton) {
    const originalText = detectButton.innerHTML;
    detectButton.disabled = true;
    detectButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 偵測中...';

    // 移除任何存在的錯誤或無數據消息
    const errorMsg = document.getElementById("locationListError");
    if (errorMsg) errorMsg.remove();

    // 清空位置列表，添加載入中提示
    const container = document.getElementById("locationList");
    container.innerHTML = "";
    const loadingMsg = document.createElement("p");
    loadingMsg.id = "locationListLoading";
    loadingMsg.className = "no-data-message";
    loadingMsg.innerHTML =
      '<i class="fas fa-spinner fa-spin"></i> 正在搜尋附近路口...';
    container.appendChild(loadingMsg);

    // 獲取位置並刷新路口列表
    getCurrentPosition(false)
      .then((success) => {
        if (success) {
          fetchIntersections().finally(() => {
            // 無論成功與否，恢復按鈕狀態
            detectButton.disabled = false;
            detectButton.innerHTML = originalText;
          });
        } else {
          // 位置獲取失敗
          detectButton.disabled = false;
          detectButton.innerHTML = originalText;

          // 移除載入中提示
          if (document.getElementById("locationListLoading")) {
            document.getElementById("locationListLoading").remove();
          }

          showLocationListError("無法獲取位置，請稍後再試");
        }
      })
      .catch((error) => {
        // 出錯時也恢復按鈕狀態
        detectButton.disabled = false;
        detectButton.innerHTML = originalText;

        // 移除載入中提示
        if (document.getElementById("locationListLoading")) {
          document.getElementById("locationListLoading").remove();
        }

        showLocationListError("獲取位置時發生錯誤，請稍後再試");
      });
  }
}

// 打開位置選擇框
function openLocationModal() {
  // 先顯示對話框，不等待位置
  document.getElementById("locationModal").style.display = "block";

  // 添加載入中提示
  const container = document.getElementById("locationList");
  container.innerHTML = "";
  const loadingMsg = document.createElement("p");
  loadingMsg.id = "locationListLoading";
  loadingMsg.className = "no-data-message";
  loadingMsg.innerHTML =
    '<i class="fas fa-spinner fa-spin"></i> 正在搜尋附近路口...';
  container.appendChild(loadingMsg);

  // 獲取位置並獲取附近路口
  getCurrentPosition(false)
    .then((success) => {
      if (success) {
        fetchIntersections();
      } else {
        // 移除載入中提示
        if (document.getElementById("locationListLoading")) {
          document.getElementById("locationListLoading").remove();
        }
        showLocationListError("無法獲取位置，請點擊重新偵測");
      }
    })
    .catch((error) => {
      // 位置獲取失敗，但對話框已顯示
      if (document.getElementById("locationListLoading")) {
        document.getElementById("locationListLoading").remove();
      }
      showLocationListError("無法獲取位置，請點擊重新偵測");
    });
}

// 關閉位置選擇彈窗
function closeLocationModal() {
  document.getElementById("locationModal").style.display = "none";
}

// 顯示位置列表錯誤訊息
function showLocationListError(message) {
  const container = document.getElementById("locationList");
  // 先檢查是否已經有錯誤訊息
  let errorMsg = document.getElementById("locationListError");

  if (!errorMsg) {
    errorMsg = document.createElement("p");
    errorMsg.id = "locationListError";
    errorMsg.className = "no-data-message";
    container.appendChild(errorMsg);
  }

  errorMsg.textContent = message;
}
// 獲取附近交叉路口
async function fetchIntersections() {
  showLoading();
  try {
    // 始終使用最新的坐標
    const response = await fetch(
      `${base_url}monitor/intersections?latitude=${currentLatitude}&longitude=${currentLongitude}&radius=300&limit=10`
    );
   // const response = await fetch(
//      `${base_url}monitor/osm/intersections?latitude=${currentLatitude}&longitude=${currentLongitude}&radius=300&limit=5`
 //   );
    if (!response.ok) {
      throw new Error(`HTTP 錯誤 ${response.status}`);
    }

    const data = await response.json();

    if (data && data.length > 0) {
      intersections = data;
      console.log("找到附近路口:", intersections);
    } else {
      console.log("附近未找到路口");
      intersections = [];
    }

    // 更新位置選擇框中的路口列表
    updateLocationList();
    hideLoading();
  } catch (error) {
    console.error("獲取路口失敗:", error);
    hideLoading();
    showStatusMessage("無法獲取附近路口，請重新偵測", "error",true);
  }
}
// 更新位置列表
function updateLocationList() {
  const container = document.getElementById("locationList");

  // 移除載入中提示
  const loadingMsg = document.getElementById("locationListLoading");
  if (loadingMsg) loadingMsg.remove();

  // 檢查是否找到路口
  if (intersections.length === 0) {
    // 移除任何存在的錯誤訊息
    const errorMsg = document.getElementById("locationListError");
    if (errorMsg) errorMsg.remove();

    // 顯示無數據訊息
    const noDataElement = document.createElement("p");
    noDataElement.id = "locationListNoData";
    noDataElement.className = "no-data-message";
    noDataElement.textContent = "附近未找到交叉路口，請點擊重新偵測";
    container.appendChild(noDataElement);
    return;
  }

  // 清空容器，準備添加路口列表
  container.innerHTML = "";

  // 創建列表容器
  const listContainer = document.createElement("div");
  listContainer.id = "intersectionListContainer";
  listContainer.className = "bus-list-container"; // 重用現有樣式

  intersections.forEach((intersection) => {
    const item = document.createElement("div");
    item.className = "location-item";
    item.textContent = intersection.name;
    item.addEventListener("click", function () {
      document.getElementById("location").value = intersection.name;
      closeLocationModal();
    });
    listContainer.appendChild(item);
  });

  container.appendChild(listContainer);
}

// 獲取其他項目列表
async function fetchOtherItems() {
  try {
    const defaultItems = [
      { id: "1", itemName: "車身未清潔" },
      { id: "2", itemName: "車輛燈號故障" },
      { id: "3", itemName: "闖紅燈" },
      { id: "4", itemName: "LED故障" },
      { id: "5", itemName: "無動態" },
    ];

    const response = await fetch(`${base_url}monitor/otherItem`);

    if (response.ok) {
      const data = await response.json();
      if (data && data.data && data.data.length > 0) {
        otherItems = data.data;
        console.log("獲取其他項目:", otherItems);
      } else {
        console.log("使用預設其他項目");
        otherItems = defaultItems;
      }
    } else {
      console.log("API回應錯誤，使用預設其他項目");
      otherItems = defaultItems;
    }
  } catch (error) {
    console.error("獲取其他項目失敗:", error);
    // 使用預設項目
    otherItems = [
      { id: "1", itemName: "車身未清潔" },
      { id: "2", itemName: "車輛燈號故障" },
      { id: "3", itemName: "闖紅燈" },
      { id: "4", itemName: "LED故障" },
      { id: "5", itemName: "無動態" },
    ];
  }
}
// 打開已提交歷史紀錄
async function openSubmittedHistoryModal() {
  document.getElementById("historyModal").style.display = "block";

  // 清空並顯示載入中
  const container = document.getElementById("historyList");
  container.innerHTML =
    '<p class="no-data-message"><i class="fas fa-spinner fa-spin"></i> 載入紀錄中...</p>';

  try {
    // 獲取用戶ID
    const userId = document.getElementById("userId").value;
    if (!userId) {
      throw new Error("未獲取到用戶ID");
    }

    // 獲取歷史紀錄
    const response = await fetch(
      `${base_url}monitor/records/${userId}/today`
    );

    if (!response.ok) {
      throw new Error(`HTTP 錯誤 ${response.status}`);
    }

    const data = await response.json();

    // 清空容器
    container.innerHTML = "";

    // 檢查是否有記錄
    if (!data || !data.length) {
      container.innerHTML =
        '<p class="no-data-message">今日尚無提交紀錄</p>';
      return;
    }

    // 顯示記錄
    data.forEach((record) => {
      const item = document.createElement("div");
      item.className = "history-item";

      // 格式化時間
      const recordTime = new Date(record.created_at);
      const timeString = recordTime.toLocaleTimeString("zh-TW", {
        hour: "2-digit",
        minute: "2-digit",
      });

      item.innerHTML = `
            <div>
                <strong>${record.plateNumber}</strong>
                <small>${record.mainItem}</small>
            </div>
            <div class="history-time">${timeString}</div>
        `;

      container.appendChild(item);
      
      // 添加到已提交列表，確保不會重複偵測
      if (!submittedBuses.includes(record.plateNumber)) {
        submittedBuses.push(record.plateNumber);
        
        // 為每條記錄設置提交時間
        const submissionTime = new Date(record.created_at).getTime();
        localStorage.setItem(`submitted_${record.plateNumber}`, submissionTime);
      }
    });
  } catch (error) {
    console.error("獲取歷史紀錄失敗:", error);
    container.innerHTML =
      '<p class="no-data-message">獲取紀錄失敗，請稍後再試</p>';
  }
}

// 清理過期的提交記錄，使用清晰的常量命名
function cleanupExpiredSubmissions() {
  const SUBMISSION_EXPIRY_TIME_MS = 3 * 60 * 1000; // 3分鐘
  const currentTime = Date.now();
  
  try {
    // 遍歷 localStorage 查找所有提交記錄
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('submitted_')) {
        const submissionTime = parseInt(localStorage.getItem(key));
        if (currentTime - submissionTime >= SUBMISSION_EXPIRY_TIME_MS) {
          // 超過3分鐘，刪除該記錄
          localStorage.removeItem(key);
        }
      }
    }
  } catch (error) {
    console.error("清理過期提交記錄失敗:", error);
  }
}

// 關閉歷史記錄彈窗
function closeHistoryModal() {
  document.getElementById("historyModal").style.display = "none";
}

// 獲取用戶今日最後位置記錄
async function fetchLastLocation(userId) {
  try {
    if (!userId) {
      console.log("獲取最後位置失敗: 用戶ID為空");
      return null;
    }

    const response = await fetch(
      `${base_url}monitor/lastLocation/${userId}`
    );

    if (!response.ok) {
      throw new Error(`HTTP 錯誤 ${response.status}`);
    }

    const data = await response.json();

    if (data.success && data.location) {
      console.log("成功獲取最後記錄位置:", data.location);
      return data.location;
    } else {
      console.log("今天沒有位置記錄:", data.message);
      return null;
    }
  } catch (error) {
    console.error("獲取最後位置記錄失敗:", error);
    return null;
  }
}
// 顯示狀態訊息
// 更新 showStatusMessage 函數（約在行 1230 左右）：
function showStatusMessage(message, type, autoHide = false) {
  const statusElement = document.getElementById("statusMessage");
  statusElement.textContent = message;
  statusElement.className = "status-message";
  statusElement.classList.add(type);
  
  // 將頁面滾動至頂部，確保用戶可以看到錯誤訊息
  window.scrollTo({
    top: 0,
    behavior: "smooth",
  });
  
  // 如果是成功訊息或者設置了自動隱藏，5秒後自動隱藏
  if (type === "success" || autoHide) {
    setTimeout(() => {
      statusElement.textContent = "";
      statusElement.className = "status-message";
    }, 5000);
  }
  
  return statusElement; // 返回元素，以便呼叫者可以進一步操作
}

// 顯示載入中
function showLoading(timeoutMs = 10000) {
  const loadingElement = document.getElementById("loading-overlay");
  loadingElement.classList.remove("hidden");
  
  // 添加自動超時
  if (globalLoadingTimeout) clearTimeout(globalLoadingTimeout);
  globalLoadingTimeout = setTimeout(() => {
    console.warn("Loading超時，自動關閉");
    hideLoading();
  }, timeoutMs);
  
  return loadingElement;
}

// 隱藏載入中
function hideLoading() {
  document.getElementById("loading-overlay").classList.add("hidden");
  if (globalLoadingTimeout) {
    clearTimeout(globalLoadingTimeout);
    globalLoadingTimeout = null;
  }
}

// 頁面關閉前清理和保存
window.addEventListener("beforeunload", function () {
  // 停止位置監視
  stopLocationWatching();
  
  // 可以在這裡添加其他需要在頁面關閉前執行的清理代碼
});

// 添加網絡重試機制的輔助函數
async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
  try {
    const response = await fetch(url, options);
    if (response.ok) return response;
    
    throw new Error(`HTTP error ${response.status}`);
  } catch (err) {
    if (retries <= 1) throw err;
    
    await new Promise(resolve => setTimeout(resolve, delay));
    return fetchWithRetry(url, options, retries - 1, delay * 1.5);
  }
}


    </script>
</html>
