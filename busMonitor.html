<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>路口查核</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #06C755;
            --secondary-color: #333333;
            --light-gray: #f5f5f5;
            --mid-gray: #e0e0e0;
            --dark-gray: #666666;
            --error-color: #dc3545;
            --success-color: #198754;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: #f7f7f7;
            color: var(--secondary-color);
            padding-bottom: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h2 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .column {
            flex: 1;
        }
                label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
        }

        .required:after {
            content: '*';
            color: var(--error-color);
            margin-left: 4px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--mid-gray);
            border-radius: 6px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.2);
        }

        .input-group {
            display: flex;
            align-items: center;
        }

        .input-group input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .icon-button {
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button[type="submit"] {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        button[type="submit"]:hover {
            background-color: #05a64b;
        }

        .highlighted-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .line-brand {
            text-align: center;
            margin-top: 30px;
            color: var(--dark-gray);
            font-size: 14px;
        }
                /* 新增的車輛檢測面板樣式 */
        .detected-vehicles-panel {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .detected-vehicles-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .detected-vehicle-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: white;
            border-left: 4px solid #06C755;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .detected-vehicle-item:hover {
            background-color: #f0f9ff;
            transform: translateY(-2px);
            transition: all 0.2s;
        }

        .vehicle-selected {
            background-color: #e7f3fe;
            border-left: 4px solid #007bff;
        }

        .refresh-btn {
            cursor: pointer;
            float: right;
            color: #06C755;
        }

        .vehicle-info {
            display: flex;
            flex-direction: column;
        }

        .bus-company {
            font-weight: 500;
        }

        .route-name {
            color: #6c757d;
            font-size: 0.9em;
        }

        .highlighted-plate {
            font-weight: bold;
        }

        .vehicle-action {
            display: flex;
            align-items: center;
        }

        .mini-button {
            background-color: #06C755;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .mini-button:hover {
            background-color: #05a64b;
        }

        /* 快速選擇缺失項目樣式 */
        .quick-select-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-select-button {
            padding: 12px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 15px;
        }

        .quick-select-button:hover {
            background-color: #f0f9ff;
            border-color: #0d6efd;
        }

        .quick-select-button.selected {
            background-color: #06C755;
            color: white;
            border-color: #06C755;
            font-weight: 500;
        }

        .success-option {
            color: #198754;
        }

        .success-option.selected {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-button {
            padding: 6px 12px;
            border-radius: 20px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-button.selected {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .no-data-message {
            color: #6c757d;
            text-align: center;
            padding: 20px;
        }

        /* 模態窗口樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }                .modal-content {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    width: 90%;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                }
        
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid var(--light-gray);
                }
        
                .close-modal {
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                }
        
                .modal-search {
                    display: flex;
                    margin-bottom: 15px;
                }
        
                .modal-search input {
                    flex: 1;
                    padding: 10px;
                    border: 1px solid var(--mid-gray);
                    border-radius: 6px;
                }
        
                .item-list {
                    list-style: none;
                }
        
                .item-list li {
                    padding: 10px;
                    border-bottom: 1px solid var(--light-gray);
                    cursor: pointer;
                }
        
                .item-list li:hover {
                    background-color: var(--light-gray);
                }
        
                /* 狀態消息樣式 */
                .status-message {
                    padding: 15px;
                    border-radius: 6px;
                    margin-bottom: 20px;
                    display: none;
                }
        
                .status-message.success {
                    background-color: #d4edda;
                    color: #155724;
                    border: 1px solid #c3e6cb;
                    display: block;
                }
        
                .status-message.error {
                    background-color: #f8d7da;
                    color: #721c24;
                    border: 1px solid #f5c6cb;
                    display: block;
                }
        
                .status-message.info {
                    background-color: #d1ecf1;
                    color: #0c5460;
                    border: 1px solid #bee5eb;
                    display: block;
                }
        
                /* 加載指示器樣式 */
                .loading-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
        
                .loading-spinner {
                    width: 50px;
                    height: 50px;
                    border: 5px solid rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    border-top-color: #fff;
                    animation: spin 1s ease-in-out infinite;
                }
        
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
        
                .check-button {
                    background-color: #06C755;
                }
            </style>
        </head>
                <body>
            <div class="container">
                <h2>路口查核</h2>
                
                <div id="statusMessage" class="status-message"></div>
                
                <!-- 路口位置選擇 -->
                <div class="form-group">
                    <label for="location" class="required">我的位置</label>
                    <div class="input-group">
                        <input type="text" id="location" placeholder="選擇附近路口">
                        <div class="icon-button" onclick="openLocationModal()">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 新增: 偵測車輛面板 -->
                <div class="detected-vehicles-panel">
                    <h3>已偵測車輛 <span class="refresh-btn" onclick="refreshBusList()"><i class="fas fa-sync-alt"></i></span></h3>
                    <div id="detectedVehiclesList" class="detected-vehicles-list">
                        <!-- 偵測到的車輛會顯示在這裡 -->
                        <p class="no-data-message">正在偵測附近車輛...</p>
                    </div>
                </div>
                
                <!-- 查核表單 -->
                <form id="monitorForm">
                    <div class="highlighted-section">
                        <!-- 車號 -->
                        <div class="form-group">
                            <label for="plateNumber" class="required">車號</label>
                            <div class="input-group">
                                <input type="text" id="plateNumber" placeholder="車號" onblur="formatPlateNumber()" oninput="convertToUpperCase(this)">
                                <div class="icon-button" onclick="openBusModal()">
                                    <i class="fas fa-bus"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 路線和公司 -->
                        <div class="form-row">
                            <div class="column">
                                <label for="routeName">路線</label>
                                <input type="text" id="routeName" oninput="convertToUpperCase(this)">
                            </div>
                            <div class="column">
                                <label for="plateNumbCompany">公司</label>
                                <div class="input-group">
                                    <input type="text" id="plateNumbCompany" readonly>
                                    <div class="icon-button" onclick="openCompanyModal()">
                                        <i class="fas fa-building"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="positionLat">
                    <input type="hidden" id="userId">
                    
                    <!-- 新增: 缺失項目快速選擇 -->
                    <div id="mainItemContainer" class="form-group">
                        <label class="required">缺失項目</label>
                        <div class="quick-select-container">
                            <button type="button" class="quick-select-button" onclick="selectQuickOption('左轉未停')">左轉未停</button>
                            <button type="button" class="quick-select-button" onclick="selectQuickOption('右轉未停')">右轉未停</button>
                            <button type="button" class="quick-select-button" onclick="selectQuickOption('未指差')">未指差</button>
                            <button type="button" class="quick-select-button" onclick="selectQuickOption('未停未指差')">未停未指差</button>
                            <button type="button" class="quick-select-button success-option" onclick="selectQuickOption('無缺失')">無缺失</button>
                        </div>
                    </div>
                    
                    <!-- 其他缺失項目 -->
                    <div class="form-group">
                        <label>其他缺失 (可複選)</label>
                        <div class="tags-container" id="otherItemTags">
                            <!-- 其他項目將由JS動態填充 -->
                        </div>
                    </div>
                    
                    <button type="submit" onclick="submitForm(); return false;">送出記錄</button>
                    
                    <div class="line-brand">
                        首都集團路口查核平台
                    </div>
                </form>
            </div>            <!-- 路口模態窗口 -->
            <div id="locationModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>選擇路口</h3>
                        <button class="close-modal" onclick="closeLocationModal()">&times;</button>
                    </div>
                    <div class="modal-search">
                        <input type="text" id="locationSearch" placeholder="搜尋路口..." oninput="filterLocations()">
                    </div>
                    <ul id="locationList" class="item-list">
                        <!-- 動態加入路口列表 -->
                    </ul>
                </div>
            </div>
        
            <!-- 車號模態窗口 -->
            <div id="busModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>選擇車輛</h3>
                        <button class="close-modal" onclick="closeBusModal()">&times;</button>
                    </div>
                    <div class="modal-search">
                        <input type="text" id="busSearch" placeholder="搜尋車號..." oninput="filterBuses()">
                    </div>
                    <ul id="busList" class="item-list">
                        <!-- 動態加入車輛列表 -->
                    </ul>
                </div>
            </div>
        
            <!-- 公司模態窗口 -->
            <div id="companyModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>選擇公司</h3>
                        <button class="close-modal" onclick="closeCompanyModal()">&times;</button>
                    </div>
                    <ul id="companyList" class="item-list">
                        <li onclick="selectCompany('首都客運')">首都客運</li>
                        <li onclick="selectCompany('大都會客運')">大都會客運</li>
                        <li onclick="selectCompany('臺北客運')">臺北客運</li>
                        <li onclick="selectCompany('欣欣客運')">欣欣客運</li>
                        <li onclick="selectCompany('基隆客運')">基隆客運</li>
                    </ul>
                </div>
            </div>
        
            <!-- 加載指示器 -->
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        
            <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
            <script>
                                const base_url = "/api/"; //window.location.origin + "/api/";
                
                // 全局變量
                let currentLatitude = 0;
                let currentLongitude = 0;
                let locations = [];
                let buses = [];
                let otherItems = [];
                let selectedMainItem = "";  // 選中的主要項目
                let selectedOtherItems = [];  // 選中的其他項目
                let liffInitialized = false;
                // 新增: 用於存儲已偵測車輛和已處理車輛
                let detectedVehicles = []; // 用於存儲已偵測但尚未處理的車輛
                let processedVehicles = new Set(); // 用於存儲已處理過的車號，避免重複顯示
        
                // 初始化LIFF
                async function initLIFF() {
                    try {
                        await liff.init({ liffId: "2001413703-LXBPama8" });
                        liffInitialized = true;
        
                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }
        
                        const profile = await liff.getProfile();
                        console.log("LIFF登入成功", profile);
                        document.getElementById("userId").value = profile.userId;
                    } catch (error) {
                        console.error("初始化LIFF失敗", error);
                        showStatusMessage("無法初始化LIFF，請重新整理頁面", "error");
                    }
                }
        
                // 頁面載入時執行的初始化功能
                window.onload = async function () {
                    try {
                        checkLocationPermission();
                        
                        // 初始化已處理車輛的本地存儲
                        initProcessedVehicles();
                        
                        // 加載其他項目
                        await loadOtherItems();
                        
                        // 初始化LIFF
                        await initLIFF();
                        
                        if (liffInitialized && liff.isLoggedIn()) {
                            // 初始化成功後立即開始監視位置
                            startLocationWatching(true);
                            
                            // 立即執行一次位置獲取
                            getCurrentPosition(true).then(() => {
                                // 成功獲取位置後，加載附近車輛和路口
                                fetchBuses();
                                fetchNearByIntersections();
                            });
                            
                            // 設置定期刷新
                            setInterval(() => {
                                fetchBuses();
                            }, 30000); // 每30秒自動刷新一次
                        }
                    } catch (error) {
                        console.error("頁面載入時發生錯誤:", error);
                        showStatusMessage("載入頁面時發生錯誤，請重新整理", "error");
                    }
                };
                                // 新增: 初始化已處理車輛的本地存儲
                function initProcessedVehicles() {
                    try {
                        // 嘗試從localStorage讀取已處理車輛
                        const storedVehicles = localStorage.getItem('processedVehicles');
                        if (storedVehicles) {
                            // 轉換為Set
                            processedVehicles = new Set(JSON.parse(storedVehicles));
                            
                            // 檢查處理日期，如果不是今天就清空
                            const lastProcessDate = localStorage.getItem('processedVehiclesDate');
                            const today = new Date().toDateString();
                            if (lastProcessDate !== today) {
                                processedVehicles = new Set();
                                localStorage.setItem('processedVehiclesDate', today);
                            }
                        } else {
                            // 初始化空Set並存儲當前日期
                            processedVehicles = new Set();
                            localStorage.setItem('processedVehiclesDate', new Date().toDateString());
                        }
                        console.log("已載入處理過的車輛:", [...processedVehicles]);
                    } catch (e) {
                        console.error("初始化已處理車輛失敗:", e);
                        processedVehicles = new Set();
                    }
                }
        
                // 新增: 保存已處理車輛到本地存儲
                function saveProcessedVehicles() {
                    try {
                        localStorage.setItem('processedVehicles', JSON.stringify([...processedVehicles]));
                    } catch (e) {
                        console.error("保存已處理車輛失敗:", e);
                    }
                }
        
                // 新增: 更新偵測到的車輛列表顯示
                function updateDetectedVehiclesList() {
                    const container = document.getElementById("detectedVehiclesList");
                    if (!container) return;
                    
                    container.innerHTML = "";
                    
                    if (detectedVehicles.length === 0) {
                        const noDataElement = document.createElement("p");
                        noDataElement.className = "no-data-message";
                        noDataElement.textContent = "附近未發現本集團車輛";
                        container.appendChild(noDataElement);
                        return;
                    }
                    
                    detectedVehicles.forEach((bus, index) => {
                        const item = document.createElement("div");
                        item.className = "detected-vehicle-item";
                        item.dataset.index = index;
                        
                        // 處理公司名稱 - 移除"客運"兩字
                        let companyName = bus.operatorName || '未知公司';
                        companyName = companyName.replace(/客運$/, '');
                        
                        const vehicleInfo = document.createElement("div");
                        vehicleInfo.className = "vehicle-info";
                        vehicleInfo.innerHTML = `
                            <span class="bus-company">${companyName}</span>
                            <span class="route-name">${bus.routeNameInfo?.Zh_tw || '未知路線'}</span>
                            <span class="highlighted-plate">${bus.plateNumb || '無車號'}</span>
                        `;
                        
                        const actionBtn = document.createElement("div");
                        actionBtn.className = "vehicle-action";
                        actionBtn.innerHTML = `
                            <button class="mini-button check-button" onclick="selectVehicleForCheck(${index})">
                                <i class="fas fa-clipboard-check"></i> 查核
                            </button>
                        `;
                        
                        item.appendChild(vehicleInfo);
                        item.appendChild(actionBtn);
                        container.appendChild(item);
                    });
                }
        
                // 新增: 當選擇車輛進行查核時
                function selectVehicleForCheck(index) {
                    const bus = detectedVehicles[index];
                    if (!bus) return;
                    
                    // 填充表單
                    document.getElementById("plateNumber").value = bus.plateNumb;
                    document.getElementById("plateNumbCompany").value = bus.operatorName || '';
                    document.getElementById("routeName").value = bus.routeNameInfo?.Zh_tw || '';
                    document.getElementById("positionLat").value = `(${bus.position?.latitude || bus.position?.Latitude},${bus.position?.longitude || bus.position?.Longitude})`;
                    
                    // 突出顯示選中的車輛
                    document.querySelectorAll('.detected-vehicle-item').forEach(el => {
                        el.classList.remove('vehicle-selected');
                    });
                    
                    const selectedItem = document.querySelector(`.detected-vehicle-item[data-index="${index}"]`);
                    if (selectedItem) {
                        selectedItem.classList.add('vehicle-selected');
                    }
                    
                    // 滾動到缺失項目部分，方便用戶填寫
                    document.getElementById("mainItemContainer").scrollIntoView({ behavior: 'smooth' });
                }
        
                // 新增: 手動刷新車輛列表
                function refreshBusList() {

                    fetchBuses();
                }
        
                // 新增: 快速選擇缺失項目
                function selectQuickOption(option) {
                    // 移除所有快速選項的選中狀態
                    document.querySelectorAll('.quick-select-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // 為當前選中的選項添加選中狀態
                    const buttons = document.querySelectorAll('.quick-select-button');
                    for (let btn of buttons) {
                        if (btn.textContent.trim() === option) {
                            btn.classList.add('selected');
                            break;
                        }
                    }
                    
                    // 更新選中的主要項目
                    selectedMainItem = option;
                    console.log("選擇主要項目:", selectedMainItem);
                }
        
                // 更新: 獲取附近的車輛
                async function fetchBuses() {
                    showLoading();
                    try {
                        const response = await fetch(`${base_url}monitor/buses?latitude=${currentLatitude}&longitude=${currentLongitude}&distance=300`);
        
                        if (!response.ok) {
                            throw new Error(`HTTP 錯誤 ${response.status}`);
                        }
        
                        const data = await response.json();
                        
                        // 過濾出本集團車輛並排除已處理的車輛
                        if (data && data.buses && data.buses.length > 0) {
                            const newBuses = data.buses.filter(bus => {
                                // 排除非本集團車輛
                                if (bus.operatorName === "非本集團") return false;
                                
                                // 排除已處理的車輛
                                if (processedVehicles.has(bus.plateNumb)) return false;
                                
                                return true;
                            });
                            
                            // 更新偵測到的車輛列表
                            detectedVehicles = newBuses;
                            console.log("找到附近車輛:", detectedVehicles);
                        } else {
                            console.log("附近未找到符合條件的車輛");
                            detectedVehicles = [];
                        }
        
                        hideLoading();
                        
                        // 更新車輛列表顯示
                        updateDetectedVehiclesList();
                        
                        // 同時也更新傳統車號選擇模態窗口
                        buses = detectedVehicles;
                    } catch (error) {
                        console.error("獲取車輛失敗:", error);
                        hideLoading();
                        showStatusMessage("無法獲取附近車輛，請稍後再試", "error");
                    }
                }

function updateOtherItemTags() {
    const container = document.getElementById("otherItemTags");
    if (!container) return;
    
    container.innerHTML = "";
    
    otherItems.forEach(item => {
        const tag = document.createElement("button");
        tag.className = "tag-button";
        tag.type = "button";
        tag.textContent = item.itemName;
        tag.addEventListener("click", function() {
            // 切換選擇狀態
            this.classList.toggle("selected");
            
            if (this.classList.contains("selected")) {
                if (!selectedOtherItems.includes(item.itemName)) {
                    selectedOtherItems.push(item.itemName);
                }
            } else {
                selectedOtherItems = selectedOtherItems.filter(i => i !== item.itemName);
            }
            console.log("選擇其他項目:", selectedOtherItems);
        });
        container.appendChild(tag);
    });
}
// 載入其他項目
async function loadOtherItems() {
    try {
        const response = await fetch(`${base_url}monitor/otherItem`);
        if (!response.ok) {
            throw new Error(`HTTP 錯誤 ${response.status}`);
        }
        const data = await response.json();
       if (data && data.data && data.data.length > 0) {
            otherItems = data.data;
            console.log("載入其他項目:", otherItems);
            updateOtherItemTags();
        }
    } catch (error) {
        console.error("載入其他項目失敗:", error);
        showStatusMessage("無法載入其他項目，請稍後再試", "error");
    }
}
// 檢查位置權限
function checkLocationPermission() {
    if (!navigator.geolocation) {
        showStatusMessage("您的瀏覽器不支援地理位置功能", "error");
        return false;
    }
    return true;
}

// 獲取當前位置
async function getCurrentPosition(showLoadingIndicator = false) {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject("瀏覽器不支援地理位置功能");
            return;
        }
        
        if (showLoadingIndicator) {
            showLoading();
        }
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentLatitude = position.coords.latitude;
                currentLongitude = position.coords.longitude;
                console.log(`位置更新: ${currentLatitude}, ${currentLongitude}`);
                
                if (showLoadingIndicator) {
                    hideLoading();
                }
                
                resolve(position);
            },
            (error) => {
                console.error("獲取位置失敗:", error.message);
                showStatusMessage("無法獲取位置，請確認已授權位置權限", "error");
                
                if (showLoadingIndicator) {
                    hideLoading();
                }
                
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    });
}

// 開始監視位置
function startLocationWatching(showLoadingIndicator = false) {
    if (watchId) return; // 已經在監視中
    
    if (!navigator.geolocation) {
        showStatusMessage("您的瀏覽器不支援地理位置功能", "error");
        return;
    }
    
    if (showLoadingIndicator) {
        showLoading();
    }
    
    watchId = navigator.geolocation.watchPosition(
        (position) => {
            currentLatitude = position.coords.latitude;
            currentLongitude = position.coords.longitude;
            console.log(`位置更新: ${currentLatitude}, ${currentLongitude}`);
            
            if (showLoadingIndicator) {
                hideLoading();
            }
        },
        (error) => {
            console.error("監視位置失敗:", error.message);
            
            if (showLoadingIndicator) {
                hideLoading();
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// 停止監視位置
function stopLocationWatching() {
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
}
// 獲取附近路口
async function fetchNearByIntersections() {
    if (!currentLatitude || !currentLongitude) {
        showStatusMessage("尚未獲取到位置", "error");
        return;
    }
    
    try {
        const response = await fetch(`${base_url}monitor/intersections?latitude=${currentLatitude}&longitude=${currentLongitude}&radius=500&limit=20`);
        
        if (!response.ok) {
            throw new Error(`HTTP 錯誤 ${response.status}`);
        }
        
        const data = await response.json();
        if (data && data.intersections) {
            locations = data.intersections;
            console.log("附近路口:", locations);
        }
    } catch (error) {
        console.error("獲取路口失敗:", error);
        showStatusMessage("無法獲取附近路口，請稍後再試", "error");
    }
}

// 打開路口選擇模態框
function openLocationModal() {
    document.getElementById("locationModal").style.display = "block";
    updateLocationList();
}

// 關閉路口選擇模態框
function closeLocationModal() {
    document.getElementById("locationModal").style.display = "none";
}

// 過濾路口列表
function filterLocations() {
    const searchText = document.getElementById("locationSearch").value.toLowerCase();
    updateLocationList(searchText);
}

// 更新路口列表
function updateLocationList(filterText = "") {
    const locationList = document.getElementById("locationList");
    locationList.innerHTML = "";
    
    let filteredLocations = locations;
    if (filterText) {
        filteredLocations = locations.filter(location => 
            location.name.toLowerCase().includes(filterText)
        );
    }
    
    filteredLocations.forEach(location => {
        const li = document.createElement("li");
        li.textContent = location.name;
        li.onclick = () => {
            document.getElementById("location").value = location.name;
            closeLocationModal();
        };
        locationList.appendChild(li);
    });
    
    if (filteredLocations.length === 0) {
        const li = document.createElement("li");
        li.textContent = "沒有匹配的路口";
        li.style.cursor = "default";
        locationList.appendChild(li);
    }
}
// 打開車輛選擇模態框
function openBusModal() {
    document.getElementById("busModal").style.display = "block";
    updateBusList();
}

// 關閉車輛選擇模態框
function closeBusModal() {
    document.getElementById("busModal").style.display = "none";
}

// 過濾車輛列表
function filterBuses() {
    const searchText = document.getElementById("busSearch").value.toLowerCase();
    updateBusList(searchText);
}

// 更新車輛列表
function updateBusList(filterText = "") {
    const busList = document.getElementById("busList");
    busList.innerHTML = "";
    
    let filteredBuses = buses;
    if (filterText) {
        filteredBuses = buses.filter(bus => 
            bus.plateNumb?.toLowerCase().includes(filterText)
        );
    }
    
    filteredBuses.forEach(bus => {
        const li = document.createElement("li");
        const companyName = bus.operatorName || '未知公司';
        const routeName = bus.routeNameInfo?.Zh_tw || '未知路線';
        li.innerHTML = `<strong>${bus.plateNumb || '無車號'}</strong> - ${routeName} (${companyName})`;
        li.onclick = () => {
            document.getElementById("plateNumber").value = bus.plateNumb || '';
            document.getElementById("plateNumbCompany").value = bus.operatorName || '';
            document.getElementById("routeName").value = bus.routeNameInfo?.Zh_tw || '';
            document.getElementById("positionLat").value = `(${bus.position?.latitude || bus.position?.Latitude},${bus.position?.longitude || bus.position?.Longitude})`;
            closeBusModal();
        };
        busList.appendChild(li);
    });
    
    if (filteredBuses.length === 0) {
        const li = document.createElement("li");
        li.textContent = "沒有匹配的車輛";
        li.style.cursor = "default";
        busList.appendChild(li);
    }
}

// 打開公司選擇模態框
function openCompanyModal() {
    document.getElementById("companyModal").style.display = "block";
}

// 關閉公司選擇模態框
function closeCompanyModal() {
    document.getElementById("companyModal").style.display = "none";
}

// 選擇公司
function selectCompany(company) {
    document.getElementById("plateNumbCompany").value = company;
    closeCompanyModal();
}
// 提交表單
async function submitForm() {
    // 表單驗證
    let isValid = true;

    // 驗證位置
    if (!document.getElementById("location").value) {
        showStatusMessage("沒有輸入查核路口", "error");
        isValid = false;
    }

    // 驗證車號
    if (!document.getElementById("plateNumber").value) {
        showStatusMessage("沒有輸入車號", "error");
        isValid = false;
    }

    // 驗證主要項目
    if (!selectedMainItem) {
        showStatusMessage("沒有選擇主要查核結果", "error");
        isValid = false;
    }

    if (!isValid) {
        return;
    }

    // 禁用提交按鈕，防止重複提交
    showLoading();
    const submitButton = document.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 送出中...';

    const plateNumber = document.getElementById("plateNumber").value;
    
    const data = {
        userId: document.getElementById("userId").value,
        location: document.getElementById("location").value,
        plateNumbCompany: document.getElementById("plateNumbCompany").value,
        routeName: document.getElementById("routeName").value,
        plateNumber: plateNumber,
        positionLat: document.getElementById("positionLat").value,
        mainItem: selectedMainItem,
        otherItem: selectedOtherItems.join(', ') // 將陣列轉為字串
    };

    try {
        const response = await fetch(base_url + "monitor/records", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            window.scrollTo(0, 0);
            showStatusMessage("記錄已成功送出！", "success");
            
            // 將此車號加入已處理列表
            processedVehicles.add(plateNumber);
            // 保存已處理車輛列表
            saveProcessedVehicles();
            
            // 從顯示列表中移除已提交的車輛
            detectedVehicles = detectedVehicles.filter(bus => bus.plateNumb !== plateNumber);
            updateDetectedVehiclesList();
            
            // 重設表單
            resetForm();
        } else {
            const error = await response.text();
            throw new Error(error || "送出記錄失敗");
        }
    } catch (error) {
        console.error("送出記錄失敗:", error);
        showStatusMessage("送出記錄失敗: " + error.message, "error");
    } finally {
        hideLoading();
        submitButton.disabled = false;
        submitButton.innerHTML = '送出記錄';
    }
}

// 重設表單
function resetForm() {
    document.getElementById("plateNumber").value = "";
    document.getElementById("plateNumbCompany").value = "";
    document.getElementById("routeName").value = "";
    document.getElementById("positionLat").value = "";

    // 清除所有選擇狀態
    document.querySelectorAll(".quick-select-button").forEach(btn => btn.classList.remove("selected"));
    document.querySelectorAll(".tag-button").forEach(tag => tag.classList.remove("selected"));
    
    selectedMainItem = "";
    selectedOtherItems = [];
}
// 顯示狀態訊息
function showStatusMessage(message, type) {
    const statusElement = document.getElementById("statusMessage");
    statusElement.textContent = message;
    statusElement.className = `status-message ${type}`;
    
    // 自動消失
    if (type === "success") {
        setTimeout(() => {
            statusElement.className = "status-message";
            statusElement.textContent = "";
        }, 3000);
    }
}

// 顯示載入指示器
function showLoading() {
    document.getElementById("loadingOverlay").style.display = "flex";
}

// 隱藏載入指示器
function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
}

// 車號轉大寫
function convertToUpperCase(input) {
    input.value = input.value.toUpperCase();
}

// 格式化車號
function formatPlateNumber() {
    const input = document.getElementById("plateNumber");
    let value = input.value.toUpperCase();
    
    // 移除所有非字母數字字符
    value = value.replace(/[^A-Z0-9]/g, '');
    
    // 檢查是否符合台灣車牌格式（如 ABC-1234）
    if (/^[A-Z]{2,3}\d{3,4}$/.test(value)) {
        if (value.length === 7) {
            // 3 字母 + 4 數字格式
            value = value.substring(0, 3) + '-' + value.substring(3);
        } else if (value.length === 6) {
            // 2 字母 + 4 數字格式或 3 字母 + 3 數字格式
            if (/^[A-Z]{2}\d{4}$/.test(value)) {
                value = value.substring(0, 2) + '-' + value.substring(2);
            } else if (/^[A-Z]{3}\d{3}$/.test(value)) {
                value = value.substring(0, 3) + '-' + value.substring(3);
            }
        } else if (value.length === 5) {
            // 2 字母 + 3 數字格式
            value = value.substring(0, 2) + '-' + value.substring(2);
        }
    }
    
    input.value = value;
}
// 處理視窗大小變化
window.addEventListener('resize', function() {
    // 手機設備上調整一些UI元素
    if (window.innerWidth <= 768) {
        // 手機設備的特殊處理
    }
});

// 頁面卸載前保存數據
window.addEventListener('beforeunload', function(e) {
    // 保存已處理車輛到本地存儲
    saveProcessedVehicles();
});
</script>
</body>
</html>
