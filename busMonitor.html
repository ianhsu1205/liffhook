<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>查核記錄</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: "Noto Sans TC", Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        color: #000;
      }

      .container {
        max-width: 500px;
         margin: 0 auto; /* 修改為0 auto使頂部無間距 */
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      h2 {
        margin-top: 10px; /* 減少上邊距 */
        color: #06c755;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
     border-bottom: none; /* 移除底部分隔線 */
        padding-bottom: 15px;
      }
/* 車輛距離黃白漸層底色樣式 */
.bus-plate.distance-veryclose { 
  background: linear-gradient(to right, #ffeb3b 100%, #ffffff 100%);
  border: 1px solid #ffc107;
}

.bus-plate.distance-close { 
  background: linear-gradient(to right, #ffeb3b 75%, #ffffff 75%);
  border: 1px solid #ffd54f;
}

.bus-plate.distance-medium { 
  background: linear-gradient(to right, #ffeb3b 50%, #ffffff 50%);
  border: 1px solid #ffe082;
}

.bus-plate.distance-far { 
  background: linear-gradient(to right, #ffeb3b 25%, #ffffff 25%);
  border: 1px solid #ffecb3;
}

/* 自動偵測按鈕啟動樣式 */
.utility-button.auto-detect-active {
  background-color: #06c755 !important;
  color: white !important;
  border-color: #04a73e !important;
  box-shadow: 0 0 8px rgba(6, 199, 85, 0.5) !important;
  transform: translateY(-2px) !important;
  position: relative;
  animation: pulse 1.5s infinite;
}
      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }

      .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 4px;
      }

      /* 輸入框樣式 */
      .input-group {
        display: flex;
        align-items: center;
      }

      .input-group input {
        flex: 1;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
      }

      .input-group .icon-button {
        width: 46px;
        height: 46px;
        border: 1px solid #ddd;
        border-left: none;
        background-color: #f8f9fa;
        border-top-right-radius: 6px;
        border-bottom-right-radius: 6px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .input-group .icon-button:hover {
        background-color: #e9ecef;
      }

      .input-group .icon-button i {
        color: #06c755;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border 0.3s;
        box-sizing: border-box;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: #06c755;
        outline: none;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.1);
      }

      /* 新增：檢測車輛卡片樣式 */
      .bus-card {
        background-color: #fff;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 15px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .bus-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .bus-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
      }

      .bus-card-company {
        font-weight: bold;
        color: #06c755;
      }

      .bus-card-plate {
        font-weight: bold;
        background-color: #ffeb3b;
        padding: 3px 8px;
        border-radius: 4px;
      }

      .bus-card-body {
        padding: 15px;
      }

      .bus-card-route {
        margin-bottom: 10px;
        font-size: 15px;
      }

      .bus-card-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }

      button {
        width: 100%;
        padding: 14px;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 10px;
      }

      button:hover {
        background-color: #04a73e;
        box-shadow: 0 4px 8px rgba(6, 199, 85, 0.2);
      }

      .secondary-button {
        background-color: #f1f1f1;
        color: #333;
      }

      .secondary-button:hover {
        background-color: #e5e5e5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 簡化選項樣式 */
      .quick-items {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }

      .quick-item {
  background-color: #f1f1f1;
  border-radius: 20px;
  padding: 8px 14px; /* 放大按鈕尺寸 */
  font-size: 15px; /* 放大字體 */
  cursor: pointer;
  border: 1px solid #ddd;
  transition: all 0.2s ease;
  margin-bottom: 5px; /* 增加間距 */
      }

      .quick-item.selected {
  background-color: #06c755;
  color: white;
  border-color: #04a73e;
  box-shadow: 0 2px 6px rgba(6, 199, 85, 0.3);
  transform: translateY(-2px);
  position: relative;
  font-weight: bold;
      }
      .quick-item.selected::after {
  content: "✓";
  position: absolute;
  top: -8px;
  right: -8px;
  background-color: #04a73e;
  color: white;
  font-size: 12px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
      /* 其他項目簡化樣式 */
      .quick-other-items {
  touch-action: pan-y; /* 允許垂直滑動，但不影響水平滑動 */
      }
      .swipe-container, 
.content-container {
  width: 100%;
  overflow: hidden;
  position: relative;
}
      .quick-other-item {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  position: relative;
      }
      /* 修正滑動容器問題 */
.category-pages {
  display: flex;
  width: 100%;
  transition: transform 0.3s ease;
}
      .quick-other-item.selected {
  background-color: #e7f3fe;
  color: #004085;
  border-color: #b8daff;
  border-width: 2px;
  font-weight: bold;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
      }
/* 為其他項目添加選中標記 */
.quick-other-item.selected::after {
  content: "✓";
  position: absolute;
  top: -8px;
  right: -8px;
  background-color: #007bff;
  color: white;
  font-size: 12px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }

      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        display: block;
      }

      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        display: block;
      }

      .status-message.info {
        background-color: #e7f3fe;
        color: #004085;
        display: block;
      }

      /* 即時偵測結果小卡 */
      .real-time-detection {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #06c755;
        color: white;
        padding: 10px 15px;
        border-radius: 30px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 99;
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .real-time-detection.show {
        opacity: 1;
        transform: translateY(0);
      }

      .detection-count {
        background-color: white;
        color: #06c755;
        font-weight: bold;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* 動作按鈕樣式 */
      .action-button {
        padding: 10px;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .submit-button {
        background-color: #06c755;
        color: white;
      }
      
      .submit-button:hover {
        background-color: #04a73e;
      }
      
      .remove-button {
        background-color: #f8d7da;
        color: #721c24;
      }
      
      .remove-button:hover {
        background-color: #f5c6cb;
      }
      
 @media (max-width: 480px) {
    .utility-buttons {
      grid-template-columns: repeat(3, 1fr);
    }
  }
.utility-buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin: 15px 0;
}
      .utility-button {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px 8px;
  border-radius: 6px;
  background-color: #f1f1f1;
  color: #333;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid #ddd;
  gap: 5px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
      }
      
      .utility-button:hover {
        background-color: #e5e5e5;
      }
      .utility-button i {
  font-size: 18px;
  margin-bottom: 4px;
}
      .utility-button.primary {
        background-color: #e7f3fe;
        color: #004085;
        border-color: #b8daff;
      }
      
      .utility-button.primary:hover {
        background-color: #d1e7ff;
      }
      
      /* 無檢測結果時的樣式 */
      .no-buses-message {
  text-align: center;
  padding: 30px 0; /* 只保留上下內邊距，左右邊距設為0 */
  background-color: #f8f9fa;
  border-radius: 8px;
  color: #6c757d;
  margin: 20px 0;
  width: 100%;
  box-sizing: border-box;
  display: block; /* 確保是塊級元素 */
      }
      /* 確保內部文字左右有適當距離 */
.no-buses-message p {
  padding: 0 20px;
  margin: 0;
}
           
      /* 查詢歷史樣式 */
      .history-list {
        margin-top: 15px;
      }
      
      .history-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
      }
      
      .history-time {
        color: #6c757d;
        font-size: 12px;
      }
      
      /* 狀態標籤 */
      .status-tag {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 5px;
      }
      
      .status-processing {
        background-color: #fff3cd;
        color: #856404;
      }
      
      .status-submitted {
        background-color: #d4edda;
        color: #155724;
      }
      
      /* 位置項目樣式 */
      .location-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }
      
      .location-item:hover {
        background-color: #f9f9f9;
      }
      
      /* 檢測按鈕容器樣式 */
      .detect-button-container {
  margin-bottom: 15px;
  text-align: center;
  display: flex;
  gap: 10px;
  justify-content: center;
      }
      
      .detect-button {
  width: auto !important;
  padding: 10px 15px !important;
  margin: 0 !important;
  flex: 1;
      }
     #onBoardInspectionButton {
  background-color: #f8f9fa;
  color: #333;
}

#onBoardInspectionButton:hover {
  background-color: #e9ecef;
} 
      /* 無數據提示樣式 */
      .no-data-message {
        text-align: center;
        padding: 15px;
        color: #6c757d;
        font-style: italic;
      }
      
      /* 彈窗模態樣式補充 */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 500px;
        max-height: 70vh;
        overflow-y: auto;
        animation: slideDown 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      
      @keyframes slideDown {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      
      /* 載入中覆蓋層樣式補充 */
      .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
      }
      
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #06c755;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .hidden {
        display: none;
      }
      
      /* 公司信息與品牌 */
      .line-brand {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #999;
        padding-top: 15px;
        border-top: 1px solid #f0f0f0;
      }
      
      /* 檢測結果區域 */
      .detected-buses-container {
        margin-top: 20px;
        margin-bottom: 20px;
      }
      
      .detection-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
      }
      .detection-title-area {
  display: flex;
  align-items: center;
}
      
      .detection-header h3 {
        margin: 0;
        color: #06c755;
      }
      /* 簡易車輛列表樣式 */
.simple-bus-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 改回固定的2列佈局 */
    gap: 10px;
    margin-top: 15px;
}
/* 路線容器固定寬度 */
.bus-route-container {
  width: 125px;            /* 固定寬度 */
  overflow: hidden;    
  white-space: nowrap;
  position: relative;
  margin-right: 0px;      /* 右側間距 */
}
.simple-bus-item {
  background-color: #f8f9fa;
  border: 1px solid #eee;
  border-radius: 6px;
  display: flex;
  justify-content: flex-start;  /* 改為從左開始排列 */
  align-items: center;
  width: 100%;
  padding: 8px 6px;
  box-sizing: border-box;
  margin: 0;
  min-height: 45px;
  overflow: hidden;
    height: 45px; /* 固定高度 */
  margin-bottom: 0;
  transform: translate3d(0, 0, 0); /* 啟用硬體加速，減少重繪 */
  transition: transform 0.2s ease, background-color 0.2s ease;
}
button, .utility-button, .quick-item, .simple-bus-item {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.simple-bus-item strong {
  font-size: 15px; /* 車牌號碼稍微大一點 */
}

.simple-bus-item:hover {
  background-color: #e7f3fe;
  border-color: #b8daff;
  transform: translateY(-2px);
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
}
/* 添加到您的CSS中 */
@font-face {
  font-family: 'FontAwesome';
  font-display: swap; /* 改善字體載入 */
}
.company-label {
 color: #06c755;
  font-weight: 500;
  font-size: 15px; /* 減小公司名稱字體 */
}
/* 然後在媒體查詢中處理響應式 */
@media (min-width: 481px) {
  .simple-bus-list {
    grid-template-columns: repeat(2, 1fr); /* 大螢幕使用2列 */
  }
}

@media (max-width: 480px) {
  .simple-bus-list {
    grid-template-columns: repeat(2, 1fr); /* 小螢幕仍保持2列 */
  }
}

@media (max-width: 320px) {
  .simple-bus-list {
    grid-template-columns: 1fr; /* 只有在非常小的螢幕(320px以下)才使用單列 */
  }
}
#detectedBusesList {
  padding: 0;
  margin: 0;
  width: 100%;
}
/* 固定輸入區域樣式 */
.bus-input-container {
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-top: 20px;
  margin-bottom: 20px;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  transition: all 0.3s ease;
}
.bus-route {
  color: #004085;
  font-weight: 500;
  font-size: 15px;
  max-width: 70%;
  overflow: hidden;
  white-space: nowrap;
  position: relative;
}
.bus-plate {
  flex-shrink: 0;
  width: 65px !important; /* 固定統一寬度 */
  min-width: 65px !important;
  max-width: 65px !important;
  text-align: center;
  background-color: #ffeb3b;
  padding: 3px 4px;
  border-radius: 4px;
  font-weight: bold;
  font-size: 14px;
  margin-left: 4px;
  white-space: nowrap;
  overflow: hidden; /* 過長時隱藏 */
}

.bus-info-header {
  background-color: #f8f9fa;
  padding: 15px;
  border-bottom: 1px solid #eee;
}

.route-info {
  color: #004085; /* 加深顏色讓路線更明顯 */
  margin-top: 0;
  margin-bottom: 5px;
  font-size: 18px;
  font-weight: 500; /* 加粗 */
  text-align: left; /* 添加這行使文字靠左 */
}

.input-section {
  padding: 15px;
    overflow-x: hidden; /* 防止水平溢出 */
}
  * {
    touch-action: manipulation; /* 優化觸控體驗 */
  }
.input-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.cancel-button {
  background-color: #f1f1f1;
  color: #333;
}

.cancel-button:hover {
  background-color: #e5e5e5;
}

/* 倒數計時容器 */
.countdown-container {
    text-align: center;
    margin-top: 8px;
    margin-bottom: 8px;
    color: #06c755;
    font-size: 14px;
    font-weight: bold;
}
/* 開關按鈕樣式 */
.switch-container {
  display: flex;
  align-items: center;
  margin-left: 10px;
  font-size: 14px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 20px;
  margin-right: 6px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #06c755;
}

input:checked + .slider:before {
  transform: translateX(20px);
}
 /* 添加到現有樣式的最後 */
  /* 跑馬燈效果樣式 */
  .text-marquee {
  display: inline-block;
  white-space: nowrap;
  overflow: hidden;
  width: 100%;
  color: #004085;
  font-weight: 500;
  flex: 1;
  will-change: transform; /* 優化硬體加速 */
  transform: translateZ(0); /* 啟用硬體加速 */
  }
  
.text-marquee.scrolling {
  animation: marquee-transform var(--scroll-duration, 15s) linear infinite;
  animation-fill-mode: forwards;
  backface-visibility: hidden; /* 減少渲染層 */
  contain: paint; /* 告訴瀏覽器只需重新繪製此元素 */
}
/* 優化的跑馬燈動畫，使用 transform 而非 left/right */
@keyframes marquee-transform {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}
/* 列表項中的跑馬燈速度更快 */
.list-marquee.scrolling {
  position: relative;
  width: auto;
  padding-left: 0;
  animation: continuous-scroll-transform 15s linear infinite;
  white-space: nowrap;
  backface-visibility: hidden;
  contain: paint;
}
/* 優化的連續滾動動畫 */
@keyframes continuous-scroll-transform {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}
/* 對於低效能設備的備選方案 */
@media (prefers-reduced-motion: reduce) {
  .text-marquee.scrolling,
  .list-marquee.scrolling {
    animation: none; /* 禁用動畫 */
    text-overflow: ellipsis; /* 使用省略號 */
  }
}
/* 添加額外空間，確保文本之間有適當間距 */
.list-marquee.scrolling::after {
content: "　"; /* 使用單個全角空格作為間隔 */
}
  .text-marquee:hover {
    animation-play-state: paused;
  }
  :root {
  --character-scroll-speed: 0.7s; /* 每個字符滾動所需時間 */
}
  .text-marquee:hover {
    animation-play-state: paused;
  }
  :root {
  --character-scroll-speed: 0.7s; /* 每個字符滾動所需時間 */
}
@keyframes continuous-scroll {
  0% { transform: translateX(100%); }    /* 從完全隱藏的右側開始 */
  100% { transform: translateX(-100%); }  /* 滾動到左側結束 */
}
    @keyframes marquee-scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }
  
  /* 調整路線顯示容器 */
  .route-info {
  color: #004085;
  margin-top: 0;
  margin-bottom: 5px;
  font-size: 18px;
  font-weight: 500;
  text-align: left;
  width: 100%;
  overflow: hidden;
  }
  
  /* 確保跑馬燈容器寬度正確 */
  #inputBusRoute {
  width: 100%;
  overflow: hidden;
  position: relative;
  }
/* 響應式調整 */
@media (max-width: 480px) {
  .switch-container {
    font-size: 12px;
  }
  
  .switch {
    width: 36px;
    height: 18px;
  }
  
  .slider:before {
    height: 14px;
    width: 14px;
  }
  
  input:checked + .slider:before {
    transform: translateX(18px);
  }
}

/* 添加脈動動畫效果 */
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(6, 199, 85, 0); }
  100% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0); }
}

/* 倒數計時文字樣式 */
.countdown-container {
  font-weight: bold;
  color: #06c755;
}
.action-button.disabled {
    opacity: 0.7;
    pointer-events: none;
    cursor: not-allowed;
}
.simple-bus-item.selected-bus-item {
  border: 2px solid #06c755;
  background-color: rgba(6, 199, 85, 0.1);
  position: relative;
}

.simple-bus-item.selected-bus-item::after {
  content: "編輯中";
  position: absolute;
  top: -8px;
  right: -8px;
  background-color: #06c755;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
}
 /* 位置精度指示器樣式 */
  .location-accuracy-container {
    margin-top: 5px;
    font-size: 12px;
  }
  
  .location-accuracy {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .utility-button.detecting {
  background-color: #ffeb3b !important;
  color: #333 !important;
  border-color: #ffc107 !important;
  box-shadow: 0 0 8px rgba(255, 193, 7, 0.7) !important;
  position: relative;
  animation: detecting-pulse 1.5s infinite;
}
/* 添加脈動動畫效果 */
@keyframes detecting-pulse {
  0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
}
/* 偵測指示器樣式 */
.detection-indicator {
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
.detection-indicator.active {
  opacity: 1;
}

.detection-indicator .spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top: 2px solid #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
.direction-badge {
  display: inline-block;
  background-color: #007bff;
  color: white;
  border-radius: 3px;
  padding: 0 3px;
  margin-right: 3px;
  font-size: 12px;
  line-height: 1.5;
}

.direction-tag {
  display: inline-block;
  background-color: #e7f3fe;
  color: #004085;
  border-radius: 4px;
  padding: 2px 6px;
  font-size: 14px;
  flex-shrink: 0; /* 防止被壓縮 */
  margin-left: 10px;
}

.route-direction-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  flex-direction: row; /* 確保水平排列 */
}
/* 去程 - 藍色系 */
.bus-plate.direction-go {
  border-left: 8px solid #007bff !important;
}

/* 返程 - 綠色系 */
.bus-plate.direction-back {
  border-left: 8px solid #28a745 !important;
}
.direction-buttons {
  display: flex;
  gap: 10px;
  margin-top: 5px;
}

.direction-btn {
  background-color: #f8f9fa;
  color: #333;
  border: 1px solid #ddd;
  position: relative;
  overflow: hidden;
}

.direction-btn.selected {
  background-color: #e9ecef;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
}
.direction-legend {
  display: flex;
  gap: 10px;
  margin-left: 10px;
  font-size: 12px;
}

.direction-tag.go-tag {
  background-color: #007bff;
  color: white;
}

.direction-tag.back-tag {
  background-color: #28a745;
  color: white;
}
.direction-btn[data-value="0"] {
  border-left: 5px solid #007bff;
}
.direction-btn[data-value="1"] {
  border-left: 5px solid #28a745;
}
.direction-btn.selected[data-value="0"] {
  border-left: 5px solid #007bff;
  background-color: #cfe2ff; /* 淺藍底 */
}

.direction-btn.selected[data-value="1"] {
  border-left: 5px solid #28a745;
  background-color: #d1e7dd; /* 淺綠底 */
}
/* 編輯標籤容器樣式 */
.editing-tabs-container {
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 5px;
  padding: 10px 5px;
  background-color: #f8f9fa;
  border-bottom: 1px solid #ddd;
  margin-top: 15px;
  scrollbar-width: thin;
  -webkit-overflow-scrolling: touch;
}

/* 隱藏水平滾動條但保持功能 */
.editing-tabs-container::-webkit-scrollbar {
  height: 4px;
}

.editing-tabs-container::-webkit-scrollbar-thumb {
  background-color: rgba(0,0,0,0.2);
  border-radius: 4px;
}

/* 編輯標籤樣式 */
.editing-tab {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  background-color: #e9ecef;
  border-radius: 20px;
  font-size: 14px;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s ease;
  max-width: 150px;
  overflow: hidden;
  flex-shrink: 0;
}

.editing-tab.active {
  background-color: #06c755;
  color: white;
}

.editing-tab .tab-company {
  margin-left: 5px;
  opacity: 0.7;
  font-size: 12px;
}

.editing-tab .tab-close {
  margin-left: 8px;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background-color: rgba(0,0,0,0.1);
  font-size: 16px;
  line-height: 1;
  transition: all 0.2s ease;
}

.editing-tab.active .tab-close {
  background-color: rgba(255,255,255,0.2);
}

.editing-tab .tab-close:hover {
  background-color: rgba(255,0,0,0.2);
}
.floating-notification {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background-color: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  z-index: 2000;
  transition: transform 0.3s ease;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  text-align: center;
  max-width: 90%;
}
.floating-notification.show {
  transform: translateX(-50%) translateY(0);
}

.floating-notification.success {
  background-color: rgba(6, 199, 85, 0.9);
}

.floating-notification.error {
  background-color: rgba(220, 53, 69, 0.9);
}
.postpone-button {
  background-color: #6c757d;
  color: white;
}

.postpone-button:hover {
  background-color: #5a6268;
  box-shadow: 0 4px 8px rgba(108, 117, 125, 0.2);
}
/* 分類導航樣式 */
.category-nav {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 5px 0;
  margin-bottom: 8px;
  scrollbar-width: none; /* 隱藏 Firefox 滾動條 */
  -ms-overflow-style: none; /* 隱藏 IE/Edge 滾動條 */
  -webkit-overflow-scrolling: touch; /* 提高滾動流暢度 */
}

.category-nav::-webkit-scrollbar {
  display: none; /* 隱藏 Chrome/Safari 滾動條 */
}

.category-tab {
  padding: 6px 15px;
  background-color: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 20px;
  font-size: 14px;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0; /* 防止標籤被壓縮 */
}

.category-tab.active {
  background-color: #06c755 !important;
  color: white !important;
  border-color: #06c755 !important;
}

/* 滑動容器樣式 */
.swipe-container {
  width: 100%;
  overflow: hidden;
  position: relative;
}

.swipe-wrapper {
  display: flex;
  transition: transform 0.3s ease;
}

.swipe-page {
  min-width: 100%;
  flex-shrink: 0;
}

/* 滑動指示器樣式 */
.swipe-indicators {
  display: flex;
  justify-content: center;
  gap: 6px;
  margin-top: 10px;
}

.swipe-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: #ddd;
  transition: all 0.2s ease;
}

.swipe-dot.active {
  background-color: #06c755;
  transform: scale(1.2);
}

/* 正向和負向項目的樣式 */
.quick-other-item.positive-item {
  border-left: 3px solid #28a745;
}

.quick-other-item.negative-item {
  border-left: 3px solid #dc3545;
}

.quick-other-item.positive-item.selected {
  background-color: #d4edda;
  color: #155724;
  border-color: #28a745;
}
.quick-other-item.positive-item.selected::after {
  background-color: #28a745;
}
.quick-other-item.negative-item.selected {
  background-color: #f8d7da;
  color: #721c24;
  border-color: #dc3545;
}
.quick-other-item.negative-item.selected::after {
  background-color: #dc3545;
}
.category-page {
  min-width: 100%;
  flex-shrink: 0;
  position: relative;
}
/* 增加觸控區域優化 */
.category-tab, 
.quick-other-item, 
.quick-item {
  position: relative;
}
.category-tab::before, 
.quick-other-item::before, 
.quick-item::before {
  content: '';
  position: absolute;
  top: -5px;
  left: -5px;
  right: -5px;
  bottom: -5px;
  z-index: -1;
}
/* 確保內容包裹容器正確布局 */
.category-page > div {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 5px 0;
}

    </style>
  </head>
<body style="overscroll-behavior-y: contain;">
    <!-- 在 body 開始位置添加返回LINE按鈕 -->
    <div id="loading-overlay" class="loading-overlay hidden">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h2>車輛查核</h2>

      <div id="statusMessage" class="status-message"></div>

      <!-- 即時偵測懸浮顯示 -->
      <div
        id="realTimeDetection"
        class="real-time-detection"
        onclick="showDetectedBuses()"
      >
        <span id="detectionCount" class="detection-count">0</span>
        <span>個新偵測結果</span>
      </div>

      <!-- 位置選擇 -->
      <div class="form-group">
        <label for="location" class="required">我的位置</label>
        <div class="input-group">
          <input type="text" id="location" placeholder="選擇附近位置" />
          <div class="icon-button" onclick="openLocationModal()">
            <i class="fas fa-map-marker-alt"></i>
          </div>
        </div>
      </div>

<div class="utility-buttons">
  <div class="utility-button" onclick="detectBuses()">
    <i class="fas fa-search"></i>
    <span>偵測車輛</span>
  </div>
  <div id="autoDetectButton" class="utility-button" onclick="toggleAutoDetect()">
    <i class="fas fa-sync"></i>
    <span id="autoDetectStatus">自動偵測</span>
  </div>
  <div class="utility-button" onclick="openManualInputModal()">
    <i class="fas fa-plus"></i>
    <span>手動新增</span>
  </div>

</div>
<div class="countdown-container">
  <span id="countdown"></span>
</div>

      <!-- 隱藏欄位 -->
      <input type="hidden" id="positionLat" />
      <input type="hidden" id="userId" />

      <!-- 檢測到的車輛容器 -->
<div id="detectedBusesContainer" class="detected-buses-container">
  <div class="detection-header">
    <div class="detection-title-area">
      <h3>偵測到的車輛：</h3>
      
      <div class="switch-container">
        <!-- <label class="switch">
          <input type="checkbox" id="includeRecordedToggle" onchange="toggleIncludeRecorded()">
          <span class="slider"></span>
        </label>
        <span>顯示3分鐘內已記錄的車輛</span>
      </div> -->
    </div>
    <span id="busCount" class="status-tag status-processing">0 輛</span>
        <div class="direction-legend">
      <span class="direction-tag go-tag">去</span>
      <span class="direction-tag back-tag">返</span>
    </div>
  </div>
  <div id="detectedBusesList">
    <!-- 檢測到的車輛卡片將在這裡動態顯示 -->
    <div class="no-buses-message">
      <i
        class="fas fa-bus"
        style="font-size: 24px; color: #adb5bd; margin-bottom: 10px"
      ></i>
      <p>尚未檢測到車輛，請點擊「偵測車輛」按鈕</p>
    </div>
  </div>
</div>
 <!-- 修改固定的車輛輸入區域結構，調整路線顯示位置 -->
<div id="busInputContainer" class="bus-input-container hidden">
  <div class="bus-info-header">
    <!-- 將路線移到頂部 -->
    <div id="inputBusRoute" class="route-info"></div>
    <div><span id="inputBusCompany" class="company-label"></span> <strong id="inputBusNumber"></strong></div>
  </div>
  
  <div class="input-section">
    <label>查核結果:</label>
    <div id="mainItemsContainer" class="quick-items">
      <!-- 主要項目將在這裡生成 -->
    </div>
    
    <label>其它:</label>
    <div id="otherItemsContainer" class="quick-other-items">
      <!-- 其他項目將在這裡生成 -->
    </div>
    
    <div class="input-actions">
      <div class="action-button submit-button" onclick="submitSelectedBus()">
        <i class="fas fa-check"></i> 送出記錄
      </div>
        <div class="action-button postpone-button" onclick="postponeEditing()">
    <i class="fas fa-clock"></i> 等下編輯
   </div>
      <div class="action-button cancel-button" onclick="cancelBusInput()">
        <i class="fas fa-times"></i> 取消
      </div>
    </div>
  </div>
</div>
<!-- 修改確認對話框模態窗口 -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>確認</h3>
    <p id="confirmMessage">是否取消對此車輛的編輯？</p>
    <div class="button-group">
      <button type="button" id="confirmYes">確認</button>
      <button type="button" class="secondary-button" id="confirmNo">取消</button>
    </div>
  </div>
</div>
<!-- 手動輸入車輛模態框 -->
<div id="manualInputModal" class="modal">
  <div class="modal-content">
    <h3>手動新增車輛</h3>
       <div id="manualInputError" class="status-message error" style="display: none; margin-bottom: 15px;"></div>
    <div class="form-group">
      <label for="manualPlateNumber" class="required">車號</label>
      <input type="text" id="manualPlateNumber" placeholder="輸入車號" oninput="convertToUpperCase(this)" onblur="formatPlateNumber(this)">
    </div>
    <div class="form-group">
      <label for="manualCompany">公司</label>
      <select id="manualCompany"  class="required">
        <option value="">請選擇公司</option>
        <option value="首都客運">首都</option>
        <option value="臺北客運">臺北</option>
        <option value="大都會客運">大都會</option>
        <option value="三重客運">三重</option>
        <option value="台中客運">台中</option>
      </select>
    </div>
    <div class="form-group">
      <label for="manualRoute">路線</label>
      <input type="text" id="manualRoute" placeholder="輸入路線">
    </div>
    <div class="form-group">
  <label for="manualDirection">方向</label>
  <div class="direction-buttons">
    <button type="button" class="direction-btn" data-value="0">去程</button>
    <button type="button" class="direction-btn" data-value="1">返程</button>
  </div>
  <input type="hidden" id="manualDirection" value="0">
</div>
    <div class="button-group">
      <button type="button" onclick="addManualBus()">確認新增</button>
      <button type="button" class="secondary-button" onclick="closeManualInputModal()">取消</button>
    </div>
  </div>
</div>
      <div class="line-brand">首都集團查核平台-v1.1.0.8(瀏覽器模式)
        <div style="font-size: 12px; margin-top: 5px;">
    GPS精準度已強化，請確保開啟位置服務
  </div>
      </div>
    </div>

    <!-- 位置選擇彈窗 -->
    <div id="locationModal" class="modal">
      <div class="modal-content">
        <h3>我的位置</h3>
        <!-- 添加重新偵測按鈕 -->
        <div id="detectLocationButtonContainer" class="detect-button-container">
          <button
            id="detectLocationButton"
            type="button"
            class="secondary-button detect-button"
            onclick="refreshLocationList()"
          >
            <i class="fas fa-sync-alt"></i> 偵測位置
          </button>
            <!-- 新增隨車稽查按鈕 -->
      <button
        id="onBoardInspectionButton"
        type="button"
        class="secondary-button detect-button"
        onclick="selectOnBoardInspection()"
      >
        <i class="fas fa-bus"></i> 隨車稽查
      </button>
        </div>
        <div id="locationList"></div>
        <div class="button-group">
          <button type="button" onclick="closeLocationModal()">關閉</button>
        </div>
      </div>
    </div>


    <!-- 歷史紀錄彈窗 -->
    <div id="historyModal" class="modal">
      <div class="modal-content">
        <h3>今日紀錄</h3>
        <div id="historyList" class="history-list">
          <!-- 歷史紀錄將在這裡動態顯示 -->
        </div>
        <div class="button-group">
          <button type="button" onclick="closeHistoryModal()">關閉</button>
        </div>
      </div>
    </div>
<!-- 添加偵測指示器元素到頁面底部 -->
<div id="detectionIndicator" class="detection-indicator">
  <div class="spinner"></div>
  <span id="detectionMessage">正在偵測車輛...</span>
</div>

  <script>
// 全局變數
const base_url = "https://35.221.146.143.nip.io/linehook/";
const channelId = "2006992891";
let currentLatitude = 0;
let currentLongitude = 0;
let intersections = [];
let allDetectedBuses = []; // 所有偵測到的車輛
let displayedBuses = []; // 目前顯示的車輛
let submittedBuses = []; // 已提交的車輛
let otherItems = [];
let globalLoadingTimeout = null;
let watchId = null;
let isProcessingBus = false;
let startY = 0;
let lastLoadingTime = 0;
// 1. 首先添加新的全局變數來跟踪編輯中的車輛
let editingBuses = []; // 儲存所有正在編輯中的車輛
let activeEditingBusIndex = -1; // 當前活躍的編輯車輛索引
const MIN_LOADING_INTERVAL = 30000; // 最短loading間隔，毫秒
// 全局變數，保存上次點擊返回的時間
let lastBackPressTime = 0;
// 添加全局變數
let autoDetectInterval = null;
let countdownInterval = null;
// 添加全局變數
let selectedBus = null; // 保存選中車輛的完整副本
let countdownSeconds = 20; // 預設20秒
// 全局變數 - 是否包含已記錄車輛
let includeRecordedVehicles = false;
//滑動全局變數
let currentSwipePage = 0;
let pagesContainer = null;
let categoryNav = null;
let totalPages = 0;
// 公司列表數據
const companies = [
  { id: "1", name: "首都客運" },
  { id: "2", name: "臺北客運" },
  { id: "3", name: "大都會客運" },
  { id: "4", name: "三重客運" },
  { id: "5", name: "台中客運" },
];

// 主要項目預設值
const mainItems = ["左轉未停", "右轉未停", "未指差", "未停未指差", "無缺失"];

// 添加防抖函數 - 放在全局變數聲明後面
function debounce(func, wait) {
  let timeout;
  return function() {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, arguments), wait);
  };
}
// 創建防抖版本的跑馬燈初始化函數
const debouncedInitMarquees = debounce(initializeMarquees, 100);

document.addEventListener('touchstart', function(e) {
  startY = e.touches[0].clientY;
}, { passive: true }); // 使用passive: true以不影響滾動性能

// 只在特定條件下阻止下拉刷新
document.addEventListener('touchmove', function(e) {
  // 只有當頁面處於頂部 AND 用戶向下拖動 AND 拖動幅度超過5像素時才阻止默認行為
  const touchY = e.touches[0].clientY;
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  if (scrollTop <= 0 && touchY > startY + 5) {
    // 只有這種情況下才阻止默認行為
    e.preventDefault();
  }
}, { passive: false }); // 需要passive: false來允許preventDefault

// 監聽返回按鈕事件
function setupBackButtonHandler() {
  // 檢查是否在Android環境中
  const isAndroid = /android/i.test(navigator.userAgent);
  
  if (isAndroid) {
    console.log("檢測到Android環境，設置返回按鈕處理");
    
    // 添加返回按鈕事件監聽
    window.addEventListener('popstate', function(event) {
      // 阻止默認的返回行為
      event.preventDefault();
      handleBackButton();
      
      // 保持在當前頁面
      history.pushState(null, document.title, window.location.href);
      return false;
    });
    
    // 添加一個history條目，確保有東西可以"返回"
    history.pushState(null, document.title, window.location.href);
  }
}
// 處理返回按鈕邏輯
function handleBackButton() {
  const currentTime = Date.now();
  
  // 如果有打開的模態框，先關閉模態框
  if (document.getElementById("locationModal").style.display === "block") {
    closeLocationModal();
    return;
  }
  
  if (document.getElementById("manualInputModal").style.display === "block") {
    closeManualInputModal();
    return;
  }
  
  if (document.getElementById("historyModal").style.display === "block") {
    closeHistoryModal();
    return;
  }
  
  // 如果正在編輯車輛，取消編輯
  if (isProcessingBus) {
    cancelBusInput();
    return;
  }
  
  // 雙擊返回才退出程序(2秒內)
  if (currentTime - lastBackPressTime < 2000) {
    showStatusMessage("再次點擊返回將退出應用", "info", true);
  } else {
    showStatusMessage("再按一次返回鍵退出應用", "info", true);
    lastBackPressTime = currentTime;
  }
}

// 初始化偵測指示器和按鈕事件
function setupDetectionFeedback() {
  // 添加偵測指示器到DOM
  if (!document.getElementById('detectionIndicator')) {
    const indicatorHTML = `
      <div id="detectionIndicator" class="detection-indicator">
        <div class="spinner"></div>
        <span id="detectionMessage">正在偵測車輛...</span>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', indicatorHTML);
  }
  
  // 綁定偵測按鈕點擊事件，添加立即反饋
  const detectButton = document.querySelector('.utility-button:nth-child(1)');
  if (detectButton) {
    detectButton.addEventListener('click', function() {
      // 按鈕點擊時立即添加視覺效果，不等待函數內部
      this.classList.add('detecting');
    });
  }
}
// 在頁面初始化時設置返回按鈕處理
document.addEventListener('DOMContentLoaded', function() {
  setupBackButtonHandler();
  setupDetectionFeedback();
     setTimeout(() => {
      debouncedInitMarquees();
    }, 500);
});

const safeStorage = {
  set: function(key, value) {
    try {
      if (typeof value === 'object') {
        value = JSON.stringify(value);
      }
      localStorage.setItem(key, value);
      return true;
    } catch (error) {
      console.error("保存到localStorage失敗:", error);
      return false;
    }
  },
  
  get: function(key, defaultValue = null) {
    try {
      const value = localStorage.getItem(key);
      if (value === null) return defaultValue;
      
      // 嘗試解析JSON
      try {
        return JSON.parse(value);
      } catch (e) {
        // 如果不是JSON，直接返回值
        return value;
      }
    } catch (error) {
      console.error("從localStorage讀取失敗:", error);
      return defaultValue;
    }
  },
  
  remove: function(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error("從localStorage刪除失敗:", error);
      return false;
    }
  },
  
  // 檢查存儲是否可用
  isAvailable: function() {
    try {
      const testKey = "__test__";
      localStorage.setItem(testKey, testKey);
      localStorage.removeItem(testKey);
      return true;
    } catch (e) {
      return false;
    }
  }
};

// 切換是否包含已記錄車輛的開關
function toggleIncludeRecorded() {
  includeRecordedVehicles = document.getElementById('includeRecordedToggle').checked;
  console.log("包含已記錄車輛設置更改為:", includeRecordedVehicles);
  
  // 立即重新篩選顯示的車輛
  refreshDisplayedBuses();
}
// 根據當前設置重新篩選要顯示的車輛
function refreshDisplayedBuses() {
  if (includeRecordedVehicles) {
    // 包含所有車輛 - 合併所有偵測到的車輛
    displayedBuses = [...allDetectedBuses];
  } else {
    // 只顯示未提交過的車輛
    const threeMinutes = 3 * 60 * 1000; // 3分鐘轉換為毫秒
    const currentTime = Date.now();
    
    displayedBuses = allDetectedBuses.filter(bus => {
      // 如果車牌在已提交列表中且提交時間小於3分鐘，則不顯示
      if (submittedBuses.includes(bus.plateNumber)) {
        const submissionTime = localStorage.getItem(`submitted_${bus.plateNumber}`);
        if (submissionTime && (currentTime - parseInt(submissionTime)) < threeMinutes) {
          return false; // 排除近期已提交的車輛
        }
      }
      return true; // 保留其他車輛
    });
  }
    // 更新UI
  updateDetectedBusesList();
}
// 在模態框內顯示錯誤訊息
function showManualInputError(message) {
  const errorElement = document.getElementById("manualInputError");
  errorElement.textContent = message;
  errorElement.style.display = "block";
  
  // 3秒後自動隱藏錯誤訊息
  setTimeout(() => {
    errorElement.style.display = "none";
  }, 3000);
}
// 轉換為大寫函數
function convertToUpperCase(input) {
  input.value = input.value.toUpperCase();
    // 添加車號格式化邏輯
  formatPlateNumber(input);
}

// 格式化車號，處理各種情況
function formatPlateNumber(input) {
  let value = input.value.replace(/-/g, ''); // 先移除所有 "-"
  
  // 如果車牌包含數字和英文，但格式複雜(如123U3)
  // 我們找到第一個字母和數字交界的地方
  let result = value;
  let hasFormatted = false;
  
  // 尋找從數字到字母的轉換
  for (let i = 0; i < value.length - 1; i++) {
    let current = value[i];
    let next = value[i + 1];
    
    // 如果當前字符是數字，下一個是字母
    if (!isNaN(parseInt(current)) && isNaN(parseInt(next)) && /[A-Z]/.test(next)) {
      result = value.substring(0, i + 1) + '-' + value.substring(i + 1);
      hasFormatted = true;
      break;
    }
    
    // 如果當前字符是字母，下一個是數字
    if (isNaN(parseInt(current)) && /[A-Z]/.test(current) && !isNaN(parseInt(next))) {
      result = value.substring(0, i + 1) + '-' + value.substring(i + 1);
      hasFormatted = true;
      break;
    }
  }
  
  input.value = result;
}


// 在頁面載入時初始化
window.onload = initializePage;
// 清空顯示車輛列表的函數
function clearDisplayedBuses() {
  // 如果列表已為空，顯示提示
  if (displayedBuses.length === 0) {
    showStatusMessage("當前列表已為空", "info");
    return;
  }
  
  // 直接清空列表
  displayedBuses = [];
  updateDetectedBusesList();
  showStatusMessage("已清空車輛列表", "info");

}
// 6. 修改cancelBusInput函數
function cancelBusInput() {
  if (activeEditingBusIndex >= 0) {
    confirmCancelEditing(activeEditingBusIndex);
  }
}
// 切換自動偵測功能
function toggleAutoDetect() {
  const statusElem = document.getElementById("autoDetectStatus");
   const autoDetectButton = document.getElementById("autoDetectButton");
  if (autoDetectInterval) {
    stopAutoDetect();
    statusElem.textContent = "自動偵測";
    autoDetectButton.classList.remove("auto-detect-active");
  } else {
    startAutoDetect();
    statusElem.textContent = "停止自動";
    autoDetectButton.classList.add("auto-detect-active");
  }
}
// 打開手動輸入模態框時暫停自動偵測
function openManualInputModal() {
  // 記錄當前自動偵測狀態
   const wasAutoDetecting = !!autoDetectInterval;
  
//   // 如果正在自動偵測，暫時停止
   if (wasAutoDetecting) {
     stopAutoDetect();
//     // 在window上保存狀態，以便後續恢復
     window.tempAutoDetectState = true;
 }
  
  document.getElementById("manualInputModal").style.display = "block";
   // 重置表單欄位到預設值
  document.getElementById("manualPlateNumber").value = "";
  document.getElementById("manualCompany").value = ""; // 預設選擇首都
  document.getElementById("manualRoute").value = "";
    // 初始化方向按鈕
  initDirectionButtons();
    // 隱藏任何之前的錯誤訊息
  document.getElementById("manualInputError").style.display = "none";
}

// 關閉手動輸入模態框時恢復自動偵測
function closeManualInputModal() {
  document.getElementById("manualInputModal").style.display = "none";
  
//   // 如果之前是自動偵測狀態，恢復自動偵測
  if (window.tempAutoDetectState) {
    startAutoDetect();
    window.tempAutoDetectState = false;
  }
}
window.addEventListener('scroll', function() {
  clearTimeout(window.scrollTimer);
  window.scrollTimer = setTimeout(debouncedInitMarquees, 200);
});
// 加強健康檢查函數，確保計時器正常運行
// 改進的自動偵測健康檢查函數，更清晰的命名和錯誤處理
function setupAutoDetectHealthCheck() {
  const HEALTH_CHECK_INTERVAL_MS = 10000; // 10秒
  
  // 設置健康檢查定時器
  const healthCheckInterval = setInterval(() => {
    try {
      const statusElem = document.getElementById("autoDetectStatus");
      
      // 檢查是否應該在自動偵測狀態但計時器已經停止
      if (statusElem && statusElem.textContent === "停止自動" && !autoDetectInterval) {
        console.log("檢測到自動偵測異常停止，正在重新啟動...");
        // 重新啟動自動偵測
        startAutoDetect();
      }
      
      // 檢查倒數計時是否正常運行
      if (statusElem && statusElem.textContent === "停止自動" && !countdownInterval) {
        console.log("檢測到倒數計時異常停止，正在重新啟動...");
        // 重新啟動倒數計時
        startCountdown();
      }
    } catch (error) {
      console.error("自動偵測健康檢查錯誤:", error);
      // 即使出錯也不中斷健康檢查
    }
  }, HEALTH_CHECK_INTERVAL_MS);
  
  // 頁面卸載時清理健康檢查
  window.addEventListener("beforeunload", function() {
    if (healthCheckInterval) {
      clearInterval(healthCheckInterval);
    }
  });
}
// 添加完整的頁面初始化函數，包含錯誤處理和回調
// 修改頁面初始化函數，使用URL參數而非LIFF登錄
async function initializePage() {
  if (navigator.permissions) {
  navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
    if (result.state === 'granted') {
      console.log('已有位置權限');
      startHighAccuracyLocationWatching();
    } else if (result.state === 'prompt') {
      console.log('需要顯式請求位置權限');
      // 顯式請求位置以觸發權限請求
      navigator.geolocation.getCurrentPosition(
        () => { console.log('已獲得位置權限'); startHighAccuracyLocationWatching(); },
        (error) => { console.error('位置權限請求失敗:', error); },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    } else if (result.state === 'denied') {
      showStatusMessage('請在瀏覽器設置中開啟位置權限以獲取準確位置', 'error');
    }
  });
} else {
  // 瀏覽器不支持permissions API，直接請求位置
  startHighAccuracyLocationWatching();
}
  try {
    showLoading();
    console.log("初始化頁面...");
    
    // 檢查localStorage是否可用
    if (!safeStorage.isAvailable()) {
      showStatusMessage("本地存儲不可用，部分功能可能受限", "warning", true);
    }
    
    // 清理過期提交記錄
    cleanupExpiredSubmissions();
    
    // 從URL獲取userId
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    
    if (userId) {
      document.getElementById("userId").value = userId;
      console.log("從URL獲取到userId:", userId);
      
      // 檢查用戶是否存在
      await checkUserExists(userId, channelId);
      
      // 獲取最後一次位置記錄
      const lastLocation = await fetchLastLocation(userId);
      if (lastLocation) {
        document.getElementById("location").value = lastLocation;
        console.log("已填入今日最後記錄位置:", lastLocation);
      }
      
      // 獲取其他項目列表
      await fetchOtherItems();
      
      // 立即啟動高精度位置監控
      startHighAccuracyLocationWatching();
      
      // 設置自動偵測健康檢查
      setupAutoDetectHealthCheck();
      
      // 添加網絡狀態監聽器
      setupNetworkListeners();
      
      console.log("頁面初始化完成");
    } else {
      console.error("URL中缺少userId參數");
      showStatusMessage("缺少必要的用戶信息，請從LINE中開啟應用", "error");
    }
    
    hideLoading();
  } catch (error) {
    console.error("頁面載入時發生錯誤:", error);
    showStatusMessage("載入頁面時發生錯誤，請重新整理", "error");
    hideLoading();
  }
  document.addEventListener('click', function() {
  requestWakeLock();
}, { once: true });

  // 添加在函數最後
  setupBackButtonHandler();
}


// 請求Wake Lock避免手機休眠
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {addEventListener
      window.wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock已啟用');
      
      // 頁面可見性變化時重新請求
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
      // 頁面變為可見時，重新初始化所有跑馬燈
      setTimeout(() => {
        debouncedInitMarquees();
      }, 100);
    }
  });
    }
  } catch (err) {
    console.error('Wake Lock請求失敗:', err);
  }
}
// 高精度位置監視函數
function startHighAccuracyLocationWatching(silent = false) {
  // 先停止現有的監視
  stopLocationWatching();
  
  if (!navigator.geolocation) {
    console.log("瀏覽器不支持地理位置API");
    if (!silent) {
      showStatusMessage("您的設備不支持位置功能", "error");
    }
    return;
  }
  
  // 添加位置精度指示器
  if (!document.querySelector('.location-accuracy-container')) {
    addLocationAccuracyIndicator();
  }
  
  const geoOptions = {
    enableHighAccuracy: true, // 使用高精度模式
    timeout: 15000,           // 較長的超時時間
    maximumAge: 0             // 不使用緩存的位置
  };
  
  
  window.watchId = navigator.geolocation.watchPosition(
    (position) => {
      console.log("位置已更新（高精度）");
      currentLatitude = position.coords.latitude;
      currentLongitude = position.coords.longitude;
      
      // 記錄位置精度
      const accuracy = position.coords.accuracy;
      console.log("位置精度:", accuracy, "公尺");
      
      // 更新位置精度指示器
      updateLocationAccuracyIndicator(accuracy);
      
      // 保存位置
      savePosition(currentLatitude, currentLongitude);
    },
    (error) => {
      console.log("位置監聽錯誤:", error);
      if (!silent) {
        showStatusMessage("暫時無法獲取位置，請至室外或開啟位置權限", "info");
      }
      
      // 錯誤時也更新位置精度指示器
      updateLocationAccuracyIndicator(999);
    },
    geoOptions
  );
  
  console.log("已啟動高精度位置監視，watchId:", window.watchId);
}

// 添加位置精度指示器
function addLocationAccuracyIndicator() {
  const locationContainer = document.querySelector(".form-group");
  
  const accuracyContainer = document.createElement("div");
  accuracyContainer.className = "location-accuracy-container";
  accuracyContainer.style.fontSize = "12px";
  accuracyContainer.style.marginTop = "5px";
  accuracyContainer.style.color = "#666";
  
  const accuracyIndicator = document.createElement("div");
  accuracyIndicator.className = "location-accuracy";
  accuracyIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在獲取位置...';
  
  accuracyContainer.appendChild(accuracyIndicator);
  locationContainer.appendChild(accuracyContainer);
}

// 更新位置精度指示器
function updateLocationAccuracyIndicator(accuracy) {
  const accuracyElement = document.querySelector(".location-accuracy");
  if (!accuracyElement) return;
  
  if (accuracy === 999) {
    accuracyElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:red;"></i> 無法獲取精確位置`;
    return;
  }
  
  if (accuracy < 10) {
    accuracyElement.innerHTML = `<i class="fas fa-crosshairs" style="color:green;"></i> 位置精確度高 (${Math.round(accuracy)}m)`;
  } else if (accuracy < 50) {
    accuracyElement.innerHTML = `<i class="fas fa-crosshairs" style="color:orange;"></i> 位置精確度中 (${Math.round(accuracy)}m)`;
  } else {
    accuracyElement.innerHTML = `<i class="fas fa-crosshairs" style="color:red;"></i> 位置精確度低 (${Math.round(accuracy)}m)`;
  }
}

// 頁面載入時刷新車輛列表
window.addEventListener('load', function() {
  setTimeout(() => {
    // 獲取位置後自動執行一次車輛偵測
    getCurrentPosition(true).then(success => {
      if (success) {
        detectBuses();
      }
    });
  }, 2000); // 等待2秒讓頁面完全載入
});
// 網絡監聽器設置
function setupNetworkListeners() {
  // 網絡恢復連接
  window.addEventListener('online', function() {
    console.log("網絡連接恢復");
    showStatusMessage("網絡連接已恢復", "info", true);
    
    // 如果頁面可見，更新位置
    if (document.visibilityState === 'visible') {
      getCurrentPosition(true);
    }
  });
  
  // 網絡斷開連接
  window.addEventListener('offline', function() {
    console.log("網絡連接已斷開");
    showStatusMessage("網絡連接已斷開，部分功能可能不可用", "warning");
  });
}
// 添加手動輸入的車輛
function addManualBus() {
  const plateNumber = document.getElementById("manualPlateNumber").value.trim();
  const company = document.getElementById("manualCompany").value;
  const route = document.getElementById("manualRoute").value.trim();
  const direction = document.getElementById("manualDirection").value;
  // 車號驗證
  if (!plateNumber) {
    showManualInputError("請輸入車號");
    return;
  }
  
  // 公司驗證
  if (!company) {
    showManualInputError("請選擇公司");
    return;
  }
  
  // 檢查是否已提交過
  if (isRecentlySubmitted(plateNumber)) {
    showStatusMessage("此車輛近期已提交記錄，請稍後再試", "error");
    return;
  }
  
  // 創建新車輛對象
  const newBus = {
    plateNumber: plateNumber,
    operatorName: company,
    routeName: { chinese: route },
    direction: direction, 
    position: {
      latitude: currentLatitude,
      longitude: currentLongitude
    },
    isManualInput: true, // 標記為手動輸入
    uniqueId: 'bus_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) // 添加唯一ID
  };
  
  // 添加到顯示列表
  displayedBuses.push(newBus);
  allDetectedBuses.push(newBus);
  
  // 更新UI
  updateDetectedBusesList();
  
  // 關閉模態框
  closeManualInputModal();
  
  // 選擇新添加的車輛進行輸入
  selectBusForInput(newBus, displayedBuses.length - 1);
}

// 檢查是否近期提交過（3分鐘內）
function isRecentlySubmitted(plateNumber) {
  const submissionTime = localStorage.getItem(`submitted_${plateNumber}`);
  if (!submissionTime) return false;
  
  const threeMinutes = 3 * 60 * 1000;
  return (Date.now() - parseInt(submissionTime)) < threeMinutes;
}

// 2. 修改 selectBusForInput 函數，使其不再鎖定整個列表，而是添加到編輯列表
function selectBusForInput(bus, index, scrollToView = false) {
  // 為車輛添加唯一標識符，如果不存在
  if (!bus.uniqueId) {
    bus.uniqueId = 'bus_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  // 查找是否已在編輯列表中 - 使用唯一ID或多條件匹配
  let existingIndex = -1;
  
  // 先嘗試用唯一ID匹配
  if (bus.uniqueId) {
    existingIndex = editingBuses.findIndex(item => item.uniqueId === bus.uniqueId);
  }
  
  // 如果沒找到，嘗試用車牌號+其他條件匹配
  if (existingIndex === -1 && bus.plateNumber) {
    existingIndex = editingBuses.findIndex(item => {
      // 匹配車牌號以及至少一個其他條件
      return item.plateNumber === bus.plateNumber && 
             ((item.isManualInput === bus.isManualInput) || 
              (item.operatorName === bus.operatorName));
    });
  }
  
  let busToEdit;
  if (existingIndex !== -1) {
    // 如果已存在，切換到該編輯視圖，不創建新的
    activeEditingBusIndex = existingIndex;
    busToEdit = editingBuses[existingIndex]; 
      // 添加日誌
  console.log("使用已存在的編輯車輛:", busToEdit.uniqueId);
    // 只更新位置信息
    if (bus.position) {
      busToEdit.position = bus.position;
    }
  } else {
    // 不存在，添加到編輯列表
    busToEdit = JSON.parse(JSON.stringify(bus)); // 深拷貝，確保原始數據不被修改
    busToEdit.selectedOtherItems = busToEdit.selectedOtherItems || [];

      // 添加日誌
  console.log("創建新的編輯車輛:", busToEdit.uniqueId);
    // 確保唯一ID被保留
    if (!busToEdit.uniqueId) {
      busToEdit.uniqueId = 'bus_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    editingBuses.push(busToEdit);
    activeEditingBusIndex = editingBuses.length - 1;
  }
  // 添加調試日誌
console.log("當前編輯中的車輛數量:", editingBuses.length);
console.log("活躍編輯車輛索引:", activeEditingBusIndex);
  // 重置處理狀態，確保可以選擇新車輛
  isProcessingBus = true;
  
  // 更新車輛編輯介面
  updateBusEditingInterface();
  
  // 顯示編輯區域
  document.getElementById("busInputContainer").classList.remove("hidden");
  
  // 更新列表中的選中狀態
  updateBusSelectionInList();
  
  // 滾動標籤容器到選中的標籤
  scrollToActiveTab();
  
  // 如果是雙擊或明確要求滾動，則滾動到編輯區域
  if (scrollToView) {
    scrollToEditingArea();
  }
}
// 添加新函數，用於滾動到活動標籤
function scrollToActiveTab() {
  setTimeout(() => {
    // 給DOM更新一點時間
    const tabsContainer = document.querySelector(".editing-tabs-container");
    if (!tabsContainer) return;
    
    const activeTab = tabsContainer.querySelector(".editing-tab.active");
    if (!activeTab) return;
    
    // 計算滾動位置：標籤的左側位置減去容器的左側位置，再減去一些padding使其居中
    const scrollLeft = activeTab.offsetLeft - tabsContainer.offsetLeft - (tabsContainer.clientWidth / 2) + (activeTab.offsetWidth / 2);
    
    // 平滑滾動到標籤位置
    tabsContainer.scrollTo({
      left: Math.max(0, scrollLeft),
      behavior: 'smooth'
    });
  }, 50); // 短暫延遲，確保DOM已更新
}

window.isHandlingItemClick = false;
// 3. 新增函數來更新編輯介面，包括車輛編輯區域和標籤列
function updateBusEditingInterface() {
  if (activeEditingBusIndex < 0 || editingBuses.length === 0) {
    // 沒有活躍的編輯車輛，隱藏編輯區域
    document.getElementById("busInputContainer").classList.add("hidden");
    return;
  }
  
  // 獲取當前活躍的編輯車輛
  const bus = editingBuses[activeEditingBusIndex];
  
  // 更新編輯標籤列
  updateEditingTabs();
  
  // 更新編輯區域內容
  const inputContainer = document.getElementById("busInputContainer");
  
  // 更新車輛信息
  const routeInfo = bus.routeName?.chinese || "不明";
  const directionInfo = bus.direction === "0" ? "去" : bus.direction === "1" ? "返" : "";
  
  // 更新路線顯示
  const routeElement = document.getElementById("inputBusRoute");
  routeElement.innerHTML = `
  <div class="route-direction-container">
    <div class="text-marquee">${routeInfo}</div>
    <div class="direction-tag" style="background-color: ${bus.direction === "0" ? "#007bff" : bus.direction === "1" ? "#28a745" : "#666"}; color: white;">
      ${directionInfo}
    </div>
  </div>`;
  
  // 檢查路線長度，如果過長則啟用跑馬燈效果
  setTimeout(() => {
    const textElement = routeElement.querySelector('.text-marquee');
    if (textElement) {
      const parentWidth = textElement.parentElement.offsetWidth;
      const textWidth = textElement.scrollWidth;
      
      if (textWidth > parentWidth) {
        textElement.classList.add('scrolling');
      } else {
        textElement.classList.remove('scrolling');
      }
    }
  }, 20);

  // 更新公司和車號信息
  document.getElementById("inputBusCompany").textContent = bus.operatorName || "未知公司";
  
  // 修改這裡：將車號純文字改為輸入框
  const inputBusNumberElement = document.getElementById("inputBusNumber");
  // 檢查是否已經是輸入框，如果不是則替換為輸入框
  if (bus.isManualInput) {
    // 如果是手動新增的車輛，且不是輸入框，替換為輸入框
    if (inputBusNumberElement.tagName !== 'INPUT') {
      const inputBox = document.createElement('input');
      inputBox.type = 'text';
      inputBox.id = 'inputBusNumber';
      inputBox.value = bus.plateNumber || '';
      inputBox.style.width = '100px';
      inputBox.style.padding = '3px 6px';
      inputBox.style.border = '1px solid #ddd';
      inputBox.style.borderRadius = '4px';
      inputBox.style.fontWeight = 'bold';
      
      // 添加事件監聽器，確保車號修改後更新到車輛對象
      inputBox.addEventListener('input', function() {
        // 將更改保存到當前編輯的車輛對象
        bus.plateNumber = this.value;
        
        // 同步更新所有相關顯示
        updateAllBusReferences(bus);
      });
      
      // 替換原有元素
      inputBusNumberElement.parentNode.replaceChild(inputBox, inputBusNumberElement);
    } else {
      // 如果已經是輸入框，只更新值
      inputBusNumberElement.value = bus.plateNumber || '';
    }
  } else {
    // 如果不是手動新增的車輛，顯示為純文字
    if (inputBusNumberElement.tagName === 'INPUT') {
      const textSpan = document.createElement('strong');
      textSpan.id = 'inputBusNumber';
      textSpan.textContent = bus.plateNumber || '';
      inputBusNumberElement.parentNode.replaceChild(textSpan, inputBusNumberElement);
    } else {
      // 如果已經是文字元素，只更新內容
      inputBusNumberElement.textContent = bus.plateNumber || '';
    }
  }
  
  // 清除並重新生成主要項目選項
  const mainItemsContainer = document.getElementById("mainItemsContainer");
  mainItemsContainer.innerHTML = '';
  mainItems.forEach(item => {
    const itemButton = document.createElement("div");
    itemButton.className = "quick-item";
    itemButton.textContent = item;
    itemButton.dataset.value = item;
    
    // 如果已經選過此項目，標記為已選
    if (bus.selectedMainItem === item) {
      itemButton.classList.add("selected");
    }
    
    itemButton.onclick = function() {
      mainItemsContainer.querySelectorAll(".quick-item").forEach(el => {
        el.classList.remove("selected");
      });
      this.classList.add("selected");
      
      // 儲存選擇到當前編輯的車輛對象
      bus.selectedMainItem = this.dataset.value;
    };
    mainItemsContainer.appendChild(itemButton);
  });

  // 清除並重新生成其他項目選項
  const otherItemsContainer = document.getElementById("otherItemsContainer");
  otherItemsContainer.innerHTML = '';

  // 確保 otherItems 存在且有數據
  if (!otherItems || otherItems.length === 0) {
    const noItemsMsg = document.createElement("div");
    noItemsMsg.textContent = "無可用選項";
    noItemsMsg.style.padding = "10px";
    noItemsMsg.style.color = "#666";
    otherItemsContainer.appendChild(noItemsMsg);
    return;
  }

  // 獲取所有不重複的類別，過濾掉null和undefined值
  let categories = [];
  try {
    categories = [...new Set(
      otherItems
        .filter(item => item && item.catolog) // 確保 item 和 item.catolog 存在
        .map(item => item.catolog)
    )];
    console.log("分類清單:", categories);
  } catch (e) {
    console.error("解析分類時出錯:", e);
    categories = ["未分類"]; // 默認分類
  }

  // 如果沒有分類，將所有項目放在一個默認分類下
  if (categories.length === 0) {
    categories = ["未分類"];
  }

  console.log(`找到 ${categories.length} 個分類，共 ${otherItems.length} 個項目`);

  // 創建分類導航標籤
  const categoryNav = document.createElement("div");
  categoryNav.className = "category-nav";
  categoryNav.style.cssText = "display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; margin-bottom: 8px;";

  // 創建分類標籤
  categories.forEach((category, idx) => {
    const tab = document.createElement("div");
    tab.className = "category-tab" + (idx === 0 ? " active" : "");
    tab.style.cssText = "padding: 5px 12px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; white-space: nowrap; cursor: pointer;";
    tab.textContent = category || "未分類";
    tab.dataset.index = idx;
    categoryNav.appendChild(tab);
  });

  // 創建內容容器
  const contentContainer = document.createElement("div");
  contentContainer.style.cssText = "position: relative; width: 100%; overflow: hidden;";

  // 創建滑動面板
  const pagesContainer = document.createElement("div");
  pagesContainer.className = "category-pages";
  pagesContainer.style.cssText = "display: flex; width: 100%; transition: transform 0.3s ease;";

  // 為每個分類創建一個面板
  categories.forEach((category, idx) => {
    // 創建分類面板
    const pageDiv = document.createElement("div");
    pageDiv.className = "category-page";
    pageDiv.style.cssText = "flex: 0 0 100%; width: 100%; min-height: 120px; padding: 5px; box-sizing: border-box;";
    
    // 創建內容包裹容器
    const contentWrapper = document.createElement("div");
    contentWrapper.style.cssText = "display: flex; flex-wrap: wrap; gap: 8px; max-height: 180px; overflow-y: auto; padding: 5px 0;";
    contentWrapper.style.position = "relative";
contentWrapper.style.zIndex = "5"; // 確保在滑動層上方
    // 篩選該分類的項目
    const categoryItems = category === "未分類" 
      ? otherItems.filter(item => !item.catolog)
      : otherItems.filter(item => item.catolog === category);
    
    // 創建項目按鈕
    categoryItems.forEach(item => {
      if (!item || !item.itemName) return; // 跳過無效項目
      
      const itemBtn = document.createElement("div");
      itemBtn.className = "quick-other-item";
      itemBtn.style.cssText = "background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 6px 12px; font-size: 14px; cursor: pointer; margin: 0; flex: 0 0 auto; max-width: calc(50% - 8px); white-space: normal;";
      
      // 根據項目類型添加樣式
      if (item.itemType === 1) {
        itemBtn.classList.add("positive-item");
      } else if (item.itemType === -1) {
        itemBtn.classList.add("negative-item");
      }
      
      itemBtn.textContent = item.itemName;
      itemBtn.dataset.value = item.itemName;
      itemBtn.dataset.type = item.itemType;
      
      // 如果此項目已選，標記為已選
      if (bus.selectedOtherItems && bus.selectedOtherItems.includes(item.itemName)) {
        itemBtn.classList.add("selected");
      }
      
      // 添加點擊事件
itemBtn.onclick = function() {
  console.log(`點擊項目 "${this.textContent}" 前的選中狀態:`, this.classList.contains("selected"));
  console.log(`點擊前的 selectedOtherItems:`, JSON.stringify(bus.selectedOtherItems));
  
  // 切換視覺效果
  this.classList.toggle("selected");
  const isNowSelected = this.classList.contains("selected");
  console.log(`點擊後的選中狀態:`, isNowSelected);
  
  // 確保數組已初始化
  if (!bus.selectedOtherItems) {
    console.log("初始化 selectedOtherItems 陣列");
    bus.selectedOtherItems = [];
  }
  
  const itemValue = this.dataset.value;
  console.log(`項目值 (dataset.value):`, itemValue);
  
  // 更新數據陣列
  if (isNowSelected) {
    if (!bus.selectedOtherItems.includes(itemValue)) {
      bus.selectedOtherItems.push(itemValue);
      console.log(`添加項目 "${itemValue}" 到陣列`);
    } else {
      console.log(`項目 "${itemValue}" 已在陣列中，不重複添加`);
    }
  } else {
    const prevLength = bus.selectedOtherItems.length;
    bus.selectedOtherItems = bus.selectedOtherItems.filter(item => item !== itemValue);
    const newLength = bus.selectedOtherItems.length;
    
    if (prevLength !== newLength) {
      console.log(`從陣列中移除項目 "${itemValue}"`);
    } else {
      console.log(`陣列中找不到項目 "${itemValue}" 無法移除`);
    }
  }
  
  console.log(`點擊後的 selectedOtherItems:`, JSON.stringify(bus.selectedOtherItems));
};
      
      contentWrapper.appendChild(itemBtn);
    });
    
    // 如果沒有項目，顯示提示訊息
    if (categoryItems.length === 0) {
      const noItemsMsg = document.createElement("div");
      noItemsMsg.textContent = "此分類無可用選項";
      noItemsMsg.style.padding = "10px";
      noItemsMsg.style.color = "#666";
      contentWrapper.appendChild(noItemsMsg);
    }
    
    pageDiv.appendChild(contentWrapper);
    pagesContainer.appendChild(pageDiv);
  });

  contentContainer.appendChild(pagesContainer);

  // 添加到主容器
  otherItemsContainer.appendChild(categoryNav);
  otherItemsContainer.appendChild(contentContainer);

  // 設置滑動功能
setupSwipeFeature(pagesContainer, categoryNav, categories.length);

// 修改分類標籤點擊事件
categoryNav.querySelectorAll('.category-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    // 更新標籤狀態
    categoryNav.querySelectorAll('.category-tab').forEach(t => {
      t.classList.remove('active');
      t.style.backgroundColor = '#f8f9fa';
      t.style.color = '#333';
    });
    this.classList.add('active');
    this.style.backgroundColor = '#06c755';
    this.style.color = 'white';
    
    // 獲取索引並滑動到對應頁面
    const index = Array.from(categoryNav.children).indexOf(this);
    currentSwipePage = index;
    swipeToPageImproved(index);
  });
});

  // 預設選中第一個標籤
  if (categoryNav.querySelector('.category-tab')) {
    const firstTab = categoryNav.querySelector('.category-tab');
    firstTab.classList.add('active');
    firstTab.style.backgroundColor = '#06c755';
    firstTab.style.color = 'white';
  }
   
  // 確保提交按鈕可用
  resetSubmitButtonState();
}
// 改進的頁面切換函數
function swipeToPageImproved(pageIndex) {
  currentSwipePage = pageIndex;
  pagesContainer.style.transition = 'transform 0.3s ease';
  pagesContainer.style.transform = `translateX(-${pageIndex * 100}%)`;
  
  // 更新分類標籤的選中狀態
  categoryNav.querySelectorAll('.category-tab').forEach((tab, idx) => {
    if (idx === pageIndex) {
      tab.classList.add('active');
      tab.style.backgroundColor = '#06c755';
      tab.style.color = 'white';
    } else {
      tab.classList.remove('active');
      tab.style.backgroundColor = '#f8f9fa';
      tab.style.color = '#333';
    }
  });
  
  // 更新指示點（如果有的話）
  const indicators = document.querySelector('.swipe-indicators');
  if (indicators) {
    indicators.querySelectorAll('.swipe-dot').forEach((dot, idx) => {
      if (idx === pageIndex) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });
  }
}

// 新增一個函數，用於同步更新所有使用該車輛的地方
function updateAllBusReferences(bus) {
  // 更新編輯標籤顯示
  updateEditingTabs();
  
  // 更新列表中的車牌顯示
  updateBusSelectionInList();
  
  // 同步更新 displayedBuses 和 allDetectedBuses 中相同車輛的資料
  const plateNumber = bus.plateNumber;
  const uniqueId = bus.uniqueId;
  
  // 更新 displayedBuses 中的對應車輛
  for (let i = 0; i < displayedBuses.length; i++) {
    // 優先使用唯一ID匹配
    if (uniqueId && displayedBuses[i].uniqueId === uniqueId) {
      displayedBuses[i].plateNumber = plateNumber;
    } 
    // 或者使用多條件匹配
    else if (displayedBuses[i].isInEditing && 
        (displayedBuses[i].isManualInput === bus.isManualInput) &&
        (displayedBuses[i].operatorName === bus.operatorName)) {
      displayedBuses[i].plateNumber = plateNumber;
      // 添加唯一ID以便未來匹配
      displayedBuses[i].uniqueId = uniqueId;
    }
  }
  
  // 更新 allDetectedBuses 中的對應車輛
  for (let i = 0; i < allDetectedBuses.length; i++) {
    // 優先使用唯一ID匹配
    if (uniqueId && allDetectedBuses[i].uniqueId === uniqueId) {
      allDetectedBuses[i].plateNumber = plateNumber;
    } 
    // 或者使用多條件匹配
    else if (allDetectedBuses[i].isInEditing && 
        (allDetectedBuses[i].isManualInput === bus.isManualInput) &&
        (allDetectedBuses[i].operatorName === bus.operatorName)) {
      allDetectedBuses[i].plateNumber = plateNumber;
      // 添加唯一ID以便未來匹配
      allDetectedBuses[i].uniqueId = uniqueId;
    }
  }
  
  // 更新車輛列表顯示
  updateDetectedBusesList();
}
// 4. 創建編輯標籤列
function updateEditingTabs() {
  // 檢查標籤容器是否存在，如果不存在則創建
  let tabsContainer = document.querySelector(".editing-tabs-container");
  // 如果沒有編輯中的車輛，隱藏標籤容器
  if (editingBuses.length === 0) {
    if (tabsContainer) tabsContainer.style.display = "none";
    return;
  }
  // 如果有編輯中的車輛，但沒有標籤容器，創建它
  if (!tabsContainer) {
    tabsContainer = document.createElement("div");
    tabsContainer.className = "editing-tabs-container";
    
    // 插入到busInputContainer之前
    const inputContainer = document.getElementById("busInputContainer");
    inputContainer.parentNode.insertBefore(tabsContainer, inputContainer);
  }
  // 確保標籤容器可見
  tabsContainer.style.display = "flex";
  
  // 清空現有標籤
  tabsContainer.innerHTML = '';
  
  // 為每個編輯中的車輛創建標籤
  editingBuses.forEach((bus, index) => {
    const tab = document.createElement("div");
    tab.className = "editing-tab";
    if (index === activeEditingBusIndex) {
      tab.classList.add("active");
    }
    
    // 標籤顯示車號和公司簡稱
    let companyAbbr = '';
    if (bus.operatorName) {
      companyAbbr = bus.operatorName.replace(/客運$/, "");
      companyAbbr = companyAbbr.length > 2 ? companyAbbr.substring(0, 2) : companyAbbr;
    }
    
    // tab.innerHTML = `
    //   <span>${bus.plateNumber || ''}</span>
    //   <span class="tab-company">${companyAbbr}</span>
    //   <span class="tab-close" data-index="${index}">×</span>
    // `;
        tab.innerHTML = `
      <span>${bus.plateNumber || ''}</span>

      <span class="tab-close" data-index="${index}">×</span>
    `;
// 點擊標籤切換到對應的編輯視圖
tab.addEventListener("click", function(e) {
  // 忽略關閉按鈕的點擊
  if (e.target.classList.contains("tab-close")) return;
  
  activeEditingBusIndex = index;
  
  // 確保編輯區域是可見的
  document.getElementById("busInputContainer").classList.remove("hidden");
  
  // 更新編輯界面
  updateBusEditingInterface();

    // 添加：滾動到編輯區域
  scrollToEditingArea();
});
  
    tabsContainer.appendChild(tab);
});

  // 為關閉按鈕添加事件監聽
  const closeButtons = tabsContainer.querySelectorAll(".tab-close");
  closeButtons.forEach(button => {
    button.addEventListener("click", function(e) {
      e.stopPropagation(); // 阻止事件冒泡，避免觸發標籤點擊
      
      const index = parseInt(this.dataset.index);
      confirmCancelEditing(index);
    });
  });
  if (editingBuses.length > 0) {
    setTimeout(() => {
      scrollToActiveTab();
    }, 10);
  }
}

// 替換
function confirmCancelEditing(index) {
  const confirmModal = document.getElementById("confirmModal");
  const confirmMessage = document.getElementById("confirmMessage");
  const confirmYes = document.getElementById("confirmYes");
  const confirmNo = document.getElementById("confirmNo");
  
  confirmMessage.textContent = "是否取消對此車輛的編輯？";
  confirmModal.style.display = "block";
  
  // 存儲要刪除的索引，供確認按鈕使用
  confirmYes.dataset.index = index;
  
  // 清除之前的事件監聽器
  const newConfirmYes = confirmYes.cloneNode(true);
  const newConfirmNo = confirmNo.cloneNode(true);
  confirmYes.parentNode.replaceChild(newConfirmYes, confirmYes);
  confirmNo.parentNode.replaceChild(newConfirmNo, confirmNo);
  
  // 添加新的事件監聽器
  newConfirmYes.addEventListener("click", function() {
    const indexToRemove = parseInt(this.dataset.index);
    removeEditingBus(indexToRemove);
    confirmModal.style.display = "none";
  });
  
  newConfirmNo.addEventListener("click", function() {
    confirmModal.style.display = "none";
  });
}
// 修改 removeEditingBus 函數
function removeEditingBus(index) {
  // 保存刪除前的信息
  const removedPlateNumber = editingBuses[index]?.plateNumber;
  
  // 移除指定索引的編輯車輛
  editingBuses.splice(index, 1);
  
  // 調整活躍編輯索引
  if (editingBuses.length === 0) {
    // 沒有編輯中的車輛了
    activeEditingBusIndex = -1;
    isProcessingBus = false; // 關鍵修改：重置處理狀態
    document.getElementById("busInputContainer").classList.add("hidden");
    
    // 隱藏標籤容器
    const tabsContainer = document.querySelector(".editing-tabs-container");
    if (tabsContainer) tabsContainer.style.display = "none";
  } else {
    // 保持活躍索引的有效性
    if (activeEditingBusIndex >= editingBuses.length) {
      activeEditingBusIndex = editingBuses.length - 1;
    } else if (activeEditingBusIndex === index) {
      // 如果刪除的是當前活躍車輛，選擇另一輛
      activeEditingBusIndex = 0; // 默認選擇第一輛車
    }
  }
  
  // 更新列表中的選中狀態 - 不傳入被移除的車牌號，讓所有編輯中的車輛都顯示編輯標記
  updateBusSelectionInList();
  
  // 更新標籤和編輯界面
  updateEditingTabs();
  updateBusEditingInterface();
}

// 新增：更新列表中車輛的選中狀態
function updateBusSelectionInList() {
  // 清除所有選中狀態
  document.querySelectorAll('.simple-bus-item').forEach(item => {
    item.classList.remove('selected-bus-item');
  });
  
  // 為所有正在編輯的車輛添加標記
  if (editingBuses.length > 0) {
    const editingPlateNumbers = editingBuses.map(bus => bus.plateNumber);
    
    // 找到對應的列表項並標記為正在編輯
    document.querySelectorAll('.simple-bus-item').forEach(item => {
      const plateElement = item.querySelector('.bus-plate');
      if (plateElement && editingPlateNumbers.includes(plateElement.textContent)) {
        item.classList.add('selected-bus-item');
      }
    });
  }
}
  // 添加視窗大小變化監聽，重新初始化跑馬燈
  window.addEventListener('resize', function() {
    debouncedInitMarquees();
  });
// 修改開始自動偵測函數，確保定時器正確設置
function startAutoDetect() {
  // 先清除任何現有的自動偵測計時器
  if (autoDetectInterval) {
    clearInterval(autoDetectInterval);
    autoDetectInterval = null;
  }
  
  // 立即執行一次偵測，標記為自動偵測
  detectBuses(true);
  
  // 重新設置自動偵測間隔，每20秒執行一次
  autoDetectInterval = setInterval(() => {
    console.log("自動偵測觸發");
    detectBuses(true); // 傳入true表示是自動偵測
  }, 20000); // 每20秒
  
  // 開始倒數計時
  startCountdown();
  
  // 視覺效果：添加自動偵測按鈕的活動樣式
  const autoDetectButton = document.getElementById("autoDetectButton");
  autoDetectButton.classList.add("auto-detect-active");
  
  // 顯示自動偵測已啟動的提示
  showStatusMessage("自動偵測已啟動", "info", true);
}

// 停止自動偵測
function stopAutoDetect() {
  if (autoDetectInterval) {
    clearInterval(autoDetectInterval);
    autoDetectInterval = null;
  }
  
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  
  // 重置倒數顯示
  const countdownElement = document.getElementById("countdown");
  if (countdownElement) {
    countdownElement.textContent = "";
  }
  // 清除自動偵測狀態
  const autoDetectButton = document.getElementById("autoDetectButton");
  autoDetectButton.classList.remove("auto-detect-active");
  document.getElementById("autoDetectStatus").textContent = "自動偵測";
}

// 開始倒數
function startCountdown() {
  if (countdownInterval) {
    clearInterval(countdownInterval);
  }
  
  countdownSeconds = 20;
  updateCountdownDisplay();
  
  countdownInterval = setInterval(() => {
    countdownSeconds--;
    
    if (countdownSeconds <= 0) {
      // 不清除計時器，而是重置倒數
      // 注意：不要在這裡調用 clearInterval
      countdownSeconds = 20; // 直接重置為20秒
    }
    
    updateCountdownDisplay();
  }, 1000);
}
// 更新倒數顯示
function updateCountdownDisplay() {
  const countdownElement = document.getElementById("countdown");
  if (countdownElement) {
    countdownElement.textContent = `${countdownSeconds}秒後重新偵測`;
  }
}
// 獲取是否為集團公司
function isGroupCompany(operatorName) {
  if (!operatorName) return false;

  // 檢查是否為集團公司
  return companies.some(
    (company) =>
      operatorName.includes(company.name) ||
      company.name.includes(operatorName)
  );
}

// 停止位置監視
function stopLocationWatching() {
  if (window.watchId) {
    navigator.geolocation.clearWatch(window.watchId);
    window.watchId = null;
    console.log("已停止位置監視");
  }
}

// 使用改進的存儲函數保存位置
function savePosition(latitude, longitude) {
  safeStorage.set("lastKnownLatitude", latitude);
  safeStorage.set("lastKnownLongitude", longitude);
  safeStorage.set("lastPositionTimestamp", Date.now());

  // 如果成功獲取位置，清除之前的"無法獲取位置"訊息
  const statusElement = document.getElementById("statusMessage");
  if (
    statusElement.textContent.includes("無法獲取位置") ||
    statusElement.textContent.includes("暫時無法獲取位置")
  ) {
    statusElement.textContent = "";
    statusElement.className = "status-message";
  }
}


// 檢查用戶是否已存在/註冊
async function checkUserExists(userId, channelId) {
  try {
    const response = await fetch(base_url + "User/checkUser", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: userId, channelId: channelId }),
    });

    if (response.status === 200) {
      // 用戶已存在，不做任何操作
      return true;
    } else if (response.status === 404) {
      // 用戶不存在
      showStatusMessage("用戶未註冊，請先從LINE中完成註冊", "error");
      return false;
    } else {
      showStatusMessage("檢查用戶信息時發生錯誤，請重新嘗試", "error");
      return false;
    }
  } catch (error) {
    console.error("檢查用戶存在性失敗:", error);
    showStatusMessage("檢查用戶信息時發生錯誤，請重新嘗試", "error");
    return false;
  }
}

async function forceUpdatePosition(silent = false) {
  console.log("強制更新位置...");
  
  try {
    // 清除之前的位置監視，避免衝突
    if (window.watchId) {
      navigator.geolocation.clearWatch(window.watchId);
      window.watchId = null;
    }
    
    // 直接向瀏覽器請求高精度位置
    const position = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,  // 高精度模式
        timeout: 15000,            // 15秒超時
        maximumAge: 0              // 強制不使用緩存
      });
    });
    
    console.log("成功獲取新位置");
    currentLatitude = position.coords.latitude;
    currentLongitude = position.coords.longitude;
    savePosition(currentLatitude, currentLongitude);
    
    // 更新位置精度指示器
    updateLocationAccuracyIndicator(position.coords.accuracy);
    
    // 重新啟動位置監視
    startHighAccuracyLocationWatching(true);
    
    return true;
  } catch (error) {
    console.error("強制更新位置失敗:", error);
    
    // 嘗試使用本地緩存作為後備
    if (loadLastPosition()) {
  // 可以考慮在這裡加入時間檢查，例如只使用最近10秒內的緩存位置
        if (Date.now() - safeStorage.get("lastPositionTimestamp") < 10000) {
          if (!silent) {
            showStatusMessage("使用最近位置作為後備", "info", true);
          }
          return true;
        }
        return false;
    }
    
    if (!silent) {
      showStatusMessage("無法獲取位置，請確認位置權限並在室外使用", "error", true);
    }
    return false;
  }
}
// 8. 修改detectBuses函數，保留編輯中的車輛
async function detectBuses(isAutoDetection = false) {
  // 顯示偵測指示器
  const indicatorMsg = isAutoDetection ? "自動偵測中..." : "正在偵測車輛...";
  showDetectionIndicator(indicatorMsg);
  
  try {
    // 獲取最新位置
    const positionResult = await forceUpdatePosition(isAutoDetection);
    if (!positionResult) {
      hideDetectionIndicator();
      if (!isAutoDetection) {
        showStatusMessage("無法獲取位置，偵測已取消", "error", true);
      }
      return;
    }

    // 保存當前編輯中的車輛的車牌號碼列表，用於檢查重複
    const editingPlateNumbers = editingBuses.map(bus => bus.plateNumber);

    // 清空全局列表，但不包含編輯中的車輛
    allDetectedBuses = [];
    displayedBuses = [];

    // 獲取附近車輛
    const response = await fetchWithRetry(
      `${base_url}monitor/buses?latitude=${currentLatitude}&longitude=${currentLongitude}&distance=300`,
      {},
      3
    );
    
    if (!response.ok) {
      throw new Error(`HTTP 錯誤 ${response.status}`);
    }
    
    const data = await response.json();
    const newDetectedBuses = [];
    const threeMinutes = 3 * 60 * 1000;
    const currentTime = Date.now();
    
    if (data && data.buses && data.buses.length > 0) {
      data.buses.forEach((bus) => {
        // 檢查這輛車是否在編輯列表中
        const editingIndex = editingBuses.findIndex(item => item.plateNumber === bus.plateNumber);
        
        // 如果在編輯列表中，僅更新位置數據
        if (editingIndex !== -1) {
          // 更新編輯中車輛的位置信息
          editingBuses[editingIndex].position = bus.position;
          
          // 添加到檢測列表，但標記為已在編輯中
          bus.isInEditing = true;
        }
        
        if (isGroupCompany(bus.operatorName) && 
            !(submittedBuses.includes(bus.plateNumber) && 
            (currentTime - parseInt(localStorage.getItem(`submitted_${bus.plateNumber}`) || '0')) < threeMinutes)) {
          
          // 添加到全局列表
          allDetectedBuses.push(bus);
          
          if (includeRecordedVehicles || !submittedBuses.includes(bus.plateNumber) || 
              (submittedBuses.includes(bus.plateNumber) && 
              ((currentTime - parseInt(localStorage.getItem(`submitted_${bus.plateNumber}`) || '0')) >= threeMinutes))) {
            
            displayedBuses.push(bus);
            
            // 只有不在編輯列表中的車輛才算作新偵測結果
            if (editingIndex === -1) {
              newDetectedBuses.push(bus);
            }
          }
        }
      });
    }
    
    // 將編輯中的車輛也加入顯示列表
    editingBuses.forEach(bus => {
      // 檢查這輛車是否已經在顯示列表中
      const existingIndex = displayedBuses.findIndex(item => item.plateNumber === bus.plateNumber);
      
      // 如果不在顯示列表中，添加進去
      if (existingIndex === -1) {
        // 標記為已在編輯中
        bus.isInEditing = true;
        
        // 添加到顯示列表
        displayedBuses.push(bus);
        
        // 如果也不在全局列表中，添加進去
        if (!allDetectedBuses.some(item => item.plateNumber === bus.plateNumber)) {
          allDetectedBuses.push(bus);
        }
      }
    });
    
    // 更新UI
    updateDetectedBusesList();
    
    // 顯示通知
    if (newDetectedBuses.length > 0) {
      showNewDetectionNotification(newDetectedBuses.length);
    } else if (!isAutoDetection) {
      showZeroDetectionNotification();
    }
    
    hideDetectionIndicator();
  } catch (error) {
    console.error("偵測車輛失敗:", error);
    hideDetectionIndicator();
    
    if (!isAutoDetection) {
      showStatusMessage("偵測車輛失敗，請稍後再試", "error", true);
    }
  }
}

// 新增顯示無車輛的浮動通知函數
function showZeroDetectionNotification() {
  const notification = document.getElementById("realTimeDetection");
  const countDisplay = document.getElementById("detectionCount");
  const textElement = notification.querySelector("span:not(.detection-count)");
  
  countDisplay.textContent = "0";
  textElement.textContent = "附近未偵測到車輛";
  
  notification.classList.add("show");
  
  // 5秒後自動隱藏
  setTimeout(() => {
    notification.classList.remove("show");
  }, 5000);
}

// 獲取車輛距離的輔助函數
function getVehicleDistance(bus) {
  // 預設999米
  let distanceInMeters = 999;
  
  // 嘗試從Distance字段獲取距離（如果存在）
  if (bus.Distance !== undefined) {
    distanceInMeters = bus.Distance * 1000; // 公里轉公尺
  }
  // 如果沒有Distance字段，嘗試從位置計算距離
  else if (bus.position && bus.position.latitude && bus.position.longitude) {
    distanceInMeters = calculateDistance(
      currentLatitude, 
      currentLongitude, 
      bus.position.latitude, 
      bus.position.longitude
    );
  }
  // 如果是手動添加的車輛且沒有距離信息，默認設為10米（很近）
  if (bus.isManualInput && distanceInMeters === 999) {
    distanceInMeters = 10;
  }
  return distanceInMeters;
}

// 根據距離為元素添加CSS類
function addDistanceClassToElement(element, distanceInMeters) {
  // 先清除所有距離相關的類
  element.classList.remove("distance-veryclose", "distance-close", "distance-medium", "distance-far");
  
  // 添加對應的距離類
  if (distanceInMeters <= 80) {
    element.classList.add("distance-veryclose"); // 0-80m 滿色
  } else if (distanceInMeters <= 150) {
    element.classList.add("distance-close"); // 81-150m 3/4滿色
  } else if (distanceInMeters <= 220) {
    element.classList.add("distance-medium"); // 151-220m 2/4滿色
  } else {
    element.classList.add("distance-far"); // 221m以上 1/4滿色
  }
}


// 使用DocumentFragment優化更新車輛列表
function updateDetectedBusesList() {
  const container = document.getElementById("detectedBusesList");
  
  // 更新計數
  document.getElementById("busCount").textContent = `${displayedBuses.length} 輛`;
  
  // 使用DocumentFragment來減少DOM操作
  const fragment = document.createDocumentFragment();
  
  if (displayedBuses.length === 0) {
    const noDataMessage = document.createElement("div");
    noDataMessage.className = "no-buses-message";
    noDataMessage.innerHTML = `
      <i class="fas fa-bus" style="font-size: 24px; color: #adb5bd; margin-bottom: 10px;"></i>
      <p>尚未檢測到車輛，請點擊「偵測車輛」按鈕</p>
    `;
    fragment.appendChild(noDataMessage);
  } else {
    // 創建簡易車輛列表
    const busListContainer = document.createElement("div");
    busListContainer.className = "simple-bus-list";
    
    displayedBuses.forEach((bus, index) => {
      const busItem = createBusListItem(bus, index);
      busListContainer.appendChild(busItem);
    });
    
    fragment.appendChild(busListContainer);
  }
  
  // 清空容器並一次性添加所有新元素
  container.innerHTML = "";
  container.appendChild(fragment);
  
  setTimeout(() => {
    debouncedInitMarquees();
  }, 50);
}

function countChineseChars(str) {
  // 使用正則表達式計算中文字符數量
  const chineseCharsMatch = str.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g);
  return chineseCharsMatch ? chineseCharsMatch.length : 0;
}
// 在 createBusListItem 函數中找到以下代碼片段並替換
function createBusListItem(bus, index) {
  // 路線信息
  const routeInfo = bus.routeName?.chinese || "未知路線";
  
  const busItem = document.createElement("div");
  busItem.className = "simple-bus-item";
  
  // 如果車輛已在編輯中，添加編輯中樣式
  // 使用唯一ID或多條件匹配檢查是否在編輯中
  const isEditing = bus.isInEditing || editingBuses.some(editingBus => {
    return (bus.uniqueId && editingBus.uniqueId === bus.uniqueId) || 
           (editingBus.plateNumber === bus.plateNumber && 
            editingBus.operatorName === bus.operatorName && 
            editingBus.isManualInput === bus.isManualInput);
  });
  
  if (isEditing) {
    busItem.classList.add("selected-bus-item");
  }
  
  // 創建路線元素包裹容器
  const routeElement = document.createElement("div");
  routeElement.className = "bus-route-container";
  
  // 使用跑馬燈包裝路線文字
  const routeTextElement = document.createElement("div");
  routeTextElement.className = "text-marquee";
  
  // 如果中文字符數量超過5個，或總長度超過12個字符，則啟用跑馬燈
  if (countChineseChars(routeInfo) > 5 || routeInfo.length > 12) {
    routeTextElement.classList.add("list-marquee", "scrolling");
    // 重複文本以避免空白間隔
    const repeatedText = routeInfo + "　" + routeInfo + "　" + routeInfo + "　" + routeInfo + "　" + routeInfo;
    routeTextElement.textContent = repeatedText;
  } else {
    // 短路線名稱直接顯示，不使用跑馬燈
    routeTextElement.textContent = routeInfo;
  }
  
  // 添加title屬性
  routeElement.title = routeInfo;
  
  routeElement.appendChild(routeTextElement);
  
  // 創建車號元素
  const plateElement = document.createElement("div");
  plateElement.className = "bus-plate";
  
  // 獲取距離並設置對應的CSS類
  const distanceInMeters = getVehicleDistance(bus);
  addDistanceClassToElement(plateElement, distanceInMeters);
  
  // 添加方向樣式類
  if (bus.direction === "0") {
    plateElement.classList.add("direction-go");
  } else if (bus.direction === "1") {
    plateElement.classList.add("direction-back");
  }

  plateElement.textContent = bus.plateNumber;
  
  // 將元素添加到車輛項目中
  busItem.appendChild(routeElement);
  busItem.appendChild(plateElement);
  
  // 修改事件綁定
  busItem.onclick = function(event) {
    // 防止連續點擊誤觸發
    if (busItem._clickTimer) return;
    
    // 設置點擊計時器，用於區分單擊和雙擊
    busItem._clickTimer = setTimeout(function() {
      busItem._clickTimer = null;
      // 單擊：僅添加到待編輯
      selectBusForInput(bus, index, false); // 添加第三個參數，表示不滾動
    }, 300); // 300毫秒延遲，在此時間內如有第二次點擊則判定為雙擊
  };
  
  busItem.ondblclick = function(event) {
    // 清除單擊計時器，防止觸發單擊事件
    if (busItem._clickTimer) {
      clearTimeout(busItem._clickTimer);
      busItem._clickTimer = null;
    }
    
    // 雙擊：添加到待編輯並滾動到編輯區
    selectBusForInput(bus, index, true); // 傳入true表示滾動到編輯區
  };
  
  return busItem;
}

// 計算兩點間距離的函數
function calculateDistance(lat1, lon1, lat2, lon2) {
  // 如果缺少座標，返回最大距離
  if (!lat1 || !lon1 || !lat2 || !lon2) {
    return 999;
  }
  
  // 轉為數字類型
  lat1 = parseFloat(lat1);
  lon1 = parseFloat(lon1);
  lat2 = parseFloat(lat2);
  lon2 = parseFloat(lon2);
  
  // 使用Haversine公式計算地球表面兩點間的距離
  const R = 6371000; // 地球半徑，單位為米
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;
  
  return distance;
}

// 顯示新偵測通知
function showNewDetectionNotification(count) {
  const notification = document.getElementById("realTimeDetection");
  const countDisplay = document.getElementById("detectionCount");

  countDisplay.textContent = count;
  
  // 更新通知顯示的文字，增加更多上下文
  const textElement = notification.querySelector("span:not(.detection-count)");
  
  // 是自動偵測的通知還是手動偵測的通知
  const isAutoDetect = !!autoDetectInterval;
  if (isAutoDetect) {
    textElement.textContent = "個新偵測結果";
  } else {
    textElement.textContent = "輛車已偵測到";
  }
  
  notification.classList.add("show");

  // 5秒後自動隱藏
  setTimeout(() => {
    notification.classList.remove("show");
  }, 5000);
}

// 顯示已偵測的車輛
function showDetectedBuses() {
  document.getElementById("realTimeDetection").classList.remove("show");

  // 滾動到車輛列表
  document.getElementById("detectedBusesContainer").scrollIntoView({
    behavior: "smooth",
  });
}

// 提交選中的車輛
// 7. 修改submitSelectedBus函數
function submitSelectedBus() {
  // 清除之前的錯誤訊息
  const statusElement = document.getElementById("statusMessage");
  statusElement.textContent = "";
  statusElement.className = "status-message";

  if (activeEditingBusIndex < 0 || editingBuses.length === 0) {
    showStatusMessage("請先選擇車輛", "error");
    return;
  }
  
  // 獲取當前活躍的編輯車輛
  const bus = editingBuses[activeEditingBusIndex];
  
  // 確保選擇了主要項目
  if (!bus.selectedMainItem) {
    showStatusMessage("請選擇查核結果", "error");
    return;
  }
  
  // 確保選擇了位置
  if (!document.getElementById("location").value) {
    showStatusMessage("請選擇查核位置", "error");
    return;
  }
  
  // 防止重複點擊
  const submitButton = document.querySelector(".action-button.submit-button");
  submitButton.classList.add("disabled");
  
  // 提交記錄
  submitBusRecord(bus, null, bus.selectedMainItem, bus.selectedOtherItems || [])
    .then(() => {
      // 清除錯誤訊息
      statusElement.textContent = "";
      statusElement.className = "status-message";
      
      // 提交成功後，從編輯列表中移除
      editingBuses.splice(activeEditingBusIndex, 1);
      
      // 調整活躍編輯索引
      if (editingBuses.length === 0) {
        // 沒有編輯中的車輛了
        activeEditingBusIndex = -1;
        document.getElementById("busInputContainer").classList.add("hidden");
      } else {
        // 如果還有其他車輛在編輯中
        activeEditingBusIndex = Math.min(activeEditingBusIndex, editingBuses.length - 1);
        // 確保更新編輯界面
        updateBusEditingInterface();
      }
      
      // 更新標籤
      updateEditingTabs();
    })
    .catch(error => {
      // 出錯時已經在 submitBusRecord 中處理了
    });
  
  // 5秒後恢復按鈕
  setTimeout(() => {
    submitButton.classList.remove("disabled");
  }, 5000);
}
// 添加一個新函數來重置提交按鈕狀態
function resetSubmitButtonState() {
    const submitButton = document.querySelector(".action-button.submit-button");
    if (submitButton && submitButton.classList.contains("disabled")) {
        submitButton.classList.remove("disabled");
    }
}

// 在創建快速選項時添加這個功能
function createQuickItems() {
    const mainItemsContainer = document.getElementById("mainItemsContainer");
    mainItemsContainer.innerHTML = '';
    mainItems.forEach(item => {
        const itemButton = document.createElement("div");
        itemButton.className = "quick-item";
        itemButton.textContent = item;
        itemButton.dataset.value = item;
        itemButton.onclick = function() {
            mainItemsContainer.querySelectorAll(".quick-item").forEach(el => {
                el.classList.remove("selected");
            });
            this.classList.add("selected");
            
            // 選擇項目後檢查並啟用提交按鈕
            resetSubmitButtonState();
        };
        mainItemsContainer.appendChild(itemButton);
    });
}
// 提交車輛記錄

// 修改 submitBusRecord 函數，處理 otherItem 和 goodItem 欄位
// 完全重寫提交記錄函數
async function submitBusRecord(bus, index, mainItem, selectedOtherItems) {
  showLoading();
  
  try {
    // 確保有選擇主要項目
    if (!mainItem) {
      showStatusMessage("請選擇查核結果", "error");
      hideLoading();
      return Promise.reject(new Error("未選擇查核結果"));
    }
    
    // 確保 selectedOtherItems 是數組
    let itemsArray = [];
    
    if (Array.isArray(selectedOtherItems)) {
      itemsArray = [...selectedOtherItems]; // 建立副本
    } else if (typeof selectedOtherItems === 'string') {
      // 處理逗號分隔的字符串
      itemsArray = selectedOtherItems.split(',')
        .map(item => item.trim())
        .filter(item => item.length > 0);
    } else if (selectedOtherItems && typeof selectedOtherItems === 'object') {
      // 處理對象形式
      try {
        itemsArray = Object.values(selectedOtherItems).filter(item => item);
      } catch (e) {
        console.error("解析selectedOtherItems對象失敗:", e);
        itemsArray = [];
      }
    }
    
    console.log("處理後的選中項目數組:", itemsArray);
    
    // 定義正向和負向項目數組
    const positiveItems = [];
    const negativeItems = [];
    const unclassifiedItems = [];
    
    // 遍歷所有選中的項目，進行分類
    for (let i = 0; i < itemsArray.length; i++) {
      const itemName = itemsArray[i];
      if (!itemName) continue; // 跳過空白項目
      
      // 在 otherItems 中查找對應項目
      let foundItem = null;
      
      // 確保 otherItems 存在且是數組
      if (Array.isArray(otherItems) && otherItems.length > 0) {
        foundItem = otherItems.find(item => 
          item && item.itemName === itemName
        );
      }
      
      if (foundItem) {
        // 使用輔助函數檢查項目類型
        const itemType = logItemClassification(itemName, foundItem);
        
        if (itemType === "positive") {
          console.log(`✅ 確認 "${itemName}" 為正向項目，加入 goodItem`);
          positiveItems.push(itemName);
        } else if (itemType === "negative") {
          console.log(`❌ 確認 "${itemName}" 為負向項目，加入 otherItem`);
          negativeItems.push(itemName);
        } else {
          console.log(`⚠️ 項目 "${itemName}" 類型無法確定，加入 otherItem`);
          unclassifiedItems.push(itemName);
        }
      } else {
        // 找不到對應項目的情況
        console.log(`⚠️ 無法在 otherItems 中找到項目 "${itemName}"，加入 otherItem`);
        unclassifiedItems.push(itemName);
      }
    }
    
    // 將未分類項目加入負向項目列表
    const finalNegativeItems = [...negativeItems, ...unclassifiedItems];
    
    // 構建最終提交數據
    const submissionData = {
      userId: document.getElementById("userId").value,
      location: document.getElementById("location").value,
      plateNumbCompany: bus.operatorName || "不明",
      routeName: bus.routeName?.chinese || "不明",
      plateNumber: bus.plateNumber,
      direction: bus.direction,
      positionLat: `(${bus.position?.latitude || currentLatitude},${
        bus.position?.longitude || currentLongitude
      })`,
      mainItem: mainItem,
      otherItem: finalNegativeItems.join(", "), // 負向項目和未分類項目
      goodItem: positiveItems.join(", ")        // 正向項目
    };
    
    // 詳細記錄最終提交的數據
    console.log("最終提交數據:", JSON.stringify(submissionData, null, 2));
    console.log("正向項目(goodItem):", positiveItems);
    console.log("負向項目(otherItem):", finalNegativeItems);
    
    // 發送請求
    const response = await fetch(`${base_url}monitor/records`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(submissionData)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText || `HTTP錯誤 ${response.status}`);
    }
    
    // 處理成功響應
    const data = await response.json();
    console.log("提交成功，服務器響應:", data);
    
    // 更新UI和本地存儲
    handleSubmitSuccess(bus);
    
    return Promise.resolve(data);
  } catch (error) {
    console.error("提交失敗:", error);
    showFloatingNotification(`提交失敗: ${error.message}`, "error");
    return Promise.reject(error);
  } finally {
    hideLoading();
  }
}

// 提取提交成功後的處理邏輯為單獨函數
function handleSubmitSuccess(bus) {
  // 清除頂部錯誤訊息
  const statusElement = document.getElementById("statusMessage");
  statusElement.textContent = "";
  statusElement.className = "status-message";
  
  // 添加到已提交列表
  submittedBuses.push(bus.plateNumber);
  
  // 設置提交時間，3分鐘內不再顯示
  const submissionTime = Date.now();
  localStorage.setItem(`submitted_${bus.plateNumber}`, submissionTime);
  
  // 從顯示列表移除
  displayedBuses = displayedBuses.filter(item => item.plateNumber !== bus.plateNumber);
  
  // 更新UI
  updateDetectedBusesList();
  
  // 隱藏輸入區域
  document.getElementById("busInputContainer").classList.add("hidden");
  activeEditingBusIndex = -1;
  
  // 修改這行，添加詳細資訊到成功提示
  const routeName = bus.routeName?.chinese || "未知路線";
  const companyName = bus.operatorName || "未知公司";
  const successMessage = `已成功送出記錄：${bus.plateNumber} (${companyName} ${routeName})`;
  
  // 使用浮動通知顯示詳細資訊
  showFloatingNotification(successMessage, "success");
}

// 添加浮動通知函數
function showFloatingNotification(message, type) {
  // 先檢查是否已存在通知元素
  let notification = document.getElementById("floatingNotification");
  
  // 如果不存在，則創建一個
  if (!notification) {
    notification = document.createElement("div");
    notification.id = "floatingNotification";
    notification.className = "floating-notification";
    document.body.appendChild(notification);
  }
  
  // 設置通知內容和樣式
  notification.textContent = message;
  notification.className = "floating-notification"; // 重置類
  notification.classList.add(type);
  
  // 顯示通知
  notification.classList.add("show");
  
  // 3秒後自動隱藏
  setTimeout(() => {
    notification.classList.remove("show");
  }, 3000);
}
// 修改定位函數，提高精度
async function getCurrentPosition(silent = false) {
  showLoading();
  console.log("開始獲取高精度位置...");
  
  let retryCount = 0;
  const maxRetries = 3;

  try {
    while (retryCount < maxRetries && navigator.geolocation) {
      try {
        // 清除之前的位置監視，避免衝突
        if (window.watchId) {
          navigator.geolocation.clearWatch(window.watchId);
          window.watchId = null;
        }
        
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true, // 高精度模式
            timeout: 20000,           // 更長的超時時間(20秒)
            maximumAge: 0             // 不使用緩存位置
          });
        });

        console.log("高精度位置獲取成功");
        currentLatitude = position.coords.latitude;
        currentLongitude = position.coords.longitude;
        savePosition(currentLatitude, currentLongitude);
        
        // 更新位置精度指示器
        updateLocationAccuracyIndicator(position.coords.accuracy);
        
        // 重新啟動位置監視
        startHighAccuracyLocationWatching(true);
        
        hideLoading();
        return true;
      } catch (geoError) {
        console.error("位置API錯誤:", geoError.code, geoError.message);
        retryCount++;
        
        if (retryCount < maxRetries) {
          console.log(`位置獲取失敗，進行第${retryCount}次重試`);
          // 延遲3秒後重試，給予更多時間獲取GPS信號
          await new Promise(resolve => setTimeout(resolve, 3000));
        } else {
          console.log("達到最大重試次數");
          break;
        }
      }
    }

 if (loadLastPosition()) {
      console.log("使用本地緩存位置作為後備");
      hideLoading();
      return true;
    }
    // 3. 如果所有嘗試都失敗，使用默認位置作為後備
    console.log("使用預設位置作為後備");
    currentLatitude = 25.033; // 台北市中心位置
    currentLongitude = 121.565;
    savePosition(currentLatitude, currentLongitude);
    
    // 更新位置精度指示器為最低精度
    updateLocationAccuracyIndicator(999);
    
    hideLoading();

    if (!silent) {
      showStatusMessage("無法準確獲取位置，請確認位置服務已開啟", "warning", true);
    }
    return true;
  } catch (error) {
    console.error("位置獲取完全失敗:", error);
    hideLoading();
    
    // 更新位置精度指示器為出錯狀態
    updateLocationAccuracyIndicator(999);
    
    if (!silent) {
      showStatusMessage("無法獲取位置，請開啟位置權限或至室外", "error", true);
    }
    return false;
  }
}
// 新增頁面焦點/可見性相關優化
document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'visible') {
    console.log('頁面重新變為可見，更新位置...');
    
    // 如果位置監視器不存在，重新啟動
    if (!window.watchId) {
      startHighAccuracyLocationWatching(true);
    }
    
    // 獲取最新位置，但使用靜默模式避免彈出訊息
    getCurrentPosition(true).then(success => {
      if (success) {
        console.log('頁面重新可見時成功更新位置');
      }
    });
    
    // 如果開啟了自動偵測但計時器不存在，重新啟動
    const statusElem = document.getElementById("autoDetectStatus");
    if (statusElem && statusElem.textContent === "停止自動" && !autoDetectInterval) {
      console.log("檢測到自動偵測已停止，重新啟動");
      startAutoDetect();
    }
  }
});

// 網絡狀態變化監聽器 - 放在全局初始化區域
window.addEventListener('online', function() {
  console.log("網絡連接恢復，重新獲取位置");
  if (document.visibilityState === 'visible') {
    getCurrentPosition(true);
  }
});

// 嘗試從 localStorage 讀取位置，使用明確的超時時間常量
function loadLastPosition() {
  const POSITION_VALID_DURATION_MS = 20 * 1000; // 20秒
  
  try {
    const lastLat = safeStorage.get("lastKnownLatitude");
    const lastLng = safeStorage.get("lastKnownLongitude");
    const timestamp = safeStorage.get("lastPositionTimestamp");

    if (lastLat && lastLng && timestamp) {
      if (Date.now() - timestamp < POSITION_VALID_DURATION_MS) {
        currentLatitude = parseFloat(lastLat);
        currentLongitude = parseFloat(lastLng);
        return true;
      }
    }
  } catch (e) {
    console.log("無法從本地儲存讀取位置:", e);
  }
  return false;
}

// 檢查位置權限
function checkLocationPermission() {
  if (!navigator.permissions) {
    console.log("瀏覽器不支持權限檢查API");
    return;
  }

  navigator.permissions.query({ name: "geolocation" }).then((result) => {
    if (result.state === "denied") {
      showStatusMessage(
        "位置權限已被拒絕，請在瀏覽器或LINE設置中允許位置訪問",
        "error"
      );
    } else if (result.state === "prompt") {
      console.log("位置權限將在需要時提示用戶");
    } else if (result.state === "granted") {
      console.log("位置權限已授予");
    }
  });
}
// 刷新位置列表
function refreshLocationList() {
  // 更新按鈕狀態，顯示正在加載
  const detectButton = document.getElementById("detectLocationButton");
  if (detectButton) {
    const originalText = detectButton.innerHTML;
    detectButton.disabled = true;
    detectButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 偵測中...';

    // 移除任何存在的錯誤或無數據消息
    const errorMsg = document.getElementById("locationListError");
    if (errorMsg) errorMsg.remove();

    // 清空位置列表，添加載入中提示
    const container = document.getElementById("locationList");
    container.innerHTML = "";
    const loadingMsg = document.createElement("p");
    loadingMsg.id = "locationListLoading";
    loadingMsg.className = "no-data-message";
    loadingMsg.innerHTML =
      '<i class="fas fa-spinner fa-spin"></i> 正在搜尋附近位置...';
    container.appendChild(loadingMsg);

    // 獲取位置並刷新路口列表
    getCurrentPosition(false)
      .then((success) => {
        if (success) {
          fetchIntersections().finally(() => {
            // 無論成功與否，恢復按鈕狀態
            detectButton.disabled = false;
            detectButton.innerHTML = originalText;
          });
        } else {
          // 位置獲取失敗
          detectButton.disabled = false;
          detectButton.innerHTML = originalText;

          // 移除載入中提示
          if (document.getElementById("locationListLoading")) {
            document.getElementById("locationListLoading").remove();
          }

          showLocationListError("無法獲取位置，請稍後再試");
        }
      })
      .catch((error) => {
        // 出錯時也恢復按鈕狀態
        detectButton.disabled = false;
        detectButton.innerHTML = originalText;

        // 移除載入中提示
        if (document.getElementById("locationListLoading")) {
          document.getElementById("locationListLoading").remove();
        }

        showLocationListError("獲取位置時發生錯誤，請稍後再試");
      });
  }
}

// 打開位置選擇框
function openLocationModal() {
  // 先顯示對話框，不等待位置
  document.getElementById("locationModal").style.display = "block";

  // 添加載入中提示
  const container = document.getElementById("locationList");
  container.innerHTML = "";
  const loadingMsg = document.createElement("p");
  loadingMsg.id = "locationListLoading";
  loadingMsg.className = "no-data-message";
  loadingMsg.innerHTML =
    '<i class="fas fa-spinner fa-spin"></i> 正在搜尋附近位置...';
  container.appendChild(loadingMsg);

  // 獲取位置並獲取附近路口
  getCurrentPosition(false)
    .then((success) => {
      if (success) {
        fetchIntersections();
      } else {
        // 移除載入中提示
        if (document.getElementById("locationListLoading")) {
          document.getElementById("locationListLoading").remove();
        }
        showLocationListError("無法獲取位置，請點擊重新偵測");
      }
    })
    .catch((error) => {
      // 位置獲取失敗，但對話框已顯示
      if (document.getElementById("locationListLoading")) {
        document.getElementById("locationListLoading").remove();
      }
      showLocationListError("無法獲取位置，請點擊重新偵測");
    });
}

// 關閉位置選擇彈窗
function closeLocationModal() {
  document.getElementById("locationModal").style.display = "none";
}
// 選擇隨車稽查
function selectOnBoardInspection() {
  document.getElementById("location").value = "隨車稽查";
  closeLocationModal();
}
// 顯示位置列表錯誤訊息
function showLocationListError(message) {
  const container = document.getElementById("locationList");
  // 先檢查是否已經有錯誤訊息
  let errorMsg = document.getElementById("locationListError");

  if (!errorMsg) {
    errorMsg = document.createElement("p");
    errorMsg.id = "locationListError";
    errorMsg.className = "no-data-message";
    container.appendChild(errorMsg);
  }

  errorMsg.textContent = message;
}
// 獲取附近交叉路口
async function fetchIntersections() {
  showLoading();
  try {
     // 先強制更新位置
    await forceUpdatePosition(true);
    // 始終使用最新的坐標
    const response = await fetch(
      `${base_url}monitor/intersections?latitude=${currentLatitude}&longitude=${currentLongitude}&radius=250&limit=10`
    );
   // const response = await fetch(
//      `${base_url}monitor/osm/intersections?latitude=${currentLatitude}&longitude=${currentLongitude}&radius=200&limit=10`
 //   );
    if (!response.ok) {
      throw new Error(`HTTP 錯誤 ${response.status}`);
    }

    const data = await response.json();

    if (data && data.length > 0) {
      intersections = data;
      console.log("找到附近位置:", intersections);
    } else {
      console.log("附近未找到位置");
      intersections = [];
    }

    // 更新位置選擇框中的路口列表
    updateLocationList();
    hideLoading();
  } catch (error) {
    console.error("獲取路口失敗:", error);
    hideLoading();
    showStatusMessage("無法獲取附近可能路口，請重新偵測", "error",true);
  }
}
// 更新位置列表
function updateLocationList() {
  const container = document.getElementById("locationList");

  // 移除載入中提示
  const loadingMsg = document.getElementById("locationListLoading");
  if (loadingMsg) loadingMsg.remove();

  // 檢查是否找到路口
  if (intersections.length === 0) {
    // 移除任何存在的錯誤訊息
    const errorMsg = document.getElementById("locationListError");
    if (errorMsg) errorMsg.remove();

    // 顯示無數據訊息
    const noDataElement = document.createElement("p");
    noDataElement.id = "locationListNoData";
    noDataElement.className = "no-data-message";
    noDataElement.textContent = "附近未找到路口，請點擊重新偵測";
    container.appendChild(noDataElement);
    return;
  }

  // 清空容器，準備添加路口列表
  container.innerHTML = "";

  // 創建列表容器
  const listContainer = document.createElement("div");
  listContainer.id = "intersectionListContainer";
  listContainer.className = "bus-list-container"; // 重用現有樣式

  intersections.forEach((intersection) => {
    const item = document.createElement("div");
    item.className = "location-item";
    item.textContent = intersection.name;
    item.addEventListener("click", function () {
      document.getElementById("location").value = intersection.name;
      closeLocationModal();
    });
    listContainer.appendChild(item);
  });

  container.appendChild(listContainer);
}

// 獲取其他項目列表
async function fetchOtherItems() {
  try {
    // 預設項目，包含明確的 Catolog 和 itemType 欄位
    const defaultItems = [
      { id: "1", itemName: "車身未清潔", catolog: "設備問題", itemType: -1 },
      { id: "2", itemName: "車輛燈號故障", catolog: "設備問題", itemType: -1 },
      { id: "3", itemName: "闖紅燈", catolog: "駕駛行為", itemType: -1 },
      { id: "4", itemName: "LED故障", catolog: "設備問題", itemType: -1 },
      { id: "5", itemName: "無動態", catolog: "設備問題", itemType: -1 },
      { id: "6", itemName: "服務態度佳", catolog: "服務態度", itemType: 1 },
      { id: "7", itemName: "禮讓行人", catolog: "駕駛行為", itemType: 1 },
      { id: "8", itemName: "主動協助乘客", catolog: "服務態度", itemType: 1 }
    ];

    const response = await fetch(`${base_url}monitor/otherItem`);

    if (response.ok) {
      const data = await response.json();
      if (data && data.data && data.data.length > 0) {
        // 直接使用API返回的數據，不自動添加分類
        otherItems = data.data;
        console.log("獲取其他項目:", otherItems);
      } else {
        console.log("使用預設其他項目");
        otherItems = defaultItems;
      }
    } else {
      console.log("API回應錯誤，使用預設其他項目");
      otherItems = defaultItems;
    }
  } catch (error) {
    console.error("獲取其他項目失敗:", error);
    // 使用預設項目
    otherItems = defaultItems;
  }
}


// 清理過期的提交記錄，使用清晰的常量命名
function cleanupExpiredSubmissions() {
  const SUBMISSION_EXPIRY_TIME_MS = 3 * 60 * 1000; // 3分鐘
  const currentTime = Date.now();
  
  try {
    // 遍歷 localStorage 查找所有提交記錄
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('submitted_')) {
        const submissionTime = parseInt(localStorage.getItem(key));
        if (currentTime - submissionTime >= SUBMISSION_EXPIRY_TIME_MS) {
          // 超過3分鐘，刪除該記錄
          localStorage.removeItem(key);
        }
      }
    }
  } catch (error) {
    console.error("清理過期提交記錄失敗:", error);
  }
}

// 關閉歷史記錄彈窗
function closeHistoryModal() {
  document.getElementById("historyModal").style.display = "none";
}

// 獲取用戶今日最後位置記錄
async function fetchLastLocation(userId) {
  try {
    if (!userId) {
      console.log("獲取最後位置失敗: 用戶ID為空");
      return null;
    }

    const response = await fetch(
      `${base_url}monitor/lastLocation/${userId}`
    );

    if (!response.ok) {
      throw new Error(`HTTP 錯誤 ${response.status}`);
    }

    const data = await response.json();

    if (data.success && data.location) {
      console.log("成功獲取最後記錄位置:", data.location);
      return data.location;
    } else {
      console.log("今天沒有位置記錄:", data.message);
      return null;
    }
  } catch (error) {
    console.error("獲取最後位置記錄失敗:", error);
    return null;
  }
}
// 顯示狀態訊息
// 更新 showStatusMessage 函數（約在行 1230 左右）：
function showStatusMessage(message, type, autoHide = false) {
  const statusElement = document.getElementById("statusMessage");
  statusElement.textContent = message;
  statusElement.className = "status-message";
  statusElement.classList.add(type);
  
  // 將頁面滾動至頂部，確保用戶可以看到錯誤訊息
  window.scrollTo({
    top: 0,
    behavior: "smooth",
  });
  
  // 如果是成功訊息或者設置了自動隱藏，5秒後自動隱藏
  if (type === "success" || autoHide) {
    setTimeout(() => {
      statusElement.textContent = "";
      statusElement.className = "status-message";
    }, 5000);
  }
  
  return statusElement; // 返回元素，以便呼叫者可以進一步操作
}

// 顯示載入中
function showLoading(timeoutMs = 10000) {
  // 檢查是否距離上次loading時間太短
  const currentTime = Date.now();
  if (currentTime - lastLoadingTime < MIN_LOADING_INTERVAL) {
    console.log("短時間內連續loading，忽略此次請求");
    return null;
  }
  // 記錄本次loading時間
  lastLoadingTime = currentTime;

  const loadingElement = document.getElementById("loading-overlay");
  loadingElement.classList.remove("hidden");
  
  // 添加自動超時
  if (globalLoadingTimeout) clearTimeout(globalLoadingTimeout);
  globalLoadingTimeout = setTimeout(() => {
    console.warn("Loading超時，自動關閉");
    hideLoading();
  }, timeoutMs);
  
  return loadingElement;
}

// 隱藏載入中
function hideLoading() {
  document.getElementById("loading-overlay").classList.add("hidden");
  if (globalLoadingTimeout) {
    clearTimeout(globalLoadingTimeout);
    globalLoadingTimeout = null;
  }
}

// 頁面關閉前清理和保存
window.addEventListener("beforeunload", function () {
  // 停止位置監視
  stopLocationWatching();
  
  // 可以在這裡添加其他需要在頁面關閉前執行的清理代碼
});

// 添加網絡重試機制的輔助函數
async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
  try {
    const response = await fetch(url, options);
    if (response.ok) return response;
    
    throw new Error(`HTTP error ${response.status}`);
  } catch (err) {
    if (retries <= 1) throw err;
    
    await new Promise(resolve => setTimeout(resolve, delay));
    return fetchWithRetry(url, options, retries - 1, delay * 1.5);
  }
}
// 顯示偵測指示器
function showDetectionIndicator(message = "正在偵測車輛...") {
  const indicator = document.getElementById('detectionIndicator');
  const messageElem = document.getElementById('detectionMessage');
  messageElem.textContent = message;
  indicator.classList.add('active');
  
  // 添加檢測按鈕的高亮效果
  const detectButton = document.querySelector('.utility-button:nth-child(1)');
  if (detectButton) {
    detectButton.classList.add('detecting');
  }
  
  return indicator;
}

// 隱藏偵測指示器
function hideDetectionIndicator() {
  const indicator = document.getElementById('detectionIndicator');
  indicator.classList.remove('active');
  
  // 移除檢測按鈕的高亮效果
  const detectButton = document.querySelector('.utility-button:nth-child(1)');
  if (detectButton) {
    detectButton.classList.remove('detecting');
  }
}
// 在頁面加載或模態框打開時初始化方向按鈕
function initDirectionButtons() {
  const directionBtns = document.querySelectorAll('.direction-btn');
  
  // 設置默認選中去程
  directionBtns[0].classList.add('selected');
  document.getElementById('manualDirection').value = "0";
  
  directionBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // 移除所有按鈕的選中狀態
      directionBtns.forEach(b => b.classList.remove('selected'));
      
      // 選中當前按鈕
      this.classList.add('selected');
      
      // 設置隱藏輸入的值
      document.getElementById('manualDirection').value = this.dataset.value;
    });
  });
}

// 改進跑馬燈功能，解決卡住問題
function initializeMarquees() {
  const CHARACTER_SCROLL_SPEED = 0.7;
  const MIN_DURATION = 8;
  const MAX_DURATION = 20;
  
  // 獲取所有需要處理的跑馬燈元素
  const marquees = document.querySelectorAll('.text-marquee');
  
  // 如果沒有元素，直接返回
  if (marquees.length === 0) return;
  
  // 使用 requestAnimationFrame 確保在瀏覽器渲染後進行處理
  requestAnimationFrame(() => {
    marquees.forEach(marquee => {
      // 檢查元素是否可見且已渲染
      if (!isElementVisible(marquee)) return;
      
      // 獲取父元素和文本寬度
      const parentWidth = marquee.parentElement.offsetWidth;
      const textWidth = marquee.scrollWidth;
      
      // 只有當文本超出容器寬度時才設置滾動
      if (textWidth > parentWidth) {
        // 移除現有動畫類以重置
        marquee.classList.remove('scrolling');
        
        // 計算適當的動畫持續時間
        const textLength = marquee.textContent.length;
        let duration = textLength * CHARACTER_SCROLL_SPEED;
        duration = Math.max(MIN_DURATION, Math.min(MAX_DURATION, duration));
        
        // 設置動畫持續時間變量
        marquee.style.setProperty('--scroll-duration', `${duration}s`);
        
        // 強制重排
        void marquee.offsetWidth;
        
        // 重新添加動畫類
        marquee.classList.add('scrolling');
      } else {
        // 內容未超出，不需要滾動
        marquee.classList.remove('scrolling');
      }
    });
    
    // 單獨處理列表跑馬燈以獲得更好的性能
    handleListMarquees();
  });
}

// 輔助函數：檢查元素是否可見
function isElementVisible(element) {
  // 檢查元素是否存在且已渲染
  if (!element || element.offsetWidth === 0 || element.offsetHeight === 0) return false;
  
  // 檢查元素是否在視口內（可選，視需求而定）
  const rect = element.getBoundingClientRect();
  return (
    rect.top >= 0 &&
    rect.left >= 0 &&
    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
  );
}

// 專門處理列表跑馬燈的函數
function handleListMarquees() {
  const listMarquees = document.querySelectorAll('.list-marquee');
  
  listMarquees.forEach(marquee => {
    if (!isElementVisible(marquee)) return;
    
    // 獲取原始文本（第一段）
    const originalText = marquee.textContent.split('　')[0] || marquee.textContent;
    const textLength = originalText.length;
    
    // 優化列表項動畫速度
    let duration = textLength * CHARACTER_SCROLL_SPEED * 0.7;
    duration = Math.max(MIN_DURATION, Math.min(MAX_DURATION, duration));
    
    // 更新動畫設置
    marquee.style.setProperty('--scroll-duration', `${duration}s`);
    
    // 重置動畫
    marquee.classList.remove('scrolling');
    void marquee.offsetWidth;
    marquee.classList.add('scrolling');
  });
}
// 新增函數：滾動到編輯區域
function scrollToEditingArea() {
  setTimeout(() => {
    const editingArea = document.getElementById("busInputContainer");
    if (editingArea && !editingArea.classList.contains("hidden")) {
      editingArea.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }, 100); // 短暫延遲，確保DOM已更新
}
// 添加等下編輯功能
function postponeEditing() {
  // 隱藏編輯區域但不刪除編輯中的車輛
  document.getElementById("busInputContainer").classList.add("hidden");
  
  // 滾動到頁面頂部
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
  
  // 可選：顯示一個簡短的提示
  // showFloatingNotification("已暫時隱藏編輯區，可從標籤重新開啟", "info");
}

// 滑動設置函數 - 重構為獨立函數，每次更新界面時調用
function setupSwipeFeature(container, navBar, totalCategoryPages) {
  pagesContainer = container;
  categoryNav = navBar;
  totalPages = totalCategoryPages;
  currentSwipePage = 0; // 重置為第一頁
  
  if (!pagesContainer || !categoryNav) return;
  
  // 應用初始頁面設置
  updateSwipePageDisplay(0);
  
  // 清除舊事件監聽器
  let newContainer = pagesContainer.cloneNode(true);
  pagesContainer.parentNode.replaceChild(newContainer, pagesContainer);
  pagesContainer = newContainer;
  
  // 設置新的事件處理
  let startX, startY;
  let isScrollingVertical = false;
  
  pagesContainer.addEventListener('touchstart', function(e) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isScrollingVertical = false;
    
    // 設置過渡為無，確保觸摸時響應迅速
    pagesContainer.style.transition = 'none';
  }, { passive: true });
  
  pagesContainer.addEventListener('touchmove', function(e) {
    if (!startX) return;
      // 檢查是否點擊在項目元素上
  if (e.target.closest('.quick-other-item')) {
    return; // 不處理在項目上的滑動
  }
      // 如果滑動距離夠大，立即標記為滑動中
  if (Math.abs(diffX) > 5) {
    window.isSwiping = true;
  }

    const currentX = e.touches[0].clientX;
    const currentY = e.touches[0].clientY;
    const diffX = startX - currentX;
    const diffY = startY - currentY;
    
    // 判斷是否垂直滾動
    if (!isScrollingVertical && Math.abs(diffY) > Math.abs(diffX) * 1.2) {
      isScrollingVertical = true;
      return;
    }
    
    // 如果是垂直滾動，不處理水平滑動
    if (isScrollingVertical) return;
    
    // 防止事件冒泡，確保滑動時頁面不會跟著滾動
    e.preventDefault();
    
    // 計算偏移量
    const pageWidth = pagesContainer.offsetWidth;
    const movePercent = (diffX / pageWidth) * 100;
    const currentOffset = -currentSwipePage * 100;
    const newOffset = currentOffset - movePercent;
    
    // 應用新的位置，添加阻尼效果
    let finalOffset = newOffset;
    if (newOffset > 0) {
      finalOffset = newOffset * 0.3; // 左端阻尼
    } else if (newOffset < -(totalPages - 1) * 100) {
      const overScroll = newOffset + (totalPages - 1) * 100;
      finalOffset = -(totalPages - 1) * 100 + overScroll * 0.3; // 右端阻尼
    }
    
    pagesContainer.style.transform = `translateX(${finalOffset}%)`;
  }, { passive: false });
  
  pagesContainer.addEventListener('touchend', function(e) {
    if (!startX || isScrollingVertical) {
      startX = null;
      startY = null;
      return;
    }
    
    const currentX = e.changedTouches[0].clientX;
    const diffX = startX - currentX;
    const pageWidth = pagesContainer.offsetWidth;
    
    // 重置起始點
    startX = null;
    startY = null;
    
    // 恢復過渡效果
    pagesContainer.style.transition = 'transform 0.3s ease';
    
    // 判斷是否需要翻頁
    if (Math.abs(diffX) > pageWidth * 0.15) { // 只需15%的滑動距離
      if (diffX > 0 && currentSwipePage < totalPages - 1) {
        // 向左滑動 -> 下一頁
        updateSwipePageDisplay(currentSwipePage + 1);
      } else if (diffX < 0 && currentSwipePage > 0) {
        // 向右滑動 -> 上一頁
        updateSwipePageDisplay(currentSwipePage - 1);
      } else {
        // 邊界情況：回到當前頁
        updateSwipePageDisplay(currentSwipePage);
      }
    } else {
      // 滑動不夠遠，回到當前頁
      updateSwipePageDisplay(currentSwipePage);
    }
    setTimeout(() => {
  window.isSwiping = false;
}, 100);
  }, { passive: true });
  
  // 設置分類標籤點擊事件
  const tabs = categoryNav.querySelectorAll('.category-tab');
  tabs.forEach((tab, index) => {
    // 移除舊事件處理程序
    let newTab = tab.cloneNode(true);
    tab.parentNode.replaceChild(newTab, tab);
    
    // 添加新的事件處理
    newTab.addEventListener('click', function() {
      updateSwipePageDisplay(index);
    });
  });
}

// 更新滑動頁面顯示
function updateSwipePageDisplay(pageIndex) {
  if (pageIndex < 0 || pageIndex >= totalPages || !pagesContainer || !categoryNav) return;
  
  // 更新當前頁碼
  currentSwipePage = pageIndex;
  
  // 更新分類標籤選中狀態
  const tabs = categoryNav.querySelectorAll('.category-tab');
  tabs.forEach((tab, idx) => {
    if (idx === pageIndex) {
      tab.classList.add('active');
      tab.style.backgroundColor = '#06c755';
      tab.style.color = 'white';
    } else {
      tab.classList.remove('active');
      tab.style.backgroundColor = '#f8f9fa';
      tab.style.color = '#333';
    }
  });
  
  // 平滑滑動到對應頁面
  pagesContainer.style.transition = 'transform 0.3s ease';
  pagesContainer.style.transform = `translateX(-${pageIndex * 100}%)`;
}

// 首先，添加一個輔助函數用於檢查和記錄選項分類情況
function logItemClassification(itemName, foundItem) {
  if (!foundItem) {
    console.log(`項目 "${itemName}" 在 otherItems 中未找到，無法確定類型`);
    return null;
  }
  
  // 明確輸出itemType值，確保檢查值的問題
  console.log(`項目: "${itemName}", itemType值: ${foundItem.itemType} (${typeof foundItem.itemType})`);
  
  // 嘗試強制轉換為數字，以防是字符串格式
  const itemTypeAsNumber = Number(foundItem.itemType);
  
  if (itemTypeAsNumber === 1) {
    return "positive";
  } else if (itemTypeAsNumber === -1) {
    return "negative";
  } else {
    console.log(`項目 "${itemName}" 的 itemType 值 ${foundItem.itemType} 不是 1 或 -1`);
    return null;
  }
}
    </script>
</html>
