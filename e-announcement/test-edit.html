<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç·¨è¼¯åŠŸèƒ½æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 10px 0;
      }
      button {
        padding: 8px 15px;
        margin: 5px;
      }
      .result {
        background: #f5f5f5;
        padding: 10px;
        margin: 5px 0;
      }
      pre {
        background: #f0f0f0;
        padding: 10px;
        overflow-x: auto;
      }
      .form-field {
        margin: 10px 0;
      }
      label {
        display: inline-block;
        width: 120px;
      }
      input,
      select,
      textarea {
        width: 300px;
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <h1>ç·¨è¼¯åŠŸèƒ½æ¸¬è©¦</h1>

    <div class="test-section">
      <h3>1. å‰µå»ºæ¸¬è©¦è³‡æ–™</h3>
      <button onclick="createTestData()">å‰µå»ºæ¸¬è©¦å®£å°å°ˆæ¡ˆ</button>
      <div id="createResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>2. æ¸¬è©¦ç·¨è¼¯åŠŸèƒ½</h3>
      <input
        type="text"
        id="testId"
        placeholder="è¼¸å…¥å°ˆæ¡ˆ ID"
        style="width: 100px"
      />
      <button onclick="testEditFunction()">æ¸¬è©¦ç·¨è¼¯</button>
      <div id="editResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>3. æ‰‹å‹•è¡¨å–®æ¸¬è©¦</h3>
      <div class="form-field">
        <label>æ¨™é¡Œ:</label>
        <input type="text" id="title" />
      </div>
      <div class="form-field">
        <label>æ–‡ä»¶é¡å‹:</label>
        <select id="documentType">
          <option value="">è«‹é¸æ“‡</option>
          <option value="å…¬å‘Š">å…¬å‘Š</option>
          <option value="é€šçŸ¥">é€šçŸ¥</option>
        </select>
      </div>
      <div class="form-field">
        <label>ç™¼ä½ˆå–®ä½:</label>
        <select id="publishUnit">
          <option value="">è«‹é¸æ“‡</option>
          <option value="è³‡è¨Šä¸­å¿ƒ">è³‡è¨Šä¸­å¿ƒ</option>
          <option value="å…¶å®ƒ">å…¶å®ƒ</option>
        </select>
      </div>
      <div class="form-field" id="customPublishUnitDiv" style="display: none">
        <label>è‡ªè¨‚ç™¼ä½ˆå–®ä½:</label>
        <input type="text" id="customPublishUnit" />
      </div>
      <div class="form-field">
        <label>ç™¼ä½ˆæ—¥æœŸ:</label>
        <input type="date" id="publishDate" />
      </div>
      <div class="form-field">
        <label>ç›®æ¨™å…¬å¸:</label>
        <input type="text" id="targetCompany" />
      </div>
      <button onclick="testFormPopulation()">æ¸¬è©¦è¡¨å–®å¡«å…¥</button>
    </div>

    <script>
      // API åŸºç¤è·¯å¾‘è¨­å®š
      const API_BASE = (() => {
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°é–‹ç™¼ç’°å¢ƒ
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return window.location.origin + "/api"
        }
        // ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨æŒ‡å®šçš„å¾Œç«¯åœ°å€
        return "https://35.221.146.143.nip.io/linehook"
      })()

      // ç›£è½ç™¼ä½ˆå–®ä½è®Šæ›´
      document
        .getElementById("publishUnit")
        .addEventListener("change", function () {
          const customDiv = document.getElementById("customPublishUnitDiv")
          if (this.value === "å…¶å®ƒ") {
            customDiv.style.display = "block"
          } else {
            customDiv.style.display = "none"
          }
        })

      // å‰µå»ºæ¸¬è©¦è³‡æ–™
      async function createTestData() {
        const testData = {
          title: "æ¸¬è©¦ç·¨è¼¯å°ˆæ¡ˆ " + new Date().getTime(),
          documentType: "å…¬å‘Š",
          publishUnit: "å…¶å®ƒ",
          customPublishUnit: "æ¸¬è©¦è‡ªè¨‚å–®ä½",
          targetCompany: "æ¸¬è©¦å…¬å¸",
          targetDepartments: ["ITéƒ¨é–€", "è¡Œæ”¿éƒ¨é–€"],
          publishDate: "2024-11-05 10:00",
          contentBlocks: [
            {
              type: "text",
              content: "é€™æ˜¯æ¸¬è©¦å…§å®¹ï¼Œç”¨ä¾†é©—è­‰ç·¨è¼¯åŠŸèƒ½ã€‚",
              order: 1,
            },
          ],
        }

        try {
          const response = await fetch(`${API_BASE}/EAnnouncement`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(testData),
          })

          const result = await response.json()
          console.log("å‰µå»ºçµæœ:", result)

          if (result.success) {
            document.getElementById("createResult").innerHTML = `
                        <strong>âœ… æ¸¬è©¦è³‡æ–™å‰µå»ºæˆåŠŸï¼</strong><br>
                        <strong>å°ˆæ¡ˆ ID:</strong> ${result.data.id}<br>
                        <input type="text" value="${
                          result.data.id
                        }" onclick="this.select()" readonly style="width: 80px;">
                        <button onclick="document.getElementById('testId').value='${
                          result.data.id
                        }'">ä½¿ç”¨æ­¤ ID æ¸¬è©¦</button>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    `
          } else {
            document.getElementById("createResult").innerHTML = `
                        <strong>âŒ å‰µå»ºå¤±æ•—:</strong> ${result.message}
                    `
          }
        } catch (error) {
          console.error("å‰µå»ºéŒ¯èª¤:", error)
          document.getElementById("createResult").innerHTML = `
                    <strong>âŒ å‰µå»ºéŒ¯èª¤:</strong> ${error.message}
                `
        }
      }

      // æ¸¬è©¦ç·¨è¼¯åŠŸèƒ½
      async function testEditFunction() {
        const id = document.getElementById("testId").value
        if (!id) {
          alert("è«‹è¼¸å…¥å°ˆæ¡ˆ ID")
          return
        }

        console.log("ğŸ” é–‹å§‹æ¸¬è©¦ç·¨è¼¯åŠŸèƒ½ï¼ŒID:", id)

        try {
          // 1. å…ˆç²å–è³‡æ–™
          const response = await fetch(`${API_BASE}/EAnnouncement/${id}`)
          const result = await response.json()

          console.log("ğŸ“¡ API å›æ‡‰:", result)

          if (result.success) {
            // 2. æ¸¬è©¦è¡¨å–®å¡«å…¥
            populateFormWithData(result.data)

            document.getElementById("editResult").innerHTML = `
                        <strong>âœ… ç·¨è¼¯æ¸¬è©¦æˆåŠŸï¼</strong><br>
                        è«‹æª¢æŸ¥ä¸‹æ–¹è¡¨å–®æ˜¯å¦æ­£ç¢ºå¡«å…¥è³‡æ–™ã€‚<br>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    `
          } else {
            document.getElementById("editResult").innerHTML = `
                        <strong>âŒ ç²å–è³‡æ–™å¤±æ•—:</strong> ${result.message}
                    `
          }
        } catch (error) {
          console.error("ç·¨è¼¯éŒ¯èª¤:", error)
          document.getElementById("editResult").innerHTML = `
                    <strong>âŒ ç·¨è¼¯éŒ¯èª¤:</strong> ${error.message}
                `
        }
      }

      // å¡«å…¥è¡¨å–®è³‡æ–™ï¼ˆç°¡åŒ–ç‰ˆï¼‰
      function populateFormWithData(data) {
        console.log("ğŸ¯ é–‹å§‹å¡«å…¥è¡¨å–®è³‡æ–™:", data)

        // åŸºæœ¬æ¬„ä½
        document.getElementById("title").value = data.title || ""
        document.getElementById("documentType").value = data.documentType || ""
        document.getElementById("publishUnit").value = data.publishUnit || ""
        document.getElementById("targetCompany").value =
          data.targetCompany || ""

        console.log("ğŸ“ åŸºæœ¬æ¬„ä½å·²å¡«å…¥")

        // è™•ç†æ—¥æœŸ
        let publishDate = ""
        if (data.publishDate) {
          if (data.publishDate.includes("T")) {
            publishDate = data.publishDate.split("T")[0]
          } else if (data.publishDate.includes(" ")) {
            publishDate = data.publishDate.split(" ")[0]
          } else {
            publishDate = data.publishDate
          }
        }
        document.getElementById("publishDate").value = publishDate
        console.log("ğŸ“… æ—¥æœŸå·²å¡«å…¥:", publishDate)

        // è™•ç†è‡ªè¨‚ç™¼ä½ˆå–®ä½
        if (data.publishUnit === "å…¶å®ƒ") {
          document.getElementById("customPublishUnit").value =
            data.customPublishUnit || ""
          document.getElementById("customPublishUnitDiv").style.display =
            "block"
          console.log("ğŸ”§ è‡ªè¨‚ç™¼ä½ˆå–®ä½å·²é¡¯ç¤º:", data.customPublishUnit)
        } else {
          document.getElementById("customPublishUnit").value = ""
          document.getElementById("customPublishUnitDiv").style.display = "none"
          console.log("ğŸ”§ è‡ªè¨‚ç™¼ä½ˆå–®ä½å·²éš±è—")
        }

        console.log("âœ… è¡¨å–®å¡«å…¥å®Œæˆ")
      }

      // æ¸¬è©¦è¡¨å–®å¡«å…¥
      function testFormPopulation() {
        const testData = {
          title: "æ¸¬è©¦æ¨™é¡Œ",
          documentType: "å…¬å‘Š",
          publishUnit: "å…¶å®ƒ",
          customPublishUnit: "æ¸¬è©¦è‡ªè¨‚å–®ä½",
          targetCompany: "æ¸¬è©¦å…¬å¸",
          publishDate: "2024-11-05T10:00:00",
        }

        populateFormWithData(testData)
        console.log("æ‰‹å‹•æ¸¬è©¦è³‡æ–™å·²å¡«å…¥")
      }
    </script>
  </body>
</html>
