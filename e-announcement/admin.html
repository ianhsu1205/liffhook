<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E宣導管理系統</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .signature-preview {
        max-width: 300px;
        max-height: 150px;
        border: 1px solid #ddd;
        margin: 10px 0;
      }
      .content-block {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
        position: relative;
      }
      .content-block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .content-block-header .btn-group {
        display: flex;
        gap: 2px;
      }
      .image-upload-container {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background-color: #fff;
      }
      .image-preview img {
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-outline-danger:hover {
        color: #fff;
      }
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
      .content-block:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.2s ease;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
          <a class="navbar-brand" href="#">
            <i class="fas fa-bullhorn me-2"></i>E宣導管理系統
          </a>
          <div class="navbar-nav ms-auto">
            <button class="btn btn-outline-light" onclick="logout()">
              <i class="fas fa-sign-out-alt me-1"></i>登出
            </button>
          </div>
        </div>
      </nav>

      <div class="container">
        <!-- 功能選單 -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-primary active"
                onclick="showView('list')"
              >
                <i class="fas fa-list me-1"></i>宣導專案列表
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="showView('create')"
              >
                <i class="fas fa-plus me-1"></i>新增宣導專案
              </button>
            </div>
          </div>
        </div>

        <!-- 宣導專案列表 -->
        <div id="listView" class="view-content">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0"><i class="fas fa-list me-2"></i>宣導專案列表</h5>
              <div class="d-flex gap-2">
                <select
                  class="form-select form-select-sm"
                  id="companyFilter"
                  style="width: auto"
                >
                  <option value="">所有公司</option>
                </select>
                <button
                  class="btn btn-sm btn-outline-secondary"
                  onclick="loadAnnouncements()"
                >
                  <i class="fas fa-refresh"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div id="announcementsList">
                <!-- 動態載入內容 -->
              </div>

              <!-- 分頁 -->
              <nav
                aria-label="分頁導航"
                id="paginationNav"
                style="display: none"
              >
                <ul
                  class="pagination justify-content-center"
                  id="pagination"
                ></ul>
              </nav>
            </div>
          </div>
        </div>

        <!-- 新增/編輯宣導專案 -->
        <div id="createView" class="view-content" style="display: none">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-plus me-2"></i
                ><span id="formTitle">新增宣導專案</span>
              </h5>
            </div>
            <div class="card-body">
              <form id="announcementForm">
                <input type="hidden" id="announcementId" />

                <div class="row mb-3">
                  <div class="col-md-8">
                    <label for="title" class="form-label">標題 *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="title"
                      required
                    />
                  </div>
                  <div class="col-md-4">
                    <label for="publishDate" class="form-label"
                      >發佈日期 *</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="publishDate"
                      required
                    />
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="documentType" class="form-label"
                      >文件類型 *</label
                    >
                    <select class="form-select" id="documentType" required>
                      <option value="">請選擇</option>
                      <option value="公告">公告</option>
                      <option value="案例宣導">案例宣導</option>
                      <option value="資安宣導">資安宣導</option>
                      <option value="其它參考">其它參考</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="publishUnit" class="form-label"
                      >發佈單位 *</label
                    >
                    <select class="form-select" id="publishUnit" required>
                      <option value="">請選擇</option>
                      <option value="董事長室">董事長室</option>
                      <option value="總經理室">總經理室</option>
                      <option value="人力資源部">人力資源部</option>
                      <option value="業務部">業務部</option>
                      <option value="總務部">總務部</option>
                      <option value="機務部">機務部</option>
                      <option value="資訊中心">資訊中心</option>
                      <option value="其它">其它</option>
                    </select>
                  </div>
                  <div
                    class="col-md-4"
                    id="customPublishUnitDiv"
                    style="display: none"
                  >
                    <label for="customPublishUnit" class="form-label"
                      >自訂發佈單位</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="customPublishUnit"
                    />
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="targetCompany" class="form-label"
                      >目標公司 *</label
                    >
                    <select class="form-select" id="targetCompany" required>
                      <option value="">請選擇公司</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="targetDepartments" class="form-label"
                      >目標部門 *</label
                    >
                    <div
                      id="departmentCheckboxes"
                      class="border rounded p-2"
                      style="max-height: 200px; overflow-y: auto"
                    >
                      <!-- 動態生成部門選項 -->
                    </div>
                  </div>
                </div>

                <!-- 內容區塊 -->
                <div class="mb-3">
                  <label class="form-label">宣導內容 *</label>
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <span class="text-muted">可新增多個內容區塊</span>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      onclick="addContentBlock()"
                    >
                      <i class="fas fa-plus me-1"></i>新增內容區塊
                    </button>
                  </div>
                  <div id="contentBlocks">
                    <!-- 動態生成內容區塊 -->
                  </div>
                </div>

                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>儲存
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="showView('list')"
                  >
                    <i class="fas fa-times me-1"></i>取消
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 預覽 Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-eye me-2"></i>宣導專案預覽
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="previewContent">
              <!-- 動態載入預覽內容 -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              關閉
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="openSignaturePage()"
            >
              <i class="fas fa-signature me-1"></i>開啟簽名頁面
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 刪除確認 Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">確認刪除</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>確定要刪除此宣導專案嗎？</p>
            <p class="text-danger small">注意：已有簽名記錄的專案無法刪除</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              確認刪除
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 成功/錯誤訊息 Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="alertToast" class="toast" role="alert">
        <div class="toast-header">
          <strong class="me-auto" id="toastTitle">通知</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
          ></button>
        </div>
        <div class="toast-body" id="toastBody">
          <!-- 動態內容 -->
        </div>
      </div>
    </div>

    <!-- 簽名 Modal -->
    <div
      class="modal fade"
      id="signatureModal"
      tabindex="-1"
      aria-labelledby="signatureModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="signatureModalLabel">
              <i class="fas fa-pen me-2"></i>電子簽名
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <p class="text-muted">請在下方區域內簽名</p>
            </div>
            <div class="signature-pad-container text-center">
              <canvas
                id="signaturePad"
                style="
                  border: 2px solid #dee2e6;
                  border-radius: 8px;
                  background-color: white;
                  cursor: crosshair;
                  max-width: 100%;
                  height: auto;
                "
              ></canvas>
            </div>
            <div class="mt-3 text-center">
              <small class="text-muted">支援滑鼠拖曳或觸控簽名</small>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              onclick="clearSignature()"
            >
              <i class="fas fa-eraser me-1"></i>清除
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-1"></i>取消
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveSignature()"
            >
              <i class="fas fa-check me-1"></i>確認簽名
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 測試發佈 Modal -->
    <div
      class="modal fade"
      id="testPublishModal"
      tabindex="-1"
      aria-labelledby="testPublishModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="testPublishModalLabel">
              <i class="fas fa-flask me-2"></i>測試發佈
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              測試發佈會忽略公司和部門設定，直接發送給指定的員工編號
            </div>
            <div class="mb-3">
              <label for="testEmployeeIds" class="form-label"
                >員工編號 <span class="text-danger">*</span></label
              >
              <textarea
                class="form-control"
                id="testEmployeeIds"
                rows="4"
                placeholder="請輸入員工編號，每行一個或用逗號分隔&#10;例如：&#10;E001&#10;E002&#10;E003&#10;或：E001,E002,E003"
              ></textarea>
              <div class="form-text">支援每行一個員工編號或用逗號分隔</div>
            </div>
            <div class="mb-3">
              <label class="form-label">預覽發佈清單</label>
              <div
                id="testPublishPreview"
                class="border rounded p-2 bg-light text-muted"
              >
                請輸入員工編號...
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-1"></i>取消
            </button>
            <button
              type="button"
              class="btn btn-warning"
              onclick="executeTestPublish()"
              id="testPublishBtn"
              disabled
            >
              <i class="fas fa-paper-plane me-1"></i>測試發佈
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="admin.js"></script>
  </body>
</html>
