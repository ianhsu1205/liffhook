<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trip Management Mobile</title>
    <style>
      :root {
        --text: #222;
        --muted: #666;
        --border: #e5e7eb;
        --primary: #2563eb;
        --ok: #10b981;
        --bg: #f9fafb;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
        line-height: 1.4;
      }
      .header {
        position: sticky;
        top: 0;
        background: #fff;
        border-bottom: 1px solid var(--border);
        z-index: 5;
      }
      .tabs {
        position: sticky;
        top: 48px;
        background: #fff;
        border-bottom: 1px solid var(--border);
        z-index: 5;
        display: flex;
        gap: 8px;
        padding: 8px 12px;
      }
      .view {
        padding: 10px 12px;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .gap-8 {
        gap: 8px;
      }
      .title {
        font-weight: 600;
        font-size: 16px;
      }
      .sub {
        color: var(--muted);
        font-size: 12px;
      }

      /* buttons */
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn.sm {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 6px;
      }
      .btn.primary {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      .btn.ghost {
        background: #fff;
        color: var(--text);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .tabs .btn {
        flex: 1 1 50%;
        text-align: center;
      }
      .tabs .btn.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      /* Bigger tabs buttons */
      .tabs .btn,
      .tabs .btn.sm {
        padding: 12px 14px;
        font-size: 15px;
        border-radius: 10px;
      }

      /* cards */
      .card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        background: #fff;
        margin: 10px 0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .card.full {
        border-color: #fecaca;
        background: #fff1f2;
      }
      .card.completed {
        position: relative;
        opacity: 0.95;
      }
      .card.completed::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 10px;
        pointer-events: none;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) inset;
      }
      .route-title {
        font-size: 14px;
        margin-bottom: 4px;
      }
      .vehicle-line {
        font-size: 14px;
        margin: 2px 0 6px;
      }
      .time-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 6px;
        background: #eef2ff;
        color: #1e3a8a;
        font-weight: 600;
      }

      /* chips */
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
        align-items: center;
      }
      /* Pending selection styles */
      .pending-toolbar {
        position: sticky;
        top: 96px; /* below header + tabs */
        z-index: 4;
        background: #fff;
        border-bottom: 1px solid var(--border);
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pending-toolbar .spacer {
        flex: 1 1 auto;
      }
      .pending-selected-count {
        font-size: 12px;
        color: var(--muted);
      }
      .pending-card.selected {
        outline: 2px solid rgba(37, 99, 235, 0.35);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15) inset;
      }
      .pending-select-box {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #f3f4f6;
        color: #374151;
        border: 1px solid var(--border);
      }
      .chip.ok {
        background: #ecfdf5;
        color: #065f46;
        border-color: #a7f3d0;
      }
      .chip.warn {
        background: #fffbeb;
        color: #92400e;
        border-color: #fde68a;
      }
      .chip.bad {
        background: #fef2f2;
        color: #991b1b;
        border-color: #fecaca;
      }

      /* route badges */
      .route-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        color: #fff;
        font-weight: 700;
        font-size: 12px;
      }
      .route-208802 {
        background: #007bff;
      }
      .route-2088A2 {
        background: #28a745;
      }
      .route-2088B2 {
        background: #fd7e14;
      }
      .route-default {
        background: #6b7280;
      }

      /* route chips picker */
      .pill {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        cursor: pointer;
        background: #fff;
        position: relative;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .pill.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35);
        transform: scale(1.05);
      }
      .pill.active::after {
        content: "✓";
        position: absolute;
        top: -6px;
        right: -6px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #10b981;
        color: #fff;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
      }
      /* Route-colored chips for route picker */
      .pill.route-208802 {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
      }
      .pill.route-2088A2 {
        background: #28a745;
        color: #fff;
        border-color: #28a745;
      }
      .pill.route-2088B2 {
        background: #fd7e14;
        color: #fff;
        border-color: #fd7e14;
      }
      .pill.route-default {
        background: #6b7280;
        color: #fff;
        border-color: #6b7280;
      }

      /* toast */
      .toast {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s, transform 0.2s;
        z-index: 1000;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* bottom bar */
      .bottom {
        background: #fff;
        border-top: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px 12px;
        position: sticky;
        bottom: 0;
      }
      .bottom .btn {
        flex: 0 1 auto;
      }

      /* modals */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        align-items: center;
        justify-content: center;
      }
      .modal .sheet {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-radius: 12px;
        background: #fff;
        width: 100%;
        max-width: 560px;
        padding: 12px;
      }
      /* Larger inputs in Trip modal */
      .modal .sheet .field label {
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
        color: #333;
      }
      .modal .sheet input[type="text"],
      .modal .sheet input[type="number"],
      .modal .sheet input[type="time"] {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .modal .sheet input:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.25);
      }
      /* Time input live validation */
      .modal .sheet input.invalid {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
      }
      .error {
        color: #b91c1c;
        font-size: 12px;
        margin-top: 4px;
      }

      /* Larger/green button variants */
      .btn.lg {
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 8px;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #10b981;
      }
      .btn.info {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
      }
      .btn.warning {
        background: #f59e0b;
        color: #fff;
        border-color: #f59e0b;
      }
      .btn.danger {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
      }

      /* suggestions dropdown */
      .field {
        position: relative;
      }
      .dropdown {
        width: 100%;
      }
      .sugg-item {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
      }
      .sugg-item:hover {
        background: #f3f4f6;
      }
    </style>
  </head>
  <body>
    <audio id="notifySound" src="audio/2456.wav" preload="auto"></audio>
    <div id="toast" class="toast"></div>
    <div id="print-content" style="display: none"></div>

    <!-- Header -->
    <div
      class="header"
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
      "
    >
      <div style="font-weight: 600">保留座位管理</div>
      <div id="today" class="sub" style="opacity: 0.8"></div>
      <button id="btnCreate" class="btn sm primary">新增趟次</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tabPending" class="btn sm">待排</button>
      <button id="tabTrips" class="btn sm">趟次</button>
    </div>

    <!-- Views -->
    <div id="pendingView" class="view" style="padding: 0 0 8px">
      <div class="pending-toolbar" id="pendingToolbar" style="display: none">
        <button id="btnSelectAllPendingMobile" class="btn sm">全選</button>
        <button id="btnClearAllPendingMobile" class="btn sm ghost">
          取消全選
        </button>
        <div class="spacer"></div>
        <span class="pending-selected-count"
          >已選 <span id="pendingSelectedCountMobile">0</span> 筆</span
        >
        <button id="btnSendDelayedMobile" class="btn sm warning" disabled>
          傳送久候通知
        </button>
      </div>
      <div id="pendingListHost" style="padding: 8px 12px"></div>
    </div>
    <div
      id="tripsView"
      class="view"
      style="padding: 8px 12px; display: none"
    ></div>

    <!-- Bottom bar -->
    <div
      class="bottom"
      style="
        position: sticky;
        bottom: 0;
        background: #fff;
        border-top: 1px solid #eee;
      "
    >
      <div class="row" style="gap: 8px">
        <button id="btnRefresh" class="btn primary" style="flex: 1 1 50%">
          重新整理
        </button>
        <button id="btnToggleCompleted" class="btn ghost" style="flex: 1 1 50%">
          顯示已發車：關
        </button>
      </div>
      <!-- 模擬列印區 (重新啟用) -->
      <div
        id="simulatePrintMobilePanel"
        class="row"
        style="display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap"
      >
        <input
          id="simulatePrintCountMobile"
          type="number"
          min="1"
          max="300"
          placeholder="乘客筆數 (<=300)"
          style="width: 110px"
        />
        <div class="row" style="gap: 4px; flex-wrap: wrap">
          <button class="btn sm ghost quick-sim" data-count="30">30</button>
          <button class="btn sm ghost quick-sim" data-count="60">60</button>
          <button class="btn sm ghost quick-sim" data-count="100">100</button>
          <button class="btn sm ghost quick-sim" data-count="150">150</button>
        </div>
        <button
          id="btnSimulatePrintMobile"
          class="btn sm primary"
          title="依輸入筆數生成假資料並列印票據"
        >
          模擬列印
        </button>
        <span class="sub" style="font-size: 11px">(壓力測試)</span>
      </div>
      <div
        class="sub"
        style="text-align: center; font-size: 11px; color: var(--muted)"
      >
        v1.0.0.18
      </div>
    </div>

    <!-- Assign Modal -->
    <div id="assignModal" class="modal" style="display: none">
      <div class="sheet">
        <div
          class="row"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <div class="title" style="font-weight: 600">指派到趟次</div>
          <button class="btn sm ghost" data-action="close-assign">關閉</button>
        </div>
        <div id="assignList"></div>
      </div>
    </div>

    <!-- Trip Modal -->
    <div id="tripModal" class="modal" style="display: none">
      <div class="sheet">
        <div
          class="row"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <div id="tripModalTitle" class="title" style="font-weight: 600">
            趟次
          </div>
          <button class="btn sm ghost" data-action="close-trip">關閉</button>
        </div>
        <input type="hidden" id="editingTripId" />
        <div
          id="routeList"
          class="chips"
          style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px"
        ></div>
        <div class="field" style="margin-bottom: 8px">
          <label>車號</label>
          <input
            id="vehicleInput"
            type="text"
            placeholder="例如 ABC-123"
            style="width: 100%"
          />
          <div
            id="vehicleSugg"
            class="dropdown"
            style="
              display: none;
              position: absolute;
              z-index: 10;
              background: #fff;
              border: 1px solid #ddd;
              border-radius: 6px;
              max-height: 180px;
              overflow: auto;
            "
          ></div>
        </div>
        <div class="field" style="margin-bottom: 8px">
          <label>發車時間 (HH:mm)</label>
          <input
            id="timeInput"
            type="text"
            inputmode="numeric"
            maxlength="5"
            placeholder="08:30"
            style="width: 100%"
          />
          <div id="timeError" class="error" style="display: none">
            時間需為 00:00 - 23:59
          </div>
        </div>
        <div class="field" style="margin-bottom: 12px">
          <label>保留座位數</label>
          <input
            id="keepCountInput"
            type="number"
            min="0"
            max="40"
            step="1"
            style="width: 100%"
          />
        </div>
        <div
          class="row"
          style="display: flex; gap: 8px; justify-content: flex-end"
        >
          <button class="btn ghost" data-action="close-trip">取消</button>
          <button id="btnSaveTrip" class="btn primary" data-action="save-trip">
            儲存
          </button>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL = "https://35.221.146.143.nip.io/linehook"
      //const BASE_URL = "http://localhost:5000/api"
      let showCompleted = false
      let trips = []
      let pending = []
      let selectedPassenger = null
      let routes = []
      let vehicleData = []
      let selectedRoute = ""
      let autoTimer = null
      // pending selection state (persist across renders)
      const pendingSelectedUserIds = window._pendingSelectedUserIds || new Set()
      window._pendingSelectedUserIds = pendingSelectedUserIds

      // UI helpers
      const $ = (sel) => document.querySelector(sel)
      function fmt(n) {
        return (n ?? "").toString().padStart(2, "0")
      }
      function toast(msg) {
        const t = $("#toast")
        t.textContent = msg
        t.classList.add("show")
        setTimeout(() => t.classList.remove("show"), 2200)
      }
      // 行動裝置震動與通知
      function vibrate(ms = 400) {
        try {
          if (navigator.vibrate) navigator.vibrate(ms)
        } catch {}
      }
      async function trySystemNotification(title, body) {
        try {
          if (!("Notification" in window)) return false
          if (Notification.permission === "granted") {
            new Notification(title, { body })
            return true
          }
          if (Notification.permission !== "denied") {
            const perm = await Notification.requestPermission()
            if (perm === "granted") {
              new Notification(title, { body })
              return true
            }
          }
        } catch {}
        return false
      }
      let lastPlay = 0
      async function playNotify() {
        try {
          const now = Date.now()
          if (now - lastPlay < 1200) return
          lastPlay = now
          const a = $("#notifySound")
          a.currentTime = 0
          await a.play()
        } catch {}
      }
      // 轉義：供舊 inline 用，仍保留但不再使用
      function escJsArg(v) {
        return String(v ?? "")
          .replace(/\\/g, "\\\\")
          .replace(/'/g, "\\'")
      }
      // 轉義：放入 HTML 屬性值
      function escAttr(v) {
        return String(v ?? "")
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
      }

      // 路線代碼對應 CSS 類別
      function routeToClass(r) {
        const v = String(r || "").toUpperCase()
        if (v === "208802") return "208802"
        if (v === "2088A2") return "2088A2"
        if (v === "2088B2") return "2088B2"
        return "default"
      }

      // 全域事件代理，取代所有 inline onclick
      document.addEventListener("click", (e) => {
        const el = e.target.closest("[data-action]")
        if (!el) return
        const action = el.getAttribute("data-action")
        switch (action) {
          case "edit-trip":
            openEditTrip(el.dataset.id)
            break
          case "confirm-trip":
            confirmDeparture(el.dataset.id)
            break
          case "mark-departed":
            markTripDeparted(el.dataset.id)
            break
          case "auto-assign-trip":
            autoAssignTrip(el.dataset.id)
            break
          case "view-pax":
            viewTripPassengers(el.dataset.id)
            break
          case "print-trip":
            printTrip(el.dataset.id)
            break
          case "delete-trip":
            deleteTrip(el.dataset.id)
            break
          case "open-assign":
            openAssign(
              el.dataset.id,
              parseInt(el.dataset.count || "1", 10) || 1
            )
            break
          case "assign-to-trip":
            assignToTrip(el.dataset.id)
            break
          case "select-route":
            selectRoute(el.dataset.id)
            break
          case "pick-vehicle":
            pickVehicle(el.dataset.value || "")
            break
          case "close-trip-pax":
            closeTripPassengersModal()
            break
          case "close-assign":
            closeAssignModal()
            break
          case "close-trip":
            closeTripModal()
            break
          case "save-trip":
            saveTrip()
            break
          case "show-pax-detail":
            openPassengerDetail(
              el.getAttribute("data-trip-id"),
              parseInt(el.getAttribute("data-idx") || "0", 10) || 0
            )
            break
          case "close-passenger-detail":
            closePassengerDetail()
            break
          case "remove-from-trip": {
            const pid = el.getAttribute("data-passenger-id")
            const tid = el.getAttribute("data-trip-id")
            const seats =
              parseInt(el.getAttribute("data-seat-count") || "1", 10) || 1
            removePassengerFromTrip(pid, tid, seats)
            break
          }
        }
      })

      // Tabs
      const _tabPending = $("#tabPending")
      if (_tabPending)
        _tabPending.addEventListener("click", () => switchTab("pending"))
      const _tabTrips = $("#tabTrips")
      if (_tabTrips)
        _tabTrips.addEventListener("click", () => switchTab("trips"))
      function switchTab(name) {
        const a = document.querySelectorAll(".tabs .btn")
        a.forEach((el) => el.classList.remove("active"))
        if (name === "pending")
          document.getElementById("tabPending")?.classList.add("active")
        if (name === "trips")
          document.getElementById("tabTrips")?.classList.add("active")
        document.getElementById("pendingView").style.display =
          name === "pending" ? "" : "none"
        document.getElementById("tripsView").style.display =
          name === "trips" ? "" : "none"
      }

      // Bottom bar
      const _btnRefresh = $("#btnRefresh")
      if (_btnRefresh) _btnRefresh.addEventListener("click", reloadAll)
      const _btnToggleCompleted = $("#btnToggleCompleted")
      if (_btnToggleCompleted)
        _btnToggleCompleted.addEventListener("click", async () => {
          showCompleted = !showCompleted
          $("#btnToggleCompleted").textContent = `顯示已發車：${
            showCompleted ? "開" : "關"
          }`
          await loadTrips()
          renderTrips()
        })

      // Date label
      function updateToday() {
        const host = document.querySelector("#today")
        if (!host) return
        const d = new Date()
        host.textContent = d.toLocaleDateString("zh-TW", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          weekday: "short",
        })
      }

      async function loadRoutes() {
        try {
          const res = await fetch(`${BASE_URL}/KeepStop`)
          const stops = await res.json()
          const routeMap = new Map()
          ;(stops || [])
            .filter((s) => s.openKeep)
            .forEach((s) => {
              if (!routeMap.has(s.subRouteId)) {
                routeMap.set(s.subRouteId, {
                  id: s.subRouteId,
                  operatorName: s.operatorName || "未知營運商",
                })
              }
            })
          routes = Array.from(routeMap.values())
          if (!selectedRoute && routes.length) selectedRoute = routes[0].id
          renderRouteChips()
        } catch {}
      }

      // 在趟次編輯/新增 Modal 內渲染路線籤
      function renderRouteChips() {
        const host = document.getElementById("routeList")
        if (!host) return
        const chips = (routes || [])
          .map((r) => {
            const id = r.id || r.Id || r.subRouteId || r.SubRouteId || ""
            const cls = "pill route-" + routeToClass(id)
            const active = String(id) === String(selectedRoute) ? " active" : ""
            const label = `${id}`
            return `<span class="${cls}${active}" role="button" aria-selected="${
              active ? "true" : "false"
            }" data-action="select-route" data-id="${escAttr(
              id
            )}">${label}</span>`
          })
          .join(" ")
        host.innerHTML = chips || '<span class="sub">無可用路線</span>'
      }
      function selectRoute(id) {
        selectedRoute = id
        renderRouteChips()
      }
      function openCreateTrip() {
        document.getElementById("editingTripId").value = ""
        document.getElementById("tripModalTitle").textContent = "新增趟次"
        if (!selectedRoute && routes.length)
          selectedRoute = routes[0].id || routes[0].Id || ""
        renderRouteChips()
        document.getElementById("vehicleInput").value = ""
        setTimeField("")
        document.getElementById("keepCountInput").value = 4
        document.getElementById("tripModal").style.display = "flex"
      }

      async function loadVehicleData() {
        try {
          const url = `${BASE_URL}/BusVehicle/for-trips?operatorName=${encodeURIComponent(
            "大都會客運"
          )}`
          const response = await fetch(url)
          const result = await response.json()
          vehicleData = result.success && result.data ? result.data : []
        } catch {
          vehicleData = []
        }
      }

      async function loadTrips() {
        const mode = showCompleted ? "completed" : "active"
        let url = `${BASE_URL}/Trip${mode ? `?status=${mode}` : ""}`
        try {
          let res = await fetch(url)
          if (!res.ok) res = await fetch(`${BASE_URL}/Trip`)
          const data = await res.json()
          if (data.success) {
            trips = Array.isArray(data.data) ? data.data : []
            if (mode === "completed")
              trips = trips.filter(
                (t) =>
                  (t.status || t.Status || "").toLowerCase() === "completed"
              )
            if (mode === "active")
              trips = trips.filter(
                (t) =>
                  (t.status || t.Status || "").toLowerCase() !== "completed"
              )
          } else {
            trips = []
          }
        } catch {
          trips = []
        }
      }

      async function loadPending() {
        try {
          const res = await fetch(`${BASE_URL}/Trip/pending-passengers`)
          const data = await res.json()
          if (data.success) {
            const before = pending.length
            pending = data.data || []
            if (pending.length > before) {
              toast("有新的預約進入待排！")
              playNotify()
              vibrate(400)
              trySystemNotification("新預約", "有乘客進入待排名單")
              refreshVisibleTripPassengers(true)
            }
            if (pending.length < before) {
              toast("有乘客取消預約，列表已更新")
              playNotify()
              vibrate(400)
              trySystemNotification("預約變更", "有乘客取消或被移除預約")
            }
          }
        } catch {}
      }

      // Trips view render
      function renderTrips() {
        const root = $("#tripsView")
        if (!Array.isArray(trips) || trips.length === 0) {
          root.innerHTML =
            '<div class="sub" style="text-align:center;padding:20px">目前沒有趟次</div>'
          return
        }
        root.innerHTML = (trips || [])
          .map((t) => {
            const s = (t.status || t.Status || "").toLowerCase()
            const statusChip =
              s === "completed"
                ? '<span class="chip ok" title="此趟次已發車，僅可列印">已發車</span>'
                : '<span class="chip" title="尚未發車，可編輯/指派/通知">未發車</span>'
            const assigned = t.assignedSeats ?? t.AssignedSeats ?? 0
            const cap = t.keepCount ?? t.KeepCount ?? 0
            const isFull = cap > 0 && assigned === cap
            const id = t.tripId || t.TripId
            const rid = t.route || t.Route || "-"
            const rcls = "route-" + routeToClass(rid)
            const seatChip = `<span class="chip ${
              isFull ? "bad" : "ok"
            }">${assigned}/${cap}</span>`
            const readOnly = s === "completed"
            return `
    <div class="card ${isFull ? "full" : ""} ${readOnly ? "completed" : ""}">
              <div class="row" style="justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
                <div class="row" style="gap:8px;flex-wrap:wrap">
                  <span class="route-badge ${rcls}">${rid}</span>
                  <span class="time-badge">${
                    t.departureTime || t.DepartureTime || "-"
                  }</span>
      ${statusChip}
      ${seatChip}
                </div>
                <div class="row gap-8" style="justify-content:flex-end;flex-wrap:wrap">
                  ${
                    !readOnly
                      ? `<button class=\"btn sm info\" data-action=\"auto-assign-trip\" data-id=\"${escAttr(
                          id
                        )}\">自動分配</button>`
                      : ""
                  }
                  ${
                    !readOnly
                      ? `<button class="btn sm warning" data-action="edit-trip" data-id="${escAttr(
                          id
                        )}">編輯</button>`
                      : ""
                  }
                  ${
                    !readOnly
                      ? `<button class="btn sm primary" data-action="confirm-trip" data-id="${escAttr(
                          id
                        )}">通知乘客</button>`
                      : ""
                  }
                    ${
                      !readOnly
                        ? `<button class="btn sm success" data-action="mark-departed" data-id="${escAttr(
                            id
                          )}">發車</button>`
                        : ""
                    }
                  ${
                    !readOnly
                      ? `<button class="btn sm ghost" data-action="view-pax" data-id="${escAttr(
                          id
                        )}">乘客</button>`
                      : ""
                  }
                  <button class="btn sm ghost" data-action="print-trip" data-id="${escAttr(
                    id
                  )}" title="列印清單">列印</button>
                  ${
                    !readOnly
                      ? `<button class="btn sm danger" data-action="delete-trip" data-id="${escAttr(
                          id
                        )}">刪除</button>`
                      : ""
                  }
                </div>
              </div>
              <div class="vehicle-line">車號：${
                t.vehicleNumber || t.VehicleNumber || "-"
              }</div>
              <div class="chips" id="pax-${id}"><span class="sub">載入中…</span></div>
            </div>`
          })
          .join("")
        ;(trips || []).forEach((t) => {
          const id = t.tripId || t.TripId
          const s = (t.status || t.Status || "").toLowerCase()
          const readOnly = s === "completed"
          ensurePassengers(id, readOnly)
        })
      }

      // 趟次內自動分配（FIFO），僅分配到指定趟次
      async function autoAssignTrip(tripId) {
        try {
          // 先刷新待排，確保使用最新資料
          await loadPending()
          const trip = (trips || []).find(
            (t) => String(t.tripId || t.TripId) === String(tripId)
          )
          if (!trip) {
            toast("找不到指定趟次")
            return
          }

          // 取得目前已佔用座位數（以實際乘客列表為準）
          let used = 0
          try {
            const list = await getTripPassengers(tripId)
            used = (list || []).reduce(
              (sum, p) => sum + (p.seatCount || p.SeatCount || 1),
              0
            )
          } catch {}
          const cap = trip.keepCount ?? trip.KeepCount ?? 0
          let remaining = Math.max(0, (cap || 0) - (used || 0))
          if (remaining <= 0) {
            toast("此趟次座位已滿，無法自動分配")
            return
          }

          // 以申請時間先後（FIFO）挑選待排乘客
          const candidates = (pending || [])
            .filter((p) => !(p.tripId || p.TripId))
            .sort((a, b) => {
              const ta = new Date(a.requestDateTime || 0).getTime() || 0
              const tb = new Date(b.requestDateTime || 0).getTime() || 0
              return ta - tb
            })

          if (!candidates.length) {
            toast("目前沒有待保留乘客可分配")
            return
          }

          const routeId = trip.route || trip.Route || ""
          let assignedSeats = 0

          for (const p of candidates) {
            if (remaining <= 0) break

            // 若提供 includeRoutes，就必須包含該趟次路線
            let canTake = true
            const inc = p.includeRoutes || p.IncludeRoutes || ""
            if (inc && String(inc).trim()) {
              const routesCsv = String(inc)
                .split(",")
                .map((r) => r.trim())
                .filter(Boolean)
              canTake = routesCsv.includes(routeId)
            }
            if (!canTake) continue

            const need = p.seatCount || p.SeatCount || 1
            if (need > remaining) continue

            const keepSeatId = p.id || p.Id || p.keepSeatId || p.KeepSeatId
            if (!keepSeatId) continue

            try {
              const res = await fetch(`${BASE_URL}/KeepSeat/assign-trip`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ keepSeatIds: [keepSeatId], tripId }),
              })
              if (!res.ok) {
                // 失敗則略過此乘客，繼續嘗試下一位
                continue
              }
              await res.json().catch(() => ({}))
              remaining -= need
              assignedSeats += need
            } catch {}
          }

          if (assignedSeats > 0) {
            toast(`自動分配完成，已指派 ${assignedSeats} 個座位到此趟次`)
            // 使該趟次乘客快取失效，並重載資料
            try {
              tripPassengersCache.delete(tripId)
            } catch {}
            await loadTrips()
            renderTrips()
            await loadPending()
            renderPending()
            try {
              await ensurePassengers(tripId)
            } catch {}
          } else {
            toast("沒有符合條件或座位的乘客可分配到此趟次")
          }
        } catch (e) {
          toast("自動分配失敗，請稍後再試")
        }
      }

      // Inline passengers chips (cached)
      const tripPassengersCache = window.tripPassengersCache || new Map()
      window.tripPassengersCache = tripPassengersCache
      async function ensurePassengers(tripId, readOnly = false, force = false) {
        const host = document.getElementById(`pax-${tripId}`)
        if (!host) return
        const cached = tripPassengersCache.get(tripId)
        const now = Date.now()
        if (!force && cached && now - cached.ts < 15000) {
          host.innerHTML = renderPaxChips(cached.list, tripId, readOnly)
          return
        }
        try {
          const list = await getTripPassengers(tripId)
          // 若新資料比快取少，代表有已排乘客被取消/移除 → 發出提示
          const prev = Array.isArray(cached?.list) ? cached.list : []
          if (prev.length > list.length) {
            playNotify()
            vibrate(400)
            trySystemNotification("預約移除", "已排乘客有取消或被移除")
          }
          tripPassengersCache.set(tripId, { list, ts: now })
          host.innerHTML = renderPaxChips(list, tripId, readOnly)
        } catch {
          host.innerHTML = '<span class="sub">讀取乘客失敗</span>'
        }
      }

      // 針對目前已載入的趟次，刷新乘客條列（可選擇是否強制忽略快取）
      function refreshVisibleTripPassengers(force = false) {
        try {
          ;(trips || []).forEach((t) => {
            const id = t.tripId || t.TripId
            const s = (t.status || t.Status || "").toLowerCase()
            const readOnly = s === "completed"
            ensurePassengers(id, readOnly, force)
          })
        } catch {}
      }
      function renderPaxChips(list, tripId, readOnly = false) {
        if (!list || !list.length)
          return '<span class="sub">尚無已分配乘客</span>'
        return list
          .map((p, i) => {
            const notified = !!(p.responseDateTime || p.ResponseDateTime)
            const when = p.responseDateTime || p.ResponseDateTime || ""
            const cls = notified ? "ok" : "warn"
            const title = notified ? `已通知 ${when}` : "未通知"
            const dataAttrs = readOnly
              ? ""
              : ` data-action=\"show-pax-detail\" data-trip-id=\"${escAttr(
                  tripId
                )}\" data-idx=\"${i}\"`
            const icon = notified
              ? '<span aria-label="已通知" title="已通知" style="margin-left:4px">🔔</span>'
              : '<span aria-label="未通知" title="未通知" style="margin-left:4px">⏳</span>'
            const count = (p.seatCount || 1) > 1 ? `×${p.seatCount}` : ""
            return `<span class=\"chip ${cls}\" title=\"${escAttr(
              title
            )}\"${dataAttrs}>${p.name || "-"} ${count} ${icon}</span>`
          })
          .join(" ")
      }

      // Pending view render
      function renderPending() {
        const listHost = document.getElementById("pendingListHost")
        const toolbar = document.getElementById("pendingToolbar")
        const unassigned = (pending || []).filter(
          (p) => !(p.tripId || p.TripId)
        )
        if (!unassigned.length) {
          if (listHost)
            listHost.innerHTML =
              '<div class="sub" style="text-align:center;padding:20px">暫無待保留乘客</div>'
          if (toolbar) toolbar.style.display = "none"
          updatePendingToolbarStateMobile()
          return
        }
        if (toolbar) toolbar.style.display = "flex"
        if (!listHost) return
        listHost.innerHTML = unassigned
          .map((p) => {
            const notified = !!(p.responseDateTime && p.responseDateTime.length)
            const badge = notified
              ? '<span class="chip ok">已通知</span>'
              : '<span class="chip warn">未通知</span>'
            const req = (p.requestDateTime || "").slice(11, 16) || "-"
            const phoneFull = p.phone || ""
            const dest = p.destStop || p.DestStop || "-"
            const include = p.includeRoutes || p.IncludeRoutes || ""
            const userId = p.userId || p.UserId || ""
            const includeChips = String(include)
              .split(",")
              .map((r) => r.trim())
              .filter(Boolean)
              .map(
                (r) =>
                  `<span class="route-badge route-${routeToClass(
                    r
                  )}">${r}</span>`
              )
              .join(" ")
            return `
            <div class="card pending-card" data-user-id="${escAttr(userId)}">
              <div class="row" style="justify-content:space-between;align-items:center">
                <div class="title">${p.name || "-"}（${
              p.seatCount || 1
            }位）</div>
                ${badge}
              </div>
              <div class="sub">申請 ${req}　電話 ${phoneFull}</div>
              <div class="chips"><span class="chip">${dest}</span> ${includeChips}
              </div>
              <div class="row" style="margin-top:6px"> 
                <label class="pending-select-box" title="選取此乘客以進行批次通知">
                  <input type="checkbox" class="pending-select" data-user-id="${escAttr(
                    userId
                  )}" /> 勾選
                </label>
                <button class="btn lg success" data-action="open-assign" data-id="${escAttr(
                  p.id
                )}" data-count="${escAttr(
              p.seatCount || 1
            )}">指派到趟次</button>
              </div>
            </div>`
          })
          .join("")
        // Re-apply selection state and bind events
        applyPendingSelectionsMobile()
        bindPendingSelectionEventsMobile()
        updatePendingToolbarStateMobile()
      }
      // 已移除顯示可搭路線功能

      function bindPendingSelectionEventsMobile() {
        const checkboxes = document.querySelectorAll(
          "#pendingListHost input.pending-select"
        )
        checkboxes.forEach((cb) => {
          cb.addEventListener("change", (e) => {
            const uid = cb.getAttribute("data-user-id") || ""
            togglePendingSelectionMobile(uid, cb.checked)
          })
        })
        const btnAll = document.getElementById("btnSelectAllPendingMobile")
        const btnClear = document.getElementById("btnClearAllPendingMobile")
        const btnSend = document.getElementById("btnSendDelayedMobile")
        if (btnAll && !btnAll.__bound) {
          btnAll.__bound = true
          btnAll.addEventListener("click", selectAllPendingMobile)
        }
        if (btnClear && !btnClear.__bound) {
          btnClear.__bound = true
          btnClear.addEventListener("click", clearAllPendingMobile)
        }
        if (btnSend && !btnSend.__bound) {
          btnSend.__bound = true
          btnSend.addEventListener("click", sendDelayedForSelectedMobile)
        }
      }

      function applyPendingSelectionsMobile() {
        const cards = document.querySelectorAll(
          "#pendingListHost .pending-card"
        )
        cards.forEach((card) => {
          const uid = card.getAttribute("data-user-id") || ""
          const checked = pendingSelectedUserIds.has(uid)
          card.classList.toggle("selected", checked)
          const cb = card.querySelector("input.pending-select")
          if (cb) cb.checked = checked
        })
      }

      function togglePendingSelectionMobile(userId, checked) {
        const uid = String(userId || "")
        if (!uid) return
        if (checked) pendingSelectedUserIds.add(uid)
        else pendingSelectedUserIds.delete(uid)
        const card = document.querySelector(
          `.pending-card[data-user-id="${CSS.escape(uid)}"]`
        )
        if (card) card.classList.toggle("selected", checked)
        updatePendingToolbarStateMobile()
      }

      function updatePendingToolbarStateMobile() {
        const visibleCards = Array.from(
          document.querySelectorAll("#pendingListHost .pending-card") || []
        )
        const visibleSelected = visibleCards.filter((c) =>
          pendingSelectedUserIds.has(c.getAttribute("data-user-id") || "")
        )
        const countEl = document.getElementById("pendingSelectedCountMobile")
        const btnSend = document.getElementById("btnSendDelayedMobile")
        if (countEl) countEl.textContent = String(visibleSelected.length)
        if (btnSend) btnSend.disabled = visibleSelected.length === 0
      }

      function selectAllPendingMobile() {
        const checkboxes = document.querySelectorAll(
          "#pendingListHost input.pending-select"
        )
        checkboxes.forEach((cb) => {
          const uid = cb.getAttribute("data-user-id") || ""
          if (!uid) return
          cb.checked = true
          pendingSelectedUserIds.add(uid)
        })
        applyPendingSelectionsMobile()
        updatePendingToolbarStateMobile()
      }

      function clearAllPendingMobile() {
        const checkboxes = document.querySelectorAll(
          "#pendingListHost input.pending-select"
        )
        checkboxes.forEach((cb) => (cb.checked = false))
        // 僅清除目前畫面上看得到的卡片所對應的 selection
        const visibleCards = document.querySelectorAll(
          "#pendingListHost .pending-card"
        )
        visibleCards.forEach((card) => {
          const uid = card.getAttribute("data-user-id") || ""
          if (uid) pendingSelectedUserIds.delete(uid)
        })
        applyPendingSelectionsMobile()
        updatePendingToolbarStateMobile()
      }

      async function sendDelayedForSelectedMobile() {
        try {
          const visibleCards = Array.from(
            document.querySelectorAll("#pendingListHost .pending-card") || []
          )
          const userIds = visibleCards
            .map((c) => c.getAttribute("data-user-id") || "")
            .filter((uid) => uid && pendingSelectedUserIds.has(uid))
          if (!userIds.length) {
            toast("請先勾選至少一位乘客")
            return
          }
          const res = await fetch(`${BASE_URL}/KeepSeat/notify-delayed`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userIds }),
          })
          if (!res.ok) throw 0
          const data = await res.json().catch(() => ({}))
          const sent = data?.sentCount ?? data?.SentCount ?? 0
          const notFound = (data?.notFound ?? data?.NotFound ?? []).length
          toast(`久候通知已送出 ${sent} 筆，略過 ${notFound} 筆`)
          await loadPending()
          renderPending()
        } catch {
          toast("傳送久候通知失敗，請稍後再試")
        }
      }

      // Assign flow
      async function openAssign(passengerId, seatCount) {
        selectedPassenger = { id: passengerId, seatCount: seatCount }
        await ensureTripSeatStats()
        const list = $("#assignList")
        if (!trips.length) {
          list.innerHTML =
            '<div class="sub" style="text-align:center;padding:16px">尚無可用趟次</div>'
        } else {
          list.innerHTML = trips
            .map((t) => {
              const stat = t.__seatStat || { used: 0, cap: t.keepCount || 0 }
              const remain = Math.max(0, (stat.cap || 0) - (stat.used || 0))
              const ok = remain >= seatCount
              const capChip = ok
                ? `<span class="chip ok">可再指派 ${remain} 位</span>`
                : `<span class="chip bad">剩餘 ${remain} 位</span>`
              return `
              <div class="card">
                <div class="row">
                  <div>
                    <div class="title">${t.route || "-"}｜${
                t.vehicleNumber || "-"
              }</div>
                    <div class="sub">發車 ${t.departureTime || "-"}</div>
                  </div>
                  <button class="btn sm ${ok ? "primary" : "ghost"}" ${
                ok ? "" : "disabled"
              } data-action="assign-to-trip" data-id="${escAttr(t.tripId)}">${
                ok ? "指派" : ""
              }</button>
                </div>
                <div class="chips">${capChip} <span class="chip">容量 ${
                stat.cap || 0
              }</span></div>
              </div>`
            })
            .join("")
        }
        $("#assignModal").style.display = "flex"
      }
      function closeAssignModal() {
        $("#assignModal").style.display = "none"
      }
      async function ensureTripSeatStats() {
        const jobs = (trips || []).map(async (t) => {
          try {
            const res = await fetch(`${BASE_URL}/Trip/${t.tripId}/passengers`)
            if (!res.ok) {
              t.__seatStat = { used: 0, cap: t.keepCount || 0 }
              return
            }
            const data = await res.json()
            if (!data.success) {
              t.__seatStat = { used: 0, cap: t.keepCount || 0 }
              return
            }
            const arr = Array.isArray(data.data)
              ? data.data
              : data.data?.passengers || []
            const used = (arr || []).reduce(
              (sum, p) => sum + (p.seatCount || 0),
              0
            )
            t.__seatStat = { used, cap: t.keepCount || 0 }
          } catch {
            t.__seatStat = { used: 0, cap: t.keepCount || 0 }
          }
        })
        await Promise.all(jobs)
      }

      async function reloadAll() {
        updateToday()
        await Promise.all([
          loadRoutes(),
          loadVehicleData(),
          loadTrips(),
          loadPending(),
        ])
        renderTrips()
        renderPending()
      }

      function closeTripModal() {
        const m = document.getElementById("tripModal")
        if (m) m.style.display = "none"
      }

      // init
      document.addEventListener("DOMContentLoaded", () => {
        updateToday()
        const _btnCreate = $("#btnCreate")
        if (_btnCreate) _btnCreate.addEventListener("click", openCreateTrip)
        setupVehicleAutocomplete()
        setupTimeInputFormatting()
        // 確保初始只高亮「待排」分頁，避免與舊的 primary/ghost 類別衝突
        switchTab("pending")
        reloadAll()
        startAutoRefresh()
        // 綁定模擬列印
        const spmBtn = document.getElementById("btnSimulatePrintMobile")
        if (spmBtn) spmBtn.addEventListener("click", simulatePrintMobile)
        // 快速筆數按鈕
        document
          .querySelectorAll("#simulatePrintMobilePanel .quick-sim")
          .forEach((btn) => {
            btn.addEventListener("click", () => {
              const c = btn.getAttribute("data-count")
              const inp = document.getElementById("simulatePrintCountMobile")
              if (inp) {
                inp.value = c
                try {
                  localStorage.setItem("simPrintCountMobile", c)
                } catch {}
              }
            })
          })
        // 還原上次輸入值
        try {
          const last = localStorage.getItem("simPrintCountMobile")
          if (last) {
            const inp = document.getElementById("simulatePrintCountMobile")
            if (inp) inp.value = last
          }
        } catch {}
      })

      function startAutoRefresh() {
        if (autoTimer) clearInterval(autoTimer)
        let tick = 0
        autoTimer = setInterval(async () => {
          try {
            tick++
            // 輕量輪詢：常態更新待排、定期更新趟次
            await loadPending()
            renderPending()
            if (tick % 3 === 0) {
              await loadTrips()
              renderTrips()
            } else {
              refreshVisibleTripPassengers()
            }
          } catch {}
        }, 8000)
      }

      function openEditTrip(tripId) {
        const t = (trips || []).find(
          (x) => String(x.tripId || x.TripId) === String(tripId)
        )
        if (!t) return
        document.getElementById("editingTripId").value = tripId
        document.getElementById("tripModalTitle").textContent = "編輯趟次"
        selectedRoute = t.route || selectedRoute
        renderRouteChips()
        document.getElementById("vehicleInput").value = t.vehicleNumber || ""
        setTimeField(t.departureTime || "")
        document.getElementById("keepCountInput").value =
          t.keepCount ?? t.KeepCount ?? 4
        document.getElementById("tripModal").style.display = "flex"
      }
      function normTime(v) {
        v = (v || "").replace(/[^0-9]/g, "")
        if (v.length >= 3) v = v.slice(0, 2) + ":" + v.slice(2, 4)
        return v.slice(0, 5)
      }

      // 時間輸入輔助：將純數字即時轉成 HH:mm，並驗證 00:00–23:59
      function toHHmmFromDigits(val) {
        const d = String(val || "")
          .replace(/\D/g, "")
          .slice(0, 4)
        if (d.length <= 2) return d
        return d.slice(0, 2) + ":" + d.slice(2)
      }
      function isValidTimeHHmm(v) {
        if (!/^\d{2}:\d{2}$/.test(v)) return false
        const h = parseInt(v.slice(0, 2), 10)
        const m = parseInt(v.slice(3, 5), 10)
        return h >= 0 && h <= 23 && m >= 0 && m <= 59
      }
      function setTimeField(v) {
        const el = document.getElementById("timeInput")
        const err = document.getElementById("timeError")
        if (!el) return
        el.value = normTime(v)
        if (err) err.style.display = "none"
        el.classList.remove("invalid")
      }
      function setupTimeInputFormatting() {
        const el = document.getElementById("timeInput")
        const err = document.getElementById("timeError")
        if (!el) return
        const update = () => {
          const formatted = toHHmmFromDigits(el.value)
          el.value = formatted
          if (formatted.length === 5) {
            const ok = isValidTimeHHmm(formatted)
            if (err) err.style.display = ok ? "none" : "block"
            el.classList.toggle("invalid", !ok)
          } else {
            if (err) err.style.display = "none"
            el.classList.remove("invalid")
          }
        }
        el.addEventListener("input", update)
        el.addEventListener("paste", (e) => {
          e.preventDefault()
          const text = (e.clipboardData || window.clipboardData).getData("text")
          el.value = toHHmmFromDigits(text)
          update()
        })
        el.addEventListener("blur", () => {
          const v = el.value
          if (v.length === 5 && !isValidTimeHHmm(v)) {
            if (err) err.style.display = "block"
            el.classList.add("invalid")
          }
        })
      }

      async function saveTrip() {
        const id = document.getElementById("editingTripId").value.trim()
        const route = selectedRoute
        const vehicle = document
          .getElementById("vehicleInput")
          .value.trim()
          .toUpperCase()
        const timeRaw = document.getElementById("timeInput").value
        const time = normTime(timeRaw)
        const keep = Math.max(
          0,
          Math.min(
            40,
            parseInt(document.getElementById("keepCountInput").value || "0", 10)
          )
        )
        if (!route) {
          toast("請選擇路線")
          return
        }
        if (!vehicle) {
          toast("請輸入車號")
          return
        }
        if (!isValidTimeHHmm(time)) {
          const err = document.getElementById("timeError")
          if (err) err.style.display = "block"
          const el = document.getElementById("timeInput")
          if (el) {
            el.classList.add("invalid")
            el.focus()
          }
          toast("請輸入有效時間 00:00 - 23:59")
          return
        }
        try {
          if (id) {
            // 編輯時限制：不得小於已排座位；若無已排，最小為 4 且不得低於原始值（只能往上加）
            const t = (trips || []).find(
              (x) => String(x.tripId || x.TripId) === String(id)
            )
            const originalKeep = t?.keepCount ?? t?.KeepCount ?? 4
            let assignedSeats = 0
            try {
              const list = await getTripPassengers(id)
              assignedSeats = (list || []).reduce(
                (sum, p) => sum + (p.seatCount || p.SeatCount || 0),
                0
              )
            } catch {}
            const minAllowed =
              assignedSeats > 0 ? assignedSeats : Math.max(4, originalKeep)
            if (keep < minAllowed) {
              toast(
                `座位數不得小於 ${minAllowed}${
                  assignedSeats > 0
                    ? `（已排：${assignedSeats}）`
                    : "（最小為 4，且不得低於原始值）"
                }`
              )
              return
            }
            const res = await fetch(`${BASE_URL}/Trip/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                route,
                vehicleNumber: vehicle,
                departureTime: time,
                keepCount: keep,
              }),
            })
            if (!res.ok) throw 0
            toast("已更新趟次")
          } else {
            // 新增：最小為 4
            if (keep < 4) {
              toast("座位數不得小於 4")
              return
            }
            const res = await fetch(`${BASE_URL}/Trip`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                route,
                vehicleNumber: vehicle,
                departureTime: time,
                keepCount: keep,
              }),
            })
            if (!res.ok) {
              const t = await res.text().catch(() => "")
              const m = (t || "").slice(0, 120)
              throw new Error(m || "新增失敗")
            }
            toast("已新增趟次")
          }
          closeTripModal()
          await loadTrips()
          renderTrips()
          await loadPending()
          renderPending()
        } catch {
          toast("儲存失敗")
        }
      }

      // Vehicle autocomplete
      function setupVehicleAutocomplete() {
        const input = document.getElementById("vehicleInput")
        const list = document.getElementById("vehicleSugg")
        if (!input || !list) return
        input.addEventListener("input", () => {
          const q = input.value.trim().toUpperCase()
          if (!q) {
            list.style.display = "none"
            list.innerHTML = ""
            return
          }
          const matches = (vehicleData || [])
            .filter((v) => (v.plateNumber || "").toUpperCase().includes(q))
            .slice(0, 8)
          if (!matches.length) {
            list.style.display = "none"
            list.innerHTML = ""
            return
          }
          list.innerHTML = matches
            .map((v) => {
              const pn = escAttr(v.plateNumber || "")
              const label = `${v.plateNumber} - ${v.operatorName || ""}`
              return `<div class="sugg-item" data-action="pick-vehicle" data-value="${pn}">${label}</div>`
            })
            .join("")
          list.style.display = "block"
        })
        input.addEventListener("blur", () =>
          setTimeout(() => {
            list.style.display = "none"
          }, 150)
        )
      }
      function pickVehicle(val) {
        document.getElementById("vehicleInput").value = val
        document.getElementById("vehicleSugg").style.display = "none"
      }

      // Trip passengers modal and helpers
      function viewTripPassengers(tripId) {
        openTripPassengersModal(tripId)
      }
      async function assignToTrip(tripId) {
        try {
          if (!selectedPassenger?.id) return toast("未選擇乘客")
          const keepSeatId = selectedPassenger.id
          const payload = { keepSeatIds: [keepSeatId], tripId }
          const res = await fetch(`${BASE_URL}/KeepSeat/assign-trip`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
          if (!res.ok) throw 0
          await res.json().catch(() => ({}))
          toast("已指派到趟次")
          closeAssignModal()
          // 使快取失效並刷新
          try {
            tripPassengersCache.delete(tripId)
          } catch {}
          await loadTrips()
          renderTrips()
          await loadPending()
          renderPending()
        } catch {
          toast("指派失敗，請稍後再試")
        }
      }
      async function confirmDeparture(tripId) {
        try {
          if (!confirm("通知乘客？")) return
          const res = await fetch(
            `${BASE_URL}/KeepSeat/confirm-departure/${tripId}`,
            {
              method: "POST",
            }
          )
          if (!res.ok) throw 0
          toast("已通知乘客")
          await loadTrips()
          renderTrips()
        } catch {
          toast("通知失敗")
        }
      }

      // 標記趟次為已發車（不發送通知）
      async function markTripDeparted(tripId) {
        try {
          if (!confirm("確認將此趟次標記為已發車？")) return
          const res = await fetch(`${BASE_URL}/Trip/${tripId}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ Status: "completed" }),
          })
          const data = await res.json().catch(() => ({}))
          if (!res.ok || data?.success === false) throw 0
          toast("已標記為已發車")
          await loadTrips()
          renderTrips()
        } catch {
          toast("標記失敗")
        }
      }
      function openTripPassengersModal(tripId) {
        getTripPassengers(tripId)
          .then((list) => {
            const host = ensurePassengersModal()
            host.list.innerHTML = list.length
              ? list
                  .map(
                    (p) =>
                      `<div class="card"><div class="row"><div class="title">${
                        p.name || "-"
                      }（${
                        p.seatCount || 1
                      }位）</div></div><div class="sub">上 ${
                        p.keepStop || "-"
                      } ｜ 下 ${p.destStop || "-"}</div></div>`
                  )
                  .join("")
              : '<div class="sub" style="text-align:center;padding:16px">目前無已分配乘客</div>'
            host.modal.style.display = "flex"
          })
          .catch(() => toast("讀取乘客失敗"))
      }
      function ensurePassengersModal() {
        let modal = document.getElementById("tripPassengersModal")
        if (!modal) {
          const html = `
          <div class="modal" id="tripPassengersModal" role="dialog" aria-modal="true"> 
            <div class="sheet"> 
              <div class="row" style="margin-bottom:8px"> 
                <div class="title">趟次乘客</div> 
                <button class="btn sm ghost" data-action="close-trip-pax">關閉</button> 
              </div> 
              <div id="tripPassengersList" class="list"></div> 
            </div> 
          </div>`
          document.body.insertAdjacentHTML("beforeend", html)
          modal = document.getElementById("tripPassengersModal")
        }
        return { modal, list: document.getElementById("tripPassengersList") }
      }
      function closeTripPassengersModal() {
        const m = document.getElementById("tripPassengersModal")
        if (m) m.style.display = "none"
      }
      async function getTripPassengers(tripId) {
        const res = await fetch(`${BASE_URL}/Trip/${tripId}/passengers`)
        if (!res.ok) throw 0
        const data = await res.json().catch(() => ({ success: false }))
        if (!data?.success) throw 0
        const arr =
          data.data?.passengers || data.data?.Passengers || data.data || []
        return Array.isArray(arr) ? arr : []
      }

      // 乘客詳情 Modal（提供 openPassengerDetail 使用）
      function ensurePassengerDetailModal() {
        let modal = document.getElementById("passengerDetailModal")
        if (!modal) {
          const html = `
          <div class="modal" id="passengerDetailModal" role="dialog" aria-modal="true">
            <div class="sheet">
              <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
                <div class="title">預約詳情</div>
                <button class="btn sm ghost" data-action="close-passenger-detail">關閉</button>
              </div>
              <div id="passengerDetailContent"></div>
            </div>
          </div>`
          document.body.insertAdjacentHTML("beforeend", html)
          modal = document.getElementById("passengerDetailModal")
        }
        return {
          modal,
          content: document.getElementById("passengerDetailContent"),
        }
      }
      async function openPassengerDetail(tripId, idx) {
        try {
          let list = tripPassengersCache.get(tripId)?.list
          if (!Array.isArray(list)) {
            list = await getTripPassengers(tripId)
            tripPassengersCache.set(tripId, { list, ts: Date.now() })
          }
          const trip = (trips || []).find(
            (t) => String(t.tripId || t.TripId) === String(tripId)
          )
          const readOnly =
            (trip?.status || trip?.Status || "").toLowerCase() === "completed"
          let p = list[idx]
          if (!p) {
            toast("找不到乘客資料，已重新載入")
            await ensurePassengers(tripId)
            return
          }
          // 先取得當前乘客ID，供重新抓取後精準比對
          const currentPid = p.id || p.Id || p.keepSeatId || p.KeepSeatId || ""

          // 若缺少 includeRoutes，嘗試重新抓取後端資料以補齊（避免舊快取）
          try {
            const hasInclude = !!(p.includeRoutes || p.IncludeRoutes)
            if (!hasInclude) {
              const fresh = await getTripPassengers(tripId)
              if (Array.isArray(fresh) && fresh.length) {
                tripPassengersCache.set(tripId, { list: fresh, ts: Date.now() })
                // 以ID匹配同一位乘客，避免序列順序變動導致取錯人
                const matched = fresh.find(
                  (x) =>
                    String(
                      x.id || x.Id || x.keepSeatId || x.KeepSeatId || ""
                    ) === String(currentPid)
                )
                p = matched || fresh[idx] || p
              }
            }
          } catch {}
          const { modal, content } = ensurePassengerDetailModal()
          const passengerId = p.id || p.Id || p.keepSeatId || p.KeepSeatId || ""
          const seatCount = p.seatCount || p.SeatCount || 1
          const include = p.includeRoutes || p.IncludeRoutes || ""
          const includeChips = String(include)
            .split(",")
            .map((r) => r.trim())
            .filter(Boolean)
            .map(
              (r) =>
                `<span class="route-badge route-${routeToClass(r)}">${r}</span>`
            )
            .join(" ")
          const lines = [
            `<div class="card"><div class="title">${escAttr(p.name || "-")}${
              (seatCount || 1) > 1 ? ` ×${seatCount}` : ""
            }</div>`,
            `<div class="sub">電話：${escAttr(p.phone || "-")}</div>`,
            `<div class="sub">上車：${escAttr(
              p.keepStop || "-"
            )}　｜　下車：${escAttr(p.destStop || "-")}</div>`,
            `<div class="chips"><span class="chip">可搭路線：</span> ${
              includeChips || "-"
            }</div>`,
            p.requestDateTime
              ? `<div class="sub">申請時間：${escAttr(p.requestDateTime)}</div>`
              : "",
            p.responseDateTime
              ? `<div class="sub">通知時間：${escAttr(
                  p.responseDateTime
                )}</div>`
              : "",
            `</div>`,
            !readOnly && passengerId
              ? `<div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
                   <button class="btn sm ghost" data-action="close-passenger-detail">關閉</button>
                   <button class="btn sm danger" data-action="remove-from-trip" data-passenger-id="${escAttr(
                     passengerId
                   )}" data-trip-id="${escAttr(
                  tripId
                )}" data-seat-count="${escAttr(seatCount)}">移除此趟次</button>
                 </div>`
              : `<div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
                   <button class="btn sm ghost" data-action="close-passenger-detail">關閉</button>
                 </div>`,
          ].filter(Boolean)
          content.innerHTML = lines.join("")
          modal.style.display = "flex"
        } catch {
          toast("顯示詳情失敗")
        }
      }
      function closePassengerDetail() {
        const m = document.getElementById("passengerDetailModal")
        if (m) m.style.display = "none"
      }

      // 將乘客從趟次中移除（回到未排）
      async function unassignPassenger(passengerId) {
        const url = `${BASE_URL}/Trip/unassign-passenger`
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ PassengerId: passengerId }),
        })
        if (!res.ok) {
          const t = await res.text().catch(() => "")
          throw new Error(t || "取消分配失敗")
        }
        const data = await res.json().catch(() => ({ success: false }))
        if (!data.success) throw new Error(data.message || "取消分配失敗")
        return data
      }
      async function removePassengerFromTrip(passengerId, tripId, seatCount) {
        try {
          if (!passengerId) return toast("缺少乘客識別，無法移除")
          if (!confirm("確定要將此乘客從趟次中移除並回到待排嗎？")) return
          await unassignPassenger(passengerId)
          // 關閉詳情視窗
          closePassengerDetail()
          // 使快取失效，避免舊資料殘留
          if (tripId) tripPassengersCache.delete(tripId)
          // 重新載入資料
          await loadTrips()
          renderTrips()
          await loadPending()
          toast("已移除，乘客已回到未排")
        } catch (e) {
          toast(`移除失敗：${e?.message || "發生錯誤"}`)
        }
      }

      // Delete trip
      async function deleteTrip(tripId) {
        try {
          if (!confirm("確定刪除此趟次？相關已分配乘客將回到待保留。")) return
          const res = await fetch(`${BASE_URL}/Trip/${tripId}`, {
            method: "DELETE",
          })
          if (!res.ok) throw 0
          toast("已刪除趟次")
          await reloadAll()
        } catch {
          toast("刪除失敗")
        }
      }

      // ================= 列印相關（同步桌面版） =================
      // 防止同時觸發重複列印
      let isPrinting = false

      // Print trip（與桌面版同步：含 QRCode 與同版式 + 防重複列印 + 高度 debug）
      async function printTrip(tripId) {
        try {
          const res = await fetch(`${BASE_URL}/Trip/${tripId}/passengers`)
          if (!res.ok) throw new Error("讀取趟次資料失敗")
          const data = await res.json()
          if (!data.success) throw new Error("後端回應失敗")
          const trip = data.data?.trip || data.data?.Trip || null
          const list =
            data.data?.passengers || data.data?.Passengers || data.data || []
          if (!list || !list.length) {
            toast("此趟次沒有已分配乘客")
            return
          }
          const totalSeats = list.reduce(
            (sum, p) => sum + (p.seatCount || p.SeatCount || 1),
            0
          )
          const qrCodeUrl = await generateQRCodeURL(tripId)
          const html = buildReservationHtml(
            { trip, passengers: list },
            qrCodeUrl,
            totalSeats
          )

          const printContent = ensurePrintContentElement()
          printContent.innerHTML = html

          await waitForQRCodeLoading()

          if (isPrinting) {
            toast("上一份列印尚未完成")
            return
          }
          isPrinting = true
          printContent.style.display = "block"

          // Debug：量測實際高度（確認是否超出單頁）
          requestAnimationFrame(() => {
            const hPx = printContent.scrollHeight
            const hMm = (hPx * 25.4) / 96
            console.log(
              `[PRINT-DEBUG] reservation content height=${hPx}px (~${hMm.toFixed(
                1
              )}mm)`
            )
          })

          const beforePrintHandler = () => {}
          const afterPrintHandler = () => {
            printContent.style.display = "none"
            window.removeEventListener("beforeprint", beforePrintHandler)
            window.removeEventListener("afterprint", afterPrintHandler)
            isPrinting = false
            toast(
              `${trip?.departureTime || ""}發車的${
                trip?.vehicleNumber || ""
              } 列印完成`
            )
          }
          window.addEventListener("beforeprint", beforePrintHandler)
          window.addEventListener("afterprint", afterPrintHandler)
          window.print()
          setTimeout(() => {
            if (printContent.style.display !== "none") {
              printContent.style.display = "none"
              window.removeEventListener("beforeprint", beforePrintHandler)
              window.removeEventListener("afterprint", afterPrintHandler)
              isPrinting = false
            }
          }, 8000)
        } catch (e) {
          toast(`列印失敗：${e?.message || "發生錯誤"}`)
          isPrinting = false
        }
      }

      // 列印 HTML（對齊桌面版）
      function buildReservationHtml(tripData, qrCodeUrl, totalSeats) {
        const list = (tripData.passengers || [])
          .map((p, i) => {
            const name = p.name || p.Name || "未知"
            const seats = p.seatCount || p.SeatCount || 1
            const to = p.destStop || p.DestStop || "未知"
            const rawPhone = p.phone || p.Phone || ""
            const digitsOnly = String(rawPhone).replace(/\D/g, "")
            const tail3 = digitsOnly ? digitsOnly.slice(-3) : ""
            return `${i + 1}. ${name} (${seats}位 ) → ${to}  ${tail3}`
          })
          .join("<br/>")

        const route = tripData.trip?.route || "未知"
        const car = tripData.trip?.vehicleNumber || "未知"
        const time = tripData.trip?.departureTime || "未知"
        const now = new Date().toLocaleString()

        return `
          <div style="width:75mm;font-family:'Microsoft JhengHei','Courier New',monospace;font-size:10pt;line-height:0.9;color:#000;padding:0 1mm 1mm;text-align:center;page-break-after:avoid;page-break-before:avoid;">
            <div style="font-size:16pt;font-weight:700;margin:0 0 1mm;">大都會客運保留座位清單</div>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <div style="font-size:13pt;">路線: ${route}</div>
            <div style="font-size:13pt;">車號: ${car}</div>
            <div style="font-size:13pt;">發車時間: ${time}</div>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <div style="text-align:left;display:inline-block;width:90%;font-size:12pt;">${list}</div>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <div style="font-size:13pt;">總計: ${totalSeats} 位乘客</div>
            <div class="qr-code" style="margin:2mm 0;min-height:32mm;display:flex;align-items:center;justify-content:center;"><img src="${qrCodeUrl}" style="width:30mm;height:30mm;"/></div>
            <div>列印時間: ${now}</div>
            <div style="height:2mm;"></div>
          </div>
        `
      }

      function createPrintContentElement() {
        const el = document.createElement("div")
        el.id = "print-content"
        el.style.display = "none"
        el.style.position = "absolute"
        el.style.left = "-9999px"
        el.style.top = "-9999px"
        document.body.appendChild(el)

        const style = document.createElement("style")
        style.id = "print-content-style"
        style.textContent = `
          @media print {
            @page { margin: 0 !important; size: 79mm auto !important; padding: 0 !important; }
            html, body { margin: 0 !important; padding: 0 !important; }
            body > *:not(#print-content) { display: none !important; }
            #print-content { display:block !important; position:static !important; left:auto !important; top:auto !important; width:75mm !important; height:auto !important; font-family:'Microsoft JhengHei','Courier New',monospace !important; font-size:10pt !important; line-height:1.2 !important; color:black !important; background:white !important; padding:0 1mm 1mm !important; text-align:center !important; margin:0 auto !important; box-sizing:border-box !important; overflow:visible !important; page-break-inside:avoid !important; }
            #print-content * { background:transparent !important; color:black !important; text-align:center !important; page-break-inside:avoid !important; }
            #print-content .qr-code { page-break-inside: avoid !important; margin: 2mm 0 !important; }
            #print-content .qr-code img { width: 30mm !important; height: 30mm !important; display:block !important; margin:0 auto !important; }
          }
        `
        document.head.appendChild(style)
        return el
      }

      // 確保存在列印容器與樣式（即使容器已先存在，也會補上樣式）
      function ensurePrintContentElement() {
        let el = document.getElementById("print-content")
        if (!el) {
          el = createPrintContentElement()
        } else {
          // 若缺少樣式則補上
          if (!document.getElementById("print-content-style")) {
            const style = document.createElement("style")
            style.id = "print-content-style"
            style.textContent = `
              @media print {
                @page { margin: 0 !important; size: 79mm auto !important; padding: 0 !important; }
                html, body { margin: 0 !important; padding: 0 !important; }
                body > *:not(#print-content) { display: none !important; }
                #print-content { display:block !important; position:static !important; left:auto !important; top:auto !important; width:75mm !important; height:auto !important; font-family:'Microsoft JhengHei','Courier New',monospace !important; font-size:10pt !important; line-height:1.2 !important; color:black !important; background:white !important; padding:0 1mm 1mm !important; text-align:center !important; margin:0 auto !important; box-sizing:border-box !important; overflow:visible !important; page-break-inside:avoid !important; }
                #print-content * { background:transparent !important; color:black !important; text-align:center !important; page-break-inside:avoid !important; }
                #print-content .qr-code { page-break-inside: avoid !important; margin: 2mm 0 !important; }
                #print-content .qr-code img { width: 30mm !important; height: 30mm !important; display:block !important; margin:0 auto !important; }
              }
            `
            document.head.appendChild(style)
          }
        }
        return el
      }

      function waitForQRCodeLoading() {
        return new Promise((resolve) => {
          const img = document.querySelector("#print-content .qr-code img")
          if (!img) return resolve()
          if (img.complete) return resolve()
          img.onload = () => resolve()
          img.onerror = () => resolve()
        })
      }

      async function generateQRCodeURL(text) {
        try {
          const encodedText = encodeURIComponent(String(text ?? ""))
          return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodedText}`
        } catch {
          return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${Date.now()}`
        }
      }

      // ========= 模擬列印 (與桌面版邏輯一致) =========
      async function simulatePrintMobile() {
        try {
          const input = document.getElementById("simulatePrintCountMobile")
          let count = parseInt(input && input.value ? input.value : "0", 10)
          if (isNaN(count) || count <= 0) {
            toast("請輸入大於 0 的數字")
            return
          }
          if (count > 300) {
            toast("筆數過大，已限制為 300")
            count = 300
          }
          // 建立模擬資料
          const passengers = []
          for (let i = 0; i < count; i++) {
            passengers.push({
              name: `乘客${i + 1}`,
              seatCount: 1,
              destStop: "測試站",
              phone: `09${(Math.random() * 1e8).toFixed(0).padStart(8, "0")}`,
            })
          }
          const tripData = {
            trip: {
              route: "測試路線",
              vehicleNumber: "TEST-000",
              departureTime: new Date().toLocaleTimeString("zh-TW", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              }),
            },
            passengers,
          }
          const totalSeats = passengers.length
          const qrCodeUrl = await generateQRCodeURL("SIMULATE-PRINT-MOBILE")
          const html = buildReservationHtml(tripData, qrCodeUrl, totalSeats)
          const printContent = ensurePrintContentElement()
          printContent.innerHTML = html
          await waitForQRCodeLoading()
          if (isPrinting) {
            toast("上一份列印尚未完成")
            return
          }
          isPrinting = true
          printContent.style.display = "block"
          requestAnimationFrame(() => {
            const hPx = printContent.scrollHeight
            const hMm = (hPx * 25.4) / 96
            console.log(
              `[PRINT-DEBUG] simulate mobile content height=${hPx}px (~${hMm.toFixed(
                1
              )}mm)  count=${count}`
            )
          })
          const beforePrintHandler = () => {}
          const afterPrintHandler = () => {
            printContent.style.display = "none"
            window.removeEventListener("beforeprint", beforePrintHandler)
            window.removeEventListener("afterprint", afterPrintHandler)
            isPrinting = false
            toast(`模擬列印完成 (共 ${count} 筆)`)
          }
          window.addEventListener("beforeprint", beforePrintHandler)
          window.addEventListener("afterprint", afterPrintHandler)
          window.print()
          setTimeout(() => {
            if (printContent.style.display !== "none") {
              printContent.style.display = "none"
              window.removeEventListener("beforeprint", beforePrintHandler)
              window.removeEventListener("afterprint", afterPrintHandler)
              isPrinting = false
            }
          }, 8000)
        } catch (e) {
          console.error("simulatePrintMobile 發生錯誤", e)
          isPrinting = false
          toast("模擬列印失敗: " + (e?.message || "錯誤"))
        }
      }
    </script>
  </body>
</html>
