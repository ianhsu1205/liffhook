<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 當頁面載入時初始化 LIFF
        async function closeWindow() {
            try {
                await liff.init({ liffId: "2006966365-94yjBGjO" });

                // 確認是否在 LINE 客戶端中
                if (liff.isInClient()) {
                    // 提交表單後，關閉視窗並回到聊天畫面
                    liff.closeWindow();
                } else {
                    // 如果不在 LIFF 客戶端中，給出提示並重定向回 LINE
                    console.log("不是在 LIFF 客戶端中，將重定向回聊天畫面");
                    alert("請在 LINE 應用程式中使用此功能");

                    // 在非 LIFF 環境中將用戶重定向到 LINE 聊天頁面
                    setTimeout(() => {
                        window.location.href = "line://";
                    }, 500);  // 加上延遲 500 毫秒來確保流程完成
                }
            } catch (error) {
                console.error("初始化 LIFF 失敗:", error);
                alert("無法初始化 LIFF SDK，請稍後再試");
            }
        }

        // 當表單提交後執行
        async function submitForm() {
            const data = {
                company: document.getElementById("company").value,
                dept: document.getElementById("dept").value,
                groupCode: document.getElementById("groupCode").value,
                phone: document.getElementById("phone").value,
                name: document.getElementById("name").value,
                empId: document.getElementById("empId").value,
                nickname: document.getElementById("nickname").value,
                projectId: document.getElementById("projectId").value,
                userId: document.getElementById("userId").value
            };
            
            // 提交表單數據
            fetch("https://1382-125-227-174-151.ngrok-free.app/api/User/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(response => response.text())
              .then(result => {
                  alert("註冊成功！");

                  // 提交後，延遲 500 毫秒後關閉並回到聊天畫面
                  setTimeout(() => {
                      closeWindow(); // 使用 liff.closeWindow() 嘗試關閉
                  }, 500);
              })
              .catch(error => {
                  console.error("錯誤:", error);
                  alert("註冊失敗，請稍後再試！");
                  
                  // 如果提交失敗，則延遲並重定向回 LINE
                  setTimeout(() => {
                      window.location.href = "line://";
                  }, 500);
              });
        }

        // 初始化並執行
        window.onload = async function() {
            await closeWindow();
        };
    </script>
</head>
<body>
    <div>
        <h2>LINE通知註冊</h2>
        <form id="registerForm" onsubmit="submitForm(); return false;">
            <input type="text" id="company" placeholder="公司名稱" required>
            <input type="text" id="dept" placeholder="部門" required>
            <input type="text" id="groupCode" placeholder="群組代碼" required>
            <input type="text" id="phone" placeholder="電話號碼" required>
            <input type="text" id="name" placeholder="姓名">
            <input type="text" id="empId" placeholder="員工編號">
            <input type="text" id="nickname" placeholder="暱稱">

            <input type="hidden" id="userId">
            <input type="hidden" id="projectId" value="固定的projectId">

            <button type="submit">提交</button>
        </form>
    </div>
</body>
</html>
