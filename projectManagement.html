<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>車輛檢查專案管理</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft JhengHei", "Segoe UI", Tahoma, Geneva, Verdana,
          sans-serif;
        background: #f8f9fa;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: linear-gradient(135deg, #06c755, #04a043);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .nav-tabs {
        display: flex;
        margin-bottom: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav-tab {
        flex: 1;
        padding: 15px;
        background: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        border-right: 1px solid #eee;
      }

      .nav-tab:last-child {
        border-right: none;
      }

      .nav-tab.active {
        background: #06c755;
        color: white;
      }

      .nav-tab:hover:not(.active) {
        background: #f0f0f0;
      }

      .tab-content {
        display: none;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .tab-content.active {
        display: block;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #06c755;
        color: white;
      }

      .btn-primary:hover {
        background: #04a043;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }

      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: #06c755;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.2);
      }

      .project-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }

      .project-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .project-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .project-title {
        font-size: 18px;
        font-weight: 600;
        color: #06c755;
        margin-bottom: 10px;
      }

      .project-desc {
        color: #666;
        margin-bottom: 15px;
        font-size: 14px;
        line-height: 1.5;
      }

      .project-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 12px;
        color: #999;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .project-actions {
        display: flex;
        gap: 10px;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      /* 圖片Modal特殊樣式 */
      #image-modal .modal-content {
        max-width: 95%;
        max-height: 95vh;
        margin: 2.5% auto;
      }

      .modal-header {
        background: #06c755;
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
      }

      .close {
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
      }

      .close:hover {
        opacity: 0.8;
      }

      .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .config-section {
        margin-bottom: 30px;
      }

      .config-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .config-list {
        border: 1px solid #eee;
        border-radius: 6px;
        overflow: hidden;
      }

      .config-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        background: #fafafa;
        transition: all 0.2s ease;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .config-item:last-child {
        border-bottom: none;
      }

      .config-item-info {
        flex: 1;
      }

      .config-item-name {
        font-weight: 500;
        color: #333;
      }

      .config-item-code {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }

      .config-item-actions {
        display: flex;
        gap: 8px;
      }

      /* 觸控拖拽相關樣式 */
      .config-item.dragging {
        transform: scale(1.05);
        z-index: 1000;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        opacity: 0.9;
        background: #e8f5e8;
      }

      .drag-placeholder {
        height: 70px;
        margin: 10px 0;
        border: 2px dashed #06c755;
        border-radius: 8px;
        background: rgba(6, 199, 85, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #06c755;
        font-weight: bold;
        transition: all 0.2s ease;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.6;
        }
      }

      /* 行動裝置優化 */
      @media (max-width: 768px) {
        .config-item {
          padding: 12px;
        }

        .config-item-name {
          font-size: 14px;
        }

        .config-item-code {
          font-size: 11px;
        }

        .fa-grip-vertical {
          font-size: 16px !important;
          padding: 8px;
          margin-right: 4px !important;
        }

        .drag-placeholder {
          height: 60px;
          font-size: 14px;
        }
      }

      /* 觸控回饋效果 */
      .config-item:active {
        background: #f0f0f0;
      }

      .fa-grip-vertical:hover,
      .fa-grip-vertical:active {
        color: #06c755 !important;
        transform: scale(1.1);
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .add-config-form {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 10px;
        align-items: end;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading i {
        font-size: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .project-grid {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95%;
          margin: 5% auto;
        }

        #image-modal .modal-content {
          width: 98%;
          margin: 1% auto;
          max-height: 98vh;
        }

        #modal-image {
          max-height: 60vh !important;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-project-diagram"></i> 車輛檢查專案管理</h1>
        <p>管理檢查專案，配置設備和檢查項目</p>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('projects', event)">
          <i class="fas fa-list"></i> 專案列表
        </button>
        <button class="nav-tab" onclick="switchTab('create', event)">
          <i class="fas fa-plus"></i> 新增專案
        </button>
      </div>

      <!-- 專案列表 -->
      <div id="projects-tab" class="tab-content active">
        <div class="loading" id="projects-loading">
          <i class="fas fa-spinner"></i>
          <div>載入中...</div>
        </div>
        <div
          id="projects-list"
          class="project-grid"
          style="display: none"
        ></div>
      </div>

      <!-- 新增專案 -->
      <div id="create-tab" class="tab-content">
        <form id="create-project-form">
          <div class="form-group">
            <label class="form-label">專案名稱 *</label>
            <input
              type="text"
              id="project-name"
              class="form-control"
              required
              maxlength="100"
            />
          </div>
          <div class="form-group">
            <label class="form-label">專案描述</label>
            <textarea
              id="project-description"
              class="form-control"
              rows="3"
              maxlength="500"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="project-active" checked /> 立即啟用專案
            </label>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> 創建專案
          </button>
        </form>
      </div>
    </div>

    <!-- 專案配置Modal -->
    <div id="config-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">專案配置</h3>
          <button class="close" onclick="closeConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="config-content"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeConfigModal()">
            <i class="fas fa-times"></i> 關閉
          </button>
          <button class="btn btn-primary" onclick="saveProjectConfig()">
            <i class="fas fa-save"></i> 保存配置
          </button>
        </div>
      </div>
    </div>

    <!-- 編輯專案Modal -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">編輯專案</h3>
          <button class="close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="edit-project-form">
            <input type="hidden" id="edit-project-id" />
            <div class="form-group">
              <label class="form-label">專案名稱 *</label>
              <input
                type="text"
                id="edit-project-name"
                class="form-control"
                required
                maxlength="100"
              />
            </div>
            <div class="form-group">
              <label class="form-label">專案描述</label>
              <textarea
                id="edit-project-description"
                class="form-control"
                rows="3"
                maxlength="500"
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="edit-project-active" /> 啟用專案
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeEditModal()">
            <i class="fas fa-times"></i> 取消
          </button>
          <button class="btn btn-primary" onclick="updateProject()">
            <i class="fas fa-save"></i> 更新專案
          </button>
        </div>
      </div>
    </div>

    <script>
      const base_url = (() => {
        // 檢查是否為本地開發環境
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return window.location.origin + "/"
        }
        // 生產環境使用指定的後端地址
        return "https://35.221.146.143.nip.io/linehook/"
      })() // 使用動態偵測指向應用程式根目錄
      let projects = []
      let currentProjectId = null
      let projectDevices = []
      let projectCheckItems = []

      // 頁面載入後初始化
      document.addEventListener("DOMContentLoaded", function () {
        // 顯示權限提示
        showPermissionNotice()

        loadProjects()

        // 綁定表單提交事件
        document
          .getElementById("create-project-form")
          .addEventListener("submit", createProject)

        // 事件委託處理查看圖片按鈕點擊
        document.addEventListener("click", function (event) {
          if (event.target.closest(".view-images-btn")) {
            const button = event.target.closest(".view-images-btn")
            const itemName = button.getAttribute("data-item-name")
            const imagesJson = button.getAttribute("data-images")
            viewItemImages(itemName, imagesJson)
          }
        })
      })

      // 顯示權限提示
      function showPermissionNotice() {
        const notice = document.createElement("div")
        notice.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          background: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
          border-radius: 4px;
          padding: 10px 15px;
          font-size: 14px;
          z-index: 1000;
          max-width: 300px;
        `
        notice.innerHTML = `
          <strong>注意：</strong>此頁面需要專案管理權限。<br>
          如需權限，請聯絡系統管理員在資料庫中設定您的用戶權限。
        `
        document.body.appendChild(notice)

        // 5秒後自動隱藏
        setTimeout(() => {
          notice.remove()
        }, 5000)
      }

      // 切換頁籤
      function switchTab(tabName, event = null) {
        // 隱藏所有頁籤內容
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active")
        })

        // 移除所有頁籤的active類
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active")
        })

        // 顯示選中的頁籤內容
        document.getElementById(tabName + "-tab").classList.add("active")

        // 添加選中頁籤的active類（如果有event）
        if (event && event.target) {
          event.target.classList.add("active")
        } else {
          // 如果沒有event，找到對應的按鈕並設為active
          const targetButton = document.querySelector(
            `[onclick="switchTab('${tabName}')"]`
          )
          if (targetButton) {
            targetButton.classList.add("active")
          }
        }

        // 如果切換到專案列表，重新載入數據
        if (tabName === "projects") {
          loadProjects()
        }
      }

      // 載入專案列表
      async function loadProjects() {
        const loading = document.getElementById("projects-loading")
        const list = document.getElementById("projects-list")

        loading.style.display = "block"
        list.style.display = "none"

        try {
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects`
          )
          if (!response.ok) throw new Error("載入專案失敗")

          projects = await response.json()
          renderProjects(projects)

          loading.style.display = "none"
          list.style.display = "grid"
        } catch (error) {
          console.error("載入專案失敗:", error)
          loading.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i><div>載入失敗，請重試</div>'
        }
      }

      // 渲染專案列表
      function renderProjects(projectList) {
        const container = document.getElementById("projects-list")

        if (projectList.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">尚無專案，點擊「新增專案」開始創建</div>'
          return
        }

        container.innerHTML = projectList
          .map(
            (project) => `
                <div class="project-card">
                    <div class="project-title">${project.name}</div>
                    <div class="project-desc">${
                      project.description || "無描述"
                    }</div>
                    <div class="project-meta">
                        <span>建立時間: ${new Date(
                          project.createdAt
                        ).toLocaleDateString()}</span>
                        <span class="status-badge ${
                          project.isActive ? "status-active" : "status-inactive"
                        }">
                            ${project.isActive ? "啟用" : "停用"}
                        </span>
                    </div>
                    <div class="project-meta">
                        <span>檢查項目: ${project.devices.length} 項</span>
                        <span>檢查結果: ${project.checkItems.length} 項</span>
                    </div>
                    <div class="project-actions">
                        <button class="btn btn-primary btn-sm" onclick="openConfigModal('${
                          project.id
                        }')">
                            <i class="fas fa-cog"></i> 配置
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="openEditModal('${
                          project.id
                        }')">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProject('${
                          project.id
                        }', '${project.name}')">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </div>
                </div>
            `
          )
          .join("")
      }

      // 創建專案
      async function createProject(event) {
        event.preventDefault()

        const name = document.getElementById("project-name").value.trim()
        const description = document
          .getElementById("project-description")
          .value.trim()
        const isActive = document.getElementById("project-active").checked

        if (!name) {
          alert("請輸入專案名稱")
          return
        }

        try {
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: name,
                description: description,
                isActive: isActive,
              }),
            }
          )

          if (!response.ok) {
            let errorMessage = "創建專案失敗"
            try {
              const error = await response.json()
              errorMessage = error.message || error.error || "創建專案失敗"
              // 如果有詳細錯誤信息，也顯示出來
              if (error.innerException) {
                errorMessage += ` (詳細: ${error.innerException})`
              }
            } catch (parseError) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`
            }
            throw new Error(errorMessage)
          }

          // 清空表單
          document.getElementById("create-project-form").reset()
          document.getElementById("project-active").checked = true

          // 切換到專案列表並重新載入
          switchTab("projects")
          loadProjects()

          alert("專案創建成功！")
        } catch (error) {
          console.error("創建專案失敗:", error)
          alert("創建專案失敗: " + error.message)
        }
      }

      // 打開配置Modal
      async function openConfigModal(projectId) {
        currentProjectId = projectId
        const project = projects.find((p) => p.id === projectId)

        if (!project) {
          alert("找不到專案")
          return
        }

        projectDevices = [...project.devices]
        projectCheckItems = [...project.checkItems]

        renderConfigModal(project)
        document.getElementById("config-modal").style.display = "block"
      }

      // 渲染配置Modal內容
      function renderConfigModal(project) {
        const content = document.getElementById("config-content")
        content.innerHTML = `
                <h4 style="color: #06c755; margin-bottom: 20px;">${project.name} - 專案配置</h4>
                
                <!-- 檢查項目配置（原設備配置） -->
                <div class="config-section">
                    <div class="config-title">
                        <i class="fas fa-desktop"></i> 檢查項目配置
                        <div style="font-size: 12px; color: #666; font-weight: normal; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> 可拖拽 <i class="fas fa-grip-vertical" style="color: #06c755;"></i> 圖示重新排序（支援觸控）
                        </div>
                    </div>
                    <div class="add-config-form">
                        <div class="form-row">
                            <div style="flex: 1;">
                                <input type="text" id="new-device-name" class="form-control" placeholder="檢查項目名稱（名稱將作為代碼使用）" maxlength="100">
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="addDevice()">
                                    <i class="fas fa-plus"></i> 添加
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="devices-list" class="config-list"></div>
                </div>
                
                <!-- 檢查結果配置（原檢查項目配置） -->
                <div class="config-section">
                    <div class="config-title">
                        <i class="fas fa-clipboard-check"></i> 檢查結果配置
                        <div style="font-size: 12px; color: #666; font-weight: normal; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> 可拖拽 <i class="fas fa-grip-vertical" style="color: #06c755;"></i> 圖示重新排序（支援觸控）
                        </div>
                    </div>
                    <div class="add-config-form">
                        <div class="form-row">
                            <div style="flex: 1;">
                                <input type="text" id="new-item-name" class="form-control" placeholder="檢查結果名稱（名稱將作為代碼使用）" maxlength="100">
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="addCheckItem()">
                                    <i class="fas fa-plus"></i> 添加
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="checkitems-list" class="config-list"></div>
                </div>
            `

        renderDevicesList()
        renderCheckItemsList()
      }

      // 渲染設備列表（現在是檢查項目）
      function renderDevicesList() {
        const container = document.getElementById("devices-list")

        if (projectDevices.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">尚無檢查項目配置</div>'
          return
        }

        // 按照 sortOrder 排序
        projectDevices.sort((a, b) => a.sortOrder - b.sortOrder)

        container.innerHTML = projectDevices
          .map((device, index) => {
            // 解析參考圖片
            let images = []
            try {
              images =
                device.referenceImages || device.ReferenceImages
                  ? JSON.parse(device.referenceImages || device.ReferenceImages)
                  : []
            } catch (e) {
              images = []
            }

            return `
                <div class="config-item" draggable="true" 
                     ondragstart="dragStart(event, ${index})" 
                     ondragover="dragOver(event)" 
                     ondrop="dropDevice(event, ${index})"
                     ontouchstart="handleTouchStart(event, ${index}, 'device')"
                     style="touch-action: none;">
                    <div class="config-item-info">
                        <div class="config-item-name">
                          <i class="fas fa-grip-vertical" style="color: #ccc; margin-right: 8px; cursor: move;"></i>
                          ${device.deviceName}
                        </div>
                        <div class="config-item-code">代碼: ${
                          device.deviceCode
                        }</div>
                        ${
                          images.length > 0
                            ? `
                        <div style="margin-top: 8px;">
                          <button class="btn btn-info btn-sm view-images-btn" data-item-name="${
                            device.deviceName
                          }" data-images='${
                                device.referenceImages ||
                                device.ReferenceImages ||
                                "[]"
                              }'>
                            <i class="fas fa-images"></i> 查看圖片 (${
                              images.length
                            })
                          </button>
                        </div>
                        `
                            : `<div style="margin-top: 8px; color: #999; font-size: 12px;">尚無參考圖片</div>`
                        }
                    </div>
                    <div class="config-item-actions">
                        <button class="btn btn-secondary btn-sm" onclick="uploadDeviceImages('${
                          device.id || device.Id
                        }', '${device.deviceName}')" title="上傳參考圖片">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeDevice(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `
          })
          .join("")
      }

      // 渲染檢查項目列表（現在是檢查結果）
      function renderCheckItemsList() {
        const container = document.getElementById("checkitems-list")

        if (projectCheckItems.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">尚無檢查結果配置</div>'
          return
        }

        // 按照 sortOrder 排序
        projectCheckItems.sort((a, b) => a.sortOrder - b.sortOrder)

        container.innerHTML = projectCheckItems
          .map((item, index) => {
            // 解析參考圖片
            let images = []
            try {
              images =
                item.referenceImages || item.ReferenceImages
                  ? JSON.parse(item.referenceImages || item.ReferenceImages)
                  : []
            } catch (e) {
              images = []
            }

            return `
                <div class="config-item" draggable="true" 
                     ondragstart="dragStart(event, ${index})" 
                     ondragover="dragOver(event)" 
                     ondrop="dropCheckItem(event, ${index})"
                     ontouchstart="handleTouchStart(event, ${index}, 'checkitem')"
                     style="touch-action: none;">
                    <div class="config-item-info">
                        <div class="config-item-name">
                          <i class="fas fa-grip-vertical" style="color: #ccc; margin-right: 8px; cursor: move;"></i>
                          ${item.itemName}
                        </div>
                        <div class="config-item-code">代碼: ${
                          item.itemCode
                        }</div>
                        ${
                          images.length > 0
                            ? `
                        <div style="margin-top: 8px;">
                          <button class="btn btn-info btn-sm view-images-btn" data-item-name="${
                            item.itemName
                          }" data-images='${
                                item.referenceImages ||
                                item.ReferenceImages ||
                                "[]"
                              }'>
                            <i class="fas fa-images"></i> 查看圖片 (${
                              images.length
                            })
                          </button>
                        </div>
                        `
                            : `<div style="margin-top: 8px; color: #999; font-size: 12px;">尚無參考圖片</div>`
                        }
                    </div>
                    <div class="config-item-actions">
                        <button class="btn btn-secondary btn-sm" onclick="uploadItemImages('${
                          item.id || item.Id
                        }', '${item.itemName}')" title="上傳參考圖片">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeCheckItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
              `
          })
          .join("")
      }

      // 添加設備（現在是檢查項目）
      function addDevice() {
        const name = document.getElementById("new-device-name").value.trim()

        if (!name) {
          alert("請輸入檢查項目名稱")
          return
        }

        // 使用名稱作為代碼，檢查是否重複
        if (projectDevices.some((d) => d.deviceCode === name)) {
          alert("檢查項目名稱已存在")
          return
        }

        projectDevices.push({
          id: null,
          deviceName: name,
          deviceCode: name, // 代碼與名稱相同
          isActive: true,
          sortOrder: projectDevices.length,
        })

        // 清空輸入框
        document.getElementById("new-device-name").value = ""

        renderDevicesList()
      }

      // 移除設備（現在是檢查項目）
      function removeDevice(index) {
        if (confirm("確定要移除此檢查項目嗎？")) {
          projectDevices.splice(index, 1)
          renderDevicesList()
        }
      }

      // 添加檢查項目（現在是檢查結果）
      function addCheckItem() {
        const name = document.getElementById("new-item-name").value.trim()

        if (!name) {
          alert("請輸入檢查結果名稱")
          return
        }

        // 使用名稱作為代碼，檢查是否重複
        if (projectCheckItems.some((i) => i.itemCode === name)) {
          alert("檢查結果名稱已存在")
          return
        }

        projectCheckItems.push({
          id: null,
          itemName: name,
          itemCode: name, // 代碼與名稱相同
          isActive: true,
          sortOrder: projectCheckItems.length,
        })

        // 清空輸入框
        document.getElementById("new-item-name").value = ""

        renderCheckItemsList()
      }

      // 移除檢查項目（現在是檢查結果）
      function removeCheckItem(index) {
        if (confirm("確定要移除此檢查結果嗎？")) {
          projectCheckItems.splice(index, 1)
          renderCheckItemsList()
        }
      }

      // 保存專案配置
      async function saveProjectConfig() {
        if (!currentProjectId) return

        try {
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${currentProjectId}/config`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                projectId: currentProjectId,
                devices: projectDevices.map((device, index) => ({
                  projectId: currentProjectId,
                  deviceName: device.deviceName,
                  deviceCode: device.deviceCode,
                  isActive: device.isActive,
                  sortOrder: index,
                  referenceImages:
                    device.referenceImages || device.ReferenceImages, // 保留參考圖片資料
                })),
                checkItems: projectCheckItems.map((item, index) => ({
                  projectId: currentProjectId,
                  itemName: item.itemName,
                  itemCode: item.itemCode,
                  isActive: item.isActive,
                  sortOrder: index,
                  referenceImages: item.referenceImages || item.ReferenceImages, // 保留參考圖片資料
                })),
              }),
            }
          )

          if (!response.ok) {
            const error = await response.json()
            throw new Error(error.message || "保存配置失敗")
          }

          alert("配置保存成功！")
          closeConfigModal()
          loadProjects() // 重新載入專案列表
        } catch (error) {
          console.error("保存配置失敗:", error)
          alert("保存配置失敗: " + error.message)
        }
      }

      // 關閉配置Modal
      function closeConfigModal() {
        document.getElementById("config-modal").style.display = "none"
        currentProjectId = null
        projectDevices = []
        projectCheckItems = []
      }

      // 打開編輯Modal
      function openEditModal(projectId) {
        const project = projects.find((p) => p.id === projectId)
        if (!project) {
          alert("找不到專案")
          return
        }

        document.getElementById("edit-project-id").value = project.id
        document.getElementById("edit-project-name").value = project.name
        document.getElementById("edit-project-description").value =
          project.description || ""
        document.getElementById("edit-project-active").checked =
          project.isActive

        document.getElementById("edit-modal").style.display = "block"
      }

      // 關閉編輯Modal
      function closeEditModal() {
        document.getElementById("edit-modal").style.display = "none"
      }

      // 更新專案
      async function updateProject() {
        const id = document.getElementById("edit-project-id").value
        const name = document.getElementById("edit-project-name").value.trim()
        const description = document
          .getElementById("edit-project-description")
          .value.trim()
        const isActive = document.getElementById("edit-project-active").checked

        if (!name) {
          alert("請輸入專案名稱")
          return
        }

        try {
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: name,
                description: description,
                isActive: isActive,
              }),
            }
          )

          if (!response.ok) {
            const error = await response.json()
            throw new Error(error.message || "更新專案失敗")
          }

          alert("專案更新成功！")
          closeEditModal()
          loadProjects()
        } catch (error) {
          console.error("更新專案失敗:", error)
          alert("更新專案失敗: " + error.message)
        }
      }

      // 刪除專案
      async function deleteProject(projectId, projectName) {
        if (
          !confirm(
            `確定要刪除專案「${projectName}」嗎？\n\n注意：如果該專案已有檢查記錄，將無法刪除。`
          )
        ) {
          return
        }

        try {
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${projectId}`,
            {
              method: "DELETE",
            }
          )

          if (!response.ok) {
            const error = await response.json()
            throw new Error(error.message || "刪除專案失敗")
          }

          alert("專案刪除成功！")
          loadProjects()
        } catch (error) {
          console.error("刪除專案失敗:", error)
          alert("刪除專案失敗: " + error.message)
        }
      }

      // 點擊Modal外部關閉
      window.onclick = function (event) {
        const configModal = document.getElementById("config-modal")
        const editModal = document.getElementById("edit-modal")
        const imageModal = document.getElementById("image-modal")

        if (event.target === configModal) {
          closeConfigModal()
        }
        if (event.target === editModal) {
          closeEditModal()
        }
        if (event.target === imageModal) {
          closeImageModal()
        }
      }

      // ============ 拖拽排序功能 ============
      let draggedIndex = -1

      // 觸控拖拽相關變數
      let touchDragInfo = {
        isDragging: false,
        draggedElement: null,
        draggedIndex: -1,
        startY: 0,
        currentY: 0,
        placeholder: null,
        type: "", // 'device' 或 'checkitem'
      }

      function dragStart(event, index) {
        draggedIndex = index
        event.dataTransfer.effectAllowed = "move"
      }

      function dragOver(event) {
        event.preventDefault()
        event.dataTransfer.dropEffect = "move"
      }

      // ============ 觸控拖拽功能 ============
      function handleTouchStart(event, index, type) {
        // 防止預設的滾動行為
        event.preventDefault()

        const touch = event.touches[0]
        const element = event.currentTarget

        touchDragInfo = {
          isDragging: false,
          draggedElement: element,
          draggedIndex: index,
          startY: touch.clientY,
          currentY: touch.clientY,
          placeholder: null,
          type: type,
        }

        // 添加觸控移動和結束事件監聽器
        document.addEventListener("touchmove", handleTouchMove, {
          passive: false,
        })
        document.addEventListener("touchend", handleTouchEnd)

        // 延遲開始拖拽，避免誤觸
        setTimeout(() => {
          if (touchDragInfo.draggedElement) {
            startTouchDrag()
          }
        }, 150)
      }

      function startTouchDrag() {
        if (!touchDragInfo.draggedElement) return

        touchDragInfo.isDragging = true

        // 創建拖拽效果
        touchDragInfo.draggedElement.style.transform = "scale(1.05)"
        touchDragInfo.draggedElement.style.zIndex = "1000"
        touchDragInfo.draggedElement.style.boxShadow =
          "0 8px 20px rgba(0,0,0,0.3)"
        touchDragInfo.draggedElement.style.transition = "none"
        touchDragInfo.draggedElement.style.opacity = "0.9"

        // 創建佔位符
        createPlaceholder()
      }

      function createPlaceholder() {
        const placeholder = document.createElement("div")
        placeholder.className = "drag-placeholder"
        placeholder.style.cssText = `
          height: ${touchDragInfo.draggedElement.offsetHeight}px;
          margin: 10px 0;
          border: 2px dashed #06c755;
          border-radius: 8px;
          background: rgba(6, 199, 85, 0.1);
          display: flex;
          align-items: center;
          justify-content: center;
          color: #06c755;
          font-weight: bold;
          transition: all 0.2s ease;
        `
        placeholder.innerHTML =
          '<i class="fas fa-hand-point-down"></i> 放置在此處'

        touchDragInfo.placeholder = placeholder
        touchDragInfo.draggedElement.parentNode.insertBefore(
          placeholder,
          touchDragInfo.draggedElement.nextSibling
        )
      }

      function handleTouchMove(event) {
        if (!touchDragInfo.isDragging) {
          // 檢查是否移動距離足夠開始拖拽
          const touch = event.touches[0]
          const deltaY = Math.abs(touch.clientY - touchDragInfo.startY)

          if (deltaY > 10) {
            startTouchDrag()
          }
          return
        }

        event.preventDefault()

        const touch = event.touches[0]
        touchDragInfo.currentY = touch.clientY

        // 移動拖拽元素
        const deltaY = touch.clientY - touchDragInfo.startY
        touchDragInfo.draggedElement.style.transform = `translateY(${deltaY}px) scale(1.05)`

        // 尋找目標位置
        findDropTarget(touch.clientY)
      }

      function findDropTarget(y) {
        const items =
          touchDragInfo.type === "device"
            ? document.querySelectorAll(
                '#devices-list .config-item:not([style*="z-index: 1000"])'
              )
            : document.querySelectorAll(
                '#checkitems-list .config-item:not([style*="z-index: 1000"])'
              )

        let targetElement = null
        let insertBefore = true

        items.forEach((item, index) => {
          const rect = item.getBoundingClientRect()
          const midY = rect.top + rect.height / 2

          if (y < midY && !targetElement) {
            targetElement = item
            insertBefore = true
          } else if (y >= midY) {
            targetElement = item
            insertBefore = false
          }
        })

        // 移動佔位符到目標位置
        if (targetElement && touchDragInfo.placeholder) {
          if (insertBefore) {
            targetElement.parentNode.insertBefore(
              touchDragInfo.placeholder,
              targetElement
            )
          } else {
            targetElement.parentNode.insertBefore(
              touchDragInfo.placeholder,
              targetElement.nextSibling
            )
          }
        } else if (!targetElement && touchDragInfo.placeholder) {
          // 如果沒有目標元素，放到列表末尾
          const container =
            touchDragInfo.type === "device"
              ? document.getElementById("devices-list")
              : document.getElementById("checkitems-list")
          container.appendChild(touchDragInfo.placeholder)
        }
      }

      function handleTouchEnd(event) {
        document.removeEventListener("touchmove", handleTouchMove)
        document.removeEventListener("touchend", handleTouchEnd)

        if (!touchDragInfo.isDragging) {
          // 如果沒有開始拖拽，恢復原狀
          resetTouchDrag()
          return
        }

        // 計算最終位置
        const finalIndex = calculateFinalIndex()

        // 執行移動操作
        if (finalIndex !== -1 && finalIndex !== touchDragInfo.draggedIndex) {
          if (touchDragInfo.type === "device") {
            moveDeviceToIndex(touchDragInfo.draggedIndex, finalIndex)
          } else {
            moveCheckItemToIndex(touchDragInfo.draggedIndex, finalIndex)
          }
        }

        // 恢復元素狀態
        resetTouchDrag()
      }

      function calculateFinalIndex() {
        if (!touchDragInfo.placeholder) return -1

        const container =
          touchDragInfo.type === "device"
            ? document.getElementById("devices-list")
            : document.getElementById("checkitems-list")

        const items = Array.from(container.children)
        const placeholderIndex = items.indexOf(touchDragInfo.placeholder)

        if (placeholderIndex === -1) return -1

        // 調整索引（考慮原始元素的位置）
        return placeholderIndex > touchDragInfo.draggedIndex
          ? placeholderIndex - 1
          : placeholderIndex
      }

      function moveDeviceToIndex(fromIndex, toIndex) {
        const draggedDevice = projectDevices[fromIndex]
        projectDevices.splice(fromIndex, 1)
        projectDevices.splice(toIndex, 0, draggedDevice)

        // 更新 sortOrder
        projectDevices.forEach((device, index) => {
          device.sortOrder = index
        })

        renderDevicesList()
        saveDeviceOrder()
      }

      function moveCheckItemToIndex(fromIndex, toIndex) {
        const draggedItem = projectCheckItems[fromIndex]
        projectCheckItems.splice(fromIndex, 1)
        projectCheckItems.splice(toIndex, 0, draggedItem)

        // 更新 sortOrder
        projectCheckItems.forEach((item, index) => {
          item.sortOrder = index
        })

        renderCheckItemsList()
        saveCheckItemOrder()
      }

      function resetTouchDrag() {
        if (touchDragInfo.draggedElement) {
          // 恢復元素樣式
          touchDragInfo.draggedElement.style.transform = ""
          touchDragInfo.draggedElement.style.zIndex = ""
          touchDragInfo.draggedElement.style.boxShadow = ""
          touchDragInfo.draggedElement.style.transition = ""
          touchDragInfo.draggedElement.style.opacity = ""
          touchDragInfo.draggedElement.classList.remove("dragging")
        }

        // 移除佔位符
        if (touchDragInfo.placeholder && touchDragInfo.placeholder.parentNode) {
          touchDragInfo.placeholder.parentNode.removeChild(
            touchDragInfo.placeholder
          )
        }

        // 重置拖拽資訊
        touchDragInfo = {
          isDragging: false,
          draggedElement: null,
          draggedIndex: -1,
          startY: 0,
          currentY: 0,
          placeholder: null,
          type: "",
        }
      }

      function dropDevice(event, targetIndex) {
        event.preventDefault()

        if (draggedIndex === -1 || draggedIndex === targetIndex) return

        // 重新排列設備陣列
        const draggedDevice = projectDevices[draggedIndex]
        projectDevices.splice(draggedIndex, 1)
        projectDevices.splice(targetIndex, 0, draggedDevice)

        // 更新 sortOrder
        projectDevices.forEach((device, index) => {
          device.sortOrder = index
        })

        renderDevicesList()
        draggedIndex = -1

        // 保存新的順序到伺服器
        saveDeviceOrder()
      }

      function dropCheckItem(event, targetIndex) {
        event.preventDefault()

        if (draggedIndex === -1 || draggedIndex === targetIndex) return

        // 重新排列檢查項目陣列
        const draggedItem = projectCheckItems[draggedIndex]
        projectCheckItems.splice(draggedIndex, 1)
        projectCheckItems.splice(targetIndex, 0, draggedItem)

        // 更新 sortOrder
        projectCheckItems.forEach((item, index) => {
          item.sortOrder = index
        })

        renderCheckItemsList()
        draggedIndex = -1

        // 保存新的順序到伺服器
        saveCheckItemOrder()
      }

      // 保存設備順序
      async function saveDeviceOrder() {
        if (!currentProjectId) return

        try {
          // 只處理已存在於資料庫的設備 (有 ID 的)
          const existingDevices = projectDevices.filter((device) => device.id)

          const orderData = existingDevices.map((device) => ({
            DeviceId: device.id,
            SortOrder: device.sortOrder,
          }))

          if (orderData.length === 0) {
            console.log("沒有需要更新順序的設備")
            return
          }

          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${currentProjectId}/devices/reorder`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(orderData),
            }
          )

          if (!response.ok) {
            const errorData = await response.json()
            throw new Error(errorData.message || "保存設備順序失敗")
          }

          console.log("設備順序保存成功")
        } catch (error) {
          console.error("保存設備順序失敗:", error)
          alert("保存設備順序失敗: " + error.message)
        }
      }

      // 保存檢查項目順序
      async function saveCheckItemOrder() {
        if (!currentProjectId) return

        try {
          // 只處理已存在於資料庫的檢查項目 (有 ID 的)
          const existingItems = projectCheckItems.filter((item) => item.id)

          const orderData = existingItems.map((item) => ({
            ItemId: item.id,
            SortOrder: item.sortOrder,
          }))

          if (orderData.length === 0) {
            console.log("沒有需要更新順序的檢查項目")
            return
          }

          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${currentProjectId}/check-items/reorder`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(orderData),
            }
          )

          if (!response.ok) {
            const errorData = await response.json()
            throw new Error(errorData.message || "保存檢查項目順序失敗")
          }

          console.log("檢查項目順序保存成功")
        } catch (error) {
          console.error("保存檢查項目順序失敗:", error)
          alert("保存檢查項目順序失敗: " + error.message)
        }
      }

      // ============ 圖片管理功能 ============

      // 重新載入當前專案配置
      async function reloadCurrentProjectConfig() {
        try {
          // 重新載入專案詳情以獲取最新的圖片資訊
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${currentProjectId}`
          )
          if (!response.ok) {
            throw new Error("載入專案配置失敗")
          }

          const project = await response.json()

          // 更新當前的設備和檢查項目陣列
          projectDevices = [...project.devices]
          projectCheckItems = [...project.checkItems]

          // 重新渲染列表
          renderDevicesList()
          renderCheckItemsList()

          console.log("專案配置重新載入完成")
        } catch (error) {
          console.error("重新載入專案配置失敗:", error)
        }
      }

      // 查看檢查項目圖片
      function viewItemImages(itemName, imagesJson) {
        try {
          const images = JSON.parse(imagesJson || "[]")
          if (images.length === 0) {
            alert("該項目沒有參考圖片")
            return
          }

          // 取得目前專案資訊
          const currentProject = projects.find((p) => p.id === currentProjectId)
          const projectName = currentProject ? currentProject.name : "未知專案"

          openImageModal(images, 0, projectName, itemName)
        } catch (error) {
          console.error("解析圖片資料失敗:", error)
          alert("無法載入圖片: " + error.message)
        }
      }

      // 上傳檢查項目圖片
      function uploadItemImages(itemId, itemName) {
        // 創建檔案選擇器
        const fileInput = document.createElement("input")
        fileInput.type = "file"
        fileInput.accept = "image/*"
        fileInput.multiple = true
        fileInput.style.display = "none"

        fileInput.onchange = async function (event) {
          const files = event.target.files
          if (!files || files.length === 0) return

          if (files.length > 3) {
            alert("最多只能選擇3張圖片")
            return
          }

          try {
            const formData = new FormData()
            for (let i = 0; i < files.length; i++) {
              formData.append("files", files[i])
            }

            const response = await fetch(
              `${base_url}api/ProjectManagement/check-items/${itemId}/upload-images`,
              {
                method: "POST",
                body: formData,
              }
            )

            if (!response.ok) {
              const error = await response.json()
              throw new Error(error.message || "上傳圖片失敗")
            }

            const result = await response.json()
            alert(`圖片上傳成功！已上傳 ${result.uploadedCount} 張圖片`)

            // 重新載入專案配置以更新圖片資訊
            if (currentProjectId) {
              await reloadCurrentProjectConfig()
            }
          } catch (error) {
            console.error("上傳圖片失敗:", error)
            alert("上傳圖片失敗: " + error.message)
          }
        }

        document.body.appendChild(fileInput)
        fileInput.click()
        document.body.removeChild(fileInput)
      }

      // 上傳設備圖片（現在是檢查項目圖片）
      function uploadDeviceImages(deviceId, deviceName) {
        // 創建檔案選擇器
        const fileInput = document.createElement("input")
        fileInput.type = "file"
        fileInput.accept = "image/*"
        fileInput.multiple = true
        fileInput.style.display = "none"

        fileInput.onchange = async function (event) {
          const files = event.target.files
          if (!files || files.length === 0) return

          if (files.length > 3) {
            alert("最多只能選擇3張圖片")
            return
          }

          try {
            const formData = new FormData()
            for (let i = 0; i < files.length; i++) {
              formData.append("files", files[i])
            }

            const response = await fetch(
              `${base_url}api/ProjectManagement/devices/${deviceId}/upload-images`,
              {
                method: "POST",
                body: formData,
              }
            )

            if (!response.ok) {
              const error = await response.json()
              throw new Error(error.message || "上傳圖片失敗")
            }

            const result = await response.json()
            alert(`圖片上傳成功！已上傳 ${result.uploadedCount} 張圖片`)

            // 重新載入專案配置以更新圖片資訊
            if (currentProjectId) {
              await reloadCurrentProjectConfig()
            }
          } catch (error) {
            console.error("上傳圖片失敗:", error)
            alert("上傳圖片失敗: " + error.message)
          }
        }

        document.body.appendChild(fileInput)
        fileInput.click()
        document.body.removeChild(fileInput)
      }
    </script>

    <!-- 圖片查看 Modal -->
    <div id="image-modal" class="modal">
      <div
        class="modal-content"
        style="max-width: 90%; max-height: 90%; position: relative"
      >
        <div class="modal-header">
          <div>
            <h3 id="image-modal-title">參考圖片</h3>
            <p
              id="image-modal-subtitle"
              style="margin: 0; opacity: 0.8; font-size: 14px"
            ></p>
          </div>
          <span class="close" onclick="closeImageModal()">&times;</span>
        </div>
        <div class="modal-body" style="text-align: center; padding: 20px">
          <div
            id="image-container"
            style="position: relative; display: inline-block; max-width: 100%"
          >
            <img
              id="modal-image"
              src=""
              alt="參考圖片"
              style="
                max-width: 100%;
                max-height: 75vh;
                width: auto;
                height: auto;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
              "
            />

            <!-- 導航按鈕 -->
            <button
              id="prev-btn"
              onclick="prevImage()"
              style="
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                cursor: pointer;
                font-size: 18px;
              "
            >
              ‹
            </button>

            <button
              id="next-btn"
              onclick="nextImage()"
              style="
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                cursor: pointer;
                font-size: 18px;
              "
            >
              ›
            </button>
          </div>

          <!-- 圖片資訊 -->
          <div id="image-info" style="margin-top: 10px; color: #666">
            <span id="image-counter">1 / 1</span>
          </div>

          <!-- 縮放控制 -->
          <div style="margin-top: 15px">
            <button onclick="zoomOut()" class="btn btn-secondary btn-sm">
              <i class="fas fa-search-minus"></i> 縮小
            </button>
            <button onclick="resetZoom()" class="btn btn-secondary btn-sm">
              <i class="fas fa-search"></i> 原始大小
            </button>
            <button onclick="zoomIn()" class="btn btn-secondary btn-sm">
              <i class="fas fa-search-plus"></i> 放大
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 圖片查看相關變數
      let currentImages = []
      let currentImageIndex = 0
      let imageZoom = 1

      // 開啟圖片 Modal
      function openImageModal(
        images,
        startIndex = 0,
        projectName = "",
        itemName = ""
      ) {
        const modal = document.getElementById("image-modal")
        const modalImage = document.getElementById("modal-image")
        const modalTitle = document.getElementById("image-modal-title")
        const modalSubtitle = document.getElementById("image-modal-subtitle")

        currentImages = images || []
        currentImageIndex = startIndex
        imageZoom = 1

        if (currentImages.length === 0) {
          alert("沒有可顯示的圖片")
          return
        }

        // 設定標題和副標題
        modalTitle.textContent = "參考圖片"
        if (projectName && itemName) {
          modalSubtitle.textContent = `專案：${projectName} | 項目：${itemName}`
        } else {
          modalSubtitle.textContent = ""
        }

        showCurrentImage()
        modal.style.display = "flex"

        // 設定導航按鈕顯示
        document.getElementById("prev-btn").style.display =
          currentImages.length > 1 ? "block" : "none"
        document.getElementById("next-btn").style.display =
          currentImages.length > 1 ? "block" : "none"
      }

      // 關閉圖片 Modal
      function closeImageModal() {
        document.getElementById("image-modal").style.display = "none"
        currentImages = []
        currentImageIndex = 0
        imageZoom = 1
      }

      // 顯示當前圖片
      function showCurrentImage() {
        const modalImage = document.getElementById("modal-image")
        const imageCounter = document.getElementById("image-counter")

        if (currentImages.length === 0) return

        // 判斷是本地圖片還是外部URL
        const imagePath = currentImages[currentImageIndex]
        if (
          imagePath.startsWith("http://") ||
          imagePath.startsWith("https://")
        ) {
          modalImage.src = imagePath // 外部URL直接使用
        } else {
          modalImage.src = `/${imagePath}` // 本地圖片添加根路徑
        }

        modalImage.style.transform = `scale(${imageZoom})`
        imageCounter.textContent = `${currentImageIndex + 1} / ${
          currentImages.length
        }`
      }

      // 上一張圖片
      function prevImage() {
        if (currentImages.length <= 1) return
        currentImageIndex =
          (currentImageIndex - 1 + currentImages.length) % currentImages.length
        showCurrentImage()
      }

      // 下一張圖片
      function nextImage() {
        if (currentImages.length <= 1) return
        currentImageIndex = (currentImageIndex + 1) % currentImages.length
        showCurrentImage()
      }

      // 放大圖片
      function zoomIn() {
        imageZoom = Math.min(imageZoom * 1.2, 3)
        showCurrentImage()
      }

      // 縮小圖片
      function zoomOut() {
        imageZoom = Math.max(imageZoom / 1.2, 0.5)
        showCurrentImage()
      }

      // 重設縮放
      function resetZoom() {
        imageZoom = 1
        showCurrentImage()
      }

      // 鍵盤控制
      document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("image-modal")
        if (modal.style.display !== "flex") return

        switch (e.key) {
          case "ArrowLeft":
            prevImage()
            break
          case "ArrowRight":
            nextImage()
            break
          case "Escape":
            closeImageModal()
            break
          case "+":
          case "=":
            zoomIn()
            break
          case "-":
            zoomOut()
            break
          case "0":
            resetZoom()
            break
        }
      })
    </script>

    <!-- 版本號 -->
    <div
      style="
        text-align: center;
        padding: 20px;
        color: #999;
        font-size: 12px;
        border-top: 1px solid #eee;
        margin-top: 30px;
      "
    >
      版本 1.0.0.2
    </div>
  </body>
</html>
