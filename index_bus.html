<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>綁定與解除</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: "Noto Sans TC", Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        color: #333;
      }
      .container {
        max-width: 500px;
        margin: 30px auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }
      h2 {
        color: #06c755;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 15px;
      }
      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }
      .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 4px;
      }
      input,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border 0.3s;
        box-sizing: border-box;
      }
      input:focus,
      select:focus {
        border-color: #06c755;
        outline: none;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.1);
      }
      input.error,
      select.error {
        border-color: #e74c3c;
      }
      .error-message {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 5px;
        display: none;
      }
      .error-message.visible {
        display: block;
      }
      button {
        width: 100%;
        padding: 14px;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 10px;
      }
      button:hover {
        background-color: #04a73e;
        box-shadow: 0 4px 8px rgba(6, 199, 85, 0.2);
      }
      .secondary-button {
        background-color: #f1f1f1;
        color: #333;
      }
      .secondary-button:hover {
        background-color: #e5e5e5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .line-brand {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #999;
      }
      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }
      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        display: block;
      }
      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        display: block;
      }
      .status-message.info {
        background-color: #e7f3fe;
        color: #004085;
        display: block;
      }
      .confirmation-dialog {
        text-align: center;
        padding: 20px 0;
      }
      .confirmation-message {
        font-size: 18px;
        margin-bottom: 25px;
        line-height: 1.5;
      }
      .user-info {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: left;
        line-height: 1.6;
      }
      /* 對手機進行優化 */
      @media (max-width: 600px) {
        .container {
          margin: 15px;
          padding: 20px;
        }
        .button-group {
          flex-direction: column;
        }
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #06c755;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none;
      }
      .debug-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        font-size: 12px;
        color: #666;
        display: none;
      }

      .policy-links {
        text-align: center;
        margin-top: 15px;
        padding: 10px 0;
        border-top: 1px solid #f0f0f0;
      }

      .policy-links a {
        color: #06c755;
        text-decoration: none;
        font-size: 14px;
        padding: 5px 10px;
      }

      .policy-links a:hover {
        text-decoration: underline;
      }

      .policy-links .separator {
        color: #ccc;
        margin: 0 5px;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 25px;
        max-width: 90%;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .modal-header h3 {
        color: #06c755;
        margin: 0;
        font-weight: 600;
      }

      .modal-body {
        line-height: 1.6;
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
      }

      .modal-body h4 {
        color: #333;
        margin: 20px 0 10px 0;
        font-weight: 500;
      }

      .modal-body p {
        margin: 10px 0;
        color: #555;
      }

      .modal-footer {
        text-align: center;
        border-top: 1px solid #f0f0f0;
        padding-top: 15px;
      }

      .consent-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
        gap: 10px;
      }

      .consent-checkbox input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .consent-checkbox label {
        margin: 0;
        font-weight: normal;
        cursor: pointer;
      }

      /* 確保彈出視窗中的按鈕在移動端容易點擊 */
      .modal-footer button {
        min-height: 44px;
        min-width: 80px;
        font-size: 16px;
        touch-action: manipulation;
        z-index: 10001;
        position: relative;
        pointer-events: auto;
      }

      /* 確保彈出視窗在最上層 */
      .modal-overlay {
        z-index: 10000;
      }

      .modal-content {
        z-index: 10001;
        position: relative;
      }

      /* 調試樣式 - 讓關閉按鈕更明顯 */
      .modal-footer .secondary-button {
        background-color: #dc3545 !important;
        color: white !important;
        border: 2px solid #dc3545 !important;
      }

      .modal-footer .secondary-button:hover {
        background-color: #c82333 !important;
        border-color: #c82333 !important;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h2>綁定與解除</h2>

      <div id="statusMessage" class="status-message"></div>

      <!-- 確認解除綁定的對話框 -->
      <div id="unbindConfirmation" class="confirmation-dialog hidden">
        <div class="confirmation-message">您已經綁定，是否要解除綁定？</div>
        <div id="userInfoDisplay" class="user-info"></div>
        <div class="button-group">
          <button onclick="unbindUser()">是，我要解除綁定</button>
          <button class="secondary-button" onclick="closeWindowSafely()">
            否，保持綁定
          </button>
        </div>
      </div>
      <div class="line-brand">多功能平台-綁定與解除-v1.0.1.1</div>

      <!-- 政策連結 -->
      <div class="policy-links">
        <a href="#" onclick="showPrivacyPolicy()">隱私權政策</a>
        <span class="separator">|</span>
        <a href="#" onclick="showDataCollectionPolicy()">個人資料搜集政策</a>
      </div>

      <!-- 註冊表單 -->
      <form id="registerForm" class="hidden">
        <div class="form-group">
          <label for="company" class="required">公司別</label>
          <select id="company">
            <option value="">請選擇公司別</option>
            <option value="首都客運">首都客運</option>
            <option value="臺北客運">臺北客運</option>
            <option value="三重客運">三重客運</option>
            <option value="大都會客運">大都會客運</option>
            <option value="台中客運">台中客運</option>
          </select>
          <div class="error-message" id="company-error">公司別為必填欄位</div>
        </div>

        <div class="form-group">
          <label for="dept" class="required">部門</label>
          <select id="dept">
            <option value="">請選擇部門</option>
            <option value="董事長室">董事長室</option>
            <option value="總經理室">總經理室</option>
            <option value="企業工會">企業工會</option>
            <option value="業務部">業務部</option>
            <option value="人資部">人資部</option>
            <option value="財務部">財務部</option>
            <option value="機務部">機務部</option>
            <option value="修理廠">修理廠</option>
            <option value="總務部">總務部</option>
            <option value="資訊中心">資訊中心</option>
            <option value="勞安室">勞安室</option>
            <option value="(三重客運)中港站">(三重客運)中港站</option>
            <option value="(三重客運)五股二站">(三重客運)五股二站</option>
            <option value="(三重客運)五股站">(三重客運)五股站</option>
            <option value="(三重客運)八里站">(三重客運)八里站</option>
            <option value="(三重客運)公西站">(三重客運)公西站</option>
            <option value="(三重客運)南港站">(三重客運)南港站</option>
            <option value="(三重客運)土城站">(三重客運)土城站</option>
            <option value="(三重客運)新莊站">(三重客運)新莊站</option>
            <option value="(三重客運)林口站">(三重客運)林口站</option>
            <option value="(三重客運)樹林站">(三重客運)樹林站</option>
            <option value="(三重客運)淡水站">(三重客運)淡水站</option>
            <option value="(三重客運)蘆一站">(三重客運)蘆一站</option>
            <option value="(三重客運)蘆二站">(三重客運)蘆二站</option>
            <option value="(三重客運)迴龍站">(三重客運)迴龍站</option>
            <option value="(大都會客運)中和站">(大都會客運)中和站</option>
            <option value="(大都會客運)內湖站">(大都會客運)內湖站</option>
            <option value="(大都會客運)凌雲站">(大都會客運)凌雲站</option>
            <option value="(大都會客運)建北站">(大都會客運)建北站</option>
            <option value="(大都會客運)北客新店站">
              (大都會客運)北客新店站
            </option>
            <option value="(大都會客運)吳興街站">(大都會客運)吳興街站</option>
            <option value="(大都會客運)四海站">(大都會客運)四海站</option>
            <option value="(大都會客運)士林站">(大都會客運)士林站</option>
            <option value="(大都會客運)建北站">(大都會客運)建北站</option>
            <option value="(大都會客運)新莊站">(大都會客運)新莊站</option>
            <option value="(大都會客運)東園站">(大都會客運)東園站</option>
            <option value="(大都會客運)東湖站">(大都會客運)東湖站</option>
            <option value="(大都會客運)松德站">(大都會客運)松德站</option>
            <option value="(大都會客運)松職站">(大都會客運)松職站</option>
            <option value="(大都會客運)林口站">(大都會客運)林口站</option>
            <option value="(大都會客運)榮總站">(大都會客運)榮總站</option>
            <option value="(大都會客運)舊莊站">(大都會客運)舊莊站</option>
            <option value="(大都會客運)萬芳站">(大都會客運)萬芳站</option>
            <option value="(大都會客運)蘆洲站">(大都會客運)蘆洲站</option>
            <option value="(大都會客運)陽明山站">(大都會客運)陽明山站</option>
            <option value="(大都會客運)麟光站">(大都會客運)麟光站</option>
            <option value="(大都會客運)基隆站">(大都會客運)基隆站</option>
            <option value="(大都會客運)蘇澳站">(大都會客運)蘇澳站</option>
            <option value="(臺北客運)三峽一站">(臺北客運)三峽一站</option>
            <option value="(臺北客運)三峽二站">(臺北客運)三峽二站</option>
            <option value="(臺北客運)中和站">(臺北客運)中和站</option>
            <option value="(臺北客運)中華站">(臺北客運)中華站</option>
            <option value="(臺北客運)五福站">(臺北客運)五福站</option>
            <option value="(臺北客運)南雅站">(臺北客運)南雅站</option>
            <option value="(臺北客運)四海站">(臺北客運)四海站</option>
            <option value="(臺北客運)新店站">(臺北客運)新店站</option>
            <option value="(臺北客運)木柵站">(臺北客運)木柵站</option>
            <option value="(臺北客運)板橋前站">(臺北客運)板橋前站</option>
            <option value="(臺北客運)板橋後站">(臺北客運)板橋後站</option>
            <option value="(臺北客運)林口站">(臺北客運)林口站</option>
            <option value="(臺北客運)樹林站">(臺北客運)樹林站</option>
            <option value="(臺北客運)歡仔園站">(臺北客運)歡仔園站</option>
            <option value="(臺北客運)民生站">(臺北客運)民生站</option>
            <option value="(臺北客運)江子翠站">(臺北客運)江子翠站</option>
            <option value="(臺北客運)瑞芳站">(臺北客運)瑞芳站</option>
            <option value="(臺北客運)蘆洲站">(臺北客運)蘆洲站</option>
            <option value="(首都客運)三峽一站">(首都客運)三峽一站</option>
            <option value="(首都客運)三重一站">(首都客運)三重一站</option>
            <option value="(首都客運)三重二站">(首都客運)三重二站</option>
            <option value="(首都客運)二重站">(首都客運)二重站</option>
            <option value="(首都客運)內湖站">(首都客運)內湖站</option>
            <option value="(首都客運)南港站">(首都客運)南港站</option>
            <option value="(首都客運)士林站">(首都客運)士林站</option>
            <option value="(首都客運)安康站">(首都客運)安康站</option>
            <option value="(首都客運)新莊一站">(首都客運)新莊一站</option>
            <option value="(首都客運)新莊二站">(首都客運)新莊二站</option>
            <option value="(首都客運)東園站">(首都客運)東園站</option>
            <option value="(首都客運)板橋前站">(首都客運)板橋前站</option>
            <option value="(首都客運)板橋站">(首都客運)板橋站</option>
            <option value="(首都客運)汐止一站">(首都客運)汐止一站</option>
            <option value="(首都客運)汐止二站">(首都客運)汐止二站</option>
            <option value="(首都客運)社子站">(首都客運)社子站</option>
            <option value="(首都客運)經貿站">(首都客運)經貿站</option>
            <option value="(首都客運)安美站">(首都客運)安美站</option>
            <option value="其它單位">其它單位</option>
          </select>
          <div class="error-message" id="dept-error">部門為必填欄位</div>
        </div>

        <div class="form-group">
          <label for="job">職稱</label>
          <select id="job">
            <option value="">請選擇職稱</option>
            <option value="董事長">董事長</option>
            <option value="執董">執董</option>
            <option value="總經理">總經理</option>
            <option value="秘書">秘書</option>
            <option value="特助">特助</option>
            <option value="協理">協理</option>
            <option value="經理">經理</option>
            <option value="副理">副理</option>
            <option value="主任">主任</option>
            <option value="副主任">副主任</option>
            <option value="襄理">襄理</option>
            <option value="站長">站長</option>
            <option value="副站長">副站長</option>
            <option value="課長">課長</option>
            <option value="副課長">副課長</option>
            <option value="課員">課員</option>
            <option value="股長">股長</option>
            <option value="組長">組長</option>
            <option value="副組長">副組長</option>
            <option value="專員">專員</option>
            <option value="業務員">業務員</option>
            <option value="事務員">事務員</option>
            <option value="技術員">技術員</option>
            <option value="副技術員">副技術員</option>
            <option value="技工">技工</option>
            <option value="助理技工">助理技工</option>
            <option value="廠長">廠長</option>
            <option value="副廠長">副廠長</option>
            <option value="總監工">總監工</option>
            <option value="監工">監工</option>
            <option value="物料員">物料員</option>
            <option value="收銀員">收銀員</option>
            <option value="站務">站務</option>
            <option value="營業車駕駛長">營業車駕駛長</option>
            <option value="油罐車駕駛長">油罐車駕駛長</option>
            <option value="稽查員">稽查員</option>
            <option value="辦事員">辦事員</option>
            <option value="庶物員">庶物員</option>
            <option value="事務員">事務員</option>
          </select>
        </div>

        <div class="form-group">
          <label for="empId" class="required">員工編號</label>
          <input type="tel" id="empId" placeholder="請輸入員工編號" />
          <div class="error-message" id="empId-error">員工編號為必填欄位</div>
        </div>

        <div class="form-group">
          <label for="name" class="required">姓名</label>
          <input type="text" id="name" placeholder="請輸入姓名" />
          <div class="error-message" id="name-error">姓名為必填欄位</div>
        </div>

        <input type="hidden" id="userId" />
        <input type="hidden" id="channelId" />

        <button type="button" onclick="submitForm()">提交資料</button>
      </form>
      <div id="debugInfo" class="debug-info"></div>
    </div>

    <!-- 個人資料搜集政策彈出視窗 -->
    <div
      id="dataCollectionModal"
      class="modal-overlay hidden"
      onclick="closeDataCollectionModalIfBackground(event)"
    >
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>個人資料搜集政策</h3>
          <button
            style="
              position: absolute;
              top: 10px;
              right: 15px;
              background: #dc3545;
              color: white;
              border: none;
              border-radius: 50%;
              width: 30px;
              height: 30px;
              cursor: pointer;
              font-size: 18px;
              line-height: 1;
            "
            onclick="closeDataCollectionModal()"
            title="關閉"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          <div
            style="
              background-color: #fff3cd;
              padding: 15px;
              border-radius: 8px;
              border-left: 4px solid #ffc107;
              margin: 20px 0;
            "
          >
            <strong>重要提醒：</strong
            >本公司依據「個人資料保護法」規定，向您說明搜集、處理及利用個人資料之相關事項。請您詳細閱讀以下內容。
          </div>

          <h4>一、個人資料搜集目的</h4>
          <p>
            本系統依據個人資料保護法第8條及第9條規定，基於以下目的搜集您的個人資料：
          </p>
          <ul>
            <li>
              <strong>員工身分確認與權限管控：</strong
              >確認您的員工身分，提供相應的系統功能權限
            </li>
            <li>
              <strong>內部系統功能使用與管理：</strong
              >維護系統正常運作，提供個人化服務
            </li>
            <li>
              <strong>業務聯繫與通知服務：</strong
              >透過LINE等通訊管道提供重要業務通知
            </li>
            <li>
              <strong>問卷調查及電子公告等宣達文宣：</strong
              >透過LINE等通訊管道提供重要業務通知、問卷調查及相關資訊及教育宣導
            </li>
            <li>
              <strong>統計分析與服務改善：</strong
              >分析使用情形以改善系統功能與服務品質
            </li>
            <li>
              <strong>法令遵循與內控管理：</strong
              >配合相關法規要求及內部控制需要
            </li>
          </ul>

          <h4>二、搜集的個人資料類別</h4>
          <p>本系統可能搜集以下類別的個人資料：</p>
          <ul>
            <li><strong>識別資料：</strong>姓名、員工編號</li>
            <li><strong>特徵資料：</strong>公司別、部門、職稱</li>
            <li><strong>聯絡資料：</strong>電話號碼（如有提供）</li>
            <li>
              <strong>技術性資料：</strong
              >LINE用戶識別碼、頻道識別碼、裝置資訊、使用記錄
            </li>
            <li>
              <strong>其他：</strong>與業務相關之必要資訊，包括但不限於電子簽名
            </li>
          </ul>

          <h4>三、個人資料來源</h4>
          <p>本系統個人資料的來源包括：</p>
          <ul>
            <li>您主動於系統中填寫、輸入或上傳的資料</li>
            <li>系統自動記錄的使用行為與技術資訊</li>
            <li>經您同意後，從第三方平台（如LINE）取得的基本資料</li>
            <li>公司內部相關系統或人力資源部門提供的員工資料</li>
          </ul>

          <h4>四、個人資料利用期間、地區、對象及方式</h4>
          <p>
            <strong>利用期間：</strong
            >自搜集之日起至您主動解除綁定、離職或法定保存期限屆滿為止。
          </p>
          <p><strong>利用地區：</strong>中華民國境內。</p>
          <p>
            <strong>利用對象：</strong
            >本公司及其關係企業、經授權之系統管理人員、法定職權機關。
          </p>
          <p>
            <strong>利用方式：</strong
            >透過資訊系統、人工處理等方式，在法定目的範圍內進行處理及利用。
          </p>

          <h4>五、當事人依個人資料保護法第3條規定得行使之權利</h4>
          <p>
            依據個人資料保護法規定，您對於本系統蒐集之個人資料，得行使以下權利：
          </p>
          <ul>
            <li>
              <strong>查詢或請求閱覽：</strong>您可要求查詢或閱覽您的個人資料
            </li>
            <li><strong>請求製給複製本：</strong>您可要求提供個人資料複本</li>
            <li>
              <strong>請求補充或更正：</strong
              >當您的個人資料不正確或不完整時，可要求補充或更正
            </li>
            <li>
              <strong>請求停止蒐集、處理或利用：</strong
              >在特定情況下，您可要求停止處理您的個人資料
            </li>
            <li>
              <strong>請求刪除：</strong
              >在法定事由下，您可要求刪除您的個人資料，或自行刪除。
            </li>
          </ul>
          <p>
            <em
              >註：依法行使上述權利時，在法律允許範圍內，可能拒絕您的請求。</em
            >
          </p>

          <h4>六、不提供個人資料之影響</h4>
          <p>若您選擇不提供個人資料，可能導致以下影響：</p>
          <ul>
            <li>無法進行身分確認，無法使用本系統相關功能</li>
            <li>無法接收重要的業務通知或系統更新訊息</li>
            <li>無法享受個人化的服務內容</li>
            <li>可能影響業務流程的順利進行</li>
          </ul>

          <h4>七、資料安全維護措施</h4>
          <p>
            本公司採取適當的技術上及組織上措施，以防止個人資料被竊取、竄改、毀損、滅失或洩漏：
          </p>
          <ul>
            <li>實施存取控制機制，限制個人資料的存取權限</li>
            <li>建置資訊安全設備與防護措施</li>
            <li>定期進行系統安全檢測與更新</li>
            <li>對處理個人資料之人員進行教育訓練</li>
            <li>制定個人資料安全維護計畫與應變程序</li>
          </ul>

          <h4>八、政策更新</h4>
          <p>
            本政策內容可能隨法規異動或營運需要進行修正，修正後的政策將公告於系統中。建議您定期查閱最新版本的個人資料搜集政策。
          </p>

          <h4>九、聯絡方式</h4>
          <p>
            如您對本個人資料搜集政策有任何疑問，或欲行使個人資料保護法賦予您的相關權利，請聯繫：
          </p>
          <ul>
            <li><strong>聯絡部門：</strong>資訊中心</li>
            <li><strong>聯絡方式：</strong>02-87920358 #622~625</li>
            <li>
              <strong>服務時間：</strong>週一至週五 08:00-17:00（國定假日除外）
            </li>
          </ul>

          <div
            style="
              background-color: #fff3cd;
              padding: 15px;
              border-radius: 8px;
              border-left: 4px solid #ffc107;
              margin: 20px 0;
            "
          >
            <strong>同意聲明：</strong
            >當您點擊「同意」按鈕或繼續使用本系統服務時，即表示您已詳細閱讀、充分了解並同意本個人資料搜集政策之所有內容。
          </div>
        </div>
        <div id="dataCollectionConsentSection" class="consent-checkbox hidden">
          <input type="checkbox" id="dataCollectionConsent" />
          <label for="dataCollectionConsent"
            >我已閱讀並同意個人資料搜集政策</label
          >
        </div>
        <div class="modal-footer">
          <button
            id="dataCollectionCloseBtn"
            class="secondary-button"
            onclick="closeDataCollectionModal()"
          >
            關閉
          </button>
          <button
            id="dataCollectionAgreeBtn"
            class="hidden"
            onclick="agreeDataCollection()"
            disabled
          >
            同意並繼續
          </button>
        </div>
      </div>
    </div>

    <!-- 隱私權政策彈出視窗 -->
    <div
      id="privacyModal"
      class="modal-overlay hidden"
      onclick="closePrivacyModalIfBackground(event)"
    >
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>隱私權政策</h3>
          <button
            style="
              position: absolute;
              top: 10px;
              right: 15px;
              background: #dc3545;
              color: white;
              border: none;
              border-radius: 50%;
              width: 30px;
              height: 30px;
              cursor: pointer;
              font-size: 18px;
              line-height: 1;
            "
            onclick="closePrivacyModal()"
            title="關閉"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          <h4>一、隱私權保護政策適用範圍</h4>
          <p>
            本隱私權保護政策適用於本多功能平台系統內所有相關的網頁與應用程式。當您使用本系統服務，即表示您已閱讀、了解並同意本政策之所有內容。
          </p>

          <h4>二、個人資料的搜集、處理及利用方式</h4>
          <p>
            當您使用本系統服務時，我們會依據服務功能需要，搜集您的個人資料，並在合理範圍內處理及利用您的個人資料。我們搜集個人資料的方式包括：
          </p>
          <p>• 您主動提供的資料（如註冊資訊、聯絡資訊）</p>
          <p>• 系統自動收集的資料（如使用紀錄、裝置資訊）</p>
          <p>• 透過合法途徑從第三方取得的資料</p>

          <h4>三、資料之保護</h4>
          <p>本公司十分重視您個人資料的安全，採取以下措施保護您的個人資料：</p>
          <p>
            1.
            本系統主機設有防火牆、防毒系統等相關的各項資訊安全設備及必要的安全防護措施。
          </p>
          <p>
            2.
            僅有經過授權的人員才能接觸您的個人資料，相關處理人員皆簽有保密合約。
          </p>
          <p>
            3.
            如因業務需要有必要委託相關單位提供服務時，本公司亦會嚴格要求其遵守保密義務。
          </p>
          <p>4. 定期進行資訊安全檢測與更新，確保系統安全性。</p>

          <h4>四、網站對外的相關連結</h4>
          <p>
            本系統網頁提供其他網站的網路連結，您也可經由本系統連結至其他網站。但該連結網站不適用本系統的隱私權保護政策，您必須參考該連結網站中的隱私權保護政策。
          </p>

          <h4>五、與第三人共用個人資料之政策</h4>
          <p>
            本系統絕不會提供、交換、出租或出售任何您的個人資料給其他個人、團體、私人企業或公務機關，但有法律依據或合約義務者，不在此限。前述法律依據包括但不限於：
          </p>
          <p>• 司法機關或政府機關基於法定程序要求提供</p>
          <p>• 為保護本公司或第三人之權利、財產或安全</p>
          <p>• 與業務相關之合作夥伴，但僅限於提供服務所必要之範圍</p>

          <h4>六、Cookie之使用</h4>
          <p>
            為了提供您最佳的服務，本系統會在您的電腦中放置並取用Cookie，若您不願接受Cookie的寫入，您可在您使用的瀏覽器功能項中設定隱私權等級為高，即可拒絕Cookie的寫入，但可能會導致網站某些功能無法正常執行。
          </p>

          <h4>七、個人資料之查詢、更正與刪除</h4>
          <p>
            您可以隨時要求查詢、更正或刪除您的個人資料。如有相關需求，請透過系統功能或聯繫客服人員處理。
          </p>

          <h4>八、隱私權保護政策之修正</h4>
          <p>
            本系統隱私權保護政策將因應需求隨時進行修正，修正後的條款將刊登此頁。當您繼續使用本系統服務時，即表示您已閱讀、了解並同意修正後的隱私權保護政策。
          </p>

          <h4>九、聯絡資訊</h4>
          <p>若您對本隱私權保護政策有任何疑問或建議，請聯繫我們：</p>
          <p>• 聯繫部門：資訊中心</p>
          <p>• 聯絡電話：02-87920358 #622~625</p>
          <p>• 服務時間：週一至週五 08:00-17:00</p>
        </div>
        <div class="modal-footer">
          <button class="secondary-button" onclick="closePrivacyModal()">
            關閉
          </button>
        </div>
      </div>
    </div>

    <script>
      // 全局變量記錄初始化狀態
      let liffInitialized = false
      let dataCollectionAgreed = false // 記錄是否已同意個人資料搜集政策

      const base_url = (() => {
        // 檢查是否為本地開發環境
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return window.location.origin + "/"
        }
        // 生產環境使用指定的後端地址
        return "https://35.221.146.143.nip.io/linehook/"
      })()
      const channelId = "2006992891" //不同的服務要修改
      const liffId = "2006993665-PVAXZjA1".trim()

      // 初始化 LIFF
      window.onload = async function () {
        try {
          await initLIFF()
        } catch (error) {
          console.error("頁面載入時發生錯誤:", error)
          showStatusMessage("載入頁面時發生錯誤，請重新整理頁面", "error")
          hideLoading()
        }
      }

      // 顯示載入中
      function showLoading() {
        document.getElementById("loading-overlay").classList.remove("hidden")
      }

      // 隱藏載入中
      function hideLoading() {
        document.getElementById("loading-overlay").classList.add("hidden")
      }

      // 顯示調試信息
      function showDebugInfo(info) {
        const debugElement = document.getElementById("debugInfo")
        debugElement.style.display = "block"
        debugElement.innerHTML += info + "<br>"
      }

      // 初始化 LIFF SDK
      async function initLIFF() {
        try {
          // 確保 LIFF ID 格式正確（去除可能的空格）
          await liff.init({ liffId: liffId })

          // 記錄初始化成功
          liffInitialized = true
          console.log("LIFF 初始化成功")
          console.log("是否在 LINE 瀏覽器中:", liff.isInClient())
          console.log("LIFF SDK 版本:", liff.getVersion())
          console.log("裝置資訊:", navigator.userAgent)

          if (!liff.isLoggedIn()) {
            console.log("用戶未登入，引導登入...")
            // 如果用戶尚未登入 LINE，則引導登入
            liff.login()
            // 登入後會重新載入頁面，所以下面的代碼不會執行
            return
          }

          // 用戶已登入，獲取用戶資料
          try {
            const profile = await liff.getProfile()

            showDebugInfo("ChannelId: " + channelId)

            const userId = profile.userId
            document.getElementById("userId").value = userId
            document.getElementById("channelId").value = channelId

            // 自動填入姓名
            document.getElementById("name").value = profile.displayName || ""

            console.log("用戶已登入:", profile.displayName)

            // 檢查用戶是否已存在
            await checkUserExists(userId, channelId)
          } catch (profileError) {
            console.error("獲取用戶資料失敗:", profileError)
            showStatusMessage("無法獲取用戶資料，請確保已授權應用程式", "error")
            showDebugInfo("獲取用戶資料失敗: " + profileError.message)
            hideLoading()
          }
        } catch (error) {
          console.error("LIFF 初始化失敗:", error)
          showStatusMessage(
            "LINE 應用程式初始化失敗，請確認網路連接並重新嘗試",
            "error"
          )
          showDebugInfo("LIFF 初始化失敗: " + error.message)
          liffInitialized = false
          hideLoading()
        }
      }

      // 顯示個人資料搜集政策
      function showDataCollectionPolicy() {
        console.log("顯示個人資料搜集政策")
        const modal = document.getElementById("dataCollectionModal")
        if (modal) {
          modal.classList.remove("hidden")
          // 防止背景滾動
          document.body.style.overflow = "hidden"
          console.log("個人資料搜集政策彈出視窗已顯示")

          // 顯示關閉提示
          setTimeout(function () {
            console.log(
              "提示：您可以按 ESC 鍵、雙擊頁面、或長按 1.5 秒來關閉視窗"
            )
          }, 2000)
        } else {
          console.error("找不到個人資料搜集政策彈出視窗元素")
        }

        // 檢查是否需要顯示同意機制（未綁定且未同意）
        const isRegisterFormVisible = !document
          .getElementById("registerForm")
          .classList.contains("hidden")
        if (isRegisterFormVisible && !dataCollectionAgreed) {
          document
            .getElementById("dataCollectionConsentSection")
            .classList.remove("hidden")
          document
            .getElementById("dataCollectionAgreeBtn")
            .classList.remove("hidden")
          document.getElementById("dataCollectionCloseBtn").style.display =
            "none"
        }
      }

      // 顯示隱私權政策
      function showPrivacyPolicy() {
        console.log("顯示隱私權政策")
        const modal = document.getElementById("privacyModal")
        if (modal) {
          modal.classList.remove("hidden")
          // 防止背景滾動
          document.body.style.overflow = "hidden"
          console.log("隱私權政策彈出視窗已顯示")

          // 顯示關閉提示
          setTimeout(function () {
            console.log(
              "提示：您可以按 ESC 鍵、雙擊頁面、或長按 1.5 秒來關閉視窗"
            )
          }, 2000)

          // 添加一個臨時的全域點擊監聽器來強制關閉
          setTimeout(() => {
            document.addEventListener("click", forceCloseOnClick, true)
          }, 100)
        } else {
          console.error("找不到隱私權政策彈出視窗元素")
        }
      }

      // 強制點擊關閉處理器
      function forceCloseOnClick(event) {
        const modal = document.getElementById("privacyModal")
        const dataModal = document.getElementById("dataCollectionModal")

        if (modal && !modal.classList.contains("hidden")) {
          const modalContent = modal.querySelector(".modal-content")
          if (!modalContent.contains(event.target)) {
            closePrivacyModal()
            document.removeEventListener("click", forceCloseOnClick, true)
          }
        }

        if (dataModal && !dataModal.classList.contains("hidden")) {
          const modalContent = dataModal.querySelector(".modal-content")
          if (!modalContent.contains(event.target)) {
            closeDataCollectionModal()
            document.removeEventListener("click", forceCloseOnClick, true)
          }
        }
      }

      // 關閉個人資料搜集政策彈出視窗
      function closeDataCollectionModal() {
        console.log("關閉個人資料搜集政策")
        const modal = document.getElementById("dataCollectionModal")
        if (modal) {
          modal.classList.add("hidden")
          // 恢復背景滾動
          document.body.style.overflow = ""
          console.log("個人資料搜集政策彈出視窗已關閉")
        } else {
          console.error("找不到個人資料搜集政策彈出視窗元素")
        }
      }

      // 點擊背景關閉個人資料搜集政策彈出視窗
      function closeDataCollectionModalIfBackground(event) {
        if (event.target === event.currentTarget) {
          closeDataCollectionModal()
        }
      }

      // 關閉隱私權政策彈出視窗
      function closePrivacyModal() {
        console.log("關閉隱私權政策")
        const modal = document.getElementById("privacyModal")
        if (modal) {
          modal.classList.add("hidden")
          // 恢復背景滾動
          document.body.style.overflow = ""
          // 移除全域點擊監聽器
          document.removeEventListener("click", forceCloseOnClick, true)
          console.log("隱私權政策彈出視窗已關閉")
        } else {
          console.error("找不到隱私權政策彈出視窗元素")
        }
      }

      // 點擊背景關閉隱私權政策彈出視窗
      function closePrivacyModalIfBackground(event) {
        if (event.target === event.currentTarget) {
          closePrivacyModal()
        }
      }

      // 同意個人資料搜集政策
      function agreeDataCollection() {
        const checkbox = document.getElementById("dataCollectionConsent")
        if (!checkbox.checked) {
          alert("請先勾選同意個人資料搜集政策")
          return
        }

        dataCollectionAgreed = true
        localStorage.setItem("dataCollectionAgreed", "true") // 儲存同意狀態
        closeDataCollectionModal()
        showStatusMessage(
          "感謝您同意個人資料搜集政策，現在可以開始使用服務",
          "success"
        )

        // 顯示註冊表單
        setTimeout(() => {
          document.getElementById("registerForm").classList.remove("hidden")
        }, 1000)
      }

      // 監聽同意勾選框變化
      document.addEventListener("DOMContentLoaded", function () {
        const checkbox = document.getElementById("dataCollectionConsent")
        const agreeBtn = document.getElementById("dataCollectionAgreeBtn")

        if (checkbox && agreeBtn) {
          checkbox.addEventListener("change", function () {
            agreeBtn.disabled = !this.checked
          })
        }

        // 檢查是否已經同意過
        const previousAgreement = localStorage.getItem("dataCollectionAgreed")
        if (previousAgreement === "true") {
          dataCollectionAgreed = true
        }

        // 添加 ESC 鍵關閉彈出視窗功能
        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            console.log("檢測到ESC鍵，關閉所有模態框")
            // 關閉所有開啟的彈出視窗
            closeDataCollectionModal()
            closePrivacyModal()
          }
        })

        // 雙擊頁面任何地方關閉模態框（應急機制）
        let clickCount = 0
        document.addEventListener("click", function () {
          clickCount++
          setTimeout(function () {
            if (clickCount >= 2) {
              console.log("檢測到雙擊，應急關閉所有模態框")
              closePrivacyModal()
              closeDataCollectionModal()
            }
            clickCount = 0
          }, 300)
        })

        // 長按應急關閉（移動裝置）
        let touchTimeout
        document.addEventListener("touchstart", function (event) {
          touchTimeout = setTimeout(function () {
            console.log("檢測到長按，應急關閉所有模態框")
            closePrivacyModal()
            closeDataCollectionModal()
          }, 1500) // 1.5秒長按
        })

        document.addEventListener("touchend", function () {
          if (touchTimeout) {
            clearTimeout(touchTimeout)
            touchTimeout = null
          }
        })

        // 為關閉按鈕添加額外的事件監聽器，確保能夠關閉
        const dataCloseBtn = document.getElementById("dataCollectionCloseBtn")
        if (dataCloseBtn) {
          dataCloseBtn.addEventListener("click", function (e) {
            e.preventDefault()
            e.stopPropagation()
            console.log("個人資料搜集政策關閉按鈕被點擊")
            closeDataCollectionModal()
          })
        }

        const privacyCloseBtn = document.querySelector(
          "#privacyModal .secondary-button"
        )
        if (privacyCloseBtn) {
          privacyCloseBtn.addEventListener("click", function (e) {
            e.preventDefault()
            e.stopPropagation()
            console.log("隱私權政策關閉按鈕被點擊")
            closePrivacyModal()
          })

          // 添加雙擊事件作為備用
          privacyCloseBtn.addEventListener("dblclick", function (e) {
            e.preventDefault()
            e.stopPropagation()
            console.log("隱私權政策關閉按鈕被雙擊")
            closePrivacyModal()
          })

          // 添加觸摸事件
          privacyCloseBtn.addEventListener("touchend", function (e) {
            e.preventDefault()
            e.stopPropagation()
            console.log("隱私權政策關閉按鈕被觸摸")
            closePrivacyModal()
          })
        }

        // 為整個彈出視窗添加應急關閉方法
        const privacyModal = document.getElementById("privacyModal")
        if (privacyModal) {
          privacyModal.addEventListener("dblclick", function (e) {
            if (e.target === privacyModal) {
              console.log("隱私權政策彈出視窗背景被雙擊")
              closePrivacyModal()
            }
          })
        }

        const dataModal = document.getElementById("dataCollectionModal")
        if (dataModal) {
          dataModal.addEventListener("dblclick", function (e) {
            if (e.target === dataModal) {
              console.log("個人資料搜集政策彈出視窗背景被雙擊")
              closeDataCollectionModal()
            }
          })
        }
      })

      // 檢查用戶是否已經存在（修改版本）
      async function checkUserExists(userId, channelId) {
        try {
          const response = await fetch(base_url + "User/checkUser", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: userId, channelId: channelId }),
          })

          console.log("檢查用戶存在性回應狀態:", response.status)

          if (response.status === 200) {
            // 用戶已存在，顯示解除綁定確認
            console.log("用戶已存在，顯示解除綁定確認")

            // 獲取返回的用戶資訊
            const userData = await response.json()
            console.log("獲取到的用戶資訊:", userData)

            // 顯示用戶綁定資訊
            const userInfoDisplay = document.getElementById("userInfoDisplay")
            userInfoDisplay.innerHTML = `
                        <strong>${userData.name || "用戶"}${
              userData.empId ? " " + userData.empId : ""
            }</strong>您好，您目前已綁定並可使用相關功能：<br>
                       公司：${userData.company || ""}<br>
                       部門：${userData.dept || ""}<br>
                       職稱：${userData.job || ""}<br>
                       `
            document
              .getElementById("unbindConfirmation")
              .classList.remove("hidden")
          } else if (response.status === 404) {
            // 用戶不存在，檢查是否需要顯示政策同意
            console.log("用戶不存在，顯示註冊表單")

            // 檢查是否已同意個人資料搜集政策
            if (!dataCollectionAgreed) {
              // 顯示個人資料搜集政策並要求同意
              showDataCollectionPolicy()
            } else {
              // 已同意，直接顯示註冊表單
              document.getElementById("registerForm").classList.remove("hidden")
            }
          } else {
            // 其他錯誤情況
            console.error("檢查用戶存在性返回非預期狀態:", response.status)
            showStatusMessage("檢查用戶信息時發生錯誤，請重新嘗試", "error")
            document.getElementById("registerForm").classList.remove("hidden")
          }

          hideLoading()
        } catch (error) {
          console.error("檢查用戶存在性失敗:", error)
          showStatusMessage("檢查用戶信息時發生錯誤，請重新嘗試", "error")
          showDebugInfo("檢查用戶存在性失敗: " + error.message)
          // 默認顯示註冊表單
          document.getElementById("registerForm").classList.remove("hidden")
          hideLoading()
        }
      }

      // 解除用戶綁定
      async function unbindUser() {
        showLoading()
        const submitButton = document.querySelector('button[type="button"]')
        submitButton.disabled = true
        submitButton.textContent = "解除綁定中..."

        const userId = document.getElementById("userId").value
        const channelId = document.getElementById("channelId").value
        if (!userId) {
          showStatusMessage("無法獲取用戶識別碼，請重新登入後再試", "error")
          hideLoading()
          return
        }

        try {
          const response = await fetch(base_url + "User/unregister", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: userId, channelId: channelId }),
          })

          if (response.ok) {
            window.scrollTo(0, 0) // 滾動至頁面最上方
            showStatusMessage("解除綁定成功！即將返回聊天室...", "success")
            setTimeout(closeWindowSafely, 2000)
          } else {
            const errorText = await response.text()
            throw new Error(errorText || "解除綁定失敗")
          }
        } catch (error) {
          console.error("解除綁定失敗:", error)
          showStatusMessage(
            "解除綁定失敗: " + (error.message || "請稍後再試"),
            "error"
          )
          setTimeout(closeWindowSafely, 3000)
        } finally {
          hideLoading()
        }
      }

      // 顯示狀態訊息
      function showStatusMessage(message, type) {
        const statusElement = document.getElementById("statusMessage")
        statusElement.textContent = message
        statusElement.className = "status-message"
        statusElement.classList.add(type)
      }

      // 驗證表單欄位
      function validateField(fieldId, condition, errorMessage) {
        const field = document.getElementById(fieldId)
        const errorElement = document.getElementById(`${fieldId}-error`)

        if (!condition) {
          field.classList.add("error")
          if (errorElement) {
            errorElement.textContent = errorMessage
            errorElement.classList.add("visible")
          }
          return false
        } else {
          field.classList.remove("error")
          if (errorElement) {
            errorElement.classList.remove("visible")
          }
          return true
        }
      }

      // 安全地關閉視窗
      function closeWindowSafely() {
        console.log("嘗試關閉窗口...")

        if (!liffInitialized) {
          console.error("LIFF 未初始化，無法關閉視窗")
          showStatusMessage("操作已完成，請手動關閉視窗", "success")
          return
        }

        // 檢查是否在 LINE 瀏覽器內
        if (liff.isInClient()) {
          try {
            console.log("在 LINE 內部，使用 liff.closeWindow()")
            liff.closeWindow()
          } catch (e) {
            console.error("關閉窗口失敗:", e)
            showStatusMessage("無法自動返回聊天室，請手動關閉視窗", "success")
          }
        } else {
          console.log("不在 LINE 瀏覽器內，顯示提示訊息")
          showStatusMessage(
            "操作已完成。由於您不在 LINE 應用內，請手動關閉此視窗",
            "success"
          )
        }
      }

      // 提交表單
      async function submitForm() {
        // 檢查是否已同意個人資料搜集政策
        if (!dataCollectionAgreed) {
          showStatusMessage("請先同意個人資料搜集政策後再提交表單", "error")
          showDataCollectionPolicy()
          return
        }

        // 進行詳細表單驗證
        let isValid = true

        // 驗證公司名稱 (必填)
        const company = document.getElementById("company").value.trim()
        isValid =
          validateField("company", company !== "", "公司名稱為必填欄位") &&
          isValid

        // 驗證部門 (必填)
        const dept = document.getElementById("dept").value.trim()
        isValid =
          validateField("dept", dept !== "", "部門為必填欄位") && isValid

        // 驗證員工編號 (必填)
        const empid = document.getElementById("empId").value.trim()
        const empIdPattern = /^\d{4,6}$/
        isValid =
          validateField(
            "empId",
            empIdPattern.test(empid),
            "員工編號為4到6碼數字"
          ) && isValid

        // 驗證姓名 (必填)
        const name = document.getElementById("name").value.trim()
        isValid =
          validateField("name", name !== "", "姓名為必填欄位") && isValid

        // 如果有驗證失敗，則不提交表單
        if (!isValid) {
          return
        }

        const userId = document.getElementById("userId").value
        if (!userId) {
          showStatusMessage("無法獲取用戶識別碼，請重新登入後再試", "error")
          return
        }

        // 禁用提交按鈕，防止重複提交
        showLoading()
        const submitButton = document.querySelector('button[type="button"]')
        submitButton.disabled = true
        submitButton.textContent = "綁定中..."

        const data = {
          company: company,
          dept: dept,
          job: document.getElementById("job").value,
          groupCode: null,
          phone: "",
          name: name,
          empId: empid,
          channelId: document.getElementById("channelId").value,
          userId: userId,
          insert_at: new Date().toISOString(), // 添加當前時間戳
        }

        try {
          // 送出 POST 請求到後端
          const response = await fetch(base_url + "User/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })

          // 確保返回的是文字
          const result = await response.text()

          if (response.ok) {
            window.scrollTo(0, 0) // 滾動至頁面最上方
            showStatusMessage("綁定成功！即將返回聊天室...", "success")
            // 註冊成功後自動關閉視窗回到聊天室
            setTimeout(closeWindowSafely, 2000) // 延遲 2 秒後關閉視窗，確保用戶看到成功訊息
          } else {
            throw new Error(result || "綁定失敗，請稍後再試！")
          }
        } catch (error) {
          console.error("錯誤:", error)
          showStatusMessage(
            "綁定失敗: " + (error.message || "請稍後再試"),
            "error"
          )
          showDebugInfo("綁定失敗: " + error.message)

          // 啟用提交按鈕，允許重試
          submitButton.disabled = false
          submitButton.textContent = "重新提交"

          // 延遲自動關閉，讓用戶有時間看到錯誤訊息
          setTimeout(closeWindowSafely, 3000)
        } finally {
          hideLoading()
        }
      }
    </script>
  </body>
</html>
