<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>線上簽核</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/zh-tw.min.js"></script>
    <style>
      body {
        font-family: "Noto Sans TC", Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 30px auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }
      h2 {
        color: #06c755;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 15px;
      }
      .form-group {
        margin-bottom: 20px;
        text-align: left;
        position: relative;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }
      .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 4px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border 0.3s;
        box-sizing: border-box;
      }
      textarea {
        min-height: 100px;
        resize: vertical;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: #06c755;
        outline: none;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.1);
      }
      input.error,
      select.error,
      textarea.error {
        border-color: #e74c3c;
      }
      .error-tooltip {
        position: absolute;
        background-color: #e74c3c;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 100;
        bottom: calc(100% + 5px);
        left: 0;
        width: auto;
        white-space: nowrap;
        display: none;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
      }
      .error-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 15px;
        border-width: 5px;
        border-style: solid;
        border-color: #e74c3c transparent transparent transparent;
      }
      .button {
        width: 100%;
        padding: 14px;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 10px;
      }
      .button:hover {
        background-color: #04a73e;
        box-shadow: 0 4px 8px rgba(6, 199, 85, 0.2);
      }
      .button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .secondary-button {
        background-color: #f1f1f1;
        color: #333;
      }
      .secondary-button:hover {
        background-color: #e5e5e5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .danger-button {
        background-color: #e74c3c;
      }
      .danger-button:hover {
        background-color: #c0392b;
      }
      .success-button {
        background-color: #27ae60;
      }
      .success-button:hover {
        background-color: #219a52;
      }
      .approval-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .approval-buttons .button {
        width: auto;
        flex: 1;
        margin: 0;
        padding: 8px 24px;
        font-size: 14px;
        min-width: 80px;
        white-space: nowrap;
      }
      #newApplicationBtn {
        padding: 12px 32px;
        font-size: 16px;
        width: auto;
        min-width: 200px;
        max-width: 300px;
        background-color: #007bff; /* Bootstrap primary 顏色 */
        color: white;
        border: 1px solid #007bff;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
      }
      #newApplicationBtn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .line-brand {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #999;
      }
      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }
      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        display: block;
      }
      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        display: block;
      }
      .status-message.info {
        background-color: #e7f3fe;
        color: #004085;
        display: block;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #06c755;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }

      /* 狀態分區塊 */
      .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 16px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        transition: all 0.3s;
        font-size: 16px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .tab:hover {
        background-color: #f9f9f9;
      }
      .tab.active {
        border-bottom-color: #06c755;
        color: #06c755;
        background-color: #f0fdf4;
        font-weight: 600;
      }

      /* 核准權限相關 tab 的特殊樣式 */
      .approval-tab {
        background-color: #fef7f0;
        border: 1px solid #f4a261;
        border-bottom: 3px solid transparent;
        margin-left: 4px;
        border-radius: 6px 6px 0 0;
      }

      .approval-tab:hover {
        background-color: #fef3e7;
      }

      .approval-tab.active {
        border-bottom-color: #f4a261;
        color: #e76f51;
        background-color: #fef3e7;
        font-weight: 600;
      }

      /* tab 分隔線 */
      .tab-divider {
        width: 2px;
        background-color: #ddd;
        margin: 8px 12px;
        flex-shrink: 0;
      }

      /* 申請列表 */
      .search-bar {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
      }
      .date-range-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: flex-end;
        justify-content: center;
      }
      .search-bar .form-group {
        flex: 1;
        min-width: 150px;
        margin-bottom: 0;
      }
      .search-button-container {
        display: flex;
        justify-content: center;
        width: 100%;
      }
      .search-button {
        padding: 12px 32px;
        font-size: 16px;
        width: auto;
        min-width: 200px;
        max-width: 300px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
      }
      .search-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .records-list {
        margin-top: 20px;
      }
      .record-item {
        background-color: #f9f9f9;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
      }
      .record-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .record-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .record-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }
      .record-title {
        font-weight: 600;
        color: #333;
        font-size: 18px; /* 增大字型 */
        flex: 1;
        min-width: 0;
        line-height: 1.3;
      }
      .record-date {
        color: #777;
        font-size: 12px;
        white-space: nowrap;
        margin-left: 8px;
        flex-shrink: 0;
      }
      .record-details {
        margin-bottom: 10px;
        font-size: 16px; /* 增大字型 */
        line-height: 1.4;
      }
      .record-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .record-status {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 8px;
        white-space: nowrap;
      }
      .status-pending {
        background-color: #ffeeba;
        color: #856404;
      }
      .status-approved {
        background-color: #d4edda;
        color: #155724;
      }
      .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
      }

      /* 對話框 */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal {
        background-color: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #06c755;
      }
      .modal-close {
        cursor: pointer;
        font-size: 24px;
        color: #aaa;
        border: none;
        background: transparent;
      }
      .modal-close:hover {
        color: #333;
      }
      .modal-form {
        margin-bottom: 20px;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      /* 分類選擇區 */
      .category-tabs {
        display: flex;
        flex-wrap: wrap; /* 允許換行 */
        gap: 10px; /* 標籤之間的間距 */
        margin-top: 5px;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        padding-top: 5px;
        padding-bottom: 10px;
      }
      .category-tab {
        padding: 8px 15px;
        background-color: #f1f1f1;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        border: 1px solid transparent; /* 添加邊框用於選中時強調 */
      }
      .category-tab:hover {
        background-color: #e5e5e5;
      }
      .category-tab.active {
        background-color: #06c755; /* 使用 LINE 綠色 */
        color: white;
        box-shadow: 0 2px 4px rgba(6, 199, 85, 0.3); /* 添加陰影 */
        transform: translateY(-2px); /* 輕微上浮效果 */
        border-color: #04a73e; /* 更深色的邊框 */
      }

      /* 使用者資訊區 */
      .user-info {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      /* 切換功能區 */
      .action-buttons {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      /* 適應行動裝置 */
      @media (max-width: 768px) {
        .container {
          margin: 15px;
          padding: 15px;
        }
        .button-group {
          flex-direction: column;
        }
        .search-bar {
          gap: 20px;
        }
        /* 修正日期選擇器：回到上下排列 */
        .date-range-container {
          flex-direction: column;
          gap: 15px;
        }
        .date-range-container .form-group {
          flex: 1;
          min-width: 100%;
        }
        .date-separator {
          display: none; /* 隱藏分隔符 */
        }
        .record-header {
          flex-direction: column;
          gap: 5px;
          align-items: flex-start;
        }
        .record-meta {
          align-items: flex-start;
          width: 100%;
        }
        .record-title {
          font-size: 17px; /* 手機版稍微縮小但仍比原來大 */
          margin-bottom: 3px;
        }
        .record-date {
          font-size: 11px;
          margin-left: 0;
          margin-top: 2px;
        }
        .record-details {
          font-size: 15px; /* 手機版稍微縮小但仍比原來大 */
        }
        .record-actions {
          margin-top: 10px;
          justify-content: flex-start;
        }
        /* 快速修改按鈕手機版樣式 */
        .quick-edit-buttons {
          gap: 6px;
          margin-top: 8px;
        }
        .quick-edit-btn {
          padding: 4px 8px;
          font-size: 11px;
          border-radius: 12px;
        }
        .fromback-option {
          padding: 8px 12px;
          font-size: 13px;
          border-radius: 15px;
        }
        .user-info {
          font-size: 14px;
        }
        .category-tabs {
          overflow-x: auto;
          padding-bottom: 5px;
          flex-wrap: nowrap;
        }
        .tabs {
          overflow-x: auto;
          padding-bottom: 5px;
          flex-wrap: nowrap;
        }
        .tab {
          padding: 6px 10px;
          font-size: 13px;
        }
        .record-status {
          font-size: 11px;
          padding: 2px 5px;
        }
        .batch-controls {
          flex-direction: column;
          gap: 8px;
          align-items: flex-start;
        }
      }

      /* 適應更小的螢幕 */
      @media (max-width: 480px) {
        .tab {
          padding: 6px 10px;
          font-size: 14px;
        }
        .approval-tab {
          margin-left: 2px;
          padding: 6px 8px;
        }
        .tab-divider {
          margin: 6px 8px;
        }
        .search-bar .form-group {
          min-width: 100%;
        }
        .search-bar .form-group label {
          font-size: 14px;
        }
        .search-bar .form-group input {
          padding: 10px;
          font-size: 14px;
        }
        .record-title {
          font-size: 16px; /* 小螢幕版本也增大字型 */
        }
        .record-date {
          font-size: 10px;
        }
        .record-details {
          font-size: 14px; /* 小螢幕版本也增大字型 */
        }
        .record-status {
          font-size: 10px;
          padding: 1px 4px;
        }
        h2 {
          font-size: 20px;
        }
        .container {
          margin: 10px;
          padding: 12px;
        }
        .batch-controls {
          flex-direction: column;
          gap: 6px;
          align-items: flex-start;
        }
        .fromback-options {
          flex-direction: row;
          gap: 8px;
          align-items: center;
          justify-content: flex-start;
        }
        .fromback-option {
          padding: 6px 12px;
          font-size: 12px;
          white-space: nowrap;
          flex: 0 0 auto;
        }
      }

      /* 日期選擇器樣式覆蓋 */
      .flatpickr-day.selected,
      .flatpickr-day.startRange,
      .flatpickr-day.endRange {
        background: #06c755;
        border-color: #06c755;
      }

      /* 空列表提示 */
      .empty-list {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
      }

      /* 公出類型醒目顯示樣式 */
      .fromback-highlight {
        font-weight: 600 !important;
        padding: 3px 8px !important;
        border-radius: 6px !important;
        font-size: 14px !important;
        display: inline-block !important;
        margin-top: 4px !important;
        border: 1px solid !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;
      }

      /* 一般公出樣式 - 灰色系 */
      .fromback-highlight.general {
        color: #6c757d !important;
        background-color: #f8f9fa !important;
        border-color: #6c757d !important;
      }

      /* 逕往樣式 - 藍色系 */
      .fromback-highlight.go {
        color: #007bff !important;
        background-color: #e3f2fd !important;
        border-color: #007bff !important;
      }

      /* 逕返樣式 - 橘色系 */
      .fromback-highlight.back {
        color: #fd7e14 !important;
        background-color: #fff3e0 !important;
        border-color: #fd7e14 !important;
      }

      /* 逕往及逕返樣式 - 紫色系 */
      .fromback-highlight.both {
        color: #6f42c1 !important;
        background-color: #f3e5f5 !important;
        border-color: #6f42c1 !important;
      }

      /* 多選核准功能 */
      .batch-operations {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }
      .batch-operations.show {
        display: block;
      }
      .batch-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }
      .batch-controls .button {
        padding: 8px 16px;
        font-size: 14px;
        margin: 0;
      }
      .fromback-options {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-start;
        width: 100%;
      }
      .record-checkbox {
        margin-right: 10px;
        transform: scale(1.2);
      }
      .record-item.with-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      .record-content {
        flex: 1;
      }

      /* 申請表單時間選項 */
      .time-ranges {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .time-range-option {
        border: 1px solid #ddd;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .time-range-option:hover {
        border-color: #06c755;
      }
      .time-range-option.selected {
        background-color: #06c755;
        color: white;
        border-color: #06c755;
      }
      /* 日期和時間放在同一行的樣式 */
      .date-time-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }
      .date-time-group .form-group {
        flex: 1;
        margin-bottom: 0;
      }
      /* 在小屏幕上自動堆疊 */
      @media (max-width: 576px) {
        .date-time-group {
          gap: 8px;
        }

        .date-time-group .form-group {
          margin-bottom: 10px;
        }
      }
      /* 新增: 讓日期和時間輸入框更小一點 */
      .date-time-group input,
      .date-time-group select {
        padding: 10px 8px;
        font-size: 14px;
      }

      /* 新增: 調整標籤字體大小 */
      .date-time-group label {
        font-size: 14px;
      }
      /* 新增：選單置中相關樣式 */
      .modal {
        /* 確保 modal 在手機上也能居中 */
        display: flex;
        flex-direction: column;
        max-height: 85vh; /* 稍微縮小高度，避免佔滿螢幕 */
      }

      .modal-body {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* iOS 流暢滾動 */
      }

      /* 新增：當選單在靠近底部開啟時，自動向上滾動到視窗中間 */
      .modal-overlay {
        align-items: center; /* 垂直置中 */
      }
      .search-bar {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .search-bar button {
        align-self: flex-end;
        width: auto;
        padding: 12px 30px;
      }

      /* 日期範圍容器樣式 */
      .date-range-container {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
      }

      .date-range-container .form-group {
        flex: 1;
      }

      .date-separator {
        margin-top: 25px;
        font-weight: 500;
      }
      /* 新增：申請類別區塊樣式 */
      .category-section {
        margin-bottom: 15px;
      }
      /* 新增：確保下拉選單打開時可以完整顯示 */
      select {
        position: relative;
        z-index: 5;
      }
      /* 新增：全域錯誤浮動提示樣式 */
      .global-error-tooltip {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #e74c3c;
        color: white;
        padding: 12px 18px;
        border-radius: 4px;
        font-size: 15px;
        z-index: 1000;
        max-width: 80%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        animation: fadeInOut 3s forwards;
        text-align: center;
      }

      /* 新增：動畫效果 */
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
        10% {
          opacity: 1;
          transform: translate(-50%, 0);
        }
        90% {
          opacity: 1;
          transform: translate(-50%, 0);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
      }

      /* 快速修改按鈕樣式 */
      .quick-edit-buttons {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .quick-edit-btn {
        padding: 10px 20px; /* 進一步增大 padding */
        border-radius: 20px; /* 進一步增大圓角 */
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 15px; /* 進一步增大字體 */
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        font-weight: 600; /* 進一步加粗 */
      }

      .quick-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出按鈕 - 灰色系 */
      .quick-edit-btn.general {
        border-color: #6c757d;
        color: #6c757d;
      }

      .quick-edit-btn.general:hover {
        background-color: #6c757d;
        color: white;
      }

      .quick-edit-btn.general.active {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      /* 逕往按鈕 - 藍色系 */
      .quick-edit-btn.go {
        border-color: #007bff;
        color: #007bff;
      }

      .quick-edit-btn.go:hover {
        background-color: #007bff;
        color: white;
      }

      .quick-edit-btn.go.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      /* 逕返按鈕 - 橘色系 */
      .quick-edit-btn.back {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .quick-edit-btn.back:hover {
        background-color: #fd7e14;
        color: white;
      }

      .quick-edit-btn.back.active {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      /* 確保公出類型選項橫向排列 */
      .fromback-option {
        flex: 0 0 auto;
        min-width: 70px;
        white-space: nowrap;
      }

      /* 新增申請表單的 FromBack 選項樣式優化 */
      .fromback-option {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
      }

      .fromback-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出選項 - 灰色系 */
      .fromback-option[data-value=""] {
        border-color: #6c757d;
        color: #6c757d;
      }

      .fromback-option[data-value=""]:hover {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      .fromback-option[data-value=""].selected {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
      }

      /* 逕往選項 - 藍色系 */
      .fromback-option[data-value="逕往"] {
        border-color: #007bff;
        color: #007bff;
      }

      .fromback-option[data-value="逕往"]:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      .fromback-option[data-value="逕往"].selected {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      /* 逕返選項 - 橘色系 */
      .fromback-option[data-value="逕返"] {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .fromback-option[data-value="逕返"]:hover {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      .fromback-option[data-value="逕返"].selected {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
        box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
      }

      /* 新增：快速修改按鈕和公出類型選項樣式調整 */
      .quick-edit-buttons {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .quick-edit-btn {
        padding: 6px 12px;
        border-radius: 15px;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .quick-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出按鈕 - 灰色系 */
      .quick-edit-btn.general {
        border-color: #6c757d;
        color: #6c757d;
      }

      .quick-edit-btn.general:hover {
        background-color: #6c757d;
        color: white;
      }

      .quick-edit-btn.general.active {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      /* 逕往按鈕 - 藍色系 */
      .quick-edit-btn.go {
        border-color: #007bff;
        color: #007bff;
      }

      .quick-edit-btn.go:hover {
        background-color: #007bff;
        color: white;
      }

      .quick-edit-btn.go.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      /* 逕返按鈕 - 橘色系 */
      .quick-edit-btn.back {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .quick-edit-btn.back:hover {
        background-color: #fd7e14;
        color: white;
      }

      .quick-edit-btn.back.active {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      /* 新增申請表單的 FromBack 選項樣式優化 */
      .fromback-option {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
      }

      .fromback-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出選項 - 灰色系 */
      .fromback-option[data-value=""] {
        border-color: #6c757d;
        color: #6c757d;
      }

      .fromback-option[data-value=""]:hover {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      .fromback-option[data-value=""].selected {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
      }

      /* 逕往選項 - 藍色系 */
      .fromback-option[data-value="逕往"] {
        border-color: #007bff;
        color: #007bff;
      }

      .fromback-option[data-value="逕往"]:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      .fromback-option[data-value="逕往"].selected {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      /* 逕返選項 - 橘色系 */
      .fromback-option[data-value="逕返"] {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .fromback-option[data-value="逕返"]:hover {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      .fromback-option[data-value="逕返"].selected {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
        box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
      }

      /* 新增：快速修改按鈕和公出類型選項樣式調整 */
      .quick-edit-buttons {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .quick-edit-btn {
        padding: 6px 12px;
        border-radius: 15px;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .quick-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出按鈕 - 灰色系 */
      .quick-edit-btn.general {
        border-color: #6c757d;
        color: #6c757d;
      }

      .quick-edit-btn.general:hover {
        background-color: #6c757d;
        color: white;
      }

      .quick-edit-btn.general.active {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      /* 逕往按鈕 - 藍色系 */
      .quick-edit-btn.go {
        border-color: #007bff;
        color: #007bff;
      }

      .quick-edit-btn.go:hover {
        background-color: #007bff;
        color: white;
      }

      .quick-edit-btn.go.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      /* 逕返按鈕 - 橘色系 */
      .quick-edit-btn.back {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .quick-edit-btn.back:hover {
        background-color: #fd7e14;
        color: white;
      }

      .quick-edit-btn.back.active {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      /* 新增申請表單的 FromBack 選項樣式優化 */
      .fromback-option {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
      }

      .fromback-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出選項 - 灰色系 */
      .fromback-option[data-value=""] {
        border-color: #6c757d;
        color: #6c757d;
      }

      .fromback-option[data-value=""]:hover {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      .fromback-option[data-value=""].selected {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
      }

      /* 逕往選項 - 藍色系 */
      .fromback-option[data-value="逕往"] {
        border-color: #007bff;
        color: #007bff;
      }

      .fromback-option[data-value="逕往"]:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      .fromback-option[data-value="逕往"].selected {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      /* 逕返選項 - 橘色系 */
      .fromback-option[data-value="逕返"] {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .fromback-option[data-value="逕返"]:hover {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      .fromback-option[data-value="逕返"].selected {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
        box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
      }

      /* 新增：快速修改按鈕和公出類型選項樣式調整 */
      .quick-edit-buttons {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .quick-edit-btn {
        padding: 6px 12px;
        border-radius: 15px;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .quick-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出按鈕 - 灰色系 */
      .quick-edit-btn.general {
        border-color: #6c757d;
        color: #6c757d;
      }

      .quick-edit-btn.general:hover {
        background-color: #6c757d;
        color: white;
      }

      .quick-edit-btn.general.active {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      /* 逕往按鈕 - 藍色系 */
      .quick-edit-btn.go {
        border-color: #007bff;
        color: #007bff;
      }

      .quick-edit-btn.go:hover {
        background-color: #007bff;
        color: white;
      }

      .quick-edit-btn.go.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      /* 逕返按鈕 - 橘色系 */
      .quick-edit-btn.back {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .quick-edit-btn.back:hover {
        background-color: #fd7e14;
        color: white;
      }

      .quick-edit-btn.back.active {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      /* 新增申請表單的 FromBack 選項樣式優化 */
      .fromback-option {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
      }

      .fromback-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出選項 - 灰色系 */
      .fromback-option[data-value=""] {
        border-color: #6c757d;
        color: #6c757d;
      }

      .fromback-option[data-value=""]:hover {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      .fromback-option[data-value=""].selected {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
      }

      /* 逕往選項 - 藍色系 */
      .fromback-option[data-value="逕往"] {
        border-color: #007bff;
        color: #007bff;
      }

      .fromback-option[data-value="逕往"]:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      .fromback-option[data-value="逕往"].selected {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      /* 逕返選項 - 橘色系 */
      .fromback-option[data-value="逕返"] {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .fromback-option[data-value="逕返"]:hover {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      .fromback-option[data-value="逕返"].selected {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
        box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
      }

      /* 新增：快速修改按鈕和公出類型選項樣式調整 */
      .quick-edit-buttons {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .quick-edit-btn {
        padding: 6px 12px;
        border-radius: 15px;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .quick-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出按鈕 - 灰色系 */
      .quick-edit-btn.general {
        border-color: #6c757d;
        color: #6c757d;
      }

      .quick-edit-btn.general:hover {
        background-color: #6c757d;
        color: white;
      }

      .quick-edit-btn.general.active {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      /* 逕往按鈕 - 藍色系 */
      .quick-edit-btn.go {
        border-color: #007bff;
        color: #007bff;
      }

      .quick-edit-btn.go:hover {
        background-color: #007bff;
        color: white;
      }

      .quick-edit-btn.go.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      /* 逕返按鈕 - 橘色系 */
      .quick-edit-btn.back {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .quick-edit-btn.back:hover {
        background-color: #fd7e14;
        color: white;
      }

      .quick-edit-btn.back.active {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      /* 新增申請表單的 FromBack 選項樣式優化 */
      .fromback-option {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
      }

      .fromback-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 一般公出選項 - 灰色系 */
      .fromback-option[data-value=""] {
        border-color: #6c757d;
        color: #6c757d;
      }

      .fromback-option[data-value=""]:hover {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
      }

      .fromback-option[data-value=""].selected {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
      }

      /* 逕往選項 - 藍色系 */
      .fromback-option[data-value="逕往"] {
        border-color: #007bff;
        color: #007bff;
      }

      .fromback-option[data-value="逕往"]:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      .fromback-option[data-value="逕往"].selected {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      /* 逕返選項 - 橘色系 */
      .fromback-option[data-value="逕返"] {
        border-color: #fd7e14;
        color: #fd7e14;
      }

      .fromback-option[data-value="逕返"]:hover {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
      }

      .fromback-option[data-value="逕返"].selected {
        background-color: #fd7e14;
        color: white;
        border-color: #e55a00;
        box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
      }

      /* 新增：快速修改按鈕和公出類型選項樣式調整 */
      .quick-edit-buttons {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .quick-edit-btn {
        padding: 6px 12px;
        border-radius: 15px;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .quick-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 快速修改按鈕手機版樣式 */
      @media (max-width: 576px) {
        .quick-edit-buttons {
          gap: 6px;
          margin-top: 8px;
        }

        .quick-edit-btn {
          padding: 8px 16px; /* 手機版進一步增大 */
          font-size: 13px; /* 手機版字體進一步增大 */
          border-radius: 18px; /* 增大圓角 */
          font-weight: 600; /* 進一步加粗 */
        }

        .fromback-option {
          padding: 8px 12px;
          font-size: 13px;
          border-radius: 15px;
        }
      }

      /* 逕往及逕返選項 - 紫色系 */
      .fromback-option[data-value="逕往及逕返"] {
        border-color: #6f42c1;
        color: #6f42c1;
      }

      .fromback-option[data-value="逕往及逕返"]:hover {
        background-color: #6f42c1;
        color: white;
        border-color: #5a3399;
      }

      .fromback-option[data-value="逕往及逕返"].selected {
        background-color: #6f42c1;
        color: white;
        border-color: #5a3399;
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
      }

      /* 逕往及逕返快速編輯按鈕 - 紫色系 */
      .quick-edit-btn.both {
        border-color: #6f42c1;
        color: #6f42c1;
      }

      .quick-edit-btn.both:hover {
        background-color: #6f42c1;
        color: white;
      }

      .quick-edit-btn.both.active {
        background-color: #6f42c1;
        color: white;
        border-color: #5a3399;
      }

      /* 確保快速編輯按鈕在同一列顯示 */
      .quick-edit-buttons {
        flex-wrap: nowrap !important;
        gap: 6px !important;
        overflow-x: auto;
      }

      .quick-edit-btn {
        padding: 10px 20px !important; /* 進一步增大 */
        font-size: 15px !important; /* 進一步增大字體 */
        min-width: 70px; /* 進一步增加最小寬度 */
        border-radius: 20px !important; /* 進一步增大圓角 */
        font-weight: 600 !important; /* 進一步加粗 */
      }

      /* 手機版本適配 */
      @media (max-width: 576px) {
        .quick-edit-btn {
          padding: 8px 16px !important; /* 手機版進一步增大 */
          font-size: 13px !important; /* 手機版字體進一步增大 */
          min-width: 60px; /* 手機版最小寬度進一步增加 */
        }
      }

      /* 簽核狀態修改按鈕樣式 */
      .approval-status-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      /* 簽核狀態操作容器 */
      .approval-status-actions {
        margin-top: 10px;
        padding-top: 8px;
        border-top: 1px solid #e9ecef;
      }

      .status-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
        min-width: 70px;
        text-align: center;
      }

      .status-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      /* 核准狀態按鈕 - 使用success-button樣式 */
      .status-btn.pass-btn {
        background-color: #27ae60;
      }

      .status-btn.pass-btn:hover {
        background-color: #219a52;
      }

      .status-btn.pass-btn.active {
        background-color: #1e8449;
        box-shadow: 0 3px 8px rgba(39, 174, 96, 0.3);
      }

      /* 不核准狀態按鈕 - 使用danger-button樣式 */
      .status-btn.reject-btn {
        background-color: #e74c3c;
      }

      .status-btn.reject-btn:hover {
        background-color: #c0392b;
      }

      .status-btn.reject-btn.active {
        background-color: #a93226;
        box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
      }

      /* 待簽核狀態按鈕 - 使用綠色系 */
      .status-btn.pending-btn {
        background-color: #27ae60;
      }

      .status-btn.pending-btn:hover {
        background-color: #219a52;
      }

      .status-btn.pending-btn.active {
        background-color: #1e8449;
        box-shadow: 0 3px 8px rgba(39, 174, 96, 0.3);
      }

      /* 手機端響應式調整 */
      @media (max-width: 480px) {
        .approval-status-buttons {
          gap: 6px;
        }

        .approval-status-actions {
          margin-top: 8px;
          padding-top: 6px;
        }

        .status-btn {
          padding: 6px 12px;
          font-size: 12px;
          min-width: 60px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 新增：全域浮動提示容器 -->
    <div
      id="globalErrorTooltip"
      class="global-error-tooltip"
      style="display: none"
    ></div>
    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h2>線上簽核</h2>
      <div id="statusMessage" class="status-message"></div>

      <!-- 使用者資訊區 -->
      <div id="userInfo" class="user-info hidden">
        <!-- 使用者資訊會在JS中被填入 -->
      </div>

      <!-- 功能按鈕區 -->
      <div class="action-buttons">
        <button id="newApplicationBtn" class="button">新增簽核</button>
      </div>

      <!-- 申請狀態分頁 -->
      <div class="tabs">
        <div class="tab active" data-status="pending">已送出</div>
        <div class="tab" data-status="pass">已核准</div>
        <div class="tab" data-status="reject">不核準</div>
        <div class="tab approval-tab" data-status="pending-approval">
          待簽核
        </div>
        <div class="tab approval-tab" data-status="my-approved">已簽核</div>
      </div>

      <!-- 搜尋條件區 -->
      <div class="search-bar">
        <div class="date-range-container">
          <div class="form-group">
            <label for="startDate">開始日期</label>
            <input
              type="text"
              id="startDate"
              class="date-picker"
              placeholder="選擇開始日期"
            />
          </div>
          <div class="date-separator">至</div>
          <div class="form-group">
            <label for="endDate">預計結束</label>
            <input
              type="text"
              id="endDate"
              class="date-picker"
              placeholder="選擇結束日期"
            />
          </div>
        </div>
        <div class="search-button-container">
          <button id="searchBtn" class="button search-button">查詢</button>
        </div>
      </div>

      <!-- 申請記錄列表 -->
      <div id="recordsList" class="records-list">
        <div class="empty-list" id="emptyListMessage">無簽核記錄</div>
        <!-- 記錄將由JavaScript動態填入 -->
      </div>

      <!-- 新增申請對話框 -->
      <div id="newApplicationModal" class="modal-overlay hidden">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">新增簽核事項</div>
            <button class="modal-close">&times;</button>
          </div>
          <!-- 新增申請對話框表單中的日期和時間調整 -->
          <div class="modal-body">
            <div class="form-group category-section">
              <label>類別</label>
              <div id="categoryTabs" class="category-tabs">
                <!-- 分類會由JavaScript動態填入 -->
              </div>
            </div>

            <!-- 申請表單 -->
            <form id="applicationForm" class="modal-form">
              <div class="form-group">
                <label for="eventItem" class="required">項目</label>
                <select id="eventItem" required>
                  <option value="">請選擇簽核項目</option>
                  <!-- 項目選項會由JavaScript動態填入 -->
                </select>
                <div class="error-tooltip" id="eventItem-error">
                  請選擇簽核項目
                </div>
              </div>

              <!-- 申請日期和時間（同一行） -->
              <div class="date-time-group">
                <div class="form-group">
                  <label for="leaveDate" class="required">公出起日</label>
                  <input
                    type="text"
                    id="leaveDate"
                    class="date-picker"
                    required
                    placeholder="選擇公出起日"
                  />
                  <div class="error-tooltip" id="leaveDate-error">
                    請選擇公出起日
                  </div>
                </div>
                <div class="form-group">
                  <label for="leaveTime" class="required">公出時間</label>
                  <select id="leaveTime" required>
                    <option value="">公出時間</option>
                    <option value="07:00">07:00</option>
                    <option value="07:30">07:30</option>
                    <option value="08:00">08:00</option>
                    <option value="08:30">08:30</option>
                    <option value="09:00">09:00</option>
                    <option value="09:30">09:30</option>
                    <option value="10:00">10:00</option>
                    <option value="10:30">10:30</option>
                    <option value="11:00">11:00</option>
                    <option value="11:30">11:30</option>
                    <option value="12:00">12:00</option>
                    <option value="12:30">12:30</option>
                    <option value="13:00">13:00</option>
                    <option value="13:30">13:30</option>
                    <option value="14:00">14:00</option>
                    <option value="14:30">14:30</option>
                    <option value="15:00">15:00</option>
                    <option value="15:30">15:30</option>
                    <option value="16:00">16:00</option>
                    <option value="16:30">16:30</option>
                    <option value="17:00">17:00</option>
                    <option value="17:30">17:30</option>
                    <option value="18:00">18:00</option>
                    <option value="18:30">18:30</option>
                    <option value="19:00">19:00</option>
                    <option value="19:30">19:30</option>
                    <option value="20:00">20:00</option>
                    <option value="20:30">20:30</option>
                    <option value="21:00">21:00</option>
                    <option value="21:30">21:30</option>
                    <option value="22:00">22:00</option>
                    <option value="22:30">22:30</option>
                    <option value="23:00">23:00</option>
                    <option value="23:30">23:30</option>
                  </select>
                  <div class="error-tooltip" id="leaveTime-error">
                    請輸入公出時間
                  </div>
                </div>
              </div>

              <!-- 結束日期和時間（同一行） -->
              <div class="date-time-group">
                <div class="form-group">
                  <label for="backDate" class="required">公出迄日</label>
                  <input
                    type="text"
                    id="backDate"
                    class="date-picker"
                    placeholder="選擇公出迄日"
                  />
                  <div class="error-tooltip" id="backDate-error">
                    公出迄日必須在公出起日之後
                  </div>
                </div>
                <div class="form-group">
                  <label for="backTime" class="required">結束時間</label>
                  <select id="backTime">
                    <option value="">選擇時間</option>
                    <option value="07:00">07:00</option>
                    <option value="07:30">07:30</option>
                    <option value="08:00">08:00</option>
                    <option value="08:30">08:30</option>
                    <option value="09:00">09:00</option>
                    <option value="09:30">09:30</option>
                    <option value="10:00">10:00</option>
                    <option value="10:30">10:30</option>
                    <option value="11:00">11:00</option>
                    <option value="11:30">11:30</option>
                    <option value="12:00">12:00</option>
                    <option value="12:30">12:30</option>
                    <option value="13:00">13:00</option>
                    <option value="13:30">13:30</option>
                    <option value="14:00">14:00</option>
                    <option value="14:30">14:30</option>
                    <option value="15:00">15:00</option>
                    <option value="15:30">15:30</option>
                    <option value="16:00">16:00</option>
                    <option value="16:30">16:30</option>
                    <option value="17:00">17:00</option>
                    <option value="17:30">17:30</option>
                    <option value="18:00">18:00</option>
                    <option value="18:30">18:30</option>
                    <option value="19:00">19:00</option>
                    <option value="19:30">19:30</option>
                    <option value="20:00">20:00</option>
                    <option value="20:30">20:30</option>
                    <option value="21:00">21:00</option>
                    <option value="21:30">21:30</option>
                    <option value="22:00">22:00</option>
                    <option value="22:30">22:30</option>
                    <option value="23:00">23:00</option>
                    <option value="23:30">23:30</option>
                  </select>
                  <div class="error-tooltip" id="backTime-error">
                    請選擇結束時間
                  </div>
                </div>
              </div>

              <!-- 其餘表單項目保持不變 -->
              <div class="form-group" id="locationGroup">
                <label for="location">地點</label>
                <input type="text" id="location" placeholder="請輸入地點" />
              </div>

              <div class="form-group">
                <label for="desc" class="required">事由</label>
                <textarea
                  id="desc"
                  placeholder="請輸入事由"
                  required
                ></textarea>
                <div class="error-tooltip" id="desc-error">請輸入事由</div>
              </div>

              <div class="form-group">
                <label for="approverType" class="required">簽核人員選擇</label>
                <select id="approverType" required>
                  <option value="same-dept">我的部門</option>
                  <option value="other-dept">其它部門</option>
                  <option value="other-company">其它公司(有兼任主管)</option>
                </select>
                <div class="error-tooltip" id="approverType-error">
                  請選擇簽核人員
                </div>
              </div>

              <div
                class="form-group"
                id="otherCompanyGroup"
                style="display: none"
              >
                <label for="otherCompany" class="required">選擇公司</label>
                <select id="otherCompany">
                  <option value="">請選擇公司</option>
                  <!-- 公司選項會由JavaScript動態填入 -->
                </select>
                <div class="error-tooltip" id="otherCompany-error">
                  請選擇公司
                </div>
              </div>

              <div class="form-group" id="otherDeptGroup" style="display: none">
                <label for="otherDept" class="required">選擇部門</label>
                <select id="otherDept">
                  <option value="">請選擇部門</option>
                  <!-- 部門選項會由JavaScript動態填入 -->
                </select>
                <div class="error-tooltip" id="otherDept-error">請選擇部門</div>
              </div>

              <div class="form-group">
                <label for="approveUserId" class="required">簽核人員</label>
                <select id="approveUserId" required>
                  <option value="">請選擇簽核人員</option>
                  <!-- 主管選項會由JavaScript動態填入 -->
                </select>
                <div class="error-tooltip" id="approveUserId-error">
                  請選擇核准人員
                </div>
              </div>

              <!-- 新增：逕往逕返設定 -->
              <div class="form-group">
                <label for="fromBackCmpy">公出類型</label>
                <div class="fromback-options">
                  <div class="fromback-option selected" data-value="一般">
                    一般
                  </div>
                  <div class="fromback-option" data-value="逕往">逕往</div>
                  <div class="fromback-option" data-value="逕返">逕返</div>
                  <div class="fromback-option" data-value="逕往及逕返">
                    逕往及逕返
                  </div>
                </div>
                <input type="hidden" id="fromBackCmpy" value="" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button id="cancelApplicationBtn" class="button secondary-button">
              取消
            </button>
            <button id="submitApplicationBtn" class="button">送出簽核</button>
          </div>
        </div>
      </div>

      <!-- 確認對話框 -->
      <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">確認操作</div>
            <button class="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <p id="confirmMessage">您確定要執行此操作嗎？</p>
          </div>
          <div class="modal-footer">
            <button id="confirmCancelBtn" class="button secondary-button">
              取消
            </button>
            <button id="confirmOkBtn" class="button">確認</button>
          </div>
        </div>
      </div>

      <div class="line-brand">多功能平台-線上簽核-v1.0.6.2</div>
    </div>

    <!-- JavaScript -->
    <script>
      // 全局變數
      const base_url = "https://35.221.146.143.nip.io/linehook/" // API 基礎 URL
      const channelId = "2006992891" // 服務 ID
      const liffId = "2006993665-xkeLlPeW".trim() // LIFF ID

      // 用戶資訊
      let currentUser = null
      let eventItems = [] // 所有申請項目
      let categories = [] // 所有分類
      let approvers = [] // 可選的核准主管
      let currentStatus = "pending" // 當前檢視的申請狀態
      let currentCategory = null // 當前選中的分類
      let confirmCallback = null // 確認對話框的回呼函數
      let lastUsedApprover = null // 最後使用的簽核人員
      // 移除批量操作變數，改為單筆快速修改模式

      // DOM 元素載入後初始化
      document.addEventListener("DOMContentLoaded", () => {
        // 從 localStorage 讀取最後使用的簽核人員
        lastUsedApprover = localStorage.getItem("lastUsedApprover")

        // 初始化頁面元素的事件監聽器
        initEventListeners()

        // 初始化日期選擇器
        initDatePickers()

        // 初始化日期標籤
        updateDateLabels()

        // 檢查 URL 參數並設置對應的 tab
        const urlParams = new URLSearchParams(window.location.search)
        const tabParam = urlParams.get("tab")

        let defaultTab = "pending" // 預設為已送出

        // 如果 URL 中指定了 tab 參數，使用該參數
        if (
          tabParam &&
          [
            "pending",
            "pass",
            "reject",
            "pending-approval",
            "my-approved",
          ].includes(tabParam)
        ) {
          defaultTab = tabParam
        }

        // 設置預設的分頁狀態
        setActiveTab(defaultTab)

        // 初始化 LIFF
        initLIFF()
      })

      // 初始化事件監聽器
      function initEventListeners() {
        // 分頁切換
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            const status = tab.dataset.status
            setActiveTab(status)
            loadRecords()
          })
        })

        // 搜尋按鈕
        document.getElementById("searchBtn").addEventListener("click", () => {
          loadRecords()
        })

        // 新增申請按鈕
        document
          .getElementById("newApplicationBtn")
          .addEventListener("click", () => {
            showNewApplicationModal()
          })

        // 關閉新增申請對話框
        document.querySelectorAll(".modal-close").forEach((closeBtn) => {
          closeBtn.addEventListener("click", (event) => {
            event.target.closest(".modal-overlay").classList.add("hidden")
          })
        })

        // 取消新增申請
        document
          .getElementById("cancelApplicationBtn")
          .addEventListener("click", () => {
            document
              .getElementById("newApplicationModal")
              .classList.add("hidden")
          })

        // 送出申請
        document
          .getElementById("submitApplicationBtn")
          .addEventListener("click", () => {
            validateAndSubmitApplication()
          })

        // 確認對話框
        document
          .getElementById("confirmCancelBtn")
          .addEventListener("click", () => {
            document.getElementById("confirmModal").classList.add("hidden")
          })

        document
          .getElementById("confirmOkBtn")
          .addEventListener("click", () => {
            document.getElementById("confirmModal").classList.add("hidden")
            if (typeof confirmCallback === "function") {
              confirmCallback()
              confirmCallback = null
            }
          })

        // 新增功能：監聽開始日期變更，自動設定結束日期為同一天
        document
          .getElementById("leaveDate")
          .addEventListener("change", function () {
            const startDate = this.value
            if (startDate) {
              document.getElementById("backDate").value = startDate
            }
          })

        // 新增功能：監聽項目選擇變化
        document
          .getElementById("eventItem")
          .addEventListener("change", function () {
            const leaveTime = document.getElementById("leaveTime").value

            // 如果已選取開始時間，重新計算結束時間
            if (leaveTime) {
              setEndTimePlus4Hours(leaveTime)
            }
          })

        // 新增功能：監聽簽核範圍變更
        document
          .getElementById("approverType")
          .addEventListener("change", function () {
            const approverType = this.value
            const otherCompanyGroup =
              document.getElementById("otherCompanyGroup")
            const otherDeptGroup = document.getElementById("otherDeptGroup")

            // 重置所有選擇
            document.getElementById("otherCompany").selectedIndex = 0
            document.getElementById("otherDept").selectedIndex = 0
            document.getElementById("approveUserId").innerHTML =
              '<option value="">請選擇簽核人員</option>'

            if (approverType === "same-dept") {
              // 本部門：隱藏其他選項，直接載入同部門人員
              otherCompanyGroup.style.display = "none"
              otherDeptGroup.style.display = "none"
              loadPotentialApprovers()
            } else if (approverType === "other-dept") {
              // 其他部門：顯示部門選擇，隱藏公司選擇
              otherCompanyGroup.style.display = "none"
              otherDeptGroup.style.display = "block"
              loadDepartments() // 載入本公司的所有部門
            } else if (approverType === "other-company") {
              // 其他公司：顯示公司和部門選擇
              otherCompanyGroup.style.display = "block"
              otherDeptGroup.style.display = "block"
              loadCompanies()
            }
          })

        // 新增功能：監聽公司選擇變更
        document
          .getElementById("otherCompany")
          .addEventListener("change", function () {
            const selectedCompany = this.value
            if (selectedCompany) {
              loadDepartments(selectedCompany)
            } else {
              document.getElementById("otherDept").innerHTML =
                '<option value="">請選擇部門</option>'
            }
            // 重置簽核人員選擇
            document.getElementById("approveUserId").innerHTML =
              '<option value="">請選擇簽核人員</option>'
          })

        // 新增功能：監聽部門選擇變更
        document
          .getElementById("otherDept")
          .addEventListener("change", function () {
            const selectedDept = this.value
            if (selectedDept) {
              loadPotentialApprovers()
            } else {
              document.getElementById("approveUserId").innerHTML =
                '<option value="">請選擇簽核人員</option>'
            }
          })

        // 新增功能：監聽開始時間變更，自動設定結束時間+4小時
        document
          .getElementById("leaveTime")
          .addEventListener("change", function () {
            const leaveTime = this.value

            if (!leaveTime) return

            // 結束時間為開始時間+4小時
            setEndTimePlus4Hours(leaveTime)
          })

        // 移除批量操作相關事件（已不再需要）

        // 新增申請表單的 FromBack 選項選擇
        document
          .querySelectorAll("#applicationForm .fromback-option")
          .forEach((option) => {
            option.addEventListener("click", () => {
              // 更新選中狀態
              document
                .querySelectorAll("#applicationForm .fromback-option")
                .forEach((opt) => {
                  opt.classList.remove("selected")
                })
              option.classList.add("selected")

              // 更新隱藏的 input 值
              document.getElementById("fromBackCmpy").value =
                option.dataset.value
            })
          })
      }
      // 新增函數：設定結束時間為開始時間+4小時
      function setEndTimePlus4Hours(startTimeStr) {
        if (!startTimeStr) return

        // 解析開始時間
        const [startHour, startMinute] = startTimeStr.split(":").map(Number)

        // 計算結束時間 (加4小時)
        let endHour = startHour + 4

        // 如果超過23點，設為23點
        if (endHour > 23) {
          endHour = 23
        }

        // 格式化結束時間
        const endTimeStr = `${endHour.toString().padStart(2, "0")}:${startMinute
          .toString()
          .padStart(2, "0")}`

        // 在下拉選單中找到最接近的選項
        const backTimeSelect = document.getElementById("backTime")
        const options = Array.from(backTimeSelect.options)

        // 找到最接近或等於計算結果的時間選項
        let bestOption = options[0]
        let minDiff = Infinity

        for (const option of options) {
          if (!option.value) continue // 跳過空選項

          const [optHour, optMinute] = option.value.split(":").map(Number)
          const optTotalMinutes = optHour * 60 + optMinute
          const endTotalMinutes = endHour * 60 + startMinute

          const diff = Math.abs(optTotalMinutes - endTotalMinutes)

          if (diff < minDiff) {
            minDiff = diff
            bestOption = option
          }
        }

        // 設定結束時間
        backTimeSelect.value = bestOption.value
      }
      // 初始化日期選擇器
      function initDatePickers() {
        const today = new Date()
        const sevenDaysAgo = new Date()
        sevenDaysAgo.setDate(today.getDate() - 7)
        const lastDaysLast = new Date()
        lastDaysLast.setDate(today.getDate() + 30)
        const datePickerOptions = {
          locale: "zh_tw",
          dateFormat: "Y-m-d",
          disableMobile: true,
        }

        // 初始化所有日期選擇器
        flatpickr("#startDate", {
          ...datePickerOptions,
          defaultDate: sevenDaysAgo,
        })

        flatpickr("#endDate", {
          ...datePickerOptions,
          defaultDate: lastDaysLast,
        })

        // 其他日期選擇器
        flatpickr("#leaveDate, #backDate", datePickerOptions)
      }

      // 初始化 LIFF SDK
      async function initLIFF() {
        showLoading()
        try {
          await liff.init({ liffId: liffId })
          console.log("LIFF 初始化成功")

          if (!liff.isLoggedIn()) {
            console.log("用戶未登入，引導登入...")
            liff.login()
            return
          }

          // 用戶已登入，取得用戶資料
          try {
            const profile = await liff.getProfile()
            console.log("獲取用戶資料成功:", profile.displayName)

            // 存儲LIFF提供的userId
            const liffUserId = profile.userId

            // 使用用戶 ID 檢查用戶是否已存在
            await checkAndLoadUserInfo(liffUserId)
          } catch (error) {
            console.error("獲取用戶資料失敗:", error)
            showStatusMessage("無法獲取用戶資料，請確保已授權應用程式", "error")
            hideLoading()
          }
        } catch (error) {
          console.error("LIFF 初始化失敗:", error)
          showStatusMessage(
            "LINE 應用程式初始化失敗，請確認網路連接並重新嘗試",
            "error"
          )
          hideLoading()
        }
      }

      // 檢查並載入用戶資訊
      async function checkAndLoadUserInfo(userId) {
        try {
          // 先設置 userId 為 LIFF 提供的值
          if (!currentUser) {
            currentUser = {
              userId: userId,
            }
          }

          const response = await fetch(`${base_url}User/checkUser`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: userId, channelId: channelId }),
          })

          if (response.status === 200) {
            // 更新其他使用者資訊，但保留 userId
            const userData = await response.json()
            console.log("獲取到的用戶資訊:", userData)
            currentUser = {
              ...userData,
              userId: userId, // 確保使用 LIFF 提供的 userId
            }

            // 顯示用戶資訊
            displayUserInfo(currentUser)

            // 載入申請項目
            await loadEventItems()

            // 載入潛在的核准主管
            await loadPotentialApprovers()

            // 載入申請記錄
            await loadRecords()
          } else {
            showStatusMessage("無法獲取用戶資訊，請先完成註冊", "error")
            setTimeout(() => {
              // 跳轉到註冊頁面
              window.location.href = "register.html"
            }, 2000)
          }
        } catch (error) {
          console.error("檢查用戶資訊失敗:", error)
          showStatusMessage("檢查用戶資訊時發生錯誤，請重新嘗試", "error")
        } finally {
          hideLoading()
        }
      }

      // 顯示用戶資訊
      function displayUserInfo(user) {
        const userInfoElement = document.getElementById("userInfo")
        userInfoElement.innerHTML = `
    <div>${user.company || ""} - <strong>${user.dept || ""}</strong></div>
    <div style="font-weight: bold; font-size: 16px; margin-top: 5px;">
      ${user.empId || ""} ${user.name || "使用者"} ${user.job || ""}
    </div>
  `
        userInfoElement.classList.remove("hidden")

        // 更新簽核人員選擇中的部門名稱顯示
        const approverTypeSelect = document.getElementById("approverType")
        if (approverTypeSelect && user.dept) {
          const sameDeptOption = approverTypeSelect.querySelector(
            'option[value="same-dept"]'
          )
          if (sameDeptOption) {
            sameDeptOption.textContent = user.dept
          }
        }
      }
      // 載入申請項目
      async function loadEventItems() {
        try {
          const response = await fetch(`${base_url}Leave/items`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          })

          if (response.ok) {
            eventItems = await response.json()
            console.log("簽核項目:", eventItems)

            // 整理類別
            categories = [...new Set(eventItems.map((item) => item.catalog))]
            console.log("類別:", categories)

            // 初始化類別選項
            initCategoryTabs()
          } else {
            console.error("獲取申請項目失敗:", response.status)
            showStatusMessage("無法獲取簽核項目，請重新嘗試", "error")
          }
        } catch (error) {
          console.error("載入申請項目失敗:", error)
          showStatusMessage("載入簽核項目時發生錯誤", "error")
        }
      }

      // 載入潛在的核准主管
      // 職稱排序權重 (數字越大權重越高)
      const jobRankingMap = {
        董事長: 18,
        總經理: 17,
        執董: 16,
        協理: 15,
        經理: 14,
        主任: 13,
        副理: 12,
        襄理: 11,
        課長: 10,
        副課長: 9,
        站長: 8,
        副站長: 7,
        廠長: 6,
        副廠長: 5,
        股長: 4,
        副股長: 3,
        組長: 2,
        副組長: 1,
      }

      // 根據職稱排序
      function sortUsersByJobRank(users) {
        return users.sort((a, b) => {
          const aRank = getJobRank(a.job)
          const bRank = getJobRank(b.job)
          return bRank - aRank // 從高到低排序
        })
      }

      // 獲取職稱權重
      function getJobRank(job) {
        if (!job) return 0

        // 檢查職稱中是否包含關鍵字
        for (const [keyword, rank] of Object.entries(jobRankingMap)) {
          if (job.includes(keyword)) {
            return rank
          }
        }
        return 0 // 其他職稱默認權重為0
      }

      // 載入公司列表
      async function loadCompanies() {
        try {
          const response = await fetch(`${base_url}Leave/companies`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          })

          if (response.ok) {
            const companies = await response.json()
            const selectElement = document.getElementById("otherCompany")
            selectElement.innerHTML = '<option value="">請選擇公司</option>'

            companies.forEach((company) => {
              const option = document.createElement("option")
              option.value = company
              option.textContent = company
              selectElement.appendChild(option)
            })
          } else {
            console.error("獲取公司列表失敗:", response.status)
            showStatusMessage("無法獲取公司列表", "error")
          }
        } catch (error) {
          console.error("載入公司列表失敗:", error)
          showStatusMessage("載入公司列表時發生錯誤", "error")
        }
      }

      // 載入部門列表
      async function loadDepartments(company = null) {
        try {
          let url = `${base_url}Leave/departments`
          if (company) {
            url += `?company=${encodeURIComponent(company)}`
          }

          const response = await fetch(url, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          })

          if (response.ok) {
            const departments = await response.json()
            const selectElement = document.getElementById("otherDept")
            selectElement.innerHTML = '<option value="">請選擇部門</option>'

            departments.forEach((dept) => {
              const option = document.createElement("option")
              option.value = dept
              option.textContent = dept
              selectElement.appendChild(option)
            })
          } else {
            console.error("獲取部門列表失敗:", response.status)
            showStatusMessage("無法獲取部門列表", "error")
          }
        } catch (error) {
          console.error("載入部門列表失敗:", error)
          showStatusMessage("載入部門列表時發生錯誤", "error")
        }
      }

      async function loadPotentialApprovers() {
        try {
          const approverType = document.getElementById("approverType").value
          let url = `${base_url}Leave/approvers?excludeUserId=${currentUser.userId}&hasManagerRole=true`

          console.log("載入核准人員 - 類型:", approverType)
          console.log("當前用戶資訊:", currentUser)

          if (approverType === "same-dept") {
            // 載入同部門主管
            url += `&company=${encodeURIComponent(
              currentUser.company
            )}&dept=${encodeURIComponent(currentUser.dept)}`
          } else if (approverType === "other-dept") {
            // 載入其他部門主管
            const selectedDept = document.getElementById("otherDept").value
            if (!selectedDept) {
              showStatusMessage("請先選擇部門", "error")
              return
            }
            url += `&company=${encodeURIComponent(
              currentUser.company
            )}&dept=${encodeURIComponent(selectedDept)}`
          } else if (approverType === "other-company") {
            // 載入其他公司別的兼任主管
            const selectedCompany =
              document.getElementById("otherCompany").value
            const selectedDept = document.getElementById("otherDept").value

            console.log("選擇的公司:", selectedCompany)
            console.log("選擇的部門:", selectedDept)

            if (!selectedCompany || !selectedDept) {
              showStatusMessage("請先選擇公司和部門", "error")
              return
            }
            url += `&company=${encodeURIComponent(
              selectedCompany
            )}&dept=${encodeURIComponent(selectedDept)}`
          }

          console.log("正在載入核准人員，API URL:", url)

          const response = await fetch(url, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          })

          console.log("API 回應狀態:", response.status)

          if (response.ok) {
            let approversData = await response.json()
            console.log("從 API 獲取的原始資料:", approversData)

            // 篩選只包含主管職位的人員
            const managerJobs = [
              "董事長",
              "總經理",
              "執董",
              "協理",
              "經理",
              "主任",
              "副理",
              "襄理",
              "課長",
              "副課長",
              "站長",
              "副站長",
              "廠長",
              "副廠長",
              "股長",
              "副股長",
              "組長",
              "副組長",
            ]

            approversData = approversData.filter((user) => {
              const isManager = managerJobs.some(
                (job) => user.job && user.job.includes(job)
              )
              if (!isManager) {
                console.log(`篩選掉非主管職位: ${user.name} (${user.job})`)
              }
              return isManager
            })

            console.log("篩選後的主管人員:", approversData)

            // 根據職稱排序
            approvers = sortUsersByJobRank(approversData)
            console.log("排序後的核准主管:", approvers)

            if (approvers.length === 0) {
              console.warn("未找到符合條件的主管人員")
              showStatusMessage(
                "未找到符合條件的主管人員，請檢查該公司部門是否有主管",
                "error"
              )
            }

            updateApproverOptions()
          } else {
            console.error("獲取簽核人員失敗:", response.status)
            const errorText = await response.text()
            console.error("錯誤詳情:", errorText)
            showStatusMessage(
              `無法獲取簽核人員列表 (錯誤代碼: ${response.status})`,
              "error"
            )
          }
        } catch (error) {
          console.error("載入簽核人員失敗:", error)
          showStatusMessage(
            "載入簽核人員列表時發生錯誤: " + error.message,
            "error"
          )
        }
      }
      // 載入申請記錄
      async function loadRecords() {
        showLoading()
        try {
          let url, records

          if (currentStatus === "my-approved") {
            // 載入我的簽核記錄 - 包括核准和不核准的記錄
            const startDate = document.getElementById("startDate").value
            const endDate = document.getElementById("endDate").value

            // 使用通用API獲取我簽核過的所有記錄
            url = `${base_url}Leave/leave?ApproveUserId=${currentUser.userId}&searchDateType=approve`

            // 添加日期查詢參數
            if (startDate && endDate) {
              url += `&StartDate=${startDate}&EndDate=${endDate}`
            }

            const response = await fetch(url, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            })

            if (response.ok) {
              const allRecords = await response.json()
              // 過濾出已經簽核完成的記錄（包括核准和不核准）
              records = allRecords.filter(
                (record) =>
                  record.approveResult === "pass" ||
                  record.approveResult === "reject"
              )
              console.log("我的簽核記錄:", records)
            } else {
              console.error("獲取我的簽核記錄失敗:", response.status)
              showStatusMessage("無法獲取我的簽核記錄", "error")
              records = []
            }
          } else if (currentStatus === "pending-approval") {
            // 載入待簽核記錄 - 顯示指定要我簽核且尚未簽核的記錄
            url = `${base_url}Leave/leave?ApproveUserId=${currentUser.userId}&ApproveResult=pending`

            const response = await fetch(url, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            })

            if (response.ok) {
              records = await response.json()
              console.log("待我簽核記錄:", records)
            } else {
              console.error("獲取待簽核記錄失敗:", response.status)
              showStatusMessage("無法獲取待簽核記錄", "error")
              records = []
            }
          } else if (currentStatus === "pending") {
            // 載入已送出記錄 - 不使用日期篩選，設定一年範圍
            const today = new Date()
            const oneYearAgo = new Date()
            oneYearAgo.setFullYear(today.getFullYear() - 1)
            const oneYearLater = new Date()
            oneYearLater.setFullYear(today.getFullYear() + 1)

            const startDate = oneYearAgo.toISOString().split("T")[0]
            const endDate = oneYearLater.toISOString().split("T")[0]

            url = `${base_url}Leave/leave?UserId=${currentUser.userId}&ApproveResult=${currentStatus}&searchDateType=leave&StartDate=${startDate}&EndDate=${endDate}`

            const response = await fetch(url, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            })

            if (response.ok) {
              records = await response.json()
              console.log("已送出記錄:", records)
            } else {
              console.error("獲取已送出記錄失敗:", response.status)
              showStatusMessage("無法獲取已送出記錄", "error")
              records = []
            }
          } else {
            // 載入申請記錄（已核准、已拒絕）- 使用 searchDateType=leave
            const startDate = document.getElementById("startDate").value
            const endDate = document.getElementById("endDate").value

            // 若沒有設定日期，預設為前7天至今
            if (!startDate || !endDate) {
              const today = new Date()
              const sevenDaysAgo = new Date()
              sevenDaysAgo.setDate(today.getDate() - 7)

              // 格式化日期為 YYYY-MM-DD
              endDate = today.toISOString().split("T")[0]
              startDate = sevenDaysAgo.toISOString().split("T")[0]

              // 更新輸入框的值
              document.getElementById("startDate").value = startDate
              document.getElementById("endDate").value = endDate
            }

            url = `${base_url}Leave/leave?UserId=${currentUser.userId}&ApproveResult=${currentStatus}&searchDateType=leave`

            // 添加日期查詢參數
            if (startDate && endDate) {
              url += `&StartDate=${startDate}&EndDate=${endDate}`
            }

            const response = await fetch(url, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            })

            if (response.ok) {
              records = await response.json()
              console.log("申請記錄:", records)
            } else {
              console.error("獲取申請記錄失敗:", response.status)
              showStatusMessage("無法獲取簽核記錄", "error")
              records = []
            }
          }

          // 依日期排序（由大到小）
          records.sort((a, b) => {
            return new Date(b.leaveDate) - new Date(a.leaveDate)
          })

          // 顯示記錄
          displayRecords(records)
        } catch (error) {
          console.error("載入記錄失敗:", error)
          showStatusMessage("載入記錄時發生錯誤", "error")
          displayRecords([])
        } finally {
          hideLoading()
        }
      }

      // 更新日期字段標籤
      function updateDateLabels() {
        const startDateLabel = document.querySelector('label[for="startDate"]')
        const backDateLabel = document.querySelector('label[for="backDate"]')
        const endDateLabel = document.querySelector('label[for="endDate"]')

        if (currentStatus === "my-approved") {
          // 已簽核標籤：簽核起日/簽核迄日
          startDateLabel.textContent = "簽核起日"
          endDateLabel.textContent = "簽核迄日"
        } else if (currentStatus === "pass" || currentStatus === "reject") {
          // 已核準/不核準標籤：公出起日/公出迄日
          startDateLabel.textContent = "公出起日"
          endDateLabel.textContent = "公出迄日"
        } else {
          // 其他標籤保持原始標籤
          startDateLabel.textContent = "開始日期"
          endDateLabel.textContent = "預計結束"
        }
      } // 設置激活的申請狀態分頁
      function setActiveTab(status) {
        currentStatus = status
        updateDateLabels() // 更新日期字段標籤

        // 更新 tab 的激活狀態
        document.querySelectorAll(".tab").forEach((tab) => {
          if (tab.dataset.status === status) {
            tab.classList.add("active")
          } else {
            tab.classList.remove("active")
          }
        })

        // 控制日期篩選器的顯示/隱藏
        const searchBar = document.querySelector(".search-bar")
        if (status === "pending" || status === "pending-approval") {
          // 已送出分頁和待簽核分頁：隱藏日期篩選器
          searchBar.style.display = "none"
        } else {
          // 其他分頁：顯示日期篩選器
          searchBar.style.display = "flex"
        }
      }
      // 顯示申請記錄
      function displayRecords(records) {
        const recordsListElement = document.getElementById("recordsList")

        if (!recordsListElement) {
          console.error("找不到記錄列表元素")
          return
        }

        if (!records || records.length === 0) {
          // 直接設置空記錄訊息
          recordsListElement.innerHTML =
            '<div class="empty-list">無簽核記錄</div>'
          return
        }

        // 對記錄進行排序，最新的在最上面
        const sortedRecords = [...records].sort((a, b) => {
          // 使用 leaveDate 和 leaveTime 進行排序
          const dateTimeA = new Date(`${a.leaveDate}T${a.leaveTime || "00:00"}`)
          const dateTimeB = new Date(`${b.leaveDate}T${b.leaveTime || "00:00"}`)

          // 如果日期時間相同，則使用 id 進行排序（假設 id 越大越新）
          if (dateTimeA.getTime() === dateTimeB.getTime()) {
            return parseInt(b.id) - parseInt(a.id)
          }

          // 日期時間降序排列（最新的在前）
          return dateTimeB - dateTimeA
        })

        let html = ""
        const isMyApproved = currentStatus === "my-approved"
        const isPendingApproval = currentStatus === "pending-approval"
        const isPending = currentStatus === "pending"
        const isPassOrReject =
          currentStatus === "pass" || currentStatus === "reject"

        sortedRecords.forEach((record) => {
          // Debug: 輸出記錄物件查看可用欄位
          console.log("Record fields:", Object.keys(record))
          console.log("Record object:", record)

          // 格式化狀態顯示
          let statusClass = ""
          let statusText = ""

          if (isMyApproved) {
            // 在我的簽核標籤頁中，根據實際審核結果顯示狀態
            if (record.approveResult === "pass") {
              statusClass = "status-approved"
              statusText = "已核准"
            } else if (record.approveResult === "reject") {
              statusClass = "status-rejected"
              statusText = "不核准"
            } else {
              statusClass = "status-approved"
              statusText = "已核准"
            }
          } else if (isPendingApproval) {
            statusClass = "status-pending"
            statusText = "待簽核"
          } else {
            switch (record.approveResult) {
              case "pending":
                statusClass = "status-pending"
                statusText = "簽核中"
                break
              case "pass":
                statusClass = "status-approved"
                statusText = "已核准"
                break
              case "reject":
                statusClass = "status-rejected"
                statusText = "不核準"
                break
            }
          }

          // 只有在 pending 狀態時才顯示撤銷按鈕（非待簽核分頁）
          const cancelButton =
            record.approveResult === "pending" &&
            !isMyApproved &&
            !isPendingApproval
              ? `<button class="cancel-btn button danger-button" onclick="confirmCancelApplication('${record.id}')">取消申請</button>`
              : ""

          // 核准/不核准按鈕（僅在待簽核分頁顯示）
          const approvalButtons = isPendingApproval
            ? `<div class="approval-buttons">
                <button class="approve-btn button success-button" onclick="showApprovalDialog('${record.id}', 'pass')">核准</button>
                <button class="reject-btn button danger-button" onclick="showApprovalDialog('${record.id}', 'reject')">不核准</button>
              </div>`
            : ""

          // 快速修改 FromBackCmpy 按鈕（僅在我的簽核分頁且狀態為已核准時顯示）
          const quickEditButtons =
            isMyApproved && record.approveResult === "pass"
              ? `<div class="quick-edit-buttons">
                <button class="quick-edit-btn general ${
                  !record.fromBackCmpy || record.fromBackCmpy === ""
                    ? "active"
                    : ""
                }" 
                        onclick="quickUpdateFromBackCmpy('${record.id}', '')" 
                        title="設為一般公出">一般</button>
                <button class="quick-edit-btn go ${
                  record.fromBackCmpy === "逕往" ? "active" : ""
                }" 
                        onclick="quickUpdateFromBackCmpy('${
                          record.id
                        }', '逕往')" 
                        title="設為逕往">逕往</button>
                <button class="quick-edit-btn back ${
                  record.fromBackCmpy === "逕返" ? "active" : ""
                }" 
                        onclick="quickUpdateFromBackCmpy('${
                          record.id
                        }', '逕返')" 
                        title="設為逕返">逕返</button>
                <button class="quick-edit-btn both ${
                  record.fromBackCmpy === "逕往及逕返" ? "active" : ""
                }" 
                        onclick="quickUpdateFromBackCmpy('${
                          record.id
                        }', '逕往及逕返')" 
                        title="設為逕往及逕返">逕往及逕返</button>
              </div>`
              : ""

          // 簽核狀態修改按鈕（僅在我的簽核分頁顯示）
          const approvalStatusButtons = isMyApproved
            ? `<div class="approval-status-buttons">
                <button class="status-btn pass-btn ${
                  record.approveResult === "pass" ? "active" : ""
                }" 
                        onclick="showApprovalStatusDialog('${
                          record.id
                        }', 'pass')" 
                        title="設為核准">核准</button>
                <button class="status-btn reject-btn ${
                  record.approveResult === "reject" ? "active" : ""
                }" 
                        onclick="showApprovalStatusDialog('${
                          record.id
                        }', 'reject')" 
                        title="設為不核准">不核准</button>
                <button class="status-btn pending-btn ${
                  record.approveResult === "pending" ? "active" : ""
                }" 
                        onclick="showApprovalStatusDialog('${
                          record.id
                        }', 'pending')" 
                        title="改回待簽核">待簽核</button>
              </div>`
            : ""

          // FromBackCmpy 狀態顯示（在已送出、待簽核、我的核准分頁、已核准和不核準分頁顯示）
          const fromBackDisplay =
            (isPending ||
              isPendingApproval ||
              isMyApproved ||
              isPassOrReject) &&
            record.fromBackCmpy
              ? `<br>類型：<span class="fromback-highlight ${
                  record.fromBackCmpy === "逕往"
                    ? "go"
                    : record.fromBackCmpy === "逕返"
                    ? "back"
                    : record.fromBackCmpy === "逕往及逕返"
                    ? "both"
                    : "general"
                }">${
                  record.fromBackCmpy === "逕往"
                    ? "逕往"
                    : record.fromBackCmpy === "逕返"
                    ? "逕返"
                    : record.fromBackCmpy === "逕往及逕返"
                    ? "逕往及逕返"
                    : "一般公出"
                }</span>`
              : ""

          // 申請人資訊（在我的核准分頁和待簽核分頁顯示）
          const applicantInfo =
            isMyApproved || isPendingApproval
              ? `<br>申請人: ${record.empId || ""} ${record.name || ""} (${
                  record.dept || ""
                })`
              : ""

          // 根據當前標籤頁決定開始和結束時間的標籤文字
          const getStartTimeLabel = () => {
            if (currentStatus === "my-approved") {
              return "簽核起日"
            } else if (currentStatus === "pass" || currentStatus === "reject") {
              return "公出起日"
            } else {
              return "開始時間"
            }
          }

          const getEndTimeLabel = () => {
            if (currentStatus === "my-approved") {
              return "簽核迄日"
            } else if (currentStatus === "pass" || currentStatus === "reject") {
              return "公出迄日"
            } else {
              return "預計返回"
            }
          }

          html += `
        <div class="record-item" data-id="${record.id}">
          <div class="record-content">
            <div class="record-header">
              <div class="record-title">
                ${record.eventCatalog}類- ${record.eventName}
                ${applicantInfo}
              </div>
              <div class="record-meta">
                <div class="record-date">送出於：${record.createdDate} ${
            record.createdTime
          }</div>
                <div class="record-status ${statusClass}">${statusText}</div>
              </div>
            </div>
            <div class="record-details">
              
              ${record.desc}
              ${record.location ? `<br>地點: ${record.location}` : ""}
              ${
                record.leaveDate
                  ? `<br>公出日期: ${record.leaveDate} ${record.leaveTime}`
                  : ""
              }
              ${
                record.backDate
                  ? `<br>預計返回: ${record.backDate} ${record.backTime}`
                  : ""
              }
              <br>簽核人員：${record.approveDept || ""} ${
            record.approveName || ""
          } (${record.approveJob || ""})
              <br>簽核時間：${record.approveDateTime || "尚未簽核"} 
              ${fromBackDisplay}
            </div>
            <div class="record-actions">
              ${cancelButton}
              ${approvalButtons}
              ${quickEditButtons}
            </div>
            ${
              approvalStatusButtons
                ? `<div class="approval-status-actions">${approvalStatusButtons}</div>`
                : ""
            }
          </div>
        </div>
      `
        })

        recordsListElement.innerHTML = html
      }
      // 顯示確認對話框
      function showConfirmDialog(message, callback, actionType = null) {
        console.log("showConfirmDialog called with actionType:", actionType)

        const confirmMessageElement = document.getElementById("confirmMessage")
        const confirmOkBtn = document.getElementById("confirmOkBtn")

        confirmMessageElement.textContent = message
        confirmCallback = callback

        // 清除所有樣式類別
        confirmOkBtn.className = "button"
        confirmOkBtn.style.cssText = ""

        // 根據操作類型設置按鈕樣式和文字
        if (actionType === "pass") {
          // 核准按鈕：綠色
          confirmOkBtn.classList.add("success-button")
          confirmOkBtn.textContent = "核准"
          console.log("設置為核准按鈕(綠色)")
        } else if (actionType === "reject") {
          // 不核准按鈕：紅色
          confirmOkBtn.classList.add("danger-button")
          confirmOkBtn.textContent = "不核准"
          console.log("設置為不核准按鈕(紅色)")
        } else {
          // 一般確認按鈕：藍色（使用現有的 button 樣式）
          confirmOkBtn.textContent = "確認"
          console.log("設置為一般確認按鈕(藍色)")
        }

        document.getElementById("confirmModal").classList.remove("hidden")
      }

      // 初始化類別分頁
      function initCategoryTabs() {
        const categoryTabsElement = document.getElementById("categoryTabs")
        let html = ""

        categories.forEach((category, index) => {
          html += `<div class="category-tab${
            index === 0 ? " active" : ""
          }" data-category="${category}">${category}</div>`
        })

        categoryTabsElement.innerHTML = html

        // 第一個類別為默認選中
        if (categories.length > 0) {
          currentCategory = categories[0]
          updateEventItemOptions(currentCategory)
        }

        // 添加類別點擊事件
        document.querySelectorAll(".category-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            const category = tab.dataset.category
            currentCategory = category

            // 更新激活狀態
            document.querySelectorAll(".category-tab").forEach((t) => {
              t.classList.toggle("active", t === tab)
            })

            // 更新項目選擇
            updateEventItemOptions(category)
            // 添加：滾動動畫效果，提升用戶體驗
            tab.style.transition = "all 0.3s"
            setTimeout(() => {
              tab.style.transition = ""
            }, 300)
          })
        })
      }
      // 更新項目選擇下拉選單
      function updateEventItemOptions(category) {
        const selectElement = document.getElementById("eventItem")
        selectElement.innerHTML = '<option value="">請選擇簽核項目</option>'

        const filteredItems = eventItems.filter(
          (item) => item.catalog === category
        )

        filteredItems.forEach((item) => {
          // 修改這裡: 不再使用 JSON.stringify，而是只儲存項目名稱
          const option = document.createElement("option")
          option.value = item.itemName // 只儲存 itemName 字串值
          option.textContent = item.itemName
          option.dataset.catalog = item.catalog // 使用 dataset 儲存 catalog
          selectElement.appendChild(option)
        })
      }

      // 顯示新增申請對話框
      function showNewApplicationModal() {
        // 重置表單
        document.getElementById("applicationForm").reset()

        // 重置逕往逕返選項為預設值（一般）
        document
          .querySelectorAll("#applicationForm .fromback-option")
          .forEach((opt) => {
            opt.classList.remove("selected")
          })
        document
          .querySelector("#applicationForm .fromback-option[data-value='']")
          .classList.add("selected")
        document.getElementById("fromBackCmpy").value = ""

        // 重置簽核範圍為預設值（本部門）
        document.getElementById("approverType").value = "same-dept"
        document.getElementById("otherCompanyGroup").style.display = "none"
        document.getElementById("otherDeptGroup").style.display = "none"

        // 載入同部門的簽核人員
        loadPotentialApprovers()

        // 顯示模態框
        document
          .getElementById("newApplicationModal")
          .classList.remove("hidden")
      }
      // 清除時間選擇
      function clearTimeSelections() {
        document.getElementById("leaveTime").value = ""
        document.getElementById("backTime").value = ""
      }

      // 更新主管選擇下拉選單
      function updateApproverOptions() {
        const selectElement = document.getElementById("approveUserId")
        selectElement.innerHTML = '<option value="">請選擇簽核人員</option>'

        approvers.forEach((approver) => {
          const option = document.createElement("option")
          option.value = approver.userId
          option.textContent = `${approver.name} (${approver.job || "未輸入"})`
          selectElement.appendChild(option)
        })

        // 如果有最後使用的簽核人員，自動選擇
        if (
          lastUsedApprover &&
          approvers.some((a) => a.userId === lastUsedApprover)
        ) {
          selectElement.value = lastUsedApprover
        }
      }
      // 顯示錯誤提示
      function showError(fieldId, message) {
        const field = document.getElementById(fieldId)
        field.classList.add("error")

        const errorTooltip = document.getElementById(`${fieldId}-error`)
        if (errorTooltip) {
          errorTooltip.textContent = message
          errorTooltip.style.display = "block"

          // 2秒後自動隱藏錯誤提示
          setTimeout(() => {
            errorTooltip.style.display = "none"
            field.classList.remove("error")
          }, 3000)
        }

        return false
      }

      // 驗證並送出申請
      function validateAndSubmitApplication() {
        // 隱藏所有錯誤提示
        document.querySelectorAll(".error-tooltip").forEach((tooltip) => {
          tooltip.style.display = "none"
        })

        let isValid = true

        // 驗證申請項目
        const eventItemValue = document.getElementById("eventItem").value
        if (!eventItemValue) {
          isValid = showError("eventItem", "請選擇簽核項目") && isValid
        }

        // 驗證申請日期
        const leaveDate = document.getElementById("leaveDate").value
        if (!leaveDate) {
          isValid = showError("leaveDate", "請選擇公出起日") && isValid
        }

        // 驗證申請時間
        const leaveTime = document.getElementById("leaveTime").value
        if (!leaveTime) {
          isValid = showError("leaveTime", "請選擇開始時間") && isValid
        }

        // 驗證結束日期（現在改為必填）
        const backDate = document.getElementById("backDate").value
        if (!backDate) {
          isValid = showError("backDate", "請選擇公出迄日") && isValid
        } else if (leaveDate && new Date(backDate) < new Date(leaveDate)) {
          isValid =
            showError("backDate", "公出迄日必須在公出起日之後") && isValid
        }

        // 驗證結束時間（現在改為必填）
        const backTime = document.getElementById("backTime").value
        if (!backTime) {
          isValid = showError("backTime", "請選擇結束時間") && isValid
        }

        // 驗證同一天時間順序
        if (
          backDate &&
          leaveDate &&
          backDate === leaveDate &&
          backTime &&
          leaveTime
        ) {
          if (backTime < leaveTime) {
            isValid =
              showError("backTime", "結束時間必須晚於開始時間") && isValid
          }
        }

        // 驗證核准主管
        const approveUserId = document.getElementById("approveUserId").value
        if (!approveUserId) {
          isValid = showError("approveUserId", "請選擇簽核人員") && isValid
        }

        // 驗證簽核範圍相關選項
        const approverType = document.getElementById("approverType").value
        if (approverType === "other-dept") {
          const otherDept = document.getElementById("otherDept").value
          if (!otherDept) {
            isValid = showError("otherDept", "請選擇部門") && isValid
          }
        } else if (approverType === "other-company") {
          const otherCompany = document.getElementById("otherCompany").value
          const otherDept = document.getElementById("otherDept").value
          if (!otherCompany) {
            isValid = showError("otherCompany", "請選擇公司") && isValid
          }
          if (!otherDept) {
            isValid = showError("otherDept", "請選擇部門") && isValid
          }
        }

        // 驗證申請說明
        const desc = document.getElementById("desc").value.trim()
        if (!desc) {
          isValid = showError("desc", "請輸入事由") && isValid
        }

        if (!isValid) {
          return
        }

        // 顯示確認對話框
        showConfirmDialog("您確定要送出申請嗎？", submitApplication)
      }

      // 送出申請
      async function submitApplication() {
        showLoading()

        try {
          const eventItemSelect = document.getElementById("eventItem")
          const eventItemValue = eventItemSelect.value
          const eventCatalog =
            eventItemSelect.options[eventItemSelect.selectedIndex].dataset
              .catalog

          const applicationData = {
            userId: currentUser.userId,
            channelId: channelId,
            company: currentUser.company,
            dept: currentUser.dept,
            empId: currentUser.empId,
            name: currentUser.name,
            leaveDate: document.getElementById("leaveDate").value,
            leaveTime: document.getElementById("leaveTime").value,
            backDate: document.getElementById("backDate").value,
            backTime: document.getElementById("backTime").value,
            location: document.getElementById("location").value || null,
            eventName: eventItemValue,
            eventCatalog: eventCatalog,
            desc: document.getElementById("desc").value,
            approveUserId: document.getElementById("approveUserId").value,
            fromBackCmpy: document.getElementById("fromBackCmpy").value || null,
          }

          const response = await fetch(`${base_url}Leave/createLeave`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(applicationData),
          })

          if (response.ok) {
            // 更新最後使用的簽核人員
            lastUsedApprover = document.getElementById("approveUserId").value
            // 保存到 localStorage
            localStorage.setItem("lastUsedApprover", lastUsedApprover)

            showStatusMessage("簽核已成功送出", "success")
            document
              .getElementById("newApplicationModal")
              .classList.add("hidden")
            await loadRecords()
          } else {
            // 在 modal 內顯示錯誤
            let errorMessage = "送出簽核失敗"
            try {
              const errorData = await response.json()
              errorMessage = errorData.message || errorMessage
            } catch (parseError) {
              console.error("解析錯誤回應失敗:", parseError)
            }

            // 在 modal 內顯示錯誤訊息
            showModalError(errorMessage)
          }
        } catch (error) {
          console.error("送出簽核失敗:", error)
          showStatusMessage("送出簽核時發生錯誤", "error")
        } finally {
          hideLoading()
        }
      }

      // 新增的函數，用於在 modal 內顯示錯誤
      function showModalError(message) {
        showStatusMessage(message, "error")
      }
      // 顯示狀態訊息
      function showStatusMessage(message, type) {
        if (type === "error") {
          // 使用全域浮動提示顯示錯誤
          const tooltipElement = document.getElementById("globalErrorTooltip")
          tooltipElement.textContent = message
          tooltipElement.style.display = "block"

          // 3秒後自動消失
          setTimeout(() => {
            tooltipElement.style.display = "none"
          }, 3000)
        } else {
          // 成功和信息訊息保持原樣
          const statusElement = document.getElementById("statusMessage")
          statusElement.textContent = message
          statusElement.className = "status-message"
          statusElement.classList.add(type)

          // 3秒後自動隱藏成功訊息
          if (type === "success") {
            setTimeout(() => {
              statusElement.style.display = "none"
            }, 3000)
          }
        }
      }

      // 顯示載入中
      function showLoading() {
        document.getElementById("loading-overlay").classList.remove("hidden")
      }

      // 隱藏載入中
      function hideLoading() {
        document.getElementById("loading-overlay").classList.add("hidden")
      }

      // 安全地關閉視窗（如果在 LINE 瀏覽器內）
      function closeWindowSafely() {
        console.log("嘗試關閉窗口...")

        if (liff && liff.isInClient()) {
          try {
            console.log("在 LINE 內部，使用 liff.closeWindow()")
            liff.closeWindow()
          } catch (e) {
            console.error("關閉窗口失敗:", e)
            showStatusMessage("無法自動返回聊天室，請手動關閉視窗", "info")
          }
        } else {
          console.log("不在 LINE 瀏覽器內，顯示提示訊息")
          showStatusMessage("操作已完成。請手動關閉此視窗", "info")
        }
      }
      // 新增：在顯示對話框函數中添加自動滾动到視圖中間的邏輯
      function showNewApplicationModal() {
        // 重置表單
        document.getElementById("applicationForm").reset()

        // 更新主管選擇下拉選單
        updateApproverOptions()

        // 顯示模態框
        const modal = document.getElementById("newApplicationModal")
        modal.classList.remove("hidden")

        // 新增：確保模態框置中
        setTimeout(() => {
          const modalContent = modal.querySelector(".modal")
          if (modalContent) {
            // 滾動到頁面頂部，然後模態框會自動置中
            window.scrollTo({
              top: 0,
              behavior: "smooth",
            })
          }
        }, 100)
      }

      // 加入「確認撤銷申請」函數
      function confirmCancelApplication(id) {
        // 檢查是否為「撤銷申請」狀態下才能撤銷
        const currentDate = new Date()
        const recordItem = document.querySelector(
          `.record-item[data-id="${id}"]`
        )

        if (!recordItem) {
          showStatusMessage("找不到此簽核記錄", "error")
          return
        }

        // 只有申請中狀態才能撤銷
        const statusElement = recordItem.querySelector(".record-status")
        if (
          statusElement &&
          !statusElement.classList.contains("status-pending")
        ) {
          showStatusMessage("只有簽核中的狀態可以撤銷", "error")
          return
        }

        // 檢查是否為跨月申請
        /*
        const leaveDateStr = recordItem
          .querySelector(".record-date")
          .textContent.split(" ")[0]
        const leaveDate = new Date(leaveDateStr)

        if (
          leaveDate.getFullYear() !== currentDate.getFullYear() ||
          leaveDate.getMonth() !== currentDate.getMonth()
        ) {
          showStatusMessage("跨月記錄無法撤銷", "error")
          return
        }
        */
        // 顯示確認對話框
        showConfirmDialog("您確定要撤銷此簽核嗎？", () => cancelApplication(id))
      }

      // 新增「執行撤銷申請」函數
      async function cancelApplication(id) {
        showLoading()

        try {
          // 準備請求資料
          const cancelData = {
            userId: currentUser.userId,
          }

          // 發送撤銷請求
          const response = await fetch(`${base_url}Leave/${id}/cancel`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cancelData),
          })

          if (response.ok) {
            showStatusMessage("簽核已成功撤銷", "success")
            // 重新載入申請記錄
            await loadRecords()
          } else {
            // 顯示錯誤訊息
            let errorMessage = "撤銷簽核失敗"
            try {
              const errorData = await response.json()
              errorMessage = errorData.message || errorMessage
            } catch (parseError) {
              console.error("解析錯誤回應失敗:", parseError)
            }

            showStatusMessage(errorMessage, "error")
          }
        } catch (error) {
          console.error("撤銷簽核失敗:", error)
          showStatusMessage("撤銷簽核時發生錯誤，請稍後再試", "error")
        } finally {
          hideLoading()
        }
      }

      // 移除批量操作相關函數，改為單筆快速修改

      // 顯示核准/不核准確認對話框
      function showApprovalDialog(recordId, action) {
        const actionText = action === "pass" ? "核准" : "不核准"
        const message = `您確定要${actionText}此申請嗎？`

        showConfirmDialog(
          message,
          () => handleApproval(recordId, action),
          action
        )
      }

      // 處理核准/不核准操作
      async function handleApproval(recordId, action) {
        try {
          showLoading()

          const approvalData = {
            approverId: currentUser.userId,
            result: action,
            description: action === "pass" ? "核准通過" : "不予核准",
          }

          const response = await fetch(`${base_url}Leave/${recordId}/approve`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(approvalData),
          })

          if (response.ok) {
            const actionText = action === "pass" ? "核准" : "不核准"
            showStatusMessage(`申請已${actionText}`, "success")
            // 重新載入記錄以更新列表
            await loadRecords()
          } else {
            let errorMessage = `${action === "pass" ? "核准" : "不核准"}失敗`
            try {
              const errorData = await response.json()
              errorMessage = errorData.message || errorMessage
            } catch (parseError) {
              console.error("解析錯誤回應失敗:", parseError)
            }
            showStatusMessage(errorMessage, "error")
          }
        } catch (error) {
          console.error("處理核准失敗:", error)
          showStatusMessage("處理申請時發生錯誤，請稍後再試", "error")
        } finally {
          hideLoading()
        }
      }

      // 快速更新單筆記錄的 FromBackCmpy（用於我的核准分頁）
      async function quickUpdateFromBackCmpy(recordId, fromBackCmpy) {
        try {
          showLoading()

          const response = await fetch(
            `${base_url}Leave/${recordId}/fromback-cmpy`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                approverId: currentUser.userId,
                fromBackCmpy: fromBackCmpy,
              }),
            }
          )

          if (!response.ok) {
            throw new Error(`更新失敗`)
          }

          // 顯示成功訊息
          const typeName =
            fromBackCmpy === "逕往"
              ? "逕往"
              : fromBackCmpy === "逕返"
              ? "逕返"
              : fromBackCmpy === "逕往及逕返"
              ? "逕往及逕返"
              : "一般"
          showStatusMessage(`已更新為「${typeName}」`, "success")

          // 重新載入記錄以顯示最新狀態
          await loadRecords()
        } catch (error) {
          console.error("更新失敗:", error)
          showStatusMessage("更新時發生錯誤", "error")
        } finally {
          hideLoading()
        }
      }

      // 顯示簽核狀態變更確認對話框
      function showApprovalStatusDialog(recordId, newStatus) {
        let actionText, message

        switch (newStatus) {
          case "pass":
            actionText = "核准"
            message = "您確定要將此申請狀態改為「核准」嗎？"
            break
          case "reject":
            actionText = "不核准"
            message = "您確定要將此申請狀態改為「不核准」嗎？"
            break
          case "pending":
            actionText = "改回待簽核"
            message =
              "您確定要將此申請狀態改回「待簽核」嗎？這將清除原有的審核記錄。"
            break
          default:
            return
        }

        showConfirmDialog(
          message,
          () => handleApprovalStatusChange(recordId, newStatus),
          newStatus
        )
      }

      // 處理簽核狀態變更
      async function handleApprovalStatusChange(recordId, newStatus) {
        try {
          showLoading()

          let description = ""
          switch (newStatus) {
            case "pass":
              description = "核准通過"
              break
            case "reject":
              description = "不予核准"
              break
            case "pending":
              description = "" // 待簽核狀態不需要描述
              break
          }

          const approvalData = {
            approverId: currentUser.userId,
            result: newStatus,
            description: description,
          }

          const response = await fetch(`${base_url}Leave/${recordId}/approve`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(approvalData),
          })

          if (response.ok) {
            let statusText
            switch (newStatus) {
              case "pass":
                statusText = "核准"
                break
              case "reject":
                statusText = "不核准"
                break
              case "pending":
                statusText = "改回待簽核"
                break
            }

            showStatusMessage(`申請狀態已更新為「${statusText}」`, "success")
            // 重新載入記錄以更新列表
            await loadRecords()
          } else {
            let errorMessage = "狀態更新失敗"
            try {
              const errorData = await response.json()
              errorMessage = errorData.message || errorMessage
            } catch (parseError) {
              console.error("解析錯誤回應失敗:", parseError)
            }
            showStatusMessage(errorMessage, "error")
          }
        } catch (error) {
          console.error("處理狀態變更失敗:", error)
          showStatusMessage("處理申請時發生錯誤，請稍後再試", "error")
        } finally {
          hideLoading()
        }
      }

      // 處理核准/不核准操作
      async function handleApproval(recordId, action) {
        try {
          showLoading()

          const approvalData = {
            approverId: currentUser.userId,
            result: action,
            description: action === "pass" ? "核准" : "不核准",
          }

          const response = await fetch(`${base_url}Leave/${recordId}/approve`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(approvalData),
          })

          if (response.ok) {
            const actionText = action === "pass" ? "核准" : "不核准"
            showStatusMessage(`申請已${actionText}`, "success")
            // 重新載入記錄以更新列表
            await loadRecords()
          } else {
            let errorMessage = "操作失敗"
            try {
              const errorData = await response.json()
              errorMessage = errorData.message || errorMessage
            } catch (parseError) {
              console.error("解析錯誤回應失敗:", parseError)
            }
            showStatusMessage(errorMessage, "error")
          }
        } catch (error) {
          console.error("核准操作失敗:", error)
          showStatusMessage("操作時發生錯誤，請稍後再試", "error")
        } finally {
          hideLoading()
        }
      }
    </script>
  </body>
</html>
