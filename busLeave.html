<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>線上申請</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/zh-tw.min.js"></script>
    <style>
      body {
        font-family: "Noto Sans TC", Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 30px auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }
      h2 {
        color: #06c755;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 15px;
      }
      .form-group {
        margin-bottom: 20px;
        text-align: left;
        position: relative;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }
      .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 4px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border 0.3s;
        box-sizing: border-box;
      }
      textarea {
        min-height: 100px;
        resize: vertical;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: #06c755;
        outline: none;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.1);
      }
      input.error,
      select.error,
      textarea.error {
        border-color: #e74c3c;
      }
      .error-tooltip {
        position: absolute;
        background-color: #e74c3c;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 100;
        bottom: calc(100% + 5px);
        left: 0;
        width: auto;
        white-space: nowrap;
        display: none;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
      }
      .error-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 15px;
        border-width: 5px;
        border-style: solid;
        border-color: #e74c3c transparent transparent transparent;
      }
      .button {
        width: 100%;
        padding: 14px;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 10px;
      }
      .button:hover {
        background-color: #04a73e;
        box-shadow: 0 4px 8px rgba(6, 199, 85, 0.2);
      }
      .button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .secondary-button {
        background-color: #f1f1f1;
        color: #333;
      }
      .secondary-button:hover {
        background-color: #e5e5e5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .danger-button {
        background-color: #e74c3c;
      }
      .danger-button:hover {
        background-color: #c0392b;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .line-brand {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #999;
      }
      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }
      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        display: block;
      }
      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        display: block;
      }
      .status-message.info {
        background-color: #e7f3fe;
        color: #004085;
        display: block;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #06c755;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }

      /* 狀態分區塊 */
      .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        transition: all 0.3s;
      }
      .tab:hover {
        background-color: #f9f9f9;
      }
      .tab.active {
        border-bottom-color: #06c755;
        color: #06c755;
      }

      /* 申請列表 */
      .search-bar {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .search-bar .form-group {
        flex: 1;
        min-width: 150px;
        margin-bottom: 0;
      }
      .search-bar button {
        padding: 12px 20px;
        height: 48px;
      }

      .records-list {
        margin-top: 20px;
      }
      .record-item {
        background-color: #f9f9f9;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
      }
      .record-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .record-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      .record-title {
        font-weight: 600;
        color: #333;
        font-size: 18px;
      }
      .record-date {
        color: #777;
        font-size: 14px;
      }
      .record-details {
        margin-bottom: 10px;
        font-size: 16px;
      }
      .record-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .record-status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        margin-right: 10px;
      }
      .status-pending {
        background-color: #ffeeba;
        color: #856404;
      }
      .status-approved {
        background-color: #d4edda;
        color: #155724;
      }
      .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
      }

      /* 對話框 */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal {
        background-color: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #06c755;
      }
      .modal-close {
        cursor: pointer;
        font-size: 24px;
        color: #aaa;
        border: none;
        background: transparent;
      }
      .modal-close:hover {
        color: #333;
      }
      .modal-form {
        margin-bottom: 20px;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      /* 分類選擇區 */
      .category-tabs {
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        padding-top: 10px;
        padding-bottom: 10px;
      }
      .category-tab {
        padding: 8px 15px;
        background-color: #f1f1f1;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .category-tab:hover {
        background-color: #e5e5e5;
      }
      .category-tab.active {
        background-color: #06c755;
        color: white;
      }

      /* 使用者資訊區 */
      .user-info {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      /* 切換功能區 */
      .action-buttons {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      /* 適應行動裝置 */
      @media (max-width: 768px) {
        .container {
          margin: 15px;
          padding: 15px;
        }
        .button-group,
        .search-bar {
          flex-direction: column;
        }
        .record-header {
          flex-direction: column;
          gap: 5px;
        }
        .record-actions {
          margin-top: 10px;
          justify-content: flex-start;
        }
        .user-info {
          font-size: 14px;
        }
        .category-tabs {
          overflow-x: auto;
          padding-bottom: 5px;
          flex-wrap: nowrap;
        }
        .tabs {
          overflow-x: auto;
          padding-bottom: 5px;
        }
      }

      /* 日期選擇器樣式覆蓋 */
      .flatpickr-day.selected,
      .flatpickr-day.startRange,
      .flatpickr-day.endRange {
        background: #06c755;
        border-color: #06c755;
      }

      /* 空列表提示 */
      .empty-list {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
      }

      /* 申請表單時間選項 */
      .time-ranges {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .time-range-option {
        border: 1px solid #ddd;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .time-range-option:hover {
        border-color: #06c755;
      }
      .time-range-option.selected {
        background-color: #06c755;
        color: white;
        border-color: #06c755;
      }
      /* 日期和時間放在同一行的樣式 */
      .date-time-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }
      .date-time-group .form-group {
        flex: 1;
        margin-bottom: 0;
      }
      /* 在小屏幕上自動堆疊 */
      @media (max-width: 576px) {
        .date-time-group {
          gap: 8px;
        }

        .date-time-group .form-group {
          margin-bottom: 10px;
        }
      }
      /* 新增: 讓日期和時間輸入框更小一點 */
      .date-time-group input,
      .date-time-group select {
        padding: 10px 8px;
        font-size: 14px;
      }

      /* 新增: 調整標籤字體大小 */
      .date-time-group label {
        font-size: 14px;
      }
      /* 新增：選單置中相關樣式 */
      .modal {
        /* 確保 modal 在手機上也能居中 */
        display: flex;
        flex-direction: column;
        max-height: 85vh; /* 稍微縮小高度，避免佔滿螢幕 */
      }

      .modal-body {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* iOS 流暢滾動 */
      }

      /* 新增：當選單在靠近底部開啟時，自動向上滾動到視窗中間 */
      .modal-overlay {
        align-items: center; /* 垂直置中 */
      }
      .date-range-container {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
      }

      .date-range-container .form-group {
        flex: 1;
      }

      .date-separator {
        margin-top: 25px;
        font-weight: 500;
      }

      .search-bar {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .search-bar button {
        align-self: flex-end;
        width: auto;
        padding: 12px 30px;
      }
      /* 新增：確保下拉選單打開時可以完整顯示 */
      select {
        position: relative;
        z-index: 5;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h2>線上申請</h2>
      <div id="statusMessage" class="status-message"></div>

      <!-- 使用者資訊區 -->
      <div id="userInfo" class="user-info hidden">
        <!-- 使用者資訊會在JS中被填入 -->
      </div>

      <!-- 功能按鈕區 -->
      <div class="action-buttons">
        <button id="newApplicationBtn" class="button">新增申請</button>
      </div>

      <!-- 申請狀態分頁 -->
      <div class="tabs">
        <div class="tab active" data-status="pending">待核准</div>
        <div class="tab" data-status="pass">已核准</div>
        <div class="tab" data-status="reject">已拒絕</div>
      </div>

      <!-- 搜尋條件區 -->
      <div class="search-bar">
        <div class="date-range-container">
          <div class="form-group">
            <label for="startDate">起始日期</label>
            <input
              type="text"
              id="startDate"
              class="date-picker"
              placeholder="選擇開始日期"
            />
          </div>
          <div class="date-separator">至</div>
          <div class="form-group">
            <label for="endDate">結束日期</label>
            <input
              type="text"
              id="endDate"
              class="date-picker"
              placeholder="選擇結束日期"
            />
          </div>
        </div>
        <button id="searchBtn" class="button">搜尋</button>
      </div>

      <!-- 申請記錄列表 -->
      <div id="recordsList" class="records-list">
        <div class="empty-list" id="emptyListMessage">無申請記錄</div>
        <!-- 記錄將由JavaScript動態填入 -->
      </div>

      <!-- 新增申請對話框 -->
      <div id="newApplicationModal" class="modal-overlay hidden">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">新增申請</div>
            <button class="modal-close">&times;</button>
          </div>
          <!-- 新增申請對話框表單中的日期和時間調整 -->
          <div class="modal-body">
            <!-- 分類選擇區保持不變 -->
            <div id="categoryTabs" class="category-tabs">
              <!-- 分類會由JavaScript動態填入 -->
            </div>

            <!-- 申請表單 -->
            <form id="applicationForm" class="modal-form">
              <div class="form-group">
                <label for="eventItem" class="required">申請項目</label>
                <select id="eventItem" required>
                  <option value="">請選擇申請項目</option>
                  <!-- 項目選項會由JavaScript動態填入 -->
                </select>
                <div class="error-tooltip" id="eventItem-error">
                  請選擇申請項目
                </div>
              </div>

              <!-- 申請日期和時間（同一行） -->
              <div class="date-time-group">
                <div class="form-group">
                  <label for="leaveDate" class="required">申請日期</label>
                  <input
                    type="text"
                    id="leaveDate"
                    class="date-picker"
                    required
                    placeholder="選擇日期"
                  />
                  <div class="error-tooltip" id="leaveDate-error">
                    請選擇申請日期
                  </div>
                </div>
                <div class="form-group">
                  <label for="leaveTime" class="required">申請時間</label>
                  <select id="leaveTime" required>
                    <option value="">選擇時間</option>
                    <option value="07:00">07:00</option>
                    <option value="08:00">08:00</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                    <option value="18:00">18:00</option>
                    <option value="19:00">19:00</option>
                    <option value="20:00">20:00</option>
                    <option value="21:00">21:00</option>
                    <option value="22:00">22:00</option>
                    <option value="23:00">23:00</option>
                  </select>
                  <div class="error-tooltip" id="leaveTime-error">
                    請選擇申請時間
                  </div>
                </div>
              </div>

              <!-- 結束日期和時間（同一行） -->
              <div class="date-time-group">
                <div class="form-group">
                  <label for="backDate">結束日期</label>
                  <input
                    type="text"
                    id="backDate"
                    class="date-picker"
                    placeholder="選擇結束日期"
                  />
                  <div class="error-tooltip" id="backDate-error">
                    結束日期必須在申請日期之後
                  </div>
                </div>
                <div class="form-group">
                  <label for="backTime">結束時間</label>
                  <select id="backTime">
                    <option value="">選擇時間</option>
                    <option value="07:00">07:00</option>
                    <option value="08:00">08:00</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                    <option value="18:00">18:00</option>
                    <option value="19:00">19:00</option>
                    <option value="20:00">20:00</option>
                    <option value="21:00">21:00</option>
                    <option value="22:00">22:00</option>
                    <option value="23:00">23:00</option>
                  </select>
                  <div class="error-tooltip" id="backTime-error">
                    請選擇結束時間
                  </div>
                </div>
              </div>

              <!-- 其餘表單項目保持不變 -->
              <div class="form-group" id="locationGroup">
                <label for="location">前往地點</label>
                <input type="text" id="location" placeholder="請輸入地點" />
              </div>

              <div class="form-group">
                <label for="approveUserId" class="required">核准主管</label>
                <select id="approveUserId" required>
                  <option value="">請選擇核准主管</option>
                  <!-- 主管選項會由JavaScript動態填入 -->
                </select>
                <div class="error-tooltip" id="approveUserId-error">
                  請選擇核准主管
                </div>
              </div>

              <div class="form-group">
                <label for="desc" class="required">申請說明</label>
                <textarea
                  id="desc"
                  placeholder="請輸入申請說明"
                  required
                ></textarea>
                <div class="error-tooltip" id="desc-error">請輸入申請說明</div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button id="cancelApplicationBtn" class="button secondary-button">
              取消
            </button>
            <button id="submitApplicationBtn" class="button">提交申請</button>
          </div>
        </div>
      </div>

      <!-- 確認對話框 -->
      <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">確認操作</div>
            <button class="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <p id="confirmMessage">您確定要執行此操作嗎？</p>
          </div>
          <div class="modal-footer">
            <button id="confirmCancelBtn" class="button secondary-button">
              取消
            </button>
            <button id="confirmOkBtn" class="button">確認</button>
          </div>
        </div>
      </div>

      <div class="line-brand">首都集團多功能平台-線上申請-v1.0.0.9</div>
    </div>

    <!-- JavaScript -->
    <script>
      // 全局變數
      const base_url = "https://35.221.146.143.nip.io/linehook/" // API 基礎 URL
      const channelId = "2006992891" // 服務 ID
      const liffId = "2006993665-xkeLlPeW".trim() // LIFF ID

      // 用戶資訊
      let currentUser = null
      let eventItems = [] // 所有申請項目
      let categories = [] // 所有分類
      let approvers = [] // 可選的核准主管
      let currentStatus = "pending" // 當前檢視的申請狀態
      let currentCategory = null // 當前選中的分類
      let confirmCallback = null // 確認對話框的回呼函數

      // DOM 元素載入後初始化
      document.addEventListener("DOMContentLoaded", () => {
        // 初始化頁面元素的事件監聽器
        initEventListeners()

        // 初始化日期選擇器
        initDatePickers()

        // 初始化 LIFF
        initLIFF()
      })

      // 初始化事件監聽器
      function initEventListeners() {
        // 分頁切換
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            const status = tab.dataset.status
            setActiveTab(status)
            loadRecords()
          })
        })

        // 搜尋按鈕
        document.getElementById("searchBtn").addEventListener("click", () => {
          loadRecords()
        })

        // 新增申請按鈕
        document
          .getElementById("newApplicationBtn")
          .addEventListener("click", () => {
            showNewApplicationModal()
          })

        // 關閉新增申請對話框
        document.querySelectorAll(".modal-close").forEach((closeBtn) => {
          closeBtn.addEventListener("click", (event) => {
            event.target.closest(".modal-overlay").classList.add("hidden")
          })
        })

        // 取消新增申請
        document
          .getElementById("cancelApplicationBtn")
          .addEventListener("click", () => {
            document
              .getElementById("newApplicationModal")
              .classList.add("hidden")
          })

        // 提交申請
        document
          .getElementById("submitApplicationBtn")
          .addEventListener("click", () => {
            validateAndSubmitApplication()
          })

        // 確認對話框
        document
          .getElementById("confirmCancelBtn")
          .addEventListener("click", () => {
            document.getElementById("confirmModal").classList.add("hidden")
          })

        document
          .getElementById("confirmOkBtn")
          .addEventListener("click", () => {
            document.getElementById("confirmModal").classList.add("hidden")
            if (typeof confirmCallback === "function") {
              confirmCallback()
              confirmCallback = null
            }
          })
      }
      // 初始化日期選擇器
      function initDatePickers() {
        const today = new Date()
        const sevenDaysAgo = new Date()
        sevenDaysAgo.setDate(today.getDate() - 7)
        const datePickerOptions = {
          locale: "zh-tw",
          dateFormat: "Y-m-d",
          disableMobile: true,
        }

        // 初始化所有日期選擇器
        flatpickr("#startDate", {
          ...datePickerOptions,
          defaultDate: sevenDaysAgo,
        })

        flatpickr("#endDate", {
          ...datePickerOptions,
          defaultDate: today,
        })

        // 其他日期選擇器
        flatpickr("#leaveDate, #backDate", datePickerOptions)
      }

      // 初始化 LIFF SDK
      async function initLIFF() {
        showLoading()
        try {
          await liff.init({ liffId: liffId })
          console.log("LIFF 初始化成功")

          if (!liff.isLoggedIn()) {
            console.log("用戶未登入，引導登入...")
            liff.login()
            return
          }

          // 用戶已登入，取得用戶資料
          try {
            const profile = await liff.getProfile()
            console.log("獲取用戶資料成功:", profile.displayName)

            // 存儲LIFF提供的userId
            const liffUserId = profile.userId

            // 使用用戶 ID 檢查用戶是否已存在
            await checkAndLoadUserInfo(liffUserId)
          } catch (error) {
            console.error("獲取用戶資料失敗:", error)
            showStatusMessage("無法獲取用戶資料，請確保已授權應用程式", "error")
            hideLoading()
          }
        } catch (error) {
          console.error("LIFF 初始化失敗:", error)
          showStatusMessage(
            "LINE 應用程式初始化失敗，請確認網路連接並重新嘗試",
            "error"
          )
          hideLoading()
        }
      }
      // 檢查並載入用戶資訊
      async function checkAndLoadUserInfo(userId) {
        try {
          // 先設置 userId 為 LIFF 提供的值
          if (!currentUser) {
            currentUser = {
              userId: userId,
            }
          }

          const response = await fetch(`${base_url}User/checkUser`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: userId, channelId: channelId }),
          })

          if (response.status === 200) {
            // 更新其他使用者資訊，但保留 userId
            const userData = await response.json()
            console.log("獲取到的用戶資訊:", userData)
            currentUser = {
              ...userData,
              userId: userId, // 確保使用 LIFF 提供的 userId
            }

            // 顯示用戶資訊
            displayUserInfo(currentUser)

            // 載入申請項目
            await loadEventItems()

            // 載入潛在的核准主管
            await loadPotentialApprovers()

            // 載入申請記錄
            await loadRecords()
          } else {
            showStatusMessage("無法獲取用戶資訊，請先完成註冊", "error")
            setTimeout(() => {
              // 跳轉到註冊頁面
              window.location.href = "register.html"
            }, 2000)
          }
        } catch (error) {
          console.error("檢查用戶資訊失敗:", error)
          showStatusMessage("檢查用戶資訊時發生錯誤，請重新嘗試", "error")
        } finally {
          hideLoading()
        }
      }

      // 顯示用戶資訊
      function displayUserInfo(user) {
        const userInfoElement = document.getElementById("userInfo")
        userInfoElement.innerHTML = `
    <strong>${user.name || "用戶"}${
          user.empId ? " (" + user.empId + ")" : ""
        }</strong> - 
    ${user.company || ""} ${user.dept || ""} ${user.job || ""}
  `
        userInfoElement.classList.remove("hidden")
      }
      // 載入申請項目
      async function loadEventItems() {
        try {
          const response = await fetch(`${base_url}Leave/items`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          })

          if (response.ok) {
            eventItems = await response.json()
            console.log("申請項目:", eventItems)

            // 整理類別
            categories = [...new Set(eventItems.map((item) => item.catalog))]
            console.log("類別:", categories)

            // 初始化類別選項
            initCategoryTabs()
          } else {
            console.error("獲取申請項目失敗:", response.status)
            showStatusMessage("無法獲取申請項目，請重新嘗試", "error")
          }
        } catch (error) {
          console.error("載入申請項目失敗:", error)
          showStatusMessage("載入申請項目時發生錯誤", "error")
        }
      }

      // 載入潛在的核准主管
      async function loadPotentialApprovers() {
        try {
          const response = await fetch(
            `${base_url}Leave/approvers?company=${currentUser.company}&dept=${currentUser.dept}&excludeUserId=${currentUser.userId}`,
            {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            }
          )

          if (response.ok) {
            approvers = await response.json()
            console.log("核准主管:", approvers)
          } else {
            console.error("獲取核准主管失敗:", response.status)
            showStatusMessage("無法獲取核准主管列表", "error")
          }
        } catch (error) {
          console.error("載入核准主管失敗:", error)
          showStatusMessage("載入核准主管列表時發生錯誤", "error")
        }
      }
      // 載入申請記錄
      async function loadRecords() {
        showLoading()
        try {
          const startDate = document.getElementById("startDate").value
          const endDate = document.getElementById("endDate").value

          // 若沒有設定日期，預設為前7天至今
          if (!startDate || !endDate) {
            const today = new Date()
            const sevenDaysAgo = new Date()
            sevenDaysAgo.setDate(today.getDate() - 7)

            // 格式化日期為 YYYY-MM-DD
            endDate = today.toISOString().split("T")[0]
            startDate = sevenDaysAgo.toISOString().split("T")[0]

            // 更新輸入框的值
            document.getElementById("startDate").value = startDate
            document.getElementById("endDate").value = endDate
          }

          let url = `${base_url}Leave/leave?UserId=${currentUser.userId}&ApproveResult=${currentStatus}`

          // 添加日期查詢參數
          if (startDate && endDate) {
            url += `&StartDate=${startDate}&EndDate=${endDate}`
          }

          const response = await fetch(url, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          })

          if (response.ok) {
            const records = await response.json()
            console.log("申請記錄:", records)

            // 依日期排序（由大到小）
            records.sort((a, b) => {
              return new Date(b.leaveDate) - new Date(a.leaveDate)
            })

            // 顯示申請記錄
            displayRecords(records)
          } else {
            console.error("獲取申請記錄失敗:", response.status)
            showStatusMessage("無法獲取申請記錄", "error")
            displayRecords([])
          }
        } catch (error) {
          console.error("載入申請記錄失敗:", error)
          showStatusMessage("載入申請記錄時發生錯誤", "error")
          displayRecords([])
        } finally {
          hideLoading()
        }
      }

      // 設置激活的申請狀態分頁
      function setActiveTab(status) {
        currentStatus = status

        // 更新 tab 的激活狀態
        document.querySelectorAll(".tab").forEach((tab) => {
          if (tab.dataset.status === status) {
            tab.classList.add("active")
          } else {
            tab.classList.remove("active")
          }
        })
      }
      // 顯示申請記錄
      // 顯示申請記錄
      function displayRecords(records) {
        const recordsListElement = document.getElementById("recordsList")

        if (!recordsListElement) {
          console.error("找不到記錄列表元素")
          return
        }

        if (!records || records.length === 0) {
          // 直接設置空記錄訊息
          recordsListElement.innerHTML =
            '<div class="empty-list">無申請記錄</div>'
          return
        }

        let html = ""

        records.forEach((record) => {
          // 格式化狀態顯示
          let statusClass = ""
          let statusText = ""

          switch (record.approveResult) {
            case "pending":
              statusClass = "status-pending"
              statusText = "申請中"
              break
            case "pass":
              statusClass = "status-approved"
              statusText = "核准"
              break
            case "reject":
              statusClass = "status-rejected"
              statusText = "拒絕(請聯繫主管)"
              break
          }

          html += `
      <div class="record-item" data-id="${record.id}">
        <div class="record-header">
          <div class="record-title">
            <span class="record-status ${statusClass}">${statusText}</span>
            ${
              record.eventItem
                ? record.eventItem.itemName || "未知項目"
                : "未知項目"
            }
          </div>
          <div class="record-date">${record.leaveDate} ${record.leaveTime}</div>
        </div>
        <div class="record-details">
          ${record.desc}
          ${record.location ? `<br>地點: ${record.location}` : ""}
          ${record.backDate ? `<br>結束日期: ${record.backDate}` : ""}
          ${record.backTime ? `<br>結束時間: ${record.backTime}` : ""}
        </div>
        <div class="record-actions">
          <button class="cancel-btn button danger-button" onclick="confirmCancelApplication('${
            record.id
          }')">撤銷申請</button>
        </div>
      </div>
    `
        })

        recordsListElement.innerHTML = html
      }
      // 顯示確認對話框
      function showConfirmDialog(message, callback) {
        const confirmMessageElement = document.getElementById("confirmMessage")
        confirmMessageElement.textContent = message

        confirmCallback = callback

        document.getElementById("confirmModal").classList.remove("hidden")
      }

      // 初始化類別分頁
      function initCategoryTabs() {
        const categoryTabsElement = document.getElementById("categoryTabs")
        let html = ""

        categories.forEach((category, index) => {
          html += `<div class="category-tab${
            index === 0 ? " active" : ""
          }" data-category="${category}">${category}</div>`
        })

        categoryTabsElement.innerHTML = html

        // 第一個類別為默認選中
        if (categories.length > 0) {
          currentCategory = categories[0]
          updateEventItemOptions(currentCategory)
        }

        // 添加類別點擊事件
        document.querySelectorAll(".category-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            const category = tab.dataset.category
            currentCategory = category

            // 更新激活狀態
            document.querySelectorAll(".category-tab").forEach((t) => {
              t.classList.toggle("active", t === tab)
            })

            // 更新項目選擇
            updateEventItemOptions(category)
          })
        })
      }
      // 更新項目選擇下拉選單
      function updateEventItemOptions(category) {
        const selectElement = document.getElementById("eventItem")
        selectElement.innerHTML = '<option value="">請選擇申請項目</option>'

        const filteredItems = eventItems.filter(
          (item) => item.catalog === category
        )

        filteredItems.forEach((item) => {
          // 修改這裡: 不再使用 JSON.stringify，而是只儲存項目名稱
          const option = document.createElement("option")
          option.value = item.itemName // 只儲存 itemName 字串值
          option.textContent = item.itemName
          option.dataset.catalog = item.catalog // 使用 dataset 儲存 catalog
          selectElement.appendChild(option)
        })
      }

      // 顯示新增申請對話框
      function showNewApplicationModal() {
        // 重置表單
        document.getElementById("applicationForm").reset()

        // 更新主管選擇下拉選單
        updateApproverOptions()

        // 顯示模態框
        document
          .getElementById("newApplicationModal")
          .classList.remove("hidden")
      }
      // 清除時間選擇
      function clearTimeSelections() {
        document.getElementById("leaveTime").value = ""
        document.getElementById("backTime").value = ""
      }

      // 更新主管選擇下拉選單
      function updateApproverOptions() {
        const selectElement = document.getElementById("approveUserId")
        selectElement.innerHTML = '<option value="">請選擇核准主管</option>'

        approvers.forEach((approver) => {
          const option = document.createElement("option")
          option.value = approver.userId
          option.textContent = `${approver.name} (${
            approver.job || "未知職位"
          })`
          selectElement.appendChild(option)
        })
      }
      // 顯示錯誤提示
      function showError(fieldId, message) {
        const field = document.getElementById(fieldId)
        field.classList.add("error")

        const errorTooltip = document.getElementById(`${fieldId}-error`)
        if (errorTooltip) {
          errorTooltip.textContent = message
          errorTooltip.style.display = "block"

          // 2秒後自動隱藏錯誤提示
          setTimeout(() => {
            errorTooltip.style.display = "none"
            field.classList.remove("error")
          }, 3000)
        }

        return false
      }

      // 驗證並提交申請
      function validateAndSubmitApplication() {
        // 隱藏所有錯誤提示
        document.querySelectorAll(".error-tooltip").forEach((tooltip) => {
          tooltip.style.display = "none"
        })

        let isValid = true

        // 驗證申請項目
        const eventItemValue = document.getElementById("eventItem").value
        if (!eventItemValue) {
          isValid = showError("eventItem", "請選擇申請項目") && isValid
        }

        // 驗證申請日期
        const leaveDate = document.getElementById("leaveDate").value
        if (!leaveDate) {
          isValid = showError("leaveDate", "請選擇申請日期") && isValid
        }

        // 驗證申請時間
        const leaveTime = document.getElementById("leaveTime").value
        if (!leaveTime) {
          isValid = showError("leaveTime", "請選擇申請時間") && isValid
        }

        // 驗證核准主管
        const approveUserId = document.getElementById("approveUserId").value
        if (!approveUserId) {
          isValid = showError("approveUserId", "請選擇核准主管") && isValid
        }

        // 驗證申請說明
        const desc = document.getElementById("desc").value.trim()
        if (!desc) {
          isValid = showError("desc", "請輸入申請說明") && isValid
        }

        // 驗證結束日期（如果有填寫）
        const backDate = document.getElementById("backDate").value
        if (backDate && leaveDate && new Date(backDate) < new Date(leaveDate)) {
          isValid =
            showError("backDate", "結束日期必須在申請日期之後") && isValid
        }

        if (!isValid) {
          return
        }

        // 顯示確認對話框
        showConfirmDialog("您確定要提交此申請嗎？", submitApplication)
      }

      // 提交申請
      async function submitApplication() {
        showLoading()

        try {
          const eventItemSelect = document.getElementById("eventItem")
          const eventItemValue = eventItemSelect.value
          const eventCatalog =
            eventItemSelect.options[eventItemSelect.selectedIndex].dataset
              .catalog

          const applicationData = {
            userId: currentUser.userId,
            channelId: channelId,
            company: currentUser.company,
            dept: currentUser.dept,
            empId: currentUser.empId,
            name: currentUser.name,
            leaveDate: document.getElementById("leaveDate").value,
            leaveTime: document.getElementById("leaveTime").value,
            backDate: document.getElementById("backDate").value || null,
            backTime: document.getElementById("backTime").value || null,
            location: document.getElementById("location").value || null,
            eventItem: eventItemValue,
            eventCatalog: eventCatalog,
            eventItem: eventItem,
            desc: document.getElementById("desc").value,
            approveUserId: document.getElementById("approveUserId").value,
          }

          const response = await fetch(`${base_url}Leave/createLeave`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(applicationData),
          })

          if (response.ok) {
            showStatusMessage("申請已成功提交", "success")
            document
              .getElementById("newApplicationModal")
              .classList.add("hidden")
            await loadRecords()
          } else {
            // 在 modal 內顯示錯誤
            let errorMessage = "提交申請失敗"
            try {
              const errorData = await response.json()
              errorMessage = errorData.message || errorMessage
            } catch (parseError) {
              console.error("解析錯誤回應失敗:", parseError)
            }

            // 在 modal 內顯示錯誤訊息
            showModalError(errorMessage)
          }
        } catch (error) {
          console.error("提交申請失敗:", error)
          showStatusMessage("提交申請時發生錯誤", "error")
        } finally {
          hideLoading()
        }
      }

      // 新增的函數，用於在 modal 內顯示錯誤
      function showModalError(message) {
        // 確保 modal 中有一個顯示錯誤的元素
        const modalErrorElement = document.getElementById("modalErrorMessage")
        if (!modalErrorElement) {
          // 如果不存在，則創建一個
          const errorDiv = document.createElement("div")
          errorDiv.id = "modalErrorMessage"
          errorDiv.className = "status-message error"
          errorDiv.style.marginTop = "10px"

          // 將錯誤訊息元素插入到 modal 表單後面
          const modalForm = document.getElementById("applicationForm")
          modalForm.after(errorDiv)
        }

        // 顯示錯誤訊息
        document.getElementById("modalErrorMessage").textContent = message
        document.getElementById("modalErrorMessage").style.display = "block"
      }
      // 顯示狀態訊息
      function showStatusMessage(message, type) {
        const statusElement = document.getElementById("statusMessage")
        statusElement.textContent = message
        statusElement.className = "status-message"
        statusElement.classList.add(type)

        // 2秒後自動隱藏成功訊息
        if (type === "success") {
          setTimeout(() => {
            statusElement.style.display = "none"
          }, 3000)
        }
      }

      // 顯示載入中
      function showLoading() {
        document.getElementById("loading-overlay").classList.remove("hidden")
      }

      // 隱藏載入中
      function hideLoading() {
        document.getElementById("loading-overlay").classList.add("hidden")
      }

      // 安全地關閉視窗（如果在 LINE 瀏覽器內）
      function closeWindowSafely() {
        console.log("嘗試關閉窗口...")

        if (liff && liff.isInClient()) {
          try {
            console.log("在 LINE 內部，使用 liff.closeWindow()")
            liff.closeWindow()
          } catch (e) {
            console.error("關閉窗口失敗:", e)
            showStatusMessage("無法自動返回聊天室，請手動關閉視窗", "info")
          }
        } else {
          console.log("不在 LINE 瀏覽器內，顯示提示訊息")
          showStatusMessage("操作已完成。請手動關閉此視窗", "info")
        }
      }
      // 新增：在顯示對話框函數中添加自動滾動到視圖中間的邏輯
      function showNewApplicationModal() {
        // 重置表單
        document.getElementById("applicationForm").reset()

        // 更新主管選擇下拉選單
        updateApproverOptions()

        // 顯示模態框
        const modal = document.getElementById("newApplicationModal")
        modal.classList.remove("hidden")

        // 新增：確保模態框置中
        setTimeout(() => {
          const modalContent = modal.querySelector(".modal")
          if (modalContent) {
            // 滾動到頁面頂部，然後模態框會自動置中
            window.scrollTo({
              top: 0,
              behavior: "smooth",
            })
          }
        }, 100)
      }
    </script>
  </body>
</html>
