<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>éƒ½æœƒä¹‹æ˜Ÿä¿ç•™åº§ä½ç®¡ç†ç³»çµ±</title>
    <script>
      // éœéŸ³éå¿…è¦çš„ console è¼¸å‡ºï¼ˆä¿ç•™ errorï¼‰ï¼Œå¯é€é window.__ENABLE_DEBUG__ = true é‡æ–°é–‹å•Ÿ
      ;(function () {
        try {
          if (!window.__ENABLE_DEBUG__) {
            var noop = function () {}
            if (window.console) {
              console.log = noop
              console.info = noop
              console.debug = noop
              console.warn = noop
            }
          }
        } catch (e) {
          // å¿½ç•¥è¦†å¯«å¤±æ•—
        }
      })()
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        /* æ”¾å¤§ä¸»å…§å®¹å¯¬åº¦ï¼Œå……åˆ†åˆ©ç”¨å¯è¦–å€åŸŸ */
        max-width: 100%;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .trip-area {
        flex: 1 1 auto;
        padding: 15px;
        background: #ffffff;
        position: relative; /* è®“å…§éƒ¨è¨Šæ¯å¯çµ•å°å®šä½ï¼Œä¸å½±éŸ¿ç‰ˆé¢é«˜åº¦ */
        /* å›ºå®šé«˜åº¦ + å…§éƒ¨åˆ—è¡¨ç¨ç«‹æ²å‹•ï¼ˆä¸Šæ–¹æ¨™é¡Œ/è¨Šæ¯å€ä¸æ²å‹•ï¼‰ */
        max-height: 600px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* åƒ…è®“è¶Ÿæ¬¡åˆ—è¡¨å¯å‚ç›´æ²å‹• */
      .trip-area #tripsContainer {
        overflow-y: auto;
        flex: 1 1 auto;
        min-height: 0; /* é¿å…å­å®¹å™¨é«˜åº¦æ’çˆ† flex å®¹å™¨ */
      }

      .section-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 12px;
        color: #333;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 4px;
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }

      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .form-control:focus {
        border-color: #4caf50;
        outline: none;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
      }

      .time-input-group {
        display: flex;
        gap: 5px;
        align-items: center;
      }

      .time-input {
        width: 50px;
        text-align: center;
      }

      .time-input-large {
        width: 80px;
        height: 50px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        border: 2px solid #ddd;
        border-radius: 8px;
      }

      .time-input-large:focus {
        border-color: #4caf50;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
      }

      .time-separator {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin: 0 10px;
      }

      .vehicle-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
      }

      .suggestion-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .suggestion-item:hover,
      .suggestion-item.selected {
        background-color: #007bff;
        color: white;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .form-group {
        position: relative;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #4caf50;
        color: white;
      }

      .btn-primary:hover {
        background: #45a049;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-warning {
        background: #ffc107;
        color: #212529;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-info {
        background: #17a2b8;
        color: white;
      }

      /* åœç”¨å‹•ç•«/è½‰å ´ä»¥é¿å…é‡æ¸²æŸ“æ™‚çš„æŠ–å‹• */
      .no-anim,
      .no-anim * {
        transition: none !important;
        animation: none !important;
      }

      /* éŠæˆ²åŒ–å…ƒç´  */
      .trip-card {
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        /* åƒ…é‡å°ä¸å½±éŸ¿æ’ç‰ˆçš„å±¬æ€§åšè½‰å ´ï¼Œé¿å…æŠ–å‹• */
        transition: box-shadow 0.25s ease, border-color 0.25s ease;
        position: relative;
      }

      .trip-card:hover {
        /* ä¸åšä½ç§»ï¼Œä½¿ç”¨æ›´æ˜é¡¯çš„å¤–ç’°èˆ‡é™°å½±åšé«˜äº® */
        box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.35),
          0 12px 24px rgba(0, 0, 0, 0.22);
        border-color: #3399ff;
        filter: brightness(1.02);
      }

      /* éµç›¤å¯åŠæ€§ï¼šfocus ä¹Ÿæœ‰ç›¸åŒé«˜äº® */
      .trip-card:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.45),
          0 12px 24px rgba(0, 0, 0, 0.22);
        border-color: #3399ff;
        filter: brightness(1.02);
      }

      .trip-card.ready {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
      }

      .trip-card.pending {
        border-color: #ffc107;
        background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
      }

      .trip-card.notified {
        border-color: #007bff;
        background: linear-gradient(135deg, #f0f8ff 0%, #e3f2fd 100%);
      }

      .trip-card.completed {
        border-color: #6c757d;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        opacity: 0.8;
      }

      /* è·¯ç·šé¡è‰²é…ç½® - èˆ‡å¯æ­ä¹˜è·¯ç·šé¡è‰²ä¿æŒä¸€è‡´ */
      .trip-card.route-208802 {
        border-color: #007bff;
        background: linear-gradient(135deg, #f0f8ff 0%, #e3f2fd 100%);
      }

      .trip-card.route-2088A2 {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
      }

      .trip-card.route-2088B2 {
        border-color: #fd7e14;
        background: linear-gradient(135deg, #fff8f0 0%, #ffe8cc 100%);
      }

      .trip-card.route-default {
        border-color: #6c757d;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      }

      /* ç·Šæ¹Šå¡ç‰‡é ­éƒ¨ */
      .trip-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .trip-basic-info {
        flex: 1;
      }

      .trip-quick-stats {
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 12px;
        margin-right: 35px; /* ç‚ºtoggleæŒ‰éˆ•ç•™å‡ºç©ºé–“ */
      }

      .seat-indicator {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 15px;
        padding: 4px 8px;
        font-weight: bold;
        white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
      }

      .seat-indicator.full {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .seat-indicator.ready {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }

      /* æ‘ºç–ŠåŠŸèƒ½ */
      .trip-collapsible {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .trip-collapsible.expanded {
        max-height: 500px;
      }

      .toggle-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 14px;
        cursor: pointer;
        color: #333;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .toggle-btn:hover {
        background: #f8f9fa;
        border-color: #4caf50;
        color: #4caf50;
        transform: scale(1.1);
      }

      .toggle-btn.expanded {
        transform: rotate(180deg);
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .toggle-btn.expanded:hover {
        transform: rotate(180deg) scale(1.1);
      }

      /* è®“æ•´å€‹trip-headeréƒ½å¯ä»¥é»æ“Š */
      .trip-header {
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .trip-header:hover {
        background-color: rgba(76, 175, 80, 0.05);
        border-radius: 5px;
      }

      .bus-icon {
        width: 40px;
        height: 28px;
        background: #4caf50;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 10px;
        font-size: 12px;
      }

      /* bus-icon è·¯ç·šé¡è‰²é…ç½® */
      .bus-icon.route-208802 {
        background: #007bff; /* è—è‰² */
      }

      .bus-icon.route-2088A2 {
        background: #28a745; /* ç¶ è‰² */
      }

      .bus-icon.route-2088B2 {
        background: #fd7e14; /* æ©™è‰² */
      }

      .bus-icon.route-default {
        background: #6c757d; /* ç°è‰² */
      }

      /* ä¹˜å®¢å€åŸŸå„ªåŒ– */
      .passenger-area {
        margin-top: 8px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 5px;
        font-size: 13px;
      }

      .passenger-area h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #495057;
      }

      /* æ§åˆ¶æŒ‰éˆ•å€åŸŸ */
      .trip-controls {
        display: flex;
        gap: 5px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .trip-controls .btn {
        font-size: 11px;
        padding: 5px 10px;
      }

      .passenger-icon {
        width: 30px;
        height: 30px;
        background: #007bff;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        margin: 2px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .passenger-icon:hover {
        transform: scale(1.1);
      }

      .passenger-icon.boarded {
        background: #28a745;
      }

      .passenger-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.25s ease, border-color 0.25s ease;
        cursor: grab;
      }

      .passenger-card:hover {
        /* ä¸åšä½ç§»ï¼Œä½¿ç”¨å¤–ç’° + é™°å½± + æ·¡è‰²åº•åšé«˜äº® */
        box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.28),
          0 10px 20px rgba(0, 0, 0, 0.18);
        border-color: #99c8ff;
        background: linear-gradient(
            0deg,
            rgba(77, 163, 255, 0.06),
            rgba(77, 163, 255, 0.06)
          ),
          #ffffff;
      }

      .passenger-card:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.38),
          0 10px 20px rgba(0, 0, 0, 0.18);
        border-color: #66b3ff;
        background: linear-gradient(
            0deg,
            rgba(77, 163, 255, 0.08),
            rgba(77, 163, 255, 0.08)
          ),
          #ffffff;
      }

      .passenger-card.dragging {
        opacity: 0.7;
        transform: rotate(5deg);
      }

      .passenger-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .passenger-name {
        font-weight: bold;
        color: #333;
        font-size: 14px;
      }

      .passenger-seats {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .passenger-route {
        color: #666;
        font-size: 12px;
        margin-bottom: 6px;
      }

      .passenger-contact {
        color: #888;
        font-size: 11px;
        margin-bottom: 8px;
      }

      .passenger-actions {
        display: flex;
        gap: 5px;
      }

      .btn-xs {
        padding: 3px 8px;
        font-size: 11px;
        border-radius: 3px;
      }

      .pending-passengers {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        max-height: 600px;
        overflow-y: auto;
      }

      .trip-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .route-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
      }

      .route-option {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
      }

      .route-option:hover {
        background: #e3f2fd;
        border-color: #2196f3;
      }

      .route-option.selected {
        /* åŸºæœ¬é¸å–ç‹€æ…‹ï¼Œå¯¦éš›é¡è‰²ç”±ä¸‹æ–¹å„è·¯ç·šè¦†è“‹ */
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      /* è·¯ç·šé¸æ“‡æŒ‰éˆ•ï¼šæ¯”ç…§ä¸‰å€‹è·¯ç·šçš„é…è‰²ï¼ˆé¸å–æ™‚ï¼‰*/
      .route-option.selected.route-208802 {
        background: #007bff; /* è—è‰² - å°1 */
        border-color: #007bff;
        color: #fff;
      }
      .route-option.selected.route-2088A2 {
        background: #28a745; /* ç¶ è‰² - è—15 */
        border-color: #28a745;
        color: #fff;
      }
      .route-option.selected.route-2088B2 {
        background: #fd7e14; /* æ©˜è‰² - ç´…33 */
        border-color: #fd7e14;
        color: #fff;
      }
      .route-option.selected.route-default {
        background: #6c757d; /* ç°è‰² - å…¶ä»–è·¯ç·š */
        border-color: #6c757d;
        color: #fff;
      }

      .vehicle-selector {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-top: 10px;
      }

      .vehicle-option {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background 0.3s;
      }

      .vehicle-option:hover {
        background: #f5f5f5;
      }

      .vehicle-option.selected {
        background: #4caf50;
        color: white;
      }

      .stats-panel {
        display: flex;
        gap: 12px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .stat-card {
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
        min-width: 90px;
      }

      .stat-number {
        font-size: 18px;
        font-weight: bold;
        color: #4caf50;
      }

      .stat-label {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* æ‹–æ‹½ç›¸é—œæ¨£å¼ */
      .passenger-icon {
        cursor: grab;
        user-select: none;
        transition: all 0.2s ease;
      }

      .passenger-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .passenger-icon:active {
        cursor: grabbing;
        transform: scale(0.95);
      }

      .trip-card {
        transition: all 0.3s ease;
        position: relative;
      }

      .trip-card.drag-over {
        border: 2px dashed #4caf50;
        background-color: rgba(76, 175, 80, 0.1);
        transform: scale(1.02);
      }

      /* æ‹–æ‹½è¢«é˜»æ“‹ï¼ˆå·²ç™¼è»Šï¼‰è¦–è¦ºæ¨£å¼ */
      .trip-card.drag-blocked {
        border: 2px solid rgba(220, 53, 69, 0.6) !important;
        background: repeating-linear-gradient(
          45deg,
          rgba(220, 53, 69, 0.08),
          rgba(220, 53, 69, 0.08) 6px,
          rgba(220, 53, 69, 0.14) 6px,
          rgba(220, 53, 69, 0.14) 12px
        );
        cursor: not-allowed !important;
        position: relative;
      }

      .trip-card.drag-blocked::before {
        content: "å·²ç™¼è»Šä¸å¯å†æ’å…¥";
        position: absolute;
        top: 4px;
        left: 4px;
        background: rgba(220, 53, 69, 0.9);
        color: #fff;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        letter-spacing: 0.5px;
        pointer-events: none;
        animation: fadeIn 0.25s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .trip-card::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(76, 175, 80, 0.05);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .trip-card.drag-over::after {
        opacity: 1;
      }

      /* éŸ³é »å•Ÿç”¨ Modal æ¨£å¼ */
      #audioActivationModal {
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #audioActivationContent {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        width: 80%;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      #activateAudioBtn {
        background-color: #4caf50;
        color: white;
        padding: 15px 30px;
        font-size: 20px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s;
      }

      #activateAudioBtn:hover {
        background-color: #45a049;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
      }

      .close:hover {
        color: #000;
      }

      .error-message {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 10px 12px;
        border-radius: 6px;
        margin: 0; /* é¿å…æ¨æ“ ç‰ˆé¢ */
        display: none;
        position: absolute; /* æ”¹ç‚ºæµ®å‹•é¡¯ç¤ºï¼Œé¿å…å€å¡Šè·³å‹• */
        top: 8px;
        right: 8px;
        max-width: 42%;
        z-index: 20;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
      }

      .success-message {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 10px 12px;
        border-radius: 6px;
        margin: 0; /* é¿å…æ¨æ“ ç‰ˆé¢ */
        display: none;
        position: absolute; /* æ”¹ç‚ºæµ®å‹•é¡¯ç¤ºï¼Œé¿å…å€å¡Šè·³å‹• */
        top: 8px;
        right: 8px;
        max-width: 42%;
        z-index: 20;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
      }

      /* é€šçŸ¥å€å¡Šèˆ‡éŸ³æ•ˆ */
      #notification {
        position: fixed;
        top: 24px;
        right: 24px;
        background: #4caf50;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.2);
        font-size: 16px;
        z-index: 9999;
        display: none;
        animation: fadeInOut 2.5s;
      }
      @keyframes fadeInOut {
        0% {
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* éŸ³æ•ˆå…ƒä»¶éš±è— */
      #notifySound {
        display: none;
      }

      /* ä¿æŒå·¦å³åˆ†æ¬„ï¼Œä¸å†åœ¨ 576px ä»¥ä¸‹æ”¹ç‚ºä¸Šä¸‹æ’åˆ— */

      /* å¹³æ¿å„ªåŒ–ï¼ˆ992px ä»¥ä¸‹ï¼‰ï¼šå¢åŠ æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†å¯é»æ“Šå€ã€ç¸®å°é–“è· */
      @media (max-width: 992px) {
        .main-content {
          gap: 12px;
        }
        .btn {
          padding: 12px 16px;
          font-size: 15px;
        }
        .time-input-large {
          width: 72px;
          height: 44px;
          font-size: 20px;
        }
        .sidebar,
        .passenger-area,
        .trip-area {
          padding: 12px;
        }
      }

      @media (max-width: 768px) {
        .route-selector {
          grid-template-columns: repeat(2, 1fr);
        }
        .main-content {
          gap: 10px;
        }
        body {
          padding: 12px;
        }
        .header h1 {
          font-size: 20px;
        }
        .trip-card {
          padding: 8px;
        }
      }

      /* æ‰‹æ©Ÿå„ªåŒ–ï¼ˆ576px ä»¥ä¸‹ï¼‰ï¼šå–®æ¬„ã€ç¸®å°é‚Šè·ã€å…ƒç´ æ»¿å¯¬ */
      @media (max-width: 576px) {
        body {
          padding: 8px;
        }
        .main-content {
          gap: 8px;
        }
        .sidebar,
        .passenger-area,
        .trip-area {
          padding: 10px;
        }
        .route-selector {
          grid-template-columns: 1fr;
        }
        .btn {
          padding: 10px 14px;
          font-size: 14px;
        }
      }

      /* è·¯ç·šå¾½ç« æ¨£å¼ */
      .route-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        color: white;
        margin: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* è·¯ç·šé…è‰² - åƒè€ƒkeepSeatApp.html */
      .route-208802 {
        background-color: #007bff; /* è—è‰² - å°1 */
      }

      .route-2088A2 {
        background-color: #28a745; /* ç¶ è‰² - è—15 */
      }

      .route-2088B2 {
        background-color: #fd7e14; /* æ©˜è‰² - ç´…33 */
      }

      .route-default {
        background-color: #6c757d; /* ç°è‰² - å…¶ä»–è·¯ç·š */
      }

      /* ä¹˜å®¢å¡ç‰‡ä¸­çš„è·¯ç·šé¡¯ç¤º */
      .passenger-route small {
        line-height: 1.6;
      }

      /* æ–°å¢è¦–è¦ºæç¤ºæ¨£å¼ */
      .visual-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(76, 175, 80, 0.9);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        font-size: 14px;
        z-index: 10000;
        transition: opacity 0.5s;
      }

      .visual-notification.error {
        background: rgba(220, 53, 69, 0.9);
      }

      .visual-notification.success {
        background: rgba(40, 167, 69, 0.9);
      }

      /* ä¸»å…§å®¹ï¼šå·¦å³åˆ†æ¬„ */
      .main-content {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        min-height: 70vh;
      }
      .main-content > .passenger-area {
        flex: 0 0 520px;
        max-width: 520px;
      }

      /* Header ç½®ä¸­èˆ‡è‰²å½©è¨­å®š */
      .header {
        text-align: center;
        padding: 16px 20px;
      }
      .header h1 {
        color: #2f855a; /* ä¸»æ¨™é¡Œç¶ è‰² */
      }
      .header p {
        color: #495057; /* èªªæ˜æ–‡å­—æ·±ç° */
      }
      .header p #currentDate {
        color: #007bff; /* æ—¥æœŸå¼·èª¿ç‚ºè—è‰² */
        font-weight: 600;
      }

      /* é ‚éƒ¨å·¥å…·åˆ—ï¼šçµ±ä¸€æ§åˆ¶å°ºå¯¸èˆ‡è¦–è¦ºå±¤ç´š */
      .top-toolbar .form-control {
        height: 44px;
        font-size: 16px;
        padding: 8px 12px;
      }
      /* è»Šç‰Œè¼¸å…¥ç¨å¾®æ”¾å¤§å­—ç´š */
      .top-toolbar #vehicleNumber.form-control {
        font-size: 18px;
      }
      /* æ™‚é–“è¼¸å…¥åœ¨å·¥å…·åˆ—å…§æ”¹ç‚ºè¼ƒå°é«˜åº¦ï¼Œèˆ‡å…¶ä»–æ§åˆ¶ä¸€è‡´ */
      .top-toolbar .time-input-large {
        height: 44px;
        width: 72px; /* ç¶­æŒå¯¬åº¦æ–¹ä¾¿è¼¸å…¥ */
        font-size: 18px;
        border-width: 2px;
      }
      .top-toolbar .btn {
        height: 44px;
        padding: 0 16px;
        font-size: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      /* è·¯ç·šæŒ‰éˆ•ç¸®å°ï¼Œä¸¦èˆ‡å…¶ä»–æ§åˆ¶ç¶­æŒä¸€è‡´é«˜åº¦ */
      .top-toolbar .route-selector {
        gap: 8px;
      }
      .top-toolbar .route-option {
        padding: 6px 10px;
        font-size: 14px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>éƒ½æœƒä¹‹æ˜Ÿè»Šè¼›åº§ä½ä¿ç•™ç³»çµ±</h1>
        <p>v1.0.0.35| <span id="currentDate"></span> | åƒ…é¡¯ç¤ºç•¶æ—¥è³‡æ–™</p>
      </div>

      <!-- é ‚éƒ¨æ–°å¢è¶Ÿæ¬¡å·¥å…·åˆ— -->
      <div
        class="top-toolbar"
        style="
          background: #fff;
          padding: 12px 16px;
          border-bottom: 1px solid #e9ecef;
          display: flex;
          gap: 12px;
          align-items: flex-end;
          flex-wrap: wrap;
        "
      >
        <form
          id="newTripForm"
          style="
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-wrap: wrap;
            width: 100%;
          "
        >
          <div class="form-group" style="min-width: 220px; flex: 1 1 260px">
            <label>é¸æ“‡è·¯ç·š:</label>
            <div class="route-selector" id="routeSelector"></div>
            <input type="hidden" id="selectedRoute" name="route" />
          </div>
          <div class="form-group" style="min-width: 160px">
            <label>è»Šè¼›è™Ÿç¢¼:</label>
            <input
              type="text"
              class="form-control"
              id="vehicleNumber"
              placeholder="è«‹è¼¸å…¥è»Šè™Ÿ"
              maxlength="10"
            />
          </div>
          <div class="form-group" style="display: flex; flex-direction: column">
            <label>ç™¼è»Šæ™‚é–“:</label>
            <div class="time-input-group">
              <input
                type="text"
                class="form-control time-input-large"
                id="hourInput"
                maxlength="2"
                placeholder="æ™‚"
                pattern="[0-9]*"
              />
              <span class="time-separator">:</span>
              <input
                type="text"
                class="form-control time-input-large"
                id="minuteInput"
                maxlength="2"
                placeholder="åˆ†"
                pattern="[0-9]*"
              />
            </div>
          </div>
          <div class="form-group" style="min-width: 160px">
            <label>ä¿ç•™åº§ä½æ•¸é‡:</label>
            <input
              type="number"
              class="form-control"
              id="keepCountInput"
              placeholder="ä¿ç•™åº§ä½æ•¸"
              min="1"
              max="40"
              value="4"
            />
          </div>
          <div
            class="form-group"
            style="align-self: stretch; display: flex; align-items: flex-end"
          >
            <button type="submit" class="btn btn-primary">ğŸšŒ å»ºç«‹è¶Ÿæ¬¡</button>
          </div>
        </form>
        <!-- é¡¯ç¤ºå·²ç™¼è»Šé–‹é—œ -->
        <div
          class="show-completed-wrapper"
          style="display: flex; align-items: center; gap: 6px"
        >
          <label
            for="showCompletedToggle"
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              cursor: pointer;
              font-size: 14px;
              margin: 0;
            "
          >
            <input
              type="checkbox"
              id="showCompletedToggle"
              style="transform: scale(1.2); cursor: pointer"
            />
            é¡¯ç¤ºå·²ç™¼è»Šè¶Ÿæ¬¡
          </label>
        </div>
      </div>

      <div class="main-content">
        <div class="passenger-area">
          <div class="section-title">ğŸ‘¥ å¾…ä¿ç•™ä¹˜å®¢</div>
          <div class="pending-passengers" id="pendingPassengersList">
            <!-- å‹•æ…‹è¼‰å…¥å¾…æ’ç­†æ•¸çš„ä¹˜å®¢ -->
          </div>
        </div>

        <!-- å³å´è¶Ÿæ¬¡å€åŸŸ -->
        <div class="trip-area">
          <div class="section-title">ğŸš è¶Ÿæ¬¡ç®¡ç†</div>
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
          <div id="tripsContainer">
            <!-- å‹•æ…‹è¼‰å…¥è¶Ÿæ¬¡å¡ç‰‡ -->
          </div>
        </div>
      </div>
    </div>

    <!-- ç·¨è¼¯è¶Ÿæ¬¡æ¨¡æ…‹æ¡† -->
    <div id="editTripModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>âœï¸ ç·¨è¼¯è¶Ÿæ¬¡</h2>
        <form id="editTripForm">
          <input type="hidden" id="editTripId" />

          <div class="form-group">
            <label>è·¯ç·š:</label>
            <div class="route-selector" id="editRouteSelector">
              <!-- å‹•æ…‹è¼‰å…¥è·¯ç·š -->
            </div>
            <input type="hidden" id="editSelectedRoute" />
          </div>

          <div class="form-group">
            <label>è»Šè¼›è™Ÿç¢¼:</label>
            <input
              type="text"
              class="form-control"
              id="editVehicleNumber"
              placeholder="è«‹è¼¸å…¥è»Šè™Ÿ"
              maxlength="10"
            />
          </div>

          <div class="form-group">
            <label>ç™¼è»Šæ™‚é–“:</label>
            <div class="time-input-group">
              <input
                type="text"
                class="form-control time-input-large"
                id="editHourInput"
                maxlength="2"
                placeholder="æ™‚"
                pattern="[0-9]*"
              />
              <span class="time-separator">:</span>
              <input
                type="text"
                class="form-control time-input-large"
                id="editMinuteInput"
                maxlength="2"
                placeholder="åˆ†"
                pattern="[0-9]*"
              />
            </div>
          </div>

          <div class="form-group">
            <label>ä¿ç•™åº§ä½æ•¸é‡:</label>
            <div style="position: relative">
              <input
                type="number"
                class="form-control"
                id="editKeepCountInput"
                placeholder="ä¿ç•™åº§ä½æ•¸"
                min="1"
                max="40"
                value="4"
              />
              <small
                id="seatCountHint"
                style="display: block; color: #666; margin-top: 4px"
              >
                <i class="fa fa-info-circle"></i>
                åº§ä½æ•¸ä¸èƒ½å°æ–¼åŸå§‹åº§ä½æ•¸æˆ–å·²åˆ†é…çš„åº§ä½æ•¸
              </small>
            </div>
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜</button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeEditModal()"
            >
              âŒ å–æ¶ˆ
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- é€šçŸ¥å€å¡Šèˆ‡éŸ³æ•ˆ -->
    <style>
      #notification {
        position: fixed;
        top: 24px;
        right: 24px;
        background: #4caf50;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.2);
        font-size: 16px;
        z-index: 9999;
        display: none;
        animation: fadeInOut 2.5s;
      }
      @keyframes fadeInOut {
        0% {
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
    </style>
    <audio id="notifySound" src="audio/2456.wav" preload="auto"></audio>

    <div id="notification"></div>
    <!-- å…¨åŸŸæµ®å‹•è¨Šæ¯å®¹å™¨ï¼ˆé¿å…æ¨æ“ ä¸»ç‰ˆé¢ï¼‰ -->
    <div
      id="globalMessageHost"
      style="
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
      "
    ></div>

    <script>
      // èˆ‡ keepSeatApp.html ä¸€è‡´çš„ API åŸºåº•ç¶²å€
      const BASE_URL = "https://35.221.146.143.nip.io/linehook"
      //const BASE_URL = "http://localhost:5000/api"
      // ======= ä¿®æ­£ showLoading æœªå®šç¾©ï¼Œä¸¦åŠ ä¸Šé€šçŸ¥/éŸ³æ•ˆåŠŸèƒ½ =======
      function showLoading(show) {
        var loading = document.getElementById("loading")
        if (loading) {
          loading.style.display = show ? "block" : "none"
        }
      }

      // æ–°å¢è¦–è¦ºæç¤ºåŠŸèƒ½
      function showVisualNotification(message, type = "success") {
        // ç§»é™¤å…ˆå‰çš„é€šçŸ¥
        const oldNotifications = document.querySelectorAll(
          ".visual-notification"
        )
        oldNotifications.forEach((n) => n.remove())

        const notification = document.createElement("div")
        notification.className = `visual-notification ${type}`
        notification.textContent = message
        document.body.appendChild(notification)

        setTimeout(() => {
          notification.style.opacity = "0"
          setTimeout(() => notification.remove(), 500)
        }, 3000)
      }

      // è¼‰å…¥éŸ³æ•ˆæª”ä¸¦é å…ˆæ’­æ”¾ï¼ˆéœéŸ³ï¼‰ä¾†é¿å…ç¬¬ä¸€æ¬¡æ’­æ”¾å¤±æ•—
      function preloadAudio() {
        const sound = document.getElementById("notifySound")
        if (sound) {
          // å…ˆå°‡éŸ³é‡è¨­ç‚º0
          const originalVolume = sound.volume
          sound.volume = 0
          // æ’­æ”¾ç„¶å¾Œç«‹å³æš«åœï¼Œå¼·åˆ¶ç€è¦½å™¨è¼‰å…¥éŸ³æ•ˆ
          sound
            .play()
            .then(() => {
              sound.pause()
              sound.currentTime = 0
              sound.volume = originalVolume
              console.log("éŸ³æ•ˆå·²é å…ˆè¼‰å…¥ï¼Œç¬¬ä¸€æ¬¡æ’­æ”¾æ‡‰è©²å¯ä»¥æ­£å¸¸é‹ä½œ")
            })
            .catch((error) => {
              console.warn("é å…ˆè¼‰å…¥éŸ³æ•ˆå¤±æ•—ï¼Œå¯èƒ½ä»éœ€è¦ç”¨æˆ¶äº’å‹•:", error)
            })
        }
      }

      // é é¢åŠ è¼‰å¾Œç«‹å³é å…ˆè¼‰å…¥éŸ³æ•ˆ
      document.addEventListener("DOMContentLoaded", () => {
        const AudioContext = window.AudioContext || window.webkitAudioContext
        if (AudioContext && !window.globalAudioContext) {
          window.globalAudioContext = new AudioContext()
        }
        const audioContext = window.globalAudioContext
        if (audioContext && audioContext.state === "suspended") {
          audioContext
            .resume()
            .then(() => {
              console.log("éŸ³é »ä¸Šä¸‹æ–‡å·²å•Ÿç”¨")
              preloadAudio() // é å…ˆè¼‰å…¥éŸ³æ•ˆ
            })
            .catch((error) => {
              console.warn("éŸ³é »ä¸Šä¸‹æ–‡å•Ÿç”¨å¤±æ•—:", error)
            })
        } else {
          preloadAudio() // é å…ˆè¼‰å…¥éŸ³æ•ˆ
        }
      })

      // é¡¯ç¤ºéŸ³é »å•Ÿç”¨ Modal
      function showAudioActivationModal() {
        // å‰µå»º modal HTML
        const modalHtml = `
          <div id="audioActivationModal">
            <div id="audioActivationContent">
              <h2>å•Ÿç”¨é€šçŸ¥éŸ³æ•ˆ</h2>
              <p>ç‚ºäº†èƒ½å¤ åœ¨æ–°é ç´„æˆ–å–æ¶ˆæ™‚æ’­æ”¾æç¤ºéŸ³ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿç”¨éŸ³æ•ˆç³»çµ±ã€‚</p>
              <p>é€™æ˜¯ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œéœ€è¦æ‚¨çš„äº’å‹•æ‰èƒ½å•Ÿç”¨éŸ³æ•ˆã€‚</p>
              <button id="activateAudioBtn">é»æ“Šé€™è£¡å•Ÿç”¨éŸ³æ•ˆ</button>
            </div>
          </div>
        `

        // æ·»åŠ åˆ°é é¢
        document.body.insertAdjacentHTML("beforeend", modalHtml)

        // è¨­ç½®å•Ÿç”¨æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document
          .getElementById("activateAudioBtn")
          .addEventListener("click", function () {
            // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
            initializeAudioSystem()

            // æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆ
            playTestSound()

            // é—œé–‰ modal
            document.getElementById("audioActivationModal").remove()

            // é¡¯ç¤ºæˆåŠŸé€šçŸ¥
            showVisualNotification("éŸ³æ•ˆç³»çµ±å·²æˆåŠŸå•Ÿç”¨ï¼", "success")
          })
      }

      // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
      function initializeAudioSystem() {
        try {
          // å‰µå»ºéŸ³é »å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if (!document.getElementById("notifySound")) {
            const audioElement = document.createElement("audio")
            audioElement.id = "notifySound"
            audioElement.src = "audio/2456.wav" // è¨­å®šæœ¬åœ°éŸ³æ•ˆä¾†æº
            audioElement.preload = "auto"
            document.body.appendChild(audioElement)
          }

          // å‰µå»º AudioContext ä¸¦å•Ÿç”¨
          window.audioContext = new (window.AudioContext ||
            window.webkitAudioContext)()
          if (window.audioContext.state === "suspended") {
            window.audioContext.resume()
          }

          console.log("éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–æˆåŠŸï¼Œç‹€æ…‹: " + window.audioContext.state)
          return true
        } catch (error) {
          console.error("åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±å¤±æ•—:", error)
          return false
        }
      }

      // æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆ
      function playTestSound() {
        try {
          const sound = document.getElementById("notifySound")
          if (sound) {
            // é‡ç½®æ’­æ”¾ä½ç½®
            sound.currentTime = 0

            // æ’­æ”¾è²éŸ³
            sound
              .play()
              .then(() => {
                console.log("æ¸¬è©¦éŸ³æ•ˆæ’­æ”¾æˆåŠŸ")
              })
              .catch((error) => {
                console.error("æ¸¬è©¦éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", error)
              })
          } else {
            console.error("æ‰¾ä¸åˆ°éŸ³æ•ˆå…ƒç´ ")
          }
        } catch (error) {
          console.error("æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:", error)
        }
      }

      // å…¨åŸŸè®Šæ•¸
      let routes = []
      let vehicles = []
      let trips = []
      let pendingPassengers = []
      // é¡¯ç¤ºå·²ç™¼è»Šè¶Ÿæ¬¡çš„åå¥½
      let showCompletedTrips = false

      // è»Šè¼›è‡ªå‹•å®Œæˆç›¸é—œè®Šæ•¸
      let vehicleData = []
      let selectedSuggestionIndex = -1
      let visibleSuggestions = []
      let lastInputValue = ""

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // å…ˆé¡¯ç¤ºéŸ³é »å•Ÿç”¨ modalï¼Œç„¶å¾Œå†åˆå§‹åŒ–é é¢
        showAudioActivationModal()

        initializePage()
        setupEventListeners()
      })

      function initializePage() {
        // é¡¯ç¤ºç•¶å‰æ—¥æœŸ
        updateCurrentDate()

        showLoading(true)
        Promise.all([
          loadRoutes(),
          loadTrips(),
          loadPendingPassengers(),
          loadVehicleData(),
        ])
          .then(() => {
            showLoading(false)
            // çµ±è¨ˆå€å·²ç§»é™¤
          })
          .catch((error) => {
            showError("è¼‰å…¥è³‡æ–™å¤±æ•—: " + error.message)
            showLoading(false)
          })
      }

      function updateCurrentDate() {
        const today = new Date()
        const dateString = today.toLocaleDateString("zh-TW", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          weekday: "short",
        })
        document.getElementById("currentDate").textContent = dateString
      }

      function setupEventListeners() {
        // æ–°å¢è¶Ÿæ¬¡è¡¨å–®
        document
          .getElementById("newTripForm")
          .addEventListener("submit", createTrip)

        // é¡¯ç¤ºå·²ç™¼è»Šé–‹é—œ
        const showCompletedToggle = document.getElementById(
          "showCompletedToggle"
        )
        if (showCompletedToggle) {
          // å¾ localStorage é‚„åŸ
          try {
            const saved = localStorage.getItem("showCompletedTrips")
            if (saved === "true") {
              showCompletedTrips = true
              showCompletedToggle.checked = true
            }
          } catch (_) {}
          showCompletedToggle.addEventListener("change", () => {
            showCompletedTrips = !!showCompletedToggle.checked
            try {
              localStorage.setItem(
                "showCompletedTrips",
                showCompletedTrips ? "true" : "false"
              )
            } catch (_) {}
            const mode = showCompletedTrips ? "completed" : "active"
            showDisplayModeBanner(showCompletedTrips)
            loadTrips(mode)
              .then(() => {
                // é‡æ–°è¼‰å…¥å¾…æ’ä¹˜å®¢ä»¥åˆ·æ–°æŒ‰éˆ•ç‹€æ…‹ / draggable
                return loadPendingPassengers()
              })
              .then(() => {
                applyAssignUIState()
              })
              .catch(() => {
                renderTripsSync()
                applyAssignUIState()
              })
          })
        }

        // ç·¨è¼¯è¶Ÿæ¬¡è¡¨å–®
        document
          .getElementById("editTripForm")
          .addEventListener("submit", updateTrip)

        // æ™‚é–“è¼¸å…¥è™•ç†
        setupTimeInputs()

        // é»æ“Šå¤–éƒ¨éš±è—è»Šè¼›å»ºè­°
        document.addEventListener("click", function (e) {
          const vehicleInput = document.getElementById("vehicleNumber")
          const editVehicleInput = document.getElementById("editVehicleNumber")
          const suggestions = document.querySelector(".vehicle-suggestions")

          if (
            suggestions &&
            !vehicleInput.contains(e.target) &&
            !editVehicleInput.contains(e.target) &&
            !suggestions.contains(e.target)
          ) {
            hideVehicleSuggestions()
          }
        })

        // æ¨¡æ…‹æ¡†é—œé–‰
        document
          .querySelector(".close")
          .addEventListener("click", closeEditModal)
        // ç§»é™¤é»æ“Šå¤–éƒ¨é—œé–‰åŠŸèƒ½ï¼Œé¿å…æ„å¤–é—œé–‰ç·¨è¼¯å°è©±æ¡†
        // window.addEventListener("click", function (event) {
        //   const modal = document.getElementById("editTripModal")
        //   if (event.target === modal) {
        //     closeEditModal()
        //   }
        // })
      }

      // é¡¯ç¤º / éš±è—æ¨¡å¼æç¤ºæ©«å¹…
      function showDisplayModeBanner(isCompleted) {
        let banner = document.getElementById("displayModeBanner")
        if (!banner) {
          banner = document.createElement("div")
          banner.id = "displayModeBanner"
          banner.style.position = "fixed"
          banner.style.top = "0"
          banner.style.left = "0"
          banner.style.right = "0"
          banner.style.zIndex = "1500"
          banner.style.padding = "10px 16px"
          banner.style.fontSize = "14px"
          banner.style.fontWeight = "600"
          banner.style.display = "flex"
          banner.style.alignItems = "center"
          banner.style.justifyContent = "center"
          banner.style.gap = "12px"
          banner.style.boxShadow = "0 2px 6px rgba(0,0,0,0.15)"
          banner.style.transition = "transform .35s ease, opacity .35s ease"
          document.body.appendChild(banner)
        }
        if (isCompleted) {
          banner.innerHTML =
            '<span style="color:#fff;">ç›®å‰ç‚º <strong style="color:#ffe082;">å·²ç™¼è»Šç´€éŒ„æª¢è¦–æ¨¡å¼</strong>ï¼šåƒ…å¯æŸ¥çœ‹ï¼Œä¸èƒ½æ’ç­ / æ‹–æ›³ã€‚</span><button onclick="toggleCompletedOff()" style="background:#fff;color:#d32f2f;border:none;padding:4px 10px;border-radius:4px;font-weight:600;cursor:pointer;">åˆ‡æ›å›é€²è¡Œä¸­</button>'
          banner.style.background = "linear-gradient(90deg,#d32f2f,#b71c1c)"
          banner.style.opacity = "1"
          banner.style.transform = "translateY(0)"
        } else {
          banner.innerHTML =
            '<span style="color:#1b5e20;">å·²å›åˆ°é€²è¡Œä¸­è¶Ÿæ¬¡æ¨¡å¼ï¼Œå¯é€²è¡Œæ’ç­æ“ä½œã€‚</span>'
          banner.style.background = "linear-gradient(90deg,#a5d6a7,#66bb6a)"
          setTimeout(() => {
            // çŸ­æš«é¡¯ç¤ºå¾Œæ·¡å‡ºç§»é™¤
            banner.style.opacity = "0"
            banner.style.transform = "translateY(-100%)"
            setTimeout(() => banner.remove(), 600)
          }, 1800)
        }
      }

      function toggleCompletedOff() {
        const toggle = document.getElementById("showCompletedToggle")
        if (toggle) {
          toggle.checked = false
          toggle.dispatchEvent(new Event("change"))
        }
      }

      // ä¾æ¨¡å¼å¥—ç”¨æŒ‰éˆ•èˆ‡æ‹–æ‹½ç‹€æ…‹
      function applyAssignUIState() {
        const passengerCards = document.querySelectorAll(".passenger-card")
        if (showCompletedTrips) {
          passengerCards.forEach((c) => {
            c.setAttribute("draggable", "false")
            c.classList.add("drag-disabled")
          })
        } else {
          passengerCards.forEach((c) => {
            c.setAttribute("draggable", "true")
            c.classList.remove("drag-disabled")
          })
        }
      }

      // æ™‚é–“è¼¸å…¥è¨­ç½®
      function setupTimeInputs() {
        const hourInput = document.getElementById("hourInput")
        const minuteInput = document.getElementById("minuteInput")
        const vehicleInput = document.getElementById("vehicleNumber")

        // å°æ™‚è¼¸å…¥è™•ç†
        hourInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "")
          if (value.length > 2) value = value.slice(0, 2)
          if (value !== "" && parseInt(value) > 23) value = "23"

          // è£œé›¶
          if (value.length === 1 && parseInt(value) > 2) {
            value = "0" + value
          }
          if (value.length === 2) {
            value = value.padStart(2, "0")
            minuteInput.focus()
          }

          e.target.value = value
        })

        // åˆ†é˜è¼¸å…¥è™•ç†
        minuteInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "")
          if (value.length > 2) value = value.slice(0, 2)
          if (value !== "" && parseInt(value) > 59) value = "59"

          // è£œé›¶
          if (value.length === 1 && parseInt(value) > 5) {
            value = "0" + value
          }
          if (value.length === 2) {
            value = value.padStart(2, "0")
            // è·³åˆ°ä¿ç•™åº§ä½æ•¸é‡è¼¸å…¥æ¡†
            document.getElementById("keepCountInput").focus()
          }

          e.target.value = value
        })

        // æ–°å¢è¶Ÿæ¬¡çš„è»Šè™Ÿè‡ªå‹•å®ŒæˆåŠŸèƒ½
        setupVehicleAutocomplete(vehicleInput, hourInput)

        // Enter éµè™•ç†
        hourInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault()
            minuteInput.focus()
          }
        })

        minuteInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault()
            document.getElementById("keepCountInput").focus()
          }
        })

        // æ™‚é–“è¼¸å…¥çš„éµç›¤å°èˆªåŠŸèƒ½
        hourInput.addEventListener("keydown", function (e) {
          const currentPos = e.target.selectionStart
          const currentValue = e.target.value

          if (e.key === "ArrowRight") {
            // å³ç®­é ­ï¼šå¦‚æœåœ¨è¼¸å…¥æ¡†æœ€å³é‚Šï¼Œè·³åˆ°åˆ†é˜è¼¸å…¥
            if (currentPos === currentValue.length) {
              e.preventDefault()
              minuteInput.focus()
              minuteInput.setSelectionRange(0, 0)
            }
          } else if (e.key === "Backspace") {
            // å€’é€€éµï¼šå¦‚æœåœ¨è¼¸å…¥æ¡†æœ€å·¦é‚Šä¸”ç‚ºç©ºï¼Œè·³åˆ°è»Šè¼›è¼¸å…¥
            if (currentPos === 0 && currentValue === "") {
              e.preventDefault()
              vehicleInput.focus()
              vehicleInput.setSelectionRange(
                vehicleInput.value.length,
                vehicleInput.value.length
              )
            }
          }
        })

        minuteInput.addEventListener("keydown", function (e) {
          const currentPos = e.target.selectionStart
          const currentValue = e.target.value

          if (e.key === "ArrowLeft") {
            // å·¦ç®­é ­ï¼šå¦‚æœåœ¨è¼¸å…¥æ¡†æœ€å·¦é‚Šï¼Œè·³åˆ°å°æ™‚è¼¸å…¥
            if (currentPos === 0) {
              e.preventDefault()
              hourInput.focus()
              hourInput.setSelectionRange(
                hourInput.value.length,
                hourInput.value.length
              )
            }
          } else if (e.key === "Backspace") {
            // å€’é€€éµï¼šå¦‚æœåœ¨è¼¸å…¥æ¡†æœ€å·¦é‚Šä¸”ç‚ºç©ºï¼Œè·³åˆ°å°æ™‚è¼¸å…¥
            if (currentPos === 0 && currentValue === "") {
              e.preventDefault()
              hourInput.focus()
              hourInput.setSelectionRange(
                hourInput.value.length,
                hourInput.value.length
              )
            }
          }
        })

        // ä¿®æ”¹è¶Ÿæ¬¡çš„æ™‚é–“è¼¸å…¥è™•ç†
        const editHourInput = document.getElementById("editHourInput")
        const editMinuteInput = document.getElementById("editMinuteInput")
        const editVehicleInput = document.getElementById("editVehicleNumber")

        // ä¿®æ”¹è¶Ÿæ¬¡çš„å°æ™‚è¼¸å…¥è™•ç†
        editHourInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "")
          if (value.length > 2) value = value.slice(0, 2)
          if (value !== "" && parseInt(value) > 23) value = "23"

          // è£œé›¶
          if (value.length === 1 && parseInt(value) > 2) {
            value = "0" + value
          }
          if (value.length === 2) {
            value = value.padStart(2, "0")
            editMinuteInput.focus()
          }

          e.target.value = value
        })

        // ä¿®æ”¹è¶Ÿæ¬¡çš„åˆ†é˜è¼¸å…¥è™•ç†
        editMinuteInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "")
          if (value.length > 2) value = value.slice(0, 2)
          if (value !== "" && parseInt(value) > 59) value = "59"

          // è£œé›¶
          if (value.length === 1 && parseInt(value) > 5) {
            value = "0" + value
          }
          if (value.length === 2) {
            value = value.padStart(2, "0")
          }

          e.target.value = value
        })

        // ä¿®æ”¹è¶Ÿæ¬¡çš„æ™‚é–“å°èˆªåŠŸèƒ½
        editHourInput.addEventListener("keydown", function (e) {
          const currentPos = e.target.selectionStart
          const currentValue = e.target.value

          if (e.key === "ArrowRight") {
            if (currentPos === currentValue.length) {
              e.preventDefault()
              editMinuteInput.focus()
              editMinuteInput.setSelectionRange(0, 0)
            }
          } else if (e.key === "Backspace") {
            if (currentPos === 0 && currentValue === "") {
              e.preventDefault()
              editVehicleInput.focus()
              editVehicleInput.setSelectionRange(
                editVehicleInput.value.length,
                editVehicleInput.value.length
              )
            }
          }
        })

        editMinuteInput.addEventListener("keydown", function (e) {
          const currentPos = e.target.selectionStart
          const currentValue = e.target.value

          if (e.key === "ArrowLeft") {
            if (currentPos === 0) {
              e.preventDefault()
              editHourInput.focus()
              editHourInput.setSelectionRange(
                editHourInput.value.length,
                editHourInput.value.length
              )
            }
          } else if (e.key === "Backspace") {
            if (currentPos === 0 && currentValue === "") {
              e.preventDefault()
              editHourInput.focus()
              editHourInput.setSelectionRange(
                editHourInput.value.length,
                editHourInput.value.length
              )
            }
          }
        })

        // ä¿®æ”¹è¶Ÿæ¬¡çš„è»Šè™Ÿè‡ªå‹•å®ŒæˆåŠŸèƒ½
        setupVehicleAutocomplete(editVehicleInput, editHourInput)
      }

      // è¨­ç½®è»Šè™Ÿè‡ªå‹•å®ŒæˆåŠŸèƒ½ï¼ˆé€šç”¨å‡½æ•¸ï¼‰
      function setupVehicleAutocomplete(inputElement, nextFocusElement) {
        inputElement.addEventListener("input", function (e) {
          const value = e.target.value.toUpperCase()
          e.target.value = value

          // åªæœ‰åœ¨å¯¦éš›å…§å®¹è®ŠåŒ–æ™‚æ‰é‡ç½®é¸æ“‡ç´¢å¼•
          if (value !== lastInputValue) {
            selectedSuggestionIndex = -1
            lastInputValue = value
            showVehicleSuggestions(value, inputElement)
          }
        })

        inputElement.addEventListener("keydown", function (e) {
          if (e.key === "ArrowDown") {
            e.preventDefault()
            const suggestions = document.querySelectorAll(".suggestion-item")

            if (suggestions.length > 0) {
              if (selectedSuggestionIndex === -1) {
                selectedSuggestionIndex = 0
              } else {
                selectedSuggestionIndex = Math.min(
                  selectedSuggestionIndex + 1,
                  suggestions.length - 1
                )
              }
              updateSuggestionSelection(suggestions)
            }
          } else if (e.key === "ArrowUp") {
            e.preventDefault()
            const suggestions = document.querySelectorAll(".suggestion-item")

            if (suggestions.length > 0) {
              if (selectedSuggestionIndex === 0) {
                selectedSuggestionIndex = -1
                updateSuggestionSelection(suggestions)
                inputElement.focus()
              } else if (selectedSuggestionIndex > 0) {
                selectedSuggestionIndex = selectedSuggestionIndex - 1
                updateSuggestionSelection(suggestions)
              }
            }
          } else if (e.key === "Enter") {
            e.preventDefault()
            const suggestions = document.querySelectorAll(".suggestion-item")
            if (selectedSuggestionIndex >= 0 && suggestions.length > 0) {
              const selectedVehicle =
                visibleSuggestions[selectedSuggestionIndex]
              selectVehicle(
                selectedVehicle.plateNumber,
                inputElement,
                nextFocusElement
              )
            } else {
              hideVehicleSuggestions()
              nextFocusElement.focus()
            }
          } else if (e.key === "Escape") {
            e.preventDefault()
            hideVehicleSuggestions()
            selectedSuggestionIndex = -1
          }
        })
      }

      // è»Šè¼›å»ºè­°åŠŸèƒ½
      function showVehicleSuggestions(inputValue, targetInput = null) {
        if (!inputValue || inputValue.length < 1) {
          hideVehicleSuggestions()
          return
        }

        const matches = vehicleData.filter((vehicle) =>
          vehicle.plateNumber.toUpperCase().includes(inputValue)
        )

        if (matches.length === 0) {
          hideVehicleSuggestions()
          return
        }

        visibleSuggestions = matches.slice(0, 5)
        let suggestionHtml = '<div class="vehicle-suggestions">'
        visibleSuggestions.forEach((vehicle, index) => {
          const inputId = targetInput ? targetInput.id : "vehicleNumber"
          suggestionHtml += `
            <div class="suggestion-item" data-index="${index}" onclick="selectVehicleFromSuggestion('${vehicle.plateNumber}', '${inputId}')">
              ${vehicle.plateNumber} - ${vehicle.operatorName}
            </div>
          `
        })
        suggestionHtml += "</div>"

        // ç§»é™¤ç¾æœ‰å»ºè­°
        hideVehicleSuggestions()

        // æ·»åŠ æ–°å»ºè­°
        const vehicleInput =
          targetInput || document.getElementById("vehicleNumber")
        vehicleInput.insertAdjacentHTML("afterend", suggestionHtml)
      }

      // æ›´æ–°å»ºè­°é¸æ“‡çš„è¦–è¦ºæ•ˆæœ
      function updateSuggestionSelection(suggestions) {
        // ç§»é™¤æ‰€æœ‰é¸ä¸­æ¨£å¼
        suggestions.forEach((item) => item.classList.remove("selected"))

        // æ·»åŠ é¸ä¸­æ¨£å¼åˆ°ç›®å‰é …ç›®
        if (
          selectedSuggestionIndex >= 0 &&
          selectedSuggestionIndex < suggestions.length
        ) {
          suggestions[selectedSuggestionIndex].classList.add("selected")
        }
      }

      function hideVehicleSuggestions() {
        const suggestions = document.querySelector(".vehicle-suggestions")
        if (suggestions) {
          suggestions.remove()
        }
      }

      function selectVehicle(
        plateNumber,
        inputElement = null,
        nextFocusElement = null
      ) {
        const targetInput =
          inputElement || document.getElementById("vehicleNumber")
        const nextElement =
          nextFocusElement || document.getElementById("hourInput")

        targetInput.value = plateNumber
        hideVehicleSuggestions()
        selectedSuggestionIndex = -1
        nextElement.focus()
      }

      function selectVehicleFromSuggestion(plateNumber, inputId) {
        const inputElement = document.getElementById(inputId)
        let nextElement

        if (inputId === "editVehicleNumber") {
          nextElement = document.getElementById("editHourInput")
        } else {
          nextElement = document.getElementById("hourInput")
        }

        selectVehicle(plateNumber, inputElement, nextElement)
      }

      // è¼‰å…¥è»Šè¼›è³‡æ–™
      async function loadVehicleData() {
        try {
          const response = await fetch(
            `${BASE_URL}/BusVehicle/for-trips?operatorName=å¤§éƒ½æœƒå®¢é‹`
          )
          const result = await response.json()
          if (result.success && result.data) {
            vehicleData = result.data
          } else {
            console.error("è»Šè¼›è³‡æ–™æ ¼å¼éŒ¯èª¤:", result)
            vehicleData = []
          }
        } catch (error) {
          console.error("è¼‰å…¥è»Šè¼›è³‡æ–™å¤±æ•—:", error)
          vehicleData = []
        }
      }

      // API èª¿ç”¨å‡½æ•¸
      async function loadRoutes() {
        try {
          const response = await fetch(`${BASE_URL}/KeepStop`)
          const stops = await response.json()

          // æŒ‰ SubRouteId åˆ†çµ„ï¼Œåªå– OpenKeep ç‚º true çš„
          const routeMap = new Map()
          stops
            .filter((stop) => stop.openKeep)
            .forEach((stop) => {
              if (!routeMap.has(stop.subRouteId)) {
                routeMap.set(stop.subRouteId, {
                  subRouteId: stop.subRouteId,
                  routeName: stop.subRouteId, // ä½¿ç”¨ SubRouteId ä½œç‚ºè·¯ç·šåç¨±
                  operatorName: stop.operatorName || "æœªçŸ¥ç‡Ÿé‹å•†",
                })
              }
            })

          routes = Array.from(routeMap.values())
          console.log(
            "è¼‰å…¥è·¯ç·šæ•¸é‡:",
            routes.length,
            "è·¯ç·šåˆ—è¡¨:",
            routes.map((r) => r.subRouteId)
          )
          renderRouteSelector()
        } catch (error) {
          throw new Error("è¼‰å…¥è·¯ç·šå¤±æ•—")
        }
      }

      async function loadVehicles() {
        try {
          const response = await fetch(`${BASE_URL}/BusVehicle/for-trips`)
          const result = await response.json()

          if (result.success) {
            vehicles = result.data
            renderVehicleSelector()
            updateOperatorFilter()
          } else {
            console.error("è¼‰å…¥è»Šè¼›å¤±æ•—:", result.message)
            vehicles = []
          }
        } catch (error) {
          console.error("è¼‰å…¥è»Šè¼›å¤±æ•—:", error)
          vehicles = []
          throw new Error("è¼‰å…¥è»Šè¼›å¤±æ•—")
        }
      }

      async function loadTrips(mode) {
        // mode: 'completed' | 'active' | undefined (å…¨éƒ¨)
        const viewMode = mode || (showCompletedTrips ? "completed" : "active")
        let url = `${BASE_URL}/Trip`
        if (viewMode === "completed") {
          url += "?status=completed"
        } else if (viewMode === "active") {
          url += "?status=active"
        }
        try {
          console.log("è¼‰å…¥ç•¶æ—¥è¶Ÿæ¬¡è³‡æ–™... mode=", viewMode, "url=", url)
          let response = await fetch(url)
          if (!response.ok) {
            console.warn("å¸¶åƒæ•¸å–å¾—å¤±æ•—ï¼Œæ”¹ç”¨åŸºç¤ç«¯é» /Trip")
            response = await fetch(`${BASE_URL}/Trip`)
          }
          const result = await response.json()

          if (result.success) {
            trips = Array.isArray(result.data) ? result.data : []
            // å¾Œç«¯è‹¥æœªè™•ç† status åƒæ•¸ï¼Œé€™è£¡å†åšä¸€æ¬¡å‰ç«¯ä¿éšªéæ¿¾
            if (viewMode === "completed") {
              trips = trips.filter(
                (t) => (t.status || "").toLowerCase().trim() === "completed"
              )
            } else if (viewMode === "active") {
              trips = trips.filter(
                (t) => (t.status || "").toLowerCase().trim() !== "completed"
              )
            }
            console.log(`è¼‰å…¥æˆåŠŸ (${viewMode}) : ${trips.length} ç­†`)
            renderTripsSync()
          } else {
            console.error("è¼‰å…¥è¶Ÿæ¬¡å¤±æ•—:", result.message)
            trips = []
          }
        } catch (error) {
          console.error("è¼‰å…¥è¶Ÿæ¬¡å¤±æ•—:", error)
          trips = []
          throw new Error("è¼‰å…¥è¶Ÿæ¬¡å¤±æ•—")
        }
      }

      // åœ¨ loadPendingPassengers æˆåŠŸå¾Œåµæ¸¬æ–°é ç´„
      async function loadPendingPassengers() {
        try {
          console.log("è¼‰å…¥ç•¶æ—¥å¾…ä¿ç•™ä¹˜å®¢...")
          const response = await fetch(`${BASE_URL}/Trip/pending-passengers`)
          const result = await response.json()

          if (result.success) {
            // å‰ç«¯é¡å¤–éæ¿¾ç•¶æ—¥è³‡æ–™ï¼ˆé›™é‡ä¿è­·ï¼‰
            const todayPassengers = result.data

            // æª¢æŸ¥æ˜¯å¦æœ‰æ–°é ç´„é€²ä¾†
            if (
              Array.isArray(pendingPassengers) &&
              todayPassengers.length > pendingPassengers.length
            ) {
              showNotification("æœ‰æ–°çš„é ç´„é€²å…¥å¾…æ’ï¼")
            }

            pendingPassengers = todayPassengers
            console.log(
              `è¼‰å…¥æˆåŠŸ: ${pendingPassengers.length} ä½ç•¶æ—¥å¾…ä¿ç•™ä¹˜å®¢`
            )
            if (result.data.length !== pendingPassengers.length) {
              console.log(
                `å‰ç«¯éæ¿¾: åŸå§‹ ${result.data.length} ç­† â†’ ç•¶æ—¥ ${pendingPassengers.length} ç­†`
              )
            }
            if (result.filterDate) {
              console.log(`å¾Œç«¯ç¯©é¸æ—¥æœŸ: ${result.filterDate}`)
            }
            if (pendingPassengers.length > 0) {
              console.log(
                "ä¹˜å®¢ä¸‹è»Šç«™ç‰Œç¯„ä¾‹:",
                pendingPassengers
                  .slice(0, 3)
                  .map((p) => `${p.name}: ${p.keepStop} â†’ ${p.destStop}`)
              )
            }
            await renderPendingPassengers()
            // çµ±è¨ˆå€å·²ç§»é™¤
          } else {
            console.error("è¼‰å…¥å¾…åˆ†é…ä¹˜å®¢å¤±æ•—:", result.message)
          }
        } catch (error) {
          console.error("è¼‰å…¥ç­‰å¾…ä¹˜å®¢å¤±æ•—:", error)
          throw new Error("è¼‰å…¥ç­‰å¾…ä¹˜å®¢å¤±æ•—")
        }
      }

      // å¼·åˆ¶æ¯æ¬¡æ–°å¢/å–æ¶ˆé ç´„å¾Œè‡ªå‹•é‡è¼‰å¾…æ’è³‡æ–™èˆ‡ç•«é¢
      async function reloadPendingPassengersAndNotify() {
        const prevCount = Array.isArray(pendingPassengers)
          ? pendingPassengers.length
          : 0
        await loadPendingPassengers()
        // ç•«é¢è‡ªå‹•æ•´ç†
        await renderPendingPassengers()
        updateStatistics()
        // æ–°å¢é€šçŸ¥
        if (
          Array.isArray(pendingPassengers) &&
          pendingPassengers.length > prevCount
        ) {
          showNotification("æœ‰æ–°çš„é ç´„é€²å…¥å¾…æ’ï¼")
        }
        if (
          Array.isArray(pendingPassengers) &&
          pendingPassengers.length < prevCount
        ) {
          showNotification(
            "æœ‰ä¹˜å®¢å–æ¶ˆé ç´„ï¼Œå·²è‡ªå‹•ç§»é™¤ï¼--reloadPendingPassengersAndNotify"
          )
        }
      }

      // æ¸²æŸ“å‡½æ•¸
      function renderRouteSelector() {
        const selector = document.getElementById("routeSelector")
        const editSelector = document.getElementById("editRouteSelector")

        const routeHtml = routes
          .map(
            (route) => `
                <div class="route-option" data-route="${route.subRouteId}"
                     onclick="selectRoute('${route.subRouteId}', '${
              route.routeName
            }')">
                    ${route.routeName}
                    <br><small>${route.operatorName.substring(0, 3)}</small>
                </div>
            `
          )
          .join("")

        selector.innerHTML = routeHtml
        editSelector.innerHTML = routeHtml.replace(
          /selectRoute/g,
          "selectEditRoute"
        )
        // æ¸²æŸ“å¾Œé‚„åŸå…ˆå‰é¸æ“‡
        restoreSelectedRoute()
        // å†æ¬¡ä¿éšªåŒæ­¥éš±è—æ¬„ä½èˆ‡è¦–è¦ºç‹€æ…‹
        ensureRouteSelectedSync()
      }

      function renderVehicleSelector() {
        const selector = document.getElementById("vehicleSelector")
        const editSelector = document.getElementById("editVehicleSelector")

        const vehicleHtml = vehicles
          .map(
            (vehicle) => `
                <div class="vehicle-option" data-vehicle="${vehicle.plateNumber}"
                     data-operator="${vehicle.operatorName}"
                     onclick="selectVehicleFromList('${vehicle.plateNumber}')">
                    <strong>${vehicle.plateNumber}</strong>
                    <br><small>${vehicle.operatorName}</small>
                </div>
            `
          )
          .join("")

        selector.innerHTML = vehicleHtml
        editSelector.innerHTML = vehicleHtml.replace(
          /selectVehicleFromList/g,
          "selectEditVehicle"
        )
      }

      // åŒ…è£ renderTrips çš„åŒæ­¥èª¿ç”¨å‡½æ•¸
      function renderTripsSync() {
        renderTrips().catch((error) => {
          console.error("æ¸²æŸ“è¶Ÿæ¬¡æ™‚ç™¼ç”ŸéŒ¯èª¤:", error)
          showError("æ¸²æŸ“è¶Ÿæ¬¡æ™‚ç™¼ç”ŸéŒ¯èª¤")
        })
      }

      async function renderTrips() {
        console.log("Rendering trips...")
        const container = document.getElementById("tripsContainer")
        const prevScrollTop = container ? container.scrollTop : 0
        if (container) container.classList.add("no-anim")

        // ä¿å­˜å±•é–‹çš„è¶Ÿæ¬¡ ID
        const expandedTrips = Array.from(
          document.querySelectorAll(".trip-collapsible.expanded")
        ).map((el) => el.id.replace("details-", ""))

        if (trips.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #666; padding: 40px;">å°šæœªå»ºç«‹ä»»ä½•è¶Ÿæ¬¡</p>'
          return
        }

        // æŒ‰ç™¼è»Šæ™‚é–“æ’åºè¶Ÿæ¬¡
        const sortedTrips = [...trips].sort((a, b) => {
          const timeA = a.departureTime.replace(":", "")
          const timeB = b.departureTime.replace(":", "")
          return timeA.localeCompare(timeB)
        })

        // å‹¾é¸ï¼šåƒ…é¡¯ç¤ºå·²ç™¼è»Šï¼›æœªå‹¾é¸ï¼šåƒ…é¡¯ç¤ºæœªç™¼è»Š
        const displayTrips = (function () {
          return showCompletedTrips
            ? sortedTrips.filter(
                (t) => (t.status || "").toLowerCase().trim() === "completed"
              )
            : sortedTrips.filter(
                (t) => (t.status || "").toLowerCase().trim() !== "completed"
              )
        })()

        if (showCompletedTrips) {
          console.log(
            "[é¡¯ç¤ºå·²ç™¼è»Šæ¨¡å¼] åŸå§‹ç­†æ•¸:",
            sortedTrips.length,
            "ç¬¦åˆ completed ç­†æ•¸:",
            displayTrips.length,
            sortedTrips.map((t) => ({ id: t.tripId, status: t.status }))
          )
        }

        if (displayTrips.length === 0) {
          const msg = showCompletedTrips
            ? "ç›®å‰æ²’æœ‰å·²ç™¼è»Šçš„è¶Ÿæ¬¡ (è«‹ç¢ºèªæœ‰ç„¡æ¨™è¨˜ç‚ºå·²ç™¼è»Š)"
            : "ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„è¶Ÿæ¬¡ (å¯å‹¾é¸é¡¯ç¤ºå·²ç™¼è»Š)"
          const finalHtmlEmpty = `
            <div class="view-toggle">
              <button class="btn btn-info" onclick="expandAllTrips()">ğŸ“– å…¨éƒ¨å±•é–‹</button>
              <button class="btn btn-info" onclick="collapseAllTrips()">ğŸ“• å…¨éƒ¨æ‘ºç–Š</button>
            </div>
            <p style=\"text-align:center;color:#666;padding:40px;\">${msg}</p>`
          container.innerHTML = finalHtmlEmpty
          return
        }

        const tripsHtml = displayTrips
          .map((trip) => {
            const currentSeats = getTripPassengerCount(trip.tripId)
            console.log(
              `Trip ID: ${trip.tripId}, Current Seats: ${currentSeats}`
            )
            const seatStatus =
              currentSeats >= trip.keepCount
                ? "full"
                : currentSeats > 0
                ? "pending"
                : ""

            return `
                <div class="trip-card ${trip.status} ${getRouteColorClass(
              trip.route
            )}" data-trip-id="${trip.tripId}" data-status="${
              trip.status
            }" title="${
              (trip.status || "") === "completed"
                ? "å·²ç™¼è»Šï¼šç¦æ­¢æ‹–æ”¾/æ–°å¢ä¹˜å®¢"
                : "å¯æ‹–æ”¾å¾…åˆ†é…ä¹˜å®¢é€²å…¥"
            }">
                    <button class="toggle-btn" onclick="toggleTripDetails('${
                      trip.tripId
                    }')">ğŸ”½</button>
                    
                    <div class="trip-header" onclick="toggleTripDetails('${
                      trip.tripId
                    }')">
                        <div style="display: flex; align-items: center; flex: 1;">

                            <div class="trip-basic-info">
                                <div style="display: flex; align-items: center; gap: 8px; margin: 0;">
                                    <span class="route-badge ${getRouteColorClass(
                                      trip.route
                                    )}" style="font-size: 16px; font-weight: bold; padding: 4px 8px; border-radius: 4px; color: white;">${
              trip.route
            }</span>
                                    <span style="font-size: 14px; color: #666;">ï½œ</span>
                                    <span style="font-size: 16px; font-weight: bold; color: #333;">${
                                      trip.vehicleNumber
                                    }</span>
                                </div>
                                <div style="display: flex; gap: 15px; font-size: 13px; color: #666; margin-top: 2px;">
                                    <span>ğŸ• ${trip.departureTime}</span>
                                    <span style="color: ${
                                      trip.status === "ready"
                                        ? "#28a745"
                                        : trip.status === "notified"
                                        ? "#007bff"
                                        : trip.status === "completed"
                                        ? "#6c757d"
                                        : "#ffc107"
                                    }">
                                        ${
                                          trip.status === "ready"
                                            ? "æº–å‚™ç™¼è»Š"
                                            : trip.status === "notified"
                                            ? "å·²é€šçŸ¥ä¹˜å®¢"
                                            : trip.status === "completed"
                                            ? "å·²ç™¼è»Š"
                                            : "åˆ†é…ä¿ç•™ä½ä¸­â€¦"
                                        }
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="trip-quick-stats">
                            <div class="seat-indicator ${seatStatus}">
                                ğŸª‘ ${currentSeats}/${trip.keepCount}
                            </div>
                        </div>
                    </div>

                    <div class="trip-collapsible" id="details-${trip.tripId}">
                        <div class="passenger-area">
                            <h4>å·²ä¿ç•™ä¹˜å®¢:</h4>
                            <div id="passengers-${trip.tripId}">
                                <p style="color: #999; font-style: italic;">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>

                        <div class="trip-controls">
                        ${
                          trip.status !== "completed"
                            ? `
                        <button class="btn btn-info" onclick="autoAssignTrip('${trip.tripId}')">
                            ğŸ¤– è‡ªå‹•æ’ç­
                        </button>
                        <button class="btn btn-warning" onclick="editTrip('${trip.tripId}')">
                            âœï¸ ç·¨è¼¯
                        </button>
                        <button class="btn btn-danger" onclick="deleteTrip('${trip.tripId}')">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                        <button class="btn btn-primary" onclick="printReservation('${trip.tripId}')">
                            ğŸ–¨ï¸ åˆ—å°
                        </button>
                        <button class="btn btn-primary" onclick="notifyPassengers('${trip.tripId}')">
                            ğŸ“± é€šçŸ¥
                        </button>
                        <button class="btn btn-secondary" onclick="markTripCompleted('${trip.tripId}')">
                            âœ… å·²ç™¼è»Š
                        </button>`
                            : `
                        <button class="btn btn-primary" onclick="printReservation('${trip.tripId}', window.enableBrowserFallback)">
                            ğŸ–¨ï¸ åˆ—å°
                        </button>
                        <button class="btn btn-secondary" disabled title="æ­¤è¶Ÿå·²ç™¼è»Š">
                            âœ… å·²ç™¼è»Š
                        </button>`
                        }
                        </div>
                    </div>
                </div>
            `
          })
          .join("")

        // æ·»åŠ å±•é–‹æ‘ºç–ŠæŒ‰éˆ•å’Œè¶Ÿæ¬¡
        const finalHtml = `
          <div class="view-toggle">
            <button class="btn btn-info" onclick="expandAllTrips()">
              ğŸ“– å…¨éƒ¨å±•é–‹
            </button>
            <button class="btn btn-info" onclick="collapseAllTrips()">
              ğŸ“• å…¨éƒ¨æ‘ºç–Š
            </button>
          </div>
          ${tripsHtml}
        `

        container.innerHTML = finalHtml

        // æ¢å¾©å±•é–‹çš„è¶Ÿæ¬¡
        expandedTrips.forEach((tripId) => {
          const details = document.getElementById(`details-${tripId}`)
          if (details) {
            details.classList.add("expanded")
          }
        })

        // ç•°æ­¥åŠ è¼‰æ‰€æœ‰è¶Ÿæ¬¡çš„ä¹˜å®¢è³‡æ–™
        const updatePromises = displayTrips.map(async (trip) => {
          console.log(
            `é–‹å§‹è™•ç†è¶Ÿæ¬¡ ${trip.tripId} (${trip.vehicleNumber}, è·¯ç·š: ${trip.route})`
          )

          try {
            // æ›´æ–°ä¹˜å®¢åˆ—è¡¨
            const passengersHtml = await renderTripPassengers(trip.tripId)
            const passengersContainer = document.getElementById(
              `passengers-${trip.tripId}`
            )
            if (passengersContainer) {
              passengersContainer.innerHTML = passengersHtml
              console.log(`è¶Ÿæ¬¡ ${trip.tripId} çš„ä¹˜å®¢åˆ—è¡¨å·²æ›´æ–°`)
            } else {
              console.warn(`æ‰¾ä¸åˆ°è¶Ÿæ¬¡ ${trip.tripId} çš„ä¹˜å®¢å®¹å™¨å…ƒç´ `)
            }
          } catch (error) {
            console.error(`è™•ç†è¶Ÿæ¬¡ ${trip.tripId} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error)
          }
        })

        // ç­‰å¾…æ‰€æœ‰æ›´æ–°å®Œæˆ
        await Promise.all(updatePromises)
        console.log("æ‰€æœ‰è¶Ÿæ¬¡ä¹˜å®¢è³‡æ–™æ›´æ–°å®Œæˆ")

        // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        setTimeout(() => {
          makeDraggable()
        }, 100)

        // é‚„åŸæ»¾å‹•ä½ç½®ä¸¦è§£é™¤ no-anim
        if (container) {
          container.scrollTop = prevScrollTop
          requestAnimationFrame(() => container.classList.remove("no-anim"))
        }
      }

      async function renderPendingPassengers() {
        const container = document.getElementById("pendingPassengersList")

        // åªé¡¯ç¤ºæœªåˆ†é…çš„ä¹˜å®¢ï¼ˆtripId ç‚º null æˆ– undefinedï¼‰ï¼Œä¸¦ä»¥è«‹æ±‚æ™‚é–“å…ˆé€²å…ˆå‡ºæ’åºï¼ˆæ—©â†’æ™šï¼‰
        const unassignedPassengers = pendingPassengers
          .filter((passenger) => !passenger.tripId)
          .sort((a, b) => {
            const ta = new Date(a.requestDateTime).getTime() || 0
            const tb = new Date(b.requestDateTime).getTime() || 0
            return ta - tb
          })

        if (unassignedPassengers.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #666;">æš«ç„¡å¾…ä¿ç•™ä¹˜å®¢</p>'
          return
        }

        // ä½¿ç”¨ for è¿´åœˆé€å€‹è™•ç†ä¹˜å®¢çš„è·¯ç·šåŒ¹é…ï¼Œé¿å…ä¸¦ç™¼ç«¶çˆ­
        const passengersWithRoutes = []

        for (const passenger of unassignedPassengers) {
          // é™¤éŒ¯è³‡è¨Š
          console.log(
            "è™•ç†ä¹˜å®¢:",
            passenger.name,
            "ä¸‹è»Šç«™ç‰Œ:",
            passenger.destStop,
            "é è¨­è·¯ç·š:",
            passenger.includeRoutes
          )

          // ä½¿ç”¨ä¹˜å®¢è³‡æ–™ä¸­é å…ˆè¨ˆç®—çš„å¯ç”¨è·¯ç·šï¼ˆIncludeRoutes æ¬„ä½ï¼‰
          let relatedRoutes = []

          if (passenger.includeRoutes && passenger.includeRoutes.trim()) {
            // è§£æ CSV æ ¼å¼çš„è·¯ç·šæ¸…å–®
            const availableRouteIds = passenger.includeRoutes
              .split(",")
              .map((id) => id.trim())
              .filter((id) => id)

            // ğŸ”§ ä¿®å¾©ï¼šç›´æ¥ä½¿ç”¨ IncludeRoutes ä¸­çš„è·¯ç·šIDï¼Œä¸ä¾è³´å‰ç«¯ routes éæ¿¾
            // å› ç‚º IncludeRoutes ä¾†è‡ªä¸‹è»Šç«™ç‰Œ(OnlyDest=true)ï¼Œå‰ç«¯ routes ä¾†è‡ªä¸Šè»Šç«™ç‰Œ(OpenKeep=true)
            relatedRoutes = availableRouteIds.map((routeId) => ({
              subRouteId: routeId,
              routeName: routeId,
            }))

            console.log(
              `ä¹˜å®¢ ${passenger.name} ä½¿ç”¨é è¨­è·¯ç·š:`,
              availableRouteIds,
              "ç›´æ¥é¡¯ç¤º:",
              relatedRoutes.map((r) => r.subRouteId)
            )
          } else {
            console.log(`ä¹˜å®¢ ${passenger.name} æ²’æœ‰é è¨­è·¯ç·šè³‡è¨Šï¼Œå°‡é¡¯ç¤ºç„¡è·¯ç·š`)
          }

          // é¡¯ç¤ºåŒ¹é…çš„è·¯ç·šå¾½ç« 
          let routeInfo
          if (relatedRoutes.length > 0) {
            routeInfo = relatedRoutes
              .map(
                (r) =>
                  `<span class="route-badge route-${r.subRouteId}">${r.subRouteId}</span>`
              )
              .join(" ")
          } else {
            // å¦‚æœçœŸçš„å®Œå…¨æ²’æœ‰è·¯ç·šï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            routeInfo = `<span class="route-badge route-default">ç„¡å¯ç”¨è·¯ç·š</span>`
          }

          const requestTime = extractTimeFromDateTime(passenger.requestDateTime)
          // é€šçŸ¥æ™‚é–“ï¼ˆæœ€å¾Œé€šçŸ¥æ™‚é–“ï¼‰ï¼Œä»¥ HH:mm:ss é¡¯ç¤ºï¼›è‹¥ç„¡å‰‡é¡¯ç¤ºæœªé€šçŸ¥
          const notifiedTime = passenger.responseDateTime
            ? extractHmsFromDateTime(passenger.responseDateTime)
            : null
          const notifyBadge = passenger.responseDateTime
            ? `<span style="background:#e8f5e9;border:1px solid #c3e6cb;color:#1e7e34;padding:2px 6px;border-radius:12px;font-weight:700;font-size:12px;white-space:nowrap;">ğŸ“£ å·²é€šçŸ¥ ${notifiedTime}</span>`
            : `<span style="background:#f0f0f0;border:1px solid #ddd;color:#6c757d;padding:2px 6px;border-radius:12px;font-weight:700;font-size:12px;white-space:nowrap;">æœªé€šçŸ¥</span>`

          const passengerHtml = `
              <div class="passenger-card" data-passenger-id="${
                passenger.id
              }" draggable="true">
                  <div class="passenger-header">
                      <div class="passenger-name">${
                        passenger.name
                      } <span style="color: #007bff; font-weight: bold;">â° ${requestTime}</span></div>
                      <div class="passenger-seats">${
                        passenger.seatCount || 1
                      }ä½</div>
                  </div>
                      <div class="passenger-notify" style="margin:4px 0;">${notifyBadge}</div>
                  <div class="passenger-route">
                      ğŸ“ ${passenger.keepStop} â†’ ${passenger.destStop}
                      <br><small>ğŸšŒ å¯æ­è·¯ç·š: ${routeInfo}</small>
                  </div>
                  <div class="passenger-contact" style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; border-left: 3px solid #ffc107;">
                      ğŸ“ <strong style="color: #856404; font-size: 14px;">${
                        passenger.phone || "ç„¡é›»è©±è³‡æ–™"
                      }</strong>
                  </div>
                  <div class="passenger-actions">
                      ${
                        showCompletedTrips
                          ? `<button class="btn btn-secondary btn-xs" disabled title="é¡¯ç¤ºå·²ç™¼è»Šæ¨¡å¼ä¸‹ä¸å¯æ’ç­">æ‰‹å‹•æ’ç­</button>
                             <button class="btn btn-secondary btn-xs" disabled title="é¡¯ç¤ºå·²ç™¼è»Šæ¨¡å¼ä¸‹ä¸å¯æ’ç­">è‡ªå‹•æ’ç­</button>`
                          : `<button class=\"btn btn-primary btn-xs\" onclick=\"showManualAssignModal('${passenger.id}')\">æ‰‹å‹•æ’ç­</button>
                             <button class=\"btn btn-info btn-xs\" onclick=\"autoAssignSinglePassenger('${passenger.id}')\">è‡ªå‹•æ’ç­</button>`
                      }
                  </div>
              </div>
            `

          passengersWithRoutes.push(passengerHtml)
        }

        // ä»¥é›™æ¬„å‘ˆç¾ï¼Œè¦–è¦ºä¸Šæ¡ç”¨å…ˆå³ä¸Šä¸‹ï¼ˆç”±æ–¼ç‚ºä¸²æ¥å­—ä¸²ï¼Œæ¬„ä½é †åºç”± CSS æ±ºå®šæ’åˆ—æµï¼‰
        const passengersHtml = passengersWithRoutes.join("")

        // ä½¿ç”¨ CSS Grid å…©æ¬„ï¼Œè®“åˆ—è¡¨æ›´å¯†é›†å¯è¦–
        container.style.display = "grid"
        container.style.gridTemplateColumns = "1fr 1fr"
        container.style.gap = "8px"
        container.innerHTML = passengersHtml

        // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        setTimeout(() => {
          makeDraggable()
        }, 100)
      }

      // å¾APIç²å–è¶Ÿæ¬¡ä¹˜å®¢è³‡æ–™
      async function loadTripPassengers(tripId) {
        try {
          console.log(
            `loadTripPassengers: é–‹å§‹è¼‰å…¥è¶Ÿæ¬¡ ${tripId} çš„ä¹˜å®¢è³‡æ–™...`
          )
          const response = await fetch(`${BASE_URL}/Trip/${tripId}/passengers`)

          if (!response.ok) {
            console.error(`loadTripPassengers: HTTPéŒ¯èª¤ ${response.status}`)
            return null
          }

          const result = await response.json()
          console.log(`loadTripPassengers: è¶Ÿæ¬¡ ${tripId} çš„APIå›æ‡‰:`, result)

          if (result.success) {
            return result.data
          } else {
            console.warn(`loadTripPassengers: è¶Ÿæ¬¡ ${tripId} ç²å–å¤±æ•—`)
            throw new Error(result.message || "è¼‰å…¥è¶Ÿæ¬¡ä¹˜å®¢å¤±æ•—")
          }
        } catch (error) {
          console.error(
            `loadTripPassengers: è¼‰å…¥è¶Ÿæ¬¡ ${tripId} ä¹˜å®¢å‡ºéŒ¯:`,
            error
          )
          return null
        }
      }

      // å·²ç™¼è»Šè¶Ÿæ¬¡ä½¿ç”¨ï¼šè¼‰å…¥åŒ…å«å·²æ­ä¹˜çš„å®Œæ•´ä¹˜å®¢æ¸…å–®
      async function loadCompletedTripPassengers(tripId) {
        try {
          console.log(
            `loadCompletedTripPassengers: è¼‰å…¥å·²ç™¼è»Šè¶Ÿæ¬¡ ${tripId} å…¨éƒ¨ä¹˜å®¢...`
          )
          const response = await fetch(
            `${BASE_URL}/Trip/${tripId}/passengers-all`
          )
          if (!response.ok) return null
          const result = await response.json()
          if (result.success) return result.data
          return null
        } catch (e) {
          console.error("loadCompletedTripPassengers error", e)
          return null
        }
      }

      async function renderTripPassengers(tripId) {
        try {
          console.log(
            `renderTripPassengers: é–‹å§‹è¼‰å…¥è¶Ÿæ¬¡ ${tripId} çš„ä¹˜å®¢è³‡æ–™...`
          )
          // è‹¥ç›®å‰ç‚ºé¡¯ç¤ºå·²ç™¼è»Šæ¨¡å¼ï¼Œæ”¹ç”¨ passengers-all ç«¯é»
          let tripData
          const tripMeta = trips.find((t) => t.tripId === tripId)
          const isCompletedView =
            showCompletedTrips ||
            (tripMeta && (tripMeta.status || "").toLowerCase() === "completed")
          if (isCompletedView) {
            tripData = await loadCompletedTripPassengers(tripId)
          } else {
            tripData = await loadTripPassengers(tripId)
          }

          // åŒæ™‚æ”¯æ´å¤§å¯«å’Œå°å¯«é–‹é ­çš„å±¬æ€§åç¨±
          if (!tripData || !tripData.passengers) {
            console.warn(`renderTripPassengers: è¶Ÿæ¬¡ ${tripId} ç„¡æœ‰æ•ˆä¹˜å®¢è³‡æ–™`)
            console.log(`tripData:`, tripData)
            return '<p style="color: #999; font-style: italic;">å°šç„¡å·²ä¿ç•™ä¹˜å®¢</p>'
          }

          const assignedPassengers = tripData.passengers
          console.log(
            `renderTripPassengers: è¶Ÿæ¬¡ ${tripId} æœ‰ ${assignedPassengers.length} ä½ä¹˜å®¢`
          )

          // å…ˆè¨ˆç®—ç¸½åº§ä½æ•¸ï¼ˆå« seatCountï¼‰ï¼Œä¸¦åŒæ­¥åˆ° trips é™£åˆ—ï¼Œæ›´æ–°åº§ä½æŒ‡æ¨™
          const totalSeatsNow = assignedPassengers.reduce(
            (sum, p) => sum + (p.seatCount || p.SeatCount || 1),
            0
          )
          const tripRefForCount = trips.find((t) => t.tripId === tripId)
          if (tripRefForCount) {
            tripRefForCount.assignedSeats = totalSeatsNow
          }
          updateTripSeatDisplay(tripId, totalSeatsNow)

          if (assignedPassengers.length === 0) {
            console.log(`renderTripPassengers: è¶Ÿæ¬¡ ${tripId} æ²’æœ‰ä¹˜å®¢`)
            return '<p style="color: #999; font-style: italic;">å°šç„¡å·²ä¿ç•™ä¹˜å®¢</p>'
          }

          // æŒ‰é ç´„æ™‚é–“æ’åº (æ—©åˆ°æ™š)
          const sortedPassengers = [...assignedPassengers].sort((a, b) => {
            const timeA = extractTimeFromDateTime(a.requestDateTime)
            const timeB = extractTimeFromDateTime(b.requestDateTime)
            return timeA.localeCompare(timeB)
          })

          // å‰µå»º2åˆ—ä½ˆå±€çš„å®¹å™¨
          let passengersHtml =
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; margin-top: 8px;">'

          sortedPassengers.forEach((passenger) => {
            const keepTime = extractTimeFromDateTime(passenger.requestDateTime)
            const notifiedTime = passenger.responseDateTime
              ? extractHmsFromDateTime(passenger.responseDateTime)
              : null
            const notifyBadge = passenger.responseDateTime
              ? `<span style="background:#e8f5e9;border:1px solid #c3e6cb;color:#1e7e34;padding:1px 6px;border-radius:12px;font-weight:700;font-size:11px;white-space:nowrap;">ğŸ“£ å·²é€šçŸ¥ ${notifiedTime}</span>`
              : `<span style="background:#f0f0f0;border:1px solid #ddd;color:#6c757d;padding:1px 6px;border-radius:12px;font-weight:700;font-size:11px;white-space:nowrap;">æœªé€šçŸ¥</span>`
            const boardedBadge =
              passenger.isBoarded || passenger.boardedDateTime
                ? `<span style='background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;padding:1px 6px;border-radius:12px;font-weight:700;font-size:11px;white-space:nowrap;margin-left:4px;'>å·²æ­ä¹˜${
                    passenger.boardedDateTime
                      ? " " + extractTimeFromDateTime(passenger.boardedDateTime)
                      : ""
                  }</span>`
                : ""
            passengersHtml += `
              <div class="assigned-passenger-compact" style="
                background: #e8f5e8;
                border: 1px solid #c3e6cb;
                border-radius: 5px;
                padding: 6px 8px;
                font-size: 12px;
                position: relative;
              ">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 3px;">
                  <strong style="font-size: 13px;">${passenger.name}</strong>
                  <span style="color: #007bff; font-weight: bold; font-size: 13px;">â° ${keepTime}</span>
                </div>
                <div style="font-size: 13px; line-height: 1.3;">
                  <div style="margin: 0 0 4px 0;">${notifyBadge} ${boardedBadge}</div>
                  <div style="background: #fff3cd; padding: 1px 4px; border-radius: 2px; border-left: 2px solid #ffc107; display: inline-block; margin-bottom: 2px;">
                    ğŸ“ <strong style="color: #856404;">${
                      passenger.phone || "ç„¡é›»è©±"
                    }</strong>
                  </div>
                  <div style="color: #666; margin-top: 2px;">
                    ğŸ“ ${passenger.keepStop} â†’ ${passenger.destStop}
                  </div>
                  <div style="margin-top: 2px;">
                    ğŸª‘ <span style="font-weight: bold; color: #007bff;">${
                      passenger.seatCount || 1
                    }ä½</span>
                  </div>
                </div>
                ${
                  isCompletedView
                    ? ""
                    : `<button class="btn btn-danger" onclick="removePassengerFromTrip('${
                        passenger.id
                      }', '${tripId}', ${
                        passenger.seatCount || passenger.SeatCount || 1
                      })" style="position:absolute;bottom:3px;right:3px;font-size:10px;padding:2px 4px;line-height:1;border-radius:3px;background:#dc3545;border:none;color:white;cursor:pointer;z-index:1;">âŒ</button>`
                }
              </div>
            `
          })

          passengersHtml += "</div>"
          console.log(`renderTripPassengers: è¶Ÿæ¬¡ ${tripId} ä¹˜å®¢æ¸²æŸ“å®Œæˆ`)
          return passengersHtml
        } catch (error) {
          console.error(
            `renderTripPassengers: è¼‰å…¥è¶Ÿæ¬¡ ${tripId} ä¹˜å®¢è³‡æ–™å¤±æ•—:`,
            error
          )
          return '<p style="color: #999; font-style: italic;">è¼‰å…¥ä¹˜å®¢è³‡æ–™å¤±æ•—</p>'
        }
      }

      // æ ¹æ“šè·¯ç·šIDåˆ†é…å°æ‡‰çš„é¡è‰²é¡åˆ¥
      function getRouteColorClass(routeName) {
        if (!routeName) return "route-default"

        // ç›´æ¥æ ¹æ“šè·¯ç·šIDåˆ†é…å°æ‡‰é¡è‰²ï¼Œèˆ‡å¯æ­ä¹˜è·¯ç·šé¡è‰²ä¿æŒä¸€è‡´
        switch (routeName) {
          case "208802": // å°1
            return "route-208802"
          case "2088A2": // è—15
            return "route-2088A2"
          case "2088B2": // ç´…33
            return "route-2088B2"
          default:
            return "route-default"
        }
      }

      // å¾ RequestDateTime ä¸­æå–æ™‚:åˆ†æ ¼å¼çš„æ™‚é–“
      function extractTimeFromDateTime(requestDateTime) {
        if (!requestDateTime) return "æœªçŸ¥"

        try {
          // å‡è¨­æ ¼å¼å¯èƒ½æ˜¯ "YYYY-MM-DD HH:mm" æˆ– "HH:mm" æˆ–å…¶ä»–
          const timeMatch = requestDateTime.match(/(\d{1,2}):(\d{1,2})/)
          if (timeMatch) {
            const hour = timeMatch[1].padStart(2, "0")
            const minute = timeMatch[2].padStart(2, "0")
            return `${hour}:${minute}`
          }

          // å¦‚æœæ˜¯å®Œæ•´çš„ DateTime å­—ä¸²ï¼Œå˜—è©¦è§£æ
          const date = new Date(requestDateTime)
          if (!isNaN(date.getTime())) {
            return date.toTimeString().substring(0, 5) // "HH:mm"
          }

          return "æœªçŸ¥"
        } catch (error) {
          console.error("è§£ææ™‚é–“å¤±æ•—:", error, requestDateTime)
          return "æœªçŸ¥"
        }
      }

      // å¾å­—ä¸²æ—¥æœŸä¸­æ“·å– HH:mm:ssï¼ˆé¡¯ç¤ºé€šçŸ¥æ™‚é–“ç”¨ï¼‰
      function extractHmsFromDateTime(dateTimeStr) {
        if (!dateTimeStr) return "--:--:--"
        try {
          // å…ˆå˜—è©¦ç”¨æ­£å‰‡ç›´æ¥æŠ“ HH:mm:ss
          const hms = dateTimeStr.match(/(\d{1,2}):(\d{1,2})/)
          if (hms) {
            const h = hms[1].padStart(2, "0")
            const m = hms[2].padStart(2, "0")
            return `${h}:${m}`
          }
          // å†å˜—è©¦ Date è§£æ
          const dt = new Date(dateTimeStr)
          if (!isNaN(dt.getTime())) {
            const h = String(dt.getHours()).padStart(2, "0")
            const m = String(dt.getMinutes()).padStart(2, "0")
            return `${h}:${m}`
          }
        } catch (_) {}
        return "--:--"
      }

      // é¸æ“‡å‡½æ•¸
      function selectRoute(routeId, routeName) {
        const all = document.querySelectorAll("#routeSelector .route-option")
        // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸å–èˆ‡é¡è‰²é¡åˆ¥
        all.forEach((el) => {
          el.classList.remove(
            "selected",
            "route-208802",
            "route-2088A2",
            "route-2088B2",
            "route-default"
          )
        })
        // å¥—ç”¨é¸å–èˆ‡å°æ‡‰é…è‰²
        const target = document.querySelector(
          `#routeSelector [data-route="${routeId}"]`
        )
        if (target) {
          target.classList.add("selected")
          const colorClass = getRouteColorClass(routeId) || "route-default"
          target.classList.add(colorClass)
        }
        document.getElementById("selectedRoute").value = routeId
        // æŒä¹…åŒ–é¸æ“‡ï¼Œè®“åˆ·æ–°å¾Œå¯é‚„åŸ
        try {
          localStorage.setItem("tm.selectedRoute", String(routeId || ""))
        } catch (_) {}
      }

      function selectEditRoute(routeId, routeName) {
        const all = document.querySelectorAll(
          "#editRouteSelector .route-option"
        )
        // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸å–èˆ‡é¡è‰²é¡åˆ¥
        all.forEach((el) => {
          el.classList.remove(
            "selected",
            "route-208802",
            "route-2088A2",
            "route-2088B2",
            "route-default"
          )
        })
        // å¥—ç”¨é¸å–èˆ‡å°æ‡‰é…è‰²
        const target = document.querySelector(
          `#editRouteSelector [data-route="${routeId}"]`
        )
        if (target) {
          target.classList.add("selected")
          const colorClass = getRouteColorClass(routeId) || "route-default"
          target.classList.add(colorClass)
        }
        document.getElementById("editSelectedRoute").value = routeId
      }

      // æ¸²æŸ“å¾Œè‡ªå‹•é‚„åŸè·¯ç·šé¸æ“‡ï¼ˆå„ªå…ˆå–éš±è—æ¬„ä½ï¼Œå…¶æ¬¡å– localStorageï¼‰
      function restoreSelectedRoute() {
        const hiddenVal = (
          document.getElementById("selectedRoute")?.value || ""
        ).trim()
        let toRestore = hiddenVal
        if (!toRestore) {
          try {
            const saved = localStorage.getItem("tm.selectedRoute")
            if (saved) toRestore = saved
          } catch (_) {}
        }
        if (toRestore) {
          // ç¬¬äºŒå€‹åƒæ•¸ routeName ç„¡ç”¨æ–¼æ¨£å¼ï¼Œå‚³ç©ºå­—ä¸²å³å¯
          selectRoute(toRestore, "")
        }
      }

      // ç¢ºä¿éš±è—æ¬„ä½èˆ‡è¦–è¦ºé¸å–ã€localStorage åŒæ­¥ï¼ˆé¿å…çœ‹èµ·ä¾†å·²é¸ä½†å€¼ç‚ºç©ºï¼‰
      function ensureRouteSelectedSync() {
        try {
          const hidden = document.getElementById("selectedRoute")
          const selectedEl = document.querySelector(
            "#routeSelector .route-option.selected"
          )
          const saved = localStorage.getItem("tm.selectedRoute") || ""

          // 1) è‹¥æœ‰é¸å–æŒ‰éˆ•ä½† hidden ç‚ºç©ºï¼Œè£œä¸Š data-route
          if (selectedEl && hidden && !hidden.value) {
            const rid = selectedEl.getAttribute("data-route") || ""
            if (rid) hidden.value = rid
          }

          // 2) è‹¥æ²’æœ‰é¸å–æŒ‰éˆ•ä½† hidden æœ‰å€¼ï¼Œè£œä¸Šæ¨£å¼
          if (!selectedEl && hidden && hidden.value) {
            const target = document.querySelector(
              `#routeSelector [data-route="${hidden.value}"]`
            )
            if (target) {
              const all = document.querySelectorAll(
                "#routeSelector .route-option"
              )
              all.forEach((el) =>
                el.classList.remove(
                  "selected",
                  "route-208802",
                  "route-2088A2",
                  "route-2088B2",
                  "route-default"
                )
              )
              target.classList.add("selected")
              const colorClass =
                getRouteColorClass(hidden.value) || "route-default"
              target.classList.add(colorClass)
            }
          }

          // 3) è‹¥å…©è€…çš†ç©ºï¼Œä½† localStorage æœ‰å€¼ï¼Œèµ°ä¸€æ¬¡ selectRoute æµç¨‹
          if (!selectedEl && (!hidden || !hidden.value) && saved) {
            selectRoute(saved, "")
          }
        } catch (_) {}
      }

      function selectVehicleFromList(plateNumber) {
        document
          .querySelectorAll("#vehicleSelector .vehicle-option")
          .forEach((el) => el.classList.remove("selected"))
        document
          .querySelector(`#vehicleSelector [data-vehicle="${plateNumber}"]`)
          .classList.add("selected")
        document.getElementById("selectedVehicle").value = plateNumber
      }

      function selectEditVehicle(plateNumber) {
        document
          .querySelectorAll("#editVehicleSelector .vehicle-option")
          .forEach((el) => el.classList.remove("selected"))
        document
          .querySelector(`#editVehicleSelector [data-vehicle="${plateNumber}"]`)
          .classList.add("selected")
        document.getElementById("editSelectedVehicle").value = plateNumber
      }

      // ç¯©é¸å‡½æ•¸
      function filterVehiclesByOperator() {
        const selectedOperator = document.getElementById("operatorFilter").value
        const vehicleOptions = document.querySelectorAll(
          "#vehicleSelector .vehicle-option"
        )

        vehicleOptions.forEach((option) => {
          const operator = option.dataset.operator
          if (!selectedOperator || operator === selectedOperator) {
            option.style.display = "block"
          } else {
            option.style.display = "none"
          }
        })
      }

      function filterEditVehiclesByOperator() {
        const selectedOperator =
          document.getElementById("editOperatorFilter").value
        const vehicleOptions = document.querySelectorAll(
          "#editVehicleSelector .vehicle-option"
        )

        vehicleOptions.forEach((option) => {
          const operator = option.dataset.operator
          if (!selectedOperator || operator === selectedOperator) {
            option.style.display = "block"
          } else {
            option.style.display = "none"
          }
        })
      }

      function updateOperatorFilter() {
        const operators = [...new Set(vehicles.map((v) => v.operatorName))]
        const filterSelect = document.getElementById("operatorFilter")
        const editFilterSelect = document.getElementById("editOperatorFilter")

        const optionsHtml = operators
          .map((op) => `<option value="${op}">${op}</option>`)
          .join("")

        filterSelect.innerHTML =
          '<option value="">æ‰€æœ‰æ¥­è€…</option>' + optionsHtml
        editFilterSelect.innerHTML =
          '<option value="">æ‰€æœ‰æ¥­è€…</option>' + optionsHtml
      }

      // ä¸»è¦æ“ä½œå‡½æ•¸
      async function createTrip(event) {
        event.preventDefault()
        // æäº¤å‰å†æ¬¡åŒæ­¥ä¸€æ¬¡ï¼Œé¿å…é¡¯ç¤ºå·²é¸ä½† hidden ç©ºç™½
        ensureRouteSelectedSync()
        const route = document.getElementById("selectedRoute").value
        const vehicleNumber = document.getElementById("vehicleNumber").value
        const hour = document.getElementById("hourInput").value
        const minute = document.getElementById("minuteInput").value
        const keepCount = document.getElementById("keepCountInput").value || 4

        if (!route || !vehicleNumber || !hour || !minute) {
          showError("è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š")
          return
        }

        const departureTime = `${hour.padStart(2, "0")}:${minute.padStart(
          2,
          "0"
        )}`

        try {
          const response = await fetch(`${BASE_URL}/Trip`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              route: route,
              vehicleNumber: vehicleNumber,
              departureTime: departureTime,
              status: "pending",
              keepCount: parseInt(keepCount),
            }),
          })

          if (response.ok) {
            // å…ˆä¿å­˜ç›®å‰é¸æ“‡çš„è·¯ç·šID
            const currentRouteId =
              document.getElementById("selectedRoute").value

            showSuccess(`è¶Ÿæ¬¡å·²å»ºç«‹ï¼`)
            // é‡è¨­è¡¨å–®ï¼ˆæœƒæ¸…ç©ºæ‰€æœ‰æ¬„ä½ï¼ŒåŒ…æ‹¬éš±è—æ¬„ä½ï¼‰
            document.getElementById("newTripForm").reset()

            // ç›´æ¥é‡æ–°è¨­å®šè·¯ç·šé¸æ“‡å€¼
            if (currentRouteId) {
              document.getElementById("selectedRoute").value = currentRouteId
              // é‡æ–°é¸å–å°æ‡‰æŒ‰éˆ•
              selectRoute(currentRouteId, "")

              // å„²å­˜åˆ°localStorageä¸­
              try {
                localStorage.setItem("tm.selectedRoute", currentRouteId)
              } catch (_) {}
            }

            await loadTrips()
            // çµ±è¨ˆå€å·²ç§»é™¤
          } else {
            throw new Error("å»ºç«‹è¶Ÿæ¬¡å¤±æ•—")
          }
        } catch (error) {
          showError("å»ºç«‹è¶Ÿæ¬¡å¤±æ•—: " + error.message)
        }
      }

      async function autoAssignPassengers(route) {
        try {
          const response = await fetch(`${BASE_URL}/Trip/auto-assign`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              route: route,
            }),
          })

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const contentType = response.headers.get("content-type")
          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text()
            throw new Error(`APIå›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œé æœŸJSONä½†æ”¶åˆ°: ${text}`)
          }

          const result = await response.json()

          if (result.success) {
            showSuccess(
              `è‡ªå‹•åˆ†é…å®Œæˆï¼æˆåŠŸåˆ†é… ${result.assignedCount || 0} ä½ä¹˜å®¢`
            )
            await loadTrips()
            await loadPendingPassengers()
            // çµ±è¨ˆå€å·²ç§»é™¤
          } else {
            throw new Error(result.message || "è‡ªå‹•æ’ç­å¤±æ•—")
          }
        } catch (error) {
          console.error("è¶Ÿæ¬¡è‡ªå‹•æ’ç­éŒ¯èª¤è©³æƒ…:", error)
          showError("è‡ªå‹•æ’ç­å¤±æ•—: " + error.message)
        }
      }

      async function assignPassengerToTrip(passengerId, tripId) {
        try {
          const tripMeta = trips.find((t) => t.tripId === tripId)
          if (
            tripMeta &&
            (tripMeta.status || "").toLowerCase() === "completed"
          ) {
            showNotification("æ­¤è¶Ÿæ¬¡å·²ç™¼è»Šï¼Œä¸èƒ½å†æ’å…¥ä¹˜å®¢", "info")
            return { success: false, message: "completed trip" }
          }
          const response = await fetch(`${BASE_URL}/Trip/assign-passenger`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              PassengerId: passengerId,
              TripId: tripId,
            }),
          })

          const result = await response.json()

          if (result.success) {
            showSuccess("ä¹˜å®¢åˆ†é…æˆåŠŸï¼")

            // æ›´æ–°æœ¬åœ°åº§ä½æ•¸æ“šï¼ˆå¦‚æœæœ‰è¿”å›åº§ä½çµ±è¨ˆï¼‰
            if (
              result.totalSeats !== undefined &&
              result.tripCapacity !== undefined
            ) {
              // åŒæ­¥æ›´æ–° trips é™£åˆ—ä¸­çš„æ­¤è¶Ÿæ¬¡ç‹€æ…‹
              const tripRef =
                trips && Array.isArray(trips)
                  ? trips.find((t) => t.tripId === tripId)
                  : null
              if (tripRef) {
                tripRef.assignedSeats = result.totalSeats
                // è‹¥å¾Œç«¯å›å‚³æœ€æ–°å®¹é‡ï¼Œæ›´æ–° keepCount
                if (!isNaN(result.tripCapacity)) {
                  tripRef.keepCount = result.tripCapacity
                }
              }
              updateTripSeatDisplay(
                tripId,
                result.totalSeats,
                result.tripCapacity
              )
            }

            await loadTrips()
            await loadPendingPassengers()
            // çµ±è¨ˆå€å·²ç§»é™¤
            return result
          } else {
            throw new Error(result.message || "åˆ†é…ä¹˜å®¢å¤±æ•—")
          }
        } catch (error) {
          showError("åˆ†é…ä¹˜å®¢å¤±æ•—: " + error.message)
          return { success: false, message: error.message }
        }
      }

      // åƒ…é‡å°æŒ‡å®šè¶Ÿæ¬¡è‡ªå‹•æ’ç­ï¼ˆFIFOï¼‰ï¼Œä¸æœƒæ’åˆ°å…¶ä»–è¶Ÿæ¬¡
      async function autoAssignTrip(tripId) {
        try {
          const trip = trips.find((t) => t.tripId === tripId)
          if (!trip) {
            showError("æ‰¾ä¸åˆ°æŒ‡å®šè¶Ÿæ¬¡")
            return
          }

          // è¨ˆç®—è¶Ÿæ¬¡å‰©é¤˜å¯ç”¨åº§ä½
          const currentSeats = getTripPassengerCount(tripId)
          let remaining = (trip.keepCount || 0) - currentSeats
          if (remaining <= 0) {
            showNotification("æ­¤è¶Ÿæ¬¡åº§ä½å·²æ»¿ï¼Œç„¡æ³•è‡ªå‹•æ’ç­", "info")
            return
          }

          // å–å¾—æœªåˆ†é…çš„ä¹˜å®¢ï¼Œä¾ requestDateTime ç”±æ—©åˆ°æ™šï¼ˆFIFOï¼‰
          const candidates = pendingPassengers
            .filter((p) => !p.tripId)
            .sort((a, b) => {
              const ta = new Date(a.requestDateTime).getTime() || 0
              const tb = new Date(b.requestDateTime).getTime() || 0
              return ta - tb
            })

          if (candidates.length === 0) {
            showNotification("ç›®å‰æ²’æœ‰å¾…ä¿ç•™ä¹˜å®¢å¯åˆ†é…", "info")
            return
          }

          let assignedCount = 0

          for (const p of candidates) {
            if (remaining <= 0) break

            // è·¯ç·šç¬¦åˆæ€§ï¼šè‹¥ä¹˜å®¢æœ‰ includeRoutesï¼ˆCSVï¼‰ï¼Œéœ€åŒ…å«æ­¤è¶Ÿæ¬¡è·¯ç·š
            let canTake = true
            if (p.includeRoutes && p.includeRoutes.trim()) {
              const routesCsv = p.includeRoutes
                .split(",")
                .map((r) => r.trim())
                .filter(Boolean)
              canTake = routesCsv.includes(trip.route)
            }

            if (!canTake) continue

            const need = p.seatCount || 1
            if (need > remaining) continue

            try {
              const result = await assignPassengerToTrip(p.id, tripId)
              if (result && result.success !== false) {
                assignedCount += need
                remaining -= need
                // è‹¥å¾Œç«¯å›å‚³æœ€æ–°çµ±è¨ˆï¼Œç«‹å³è¦†å¯«é¡¯ç¤ºèˆ‡ trips ç‹€æ…‹
                if (
                  result.totalSeats !== undefined &&
                  result.tripCapacity !== undefined
                ) {
                  const tripRef = trips.find((t) => t.tripId === tripId)
                  if (tripRef) {
                    tripRef.assignedSeats = result.totalSeats
                    if (!isNaN(result.tripCapacity)) {
                      tripRef.keepCount = result.tripCapacity
                    }
                  }
                  updateTripSeatDisplay(
                    tripId,
                    result.totalSeats,
                    result.tripCapacity
                  )
                } else {
                  // æ²’å›å‚³çµ±è¨ˆæ™‚ï¼ŒæŒ‰æœ¬æ¬¡æŒ‡æ´¾æ•¸ä¼°ç®—æ›´æ–°æŒ‡æ¨™
                  const estimated = getTripPassengerCount(tripId) + need
                  const cap = trip.keepCount
                  const tripRef = trips.find((t) => t.tripId === tripId)
                  if (tripRef) {
                    tripRef.assignedSeats = estimated
                  }
                  updateTripSeatDisplay(tripId, estimated, cap)
                }
              }
            } catch (e) {
              console.warn("æŒ‡æ´¾ä¹˜å®¢å¤±æ•—ï¼Œç•¥é:", p.id, e)
            }
          }

          if (assignedCount > 0) {
            showSuccess(`è‡ªå‹•æ’ç­å®Œæˆï¼Œå·²æŒ‡æ´¾ ${assignedCount} å€‹åº§ä½åˆ°æ­¤è¶Ÿæ¬¡`)
            await loadTrips()
            await loadPendingPassengers()
            // çµ±è¨ˆå€å·²ç§»é™¤
          } else {
            showNotification("æ²’æœ‰ç¬¦åˆæ¢ä»¶æˆ–åº§ä½çš„ä¹˜å®¢å¯åˆ†é…åˆ°æ­¤è¶Ÿæ¬¡", "info")
          }
        } catch (error) {
          console.error("autoAssignTrip éŒ¯èª¤:", error)
          showError("è‡ªå‹•æ’ç­å¤±æ•—: " + error.message)
        }
      }

      async function unassignPassenger(
        passengerId,
        tripIdFromCaller = null,
        seatCountFromCaller = 1
      ) {
        try {
          const response = await fetch(`${BASE_URL}/Trip/unassign-passenger`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              PassengerId: passengerId,
            }),
          })

          const result = await response.json()

          if (result.success) {
            showVisualNotification(
              `ä¹˜å®¢ ${result.data.passengerName} å¾${result.data.departureTime} ${result.data.vehicleNumber} å–æ¶ˆä¿ç•™`,
              "success"
            )

            // å„ªå…ˆä½¿ç”¨å‘¼å«ç«¯æä¾›çš„ tripId/seatCount é€²è¡Œå±€éƒ¨æ›´æ–°ï¼Œé¿å…æ•´é«”æŠ–å‹•
            const tripId = tripIdFromCaller
            const seatDelta = Math.max(1, seatCountFromCaller || 1)

            if (tripId) {
              // åœç”¨å‹•ç•«ï¼Œå±€éƒ¨æ›´æ–°æ­¤è¶Ÿæ¬¡
              const container = document.getElementById("tripsContainer")
              if (container) container.classList.add("no-anim")

              try {
                // æ›´æ–°æœ¬åœ°åº§ä½æ•¸
                const trip = trips.find((t) => t.tripId === tripId)
                if (trip) {
                  const current =
                    typeof trip.assignedSeats === "number"
                      ? trip.assignedSeats
                      : getTripPassengerCount(tripId)
                  trip.assignedSeats = Math.max(0, (current || 0) - seatDelta)
                  updateTripSeatDisplay(tripId)
                }

                // é‡æ–°è¼‰å…¥è©²è¶Ÿæ¬¡çš„ä¹˜å®¢åˆ—è¡¨ï¼ˆè€Œä¸æ˜¯æ•´é«”æ¸²æŸ“ï¼‰
                const passengersHtml = await renderTripPassengers(tripId)
                const passengersContainer = document.getElementById(
                  `passengers-${tripId}`
                )
                if (passengersContainer)
                  passengersContainer.innerHTML = passengersHtml

                // åˆ·æ–°å¾…æ’æ¸…å–®å³å¯ï¼ˆæ•´é«” trips ä¸é‡ç¹ªï¼‰
                await loadPendingPassengers()
              } finally {
                if (container)
                  requestAnimationFrame(() =>
                    container.classList.remove("no-anim")
                  )
              }

              return result
            }

            // å¾Œå‚™è·¯å¾‘ï¼šè‹¥æ‹¿ä¸åˆ° tripIdï¼Œè½å›åŸæµç¨‹ï¼ˆå¯èƒ½é€ æˆè¼ƒå¤šé‡ç¹ªï¼‰
            await loadTrips()
            await loadPendingPassengers()
            trips.forEach((trip) => updateTripSeatDisplay(trip.tripId))
            renderTripsSync()
            return result
          } else {
            throw new Error(result.message || "å–æ¶ˆåˆ†é…å¤±æ•—")
          }
        } catch (error) {
          console.error("å–æ¶ˆåˆ†é…å¤±æ•—:", error)
          showError("å–æ¶ˆåˆ†é…å¤±æ•—: " + error.message)
          showVisualNotification("æ“ä½œå¤±æ•—", "error")
          throw error
        }
      }

      async function updateTripStatus(tripId, status) {
        try {
          const response = await fetch(`${BASE_URL}/Trip/${tripId}/status`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              status: status,
            }),
          })

          const result = await response.json()

          if (result.success) {
            showSuccess(
              `${result.data.departureTime}çš„${result.data.vehicleNumber}ç‹€æ…‹å·²æ›´æ–°ï¼`
            )
            await loadTrips()
            // çµ±è¨ˆå€å·²ç§»é™¤
          } else {
            throw new Error(result.message || "æ›´æ–°ç‹€æ…‹å¤±æ•—")
          }
        } catch (error) {
          showError("æ›´æ–°ç‹€æ…‹å¤±æ•—: " + error.message)
        }
      }

      async function loadTripPassengers(tripId) {
        try {
          const response = await fetch(`${BASE_URL}/Trip/${tripId}/passengers`)
          const result = await response.json()

          if (result.success) {
            return result.data
          } else {
            throw new Error(result.message || "è¼‰å…¥è¶Ÿæ¬¡ä¹˜å®¢å¤±æ•—")
          }
        } catch (error) {
          console.error("è¼‰å…¥è¶Ÿæ¬¡ä¹˜å®¢å¤±æ•—:", error)
          return null
        }
      }

      function editTrip(tripId) {
        const trip = trips.find((t) => t.tripId === tripId)
        if (!trip) return

        document.getElementById("editTripId").value = tripId
        document.getElementById("editSelectedRoute").value = trip.route
        document.getElementById("editVehicleNumber").value = trip.vehicleNumber
        document.getElementById("editKeepCountInput").value =
          trip.keepCount || 4

        // ä¿å­˜åŸå§‹åº§ä½æ•¸ï¼Œç”¨æ–¼ä¹‹å¾Œçš„é©—è­‰
        document.getElementById("editKeepCountInput").dataset.originalCount =
          trip.keepCount || 4

        // è¨ˆç®—ç•¶å‰å·²åˆ†é…çš„åº§ä½æ•¸
        const currentAssignedSeats = getTripPassengerCount(tripId)
        document.getElementById("editKeepCountInput").dataset.assignedSeats =
          currentAssignedSeats

        // è¨­ç½®æœ€å°å€¼ç‚ºåŸå§‹åº§ä½æ•¸æˆ–å·²åˆ†é…åº§ä½æ•¸ï¼ˆå–è¼ƒå¤§å€¼ï¼‰
        const minSeats = Math.max(trip.keepCount || 4, currentAssignedSeats)
        document.getElementById("editKeepCountInput").min = minSeats

        // æ›´æ–°æç¤ºä¿¡æ¯
        document.getElementById(
          "seatCountHint"
        ).innerHTML = `<i class="fa fa-info-circle"></i> åº§ä½æ•¸ä¸èƒ½å°æ–¼ <strong>${minSeats}</strong> (åŸå§‹: ${
          trip.keepCount || 4
        }, å·²åˆ†é…: ${currentAssignedSeats})`

        const [hour, minute] = trip.departureTime.split(":")
        document.getElementById("editHourInput").value = hour.padStart(2, "0")
        document.getElementById("editMinuteInput").value = minute.padStart(
          2,
          "0"
        )

        // è¨­å®šé¸ä¸­ç‹€æ…‹
        setTimeout(() => {
          selectEditRoute(trip.route, "")
        }, 100)

        document.getElementById("editTripModal").style.display = "block"
      }

      async function updateTrip(event) {
        event.preventDefault()

        const tripId = document.getElementById("editTripId").value
        const route = document.getElementById("editSelectedRoute").value
        const vehicleNumber = document.getElementById("editVehicleNumber").value
        const hour = document.getElementById("editHourInput").value
        const minute = document.getElementById("editMinuteInput").value
        const keepCountInput = document.getElementById("editKeepCountInput")
        let keepCount = parseInt(keepCountInput.value) || 4

        // ç²å–åŸå§‹åº§ä½æ•¸å’Œå·²åˆ†é…åº§ä½æ•¸
        const originalCount =
          parseInt(keepCountInput.dataset.originalCount) || 4
        const assignedSeats =
          parseInt(keepCountInput.dataset.assignedSeats) || 0

        // ç¢ºä¿åº§ä½æ•¸ä¸å°æ–¼å·²åˆ†é…çš„åº§ä½æ•¸
        const minAllowedSeats = Math.max(originalCount, assignedSeats)
        if (keepCount < minAllowedSeats) {
          showError(
            `åº§ä½æ•¸ä¸èƒ½å°æ–¼åŸå§‹åº§ä½æ•¸ ${originalCount} æˆ–å·²åˆ†é…çš„åº§ä½æ•¸ ${assignedSeats}`
          )
          keepCountInput.value = minAllowedSeats
          return
        }

        if (!route || !vehicleNumber || !hour || !minute) {
          showError("è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š")
          return
        }

        const departureTime = `${hour.padStart(2, "0")}:${minute.padStart(
          2,
          "0"
        )}`

        try {
          const response = await fetch(`${BASE_URL}/Trip/${tripId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              route: route,
              vehicleNumber: vehicleNumber,
              departureTime: departureTime,
              keepCount: parseInt(keepCount),
            }),
          })

          if (response.ok) {
            showSuccess("è¶Ÿæ¬¡æ›´æ–°æˆåŠŸï¼")
            closeEditModal()
            await loadTrips()
            await loadPendingPassengers()
            // çµ±è¨ˆå€å·²ç§»é™¤
          } else {
            throw new Error("æ›´æ–°è¶Ÿæ¬¡å¤±æ•—")
          }
        } catch (error) {
          showError("æ›´æ–°è¶Ÿæ¬¡å¤±æ•—: " + error.message)
        }
      }

      async function deleteTrip(tripId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¶Ÿæ¬¡å—ï¼Ÿå·²ä¿ç•™çš„ä¹˜å®¢å°‡é€€å›ç­‰å¾…ç‹€æ…‹ã€‚")) {
          return
        }

        try {
          const response = await fetch(`${BASE_URL}/Trip/${tripId}`, {
            method: "DELETE",
          })

          if (response.ok) {
            showSuccess("è¶Ÿæ¬¡åˆªé™¤æˆåŠŸï¼")
            await loadTrips()
            await loadPendingPassengers()
            updateStatistics()
          } else {
            // å˜—è©¦è®€å–å¾Œç«¯éŒ¯èª¤è¨Šæ¯
            let errorMessage = "åˆªé™¤è¶Ÿæ¬¡å¤±æ•—"
            try {
              const errorData = await response.json()
              if (errorData.message) {
                errorMessage = errorData.message
              } else if (errorData.error) {
                errorMessage = errorData.error
              }
            } catch (parseError) {
              // å¦‚æœç„¡æ³•è§£æJSONï¼Œä½¿ç”¨HTTPç‹€æ…‹è¨Šæ¯
              errorMessage = `åˆªé™¤è¶Ÿæ¬¡å¤±æ•— (HTTP ${response.status}: ${response.statusText})`
            }

            console.error("åˆªé™¤è¶Ÿæ¬¡éŒ¯èª¤è©³æƒ…:", {
              status: response.status,
              statusText: response.statusText,
              tripId: tripId,
            })

            throw new Error(errorMessage)
          }
        } catch (error) {
          console.error("åˆªé™¤è¶Ÿæ¬¡ç•°å¸¸:", error)
          showError("åˆªé™¤è¶Ÿæ¬¡å¤±æ•—: " + error.message)
        }
      }

      async function notifyPassengers(tripId) {
        try {
          const response = await fetch(
            `${BASE_URL}/KeepSeat/confirm-departure/${tripId}`,
            {
              method: "POST",
            }
          )

          if (response.ok) {
            // è§£æå›æ‡‰ï¼Œè‹¥ notifiedCount === 0 å‰‡ä¸é¡¯ç¤ºæˆåŠŸã€ç›´æ¥åœæ­¢
            let result = null
            try {
              result = await response.json()
            } catch (_) {
              // è‹¥é JSONï¼Œè¦–ç‚ºç„¡æ³•å–å¾— notifiedCountï¼Œç…§èˆŠé¡¯ç¤ºæˆåŠŸ
            }

            if (result && typeof result.notifiedCount === "number") {
              if (result.notifiedCount === 0) {
                showSuccess(
                  result?.message ? `${result.message}` : "é€šçŸ¥ç™¼é€æˆåŠŸï¼"
                )
                return
              }
            }

            showSuccess(
              result?.message
                ? `é€šçŸ¥ç™¼é€æˆåŠŸï¼š${result.message}`
                : "é€šçŸ¥ç™¼é€æˆåŠŸï¼"
            )
            // æ›´æ–°è¶Ÿæ¬¡ç‹€æ…‹ç‚ºå·²é€šçŸ¥
            //await updateTripStatus(tripId, "notified")

            // ç‰¹åˆ¥æ›´æ–°è©²è¶Ÿæ¬¡çš„ä¹˜å®¢åˆ—è¡¨ï¼Œç¢ºä¿é¡¯ç¤ºæ­£ç¢º
            const tripData = await loadTripPassengers(tripId)
            console.log(`é€šçŸ¥å¾Œè¶Ÿæ¬¡ ${tripId} çš„ä¹˜å®¢è³‡æ–™:`, tripData)

            if (tripData && tripData.passengers) {
              // æ‰‹å‹•æ›´æ–°è©²è¶Ÿæ¬¡çš„ä¹˜å®¢åˆ—è¡¨é¡¯ç¤º
              const passengersHtml = await renderTripPassengers(tripId)
              const passengersContainer = document.getElementById(
                `passengers-${tripId}`
              )
              if (passengersContainer) {
                passengersContainer.innerHTML = passengersHtml
                console.log(`è¶Ÿæ¬¡ ${tripId} çš„ä¹˜å®¢åˆ—è¡¨å·²æ›´æ–°`)
              }
            }
          } else {
            throw new Error(response.statusText || "é€šçŸ¥ç™¼é€å¤±æ•—")
          }
        } catch (error) {
          console.error("é€šçŸ¥ç™¼é€éŒ¯èª¤:", error)
          showError("é€šçŸ¥ç™¼é€å¤±æ•—: " + error.message)
        }
      }

      async function markTripCompleted(tripId) {
        // 1. æ²’æœ‰ä»»ä½•å·²æ’å…¥çš„ä¹˜å®¢ç¦æ­¢æ”¹ç‚ºå·²ç™¼è»Š
        try {
          const assignedSeats = getTripPassengerCount(tripId) || 0
          if (assignedSeats === 0) {
            showNotification("æ²’æœ‰æ’å…¥ä»»ä½•ä¿ç•™ä½ï¼Œç„¡æ³•æ”¹ç‚ºå·²ç™¼è»Š", "info")
            return
          }
        } catch (_) {}

        // 2. æª¢æŸ¥æ˜¯å¦ä»æœ‰æœªé€šçŸ¥(passenger.responseDateTime ç‚ºç©º) çš„ä¹˜å®¢
        let unnotifiedCount = 0
        try {
          const tripData = await loadTripPassengers(tripId)
          const passengers = (tripData && tripData.passengers) || []
          unnotifiedCount = passengers.filter((p) => !p.responseDateTime).length
          if (unnotifiedCount > 0) {
            showNotification(
              `å°šæœ‰ ${unnotifiedCount} ä½ä¹˜å®¢æœªé€šçŸ¥ï¼Œè«‹å…ˆæŒ‰ã€Œé€šçŸ¥ã€å†æ¨™è¨˜å·²ç™¼è»Š`,
              "warning"
            )
            // è¦–è¦ºæç¤ºé€šçŸ¥æŒ‰éˆ•
            try {
              const notifyBtn = document.querySelector(
                `.trip-card[data-trip-id="${tripId}"] .trip-controls button.btn.btn-primary[onclick*="notifyPassengers('${tripId}')"]`
              )
              if (notifyBtn) {
                const prevBoxShadow = notifyBtn.style.boxShadow
                const prevTransform = notifyBtn.style.transform
                notifyBtn.style.boxShadow =
                  "0 0 0 3px rgba(255,152,0,0.65),0 0 12px rgba(255,152,0,0.9)"
                notifyBtn.style.transform = "scale(1.08)"
                let flash = true
                let flashes = 0
                const flashTimer = setInterval(() => {
                  flash = !flash
                  notifyBtn.style.boxShadow = flash
                    ? "0 0 0 3px rgba(255,152,0,0.65),0 0 12px rgba(255,152,0,0.9)"
                    : "0 0 0 3px rgba(255,152,0,0.35),0 0 6px rgba(255,152,0,0.55)"
                  flashes++
                  if (flashes >= 6) {
                    clearInterval(flashTimer)
                    notifyBtn.style.boxShadow = prevBoxShadow
                    notifyBtn.style.transform = prevTransform
                  }
                }, 260)
              }
            } catch (e) {}
            return
          }
        } catch (e) {
          // è‹¥ä¹˜å®¢è³‡æ–™å–å¾—å¤±æ•—ï¼Œä¿å®ˆï¼šä»å…è¨±å¾ŒçºŒæµç¨‹ï¼Œä½†å¯ä»¥æç¤º
          console.warn("æª¢æŸ¥æœªé€šçŸ¥ä¹˜å®¢å¤±æ•—ï¼Œå°‡å…è¨±ç¹¼çºŒ", e)
        }

        // 3. äºŒæ¬¡ç¢ºèª
        if (!confirm("ç¢ºå®šè¦å°‡æ­¤è¶Ÿæ¬¡æ¨™è¨˜ç‚ºå·²ç™¼è»Šå—ï¼Ÿ")) return

        // 4. åŸ·è¡Œæ›´æ–°
        try {
          await updateTripStatus(tripId, "completed")
          showSuccess("è¶Ÿæ¬¡å·²æ¨™è¨˜ç‚ºå·²ç™¼è»Šï¼")
        } catch (error) {
          showError("æ¨™è¨˜å·²ç™¼è»Šå¤±æ•—: " + error.message)
        }
      }

      // åˆ—å°è¶Ÿæ¬¡é ç´„å–®
      async function printReservation(tripId, useBrowserFallback = false) {
        try {
          console.log("ğŸ–¨ï¸ é–‹å§‹åˆ—å°è¶Ÿæ¬¡é ç´„å–®ï¼Œè¶Ÿæ¬¡ID:", tripId)

          // å–å¾—è¶Ÿæ¬¡è©³ç´°è³‡è¨Š
          const response = await fetch(`${BASE_URL}/Trip/${tripId}/passengers`)
          if (!response.ok) {
            throw new Error(
              `ç„¡æ³•å–å¾—è¶Ÿæ¬¡è³‡æ–™: ${response.status} ${response.statusText}`
            )
          }

          const result = await response.json()
          console.log("APIå›æ‡‰åŸå§‹è³‡æ–™:", result)

          if (!result.success) {
            throw new Error(`ç„¡æ³•å–å¾—è¶Ÿæ¬¡è³‡æ–™: ${result.message}`)
          }

          // API è¿”å›çµæ§‹æª¢æŸ¥å’Œè™•ç†
          if (!result.data) {
            throw new Error("APIå›æ‡‰ç¼ºå°‘dataæ¬„ä½")
          }

          // æ ¹æ“šAPIå¯¦éš›å›å‚³çµæ§‹èª¿æ•´
          const tripData = {
            trip: result.data.trip || result.data.Trip || {},
            passengers: result.data.passengers || result.data.Passengers || [],
          }

          // è‹¥æ²’æœ‰æ’å…¥ä¹˜å®¢ï¼Œæç¤ºå¾Œç›´æ¥è¿”å›ï¼Œä¸é€²è¡Œåˆ—å°
          if (!tripData.passengers || tripData.passengers.length === 0) {
            showNotification(
              `${tripData.trip.vehicleNumber} æ²’æœ‰æ’å…¥ä»»ä½•ä¿ç•™ä½ï¼Œæœªåˆ—å°`,
              "info"
            )
            return
          }

          // é€šçŸ¥é–‹å§‹åˆ—å°ï¼ˆå·²ç¢ºèªæœ‰ä¹˜å®¢ï¼‰
          // showNotification("æ­£åœ¨æº–å‚™åˆ—å°...", "info")

          // ç”Ÿæˆ QR ç¢¼ URL (ä½¿ç”¨è¶Ÿæ¬¡ID)
          const qrCodeUrl = await generateQRCodeURL(tripId)

          // è¨ˆç®—ä¹˜å®¢ç¸½åº§ä½æ•¸
          let totalSeats = 0
          tripData.passengers.forEach((p) => {
            totalSeats += p.seatCount || 1
          })

          // ä½¿ç”¨ç€è¦½å™¨åˆ—å°ï¼ˆé…åˆ Chrome --kiosk --kiosk-printing å¯éœé»˜åˆ—å°ï¼‰
          const html = buildReservationHtml(tripData, qrCodeUrl, totalSeats)
          const printContent =
            document.getElementById("print-content") ||
            createPrintContentElement()
          printContent.innerHTML = html
          await waitForQRCodeLoading()
          try {
            printContent.style.display = "block"
            const beforePrintHandler = () => {}
            const afterPrintHandler = () => {
              printContent.style.display = "none"
              window.removeEventListener("beforeprint", beforePrintHandler)
              window.removeEventListener("afterprint", afterPrintHandler)
              showSuccess(
                `${tripData.trip.departureTime}ç™¼è»Šçš„${tripData.trip.vehicleNumber} åˆ—å°å®Œæˆ`
              )
            }
            window.addEventListener("beforeprint", beforePrintHandler)
            window.addEventListener("afterprint", afterPrintHandler)
            // showNotification("æ­£åœ¨ä½¿ç”¨ç€è¦½å™¨åˆ—å°...", "info")
            window.print()
            setTimeout(() => {
              if (printContent.style.display !== "none") {
                printContent.style.display = "none"
                window.removeEventListener("beforeprint", beforePrintHandler)
                window.removeEventListener("afterprint", afterPrintHandler)
              }
            }, 8000)
          } catch (printError) {
            console.error("åˆ—å°éç¨‹éŒ¯èª¤:", printError)
            const el = document.getElementById("print-content")
            if (el) el.style.display = "none"
            showError(`åˆ—å°éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${printError.message}`)
          }
        } catch (error) {
          console.error("åˆ—å°å¤±æ•—:", error)
          showError(`åˆ—å°å¤±æ•—: ${error.message}`)
        }
      }

      // å»ºç«‹ QZ åˆ—å°çš„ HTMLï¼ˆå«å…§åµŒæ¨£å¼ï¼Œé©é… 80mm å°ç¥¨å¯¬åº¦ï¼‰
      function buildReservationHtml(tripData, qrCodeUrl, totalSeats) {
        const list = (tripData.passengers || [])
          .map((p, i) => {
            const name = p.name || p.Name || "æœªçŸ¥"
            const seats = p.seatCount || p.SeatCount || 1
            const from = p.keepStop || p.KeepStop || "æœªçŸ¥"
            const to = p.destStop || p.DestStop || "æœªçŸ¥"
            const rawPhone = p.phone || p.Phone || ""
            const digitsOnly = String(rawPhone).replace(/\D/g, "")
            const tail3 = digitsOnly ? digitsOnly.slice(-3) : ""
            return `${i + 1}. ${name} (${seats}ä½ ) â†’ ${to}  ${tail3}`
          })
          .join("<br/>")

        const route = tripData.trip.route || "æœªçŸ¥"
        const car = tripData.trip.vehicleNumber || "æœªçŸ¥"
        const time = tripData.trip.departureTime || "æœªçŸ¥"
        const now = new Date().toLocaleString()

        return `
          <div style="width:75mm;font-family:'Microsoft JhengHei','Courier New',monospace;font-size:10pt;line-height:0.9;color:#000;padding:0 1mm 1mm;text-align:center;">
            <div style="font-size:16pt;font-weight:700;margin:0 0 1mm;">å¤§éƒ½æœƒå®¢é‹ä¿ç•™åº§ä½æ¸…å–®</div>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <div style="font-size:13pt;">è·¯ç·š: ${route}</div>
            <div style="font-size:13pt;">è»Šè™Ÿ: ${car}</div>
            <div style="font-size:13pt;">ç™¼è»Šæ™‚é–“: ${time}</div>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <div style="text-align:left;display:inline-block;width:90%;font-size:12pt;">${list}</div>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <div style="font-size:13pt;">ç¸½è¨ˆ: ${totalSeats} ä½ä¹˜å®¢</div>
            <div class="qr-code" style="margin:2mm 0;"><img src="${qrCodeUrl}" style="width:30mm;height:30mm;"/></div>
            <div>åˆ—å°æ™‚é–“: ${now}</div>
            <div style="height:12mm;"></div>
          </div>
        `
      }

      // å‰µå»ºåˆ—å°å…§å®¹å…ƒç´ 
      function createPrintContentElement() {
        const printContent = document.createElement("div")
        printContent.id = "print-content"
        printContent.style.display = "none"
        printContent.style.position = "absolute"
        printContent.style.left = "-9999px"
        printContent.style.top = "-9999px"
        document.body.appendChild(printContent)

        // æ·»åŠ åˆ—å°æ¨£å¼
        const printStyle = document.createElement("style")
        printStyle.textContent = `
          @media print {
            /* å¼·åˆ¶å–®é åˆ—å°ï¼Œæœ€å°åŒ–é‚Šè· */
            @page {
              margin: 0 !important;
              size: 79mm auto !important; /* è‡ªå‹•é«˜åº¦ */
              padding: 0 !important;
            }
            /* ç§»é™¤æ ¹ç¯€é»çš„é è¨­é‚Šè·ï¼Œé¿å…é ‚éƒ¨ç©ºç™½ */
            html, body {
              margin: 0 !important;
              padding: 0 !important;
            }
            
            /* éš±è—æ‰€æœ‰éåˆ—å°å…§å®¹ */
            body > *:not(#print-content) {
              display: none !important;
            }
            
            /* ç¢ºä¿åˆ—å°å…§å®¹å¯è¦‹ä¸”æ¨£å¼æ­£ç¢º */
            #print-content {
              display: block !important;
              position: static !important;
              left: auto !important;
              top: auto !important;
              width: 75mm !important;
              height: auto !important;
              font-family: "Microsoft JhengHei", "Courier New", monospace !important;
              font-size: 10pt !important;
              line-height: 1.2 !important;
              color: black !important;
              background: white !important;
              padding: 0 1mm 1mm !important;
              text-align: center !important;
              margin: 0 auto !important;
              box-sizing: border-box !important;
              overflow: visible !important;
              page-break-inside: avoid !important;
            }
            
            /* åˆ—å°å…§å®¹çš„æ‰€æœ‰å­å…ƒç´ æ¨£å¼ */
            #print-content * {
              background: transparent !important;
              color: black !important;
              text-align: center !important;
              page-break-inside: avoid !important;
            }
            
            /* æ¨™é¡Œæ¨£å¼ */
            #print-content .print-header {
              font-size: 12pt !important;
              font-weight: bold !important;
              margin: 2mm 0 !important;
            }
            
            #print-content .print-title {
              font-size: 16pt !important;
              font-weight: bold !important;
              margin: 0 0 3mm 0 !important;
            }
            
            /* QRç¢¼æ¨£å¼ */
            #print-content .qr-code {
              page-break-inside: avoid !important;
              margin: 2mm 0 !important;
            }
            
            #print-content .qr-code img {
              width: 30mm !important;
              height: 30mm !important;
              display: block !important;
              margin: 0 auto !important;
            }
            
            /* ä¹˜å®¢åˆ—è¡¨æ¨£å¼ */
            #print-content .passenger-list {
              font-size: 9pt !important;
              line-height: 1.1 !important;
              margin: 2mm auto !important;
              text-align: left !important;
              width: 90% !important;
              display: inline-block !important;
            }
          }
        `
        document.head.appendChild(printStyle)

        return printContent
      }

      // ç­‰å¾… QR ç¢¼åœ–ç‰‡è¼‰å…¥
      function waitForQRCodeLoading() {
        return new Promise((resolve) => {
          const qrImage = document.querySelector("#print-content .qr-code img")
          if (!qrImage) {
            console.warn("æ²’æœ‰æ‰¾åˆ° QR ç¢¼åœ–ç‰‡")
            resolve()
            return
          }

          if (qrImage.complete) {
            console.log("QR ç¢¼åœ–ç‰‡å·²è¼‰å…¥")
            resolve()
            return
          }

          qrImage.onload = () => {
            console.log("QR ç¢¼åœ–ç‰‡è¼‰å…¥å®Œæˆ")
            resolve()
          }

          qrImage.onerror = () => {
            console.warn("QR ç¢¼åœ–ç‰‡è¼‰å…¥å¤±æ•—")
            resolve()
          }

          // é˜²æ­¢æ°¸é ç­‰å¾…
          setTimeout(resolve, 3000)
        })
      }

      // ç”Ÿæˆ QR ç¢¼ URL
      async function generateQRCodeURL(text) {
        // ä½¿ç”¨ç°¡å–®çš„ QR ç¢¼ API
        const encodedText = encodeURIComponent(text)
        return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodedText}`
      }

      // æ¸¬è©¦ API é€£æ¥
      async function testApiConnection() {
        try {
          console.log("æ¸¬è©¦ API é€£æ¥...")
          const response = await fetch(`${BASE_URL}/Trip/test-endpoint`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              test: "hello",
              timestamp: new Date().toISOString(),
            }),
          })

          const result = await response.json()
          console.log("API æ¸¬è©¦çµæœ:", result)
          if (result.success) {
            showSuccess("API é€£æ¥æ­£å¸¸")
          } else {
            showError("API æ¸¬è©¦å¤±æ•—: " + result.message)
          }
        } catch (error) {
          console.error("API æ¸¬è©¦éŒ¯èª¤:", error)
          showError("API é€£æ¥æ¸¬è©¦å¤±æ•—: " + error.message)
        }
      }

      // å–®å€‹ä¹˜å®¢è‡ªå‹•æ’ç­
      async function autoAssignSinglePassenger(passengerId) {
        try {
          if (showCompletedTrips) {
            showVisualNotification("å·²ç™¼è»Šæª¢è¦–æ¨¡å¼ä¸‹ä¸å¯æ’ç­", "error")
            return
          }
          const passenger = pendingPassengers.find((p) => p.id === passengerId)
          if (!passenger) {
            showError("æ‰¾ä¸åˆ°ä¹˜å®¢è³‡æ–™")
            return
          }

          // è©³ç´°èª¿è©¦è¼¸å‡º
          console.log("=== è‡ªå‹•æ’ç­èª¿è©¦ä¿¡æ¯ ===")
          console.log(
            "PassengerId é¡å‹:",
            typeof passengerId,
            "å€¼:",
            passengerId
          )
          console.log("å®Œæ•´ä¹˜å®¢è³‡æ–™:", passenger)
          console.log("KeepStop:", passenger.keepStop)
          console.log("DestStop:", passenger.destStop)
          console.log("SeatCount:", passenger.seatCount)

          // ğŸš€ å„ªåŒ–ï¼šä½¿ç”¨é è¨ˆç®—çš„ IncludeRoutesï¼Œç„¡éœ€ API èª¿ç”¨
          let availableRoutes = []
          if (passenger.includeRoutes && passenger.includeRoutes.trim()) {
            // å¾é è¨ˆç®—çš„ CSV æ¬„ä½è§£æå¯ç”¨è·¯ç·š
            availableRoutes = passenger.includeRoutes
              .split(",")
              .map((route) => route.trim())
              .filter((route) => route.length > 0)
            console.log("ğŸ“ˆ ä½¿ç”¨é è¨ˆç®—è·¯ç·š (ç„¡APIèª¿ç”¨):", availableRoutes)
          } else {
            // é™ç´šè™•ç†ï¼šå¦‚æœæ²’æœ‰é è¨ˆç®—è³‡æ–™ï¼Œæ‰ä½¿ç”¨ API
            console.log(`âš ï¸ é™ç´šè™•ç†ï¼šæŸ¥è©¢å¯ç”¨è·¯ç·š...`)
            const routesResponse = await fetch(
              `${BASE_URL}/Trip/available-routes/${encodeURIComponent(
                passenger.destStop
              )}`
            )

            if (!routesResponse.ok) {
              throw new Error(`ç„¡æ³•æŸ¥è©¢å¯ç”¨è·¯ç·š: HTTP ${routesResponse.status}`)
            }

            const routesResult = await routesResponse.json()
            console.log("å¯ç”¨è·¯ç·šæŸ¥è©¢çµæœ:", routesResult)

            if (
              !routesResult.success ||
              !routesResult.data ||
              routesResult.data.length === 0
            ) {
              throw new Error(`ç›®çš„åœ°ç«™ç‰Œ "${passenger.destStop}" æ²’æœ‰å¯ç”¨è·¯ç·š`)
            }

            availableRoutes = routesResult.data
            console.log("æ‰¾åˆ°å¯ç”¨è·¯ç·š:", availableRoutes)
          }

          // é¡¯ç¤ºå¯ç”¨è·¯ç·šè¨Šæ¯
          showSuccess(
            `æ‰¾åˆ° ${availableRoutes.length} æ¢å¯ç”¨è·¯ç·š: ${availableRoutes.join(
              ", "
            )}`
          )

          const requestData = {
            PassengerId: passengerId,
            KeepStop: passenger.keepStop || "",
            DestStop: passenger.destStop || "",
            SeatCount: passenger.seatCount || 1,
            AvailableRoutes: availableRoutes,
          }

          console.log(
            "æº–å‚™ç™¼é€çš„è«‹æ±‚è³‡æ–™:",
            JSON.stringify(requestData, null, 2)
          )

          const response = await fetch(`${BASE_URL}/Trip/auto-assign-single`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          })

          if (!response.ok) {
            // å˜—è©¦è®€å–éŒ¯èª¤å›æ‡‰çš„è©³ç´°è¨Šæ¯
            let errorMessage = `HTTP ${response.status}: ${response.statusText}`
            try {
              const errorText = await response.text()
              console.log("ä¼ºæœå™¨å›æ‡‰çš„å®Œæ•´éŒ¯èª¤å…§å®¹:", errorText)

              // å˜—è©¦è§£æç‚º JSON
              if (errorText) {
                try {
                  const errorResult = JSON.parse(errorText)
                  if (errorResult.message) {
                    errorMessage = `HTTP ${response.status}: ${errorResult.message}`
                  } else if (errorResult.title) {
                    errorMessage = `HTTP ${response.status}: ${errorResult.title}`
                  } else {
                    errorMessage = `HTTP ${response.status}: ${errorText}`
                  }
                } catch (jsonError) {
                  errorMessage = `HTTP ${response.status}: ${errorText}`
                }
              }
            } catch (parseError) {
              console.error("ç„¡æ³•è®€å–éŒ¯èª¤å›æ‡‰:", parseError)
            }
            throw new Error(errorMessage)
          }

          const contentType = response.headers.get("content-type")
          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text()
            throw new Error(`APIå›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œé æœŸJSONä½†æ”¶åˆ°: ${text}`)
          }

          const result = await response.json()

          if (result.success) {
            showSuccess(
              `ä¹˜å®¢ ${passenger.name} å·²ä¿ç•™ ${result.data.departureTime} çš„ ${result.data.vehicleNumber} `
            )
            await loadTrips()
            await loadPendingPassengers()
            updateStatistics()
          } else {
            // è™•ç†è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
            let errorMessage = result.message || "è‡ªå‹•ä¿ç•™å¤±æ•—"
            let detailMessage = ""

            // æª¢æŸ¥æ˜¯å¦æœ‰è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
            if (result.detail) {
              detailMessage += `åŸå› ï¼š${result.detail}`
            }

            // é¡¯ç¤ºéŒ¯èª¤åˆ†é¡å’ŒæŠ€è¡“ç´°ç¯€
            if (result.errorCategory) {
              detailMessage += `\néŒ¯èª¤é¡åˆ¥ï¼š${result.errorCategory}`
            }

            if (
              result.technicalError &&
              result.technicalError !== result.message
            ) {
              detailMessage += `\næŠ€è¡“è©³æƒ…ï¼š${result.technicalError}`
            }

            if (result.errorType) {
              detailMessage += `\néŒ¯èª¤é¡å‹ï¼š${result.errorType}`
            }

            // é¡¯ç¤ºå»ºè­°æ“ä½œæ­¥é©Ÿ
            if (result.steps && result.steps.length > 0) {
              detailMessage += `\n\nå»ºè­°æ­¥é©Ÿï¼š`
              result.steps.forEach((step, index) => {
                detailMessage += `\n${step}`
              })
            }

            // é¡¯ç¤ºé™¤éŒ¯è³‡è¨Šï¼ˆåƒ…åœ¨é–‹ç™¼ç’°å¢ƒï¼‰
            if (result.debugInfo && window.location.hostname === "localhost") {
              detailMessage += `\n\né™¤éŒ¯è³‡è¨Šï¼š`
              detailMessage += `\nâ€¢ æ–¹æ³•ï¼š${result.debugInfo.method}`
              detailMessage += `\nâ€¢ éŒ¯èª¤é¡å‹ï¼š${result.debugInfo.errorType}`
              if (result.debugInfo.hasInnerException) {
                detailMessage += `\nâ€¢ å…§éƒ¨éŒ¯èª¤ï¼š${result.debugInfo.innerExceptionMessage}`
              }
            }

            // é¡¯ç¤ºæ™‚é–“æˆ³
            if (result.timestamp) {
              detailMessage += `\n\nç™¼ç”Ÿæ™‚é–“ï¼š${result.timestamp}`
            }

            if (result.reason) {
              detailMessage += `\nå•é¡Œï¼š${result.reason}`
            }

            // é¡¯ç¤ºå¯ç”¨çš„è¶Ÿæ¬¡ä¿¡æ¯
            if (result.availableTrips && result.availableTrips.length > 0) {
              detailMessage += `\n\nç›®å‰å¯ç”¨è¶Ÿæ¬¡ï¼š`
              result.availableTrips.forEach((trip) => {
                detailMessage += `\nâ€¢ ${trip.vehicleNumber} (${trip.route}) ${trip.departureTime} - åº§ä½ï¼š${trip.availableSeats}/${trip.totalSeats} å¯ç”¨`
              })
            }

            // é¡¯ç¤ºå»ºè­°æ“ä½œ
            if (result.suggestions && result.suggestions.length > 0) {
              detailMessage += `\n\nå»ºè­°æ“ä½œï¼š`
              result.suggestions.forEach((suggestion, index) => {
                detailMessage += `\n${index + 1}. ${suggestion}`
              })
            }

            // é¡¯ç¤ºè¨ºæ–·ä¿¡æ¯
            if (result.detail && result.detail.totalTripsToday !== undefined) {
              detailMessage += `\n\nç³»çµ±è¨ºæ–­ï¼š`
              detailMessage += `\nâ€¢ ä»Šæ—¥ç¸½è¶Ÿæ¬¡ï¼š${result.detail.totalTripsToday} å€‹`
              if (
                result.detail.availableRoutesToday &&
                result.detail.availableRoutesToday.length > 0
              ) {
                detailMessage += `\nâ€¢ å¯ç”¨è·¯ç·šï¼š${result.detail.availableRoutesToday.join(
                  ", "
                )}`
              }
              if (
                result.detail.requiredRoutes &&
                result.detail.requiredRoutes.length > 0
              ) {
                detailMessage += `\nâ€¢ éœ€è¦è·¯ç·šï¼š${result.detail.requiredRoutes.join(
                  ", "
                )}`
              }
            }

            // é¡¯ç¤ºä¹˜å®¢ä¿¡æ¯
            if (result.passengerInfo) {
              detailMessage += `\n\nä¹˜å®¢è³‡è¨Šï¼š`
              detailMessage += `\nâ€¢ å§“åï¼š${result.passengerInfo.name}`
              detailMessage += `\nâ€¢ éœ€è¦åº§ä½ï¼š${result.passengerInfo.requiredSeats} å€‹`
              if (
                result.passengerInfo.routes &&
                result.passengerInfo.routes.length > 0
              ) {
                detailMessage += `\nâ€¢ å¯æ­è·¯ç·šï¼š${result.passengerInfo.routes.join(
                  ", "
                )}`
              }
            }

            // ä½¿ç”¨æ›´è©³ç´°çš„éŒ¯èª¤é¡¯ç¤º
            showDetailedError(errorMessage, detailMessage)
          }
        } catch (error) {
          console.error("è‡ªå‹•ä¿ç•™éŒ¯èª¤è©³æƒ…:", error)

          // å˜—è©¦å¾éŒ¯èª¤ä¿¡æ¯ä¸­æå–æ›´è©³ç´°çš„ä¿¡æ¯
          let errorMessage = "è‡ªå‹•ä¿ç•™å¤±æ•—"
          let errorDetail = error.message

          // æ ¹æ“šéŒ¯èª¤é¡å‹é€²è¡Œåˆ†é¡è™•ç†
          if (error.message.includes("HTTP 400")) {
            errorMessage = "ä¿ç•™è«‹æ±‚æœ‰èª¤"
            errorDetail = error.message.replace("HTTP 400: ", "")
          } else if (error.message.includes("HTTP 500")) {
            errorMessage = "ç³»çµ±è™•ç†éŒ¯èª¤"
            errorDetail = error.message.replace("HTTP 500: ", "")

            // å˜—è©¦è§£æ HTTP 500 éŒ¯èª¤ä¸­çš„ JSON å…§å®¹
            try {
              const jsonMatch = errorDetail.match(/\{.*\}/)
              if (jsonMatch) {
                const errorObj = JSON.parse(jsonMatch[0])
                if (errorObj.message) {
                  errorMessage = errorObj.message
                }
                if (errorObj.detail) {
                  errorDetail = `${errorObj.detail}`
                }
                if (errorObj.errorCategory) {
                  errorDetail += `\néŒ¯èª¤é¡åˆ¥ï¼š${errorObj.errorCategory}`
                }
                if (errorObj.technicalError) {
                  errorDetail += `\næŠ€è¡“è©³æƒ…ï¼š${errorObj.technicalError}`
                }
              }
            } catch (parseError) {
              console.warn("ç„¡æ³•è§£æ HTTP 500 éŒ¯èª¤ä¸­çš„ JSON å…§å®¹:", parseError)
            }
          } else if (
            error.message.includes("æ²’æœ‰") ||
            error.message.includes("æ‰¾ä¸åˆ°")
          ) {
            errorMessage = "æ‰¾ä¸åˆ°å¯ç”¨è¶Ÿæ¬¡"
            errorDetail = "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¶Ÿæ¬¡å¯é€²è¡Œä¿ç•™"
          } else if (error.message.includes("åº§ä½")) {
            errorMessage = "åº§ä½ä¸è¶³"
            errorDetail = "æ‰€é¸è¶Ÿæ¬¡çš„åº§ä½æ•¸é‡ä¸è¶³"
          } else if (
            error.message.includes("ç¶²è·¯") ||
            error.message.includes("connection") ||
            error.message.includes("fetch")
          ) {
            errorMessage = "ç¶²è·¯é€£ç·šå•é¡Œ"
            errorDetail = "è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢"
          } else if (error.message.includes("timeout")) {
            errorMessage = "è«‹æ±‚é€¾æ™‚"
            errorDetail = "ç³»çµ±è™•ç†æ™‚é–“éé•·ï¼Œè«‹ç¨å¾Œå†è©¦"
          }

          // å¦‚æœéŒ¯èª¤ä¿¡æ¯å¾ˆé•·æˆ–åŒ…å«è©³ç´°è³‡è¨Šï¼Œä½¿ç”¨è©³ç´°éŒ¯èª¤é¡¯ç¤º
          if (
            errorDetail &&
            (errorDetail.length > 50 || errorDetail.includes("\n"))
          ) {
            showDetailedError(errorMessage, errorDetail)
          } else {
            showError(`${errorMessage}: ${errorDetail}`)
          }
        }
      }

      // é¡¯ç¤ºæ‰‹å‹•æ’ç­æ¨¡æ…‹æ¡†
      async function showManualAssignModal(passengerId) {
        if (showCompletedTrips) {
          showVisualNotification("å·²ç™¼è»Šæª¢è¦–æ¨¡å¼ä¸‹ä¸å¯æ’ç­", "error")
          return
        }
        const passenger = pendingPassengers.find((p) => p.id === passengerId)
        if (!passenger) {
          showError("æ‰¾ä¸åˆ°ä¹˜å®¢è³‡æ–™")
          return
        }

        // ğŸš€ å„ªåŒ–ï¼šä½¿ç”¨é è¨ˆç®—çš„ IncludeRoutes é€²è¡Œè·¯ç·šéæ¿¾
        let passengerAvailableRoutes = []
        if (passenger.includeRoutes && passenger.includeRoutes.trim()) {
          passengerAvailableRoutes = passenger.includeRoutes
            .split(",")
            .map((route) => route.trim())
            .filter((route) => route.length > 0)
          console.log(
            "ğŸ“ˆ ä½¿ç”¨é è¨ˆç®—è·¯ç·šéæ¿¾è¶Ÿæ¬¡ (ç„¡APIèª¿ç”¨):",
            passengerAvailableRoutes
          )
        }

        // æ‰¾å‡ºé©åˆçš„è¶Ÿæ¬¡ï¼ˆæœ‰ç©ºä½ä¸”è·¯ç·šç›¸ç¬¦ï¼‰
        const availableTrips = []

        for (const trip of trips) {
          // æª¢æŸ¥åŸºæœ¬æ¢ä»¶
          if (
            trip.status === "completed" ||
            getTripPassengerCount(trip.tripId) >= trip.keepCount
          ) {
            continue
          }

          // ğŸš€ å„ªåŒ–ï¼šè·¯ç·šåŒ¹é…æª¢æŸ¥
          let canTake = false
          if (passengerAvailableRoutes.length > 0) {
            // ä½¿ç”¨é è¨ˆç®—è·¯ç·šï¼Œç„¡éœ€ API èª¿ç”¨
            canTake = passengerAvailableRoutes.includes(trip.route)
            console.log(
              `è¶Ÿæ¬¡ ${trip.route}: ${canTake ? "ç¬¦åˆ" : "ä¸ç¬¦åˆ"} é è¨ˆç®—è·¯ç·š`
            )
          } else {
            // é™ç´šè™•ç†ï¼šä½¿ç”¨åŸæœ‰çš„ API æª¢æŸ¥æ–¹å¼
            console.log(`âš ï¸ é™ç´šè™•ç†ï¼šAPIæª¢æŸ¥è¶Ÿæ¬¡ ${trip.route}`)
            canTake = await canPassengerTakeRoute(passengerId, trip.route)
          }

          if (canTake) {
            availableTrips.push(trip)
          }
        }

        if (availableTrips.length === 0) {
          showError(
            `ä¹˜å®¢ ${passenger.name} æ²’æœ‰é©åˆçš„è¶Ÿæ¬¡å¯ä¾›é¸æ“‡ï¼Œè«‹æª¢æŸ¥ç›®çš„åœ°ç«™ç‰Œ "${passenger.destStop}" æˆ–å¯ç”¨è¶Ÿæ¬¡åº§ä½`
          )
          return
        }

        let modalHtml = `
          <div class="modal" id="manualAssignModal" style="display: block;">
            <div class="modal-content">
              <span class="close" onclick="closeManualAssignModal()">&times;</span>
              <h3>æ‰‹å‹•æ’ç­ - ${passenger.name}</h3>
              <p><strong>è·¯ç·š:</strong> ${passenger.keepStop} â†’ ${
          passenger.destStop
        }</p>
              <p><strong>åº§ä½éœ€æ±‚:</strong> ${passenger.seatCount || 1} ä½</p>
              <p><strong>é›»è©±:</strong> ${passenger.phone || "ç„¡"}</p>
              <hr>
              <h4>é¸æ“‡è¶Ÿæ¬¡:</h4>
              <div style="max-height: 300px; overflow-y: auto;">
        `

        availableTrips.forEach((trip) => {
          const passengerCount = getTripPassengerCount(trip.tripId)
          const remainingSeats = trip.keepCount - passengerCount

          modalHtml += `
            <div class="trip-option" style="border: 1px solid #ddd; margin: 5px 0; padding: 10px; border-radius: 5px; cursor: pointer;"
                 onclick="assignToTrip('${passengerId}', '${trip.tripId}')">
              <strong>${trip.route} - ${trip.vehicleNumber}</strong><br>
              ç™¼è»Šæ™‚é–“: ${trip.departureTime}<br>
              åº§ä½ç‹€æ³: ${passengerCount}/${
            trip.keepCount
          } (å‰©é¤˜ ${remainingSeats} ä½)<br>
              ç‹€æ…‹: ${
                trip.status === "pending"
                  ? "æº–å‚™ç™¼è»Š"
                  : trip.status === "notified"
                  ? "å·²é€šçŸ¥"
                  : "å¾…åˆ†é…ä¿ç•™ä½ä¸­"
              }
            </div>
          `
        })

        modalHtml += `
              </div>
            </div>
          </div>
        `

        document.body.insertAdjacentHTML("beforeend", modalHtml)
      }

      function closeManualAssignModal() {
        const modal = document.getElementById("manualAssignModal")
        if (modal) {
          modal.remove()
        }
      }

      async function assignToTrip(passengerId, tripId) {
        try {
          await assignPassengerToTrip(passengerId, tripId)
          closeManualAssignModal()
        } catch (error) {
          showError("æ’ç­å¤±æ•—: " + error.message)
        }
      }

      // ç§»é™¤ä¹˜å®¢å¾è¶Ÿæ¬¡
      async function removePassengerFromTrip(
        passengerId,
        tripId,
        seatCount = 1
      ) {
        if (!confirm("ç¢ºå®šè¦å°‡æ­¤ä¹˜å®¢å¾è¶Ÿæ¬¡ä¸­ç§»é™¤å—ï¼Ÿ")) {
          return
        }

        try {
          await unassignPassenger(passengerId, tripId, seatCount)

          // å¼·åˆ¶é‡æ–°è¼‰å…¥å’Œæ¸²æŸ“
          // å·²æ”¹ç‚ºå±€éƒ¨æ›´æ–°ï¼Œé€™è£¡ç„¡éœ€æ•´é«”é‡è¼‰
          updateStatistics() // ç›®å‰çµ±è¨ˆå·²ç§»é™¤ï¼Œç•™å­˜å ä½
        } catch (error) {
          showError("ç§»é™¤å¤±æ•—: " + error.message)
        }
      }

      // è¼”åŠ©å‡½æ•¸
      function closeEditModal() {
        document.getElementById("editTripModal").style.display = "none"
      }

      function clearSelections(options) {
        options = options || {}
        const preserveRoute = options.preserveRoute !== false // é è¨­ä¿ç•™è·¯ç·š

        // è»Šè¼›èˆ‡æ™‚é–“æ¬„ä½æ¸…ç©º
        document
          .querySelectorAll(".vehicle-option.selected")
          .forEach((el) => el.classList.remove("selected"))
        document.getElementById("vehicleNumber").value = ""
        document.getElementById("hourInput").value = ""
        document.getElementById("minuteInput").value = ""
        document.getElementById("keepCountInput").value = "4"

        // è¦–éœ€è¦æ˜¯å¦æ¸…é™¤è·¯ç·šé¸æ“‡èˆ‡å„²å­˜
        if (!preserveRoute) {
          document
            .querySelectorAll(".route-option.selected")
            .forEach((el) => el.classList.remove("selected"))
          const sr = document.getElementById("selectedRoute")
          if (sr) sr.value = ""
          try {
            localStorage.removeItem("tm.selectedRoute")
          } catch (_) {}
        }
      }

      function getTripPassengerCount(tripId) {
        // å¾ trips é™£åˆ—ä¸Šçš„ assignedSeats è®€å–ï¼ˆç”± renderTripPassengers èˆ‡ API å›æ‡‰ç¶­è­·ï¼‰
        const trip =
          trips && Array.isArray(trips)
            ? trips.find((t) => t.tripId === tripId)
            : null
        if (trip && typeof trip.assignedSeats === "number") {
          return trip.assignedSeats
        }
        return 0
      }

      // æ›´æ–°è¶Ÿæ¬¡åº§ä½é¡¯ç¤º
      function updateTripSeatDisplay(
        tripId,
        currentSeatsOverride,
        keepCountOverride
      ) {
        const trip = trips.find((t) => t.tripId === tripId)
        if (!trip) {
          console.error(`Trip with ID ${tripId} not found.`)
          return
        }

        const currentSeats =
          typeof currentSeatsOverride === "number"
            ? currentSeatsOverride
            : getTripPassengerCount(tripId)
        const effectiveKeep =
          typeof keepCountOverride === "number" && !isNaN(keepCountOverride)
            ? keepCountOverride
            : trip.keepCount
        const seatIndicator = document.querySelector(
          `.trip-card[data-trip-id="${tripId}"] .seat-indicator`
        )

        if (seatIndicator) {
          seatIndicator.textContent = `ğŸª‘ ${currentSeats}/${effectiveKeep}`
          seatIndicator.className = `seat-indicator ${
            currentSeats >= effectiveKeep
              ? "full"
              : currentSeats > 0
              ? "pending"
              : ""
          }`
        } else {
          console.error(
            `Seat indicator for trip ID ${tripId} not found in DOM.`
          )
        }
      }

      function updateStatistics() {
        /* å·²ç§»é™¤è¦–è¦ºçµ±è¨ˆ */
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none"
      }

      function showError(message) {
        renderToast(message, "error")
      }

      function showDetailedError(title, details) {
        // ä½¿ç”¨è¼ƒå¤§çš„å¯æ»¾å‹• toast ä»¥é¿å…æ¨æ“ ç‰ˆé¢
        const container = ensureGlobalMessageHost()
        const toast = document.createElement("div")
        toast.style.pointerEvents = "auto"
        toast.style.background = "#f8d7da"
        toast.style.border = "1px solid #f5c6cb"
        toast.style.color = "#721c24"
        toast.style.padding = "12px 14px"
        toast.style.borderRadius = "8px"
        toast.style.boxShadow = "0 8px 24px rgba(0,0,0,.18)"
        toast.style.maxWidth = "560px" // å†é•·ä¸€é»
        toast.style.maxHeight = "50vh"
        toast.style.overflow = "auto"
        toast.style.opacity = "0"
        toast.style.transform = "translateY(-4px)"
        toast.style.transition = "opacity .3s ease, transform .3s ease"
        toast.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">${title}</div>`
        if (details && details.trim()) {
          const formatted = details.replace(/\n/g, "<br>")
          toast.innerHTML += `<div style=\"font-size:14px; line-height:1.5;\">${formatted}</div>`
        }
        container.appendChild(toast)
        // å‹•ç•«é€²å ´
        requestAnimationFrame(() => {
          toast.style.opacity = "1"
          toast.style.transform = "translateY(0)"
        })
        // é€¾æ™‚æ·¡å‡ºç§»é™¤ï¼ˆä¿ç•™è¼ƒé•·æ™‚é–“ä¾¿æ–¼é–±è®€ï¼‰
        setTimeout(() => {
          toast.style.opacity = "0"
          toast.style.transform = "translateY(-4px)"
          setTimeout(() => toast.remove(), 300)
        }, 10000)
      }

      function showSuccess(message) {
        renderToast(message, "success")
      }

      function showNotification(message, type = "info") {
        // å°‡ info / warning ä¹Ÿåšå¯è¦‹é¡¯ç¤ºï¼Œé¿å…ä½¿ç”¨è€…æ„Ÿè¦ºã€Œæ²’åæ‡‰ã€
        if (type === "error") return showError(message)
        return renderToast(message, type)
      }

      function ensureGlobalMessageHost() {
        let host = document.getElementById("globalMessageHost")
        if (!host) {
          host = document.createElement("div")
          host.id = "globalMessageHost"
          host.style.position = "fixed"
          host.style.top = "24px"
          host.style.left = "50%"
          host.style.transform = "translateX(-50%)"
          host.style.zIndex = "10000"
          host.style.display = "flex"
          host.style.flexDirection = "column"
          host.style.gap = "8px"
          host.style.alignItems = "center"
          host.style.pointerEvents = "none"
          document.body.appendChild(host)
        }
        return host
      }

      function renderToast(message, type = "info") {
        const container = ensureGlobalMessageHost()
        const toast = document.createElement("div")
        toast.style.pointerEvents = "auto"
        toast.style.padding = "10px 12px"
        toast.style.borderRadius = "8px"
        toast.style.boxShadow = "0 8px 24px rgba(0,0,0,.18)"
        toast.style.maxWidth = "520px" // å†é•·ä¸€é»
        toast.style.fontSize = "14px"
        toast.style.lineHeight = "1.4"
        toast.style.color = "#fff"
        toast.style.opacity = "0"
        toast.style.transform = "translateY(-4px)"
        toast.style.transition = "opacity .3s ease, transform .3s ease"
        switch (type) {
          case "error":
            toast.style.background = "#ff4d4f" // æ›´é†’ç›®çš„ç´…è‰²
            break
          case "success":
            toast.style.background = "#00c853" // æ›´äº®çš„ç¶ è‰²
            break
          case "warning":
            toast.style.background = "#ffca28" // äº®é»ƒ
            toast.style.color = "#3d2e00"
            break
          default:
            toast.style.background = "#2f86eb" // äº®è—
            break
        }
        toast.textContent = message
        container.appendChild(toast)
        // å‹•ç•«é€²å ´
        requestAnimationFrame(() => {
          toast.style.opacity = "1"
          toast.style.transform = "translateY(0)"
        })
        // é¡¯ç¤ºç´„ 5 ç§’ï¼Œæ·¡å‡ºå¾Œç§»é™¤
        const displayMs = 8000
        setTimeout(() => {
          toast.style.opacity = "0"
          toast.style.transform = "translateY(-4px)"
          setTimeout(() => toast.remove(), 300)
        }, displayMs)
        return toast
      }

      // æ¸¬è©¦åˆ—å°åŠŸèƒ½
      function testPrint() {
        try {
          // ä½¿ç”¨æ¨™æº–åˆ—å°
          standardTestPrint()
        } catch (error) {
          console.error("æ¸¬è©¦åˆ—å°éŒ¯èª¤:", error)
          showError(`æ¸¬è©¦åˆ—å°å¤±æ•—: ${error.message}`)
        }
      }

      // æ¨™æº–åˆ—å°æ¸¬è©¦ï¼ˆkiosk-printing ä¸‹å°‡éœé»˜åˆ—å°ï¼‰
      async function standardTestPrint() {
        showNotification("æ­£åœ¨æ¸¬è©¦åˆ—å°åŠŸèƒ½...", "info")

        const html = `
          <div id="print-content" style="width:75mm;font-family:'Microsoft JhengHei','Courier New',monospace;font-size:10pt;line-height:1.2;color:#000;padding:2mm;text-align:center;">
            <div style="font-size:16pt;font-weight:700;margin:0 0 3mm;">åˆ—å°æ¸¬è©¦é </div>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <p>æ™‚é–“: ${new Date().toLocaleString()}</p>
            <div style="border-top:1px dashed #000;margin:2mm 0;"></div>
            <p>å¦‚æœæ‚¨çœ‹åˆ°æ­¤é é¢ï¼Œåˆ—å°è¨­å®šæ­£ç¢º</p>
            <div style="height:8mm;"></div>
          </div>`

        const printContent =
          document.getElementById("print-content") ||
          createPrintContentElement()
        printContent.innerHTML = html
        printContent.style.display = "block"
        const beforePrintHandler = () => {}
        const afterPrintHandler = () => {
          printContent.style.display = "none"
          window.removeEventListener("beforeprint", beforePrintHandler)
          window.removeEventListener("afterprint", afterPrintHandler)
          showSuccess("åˆ—å°æ¸¬è©¦å®Œæˆ")
        }
        window.addEventListener("beforeprint", beforePrintHandler)
        window.addEventListener("afterprint", afterPrintHandler)
        window.print()
        setTimeout(() => {
          if (printContent.style.display !== "none") {
            printContent.style.display = "none"
            window.removeEventListener("beforeprint", beforePrintHandler)
            window.removeEventListener("afterprint", afterPrintHandler)
          }
        }, 8000)
      }

      // æ‹–æ‹½åŠŸèƒ½æ”¯æ´
      function makeDraggable() {
        const passengerCards = document.querySelectorAll(".passenger-card")
        const tripCards = document.querySelectorAll(".trip-card")

        passengerCards.forEach((card) => {
          card.draggable = true
          card.addEventListener("dragstart", handleDragStart)
          card.addEventListener("dragend", handleDragEnd)
        })

        tripCards.forEach((card) => {
          card.addEventListener("dragover", handleDragOver)
          card.addEventListener("drop", handleDrop)
          card.addEventListener("dragleave", handleDragLeave)
        })
      }

      function handleDragStart(e) {
        e.target.classList.add("dragging")
        e.dataTransfer.setData("text/plain", e.target.dataset.passengerId)
      }

      function handleDragEnd(e) {
        e.target.classList.remove("dragging")
      }

      // æª¢æŸ¥ä¹˜å®¢æ˜¯å¦å¯ä»¥æ­ä¹˜æŒ‡å®šè·¯ç·š
      async function canPassengerTakeRoute(passengerId, routeId) {
        try {
          // æ‰¾åˆ°ä¹˜å®¢è³‡æ–™
          const passenger = pendingPassengers.find((p) => p.id === passengerId)
          if (!passenger || !passenger.destStop) {
            console.log("æ‰¾ä¸åˆ°ä¹˜å®¢æˆ–ä¹˜å®¢æ²’æœ‰ç›®çš„åœ°ç«™ç‰Œ")
            return false
          }

          // ç²å–è·¯ç·šçš„ç«™ç‰Œè³‡æ–™
          const response = await fetch(`${BASE_URL}/KeepStop/route/${routeId}`)
          if (!response.ok) {
            console.log("ç„¡æ³•ç²å–è·¯ç·šç«™ç‰Œè³‡æ–™")
            return false
          }

          const stops = await response.json()
          if (!stops || stops.length === 0) {
            console.log("è·¯ç·šæ²’æœ‰ç«™ç‰Œè³‡æ–™")
            return false
          }

          const destStop = passenger.destStop || ""
          const cleanDestStop = destStop.replace(/\s+/g, "").toUpperCase()

          // æª¢æŸ¥ç›®çš„åœ°ç«™ç‰Œæ˜¯å¦åœ¨è©²è·¯ç·šçš„ç«™ç‰Œåˆ—è¡¨ä¸­
          const hasDestStop = stops.some((stop) => {
            const stopName = stop.stopNameZh || ""
            const cleanStopName = stopName.replace(/\s+/g, "").toUpperCase()
            return (
              cleanStopName.includes(cleanDestStop) ||
              cleanDestStop.includes(cleanStopName)
            )
          })

          console.log(
            `ä¹˜å®¢ ${passenger.name} (ç›®çš„åœ°: ${destStop}) ${
              hasDestStop ? "å¯ä»¥" : "ä¸å¯ä»¥"
            } æ­ä¹˜è·¯ç·š ${routeId}`
          )
          return hasDestStop
        } catch (error) {
          console.error("æª¢æŸ¥ä¹˜å®¢è·¯ç·šåŒ¹é…å¤±æ•—:", error)
          return false
        }
      }

      function handleDragOver(e) {
        const status = (
          e.currentTarget.getAttribute("data-status") || ""
        ).toLowerCase()
        if (status === "completed") {
          // æ”¹è®Šæ¸¸æ¨™èˆ‡æ¨£å¼æç¤ºä¸å¯æ”¾ç½®
          e.currentTarget.classList.add("drag-blocked")
          e.dataTransfer.dropEffect = "none"
          return
        }
        e.preventDefault()
        e.dataTransfer.dropEffect = "move"
        e.currentTarget.classList.add("drag-over")
      }

      async function handleDrop(e) {
        e.preventDefault()
        e.currentTarget.classList.remove("drag-over")
        e.currentTarget.classList.remove("drag-blocked")

        const status = (
          e.currentTarget.getAttribute("data-status") || ""
        ).toLowerCase()
        if (status === "completed") {
          showNotification("å·²ç™¼è»Šè¶Ÿæ¬¡ç¦æ­¢å†æ’å…¥", "info")
          return
        }

        const passengerId = e.dataTransfer.getData("text/plain")
        const tripCard = e.currentTarget
        const tripId = tripCard.dataset.tripId

        if (passengerId && tripId) {
          // æ‰¾åˆ°å°æ‡‰çš„è¶Ÿæ¬¡
          const trip = trips.find((t) => t.tripId === tripId)
          if (!trip) {
            showError("æ‰¾ä¸åˆ°å°æ‡‰çš„è¶Ÿæ¬¡")
            return
          }

          // ğŸš€ å„ªåŒ–ï¼šä½¿ç”¨é è¨ˆç®—çš„ IncludeRoutes æª¢æŸ¥è·¯ç·šåŒ¹é…
          const passenger = pendingPassengers.find((p) => p.id === passengerId)
          if (!passenger) {
            showError("æ‰¾ä¸åˆ°å°æ‡‰çš„ä¹˜å®¢")
            return
          }

          let canTake = false
          if (passenger.includeRoutes && passenger.includeRoutes.trim()) {
            // ä½¿ç”¨é è¨ˆç®—è·¯ç·šï¼Œç„¡éœ€ API èª¿ç”¨
            const availableRoutes = passenger.includeRoutes
              .split(",")
              .map((route) => route.trim())
              .filter((route) => route.length > 0)
            canTake = availableRoutes.includes(trip.route)
            console.log(
              `ğŸ“ˆ æ‹–æ‹½æª¢æŸ¥ (ç„¡APIèª¿ç”¨): è¶Ÿæ¬¡ ${trip.route} ${
                canTake ? "ç¬¦åˆ" : "ä¸ç¬¦åˆ"
              } é è¨ˆç®—è·¯ç·š`
            )
          } else {
            // é™ç´šè™•ç†ï¼šä½¿ç”¨åŸæœ‰çš„ API æª¢æŸ¥æ–¹å¼
            console.log(`âš ï¸ æ‹–æ‹½é™ç´šè™•ç†ï¼šAPIæª¢æŸ¥è¶Ÿæ¬¡ ${trip.route}`)
            canTake = await canPassengerTakeRoute(passengerId, trip.route)
          }

          if (!canTake) {
            const passengerName = passenger ? passenger.name : "æœªçŸ¥ä¹˜å®¢"
            showError(
              `${passengerName} ç„¡æ³•æ­ä¹˜è·¯ç·š ${trip.route}ï¼Œè«‹æª¢æŸ¥ç›®çš„åœ°ç«™ç‰Œæ˜¯å¦æ­£ç¢º`
            )
            return
          }

          // å¦‚æœå¯ä»¥æ­ä¹˜ï¼Œå‰‡åˆ†é…ä¹˜å®¢
          assignPassengerToTrip(passengerId, tripId)
        }
      }

      function handleDragLeave(e) {
        e.currentTarget.classList.remove("drag-over")
      }

      // åˆ‡æ›è¶Ÿæ¬¡è©³ç´°è³‡è¨Š
      function toggleTripDetails(tripId) {
        const details = document.getElementById(`details-${tripId}`)
        const toggleBtn = document.querySelector(
          `[data-trip-id="${tripId}"] .toggle-btn`
        )

        if (details && toggleBtn) {
          if (details.classList.contains("expanded")) {
            details.classList.remove("expanded")
            toggleBtn.classList.remove("expanded")
            toggleBtn.textContent = "ğŸ”½"
          } else {
            details.classList.add("expanded")
            toggleBtn.classList.add("expanded")
            toggleBtn.textContent = "ğŸ”¼"
          }
        }
      }

      // å…¨éƒ¨å±•é–‹è¶Ÿæ¬¡
      function expandAllTrips() {
        const allDetails = document.querySelectorAll(".trip-collapsible")
        const allToggleBtns = document.querySelectorAll(".toggle-btn")

        allDetails.forEach((detail) => {
          detail.classList.add("expanded")
        })

        allToggleBtns.forEach((btn) => {
          btn.classList.add("expanded")
          btn.textContent = "ğŸ”¼"
        })
      }

      // å…¨éƒ¨æ‘ºç–Šè¶Ÿæ¬¡
      function collapseAllTrips() {
        const allDetails = document.querySelectorAll(".trip-collapsible")
        const allToggleBtns = document.querySelectorAll(".toggle-btn")

        allDetails.forEach((detail) => {
          detail.classList.remove("expanded")
        })

        allToggleBtns.forEach((btn) => {
          btn.classList.remove("expanded")
          btn.textContent = "ğŸ”½"
        })
      }

      function pollPendingPassengers() {
        fetch(`${BASE_URL}/Trip/pending-passengers`)
          .then((res) => res.json())
          .then((result) => {
            if (!result.success || !Array.isArray(result.data)) return

            const todayPassengers = result.data // ç›´æ¥ä½¿ç”¨ API è¿”å›çš„è³‡æ–™

            // è‹¥è³‡æ–™ç„¡è®Šæ›´ï¼Œé¿å…é‡ç¹ªä»¥æ¸›å°‘æŠ–å‹•
            try {
              const currentKey = JSON.stringify(pendingPassengers)
              const incomingKey = JSON.stringify(todayPassengers)
              if (currentKey === incomingKey) {
                return
              }
            } catch (_) {
              // æ¯”å°å¤±æ•—æ™‚ï¼Œç¹¼çºŒèµ°å·®ç•°æµç¨‹
            }

            const removedReservations = pendingPassengers.filter(
              (oldPassenger) =>
                !todayPassengers.some(
                  (newPassenger) => newPassenger.id === oldPassenger.id
                )
            )

            const addedReservations = todayPassengers.filter(
              (newPassenger) =>
                !pendingPassengers.some(
                  (oldPassenger) => oldPassenger.id === newPassenger.id
                )
            )

            if (removedReservations.length > 0) {
              removedReservations.forEach((removedPassenger) => {
                trips.forEach((trip) => {
                  if (trip.passengers) {
                    trip.passengers = trip.passengers.filter(
                      (passenger) => passenger.id !== removedPassenger.id
                    )
                  }
                  // åƒ…æ›´æ–°å—å½±éŸ¿çš„åº§ä½é¡¯ç¤º
                  updateTripSeatDisplay(trip.tripId)
                })
              })
              showNotification("æœ‰ä¹˜å®¢å–æ¶ˆé ç´„ï¼Œå·²è‡ªå‹•ç§»é™¤ï¼")

              // ä½¿ç”¨å®‰å…¨çš„æ–¹å¼æ’­æ”¾éŸ³æ•ˆ
              playNotificationSound()
            }

            if (addedReservations.length > 0) {
              showNotification("æœ‰æ–°çš„é ç´„é€²å…¥å¾…æ’ï¼")

              // ä½¿ç”¨å®‰å…¨çš„æ–¹å¼æ’­æ”¾éŸ³æ•ˆ
              playNotificationSound()
            }

            pendingPassengers = todayPassengers

            // åƒ…åœ¨æœ‰å·®ç•°æ™‚é€²è¡Œå¿…è¦çš„é‡ç¹ª
            renderPendingPassengers()
            renderTripsSync()
            updateStatistics()
          })
          .catch((error) => {
            console.error("API request failed:", error)
          })
      }

      // å®‰å…¨æ’­æ”¾é€šçŸ¥éŸ³æ•ˆ
      function playNotificationSound() {
        try {
          const sound = document.getElementById("notifySound")
          if (sound) {
            // æª¢æŸ¥ AudioContext æ˜¯å¦å­˜åœ¨ä¸¦ä¸”æ˜¯å¦å·²å•Ÿç”¨
            if (
              window.audioContext &&
              window.audioContext.state === "running"
            ) {
              // é‡ç½®æ’­æ”¾ä½ç½®
              sound.currentTime = 0

              // æ’­æ”¾è²éŸ³
              const playPromise = sound.play()

              // è™•ç†æ’­æ”¾ Promise
              if (playPromise !== undefined) {
                playPromise
                  .then(() => {
                    console.log("é€šçŸ¥éŸ³æ•ˆæ’­æ”¾æˆåŠŸ")
                  })
                  .catch((error) => {
                    console.error("é€šçŸ¥éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", error)

                    // å¦‚æœæ˜¯å› ç‚ºç”¨æˆ¶äº’å‹•é™åˆ¶ï¼Œæç¤ºç”¨æˆ¶
                    if (error.name === "NotAllowedError") {
                      showVisualNotification(
                        "è«‹é»æ“Šã€Œå•Ÿç”¨éŸ³æ•ˆé€šçŸ¥ã€æŒ‰éˆ•ä¾†å•Ÿç”¨éŸ³æ•ˆ",
                        "warning"
                      )
                    }
                  })
              }
            } else {
              console.warn("AudioContext æœªå•Ÿç”¨ï¼Œç„¡æ³•æ’­æ”¾éŸ³æ•ˆ")
              showVisualNotification(
                "è«‹é»æ“Šã€Œå•Ÿç”¨éŸ³æ•ˆé€šçŸ¥ã€æŒ‰éˆ•ä¾†å•Ÿç”¨éŸ³æ•ˆ",
                "warning"
              )
            }
          } else {
            console.error("æ‰¾ä¸åˆ°éŸ³æ•ˆå…ƒç´ ")
          }
        } catch (error) {
          console.error("æ’­æ”¾é€šçŸ¥éŸ³æ•ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:", error)
        }
      }
      setInterval(pollPendingPassengers, 5000) // æ¯5ç§’è‡ªå‹•åµæ¸¬
    </script>

    <!-- åˆ—å°å…§å®¹å€åŸŸ -->
    <div
      id="print-content"
      style="
        display: none;
        position: absolute;
        left: -9999px;
        top: -9999px;
        background: white;
        color: black;
      "
    ></div>

    <!-- åˆ—å°æ¨£å¼ -->
    <style>
      /* åˆ—å°å…§å®¹æ¨£å¼å®šç¾© */
      #print-content .print-title {
        font-size: 16pt;
        font-weight: bold;
        text-align: center;
        margin: 0 0 3mm 0;
        background: white;
        color: black;
      }

      #print-content .print-header {
        font-size: 12pt;
        font-weight: bold;
        margin: 2mm 0;
        text-align: center;
        background: white;
        color: black;
      }

      #print-content .print-divider {
        height: 3mm;
        margin: 0;
        padding: 0;
        background: white;
        border: none;
      }

      #print-content .print-route,
      #print-content .print-stop {
        font-size: 11pt;
        font-weight: bold;
        margin: 1mm 0;
        text-align: center;
        background: white;
        color: black;
      }

      #print-content .passenger-list {
        font-size: 9pt;
        line-height: 1.2;
        margin: 2mm 0;
        text-align: left;
        background: white;
        color: black;
      }

      #print-content .print-summary,
      #print-content .print-datetime {
        font-size: 9pt;
        margin: 1mm 0;
        text-align: center;
        background: white;
        color: black;
      }

      #print-content .print-spacer {
        height: 4mm;
        margin: 0;
        padding: 0;
        background: white;
        border: none;
      }

      #print-content .qr-code {
        margin: 2mm 0;
        text-align: center;
        background: white;
      }

      #print-content .qr-code img {
        background: white;
        border: none;
        width: 30mm;
        height: 30mm;
      }

      /* åˆ—å°æ™‚çš„æ¨£å¼ */
      @media print {
        /* å¼·åˆ¶å–®é åˆ—å°ï¼Œæœ€å°åŒ–é‚Šè· */
        @page {
          margin: 2mm !important;
          size: 79mm auto !important; /* è‡ªå‹•é«˜åº¦ */
          padding: 0 !important;
        }

        /* éš±è—æ‰€æœ‰éåˆ—å°å…§å®¹ */
        body > *:not(#print-content) {
          display: none !important;
        }

        /* ç¢ºä¿åˆ—å°å…§å®¹å¯è¦‹ä¸”æ¨£å¼æ­£ç¢º */
        #print-content {
          display: block !important;
          position: static !important;
          left: auto !important;
          top: auto !important;
          width: 75mm !important;
          height: auto !important;
          font-family: "Microsoft JhengHei", "Courier New", monospace !important;
          font-size: 10pt !important;
          line-height: 1.2 !important;
          color: black !important;
          background: white !important;
          padding: 2mm !important;
          text-align: center !important;
          margin: 0 auto !important;
          box-sizing: border-box !important;
          overflow: visible !important;
          page-break-inside: avoid !important;
        }
      }
    </style>

    <script>
      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // åˆå§‹åŒ–é é¢
      })
    </script>
  </body>
</html>
