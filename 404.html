<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>重定向中...</title>

    <!-- 最激進的立即重定向 - 在任何渲染之前執行 -->
    <script>
      // 阻止頁面渲染，立即檢查重定向
      document.open()
      document.write('<div style="display:none;">重定向中...</div>')
      document.close()
      ;(function () {
        var path = window.location.pathname
        var search = window.location.search || ""

        // 檢查是否有 fromLine 參數
        var urlParams = new URLSearchParams(search)
        var fromLine = urlParams.get("fromLine") === "true"

        // 如果是 e-announcement 路徑，立即重定向，不顯示任何內容
        if (path.indexOf("/e-announcement/") !== -1) {
          var backendUrl = "https://35.221.146.143.nip.io/linehook"
          var redirectUrl = backendUrl + path + search

          // 檢查 LINE 環境
          var userAgent = navigator.userAgent || ""
          var isLineApp =
            userAgent.indexOf("Line") !== -1 ||
            userAgent.toLowerCase().indexOf("line") !== -1 ||
            fromLine // 如果有 fromLine 參數，也視為 LINE 環境

          if ((isLineApp || fromLine) && window.opener) {
            // LINE 彈出窗口：安全的關閉策略
            console.log("LINE 環境檢測到，執行安全關閉策略")

            // 先通知 opener 我們正在關閉
            try {
              if (window.opener && !window.opener.closed) {
                window.opener.postMessage("child-closing", "*")
              }
            } catch (e) {
              console.log("無法發送關閉消息:", e)
            }

            // 延遲執行關閉，確保消息已發送
            setTimeout(function () {
              var attempts = 0
              var maxAttempts = 5 // 減少嘗試次數，避免過度激進

              function safeClose() {
                attempts++
                try {
                  window.close()

                  // 檢查是否成功關閉
                  setTimeout(function () {
                    if (!window.closed && attempts < maxAttempts) {
                      // 如果還沒關閉，繼續嘗試
                      safeClose()
                    } else if (!window.closed) {
                      // 溫和的清理：只隱藏內容，不刪除整個 DOM
                      document.body.style.display = "none"
                      document.documentElement.style.visibility = "hidden"

                      // 最後嘗試：重定向到後端
                      setTimeout(function () {
                        window.location.replace(redirectUrl)
                      }, 100)
                    }
                  }, 50) // 增加間隔時間
                } catch (e) {
                  if (attempts < maxAttempts) {
                    setTimeout(safeClose, 100) // 增加重試間隔
                  } else {
                    // 最終處理：重定向而不是清空頁面
                    window.location.replace(redirectUrl)
                  }
                }
              }

              // 開始安全關閉
              safeClose()
            }, 50) // 給消息傳送一些時間
          } else {
            // 非 LINE 彈出窗口：立即重定向
            window.location.replace(redirectUrl)
          }

          // 阻止任何進一步的渲染
          return
        }
      })()
    </script>
  </head>
  <body style="display: none">
    <!-- 頁面內容被隱藏，防止閃爍 -->
  </body>
</html>
