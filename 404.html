<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>重定向中...</title>

    <!-- 最激進的立即重定向 - 在任何渲染之前執行 -->
    <script>
      // 阻止頁面渲染，立即檢查重定向
      document.open()
      document.write('<div style="display:none;">重定向中...</div>')
      document.close()

      ;(function () {
        var path = window.location.pathname
        var search = window.location.search || ""

        // 檢查是否有 fromLine 參數
        var urlParams = new URLSearchParams(search)
        var fromLine = urlParams.get("fromLine") === "true"

        // 如果是 e-announcement 路徑，立即重定向，不顯示任何內容
        if (path.indexOf("/e-announcement/") !== -1) {
          var backendUrl = "https://35.221.146.143.nip.io/linehook"
          var redirectUrl = backendUrl + path + search

          // 檢查 LINE 環境
          var userAgent = navigator.userAgent || ""
          var isLineApp =
            userAgent.indexOf("Line") !== -1 ||
            userAgent.toLowerCase().indexOf("line") !== -1 ||
            fromLine // 如果有 fromLine 參數，也視為 LINE 環境

          if ((isLineApp || fromLine) && window.opener) {
            // LINE 彈出窗口：立即且激進的關閉策略
            console.log("LINE 環境檢測到，執行激進關閉策略")

            var attempts = 0
            var maxAttempts = 10 // 增加嘗試次數

            function aggressiveClose() {
              attempts++
              try {
                // 立即清空頁面
                document.documentElement.innerHTML = ""

                // 嘗試多種關閉方法
                window.close()

                // 檢查是否成功關閉
                setTimeout(function () {
                  if (!window.closed && attempts < maxAttempts) {
                    // 如果還沒關閉，繼續嘗試
                    aggressiveClose()
                  } else if (!window.closed) {
                    // 最終手段：多重清理
                    try {
                      document.head.innerHTML = ""
                      document.body.innerHTML = ""
                      window.location.replace("javascript:void(0)")

                      setTimeout(function () {
                        window.location.replace("about:blank")
                      }, 10)
                    } catch (e) {
                      // 最後嘗試：強制隱藏所有內容
                      document.documentElement.style.display = "none"
                      window.location.href = "about:blank"
                    }
                  }
                }, 10) // 更短的間隔
              } catch (e) {
                if (attempts < maxAttempts) {
                  setTimeout(aggressiveClose, 5) // 更頻繁的重試
                } else {
                  // 最終清空頁面
                  try {
                    document.documentElement.innerHTML = ""
                    window.location.replace("about:blank")
                  } catch (finalError) {
                    document.documentElement.style.display = "none"
                  }
                }
              }
            }

            // 立即開始激進關閉
            aggressiveClose()
          } else {
            // 非 LINE 彈出窗口：立即重定向
            window.location.replace(redirectUrl)
          }

          // 阻止任何進一步的渲染
          return
        }
      })()
    </script>
  </head>
  <body style="display: none">
    <!-- 頁面內容被隱藏，防止閃爍 -->
  </body>
</html>
