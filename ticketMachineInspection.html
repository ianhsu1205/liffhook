<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>è»Šè¼›æª¢æŸ¥è¡¨</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- SheetJS åº«ç”¨æ–¼ Excel åŒ¯å‡º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 
      LIFF è¨­å®šèªªæ˜ï¼š
      1. è«‹å°‡ LIFF_ID è®Šæ•¸æ›¿æ›ç‚ºæ‚¨å¯¦éš›çš„ LIFF ID
      2. éœ€è¦åœ¨ LINE Developers Console ä¸­å‰µå»º LIFF æ‡‰ç”¨
      3. LIFF é¡å‹å»ºè­°é¸æ“‡ "Full" æˆ– "Tall"
      4. è¨­å®šæ­£ç¢ºçš„ Endpoint URL
      
    
    -->
    <style>
      body {
        font-family: "Noto Sans TC", Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        color: #000;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      h2 {
        margin-top: 10px;
        color: #06c755;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        border-bottom: none;
        padding-bottom: 15px;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }

      .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 4px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border 0.3s;
        box-sizing: border-box;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: #06c755;
        outline: none;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.1);
      }

      button {
        width: 100%;
        padding: 14px;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 10px;
      }

      button:hover {
        background-color: #04a73e;
        box-shadow: 0 4px 8px rgba(6, 199, 85, 0.2);
      }

      .secondary-button {
        background-color: #f1f1f1;
        color: #333;
      }

      .secondary-button:hover {
        background-color: #e5e5e5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }

      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        display: block;
      }

      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        display: block;
      }

      .status-message.info {
        background-color: #e7f3fe;
        color: #004085;
        display: block;
      }

      /* è»Šè™Ÿè‡ªå‹•åŒ¹é…åŠŸèƒ½ */
      .plate-suggestions {
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        background: white;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        width: calc(100% - 2px);
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }

      .suggestion-item:hover {
        background-color: #f8f9fa;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      /* æª¢æŸ¥é …ç›®å’Œæª¢æŸ¥çµæœé¸æ“‡æ¨£å¼ */
      .option-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
        scrollbar-width: thin;
        scrollbar-color: #06c755 #f1f1f1;
      }

      /* Webkitç€è¦½å™¨çš„æ»¾å‹•æ¢æ¨£å¼ */
      .option-grid::-webkit-scrollbar {
        width: 8px;
      }

      .option-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .option-grid::-webkit-scrollbar-thumb {
        background: #06c755;
        border-radius: 4px;
      }

      .option-grid::-webkit-scrollbar-thumb:hover {
        background: #059652;
      }

      .option-item {
        padding: 8px 6px;
        border: 2px solid #ddd;
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #ffffff;
        font-size: 12px;
        min-height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        word-break: keep-all;
        position: relative;
      }

      .option-item.selected {
        border-color: #06c755;
        background-color: #e8f5e8;
        color: #06c755;
        font-weight: 500;
      }

      .option-item:hover {
        border-color: #06c755;
      }

      /* çµ±è¨ˆè³‡è¨Šé¡¯ç¤º */
      .stats-container {
        background-color: #e7f3fe;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
      }

      .stats-item {
        display: inline-block;
        margin: 0 15px;
      }

      .stats-number {
        font-size: 24px;
        font-weight: bold;
        color: #004085;
      }

      .stats-label {
        font-size: 14px;
        color: #555;
      }

      /* æª¢æŸ¥è¨˜éŒ„åˆ—è¡¨ - æ–°æ¨£å¼ */
      .vehicle-inspection-item {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .vehicle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
      }

      .check-count {
        background: #06c755;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .check-details {
        margin-bottom: 15px;
      }

      .check-detail {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
      }

      .device-badge {
        background: #17a2b8;
        color: white;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .result-badge {
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .result-normal {
        background: #28a745;
        color: white;
      }

      .result-issue {
        background: #dc3545;
        color: white;
      }

      .result-updated {
        background: #007bff;
        color: white;
      }

      .result-other {
        background: #6c757d;
        color: white;
      }

      .other-note {
        width: 100%;
        background: #fff3cd;
        color: #856404;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        margin-top: 4px;
        border-left: 4px solid #ffc107;
      }

      .plate-number {
        font-weight: bold;
        color: #06c755;
        font-size: 18px;
      }

      .check-time {
        color: #666;
        font-size: 12px;
      }

      .device-result {
        margin-bottom: 5px;
      }

      .device-name {
        font-weight: 500;
        color: #333;
      }

      .result-text {
        color: #666;
      }

      /* æ“ä½œæŒ‰éˆ• */
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .edit-btn,
      .delete-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s;
      }

      .edit-btn {
        background-color: #ffc107;
        color: #212529;
        border: 2px solid #ffc107;
      }

      .edit-btn:hover {
        background-color: #ffca2c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      }

      .delete-btn {
        background-color: #dc3545;
        color: white;
        border: 2px solid #dc3545;
      }

      .delete-btn:hover {
        background-color: #e65760;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      }

      /* ç·¨è¼¯æ¨¡å¼æ¨£å¼ */
      .editing-mode {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 3px solid #ffc107;
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.2);
        position: relative;
      }

      .editing-mode::before {
        content: "ğŸ“ ç·¨è¼¯æ¨¡å¼";
        position: absolute;
        top: -15px;
        left: 15px;
        background: #ffc107;
        color: #212529;
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
      #vehicleListContainer::-webkit-scrollbar {
        width: 8px;
      }

      #vehicleListContainer::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      #vehicleListContainer::-webkit-scrollbar-thumb {
        background: #06c755;
        border-radius: 4px;
      }

      #vehicleListContainer::-webkit-scrollbar-thumb:hover {
        background: #04a73e;
      }

      /* åœ–ç‰‡æŸ¥çœ‹æŒ‰éµæ¨£å¼ */
      .image-view-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(23, 162, 184, 0.95);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 15;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .image-view-btn:hover {
        background: rgba(23, 162, 184, 1);
        border-color: rgba(255, 255, 255, 1);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      .image-count {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #dc3545;
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        font-size: 8px;
        font-weight: bold;
        width: 14px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .option-text {
        display: block;
        padding-right: 35px;
      }

      /* Modal æ¨£å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 90%;
        max-height: 90%;
        overflow: hidden;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
      }

      .modal-header h3 {
        margin: 0;
        color: #333;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }

      .close:hover {
        color: #000;
      }

      /* è»Šè¼›åˆ—è¡¨å®¹å™¨æ¨£å¼ */
      .vehicle-list-container {
        position: relative;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background: #fafafa;
        scrollbar-width: thin;
        scrollbar-color: #06c755 #f1f1f1;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 480px) {
        .container {
          margin: 5px;
          padding: 15px;
        }

        .option-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 4px;
          max-height: 250px;
          padding: 6px;
        }

        .option-item {
          padding: 6px 4px;
          font-size: 11px;
          min-height: 38px;
        }

        .stats-item {
          display: block;
          margin: 10px 0;
        }

        .vehicle-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .check-detail {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }

        .action-buttons {
          flex-direction: column;
          gap: 8px;
        }

        .edit-btn,
        .delete-btn {
          padding: 12px;
          font-size: 16px;
        }
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #06c755;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      .position-relative {
        position: relative;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h2>è»Šè¼›æª¢æŸ¥è¡¨</h2>

      <!-- å°ˆæ¡ˆé¸æ“‡ -->
      <div
        class="project-selection"
        style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        "
      >
        <div
          style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap"
        >
          <label style="font-weight: 500; color: #333; white-space: nowrap"
            >é¸æ“‡å°ˆæ¡ˆ:</label
          >
          <select
            id="projectSelect"
            style="
              flex: 1;
              min-width: 200px;
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 6px;
              font-size: 14px;
            "
          >
            <option value="">è«‹é¸æ“‡å°ˆæ¡ˆ...</option>
          </select>
          <button
            id="projectManagementBtn"
            onclick="openProjectManagement()"
            style="
              padding: 10px 15px;
              background: #06c755;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              white-space: nowrap;
            "
          >
            <i class="fas fa-cog"></i> å°ˆæ¡ˆç®¡ç†
          </button>
          <button
            id="exportReportBtn"
            onclick="exportProjectReport()"
            style="
              padding: 10px 15px;
              background: #17a2b8;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              white-space: nowrap;
              display: none;
            "
          >
            <i class="fas fa-download"></i> åŒ¯å‡ºå ±è¡¨
          </button>
        </div>
        <div
          id="projectStatus"
          style="
            margin-top: 10px;
            padding: 8px 12px;
            background: #fff3cd;
            color: #856404;
            border-radius: 4px;
            font-size: 12px;
            display: none;
          "
        >
          è«‹å…ˆé¸æ“‡å°ˆæ¡ˆæ‰èƒ½é€²è¡Œæª¢æŸ¥
        </div>
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div id="statsContainer" class="stats-container">
        <div class="stats-item">
          <div class="stats-number" id="vehicleCount">0</div>
          <div class="stats-label">å·²æª¢æŸ¥è»Šè¼›æ•¸</div>
        </div>

        <!-- åˆ†çµ„çµ±è¨ˆè©³ç´°è³‡è¨Š -->
        <div
          id="groupedStats"
          style="
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
          "
        ></div>
      </div>
      <!-- æª¢æŸ¥è¡¨å–® -->
      <div id="inspectionForm">
        <!-- ç§»é™¤é‡è¤‡çš„å°ˆæ¡ˆåç¨±é¸æ“‡ï¼Œä½¿ç”¨é ‚éƒ¨çš„å°ˆæ¡ˆé¸æ“‡ -->

        <div class="form-group position-relative">
          <label for="plateNumber" class="required">è»Šè™Ÿ</label>
          <div style="display: flex; gap: 4px; align-items: stretch">
            <div style="flex: 1; position: relative; min-width: 0">
              <input
                type="text"
                id="plateNumber"
                placeholder="è«‹è¼¸å…¥è»Šè™Ÿ"
                autocomplete="off"
                style="width: 100%; box-sizing: border-box"
              />
              <div id="plateSuggestions" class="plate-suggestions hidden"></div>
              <div
                id="plateErrorMessage"
                style="
                  display: none;
                  color: #dc3545;
                  font-size: 12px;
                  margin-top: 5px;
                "
              ></div>
            </div>
            <button
              type="button"
              id="queryBtn"
              onclick="queryPlateRecords()"
              style="
                padding: 8px 10px;
                background-color: #17a2b8;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 11px;
                font-weight: 500;
                transition: all 0.3s;
                white-space: nowrap;
                width: 65px;
                flex-shrink: 0;
              "
              onmouseover="this.style.backgroundColor='#138496'"
              onmouseout="this.style.backgroundColor='#17a2b8'"
            >
              ğŸ” æŸ¥è©¢
            </button>
          </div>
        </div>
        <div class="form-group">
          <label class="required">æª¢æŸ¥é …ç›®</label>
          <input
            type="text"
            id="deviceSearch"
            placeholder="ğŸ” æœå°‹æª¢æŸ¥é …ç›®..."
            style="
              width: 100%;
              padding: 8px 12px;
              border: 1px solid #ddd;
              border-radius: 6px;
              font-size: 14px;
              margin-bottom: 10px;
              box-sizing: border-box;
            "
            oninput="filterDeviceOptions(this.value)"
          />
          <div id="deviceOptions" class="option-grid">
            <!-- æª¢æŸ¥é …ç›®é¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <div class="form-group">
          <label class="required">æª¢æŸ¥çµæœ</label>
          <div id="resultOptions" class="option-grid">
            <!-- æª¢æŸ¥çµæœé¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <div class="form-group">
          <label for="otherResult">å…¶å®ƒæª¢æŸ¥çµæœ</label>
          <textarea
            id="otherResult"
            rows="3"
            placeholder="å¦‚é¸æ“‡ã€Œå…¶å®ƒã€ï¼Œè«‹è©³ç´°èªªæ˜æª¢æŸ¥çµæœ"
          ></textarea>
        </div>

        <div class="form-group">
          <button id="submitBtn" onclick="submitInspection()">
            <i class="fas fa-save"></i> æäº¤æª¢æŸ¥è¨˜éŒ„
          </button>
        </div>
      </div>

      <!-- æŸ¥è©¢çµæœå€åŸŸ -->
      <div
        id="queryResultsContainer"
        style="display: none; margin-bottom: 20px"
      >
        <div
          style="
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            background: #f0f9ff;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <h4 style="color: #17a2b8; margin: 0" id="queryResultTitle">
              æŸ¥è©¢çµæœ
            </h4>
            <button
              onclick="clearQueryResults()"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
              "
            >
              é—œç•¢æŸ¥è©¢çµæœ
            </button>
          </div>
          <div id="queryResults"></div>
        </div>
      </div>

      <!-- æª¢æŸ¥è¨˜éŒ„åˆ—è¡¨ -->
      <div class="inspection-list">
        <div id="inspectionList">
          <!-- æª¢æŸ¥è¨˜éŒ„å°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
        </div>
      </div>

      <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
      // å…¨åŸŸè®Šæ•¸
      const base_url = (() => {
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°é–‹ç™¼ç’°å¢ƒ
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return window.location.origin + "/"
        }
        // ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨æŒ‡å®šçš„å¾Œç«¯åœ°å€
        return "https://35.221.146.143.nip.io/linehook/"
      })() // ä½¿ç”¨å‹•æ…‹åµæ¸¬æŒ‡å‘æ‡‰ç”¨ç¨‹å¼æ ¹ç›®éŒ„
      let currentUserId = ""
      let allVehicles = [] // å„²å­˜æ‰€æœ‰è»Šè¼›æ•¸æ“š
      let allInspectionRecords = [] // å„²å­˜æ‰€æœ‰æª¢æŸ¥è¨˜éŒ„
      let selectedDevices = []
      let selectedResults = []
      let currentEditId = null
      let availableProjects = [] // å¯ç”¨çš„å°ˆæ¡ˆåˆ—è¡¨
      let currentProjectName = "" // ç•¶å‰é¸æ“‡çš„å°ˆæ¡ˆ

      // æª¢æŸ¥é …ç›®é¸é …é…ç½® - å°‡æ ¹æ“šé¸æ“‡çš„å°ˆæ¡ˆå‹•æ…‹è¼‰å…¥
      let deviceOptions = []

      // æª¢æŸ¥çµæœé¸é …é…ç½® - å°‡æ ¹æ“šé¸æ“‡çš„å°ˆæ¡ˆå‹•æ…‹è¼‰å…¥
      let resultOptions = []

      // LIFF åˆå§‹åŒ–å‡½æ•¸
      async function initializeLIFF() {
        try {
          // å…ˆå˜—è©¦å¾ URL ç²å–åƒæ•¸
          const urlParams = new URLSearchParams(window.location.search)
          const urlUserId = urlParams.get("userId")
          const isDesktop = urlParams.get("desktop") === "true"

          // å¦‚æœæœ‰ desktop=true åƒæ•¸ï¼Œä½¿ç”¨æ¸¬è©¦ UserID
          if (isDesktop && urlUserId) {
            console.log("æ¡Œé¢ç‰ˆæ¨¡å¼ï¼Œä½¿ç”¨ URL åƒæ•¸çš„ userId:", urlUserId)
            currentUserId = urlUserId
            showStatusMessage("æ¡Œé¢ç‰ˆæ¸¬è©¦æ¨¡å¼", "info")
            return true
          }

          // å¦‚æœæœ‰ desktop=true ä½†æ²’æœ‰ userIdï¼Œä½¿ç”¨é è¨­æ¸¬è©¦ ID
          if (isDesktop) {
            console.log("æ¡Œé¢ç‰ˆæ¨¡å¼ï¼Œä½¿ç”¨é è¨­æ¸¬è©¦ userId")
            currentUserId = "test-user-001"
            showStatusMessage("æ¡Œé¢ç‰ˆæ¸¬è©¦æ¨¡å¼", "info")
            return true
          }

          // éæ¡Œé¢ç‰ˆå¿…é ˆä½¿ç”¨ LIFF
          if (typeof liff !== "undefined") {
            console.log("æ­£åœ¨åˆå§‹åŒ– LIFF...")

            // é€™è£¡éœ€è¦æ‚¨çš„ LIFF IDï¼Œè«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID
            const LIFF_ID = "your-liff-id-here" // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID

            await liff.init({ liffId: LIFF_ID })
            console.log("LIFF åˆå§‹åŒ–æˆåŠŸ")

            if (liff.isLoggedIn()) {
              // ç²å–ç”¨æˆ¶è³‡è¨Š
              const profile = await liff.getProfile()
              currentUserId = profile.userId
              console.log("LIFF ç”¨æˆ¶è³‡è¨Š:", {
                userId: profile.userId,
                displayName: profile.displayName,
                pictureUrl: profile.pictureUrl,
              })
              showStatusMessage(`æ­¡è¿ ${profile.displayName}`, "success")
              return true
            } else {
              // ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢
              console.log("ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ LIFF ç™»å…¥")
              liff.login()
              return false
            }
          } else {
            // ä¸åœ¨ LIFF ç’°å¢ƒä¸­ä¸”éæ¡Œé¢ç‰ˆ
            console.error("éæ¡Œé¢ç‰ˆå¿…é ˆåœ¨ LINE ç’°å¢ƒä¸­ä½¿ç”¨")
            showNotBoundUserMessage()
            return false
          }
        } catch (error) {
          console.error("LIFF åˆå§‹åŒ–å¤±æ•—:", error)
          showNotBoundUserMessage()
          return false
        }
      }

      // é¡¯ç¤ºå°šæœªç¶å®šä½¿ç”¨è€…è¨Šæ¯
      function showNotBoundUserMessage() {
        // éš±è—æ‰€æœ‰åŠŸèƒ½å€åŸŸ
        const mainContent = document.querySelector(".container")
        if (mainContent) {
          mainContent.style.display = "none"
        }

        // é¡¯ç¤ºå°šæœªç¶å®šä½¿ç”¨è€…è¨Šæ¯
        document.body.insertAdjacentHTML(
          "beforeend",
          `
          <div style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            z-index: 9999;
          ">
            <i class="fas fa-user-times" style="font-size: 48px; color: #ff6b6b; margin-bottom: 20px;"></i>
            <h3 style="color: #333; margin-bottom: 15px;">å°šæœªç¶å®šä½¿ç”¨è€…</h3>
            <p style="color: #666; line-height: 1.6;">
              æ‚¨å°šæœªç¶å®šä½¿ç”¨è€…ï¼Œç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚<br>
              è«‹å…ˆå®Œæˆä½¿ç”¨è€…ç¶å®šç¨‹åºã€‚
            </p>
          </div>
        `
        )
      }

      // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å­˜åœ¨æ–¼ç³»çµ±ä¸­
      async function checkUserExists(userId) {
        try {
          const response = await fetch(
            `${base_url}api/User/exists/${encodeURIComponent(userId)}`
          )
          if (response.ok) {
            const data = await response.json()
            return data.exists
          }
          return false
        } catch (error) {
          console.error("æª¢æŸ¥ç”¨æˆ¶å­˜åœ¨å¤±æ•—:", error)
          return false
        }
      } // é é¢åˆå§‹åŒ–
      async function initializePage() {
        showLoading()

        try {
          // åˆå§‹åŒ– LIFF
          const liffInitialized = await initializeLIFF()

          // å¦‚æœ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œåœæ­¢å¾ŒçºŒè™•ç†
          if (!liffInitialized) {
            return
          }

          console.log("ç•¶å‰ç”¨æˆ¶ID:", currentUserId)

          // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å­˜åœ¨æ–¼ç³»çµ±ä¸­ï¼ˆéæ¡Œé¢æ¸¬è©¦æ¨¡å¼ï¼‰
          const urlParams = new URLSearchParams(window.location.search)
          const isDesktop = urlParams.get("desktop") === "true"

          if (!isDesktop && currentUserId) {
            const userExists = await checkUserExists(currentUserId)
            if (!userExists) {
              console.log("ç”¨æˆ¶ä¸å­˜åœ¨æ–¼ç³»çµ±ä¸­")
              showNotBoundUserMessage()
              return
            }
          }

          // åˆå§‹åŒ–é é¢å…ƒç´ 
          generateDeviceOptions()
          generateResultOptions()

          // è¼‰å…¥è»Šè¼›æ•¸æ“š
          await loadVehicleData()

          // è¼‰å…¥çµ±è¨ˆè³‡æ–™
          await loadSummaryData()

          // è¼‰å…¥æª¢æŸ¥è¨˜éŒ„
          await loadInspectionRecords()

          // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
          await loadProjectList()

          // æª¢æŸ¥å°ˆæ¡ˆç®¡ç†æ¬Šé™
          await checkProjectManagementPermission()

          // è¨­ç½®è»Šè™Ÿè¼¸å…¥äº‹ä»¶
          setupPlateNumberInput()

          // è¨­ç½®å°ˆæ¡ˆé¸æ“‡äº‹ä»¶
          setupProjectSelection()

          console.log("é é¢åˆå§‹åŒ–å®Œæˆ")
        } catch (error) {
          console.error("é é¢åˆå§‹åŒ–å¤±æ•—:", error)
          showStatusMessage("è¼‰å…¥é é¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†", "error")
        } finally {
          hideLoading()
        }
      } // ç”Ÿæˆæª¢æŸ¥é …ç›®é¸é …
      function generateDeviceOptions() {
        const container = document.getElementById("deviceOptions")
        container.innerHTML = ""

        // æ¸…é™¤æœå°‹æ¡†
        const searchInput = document.getElementById("deviceSearch")
        if (searchInput) {
          searchInput.value = ""
        }

        if (deviceOptions.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ</div>'
          return
        }

        deviceOptions.forEach((device) => {
          if (device.enabled) {
            const option = document.createElement("div")
            option.className = "option-item"
            option.dataset.value = device.id
            option.style.position = "relative"

            // æª¢æŸ¥æ˜¯å¦æœ‰åƒè€ƒåœ–ç‰‡
            let hasImages = false
            let imageCount = 0
            console.log(
              `æª¢æŸ¥é …ç›® "${device.name}" çš„ referenceImages æ¬„ä½:`,
              device.referenceImages
            )
            if (device.referenceImages) {
              try {
                const images = JSON.parse(device.referenceImages)
                hasImages = images && images.length > 0
                imageCount = images.length
                console.log(
                  `æª¢æŸ¥é …ç›® "${device.name}" æœ‰ ${imageCount} å¼µåƒè€ƒåœ–ç‰‡:`,
                  images
                )
              } catch (e) {
                console.error(
                  `è§£ææª¢æŸ¥é …ç›® "${device.name}" çš„åƒè€ƒåœ–ç‰‡å¤±æ•—:`,
                  e
                )
                console.error(`åŸå§‹è³‡æ–™:`, device.referenceImages)
                hasImages = false
              }
            } else {
              console.log(`æª¢æŸ¥é …ç›® "${device.name}" æ²’æœ‰åƒè€ƒåœ–ç‰‡`)
            }

            option.innerHTML = `
              <span class="option-text">${device.name}</span>
              ${
                hasImages
                  ? `
                <button class="image-view-btn view-reference-images-btn" data-item-name="${device.name}" data-images='${device.referenceImages}' title="æŸ¥çœ‹åƒè€ƒåœ–ç‰‡ (${imageCount}å¼µ)">
                  <i class="fas fa-images"></i>
                  <span class="image-count">${imageCount}</span>
                </button>
              `
                  : ""
              }
            `

            option.onclick = (event) => {
              // å¦‚æœé»æ“Šçš„æ˜¯åœ–ç‰‡æŒ‰éµï¼Œä¸è¦è§¸ç™¼é¸æ“‡
              if (event.target.closest(".view-reference-images-btn")) {
                return
              }
              toggleSelection(option, "device")
            }
            container.appendChild(option)
          }
        })
      }

      // ç”Ÿæˆæª¢æŸ¥çµæœé¸é …
      function generateResultOptions() {
        const container = document.getElementById("resultOptions")
        container.innerHTML = ""

        if (resultOptions.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ</div>'
          return
        }

        resultOptions.forEach((result) => {
          if (result.enabled) {
            const option = document.createElement("div")
            option.className = "option-item"
            option.dataset.value = result.id
            option.style.position = "relative"

            // æª¢æŸ¥æ˜¯å¦æœ‰åƒè€ƒåœ–ç‰‡
            let hasImages = false
            let imageCount = 0
            console.log(
              `æª¢æŸ¥çµæœ "${result.name}" çš„ referenceImages æ¬„ä½:`,
              result.referenceImages
            )
            if (result.referenceImages) {
              try {
                const images = JSON.parse(result.referenceImages)
                hasImages = images && images.length > 0
                imageCount = images.length
                console.log(
                  `æª¢æŸ¥çµæœ "${result.name}" æœ‰ ${imageCount} å¼µåƒè€ƒåœ–ç‰‡:`,
                  images
                )
              } catch (e) {
                console.error(
                  `è§£ææª¢æŸ¥çµæœ "${result.name}" çš„åƒè€ƒåœ–ç‰‡å¤±æ•—:`,
                  e
                )
                console.error(`åŸå§‹è³‡æ–™:`, result.referenceImages)
                hasImages = false
              }
            } else {
              console.log(`æª¢æŸ¥çµæœ "${result.name}" æ²’æœ‰åƒè€ƒåœ–ç‰‡`)
            }

            option.innerHTML = `
              <span class="option-text">${result.name}</span>
              ${
                hasImages
                  ? `
                <button class="image-view-btn view-reference-images-btn" data-item-name="${result.name}" data-images='${result.referenceImages}' title="æŸ¥çœ‹åƒè€ƒåœ–ç‰‡ (${imageCount}å¼µ)">
                  <i class="fas fa-images"></i>
                  <span class="image-count">${imageCount}</span>
                </button>
              `
                  : ""
              }
            `

            option.onclick = (event) => {
              // å¦‚æœé»æ“Šçš„æ˜¯åœ–ç‰‡æŒ‰éµï¼Œä¸è¦è§¸ç™¼é¸æ“‡
              if (event.target.closest(".view-reference-images-btn")) {
                return
              }
              toggleSelection(option, "result")
            }
            container.appendChild(option)
          }
        })
      }

      // åˆ‡æ›é¸é …é¸æ“‡ç‹€æ…‹
      function toggleSelection(element, type) {
        if (type === "device") {
          // æª¢æŸ¥é …ç›®æ”¹ç‚ºå–®é¸ - å…ˆæ¸…é™¤æ‰€æœ‰é¸æ“‡
          document
            .querySelectorAll("#deviceOptions .option-item")
            .forEach((item) => {
              item.classList.remove("selected")
            })
          selectedDevices = []

          // é¸æ“‡ç•¶å‰é …ç›®
          element.classList.add("selected")
          selectedDevices.push(element.dataset.value)
        } else if (type === "result") {
          element.classList.toggle("selected")

          if (element.classList.contains("selected")) {
            selectedResults.push(element.dataset.value)
          } else {
            selectedResults = selectedResults.filter(
              (r) => r !== element.dataset.value
            )
          }

          // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†ã€Œå…¶å®ƒã€é¸é …
          const otherTextarea = document.getElementById("otherResult")
          const hasOtherSelected = selectedResults.includes("å…¶å®ƒ")
          otherTextarea.required = hasOtherSelected
          otherTextarea.style.borderColor = hasOtherSelected
            ? "#06c755"
            : "#ddd"
        }
      }

      // æª¢æŸ¥é …ç›®æœå°‹åŠŸèƒ½
      function filterDeviceOptions(searchText) {
        const container = document.getElementById("deviceOptions")
        const options = container.querySelectorAll(".option-item")

        if (!searchText.trim()) {
          // å¦‚æœæœå°‹æ–‡å­—ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰é¸é …
          options.forEach((option) => {
            option.style.display = "flex"
          })
          return
        }

        const searchLower = searchText.toLowerCase()
        let visibleCount = 0

        options.forEach((option) => {
          const optionText = option.querySelector(".option-text")
          if (optionText) {
            const text = optionText.textContent.toLowerCase()
            if (text.includes(searchLower)) {
              option.style.display = "flex"
              visibleCount++
            } else {
              option.style.display = "none"
            }
          }
        })

        // å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•é …ç›®ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
        let noResultsDiv = container.querySelector(".no-results")
        if (visibleCount === 0) {
          if (!noResultsDiv) {
            noResultsDiv = document.createElement("div")
            noResultsDiv.className = "no-results"
            noResultsDiv.style.cssText =
              "grid-column: 1/-1; text-align: center; padding: 20px; color: #999; font-style: italic;"
            noResultsDiv.textContent = `æ‰¾ä¸åˆ°åŒ…å«ã€Œ${searchText}ã€çš„æª¢æŸ¥é …ç›®`
            container.appendChild(noResultsDiv)
          }
        } else {
          if (noResultsDiv) {
            noResultsDiv.remove()
          }
        }
      }

      // è¼‰å…¥è»Šè¼›æ•¸æ“šï¼ˆç”¨æ–¼è‡ªå‹•åŒ¹é…ï¼‰
      async function loadVehicleData() {
        try {
          const response = await fetch(`${base_url}api/BusVehicle`)
          if (response.ok) {
            const data = await response.json()
            if (data.success && data.data) {
              allVehicles = data.data
              console.log("è¼‰å…¥è»Šè¼›æ•¸æ“šæˆåŠŸ:", allVehicles.length, "è¼›è»Š")
            } else {
              console.error("APIå›æ‡‰æ ¼å¼éŒ¯èª¤:", data)
            }
          } else {
            console.error("APIè«‹æ±‚å¤±æ•—:", response.status, response.statusText)
          }
        } catch (error) {
          console.error("è¼‰å…¥è»Šè¼›æ•¸æ“šå¤±æ•—:", error)
        }
      }

      // è¨­ç½®è»Šè™Ÿè¼¸å…¥è‡ªå‹•åŒ¹é…
      function setupPlateNumberInput() {
        const plateInput = document.getElementById("plateNumber")
        const suggestionsDiv = document.getElementById("plateSuggestions")

        plateInput.addEventListener("input", function () {
          const value = this.value.trim()
          console.log("è¼¸å…¥è»Šè™Ÿ:", value, "è»Šè¼›ç¸½æ•¸:", allVehicles.length)

          // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
          document.getElementById("plateErrorMessage").style.display = "none"

          if (value.length < 1) {
            suggestionsDiv.classList.add("hidden")
            return
          }

          // å°‹æ‰¾åŒ¹é…çš„è»Šè¼›
          const matches = allVehicles
            .filter((vehicle) => {
              if (!vehicle.plateNumber) {
                console.warn("ç™¼ç¾æ²’æœ‰è»Šè™Ÿçš„è»Šè¼›:", vehicle)
                return false
              }
              return vehicle.plateNumber
                .toLowerCase()
                .includes(value.toLowerCase())
            })
            .slice(0, 5) // é™åˆ¶é¡¯ç¤º5å€‹çµæœ

          console.log("æ‰¾åˆ°åŒ¹é…çš„è»Šè¼›:", matches.length, "è¼›")

          if (matches.length > 0) {
            suggestionsDiv.innerHTML = matches
              .map(
                (vehicle) =>
                  `<div class="suggestion-item" onclick="selectPlate('${
                    vehicle.plateNumber
                  }')">
                            ${vehicle.plateNumber} ${
                    vehicle.operatorName ? `(${vehicle.operatorName})` : ""
                  }
                        </div>`
              )
              .join("")
            suggestionsDiv.classList.remove("hidden")
          } else {
            suggestionsDiv.classList.add("hidden")
          }
        })

        // é»æ“Šå…¶ä»–åœ°æ–¹æ™‚éš±è—å»ºè­°åˆ—è¡¨
        document.addEventListener("click", function (e) {
          if (
            !plateInput.contains(e.target) &&
            !suggestionsDiv.contains(e.target)
          ) {
            suggestionsDiv.classList.add("hidden")
          }
        })
      }

      // é¸æ“‡è»Šè™Ÿ
      function selectPlate(plateNumber) {
        document.getElementById("plateNumber").value = plateNumber
        document.getElementById("plateSuggestions").classList.add("hidden")
      }

      // è¼‰å…¥çµ±è¨ˆè³‡æ–™
      async function loadSummaryData() {
        try {
          let url = `${base_url}api/TicketMachineInspection/summary`
          console.log("æ­£åœ¨è¼‰å…¥çµ±è¨ˆè³‡æ–™:", url)

          const response = await fetch(url)
          console.log("çµ±è¨ˆè³‡æ–™APIç‹€æ…‹:", response.status)

          if (response.ok) {
            const data = await response.json()
            console.log("çµ±è¨ˆè³‡æ–™å›æ‡‰:", data)
            if (data.success) {
              document.getElementById("vehicleCount").textContent =
                data.data.inspectedVehicleCount

              // è¼‰å…¥åˆ†çµ„è©³ç´°çµ±è¨ˆ - å›ºå®šé¡¯ç¤ºå°ˆæ¡ˆã€å…¬å¸ã€éƒ¨é–€çµ±è¨ˆ
              await loadGroupedStats()
            } else {
              console.error("çµ±è¨ˆè³‡æ–™APIè¿”å›éŒ¯èª¤:", data.message)
            }
          } else {
            const errorText = await response.text()
            console.error("çµ±è¨ˆè³‡æ–™APIè«‹æ±‚å¤±æ•—:", response.status, errorText)
          }
        } catch (error) {
          console.error("è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:", error)
        }
      }

      // è¼‰å…¥åˆ†çµ„çµ±è¨ˆè©³ç´°è³‡è¨Š
      async function loadGroupedStats() {
        try {
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success && data.data) {
              displayGroupedStats(data.data)
            }
          }
        } catch (error) {
          console.error("è¼‰å…¥åˆ†çµ„çµ±è¨ˆå¤±æ•—:", error)
        }
      }

      // é¡¯ç¤ºåˆ†çµ„çµ±è¨ˆ - ç°¡åŒ–é¡¯ç¤ºæ ¼å¼
      function displayGroupedStats(records) {
        const container = document.getElementById("groupedStats")

        if (!records || records.length === 0) {
          container.innerHTML = ""
          return
        }

        // çµ±è¨ˆè»Šè¼›æ•¸
        const vehicleCount = new Set(records.map((item) => item.plateNumber))
          .size

        // ç²å–ä¸»è¦å°ˆæ¡ˆåç¨±å’Œå…¬å¸åç¨±ï¼ˆå–ç¬¬ä¸€å€‹è¨˜éŒ„ä½œç‚ºä»£è¡¨ï¼‰
        const projectName = records[0]?.projectName || "æœªæŒ‡å®šå°ˆæ¡ˆ"
        const companyName = records[0]?.company || "æœªæŒ‡å®šå…¬å¸"

        container.innerHTML = `
          <div style="font-size: 14px; color: #555; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
            <strong>${projectName}</strong>ã€<strong>${companyName}</strong>ï¼Œå·²æª¢æŸ¥<strong>${vehicleCount}</strong>è¼›è»Š
          </div>
        `
      }

      // è¼‰å…¥æª¢æŸ¥è¨˜éŒ„
      async function loadInspectionRecords() {
        try {
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              allInspectionRecords = data.data // ä¿å­˜åˆ°å…¨åŸŸè®Šæ•¸
              displayInspectionRecords(data.data)
            }
          }
        } catch (error) {
          console.error("è¼‰å…¥æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
        }
      }

      // é¡¯ç¤ºæª¢æŸ¥è¨˜éŒ„ - ä»¥è»Šè™Ÿåˆ—è¡¨é¡¯ç¤º
      function displayInspectionRecords(records) {
        const container = document.getElementById("inspectionList")

        if (!records || records.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #666;">å°šç„¡æª¢æŸ¥è¨˜éŒ„</p>'
          return
        }

        // æŒ‰è»Šè™Ÿåˆ†çµ„è¨˜éŒ„ä¸¦ç²å–å”¯ä¸€è»Šè™Ÿåˆ—è¡¨
        const groupedRecords = records.reduce((groups, record) => {
          const plate = record.plateNumber
          if (!groups[plate]) {
            groups[plate] = []
          }
          groups[plate].push(record)
          return groups
        }, {})

        // é¡¯ç¤ºè»Šè™Ÿåˆ—è¡¨
        container.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h3 style="color: #06c755; margin: 0;">æª¢æŸ¥è¨˜éŒ„</h3>
              <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-size: 14px; color: #555;">æ’åºæ–¹å¼:</label>
                <select id="sortOption" onchange="applySorting()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd;">
                  <option value="time">ä¾æ™‚é–“æ’åº</option>
                  <option value="plate">ä¾è»Šè™Ÿæ’åº</option>
                </select>
              </div>
            </div>
            <div id="vehicleListContainer" style="
              max-height: 400px;
              overflow-y: auto;
              border: 1px solid #ddd;
              border-radius: 8px;
              padding: 10px;
              background: #fafafa;
            ">
              <div id="vehicleGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                ${Object.keys(groupedRecords)
                  .map((plateNumber) => {
                    const vehicleRecords = groupedRecords[plateNumber]
                    return `
                      <div class="vehicle-card" onclick="loadVehicleDetails('${plateNumber}')" style="
                        padding: 15px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        cursor: pointer;
                        background: #f9f9f9;
                        transition: all 0.3s;
                        text-align: center;
                      " onmouseover="this.style.borderColor='#06c755'; this.style.background='#f0fff4'" 
                         onmouseout="this.style.borderColor='#ddd'; this.style.background='#f9f9f9'">
                        <div style="font-weight: bold; font-size: 16px; color: #06c755; margin-bottom: 5px;">
                          ${plateNumber}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                          ${vehicleRecords.length} é …æª¢æŸ¥
                        </div>
                      </div>
                    `
                  })
                  .join("")}
              </div>
            </div>
          </div>
          <div id="vehicleDetailContainer" style="margin-top: 20px;"></div>
        `
      }

      // æ‡‰ç”¨æ’åº
      function applySorting() {
        if (!allInspectionRecords || allInspectionRecords.length === 0) {
          return
        }

        const sortOption = document.getElementById("sortOption").value
        const groupedRecords = allInspectionRecords.reduce((groups, record) => {
          const plate = record.plateNumber
          if (!groups[plate]) {
            groups[plate] = []
          }
          groups[plate].push(record)
          return groups
        }, {})

        let sortedPlateNumbers = Object.keys(groupedRecords)

        if (sortOption === "plate") {
          // ä¾è»Šè™Ÿæ’åº
          sortedPlateNumbers.sort((a, b) => a.localeCompare(b))
        } else {
          // ä¾æ™‚é–“æ’åºï¼ˆé è¨­ï¼‰- ä¾æœ€æ–°æª¢æŸ¥æ™‚é–“
          sortedPlateNumbers.sort((a, b) => {
            const timeA = new Date(groupedRecords[a][0].checkAt)
            const timeB = new Date(groupedRecords[b][0].checkAt)
            return timeB - timeA // æœ€æ–°çš„åœ¨å‰é¢
          })
        }

        // é‡æ–°ç”Ÿæˆè»Šè¼›å¡ç‰‡
        const vehicleGrid = document.getElementById("vehicleGrid")
        if (vehicleGrid) {
          vehicleGrid.innerHTML = sortedPlateNumbers
            .map((plateNumber) => {
              const vehicleRecords = groupedRecords[plateNumber]
              return `
                <div class="vehicle-card" onclick="loadVehicleDetails('${plateNumber}')" style="
                  padding: 15px;
                  border: 2px solid #ddd;
                  border-radius: 8px;
                  cursor: pointer;
                  background: #f9f9f9;
                  transition: all 0.3s;
                  text-align: center;
                " onmouseover="this.style.borderColor='#06c755'; this.style.background='#f0fff4'" 
                   onmouseout="this.style.borderColor='#ddd'; this.style.background='#f9f9f9'">
                  <div style="font-weight: bold; font-size: 16px; color: #06c755; margin-bottom: 5px;">
                    ${plateNumber}
                  </div>
                  <div style="font-size: 12px; color: #666;">
                    ${vehicleRecords.length} é …æª¢æŸ¥
                  </div>
                </div>
              `
            })
            .join("")
        }
      }

      // æŸ¥è©¢è»Šè™Ÿæª¢æŸ¥è¨˜éŒ„
      async function queryPlateRecords() {
        const plateNumber = document.getElementById("plateNumber").value.trim()
        const projectName = currentProjectName // ä½¿ç”¨é ‚éƒ¨é¸æ“‡çš„å°ˆæ¡ˆåç¨±

        // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤è¨Šæ¯
        document.getElementById("plateErrorMessage").style.display = "none"

        if (!projectName) {
          showStatusMessage("è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ", "error")
          return
        }

        if (!plateNumber) {
          showStatusMessage("è«‹è¼¸å…¥è»Šè™Ÿ", "error")
          return
        }

        try {
          showLoading()

          // ç²å–æ‰€æœ‰æª¢æŸ¥è¨˜éŒ„
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              // éæ¿¾å‡ºè©²è»Šè™Ÿä¸”å°ˆæ¡ˆç›¸åŒçš„è¨˜éŒ„
              const vehicleRecords = data.data.filter(
                (record) =>
                  record.plateNumber.toLowerCase() ===
                    plateNumber.toLowerCase() &&
                  record.projectName === projectName
              )

              if (vehicleRecords.length === 0) {
                // åœ¨è»Šè™Ÿè¼¸å…¥æ¡†ä¸‹æ–¹é¡¯ç¤ºç´…å­—éŒ¯èª¤è¨Šæ¯
                const errorMsg = document.getElementById("plateErrorMessage")
                errorMsg.textContent = `æŸ¥ç„¡ã€Œ${plateNumber}ã€åœ¨å°ˆæ¡ˆã€Œ${projectName}ã€çš„æª¢æŸ¥è¨˜éŒ„`
                errorMsg.style.display = "block"
                showStatusMessage(`è»Šè™Ÿã€Œ${plateNumber}ã€æŸ¥ç„¡è¨˜éŒ„`, "info")
              } else {
                displayQueryResults(plateNumber, vehicleRecords)
              }
            }
          }
        } catch (error) {
          console.error("æŸ¥è©¢æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
          showStatusMessage("æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥", "error")
        } finally {
          hideLoading()
        }
      }

      // é¡¯ç¤ºæŸ¥è©¢çµæœ
      function displayQueryResults(plateNumber, records) {
        const container = document.getElementById("queryResultsContainer")
        const resultsDiv = document.getElementById("queryResults")
        const titleDiv = document.getElementById("queryResultTitle")

        // é¡¯ç¤ºæŸ¥è©¢çµæœå®¹å™¨
        container.style.display = "block"

        // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
        const sortedRecords = records.sort((a, b) => {
          return new Date(b.checkAt) - new Date(a.checkAt)
        })

        titleDiv.textContent = `è»Šè™Ÿã€Œ${plateNumber}ã€æŸ¥è©¢çµæœ (${records.length}é …æª¢æŸ¥)`

        const recordsHtml = sortedRecords
          .map(
            (record) => `
            <div style="margin-bottom: 10px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; background: white;">
              <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <div>
                  <span class="device-badge" style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 15px; font-size: 12px; margin-right: 8px;">
                    ${getDeviceName(record.CheckItem || record.checkItem)}
                  </span>
                  <span class="result-badge ${getResultClass(
                    record.result
                  )}" style="padding: 4px 8px; border-radius: 15px; font-size: 12px;">
                    ${getResultName(record.result)}
                  </span>
                </div>
              </div>
              <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">
                æª¢æŸ¥æ™‚é–“: ${record.checkAt}
              </div>
              ${
                record.other
                  ? `<div style="background: #fff3cd; color: #856404; padding: 6px 10px; border-radius: 4px; font-size: 12px; border-left: 4px solid #ffc107;">å‚™è¨»: ${record.other}</div>`
                  : ""
              }
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button onclick="editSingleInspection('${record.id}')" style="
                  flex: 1;
                  padding: 6px 10px;
                  background: #ffc107;
                  color: #212529;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 12px;
                  font-weight: 500;
                ">ğŸ“ ç·¨è¼¯</button>
                <button onclick="deleteSingleInspection('${record.id}')" style="
                  flex: 1;
                  padding: 6px 10px;
                  background: #dc3545;
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 12px;
                  font-weight: 500;
                ">ğŸ—‘ï¸ åˆªé™¤</button>
              </div>
            </div>
          `
          )
          .join("")

        resultsDiv.innerHTML = `
          <div style="max-height: 300px; overflow-y: auto;">
            ${recordsHtml}
          </div>
        `

        showStatusMessage(`æ‰¾åˆ° ${records.length} é …æª¢æŸ¥è¨˜éŒ„`, "success")
      }

      // æ¸…é™¤æŸ¥è©¢çµæœ
      function clearQueryResults() {
        document.getElementById("queryResultsContainer").style.display = "none"
        document.getElementById("plateNumber").value = ""
        document.getElementById("plateErrorMessage").style.display = "none"
        showStatusMessage("å·²æ¸…é™¤æŸ¥è©¢çµæœ", "info")
      }

      // è¼‰å…¥è»Šè¼›è©³ç´°æª¢æŸ¥è³‡æ–™
      async function loadVehicleDetails(plateNumber) {
        try {
          showLoading()

          // ç²å–è©²è»Šè™Ÿçš„æ‰€æœ‰æª¢æŸ¥è¨˜éŒ„
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const vehicleRecords = data.data.filter(
                (record) => record.plateNumber === plateNumber
              )
              displayVehicleDetails(plateNumber, vehicleRecords)
            }
          }
        } catch (error) {
          console.error("è¼‰å…¥è»Šè¼›è©³ç´°è³‡æ–™å¤±æ•—:", error)
          showStatusMessage("è¼‰å…¥è»Šè¼›è©³ç´°è³‡æ–™å¤±æ•—", "error")
        } finally {
          hideLoading()
        }
      }

      // é¡¯ç¤ºè»Šè¼›è©³ç´°æª¢æŸ¥è³‡æ–™
      function displayVehicleDetails(plateNumber, records) {
        const container = document.getElementById("vehicleDetailContainer")

        if (!records || records.length === 0) {
          container.innerHTML = ""
          return
        }

        // é è¨­æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
        const sortedRecords = records.sort((a, b) => {
          return new Date(b.checkAt) - new Date(a.checkAt)
        })

        const detailsHtml = sortedRecords
          .map(
            (record) => `
            <div class="check-detail" style="margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; background: #fafafa;">
              <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <div>
                  <span class="device-badge">${getDeviceName(
                    record.CheckItem || record.checkItem
                  )}</span>
                  <span class="result-badge ${getResultClass(
                    record.result
                  )}">${getResultName(record.result)}</span>
                </div>
              </div>
              <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                 ${record.checkAt}
              </div>
              ${
                record.other
                  ? `<div class="other-note" style="margin-bottom: 8px;">å‚™è¨»: ${record.other}</div>`
                  : ""
              }
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="edit-btn" style="
                  flex: 1;
                  min-width: 60px;
                  padding: 8px 10px;
                  font-size: 12px;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  background: #ffc107;
                  color: #212529;
                  font-weight: 500;
                  transition: all 0.2s;
                " onclick="editSingleInspection('${record.id}')">
                  ğŸ“ ç·¨è¼¯
                </button>
                <button class="delete-btn" style="
                  flex: 1;
                  min-width: 60px;
                  padding: 8px 10px;
                  font-size: 12px;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  background: #dc3545;
                  color: white;
                  font-weight: 500;
                  transition: all 0.2s;
                " onclick="deleteSingleInspection('${record.id}')">
                  ğŸ—‘ï¸ åˆªé™¤
                </button>
              </div>
            </div>
          `
          )
          .join("")

        container.innerHTML = `
          <div style="border: 2px solid #06c755; border-radius: 8px; padding: 15px; background: #f9fff9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4 style="color: #06c755; margin: 0;">è»Šè™Ÿ: ${plateNumber} çš„æª¢æŸ¥è¨˜éŒ„ (${sortedRecords.length}é …)</h4>
              <button onclick="document.getElementById('vehicleDetailContainer').innerHTML=''" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 3px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 10px;
                max-width: 40px;
                min-width: 40px;
              ">é—œé–‰</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #06c755 #f1f1f1;">
              ${detailsHtml}
            </div>
          </div>
        `
      }

      // å–å¾—æª¢æŸ¥é …ç›®åç¨±
      function getDeviceName(deviceId) {
        const device = deviceOptions.find((d) => d.id === deviceId)
        return device ? device.name : deviceId
      }

      // å–å¾—æª¢æŸ¥çµæœæ¨£å¼é¡åˆ¥
      function getResultClass(resultId) {
        if (resultId === "èºçµ²æ­£å¸¸") return "result-normal"
        if (resultId === "ç‰ˆæœ¬å·²æ›´æ–°") return "result-updated"
        if (resultId === "å…¶å®ƒ") return "result-other"
        return "result-issue" // å…¶ä»–å•é¡Œéƒ½ç”¨ç´…è‰²
      }

      // å–å¾—æª¢æŸ¥çµæœåç¨±
      function getResultName(resultId) {
        const result = resultOptions.find((r) => r.id === resultId)
        return result ? result.name : resultId
      }

      // ç·¨è¼¯å–®é …æª¢æŸ¥è¨˜éŒ„
      async function editSingleInspection(inspectionId) {
        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${inspectionId}`
          )

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const inspection = data.data

              // å¡«å…¥è¡¨å–®è³‡æ–™
              // å°ˆæ¡ˆåç¨±ç”±é ‚éƒ¨å°ˆæ¡ˆé¸æ“‡å™¨æ§åˆ¶ï¼Œä¸éœ€è¦è¨­ç½®
              document.getElementById("plateNumber").value =
                inspection.plateNumber
              document.getElementById("otherResult").value =
                inspection.other || ""

              // è¨­å®šç·¨è¼¯æ¨¡å¼
              currentEditId = inspectionId
              document.querySelector(".container").classList.add("editing-mode")

              // é‡ç½®é¸æ“‡
              selectedDevices = []
              selectedResults = []
              document.querySelectorAll(".option-item").forEach((item) => {
                item.classList.remove("selected")
              })

              // é¸ä¸­å°æ‡‰çš„æª¢æŸ¥é …ç›®å’Œçµæœ
              const deviceElement = document.querySelector(
                `[data-value="${inspection.CheckItem || inspection.checkItem}"]`
              )
              if (deviceElement) {
                deviceElement.classList.add("selected")
                selectedDevices.push(
                  inspection.CheckItem || inspection.checkItem
                )
              }

              const resultElement = document.querySelector(
                `#resultOptions [data-value="${inspection.result}"]`
              )
              if (resultElement) {
                resultElement.classList.add("selected")
                selectedResults.push(inspection.result)
              }

              // æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼Œæ·»åŠ å–æ¶ˆæŒ‰éˆ•
              document.getElementById("submitBtn").innerHTML =
                '<i class="fas fa-save"></i> æ›´æ–°æª¢æŸ¥è¨˜éŒ„'

              // æ·»åŠ å–æ¶ˆç·¨è¼¯æŒ‰éˆ•
              let cancelBtn = document.getElementById("cancelEditBtn")
              if (!cancelBtn) {
                cancelBtn = document.createElement("button")
                cancelBtn.id = "cancelEditBtn"
                cancelBtn.className = "secondary-button"
                cancelBtn.style.marginTop = "10px"
                cancelBtn.innerHTML = '<i class="fas fa-times"></i> å–æ¶ˆç·¨è¼¯'
                cancelBtn.onclick = cancelEdit
                document
                  .getElementById("submitBtn")
                  .parentNode.appendChild(cancelBtn)
              }
              cancelBtn.style.display = "block"

              // æ»¾å‹•åˆ°è¡¨å–®
              document
                .getElementById("inspectionForm")
                .scrollIntoView({ behavior: "smooth" })

              showStatusMessage("å·²è¼‰å…¥æª¢æŸ¥è¨˜éŒ„ï¼Œå¯é€²è¡Œä¿®æ”¹", "info")
            }
          }
        } catch (error) {
          console.error("è¼‰å…¥æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
          showStatusMessage("è¼‰å…¥æª¢æŸ¥è¨˜éŒ„å¤±æ•—", "error")
        } finally {
          hideLoading()
        }
      }

      // åˆªé™¤å–®é …æª¢æŸ¥è¨˜éŒ„
      async function deleteSingleInspection(inspectionId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™é …æª¢æŸ¥è¨˜éŒ„å—ï¼Ÿ")) {
          return
        }

        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${inspectionId}`,
            {
              method: "DELETE",
            }
          )

          if (response.ok) {
            showStatusMessage("æª¢æŸ¥è¨˜éŒ„åˆªé™¤æˆåŠŸ", "success")

            // é‡æ–°è¼‰å…¥æ•¸æ“š
            await loadSummaryData()
            await loadInspectionRecords()

            // æ¸…ç©ºè©³ç´°é¡¯ç¤º
            document.getElementById("vehicleDetailContainer").innerHTML = ""
          } else {
            showStatusMessage("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error")
          }
        } catch (error) {
          console.error("åˆªé™¤æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
          showStatusMessage("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥", "error")
        } finally {
          hideLoading()
        }
      }

      // ç·¨è¼¯æ•´è»Šæª¢æŸ¥è¨˜éŒ„
      async function editVehicleInspections(plateNumber) {
        try {
          // ç‚ºç·¨è¼¯æ¨¡å¼åŠ ä¸Šç‰¹æ®Šæ¨£å¼
          document.querySelector(".container").classList.add("editing-mode")

          // å¡«å…¥è»Šè™Ÿ
          document.getElementById("plateNumber").value = plateNumber

          // æ¸…ç©ºä¹‹å‰çš„é¸æ“‡
          resetSelections()

          // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
          document
            .getElementById("inspectionForm")
            .scrollIntoView({ behavior: "smooth" })

          // æ›´æ–°æäº¤æŒ‰éˆ•æ–‡å­—
          document.getElementById("submitBtn").innerHTML =
            '<i class="fas fa-save"></i> æ–°å¢æª¢æŸ¥é …ç›®'

          showStatusMessage("è«‹é¸æ“‡è¦æ–°å¢çš„æª¢æŸ¥é …ç›®", "info")
        } catch (error) {
          console.error("ç·¨è¼¯æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
          showStatusMessage("è¼‰å…¥ç·¨è¼¯è³‡æ–™å¤±æ•—", "error")
        }
      }

      // åˆªé™¤æ•´è»Šæª¢æŸ¥è¨˜éŒ„
      async function deleteVehicleInspections(plateNumber) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤è»Šè™Ÿ ${plateNumber} çš„æ‰€æœ‰æª¢æŸ¥è¨˜éŒ„å—ï¼Ÿ`)) {
          return
        }

        try {
          showLoading()

          // ç²å–è©²è»Šè¼›çš„æ‰€æœ‰è¨˜éŒ„
          const today = new Date().toISOString().split("T")[0]
          const response = await fetch(
            `${base_url}api/TicketMachineInspection/user/${currentUserId}?date=${today}`
          )

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const vehicleRecords = data.data.filter(
                (record) => record.plateNumber === plateNumber
              )

              // åˆªé™¤æ‰€æœ‰ç›¸é—œè¨˜éŒ„
              const deletePromises = vehicleRecords.map((record) =>
                fetch(`${base_url}api/TicketMachineInspection/${record.id}`, {
                  method: "DELETE",
                })
              )

              const results = await Promise.all(deletePromises)
              const allSuccessful = results.every((result) => result.ok)

              if (allSuccessful) {
                showStatusMessage("æª¢æŸ¥è¨˜éŒ„åˆªé™¤æˆåŠŸ", "success")

                // é‡æ–°è¼‰å…¥æ•¸æ“š
                await loadSummaryData()
                await loadInspectionRecords()
              } else {
                showStatusMessage("éƒ¨åˆ†è¨˜éŒ„åˆªé™¤å¤±æ•—", "error")
              }
            }
          }
        } catch (error) {
          console.error("åˆªé™¤æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
          showStatusMessage("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥", "error")
        } finally {
          hideLoading()
        }
      }

      // é‡ç½®é¸æ“‡ç‹€æ…‹
      function resetSelections() {
        selectedDevices = []
        selectedResults = []
        currentEditId = null

        document.querySelectorAll(".option-item").forEach((item) => {
          item.classList.remove("selected")
        })

        document.getElementById("otherResult").value = ""
        document.querySelector(".container").classList.remove("editing-mode")
        document.getElementById("submitBtn").innerHTML =
          '<i class="fas fa-save"></i>é€å‡º'
      }

      // æäº¤æª¢æŸ¥è¨˜éŒ„
      async function submitInspection() {
        try {
          // é©—è­‰è¡¨å–®
          const projectName = currentProjectName // ä½¿ç”¨é ‚éƒ¨é¸æ“‡çš„å°ˆæ¡ˆåç¨±
          const plateNumber = document
            .getElementById("plateNumber")
            .value.trim()

          if (!projectName) {
            showStatusMessage("è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ", "error")
            return
          }
          const otherResult = document
            .getElementById("otherResult")
            .value.trim()

          if (!projectName) {
            showStatusMessage("è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ", "error")
            return
          }

          if (!plateNumber) {
            showStatusMessage("è«‹è¼¸å…¥è»Šè™Ÿ", "error")
            return
          }

          if (selectedDevices.length === 0) {
            showStatusMessage("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª¢æŸ¥é …ç›®", "error")
            return
          }

          if (selectedResults.length === 0) {
            showStatusMessage("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª¢æŸ¥çµæœ", "error")
            return
          }

          if (selectedResults.includes("å…¶å®ƒ") && !otherResult) {
            showStatusMessage("é¸æ“‡ã€Œå…¶å®ƒã€æ™‚ï¼Œè«‹å¡«å¯«è©³ç´°èªªæ˜", "error")
            return
          }

          showLoading()

          // ç‚ºæ¯å€‹é¸ä¸­çš„æª¢æŸ¥é …ç›®å»ºç«‹è¨˜éŒ„
          const promises = []

          for (const device of selectedDevices) {
            for (const result of selectedResults) {
              const requestData = {
                projectName: projectName,
                userId: currentUserId,
                plateNumber: plateNumber,
                checkItem: device,
                result: result,
                other: selectedResults.includes("å…¶å®ƒ") ? otherResult : null,
                checkAt: new Date()
                  .toLocaleString("zh-TW", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                  })
                  .replace(/\//g, "-"),
              }

              const url = currentEditId
                ? `${base_url}api/TicketMachineInspection/${currentEditId}`
                : `${base_url}api/TicketMachineInspection`

              const method = currentEditId ? "PUT" : "POST"

              promises.push(
                fetch(url, {
                  method: method,
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(requestData),
                })
              )
            }
          }

          const responses = await Promise.all(promises)
          const allSuccessful = responses.every((response) => response.ok)

          if (allSuccessful) {
            showStatusMessage(
              currentEditId ? "æª¢æŸ¥è¨˜éŒ„æ›´æ–°æˆåŠŸ" : "æª¢æŸ¥è¨˜éŒ„æäº¤æˆåŠŸ",
              "success"
            )

            // æ¸…é™¤è»Šè™ŸéŒ¯èª¤è¨Šæ¯
            document.getElementById("plateErrorMessage").style.display = "none"

            // é‡ç½®è¡¨å–®
            resetForm()

            // é‡æ–°è¼‰å…¥æ•¸æ“š
            await loadSummaryData()
            await loadInspectionRecords()
          } else {
            showStatusMessage("éƒ¨åˆ†è¨˜éŒ„æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥", "error")
          }
        } catch (error) {
          console.error("æäº¤æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
          showStatusMessage("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error")
        } finally {
          hideLoading()
        }
      }

      // ç·¨è¼¯æª¢æŸ¥è¨˜éŒ„
      async function editInspection(id) {
        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${id}`
          )
          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const record = data.data

              // å¡«å…¥è¡¨å–®æ•¸æ“š
              document.getElementById("plateNumber").value = record.plateNumber
              document.getElementById("otherResult").value = record.other || ""

              // é¸ä¸­å°æ‡‰çš„æª¢æŸ¥é …ç›®å’Œçµæœé¸é …
              selectedDevices = [record.CheckItem || record.checkItem]
              selectedResults = [record.result]

              // æ›´æ–°UIé¸ä¸­ç‹€æ…‹
              document
                .querySelectorAll("#deviceOptions .option-item")
                .forEach((item) => {
                  item.classList.toggle(
                    "selected",
                    selectedDevices.includes(item.dataset.value)
                  )
                })

              document
                .querySelectorAll("#resultOptions .option-item")
                .forEach((item) => {
                  item.classList.toggle(
                    "selected",
                    selectedResults.includes(item.dataset.value)
                  )
                })

              currentEditId = id
              document.getElementById("submitBtn").innerHTML =
                '<i class="fas fa-save"></i> æ›´æ–°æª¢æŸ¥è¨˜éŒ„'

              // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
              document
                .getElementById("inspectionForm")
                .scrollIntoView({ behavior: "smooth" })
            }
          }
        } catch (error) {
          console.error("è¼‰å…¥ç·¨è¼¯æ•¸æ“šå¤±æ•—:", error)
          showStatusMessage("è¼‰å…¥ç·¨è¼¯æ•¸æ“šå¤±æ•—", "error")
        } finally {
          hideLoading()
        }
      }

      // åˆªé™¤æª¢æŸ¥è¨˜éŒ„
      async function deleteInspection(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æª¢æŸ¥è¨˜éŒ„å—ï¼Ÿ")) {
          return
        }

        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${id}`,
            {
              method: "DELETE",
            }
          )

          if (response.ok) {
            showStatusMessage("æª¢æŸ¥è¨˜éŒ„åˆªé™¤æˆåŠŸ", "success")

            // é‡æ–°è¼‰å…¥æ•¸æ“š
            await loadSummaryData()
            await loadInspectionRecords()
          } else {
            showStatusMessage("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error")
          }
        } catch (error) {
          console.error("åˆªé™¤æª¢æŸ¥è¨˜éŒ„å¤±æ•—:", error)
          showStatusMessage("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥", "error")
        } finally {
          hideLoading()
        }
      }

      // å–æ¶ˆç·¨è¼¯
      function cancelEdit() {
        resetForm()

        // éš±è—å–æ¶ˆæŒ‰éˆ•
        const cancelBtn = document.getElementById("cancelEditBtn")
        if (cancelBtn) {
          cancelBtn.style.display = "none"
        }

        showStatusMessage("å·²å–æ¶ˆç·¨è¼¯", "info")
      }

      // é‡ç½®è¡¨å–®
      function resetForm() {
        // å°ˆæ¡ˆåç¨±ç”±é ‚éƒ¨å°ˆæ¡ˆé¸æ“‡å™¨æ§åˆ¶ï¼Œä¸éœ€è¦é‡ç½®
        document.getElementById("plateNumber").value = ""
        document.getElementById("otherResult").value = ""

        // æ¸…é™¤è»Šè™ŸéŒ¯èª¤è¨Šæ¯
        document.getElementById("plateErrorMessage").style.display = "none"

        selectedDevices = []
        selectedResults = []
        currentEditId = null

        document.querySelectorAll(".option-item").forEach((item) => {
          item.classList.remove("selected")
        })

        document.querySelector(".container").classList.remove("editing-mode")
        document.getElementById("submitBtn").innerHTML =
          '<i class="fas fa-save"></i> æäº¤æª¢æŸ¥è¨˜éŒ„'

        // éš±è—å–æ¶ˆæŒ‰éˆ•
        const cancelBtn = document.getElementById("cancelEditBtn")
        if (cancelBtn) {
          cancelBtn.style.display = "none"
        }
      }

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex"
      }

      // éš±è—è¼‰å…¥ä¸­
      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none"
      }

      // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
      function showStatusMessage(message, type) {
        const statusElement = document.getElementById("statusMessage")
        statusElement.textContent = message
        statusElement.className = `status-message ${type}`

        // 3ç§’å¾Œè‡ªå‹•éš±è—
        setTimeout(() => {
          statusElement.className = "status-message"
        }, 3000)
      }

      // æ¸¬è©¦APIé€£æ¥
      // æª¢æŸ¥ LIFF ç‹€æ…‹
      // ============ å°ˆæ¡ˆç®¡ç†ç›¸é—œå‡½æ•¸ ============

      // æª¢æŸ¥å°ˆæ¡ˆç®¡ç†æ¬Šé™
      async function checkProjectManagementPermission() {
        try {
          if (!currentUserId) {
            // æ²’æœ‰ç”¨æˆ¶IDï¼Œéš±è—å°ˆæ¡ˆç®¡ç†æŒ‰éˆ•
            document.getElementById("projectManagementBtn").style.display =
              "none"
            document.getElementById("exportReportBtn").style.display = "none"
            return
          }

          const response = await fetch(
            `${base_url}api/ProjectManagement/check-permission/${encodeURIComponent(
              currentUserId
            )}`
          )

          if (response.ok) {
            const hasPermission = await response.json()
            const projectManagementBtn = document.getElementById(
              "projectManagementBtn"
            )
            const exportReportBtn = document.getElementById("exportReportBtn")

            if (hasPermission) {
              projectManagementBtn.style.display = "inline-block"
              exportReportBtn.style.display = "inline-block"
            } else {
              projectManagementBtn.style.display = "none"
              exportReportBtn.style.display = "none"
            }
          } else {
            // API éŒ¯èª¤ï¼Œé è¨­éš±è—æŒ‰éˆ•
            document.getElementById("projectManagementBtn").style.display =
              "none"
            document.getElementById("exportReportBtn").style.display = "none"
          }
        } catch (error) {
          console.error("æª¢æŸ¥å°ˆæ¡ˆç®¡ç†æ¬Šé™å¤±æ•—:", error)
          // éŒ¯èª¤æ™‚éš±è—æŒ‰éˆ•
          document.getElementById("projectManagementBtn").style.display = "none"
          document.getElementById("exportReportBtn").style.display = "none"
        }
      }

      // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
      async function loadProjectList() {
        try {
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/names`
          )
          if (!response.ok) {
            throw new Error("è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨å¤±æ•—")
          }

          availableProjects = await response.json()

          const projectSelect = document.getElementById("projectSelect")
          projectSelect.innerHTML = '<option value="">è«‹é¸æ“‡å°ˆæ¡ˆ...</option>'

          availableProjects.forEach((projectName) => {
            const option = document.createElement("option")
            option.value = projectName
            option.textContent = projectName
            projectSelect.appendChild(option)
          })

          // å¦‚æœåªæœ‰ä¸€å€‹å°ˆæ¡ˆï¼Œè‡ªå‹•é¸æ“‡å®ƒ
          if (availableProjects.length === 1) {
            projectSelect.value = availableProjects[0]
            // ç›´æ¥èª¿ç”¨å°ˆæ¡ˆè®Šæ›´è™•ç†å‡½æ•¸
            const fakeEvent = { target: { value: availableProjects[0] } }
            await handleProjectChange(fakeEvent)
            console.log("è‡ªå‹•é¸æ“‡å”¯ä¸€å°ˆæ¡ˆ:", availableProjects[0])
          }

          console.log("å°ˆæ¡ˆåˆ—è¡¨è¼‰å…¥å®Œæˆ:", availableProjects)
        } catch (error) {
          console.error("è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨å¤±æ•—:", error)
          showStatusMessage("è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š", "error")
        }
      }

      // è¨­ç½®å°ˆæ¡ˆé¸æ“‡äº‹ä»¶
      function setupProjectSelection() {
        const projectSelect = document.getElementById("projectSelect")
        projectSelect.addEventListener("change", handleProjectChange)
      }

      // è™•ç†å°ˆæ¡ˆè®Šæ›´
      async function handleProjectChange(event) {
        const selectedProject = event.target.value
        const projectStatus = document.getElementById("projectStatus")

        // æ¸…é™¤è»Šè™ŸéŒ¯èª¤è¨Šæ¯ï¼ˆå› ç‚ºå°ˆæ¡ˆè®Šæ›´å¯èƒ½å½±éŸ¿æŸ¥è©¢çµæœï¼‰
        document.getElementById("plateErrorMessage").style.display = "none"

        if (!selectedProject) {
          currentProjectName = ""
          deviceOptions = []
          resultOptions = []
          projectStatus.style.display = "block"
          projectStatus.textContent = "è«‹å…ˆé¸æ“‡å°ˆæ¡ˆæ‰èƒ½é€²è¡Œæª¢æŸ¥"
          projectStatus.style.background = "#fff3cd"
          projectStatus.style.color = "#856404"

          // æ¸…ç©ºç¾æœ‰çš„æª¢æŸ¥é …ç›®å’Œçµæœé¸é …
          clearOptionsUI()
          return
        }

        try {
          showLoading()

          // è¼‰å…¥å°ˆæ¡ˆçš„æª¢æŸ¥é …ç›®å’Œæª¢æŸ¥çµæœé…ç½®
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${encodeURIComponent(
              selectedProject
            )}/options`
          )
          if (!response.ok) {
            throw new Error("è¼‰å…¥å°ˆæ¡ˆé…ç½®å¤±æ•—")
          }

          const projectConfig = await response.json()

          console.log("=== API å›æ‡‰è©³ç´°åˆ†æ ===")
          console.log("å°ˆæ¡ˆé…ç½®åŸå§‹è³‡æ–™:", projectConfig)
          console.log("å°ˆæ¡ˆé…ç½®è³‡æ–™é¡å‹:", typeof projectConfig)

          if (projectConfig.devices) {
            console.log(
              "æª¢æŸ¥é …ç›® (devices) æ•¸é‡:",
              projectConfig.devices.length
            )
            projectConfig.devices.forEach((device, index) => {
              console.log(`æª¢æŸ¥é …ç›® ${index + 1}:`, {
                id: device.id,
                name: device.name,
                referenceImages: device.referenceImages,
                referenceImagesType: typeof device.referenceImages,
                referenceImagesLength: device.referenceImages
                  ? device.referenceImages.length
                  : 0,
                fullObject: device,
              })
            })
          } else {
            console.log("è­¦å‘Š: projectConfig.devices ä¸å­˜åœ¨")
          }

          if (projectConfig.checkItems) {
            console.log(
              "æª¢æŸ¥çµæœ (checkItems) æ•¸é‡:",
              projectConfig.checkItems.length
            )
            projectConfig.checkItems.forEach((item, index) => {
              console.log(`æª¢æŸ¥çµæœ ${index + 1}:`, {
                id: item.id,
                name: item.name,
                referenceImages: item.referenceImages,
                referenceImagesType: typeof item.referenceImages,
                referenceImagesLength: item.referenceImages
                  ? item.referenceImages.length
                  : 0,
                fullObject: item,
              })
            })
          } else {
            console.log("è­¦å‘Š: projectConfig.checkItems ä¸å­˜åœ¨")
          }
          console.log("=== API å›æ‡‰è©³ç´°åˆ†æçµæŸ ===")

          // æ›´æ–°ç•¶å‰å°ˆæ¡ˆåç¨±
          currentProjectName = selectedProject

          // æ›´æ–°æª¢æŸ¥é …ç›®é¸é …
          deviceOptions = projectConfig.devices.map((device) => {
            console.log(`è™•ç†æª¢æŸ¥é …ç›® "${device.name}":`, {
              id: device.id,
              name: device.name,
              referenceImages: device.referenceImages,
              referenceImagesType: typeof device.referenceImages,
            })
            return {
              id: device.id,
              name: device.name,
              enabled: true,
              referenceImages: device.referenceImages || null,
            }
          })

          // æ›´æ–°æª¢æŸ¥çµæœé¸é …
          resultOptions = projectConfig.checkItems.map((item) => {
            console.log(`è™•ç†æª¢æŸ¥çµæœ "${item.name}":`, {
              id: item.id,
              name: item.name,
              referenceImages: item.referenceImages,
              referenceImagesType: typeof item.referenceImages,
            })
            return {
              id: item.id,
              name: item.name,
              enabled: true,
              referenceImages: item.referenceImages || null,
            }
          })

          // é‡æ–°ç”Ÿæˆé¸é …UI
          generateDeviceOptions()
          generateResultOptions()

          // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
          projectStatus.style.display = "block"
          projectStatus.textContent = `å·²é¸æ“‡å°ˆæ¡ˆ: ${selectedProject} (æª¢æŸ¥é …ç›®: ${deviceOptions.length}é …, æª¢æŸ¥çµæœ: ${resultOptions.length}é …)`
          projectStatus.style.background = "#d4edda"
          projectStatus.style.color = "#155724"

          // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡è¨Š
          await loadSummaryData()
          await loadInspectionRecords()

          console.log("å°ˆæ¡ˆé…ç½®è¼‰å…¥å®Œæˆ:", { deviceOptions, resultOptions })
        } catch (error) {
          console.error("è¼‰å…¥å°ˆæ¡ˆé…ç½®å¤±æ•—:", error)
          showStatusMessage(
            `è¼‰å…¥å°ˆæ¡ˆã€Œ${selectedProject}ã€é…ç½®å¤±æ•—: ${error.message}`,
            "error"
          )

          // é‡ç½®é¸æ“‡
          event.target.value = ""
          currentProjectName = ""
          deviceOptions = []
          resultOptions = []

          projectStatus.style.display = "block"
          projectStatus.textContent = "è¼‰å…¥å°ˆæ¡ˆé…ç½®å¤±æ•—ï¼Œè«‹é‡æ–°é¸æ“‡"
          projectStatus.style.background = "#f8d7da"
          projectStatus.style.color = "#721c24"

          clearOptionsUI()
        } finally {
          hideLoading()
        }
      }

      // æ¸…ç©ºé¸é …UI
      function clearOptionsUI() {
        const deviceContainer = document.getElementById("deviceOptions")
        const resultContainer = document.getElementById("resultOptions")

        if (deviceContainer) {
          deviceContainer.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ</div>'
        }

        if (resultContainer) {
          resultContainer.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ</div>'
        }

        // æ¸…ç©ºå·²é¸æ“‡çš„æª¢æŸ¥é …ç›®å’Œçµæœ
        selectedDevices = []
        selectedResults = []
      }

      // æ‰“é–‹å°ˆæ¡ˆç®¡ç†é é¢
      function openProjectManagement() {
        window.open(`${base_url}projectManagement.html`, "_blank")
      }

      // ä¿®æ”¹æäº¤æª¢æŸ¥å‡½æ•¸ï¼ŒåŠ å…¥å°ˆæ¡ˆé©—è­‰
      const originalSubmitInspection = submitInspection
      window.submitInspection = function () {
        if (!currentProjectName) {
          showStatusMessage("è«‹å…ˆé¸æ“‡å°ˆæ¡ˆæ‰èƒ½æäº¤æª¢æŸ¥", "error")
          return
        }

        if (deviceOptions.length === 0 || resultOptions.length === 0) {
          showStatusMessage(
            "æ‰€é¸å°ˆæ¡ˆå°šæœªé…ç½®æª¢æŸ¥é …ç›®æˆ–æª¢æŸ¥çµæœï¼Œè«‹è¯çµ¡ç®¡ç†å“¡",
            "error"
          )
          return
        }

        // å‘¼å«åŸå§‹çš„æäº¤å‡½æ•¸
        originalSubmitInspection()
      }

      // åŒ¯å‡ºå°ˆæ¡ˆå ±è¡¨
      async function exportProjectReport() {
        try {
          const selectedProject = document.getElementById("projectSelect").value

          if (!selectedProject) {
            showStatusMessage("è«‹å…ˆé¸æ“‡è¦åŒ¯å‡ºçš„å°ˆæ¡ˆ", "error")
            return
          }

          showStatusMessage("æ­£åœ¨æº–å‚™åŒ¯å‡ºè³‡æ–™...", "info")

          // ç²å–å°ˆæ¡ˆçš„é¸é …ï¼ˆåŒ…å«æª¢æŸ¥é …ç›®ï¼‰
          const optionsResponse = await fetch(
            `${base_url}api/ProjectManagement/projects/${encodeURIComponent(
              selectedProject
            )}/options`
          )

          if (!optionsResponse.ok) {
            throw new Error("ç²å–å°ˆæ¡ˆé¸é …å¤±æ•—")
          }

          const projectOptions = await optionsResponse.json()
          // ä½¿ç”¨è¨­å‚™ä½œç‚ºæª¢æŸ¥é …ç›®ï¼Œå› ç‚ºå¯¦éš›æª¢æŸ¥çš„æ˜¯è¨­å‚™
          const checkItems = projectOptions.devices || []

          // ç²å–å°ˆæ¡ˆçš„æª¢æŸ¥è¨˜éŒ„
          const recordsResponse = await fetch(
            `${base_url}api/TicketMachineInspection/project-records/${encodeURIComponent(
              selectedProject
            )}`
          )

          if (!recordsResponse.ok) {
            throw new Error("ç²å–å°ˆæ¡ˆæª¢æŸ¥è¨˜éŒ„å¤±æ•—")
          }

          const records = await recordsResponse.json()

          // ç”Ÿæˆ Excel è³‡æ–™
          generateExcelReport(selectedProject, checkItems, records)
        } catch (error) {
          console.error("åŒ¯å‡ºå ±è¡¨å¤±æ•—:", error)
          showStatusMessage("åŒ¯å‡ºå ±è¡¨å¤±æ•—: " + error.message, "error")
        }
      }

      // ç”Ÿæˆ Excel å ±è¡¨
      function generateExcelReport(projectName, checkItems, records) {
        // å»ºç«‹æ¨™é¡Œè¡Œ
        const headers = ["è»Šè™Ÿ", "è»Šå‹"]
        checkItems.forEach((item) => {
          headers.push(item.name)
        })

        // æ”¶é›†æ‰€æœ‰è»Šè™Ÿ
        const vehicleNumbers = [
          ...new Set(
            records
              .map(
                (record) =>
                  record.VehicleNumber ||
                  record.PlateNumber ||
                  record.vehicleNumber ||
                  record.plateNumber
              )
              .filter(Boolean)
          ),
        ]

        // å»ºç«‹è³‡æ–™è¡Œ
        const data = [headers]

        vehicleNumbers.forEach((vehicleNumber) => {
          const row = [vehicleNumber, ""] // è»Šè™Ÿå’Œè»Šå‹(ç©ºç™½)

          // å°æ¯å€‹æª¢æŸ¥é …ç›®æ‰¾å‡ºå°æ‡‰çš„æª¢æŸ¥çµæœ
          checkItems.forEach((item) => {
            // æ‰¾åˆ°è©²è»Šè¼›å°æ‡‰æ­¤æª¢æŸ¥é …ç›®çš„è¨˜éŒ„
            const itemResult = records.find((record) => {
              const vehicleMatch =
                record.VehicleNumber === vehicleNumber ||
                record.PlateNumber === vehicleNumber ||
                record.vehicleNumber === vehicleNumber ||
                record.plateNumber === vehicleNumber

              const itemMatch =
                record.CheckItem === item.name || record.checkItem === item.name

              return vehicleMatch && itemMatch
            })

            if (itemResult) {
              // é¡¯ç¤ºæª¢æŸ¥çµæœ
              let resultText =
                itemResult.Result ||
                itemResult.result ||
                itemResult.resultName ||
                "å·²æª¢æŸ¥"

              // å¦‚æœæœ‰å‚™è¨»ï¼ŒåŠ ä¸Šå‚™è¨»è³‡è¨Š
              if (itemResult.Other && itemResult.Other.trim() !== "") {
                resultText += ` (${itemResult.Other.trim()})`
              } else if (itemResult.other && itemResult.other.trim() !== "") {
                resultText += ` (${itemResult.other.trim()})`
              }

              row.push(resultText)
            } else {
              // æ²’æœ‰æª¢æŸ¥è¨˜éŒ„
              row.push("")
            }
          })

          data.push(row)
        })

        // å¦‚æœæ²’æœ‰ä»»ä½•è¨˜éŒ„ï¼Œé¡¯ç¤ºæç¤º
        if (vehicleNumbers.length === 0) {
          const emptyRow = ["ç›®å‰æ²’æœ‰æª¢æŸ¥è¨˜éŒ„", ""]
          checkItems.forEach(() => {
            emptyRow.push("")
          })
          data.push(emptyRow)
        }

        // å»ºç«‹å·¥ä½œç°¿
        const wb = XLSX.utils.book_new()
        const ws = XLSX.utils.aoa_to_sheet(data)

        // è¨­å®šæ¬„å¯¬
        const colWidths = [
          { wch: 12 }, // è»Šè™Ÿ
          { wch: 10 }, // è»Šå‹
        ]
        checkItems.forEach(() => {
          colWidths.push({ wch: 20 }) // æª¢æŸ¥é …ç›®æ¬„ä½ï¼Œå¢åŠ å¯¬åº¦ä»¥å®¹ç´å‚™è¨»
        })
        ws["!cols"] = colWidths

        // è¨­å®šæ¨™é¡Œè¡Œæ¨£å¼
        const range = XLSX.utils.decode_range(ws["!ref"])
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const address = XLSX.utils.encode_cell({ r: 0, c: C })
          if (!ws[address]) continue
          ws[address].s = {
            font: { bold: true },
            fill: { fgColor: { rgb: "E6F3FF" } },
            alignment: { horizontal: "center" },
          }
        }

        // æ·»åŠ å·¥ä½œè¡¨
        XLSX.utils.book_append_sheet(wb, ws, "æª¢æŸ¥å ±è¡¨")

        // ç”Ÿæˆæª”æ¡ˆåç¨±
        const now = new Date()
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "")
        const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, "")
        const fileName = `${projectName}_æª¢æŸ¥å ±è¡¨_${dateStr}_${timeStr}.xlsx`

        // ä¸‹è¼‰æª”æ¡ˆ
        XLSX.writeFile(wb, fileName)

        showStatusMessage(`å ±è¡¨å·²åŒ¯å‡º: ${fileName}`, "success")
        console.log("åŒ¯å‡ºçš„è³‡æ–™:", {
          å°ˆæ¡ˆåç¨±: projectName,
          æª¢æŸ¥é …ç›®æ•¸é‡: checkItems.length,
          è¨˜éŒ„æ•¸é‡: records.length,
          è»Šè¼›æ•¸é‡: vehicleNumbers.length,
        })
      }

      // ============ å°ˆæ¡ˆç®¡ç†ç›¸é—œå‡½æ•¸çµæŸ ============

      // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
      window.addEventListener("load", initializePage)

      // äº‹ä»¶å§”è¨—è™•ç†åƒè€ƒåœ–ç‰‡æŒ‰éˆ•é»æ“Š
      document.addEventListener("click", function (event) {
        if (event.target.closest(".view-reference-images-btn")) {
          event.stopPropagation()
          const button = event.target.closest(".view-reference-images-btn")
          const itemName = button.getAttribute("data-item-name")
          const imagesJson = button.getAttribute("data-images")

          console.log(
            `æŒ‰éµé»æ“Šäº‹ä»¶ - é …ç›®: "${itemName}", è³‡æ–™å±¬æ€§: "${imagesJson}"`
          )

          viewReferenceImages(itemName, imagesJson)
          return false
        }
      })

      // ============ åœ–ç‰‡æŸ¥çœ‹åŠŸèƒ½ ============

      // æŸ¥çœ‹åƒè€ƒåœ–ç‰‡
      function viewReferenceImages(itemName, imagesJson) {
        try {
          console.log(
            `æŸ¥çœ‹åƒè€ƒåœ–ç‰‡ - é …ç›®åç¨±: "${itemName}", åœ–ç‰‡JSON: "${imagesJson}"`
          )

          const images = JSON.parse(imagesJson || "[]")
          console.log(`è§£æå¾Œçš„åœ–ç‰‡é™£åˆ—:`, images)

          if (images.length === 0) {
            console.log(`è©²æª¢æŸ¥é …ç›® "${itemName}" æ²’æœ‰åƒè€ƒåœ–ç‰‡`)
            alert("è©²æª¢æŸ¥é …ç›®æ²’æœ‰åƒè€ƒåœ–ç‰‡")
            return
          }

          // å–å¾—ç›®å‰å°ˆæ¡ˆè³‡è¨Š
          const projectName = currentProjectName || "æœªçŸ¥å°ˆæ¡ˆ"
          console.log(
            `é–‹å•Ÿåœ–ç‰‡ Modal - å°ˆæ¡ˆ: "${projectName}", é …ç›®: "${itemName}", åœ–ç‰‡æ•¸é‡: ${images.length}`
          )

          openImageModal(images, 0, projectName, itemName)
        } catch (error) {
          console.error("è§£æåœ–ç‰‡è³‡æ–™å¤±æ•—:", error)
          console.error("åŸå§‹åœ–ç‰‡JSON:", imagesJson)
          alert("ç„¡æ³•è¼‰å…¥åœ–ç‰‡: " + error.message)
        }
      }

      // åœ–ç‰‡æŸ¥çœ‹ç›¸é—œè®Šæ•¸
      let currentImages = []
      let currentImageIndex = 0
      let imageZoom = 1

      // é–‹å•Ÿåœ–ç‰‡ Modal
      function openImageModal(
        images,
        startIndex = 0,
        projectName = "",
        itemName = ""
      ) {
        const modal = document.getElementById("reference-image-modal")
        const modalImage = document.getElementById("modal-reference-image")
        const modalTitle = document.getElementById("ref-image-modal-title")
        const modalSubtitle = document.getElementById(
          "ref-image-modal-subtitle"
        )

        currentImages = images || []
        currentImageIndex = startIndex
        imageZoom = 1

        if (currentImages.length === 0) {
          alert("æ²’æœ‰å¯é¡¯ç¤ºçš„åœ–ç‰‡")
          return
        }

        // è¨­å®šæ¨™é¡Œå’Œå‰¯æ¨™é¡Œ
        modalTitle.textContent = "æª¢æŸ¥é …ç›®åƒè€ƒåœ–ç‰‡"
        if (projectName && itemName) {
          modalSubtitle.textContent = `å°ˆæ¡ˆï¼š${projectName} | æª¢æŸ¥é …ç›®ï¼š${itemName}`
        } else {
          modalSubtitle.textContent = ""
        }

        showCurrentImage()
        modal.style.display = "flex"

        // è¨­å®šå°èˆªæŒ‰éˆ•é¡¯ç¤º
        document.getElementById("ref-prev-btn").style.display =
          currentImages.length > 1 ? "block" : "none"
        document.getElementById("ref-next-btn").style.display =
          currentImages.length > 1 ? "block" : "none"
      }

      // é—œé–‰åœ–ç‰‡ Modal
      function closeImageModal() {
        document.getElementById("reference-image-modal").style.display = "none"
        currentImages = []
        currentImageIndex = 0
        imageZoom = 1
      }

      // é¡¯ç¤ºç•¶å‰åœ–ç‰‡
      function showCurrentImage() {
        const modalImage = document.getElementById("modal-reference-image")
        const imageCounter = document.getElementById("ref-image-counter")

        if (currentImages.length === 0) return

        // åˆ¤æ–·æ˜¯æœ¬åœ°åœ–ç‰‡é‚„æ˜¯å¤–éƒ¨URL
        const imagePath = currentImages[currentImageIndex]
        if (
          imagePath.startsWith("http://") ||
          imagePath.startsWith("https://")
        ) {
          modalImage.src = imagePath // å¤–éƒ¨URLç›´æ¥ä½¿ç”¨
        } else {
          modalImage.src = `/${imagePath}` // æœ¬åœ°åœ–ç‰‡æ·»åŠ æ ¹è·¯å¾‘
        }

        modalImage.style.transform = `scale(${imageZoom})`
        imageCounter.textContent = `${currentImageIndex + 1} / ${
          currentImages.length
        }`
      }

      // ä¸Šä¸€å¼µåœ–ç‰‡
      function prevReferenceImage() {
        if (currentImages.length <= 1) return
        currentImageIndex =
          (currentImageIndex - 1 + currentImages.length) % currentImages.length
        showCurrentImage()
      }

      // ä¸‹ä¸€å¼µåœ–ç‰‡
      function nextReferenceImage() {
        if (currentImages.length <= 1) return
        currentImageIndex = (currentImageIndex + 1) % currentImages.length
        showCurrentImage()
      }

      // æ”¾å¤§åœ–ç‰‡
      function zoomInReference() {
        imageZoom = Math.min(imageZoom * 1.2, 3)
        showCurrentImage()
      }

      // ç¸®å°åœ–ç‰‡
      function zoomOutReference() {
        imageZoom = Math.max(imageZoom / 1.2, 0.5)
        showCurrentImage()
      }

      // é‡è¨­ç¸®æ”¾
      function resetZoomReference() {
        imageZoom = 1
        showCurrentImage()
      }

      // éµç›¤æ§åˆ¶
      document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("reference-image-modal")
        if (modal.style.display !== "flex") return

        switch (e.key) {
          case "ArrowLeft":
            prevReferenceImage()
            break
          case "ArrowRight":
            nextReferenceImage()
            break
          case "Escape":
            closeImageModal()
            break
          case "+":
          case "=":
            zoomInReference()
            break
          case "-":
            zoomOutReference()
            break
          case "0":
            resetZoomReference()
            break
        }
      })

      // é»æ“ŠModalå¤–éƒ¨é—œé–‰
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("reference-image-modal")
        if (event.target === modal) {
          closeImageModal()
        }
      })
    </script>

    <!-- åƒè€ƒåœ–ç‰‡æŸ¥çœ‹ Modal -->
    <div id="reference-image-modal" class="modal">
      <div
        class="modal-content"
        style="max-width: 90%; max-height: 90%; position: relative"
      >
        <div class="modal-header">
          <div>
            <h3 id="ref-image-modal-title">æª¢æŸ¥é …ç›®åƒè€ƒåœ–ç‰‡</h3>
            <p
              id="ref-image-modal-subtitle"
              style="margin: 0; opacity: 0.8; font-size: 14px"
            ></p>
          </div>
          <span class="close" onclick="closeImageModal()">&times;</span>
        </div>
        <div class="modal-body" style="text-align: center; padding: 20px">
          <div
            id="reference-image-container"
            style="position: relative; display: inline-block"
          >
            <img
              id="modal-reference-image"
              src=""
              alt="åƒè€ƒåœ–ç‰‡"
              style="
                max-width: 100%;
                max-height: 75vh;
                width: auto;
                height: auto;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
              "
            />

            <!-- å°èˆªæŒ‰éˆ• -->
            <button
              id="ref-prev-btn"
              onclick="prevReferenceImage()"
              style="
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                cursor: pointer;
                font-size: 18px;
              "
            >
              â€¹
            </button>

            <button
              id="ref-next-btn"
              onclick="nextReferenceImage()"
              style="
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                cursor: pointer;
                font-size: 18px;
              "
            >
              â€º
            </button>
          </div>

          <!-- åœ–ç‰‡è³‡è¨Š -->
          <div id="ref-image-info" style="margin-top: 10px; color: #666">
            <span id="ref-image-counter">1 / 1</span>
          </div>

          <!-- ç¸®æ”¾æ§åˆ¶ -->
          <div style="margin-top: 15px">
            <button
              onclick="zoomOutReference()"
              class="btn btn-secondary btn-sm"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 12px;
                margin: 0 5px;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              <i class="fas fa-search-minus"></i> ç¸®å°
            </button>
            <button
              onclick="resetZoomReference()"
              class="btn btn-secondary btn-sm"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 12px;
                margin: 0 5px;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              <i class="fas fa-search"></i> åŸå§‹å¤§å°
            </button>
            <button
              onclick="zoomInReference()"
              class="btn btn-secondary btn-sm"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 12px;
                margin: 0 5px;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              <i class="fas fa-search-plus"></i> æ”¾å¤§
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ç‰ˆæœ¬è™Ÿ -->
    <div
      style="
        text-align: center;
        padding: 20px;
        color: #999;
        font-size: 12px;
        border-top: 1px solid #eee;
        margin-top: 30px;
      "
    >
      ç‰ˆæœ¬ 1.0.0.2
    </div>
  </body>
</html>
