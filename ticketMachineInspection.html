<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>車輛檢查表</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- SheetJS 庫用於 Excel 匯出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 
      LIFF 設定說明：
      1. 請將 LIFF_ID 變數替換為您實際的 LIFF ID
      2. 需要在 LINE Developers Console 中創建 LIFF 應用
      3. LIFF 類型建議選擇 "Full" 或 "Tall"
      4. 設定正確的 Endpoint URL
      
    
    -->
    <style>
      body {
        font-family: "Noto Sans TC", Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
        color: #000;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      h2 {
        margin-top: 10px;
        color: #06c755;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        border-bottom: none;
        padding-bottom: 15px;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }

      .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 4px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border 0.3s;
        box-sizing: border-box;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: #06c755;
        outline: none;
        box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.1);
      }

      button {
        width: 100%;
        padding: 14px;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 10px;
      }

      button:hover {
        background-color: #04a73e;
        box-shadow: 0 4px 8px rgba(6, 199, 85, 0.2);
      }

      .secondary-button {
        background-color: #f1f1f1;
        color: #333;
      }

      .secondary-button:hover {
        background-color: #e5e5e5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }

      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        display: block;
      }

      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        display: block;
      }

      .status-message.info {
        background-color: #e7f3fe;
        color: #004085;
        display: block;
      }

      /* 車號自動匹配功能 */
      .plate-suggestions {
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        background: white;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        width: calc(100% - 2px);
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }

      .suggestion-item:hover {
        background-color: #f8f9fa;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      /* 檢查項目和檢查結果選擇樣式 */
      .option-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
        scrollbar-width: thin;
        scrollbar-color: #06c755 #f1f1f1;
      }

      /* Webkit瀏覽器的滾動條樣式 */
      .option-grid::-webkit-scrollbar {
        width: 8px;
      }

      .option-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .option-grid::-webkit-scrollbar-thumb {
        background: #06c755;
        border-radius: 4px;
      }

      .option-grid::-webkit-scrollbar-thumb:hover {
        background: #059652;
      }

      .option-item {
        padding: 8px 6px;
        border: 2px solid #ddd;
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #ffffff;
        font-size: 12px;
        min-height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        word-break: keep-all;
        position: relative;
      }

      .option-item.selected {
        border-color: #06c755;
        background-color: #e8f5e8;
        color: #06c755;
        font-weight: 500;
      }

      .option-item:hover {
        border-color: #06c755;
      }

      /* 統計資訊顯示 */
      .stats-container {
        background-color: #e7f3fe;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
      }

      .stats-item {
        display: inline-block;
        margin: 0 15px;
      }

      .stats-number {
        font-size: 24px;
        font-weight: bold;
        color: #004085;
      }

      .stats-label {
        font-size: 14px;
        color: #555;
      }

      /* 檢查記錄列表 - 新樣式 */
      .vehicle-inspection-item {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .vehicle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
      }

      .check-count {
        background: #06c755;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .check-details {
        margin-bottom: 15px;
      }

      .check-detail {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
      }

      .device-badge {
        background: #17a2b8;
        color: white;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .result-badge {
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .result-normal {
        background: #28a745;
        color: white;
      }

      .result-issue {
        background: #dc3545;
        color: white;
      }

      .result-updated {
        background: #007bff;
        color: white;
      }

      .result-other {
        background: #6c757d;
        color: white;
      }

      .other-note {
        width: 100%;
        background: #fff3cd;
        color: #856404;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        margin-top: 4px;
        border-left: 4px solid #ffc107;
      }

      .plate-number {
        font-weight: bold;
        color: #06c755;
        font-size: 18px;
      }

      .check-time {
        color: #666;
        font-size: 12px;
      }

      .device-result {
        margin-bottom: 5px;
      }

      .device-name {
        font-weight: 500;
        color: #333;
      }

      .result-text {
        color: #666;
      }

      /* 操作按鈕 */
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .edit-btn,
      .delete-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s;
      }

      .edit-btn {
        background-color: #ffc107;
        color: #212529;
        border: 2px solid #ffc107;
      }

      .edit-btn:hover {
        background-color: #ffca2c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      }

      .delete-btn {
        background-color: #dc3545;
        color: white;
        border: 2px solid #dc3545;
      }

      .delete-btn:hover {
        background-color: #e65760;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      }

      /* 編輯模式樣式 */
      .editing-mode {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 3px solid #ffc107;
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.2);
        position: relative;
      }

      .editing-mode::before {
        content: "📝 編輯模式";
        position: absolute;
        top: -15px;
        left: 15px;
        background: #ffc107;
        color: #212529;
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* 自定義滾動條樣式 */
      #vehicleListContainer::-webkit-scrollbar {
        width: 8px;
      }

      #vehicleListContainer::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      #vehicleListContainer::-webkit-scrollbar-thumb {
        background: #06c755;
        border-radius: 4px;
      }

      #vehicleListContainer::-webkit-scrollbar-thumb:hover {
        background: #04a73e;
      }

      /* 圖片查看按鍵樣式 */
      .image-view-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(23, 162, 184, 0.95);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 15;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .image-view-btn:hover {
        background: rgba(23, 162, 184, 1);
        border-color: rgba(255, 255, 255, 1);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      .image-count {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #dc3545;
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        font-size: 8px;
        font-weight: bold;
        width: 14px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .option-text {
        display: block;
        padding-right: 35px;
      }

      /* Modal 樣式 */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 90%;
        max-height: 90%;
        overflow: hidden;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
      }

      .modal-header h3 {
        margin: 0;
        color: #333;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }

      .close:hover {
        color: #000;
      }

      /* 車輛列表容器樣式 */
      .vehicle-list-container {
        position: relative;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background: #fafafa;
        scrollbar-width: thin;
        scrollbar-color: #06c755 #f1f1f1;
      }

      /* 響應式設計 */
      @media (max-width: 480px) {
        .container {
          margin: 5px;
          padding: 15px;
        }

        .option-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 4px;
          max-height: 250px;
          padding: 6px;
        }

        .option-item {
          padding: 6px 4px;
          font-size: 11px;
          min-height: 38px;
        }

        .stats-item {
          display: block;
          margin: 10px 0;
        }

        .vehicle-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .check-detail {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }

        .action-buttons {
          flex-direction: column;
          gap: 8px;
        }

        .edit-btn,
        .delete-btn {
          padding: 12px;
          font-size: 16px;
        }
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #06c755;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      .position-relative {
        position: relative;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h2>車輛檢查表</h2>

      <!-- 專案選擇 -->
      <div
        class="project-selection"
        style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        "
      >
        <div
          style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap"
        >
          <label style="font-weight: 500; color: #333; white-space: nowrap"
            >選擇專案:</label
          >
          <select
            id="projectSelect"
            style="
              flex: 1;
              min-width: 200px;
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 6px;
              font-size: 14px;
            "
          >
            <option value="">請選擇專案...</option>
          </select>
          <button
            id="projectManagementBtn"
            onclick="openProjectManagement()"
            style="
              padding: 10px 15px;
              background: #06c755;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              white-space: nowrap;
            "
          >
            <i class="fas fa-cog"></i> 專案管理
          </button>
          <button
            id="exportReportBtn"
            onclick="exportProjectReport()"
            style="
              padding: 10px 15px;
              background: #17a2b8;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              white-space: nowrap;
              display: none;
            "
          >
            <i class="fas fa-download"></i> 匯出報表
          </button>
        </div>
        <div
          id="projectStatus"
          style="
            margin-top: 10px;
            padding: 8px 12px;
            background: #fff3cd;
            color: #856404;
            border-radius: 4px;
            font-size: 12px;
            display: none;
          "
        >
          請先選擇專案才能進行檢查
        </div>
      </div>

      <!-- 統計資訊 -->
      <div id="statsContainer" class="stats-container">
        <div class="stats-item">
          <div class="stats-number" id="vehicleCount">0</div>
          <div class="stats-label">已檢查車輛數</div>
        </div>

        <!-- 分組統計詳細資訊 -->
        <div
          id="groupedStats"
          style="
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
          "
        ></div>
      </div>
      <!-- 檢查表單 -->
      <div id="inspectionForm">
        <!-- 移除重複的專案名稱選擇，使用頂部的專案選擇 -->

        <div class="form-group position-relative">
          <label for="plateNumber" class="required">車號</label>
          <div style="display: flex; gap: 4px; align-items: stretch">
            <div style="flex: 1; position: relative; min-width: 0">
              <input
                type="text"
                id="plateNumber"
                placeholder="請輸入車號"
                autocomplete="off"
                style="width: 100%; box-sizing: border-box"
              />
              <div id="plateSuggestions" class="plate-suggestions hidden"></div>
              <div
                id="plateErrorMessage"
                style="
                  display: none;
                  color: #dc3545;
                  font-size: 12px;
                  margin-top: 5px;
                "
              ></div>
            </div>
            <button
              type="button"
              id="queryBtn"
              onclick="queryPlateRecords()"
              style="
                padding: 8px 10px;
                background-color: #17a2b8;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 11px;
                font-weight: 500;
                transition: all 0.3s;
                white-space: nowrap;
                width: 65px;
                flex-shrink: 0;
              "
              onmouseover="this.style.backgroundColor='#138496'"
              onmouseout="this.style.backgroundColor='#17a2b8'"
            >
              🔍 查詢
            </button>
          </div>
        </div>
        <div class="form-group">
          <label class="required">檢查項目</label>
          <input
            type="text"
            id="deviceSearch"
            placeholder="🔍 搜尋檢查項目..."
            style="
              width: 100%;
              padding: 8px 12px;
              border: 1px solid #ddd;
              border-radius: 6px;
              font-size: 14px;
              margin-bottom: 10px;
              box-sizing: border-box;
            "
            oninput="filterDeviceOptions(this.value)"
          />
          <div id="deviceOptions" class="option-grid">
            <!-- 檢查項目選項將由JavaScript動態生成 -->
          </div>
        </div>

        <div class="form-group">
          <label class="required">檢查結果</label>
          <div id="resultOptions" class="option-grid">
            <!-- 檢查結果選項將由JavaScript動態生成 -->
          </div>
        </div>

        <div class="form-group">
          <label for="otherResult">其它檢查結果</label>
          <textarea
            id="otherResult"
            rows="3"
            placeholder="如選擇「其它」，請詳細說明檢查結果"
          ></textarea>
        </div>

        <div class="form-group">
          <button id="submitBtn" onclick="submitInspection()">
            <i class="fas fa-save"></i> 提交檢查記錄
          </button>
        </div>
      </div>

      <!-- 查詢結果區域 -->
      <div
        id="queryResultsContainer"
        style="display: none; margin-bottom: 20px"
      >
        <div
          style="
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            background: #f0f9ff;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <h4 style="color: #17a2b8; margin: 0" id="queryResultTitle">
              查詢結果
            </h4>
            <button
              onclick="clearQueryResults()"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
              "
            >
              關畢查詢結果
            </button>
          </div>
          <div id="queryResults"></div>
        </div>
      </div>

      <!-- 檢查記錄列表 -->
      <div class="inspection-list">
        <div id="inspectionList">
          <!-- 檢查記錄將由JavaScript動態載入 -->
        </div>
      </div>

      <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
      // 全域變數
      const base_url = (() => {
        // 檢查是否為本地開發環境
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return window.location.origin + "/"
        }
        // 生產環境使用指定的後端地址
        return "https://35.221.146.143.nip.io/linehook/"
      })() // 使用動態偵測指向應用程式根目錄
      let currentUserId = ""
      let allVehicles = [] // 儲存所有車輛數據
      let allInspectionRecords = [] // 儲存所有檢查記錄
      let selectedDevices = []
      let selectedResults = []
      let currentEditId = null
      let availableProjects = [] // 可用的專案列表
      let currentProjectName = "" // 當前選擇的專案

      // 檢查項目選項配置 - 將根據選擇的專案動態載入
      let deviceOptions = []

      // 檢查結果選項配置 - 將根據選擇的專案動態載入
      let resultOptions = []

      // LIFF 初始化函數
      async function initializeLIFF() {
        try {
          // 先嘗試從 URL 獲取參數
          const urlParams = new URLSearchParams(window.location.search)
          const urlUserId = urlParams.get("userId")
          const isDesktop = urlParams.get("desktop") === "true"

          // 如果有 desktop=true 參數，使用測試 UserID
          if (isDesktop && urlUserId) {
            console.log("桌面版模式，使用 URL 參數的 userId:", urlUserId)
            currentUserId = urlUserId
            showStatusMessage("桌面版測試模式", "info")
            return true
          }

          // 如果有 desktop=true 但沒有 userId，使用預設測試 ID
          if (isDesktop) {
            console.log("桌面版模式，使用預設測試 userId")
            currentUserId = "test-user-001"
            showStatusMessage("桌面版測試模式", "info")
            return true
          }

          // 非桌面版必須使用 LIFF
          if (typeof liff !== "undefined") {
            console.log("正在初始化 LIFF...")

            // 這裡需要您的 LIFF ID，請替換為實際的 LIFF ID
            const LIFF_ID = "your-liff-id-here" // 請替換為實際的 LIFF ID

            await liff.init({ liffId: LIFF_ID })
            console.log("LIFF 初始化成功")

            if (liff.isLoggedIn()) {
              // 獲取用戶資訊
              const profile = await liff.getProfile()
              currentUserId = profile.userId
              console.log("LIFF 用戶資訊:", {
                userId: profile.userId,
                displayName: profile.displayName,
                pictureUrl: profile.pictureUrl,
              })
              showStatusMessage(`歡迎 ${profile.displayName}`, "success")
              return true
            } else {
              // 用戶未登入，導向登入頁面
              console.log("用戶未登入，導向 LIFF 登入")
              liff.login()
              return false
            }
          } else {
            // 不在 LIFF 環境中且非桌面版
            console.error("非桌面版必須在 LINE 環境中使用")
            showNotBoundUserMessage()
            return false
          }
        } catch (error) {
          console.error("LIFF 初始化失敗:", error)
          showNotBoundUserMessage()
          return false
        }
      }

      // 顯示尚未綁定使用者訊息
      function showNotBoundUserMessage() {
        // 隱藏所有功能區域
        const mainContent = document.querySelector(".container")
        if (mainContent) {
          mainContent.style.display = "none"
        }

        // 顯示尚未綁定使用者訊息
        document.body.insertAdjacentHTML(
          "beforeend",
          `
          <div style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            z-index: 9999;
          ">
            <i class="fas fa-user-times" style="font-size: 48px; color: #ff6b6b; margin-bottom: 20px;"></i>
            <h3 style="color: #333; margin-bottom: 15px;">尚未綁定使用者</h3>
            <p style="color: #666; line-height: 1.6;">
              您尚未綁定使用者，無法使用此功能。<br>
              請先完成使用者綁定程序。
            </p>
          </div>
        `
        )
      }

      // 檢查用戶是否存在於系統中
      async function checkUserExists(userId) {
        try {
          const response = await fetch(
            `${base_url}api/User/exists/${encodeURIComponent(userId)}`
          )
          if (response.ok) {
            const data = await response.json()
            return data.exists
          }
          return false
        } catch (error) {
          console.error("檢查用戶存在失敗:", error)
          return false
        }
      } // 頁面初始化
      async function initializePage() {
        showLoading()

        try {
          // 初始化 LIFF
          const liffInitialized = await initializeLIFF()

          // 如果 LIFF 初始化失敗，停止後續處理
          if (!liffInitialized) {
            return
          }

          console.log("當前用戶ID:", currentUserId)

          // 檢查用戶是否存在於系統中（非桌面測試模式）
          const urlParams = new URLSearchParams(window.location.search)
          const isDesktop = urlParams.get("desktop") === "true"

          if (!isDesktop && currentUserId) {
            const userExists = await checkUserExists(currentUserId)
            if (!userExists) {
              console.log("用戶不存在於系統中")
              showNotBoundUserMessage()
              return
            }
          }

          // 初始化頁面元素
          generateDeviceOptions()
          generateResultOptions()

          // 載入車輛數據
          await loadVehicleData()

          // 載入統計資料
          await loadSummaryData()

          // 載入檢查記錄
          await loadInspectionRecords()

          // 載入專案列表
          await loadProjectList()

          // 檢查專案管理權限
          await checkProjectManagementPermission()

          // 設置車號輸入事件
          setupPlateNumberInput()

          // 設置專案選擇事件
          setupProjectSelection()

          console.log("頁面初始化完成")
        } catch (error) {
          console.error("頁面初始化失敗:", error)
          showStatusMessage("載入頁面時發生錯誤，請重新整理", "error")
        } finally {
          hideLoading()
        }
      } // 生成檢查項目選項
      function generateDeviceOptions() {
        const container = document.getElementById("deviceOptions")
        container.innerHTML = ""

        // 清除搜尋框
        const searchInput = document.getElementById("deviceSearch")
        if (searchInput) {
          searchInput.value = ""
        }

        if (deviceOptions.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">請先選擇專案</div>'
          return
        }

        deviceOptions.forEach((device) => {
          if (device.enabled) {
            const option = document.createElement("div")
            option.className = "option-item"
            option.dataset.value = device.id
            option.style.position = "relative"

            // 檢查是否有參考圖片
            let hasImages = false
            let imageCount = 0
            console.log(
              `檢查項目 "${device.name}" 的 referenceImages 欄位:`,
              device.referenceImages
            )
            if (device.referenceImages) {
              try {
                const images = JSON.parse(device.referenceImages)
                hasImages = images && images.length > 0
                imageCount = images.length
                console.log(
                  `檢查項目 "${device.name}" 有 ${imageCount} 張參考圖片:`,
                  images
                )
              } catch (e) {
                console.error(
                  `解析檢查項目 "${device.name}" 的參考圖片失敗:`,
                  e
                )
                console.error(`原始資料:`, device.referenceImages)
                hasImages = false
              }
            } else {
              console.log(`檢查項目 "${device.name}" 沒有參考圖片`)
            }

            option.innerHTML = `
              <span class="option-text">${device.name}</span>
              ${
                hasImages
                  ? `
                <button class="image-view-btn view-reference-images-btn" data-item-name="${device.name}" data-images='${device.referenceImages}' title="查看參考圖片 (${imageCount}張)">
                  <i class="fas fa-images"></i>
                  <span class="image-count">${imageCount}</span>
                </button>
              `
                  : ""
              }
            `

            option.onclick = (event) => {
              // 如果點擊的是圖片按鍵，不要觸發選擇
              if (event.target.closest(".view-reference-images-btn")) {
                return
              }
              toggleSelection(option, "device")
            }
            container.appendChild(option)
          }
        })
      }

      // 生成檢查結果選項
      function generateResultOptions() {
        const container = document.getElementById("resultOptions")
        container.innerHTML = ""

        if (resultOptions.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">請先選擇專案</div>'
          return
        }

        resultOptions.forEach((result) => {
          if (result.enabled) {
            const option = document.createElement("div")
            option.className = "option-item"
            option.dataset.value = result.id
            option.style.position = "relative"

            // 檢查是否有參考圖片
            let hasImages = false
            let imageCount = 0
            console.log(
              `檢查結果 "${result.name}" 的 referenceImages 欄位:`,
              result.referenceImages
            )
            if (result.referenceImages) {
              try {
                const images = JSON.parse(result.referenceImages)
                hasImages = images && images.length > 0
                imageCount = images.length
                console.log(
                  `檢查結果 "${result.name}" 有 ${imageCount} 張參考圖片:`,
                  images
                )
              } catch (e) {
                console.error(
                  `解析檢查結果 "${result.name}" 的參考圖片失敗:`,
                  e
                )
                console.error(`原始資料:`, result.referenceImages)
                hasImages = false
              }
            } else {
              console.log(`檢查結果 "${result.name}" 沒有參考圖片`)
            }

            option.innerHTML = `
              <span class="option-text">${result.name}</span>
              ${
                hasImages
                  ? `
                <button class="image-view-btn view-reference-images-btn" data-item-name="${result.name}" data-images='${result.referenceImages}' title="查看參考圖片 (${imageCount}張)">
                  <i class="fas fa-images"></i>
                  <span class="image-count">${imageCount}</span>
                </button>
              `
                  : ""
              }
            `

            option.onclick = (event) => {
              // 如果點擊的是圖片按鍵，不要觸發選擇
              if (event.target.closest(".view-reference-images-btn")) {
                return
              }
              toggleSelection(option, "result")
            }
            container.appendChild(option)
          }
        })
      }

      // 切換選項選擇狀態
      function toggleSelection(element, type) {
        if (type === "device") {
          // 檢查項目改為單選 - 先清除所有選擇
          document
            .querySelectorAll("#deviceOptions .option-item")
            .forEach((item) => {
              item.classList.remove("selected")
            })
          selectedDevices = []

          // 選擇當前項目
          element.classList.add("selected")
          selectedDevices.push(element.dataset.value)
        } else if (type === "result") {
          element.classList.toggle("selected")

          if (element.classList.contains("selected")) {
            selectedResults.push(element.dataset.value)
          } else {
            selectedResults = selectedResults.filter(
              (r) => r !== element.dataset.value
            )
          }

          // 檢查是否選擇了「其它」選項
          const otherTextarea = document.getElementById("otherResult")
          const hasOtherSelected = selectedResults.includes("其它")
          otherTextarea.required = hasOtherSelected
          otherTextarea.style.borderColor = hasOtherSelected
            ? "#06c755"
            : "#ddd"
        }
      }

      // 檢查項目搜尋功能
      function filterDeviceOptions(searchText) {
        const container = document.getElementById("deviceOptions")
        const options = container.querySelectorAll(".option-item")

        if (!searchText.trim()) {
          // 如果搜尋文字為空，顯示所有選項
          options.forEach((option) => {
            option.style.display = "flex"
          })
          return
        }

        const searchLower = searchText.toLowerCase()
        let visibleCount = 0

        options.forEach((option) => {
          const optionText = option.querySelector(".option-text")
          if (optionText) {
            const text = optionText.textContent.toLowerCase()
            if (text.includes(searchLower)) {
              option.style.display = "flex"
              visibleCount++
            } else {
              option.style.display = "none"
            }
          }
        })

        // 如果沒有找到任何項目，顯示提示訊息
        let noResultsDiv = container.querySelector(".no-results")
        if (visibleCount === 0) {
          if (!noResultsDiv) {
            noResultsDiv = document.createElement("div")
            noResultsDiv.className = "no-results"
            noResultsDiv.style.cssText =
              "grid-column: 1/-1; text-align: center; padding: 20px; color: #999; font-style: italic;"
            noResultsDiv.textContent = `找不到包含「${searchText}」的檢查項目`
            container.appendChild(noResultsDiv)
          }
        } else {
          if (noResultsDiv) {
            noResultsDiv.remove()
          }
        }
      }

      // 載入車輛數據（用於自動匹配）
      async function loadVehicleData() {
        try {
          const response = await fetch(`${base_url}api/BusVehicle`)
          if (response.ok) {
            const data = await response.json()
            if (data.success && data.data) {
              allVehicles = data.data
              console.log("載入車輛數據成功:", allVehicles.length, "輛車")
            } else {
              console.error("API回應格式錯誤:", data)
            }
          } else {
            console.error("API請求失敗:", response.status, response.statusText)
          }
        } catch (error) {
          console.error("載入車輛數據失敗:", error)
        }
      }

      // 設置車號輸入自動匹配
      function setupPlateNumberInput() {
        const plateInput = document.getElementById("plateNumber")
        const suggestionsDiv = document.getElementById("plateSuggestions")

        plateInput.addEventListener("input", function () {
          const value = this.value.trim()
          console.log("輸入車號:", value, "車輛總數:", allVehicles.length)

          // 清除錯誤訊息
          document.getElementById("plateErrorMessage").style.display = "none"

          if (value.length < 1) {
            suggestionsDiv.classList.add("hidden")
            return
          }

          // 尋找匹配的車輛
          const matches = allVehicles
            .filter((vehicle) => {
              if (!vehicle.plateNumber) {
                console.warn("發現沒有車號的車輛:", vehicle)
                return false
              }
              return vehicle.plateNumber
                .toLowerCase()
                .includes(value.toLowerCase())
            })
            .slice(0, 5) // 限制顯示5個結果

          console.log("找到匹配的車輛:", matches.length, "輛")

          if (matches.length > 0) {
            suggestionsDiv.innerHTML = matches
              .map(
                (vehicle) =>
                  `<div class="suggestion-item" onclick="selectPlate('${
                    vehicle.plateNumber
                  }')">
                            ${vehicle.plateNumber} ${
                    vehicle.operatorName ? `(${vehicle.operatorName})` : ""
                  }
                        </div>`
              )
              .join("")
            suggestionsDiv.classList.remove("hidden")
          } else {
            suggestionsDiv.classList.add("hidden")
          }
        })

        // 點擊其他地方時隱藏建議列表
        document.addEventListener("click", function (e) {
          if (
            !plateInput.contains(e.target) &&
            !suggestionsDiv.contains(e.target)
          ) {
            suggestionsDiv.classList.add("hidden")
          }
        })
      }

      // 選擇車號
      function selectPlate(plateNumber) {
        document.getElementById("plateNumber").value = plateNumber
        document.getElementById("plateSuggestions").classList.add("hidden")
      }

      // 載入統計資料
      async function loadSummaryData() {
        try {
          let url = `${base_url}api/TicketMachineInspection/summary`
          console.log("正在載入統計資料:", url)

          const response = await fetch(url)
          console.log("統計資料API狀態:", response.status)

          if (response.ok) {
            const data = await response.json()
            console.log("統計資料回應:", data)
            if (data.success) {
              document.getElementById("vehicleCount").textContent =
                data.data.inspectedVehicleCount

              // 載入分組詳細統計 - 固定顯示專案、公司、部門統計
              await loadGroupedStats()
            } else {
              console.error("統計資料API返回錯誤:", data.message)
            }
          } else {
            const errorText = await response.text()
            console.error("統計資料API請求失敗:", response.status, errorText)
          }
        } catch (error) {
          console.error("載入統計資料失敗:", error)
        }
      }

      // 載入分組統計詳細資訊
      async function loadGroupedStats() {
        try {
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success && data.data) {
              displayGroupedStats(data.data)
            }
          }
        } catch (error) {
          console.error("載入分組統計失敗:", error)
        }
      }

      // 顯示分組統計 - 簡化顯示格式
      function displayGroupedStats(records) {
        const container = document.getElementById("groupedStats")

        if (!records || records.length === 0) {
          container.innerHTML = ""
          return
        }

        // 統計車輛數
        const vehicleCount = new Set(records.map((item) => item.plateNumber))
          .size

        // 獲取主要專案名稱和公司名稱（取第一個記錄作為代表）
        const projectName = records[0]?.projectName || "未指定專案"
        const companyName = records[0]?.company || "未指定公司"

        container.innerHTML = `
          <div style="font-size: 14px; color: #555; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
            <strong>${projectName}</strong>、<strong>${companyName}</strong>，已檢查<strong>${vehicleCount}</strong>輛車
          </div>
        `
      }

      // 載入檢查記錄
      async function loadInspectionRecords() {
        try {
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              allInspectionRecords = data.data // 保存到全域變數
              displayInspectionRecords(data.data)
            }
          }
        } catch (error) {
          console.error("載入檢查記錄失敗:", error)
        }
      }

      // 顯示檢查記錄 - 以車號列表顯示
      function displayInspectionRecords(records) {
        const container = document.getElementById("inspectionList")

        if (!records || records.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #666;">尚無檢查記錄</p>'
          return
        }

        // 按車號分組記錄並獲取唯一車號列表
        const groupedRecords = records.reduce((groups, record) => {
          const plate = record.plateNumber
          if (!groups[plate]) {
            groups[plate] = []
          }
          groups[plate].push(record)
          return groups
        }, {})

        // 顯示車號列表
        container.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h3 style="color: #06c755; margin: 0;">檢查記錄</h3>
              <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-size: 14px; color: #555;">排序方式:</label>
                <select id="sortOption" onchange="applySorting()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd;">
                  <option value="time">依時間排序</option>
                  <option value="plate">依車號排序</option>
                </select>
              </div>
            </div>
            <div id="vehicleListContainer" style="
              max-height: 400px;
              overflow-y: auto;
              border: 1px solid #ddd;
              border-radius: 8px;
              padding: 10px;
              background: #fafafa;
            ">
              <div id="vehicleGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                ${Object.keys(groupedRecords)
                  .map((plateNumber) => {
                    const vehicleRecords = groupedRecords[plateNumber]
                    return `
                      <div class="vehicle-card" onclick="loadVehicleDetails('${plateNumber}')" style="
                        padding: 15px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        cursor: pointer;
                        background: #f9f9f9;
                        transition: all 0.3s;
                        text-align: center;
                      " onmouseover="this.style.borderColor='#06c755'; this.style.background='#f0fff4'" 
                         onmouseout="this.style.borderColor='#ddd'; this.style.background='#f9f9f9'">
                        <div style="font-weight: bold; font-size: 16px; color: #06c755; margin-bottom: 5px;">
                          ${plateNumber}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                          ${vehicleRecords.length} 項檢查
                        </div>
                      </div>
                    `
                  })
                  .join("")}
              </div>
            </div>
          </div>
          <div id="vehicleDetailContainer" style="margin-top: 20px;"></div>
        `
      }

      // 應用排序
      function applySorting() {
        if (!allInspectionRecords || allInspectionRecords.length === 0) {
          return
        }

        const sortOption = document.getElementById("sortOption").value
        const groupedRecords = allInspectionRecords.reduce((groups, record) => {
          const plate = record.plateNumber
          if (!groups[plate]) {
            groups[plate] = []
          }
          groups[plate].push(record)
          return groups
        }, {})

        let sortedPlateNumbers = Object.keys(groupedRecords)

        if (sortOption === "plate") {
          // 依車號排序
          sortedPlateNumbers.sort((a, b) => a.localeCompare(b))
        } else {
          // 依時間排序（預設）- 依最新檢查時間
          sortedPlateNumbers.sort((a, b) => {
            const timeA = new Date(groupedRecords[a][0].checkAt)
            const timeB = new Date(groupedRecords[b][0].checkAt)
            return timeB - timeA // 最新的在前面
          })
        }

        // 重新生成車輛卡片
        const vehicleGrid = document.getElementById("vehicleGrid")
        if (vehicleGrid) {
          vehicleGrid.innerHTML = sortedPlateNumbers
            .map((plateNumber) => {
              const vehicleRecords = groupedRecords[plateNumber]
              return `
                <div class="vehicle-card" onclick="loadVehicleDetails('${plateNumber}')" style="
                  padding: 15px;
                  border: 2px solid #ddd;
                  border-radius: 8px;
                  cursor: pointer;
                  background: #f9f9f9;
                  transition: all 0.3s;
                  text-align: center;
                " onmouseover="this.style.borderColor='#06c755'; this.style.background='#f0fff4'" 
                   onmouseout="this.style.borderColor='#ddd'; this.style.background='#f9f9f9'">
                  <div style="font-weight: bold; font-size: 16px; color: #06c755; margin-bottom: 5px;">
                    ${plateNumber}
                  </div>
                  <div style="font-size: 12px; color: #666;">
                    ${vehicleRecords.length} 項檢查
                  </div>
                </div>
              `
            })
            .join("")
        }
      }

      // 查詢車號檢查記錄
      async function queryPlateRecords() {
        const plateNumber = document.getElementById("plateNumber").value.trim()
        const projectName = currentProjectName // 使用頂部選擇的專案名稱

        // 清除之前的錯誤訊息
        document.getElementById("plateErrorMessage").style.display = "none"

        if (!projectName) {
          showStatusMessage("請先選擇專案", "error")
          return
        }

        if (!plateNumber) {
          showStatusMessage("請輸入車號", "error")
          return
        }

        try {
          showLoading()

          // 獲取所有檢查記錄
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              // 過濾出該車號且專案相同的記錄
              const vehicleRecords = data.data.filter(
                (record) =>
                  record.plateNumber.toLowerCase() ===
                    plateNumber.toLowerCase() &&
                  record.projectName === projectName
              )

              if (vehicleRecords.length === 0) {
                // 在車號輸入框下方顯示紅字錯誤訊息
                const errorMsg = document.getElementById("plateErrorMessage")
                errorMsg.textContent = `查無「${plateNumber}」在專案「${projectName}」的檢查記錄`
                errorMsg.style.display = "block"
                showStatusMessage(`車號「${plateNumber}」查無記錄`, "info")
              } else {
                displayQueryResults(plateNumber, vehicleRecords)
              }
            }
          }
        } catch (error) {
          console.error("查詢檢查記錄失敗:", error)
          showStatusMessage("查詢失敗，請檢查網絡連接", "error")
        } finally {
          hideLoading()
        }
      }

      // 顯示查詢結果
      function displayQueryResults(plateNumber, records) {
        const container = document.getElementById("queryResultsContainer")
        const resultsDiv = document.getElementById("queryResults")
        const titleDiv = document.getElementById("queryResultTitle")

        // 顯示查詢結果容器
        container.style.display = "block"

        // 按時間排序（最新在前）
        const sortedRecords = records.sort((a, b) => {
          return new Date(b.checkAt) - new Date(a.checkAt)
        })

        titleDiv.textContent = `車號「${plateNumber}」查詢結果 (${records.length}項檢查)`

        const recordsHtml = sortedRecords
          .map(
            (record) => `
            <div style="margin-bottom: 10px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; background: white;">
              <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <div>
                  <span class="device-badge" style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 15px; font-size: 12px; margin-right: 8px;">
                    ${getDeviceName(record.CheckItem || record.checkItem)}
                  </span>
                  <span class="result-badge ${getResultClass(
                    record.result
                  )}" style="padding: 4px 8px; border-radius: 15px; font-size: 12px;">
                    ${getResultName(record.result)}
                  </span>
                </div>
              </div>
              <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">
                檢查時間: ${record.checkAt}
              </div>
              ${
                record.other
                  ? `<div style="background: #fff3cd; color: #856404; padding: 6px 10px; border-radius: 4px; font-size: 12px; border-left: 4px solid #ffc107;">備註: ${record.other}</div>`
                  : ""
              }
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button onclick="editSingleInspection('${record.id}')" style="
                  flex: 1;
                  padding: 6px 10px;
                  background: #ffc107;
                  color: #212529;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 12px;
                  font-weight: 500;
                ">📝 編輯</button>
                <button onclick="deleteSingleInspection('${record.id}')" style="
                  flex: 1;
                  padding: 6px 10px;
                  background: #dc3545;
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 12px;
                  font-weight: 500;
                ">🗑️ 刪除</button>
              </div>
            </div>
          `
          )
          .join("")

        resultsDiv.innerHTML = `
          <div style="max-height: 300px; overflow-y: auto;">
            ${recordsHtml}
          </div>
        `

        showStatusMessage(`找到 ${records.length} 項檢查記錄`, "success")
      }

      // 清除查詢結果
      function clearQueryResults() {
        document.getElementById("queryResultsContainer").style.display = "none"
        document.getElementById("plateNumber").value = ""
        document.getElementById("plateErrorMessage").style.display = "none"
        showStatusMessage("已清除查詢結果", "info")
      }

      // 載入車輛詳細檢查資料
      async function loadVehicleDetails(plateNumber) {
        try {
          showLoading()

          // 獲取該車號的所有檢查記錄
          const response = await fetch(`${base_url}api/TicketMachineInspection`)

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const vehicleRecords = data.data.filter(
                (record) => record.plateNumber === plateNumber
              )
              displayVehicleDetails(plateNumber, vehicleRecords)
            }
          }
        } catch (error) {
          console.error("載入車輛詳細資料失敗:", error)
          showStatusMessage("載入車輛詳細資料失敗", "error")
        } finally {
          hideLoading()
        }
      }

      // 顯示車輛詳細檢查資料
      function displayVehicleDetails(plateNumber, records) {
        const container = document.getElementById("vehicleDetailContainer")

        if (!records || records.length === 0) {
          container.innerHTML = ""
          return
        }

        // 預設按時間排序（最新在前）
        const sortedRecords = records.sort((a, b) => {
          return new Date(b.checkAt) - new Date(a.checkAt)
        })

        const detailsHtml = sortedRecords
          .map(
            (record) => `
            <div class="check-detail" style="margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; background: #fafafa;">
              <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <div>
                  <span class="device-badge">${getDeviceName(
                    record.CheckItem || record.checkItem
                  )}</span>
                  <span class="result-badge ${getResultClass(
                    record.result
                  )}">${getResultName(record.result)}</span>
                </div>
              </div>
              <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                 ${record.checkAt}
              </div>
              ${
                record.other
                  ? `<div class="other-note" style="margin-bottom: 8px;">備註: ${record.other}</div>`
                  : ""
              }
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="edit-btn" style="
                  flex: 1;
                  min-width: 60px;
                  padding: 8px 10px;
                  font-size: 12px;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  background: #ffc107;
                  color: #212529;
                  font-weight: 500;
                  transition: all 0.2s;
                " onclick="editSingleInspection('${record.id}')">
                  📝 編輯
                </button>
                <button class="delete-btn" style="
                  flex: 1;
                  min-width: 60px;
                  padding: 8px 10px;
                  font-size: 12px;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  background: #dc3545;
                  color: white;
                  font-weight: 500;
                  transition: all 0.2s;
                " onclick="deleteSingleInspection('${record.id}')">
                  🗑️ 刪除
                </button>
              </div>
            </div>
          `
          )
          .join("")

        container.innerHTML = `
          <div style="border: 2px solid #06c755; border-radius: 8px; padding: 15px; background: #f9fff9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4 style="color: #06c755; margin: 0;">車號: ${plateNumber} 的檢查記錄 (${sortedRecords.length}項)</h4>
              <button onclick="document.getElementById('vehicleDetailContainer').innerHTML=''" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 3px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 10px;
                max-width: 40px;
                min-width: 40px;
              ">關閉</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #06c755 #f1f1f1;">
              ${detailsHtml}
            </div>
          </div>
        `
      }

      // 取得檢查項目名稱
      function getDeviceName(deviceId) {
        const device = deviceOptions.find((d) => d.id === deviceId)
        return device ? device.name : deviceId
      }

      // 取得檢查結果樣式類別
      function getResultClass(resultId) {
        if (resultId === "螺絲正常") return "result-normal"
        if (resultId === "版本已更新") return "result-updated"
        if (resultId === "其它") return "result-other"
        return "result-issue" // 其他問題都用紅色
      }

      // 取得檢查結果名稱
      function getResultName(resultId) {
        const result = resultOptions.find((r) => r.id === resultId)
        return result ? result.name : resultId
      }

      // 編輯單項檢查記錄
      async function editSingleInspection(inspectionId) {
        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${inspectionId}`
          )

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const inspection = data.data

              // 填入表單資料
              // 專案名稱由頂部專案選擇器控制，不需要設置
              document.getElementById("plateNumber").value =
                inspection.plateNumber
              document.getElementById("otherResult").value =
                inspection.other || ""

              // 設定編輯模式
              currentEditId = inspectionId
              document.querySelector(".container").classList.add("editing-mode")

              // 重置選擇
              selectedDevices = []
              selectedResults = []
              document.querySelectorAll(".option-item").forEach((item) => {
                item.classList.remove("selected")
              })

              // 選中對應的檢查項目和結果
              const deviceElement = document.querySelector(
                `[data-value="${inspection.CheckItem || inspection.checkItem}"]`
              )
              if (deviceElement) {
                deviceElement.classList.add("selected")
                selectedDevices.push(
                  inspection.CheckItem || inspection.checkItem
                )
              }

              const resultElement = document.querySelector(
                `#resultOptions [data-value="${inspection.result}"]`
              )
              if (resultElement) {
                resultElement.classList.add("selected")
                selectedResults.push(inspection.result)
              }

              // 更新按鈕文字，添加取消按鈕
              document.getElementById("submitBtn").innerHTML =
                '<i class="fas fa-save"></i> 更新檢查記錄'

              // 添加取消編輯按鈕
              let cancelBtn = document.getElementById("cancelEditBtn")
              if (!cancelBtn) {
                cancelBtn = document.createElement("button")
                cancelBtn.id = "cancelEditBtn"
                cancelBtn.className = "secondary-button"
                cancelBtn.style.marginTop = "10px"
                cancelBtn.innerHTML = '<i class="fas fa-times"></i> 取消編輯'
                cancelBtn.onclick = cancelEdit
                document
                  .getElementById("submitBtn")
                  .parentNode.appendChild(cancelBtn)
              }
              cancelBtn.style.display = "block"

              // 滾動到表單
              document
                .getElementById("inspectionForm")
                .scrollIntoView({ behavior: "smooth" })

              showStatusMessage("已載入檢查記錄，可進行修改", "info")
            }
          }
        } catch (error) {
          console.error("載入檢查記錄失敗:", error)
          showStatusMessage("載入檢查記錄失敗", "error")
        } finally {
          hideLoading()
        }
      }

      // 刪除單項檢查記錄
      async function deleteSingleInspection(inspectionId) {
        if (!confirm("確定要刪除這項檢查記錄嗎？")) {
          return
        }

        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${inspectionId}`,
            {
              method: "DELETE",
            }
          )

          if (response.ok) {
            showStatusMessage("檢查記錄刪除成功", "success")

            // 重新載入數據
            await loadSummaryData()
            await loadInspectionRecords()

            // 清空詳細顯示
            document.getElementById("vehicleDetailContainer").innerHTML = ""
          } else {
            showStatusMessage("刪除失敗，請稍後再試", "error")
          }
        } catch (error) {
          console.error("刪除檢查記錄失敗:", error)
          showStatusMessage("刪除失敗，請檢查網絡連接", "error")
        } finally {
          hideLoading()
        }
      }

      // 編輯整車檢查記錄
      async function editVehicleInspections(plateNumber) {
        try {
          // 為編輯模式加上特殊樣式
          document.querySelector(".container").classList.add("editing-mode")

          // 填入車號
          document.getElementById("plateNumber").value = plateNumber

          // 清空之前的選擇
          resetSelections()

          // 滾動到表單頂部
          document
            .getElementById("inspectionForm")
            .scrollIntoView({ behavior: "smooth" })

          // 更新提交按鈕文字
          document.getElementById("submitBtn").innerHTML =
            '<i class="fas fa-save"></i> 新增檢查項目'

          showStatusMessage("請選擇要新增的檢查項目", "info")
        } catch (error) {
          console.error("編輯檢查記錄失敗:", error)
          showStatusMessage("載入編輯資料失敗", "error")
        }
      }

      // 刪除整車檢查記錄
      async function deleteVehicleInspections(plateNumber) {
        if (!confirm(`確定要刪除車號 ${plateNumber} 的所有檢查記錄嗎？`)) {
          return
        }

        try {
          showLoading()

          // 獲取該車輛的所有記錄
          const today = new Date().toISOString().split("T")[0]
          const response = await fetch(
            `${base_url}api/TicketMachineInspection/user/${currentUserId}?date=${today}`
          )

          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const vehicleRecords = data.data.filter(
                (record) => record.plateNumber === plateNumber
              )

              // 刪除所有相關記錄
              const deletePromises = vehicleRecords.map((record) =>
                fetch(`${base_url}api/TicketMachineInspection/${record.id}`, {
                  method: "DELETE",
                })
              )

              const results = await Promise.all(deletePromises)
              const allSuccessful = results.every((result) => result.ok)

              if (allSuccessful) {
                showStatusMessage("檢查記錄刪除成功", "success")

                // 重新載入數據
                await loadSummaryData()
                await loadInspectionRecords()
              } else {
                showStatusMessage("部分記錄刪除失敗", "error")
              }
            }
          }
        } catch (error) {
          console.error("刪除檢查記錄失敗:", error)
          showStatusMessage("刪除失敗，請檢查網絡連接", "error")
        } finally {
          hideLoading()
        }
      }

      // 重置選擇狀態
      function resetSelections() {
        selectedDevices = []
        selectedResults = []
        currentEditId = null

        document.querySelectorAll(".option-item").forEach((item) => {
          item.classList.remove("selected")
        })

        document.getElementById("otherResult").value = ""
        document.querySelector(".container").classList.remove("editing-mode")
        document.getElementById("submitBtn").innerHTML =
          '<i class="fas fa-save"></i>送出'
      }

      // 提交檢查記錄
      async function submitInspection() {
        try {
          // 驗證表單
          const projectName = currentProjectName // 使用頂部選擇的專案名稱
          const plateNumber = document
            .getElementById("plateNumber")
            .value.trim()

          if (!projectName) {
            showStatusMessage("請先選擇專案", "error")
            return
          }
          const otherResult = document
            .getElementById("otherResult")
            .value.trim()

          if (!projectName) {
            showStatusMessage("請先選擇專案", "error")
            return
          }

          if (!plateNumber) {
            showStatusMessage("請輸入車號", "error")
            return
          }

          if (selectedDevices.length === 0) {
            showStatusMessage("請至少選擇一個檢查項目", "error")
            return
          }

          if (selectedResults.length === 0) {
            showStatusMessage("請至少選擇一個檢查結果", "error")
            return
          }

          if (selectedResults.includes("其它") && !otherResult) {
            showStatusMessage("選擇「其它」時，請填寫詳細說明", "error")
            return
          }

          showLoading()

          // 為每個選中的檢查項目建立記錄
          const promises = []

          for (const device of selectedDevices) {
            for (const result of selectedResults) {
              const requestData = {
                projectName: projectName,
                userId: currentUserId,
                plateNumber: plateNumber,
                checkItem: device,
                result: result,
                other: selectedResults.includes("其它") ? otherResult : null,
                checkAt: new Date()
                  .toLocaleString("zh-TW", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                  })
                  .replace(/\//g, "-"),
              }

              const url = currentEditId
                ? `${base_url}api/TicketMachineInspection/${currentEditId}`
                : `${base_url}api/TicketMachineInspection`

              const method = currentEditId ? "PUT" : "POST"

              promises.push(
                fetch(url, {
                  method: method,
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(requestData),
                })
              )
            }
          }

          const responses = await Promise.all(promises)
          const allSuccessful = responses.every((response) => response.ok)

          if (allSuccessful) {
            showStatusMessage(
              currentEditId ? "檢查記錄更新成功" : "檢查記錄提交成功",
              "success"
            )

            // 清除車號錯誤訊息
            document.getElementById("plateErrorMessage").style.display = "none"

            // 重置表單
            resetForm()

            // 重新載入數據
            await loadSummaryData()
            await loadInspectionRecords()
          } else {
            showStatusMessage("部分記錄提交失敗，請檢查網絡連接", "error")
          }
        } catch (error) {
          console.error("提交檢查記錄失敗:", error)
          showStatusMessage("提交失敗，請稍後再試", "error")
        } finally {
          hideLoading()
        }
      }

      // 編輯檢查記錄
      async function editInspection(id) {
        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${id}`
          )
          if (response.ok) {
            const data = await response.json()
            if (data.success) {
              const record = data.data

              // 填入表單數據
              document.getElementById("plateNumber").value = record.plateNumber
              document.getElementById("otherResult").value = record.other || ""

              // 選中對應的檢查項目和結果選項
              selectedDevices = [record.CheckItem || record.checkItem]
              selectedResults = [record.result]

              // 更新UI選中狀態
              document
                .querySelectorAll("#deviceOptions .option-item")
                .forEach((item) => {
                  item.classList.toggle(
                    "selected",
                    selectedDevices.includes(item.dataset.value)
                  )
                })

              document
                .querySelectorAll("#resultOptions .option-item")
                .forEach((item) => {
                  item.classList.toggle(
                    "selected",
                    selectedResults.includes(item.dataset.value)
                  )
                })

              currentEditId = id
              document.getElementById("submitBtn").innerHTML =
                '<i class="fas fa-save"></i> 更新檢查記錄'

              // 滾動到表單頂部
              document
                .getElementById("inspectionForm")
                .scrollIntoView({ behavior: "smooth" })
            }
          }
        } catch (error) {
          console.error("載入編輯數據失敗:", error)
          showStatusMessage("載入編輯數據失敗", "error")
        } finally {
          hideLoading()
        }
      }

      // 刪除檢查記錄
      async function deleteInspection(id) {
        if (!confirm("確定要刪除這筆檢查記錄嗎？")) {
          return
        }

        try {
          showLoading()

          const response = await fetch(
            `${base_url}api/TicketMachineInspection/${id}`,
            {
              method: "DELETE",
            }
          )

          if (response.ok) {
            showStatusMessage("檢查記錄刪除成功", "success")

            // 重新載入數據
            await loadSummaryData()
            await loadInspectionRecords()
          } else {
            showStatusMessage("刪除失敗，請稍後再試", "error")
          }
        } catch (error) {
          console.error("刪除檢查記錄失敗:", error)
          showStatusMessage("刪除失敗，請檢查網絡連接", "error")
        } finally {
          hideLoading()
        }
      }

      // 取消編輯
      function cancelEdit() {
        resetForm()

        // 隱藏取消按鈕
        const cancelBtn = document.getElementById("cancelEditBtn")
        if (cancelBtn) {
          cancelBtn.style.display = "none"
        }

        showStatusMessage("已取消編輯", "info")
      }

      // 重置表單
      function resetForm() {
        // 專案名稱由頂部專案選擇器控制，不需要重置
        document.getElementById("plateNumber").value = ""
        document.getElementById("otherResult").value = ""

        // 清除車號錯誤訊息
        document.getElementById("plateErrorMessage").style.display = "none"

        selectedDevices = []
        selectedResults = []
        currentEditId = null

        document.querySelectorAll(".option-item").forEach((item) => {
          item.classList.remove("selected")
        })

        document.querySelector(".container").classList.remove("editing-mode")
        document.getElementById("submitBtn").innerHTML =
          '<i class="fas fa-save"></i> 提交檢查記錄'

        // 隱藏取消按鈕
        const cancelBtn = document.getElementById("cancelEditBtn")
        if (cancelBtn) {
          cancelBtn.style.display = "none"
        }
      }

      // 顯示載入中
      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex"
      }

      // 隱藏載入中
      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none"
      }

      // 顯示狀態訊息
      function showStatusMessage(message, type) {
        const statusElement = document.getElementById("statusMessage")
        statusElement.textContent = message
        statusElement.className = `status-message ${type}`

        // 3秒後自動隱藏
        setTimeout(() => {
          statusElement.className = "status-message"
        }, 3000)
      }

      // 測試API連接
      // 檢查 LIFF 狀態
      // ============ 專案管理相關函數 ============

      // 檢查專案管理權限
      async function checkProjectManagementPermission() {
        try {
          if (!currentUserId) {
            // 沒有用戶ID，隱藏專案管理按鈕
            document.getElementById("projectManagementBtn").style.display =
              "none"
            document.getElementById("exportReportBtn").style.display = "none"
            return
          }

          const response = await fetch(
            `${base_url}api/ProjectManagement/check-permission/${encodeURIComponent(
              currentUserId
            )}`
          )

          if (response.ok) {
            const hasPermission = await response.json()
            const projectManagementBtn = document.getElementById(
              "projectManagementBtn"
            )
            const exportReportBtn = document.getElementById("exportReportBtn")

            if (hasPermission) {
              projectManagementBtn.style.display = "inline-block"
              exportReportBtn.style.display = "inline-block"
            } else {
              projectManagementBtn.style.display = "none"
              exportReportBtn.style.display = "none"
            }
          } else {
            // API 錯誤，預設隱藏按鈕
            document.getElementById("projectManagementBtn").style.display =
              "none"
            document.getElementById("exportReportBtn").style.display = "none"
          }
        } catch (error) {
          console.error("檢查專案管理權限失敗:", error)
          // 錯誤時隱藏按鈕
          document.getElementById("projectManagementBtn").style.display = "none"
          document.getElementById("exportReportBtn").style.display = "none"
        }
      }

      // 載入專案列表
      async function loadProjectList() {
        try {
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/names`
          )
          if (!response.ok) {
            throw new Error("載入專案列表失敗")
          }

          availableProjects = await response.json()

          const projectSelect = document.getElementById("projectSelect")
          projectSelect.innerHTML = '<option value="">請選擇專案...</option>'

          availableProjects.forEach((projectName) => {
            const option = document.createElement("option")
            option.value = projectName
            option.textContent = projectName
            projectSelect.appendChild(option)
          })

          // 如果只有一個專案，自動選擇它
          if (availableProjects.length === 1) {
            projectSelect.value = availableProjects[0]
            // 直接調用專案變更處理函數
            const fakeEvent = { target: { value: availableProjects[0] } }
            await handleProjectChange(fakeEvent)
            console.log("自動選擇唯一專案:", availableProjects[0])
          }

          console.log("專案列表載入完成:", availableProjects)
        } catch (error) {
          console.error("載入專案列表失敗:", error)
          showStatusMessage("載入專案列表失敗，請檢查網路連線", "error")
        }
      }

      // 設置專案選擇事件
      function setupProjectSelection() {
        const projectSelect = document.getElementById("projectSelect")
        projectSelect.addEventListener("change", handleProjectChange)
      }

      // 處理專案變更
      async function handleProjectChange(event) {
        const selectedProject = event.target.value
        const projectStatus = document.getElementById("projectStatus")

        // 清除車號錯誤訊息（因為專案變更可能影響查詢結果）
        document.getElementById("plateErrorMessage").style.display = "none"

        if (!selectedProject) {
          currentProjectName = ""
          deviceOptions = []
          resultOptions = []
          projectStatus.style.display = "block"
          projectStatus.textContent = "請先選擇專案才能進行檢查"
          projectStatus.style.background = "#fff3cd"
          projectStatus.style.color = "#856404"

          // 清空現有的檢查項目和結果選項
          clearOptionsUI()
          return
        }

        try {
          showLoading()

          // 載入專案的檢查項目和檢查結果配置
          const response = await fetch(
            `${base_url}api/ProjectManagement/projects/${encodeURIComponent(
              selectedProject
            )}/options`
          )
          if (!response.ok) {
            throw new Error("載入專案配置失敗")
          }

          const projectConfig = await response.json()

          console.log("=== API 回應詳細分析 ===")
          console.log("專案配置原始資料:", projectConfig)
          console.log("專案配置資料類型:", typeof projectConfig)

          if (projectConfig.devices) {
            console.log(
              "檢查項目 (devices) 數量:",
              projectConfig.devices.length
            )
            projectConfig.devices.forEach((device, index) => {
              console.log(`檢查項目 ${index + 1}:`, {
                id: device.id,
                name: device.name,
                referenceImages: device.referenceImages,
                referenceImagesType: typeof device.referenceImages,
                referenceImagesLength: device.referenceImages
                  ? device.referenceImages.length
                  : 0,
                fullObject: device,
              })
            })
          } else {
            console.log("警告: projectConfig.devices 不存在")
          }

          if (projectConfig.checkItems) {
            console.log(
              "檢查結果 (checkItems) 數量:",
              projectConfig.checkItems.length
            )
            projectConfig.checkItems.forEach((item, index) => {
              console.log(`檢查結果 ${index + 1}:`, {
                id: item.id,
                name: item.name,
                referenceImages: item.referenceImages,
                referenceImagesType: typeof item.referenceImages,
                referenceImagesLength: item.referenceImages
                  ? item.referenceImages.length
                  : 0,
                fullObject: item,
              })
            })
          } else {
            console.log("警告: projectConfig.checkItems 不存在")
          }
          console.log("=== API 回應詳細分析結束 ===")

          // 更新當前專案名稱
          currentProjectName = selectedProject

          // 更新檢查項目選項
          deviceOptions = projectConfig.devices.map((device) => {
            console.log(`處理檢查項目 "${device.name}":`, {
              id: device.id,
              name: device.name,
              referenceImages: device.referenceImages,
              referenceImagesType: typeof device.referenceImages,
            })
            return {
              id: device.id,
              name: device.name,
              enabled: true,
              referenceImages: device.referenceImages || null,
            }
          })

          // 更新檢查結果選項
          resultOptions = projectConfig.checkItems.map((item) => {
            console.log(`處理檢查結果 "${item.name}":`, {
              id: item.id,
              name: item.name,
              referenceImages: item.referenceImages,
              referenceImagesType: typeof item.referenceImages,
            })
            return {
              id: item.id,
              name: item.name,
              enabled: true,
              referenceImages: item.referenceImages || null,
            }
          })

          // 重新生成選項UI
          generateDeviceOptions()
          generateResultOptions()

          // 更新狀態顯示
          projectStatus.style.display = "block"
          projectStatus.textContent = `已選擇專案: ${selectedProject} (檢查項目: ${deviceOptions.length}項, 檢查結果: ${resultOptions.length}項)`
          projectStatus.style.background = "#d4edda"
          projectStatus.style.color = "#155724"

          // 重新載入統計資訊
          await loadSummaryData()
          await loadInspectionRecords()

          console.log("專案配置載入完成:", { deviceOptions, resultOptions })
        } catch (error) {
          console.error("載入專案配置失敗:", error)
          showStatusMessage(
            `載入專案「${selectedProject}」配置失敗: ${error.message}`,
            "error"
          )

          // 重置選擇
          event.target.value = ""
          currentProjectName = ""
          deviceOptions = []
          resultOptions = []

          projectStatus.style.display = "block"
          projectStatus.textContent = "載入專案配置失敗，請重新選擇"
          projectStatus.style.background = "#f8d7da"
          projectStatus.style.color = "#721c24"

          clearOptionsUI()
        } finally {
          hideLoading()
        }
      }

      // 清空選項UI
      function clearOptionsUI() {
        const deviceContainer = document.getElementById("deviceOptions")
        const resultContainer = document.getElementById("resultOptions")

        if (deviceContainer) {
          deviceContainer.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">請先選擇專案</div>'
        }

        if (resultContainer) {
          resultContainer.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">請先選擇專案</div>'
        }

        // 清空已選擇的檢查項目和結果
        selectedDevices = []
        selectedResults = []
      }

      // 打開專案管理頁面
      function openProjectManagement() {
        window.open(`${base_url}projectManagement.html`, "_blank")
      }

      // 修改提交檢查函數，加入專案驗證
      const originalSubmitInspection = submitInspection
      window.submitInspection = function () {
        if (!currentProjectName) {
          showStatusMessage("請先選擇專案才能提交檢查", "error")
          return
        }

        if (deviceOptions.length === 0 || resultOptions.length === 0) {
          showStatusMessage(
            "所選專案尚未配置檢查項目或檢查結果，請聯絡管理員",
            "error"
          )
          return
        }

        // 呼叫原始的提交函數
        originalSubmitInspection()
      }

      // 匯出專案報表
      async function exportProjectReport() {
        try {
          const selectedProject = document.getElementById("projectSelect").value

          if (!selectedProject) {
            showStatusMessage("請先選擇要匯出的專案", "error")
            return
          }

          showStatusMessage("正在準備匯出資料...", "info")

          // 獲取專案的選項（包含檢查項目）
          const optionsResponse = await fetch(
            `${base_url}api/ProjectManagement/projects/${encodeURIComponent(
              selectedProject
            )}/options`
          )

          if (!optionsResponse.ok) {
            throw new Error("獲取專案選項失敗")
          }

          const projectOptions = await optionsResponse.json()
          // 使用設備作為檢查項目，因為實際檢查的是設備
          const checkItems = projectOptions.devices || []

          // 獲取專案的檢查記錄
          const recordsResponse = await fetch(
            `${base_url}api/TicketMachineInspection/project-records/${encodeURIComponent(
              selectedProject
            )}`
          )

          if (!recordsResponse.ok) {
            throw new Error("獲取專案檢查記錄失敗")
          }

          const records = await recordsResponse.json()

          // 生成 Excel 資料
          generateExcelReport(selectedProject, checkItems, records)
        } catch (error) {
          console.error("匯出報表失敗:", error)
          showStatusMessage("匯出報表失敗: " + error.message, "error")
        }
      }

      // 生成 Excel 報表
      function generateExcelReport(projectName, checkItems, records) {
        // 建立標題行
        const headers = ["車號", "車型"]
        checkItems.forEach((item) => {
          headers.push(item.name)
        })

        // 收集所有車號
        const vehicleNumbers = [
          ...new Set(
            records
              .map(
                (record) =>
                  record.VehicleNumber ||
                  record.PlateNumber ||
                  record.vehicleNumber ||
                  record.plateNumber
              )
              .filter(Boolean)
          ),
        ]

        // 建立資料行
        const data = [headers]

        vehicleNumbers.forEach((vehicleNumber) => {
          const row = [vehicleNumber, ""] // 車號和車型(空白)

          // 對每個檢查項目找出對應的檢查結果
          checkItems.forEach((item) => {
            // 找到該車輛對應此檢查項目的記錄
            const itemResult = records.find((record) => {
              const vehicleMatch =
                record.VehicleNumber === vehicleNumber ||
                record.PlateNumber === vehicleNumber ||
                record.vehicleNumber === vehicleNumber ||
                record.plateNumber === vehicleNumber

              const itemMatch =
                record.CheckItem === item.name || record.checkItem === item.name

              return vehicleMatch && itemMatch
            })

            if (itemResult) {
              // 顯示檢查結果
              let resultText =
                itemResult.Result ||
                itemResult.result ||
                itemResult.resultName ||
                "已檢查"

              // 如果有備註，加上備註資訊
              if (itemResult.Other && itemResult.Other.trim() !== "") {
                resultText += ` (${itemResult.Other.trim()})`
              } else if (itemResult.other && itemResult.other.trim() !== "") {
                resultText += ` (${itemResult.other.trim()})`
              }

              row.push(resultText)
            } else {
              // 沒有檢查記錄
              row.push("")
            }
          })

          data.push(row)
        })

        // 如果沒有任何記錄，顯示提示
        if (vehicleNumbers.length === 0) {
          const emptyRow = ["目前沒有檢查記錄", ""]
          checkItems.forEach(() => {
            emptyRow.push("")
          })
          data.push(emptyRow)
        }

        // 建立工作簿
        const wb = XLSX.utils.book_new()
        const ws = XLSX.utils.aoa_to_sheet(data)

        // 設定欄寬
        const colWidths = [
          { wch: 12 }, // 車號
          { wch: 10 }, // 車型
        ]
        checkItems.forEach(() => {
          colWidths.push({ wch: 20 }) // 檢查項目欄位，增加寬度以容納備註
        })
        ws["!cols"] = colWidths

        // 設定標題行樣式
        const range = XLSX.utils.decode_range(ws["!ref"])
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const address = XLSX.utils.encode_cell({ r: 0, c: C })
          if (!ws[address]) continue
          ws[address].s = {
            font: { bold: true },
            fill: { fgColor: { rgb: "E6F3FF" } },
            alignment: { horizontal: "center" },
          }
        }

        // 添加工作表
        XLSX.utils.book_append_sheet(wb, ws, "檢查報表")

        // 生成檔案名稱
        const now = new Date()
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "")
        const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, "")
        const fileName = `${projectName}_檢查報表_${dateStr}_${timeStr}.xlsx`

        // 下載檔案
        XLSX.writeFile(wb, fileName)

        showStatusMessage(`報表已匯出: ${fileName}`, "success")
        console.log("匯出的資料:", {
          專案名稱: projectName,
          檢查項目數量: checkItems.length,
          記錄數量: records.length,
          車輛數量: vehicleNumbers.length,
        })
      }

      // ============ 專案管理相關函數結束 ============

      // 頁面載入完成後初始化
      window.addEventListener("load", initializePage)

      // 事件委託處理參考圖片按鈕點擊
      document.addEventListener("click", function (event) {
        if (event.target.closest(".view-reference-images-btn")) {
          event.stopPropagation()
          const button = event.target.closest(".view-reference-images-btn")
          const itemName = button.getAttribute("data-item-name")
          const imagesJson = button.getAttribute("data-images")

          console.log(
            `按鍵點擊事件 - 項目: "${itemName}", 資料屬性: "${imagesJson}"`
          )

          viewReferenceImages(itemName, imagesJson)
          return false
        }
      })

      // ============ 圖片查看功能 ============

      // 查看參考圖片
      function viewReferenceImages(itemName, imagesJson) {
        try {
          console.log(
            `查看參考圖片 - 項目名稱: "${itemName}", 圖片JSON: "${imagesJson}"`
          )

          const images = JSON.parse(imagesJson || "[]")
          console.log(`解析後的圖片陣列:`, images)

          if (images.length === 0) {
            console.log(`該檢查項目 "${itemName}" 沒有參考圖片`)
            alert("該檢查項目沒有參考圖片")
            return
          }

          // 取得目前專案資訊
          const projectName = currentProjectName || "未知專案"
          console.log(
            `開啟圖片 Modal - 專案: "${projectName}", 項目: "${itemName}", 圖片數量: ${images.length}`
          )

          openImageModal(images, 0, projectName, itemName)
        } catch (error) {
          console.error("解析圖片資料失敗:", error)
          console.error("原始圖片JSON:", imagesJson)
          alert("無法載入圖片: " + error.message)
        }
      }

      // 圖片查看相關變數
      let currentImages = []
      let currentImageIndex = 0
      let imageZoom = 1

      // 開啟圖片 Modal
      function openImageModal(
        images,
        startIndex = 0,
        projectName = "",
        itemName = ""
      ) {
        const modal = document.getElementById("reference-image-modal")
        const modalImage = document.getElementById("modal-reference-image")
        const modalTitle = document.getElementById("ref-image-modal-title")
        const modalSubtitle = document.getElementById(
          "ref-image-modal-subtitle"
        )

        currentImages = images || []
        currentImageIndex = startIndex
        imageZoom = 1

        if (currentImages.length === 0) {
          alert("沒有可顯示的圖片")
          return
        }

        // 設定標題和副標題
        modalTitle.textContent = "檢查項目參考圖片"
        if (projectName && itemName) {
          modalSubtitle.textContent = `專案：${projectName} | 檢查項目：${itemName}`
        } else {
          modalSubtitle.textContent = ""
        }

        showCurrentImage()
        modal.style.display = "flex"

        // 設定導航按鈕顯示
        document.getElementById("ref-prev-btn").style.display =
          currentImages.length > 1 ? "block" : "none"
        document.getElementById("ref-next-btn").style.display =
          currentImages.length > 1 ? "block" : "none"
      }

      // 關閉圖片 Modal
      function closeImageModal() {
        document.getElementById("reference-image-modal").style.display = "none"
        currentImages = []
        currentImageIndex = 0
        imageZoom = 1
      }

      // 顯示當前圖片
      function showCurrentImage() {
        const modalImage = document.getElementById("modal-reference-image")
        const imageCounter = document.getElementById("ref-image-counter")

        if (currentImages.length === 0) return

        // 判斷是本地圖片還是外部URL
        const imagePath = currentImages[currentImageIndex]
        if (
          imagePath.startsWith("http://") ||
          imagePath.startsWith("https://")
        ) {
          modalImage.src = imagePath // 外部URL直接使用
        } else {
          modalImage.src = `/${imagePath}` // 本地圖片添加根路徑
        }

        modalImage.style.transform = `scale(${imageZoom})`
        imageCounter.textContent = `${currentImageIndex + 1} / ${
          currentImages.length
        }`
      }

      // 上一張圖片
      function prevReferenceImage() {
        if (currentImages.length <= 1) return
        currentImageIndex =
          (currentImageIndex - 1 + currentImages.length) % currentImages.length
        showCurrentImage()
      }

      // 下一張圖片
      function nextReferenceImage() {
        if (currentImages.length <= 1) return
        currentImageIndex = (currentImageIndex + 1) % currentImages.length
        showCurrentImage()
      }

      // 放大圖片
      function zoomInReference() {
        imageZoom = Math.min(imageZoom * 1.2, 3)
        showCurrentImage()
      }

      // 縮小圖片
      function zoomOutReference() {
        imageZoom = Math.max(imageZoom / 1.2, 0.5)
        showCurrentImage()
      }

      // 重設縮放
      function resetZoomReference() {
        imageZoom = 1
        showCurrentImage()
      }

      // 鍵盤控制
      document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("reference-image-modal")
        if (modal.style.display !== "flex") return

        switch (e.key) {
          case "ArrowLeft":
            prevReferenceImage()
            break
          case "ArrowRight":
            nextReferenceImage()
            break
          case "Escape":
            closeImageModal()
            break
          case "+":
          case "=":
            zoomInReference()
            break
          case "-":
            zoomOutReference()
            break
          case "0":
            resetZoomReference()
            break
        }
      })

      // 點擊Modal外部關閉
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("reference-image-modal")
        if (event.target === modal) {
          closeImageModal()
        }
      })
    </script>

    <!-- 參考圖片查看 Modal -->
    <div id="reference-image-modal" class="modal">
      <div
        class="modal-content"
        style="max-width: 90%; max-height: 90%; position: relative"
      >
        <div class="modal-header">
          <div>
            <h3 id="ref-image-modal-title">檢查項目參考圖片</h3>
            <p
              id="ref-image-modal-subtitle"
              style="margin: 0; opacity: 0.8; font-size: 14px"
            ></p>
          </div>
          <span class="close" onclick="closeImageModal()">&times;</span>
        </div>
        <div class="modal-body" style="text-align: center; padding: 20px">
          <div
            id="reference-image-container"
            style="position: relative; display: inline-block"
          >
            <img
              id="modal-reference-image"
              src=""
              alt="參考圖片"
              style="
                max-width: 100%;
                max-height: 75vh;
                width: auto;
                height: auto;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
              "
            />

            <!-- 導航按鈕 -->
            <button
              id="ref-prev-btn"
              onclick="prevReferenceImage()"
              style="
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                cursor: pointer;
                font-size: 18px;
              "
            >
              ‹
            </button>

            <button
              id="ref-next-btn"
              onclick="nextReferenceImage()"
              style="
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                cursor: pointer;
                font-size: 18px;
              "
            >
              ›
            </button>
          </div>

          <!-- 圖片資訊 -->
          <div id="ref-image-info" style="margin-top: 10px; color: #666">
            <span id="ref-image-counter">1 / 1</span>
          </div>

          <!-- 縮放控制 -->
          <div style="margin-top: 15px">
            <button
              onclick="zoomOutReference()"
              class="btn btn-secondary btn-sm"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 12px;
                margin: 0 5px;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              <i class="fas fa-search-minus"></i> 縮小
            </button>
            <button
              onclick="resetZoomReference()"
              class="btn btn-secondary btn-sm"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 12px;
                margin: 0 5px;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              <i class="fas fa-search"></i> 原始大小
            </button>
            <button
              onclick="zoomInReference()"
              class="btn btn-secondary btn-sm"
              style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 12px;
                margin: 0 5px;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              <i class="fas fa-search-plus"></i> 放大
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 版本號 -->
    <div
      style="
        text-align: center;
        padding: 20px;
        color: #999;
        font-size: 12px;
        border-top: 1px solid #eee;
        margin-top: 30px;
      "
    >
      版本 1.0.0.2
    </div>
  </body>
</html>
